var Wo=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports);var Hc=Wo((zc,vt)=>{(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))s(a);new MutationObserver(a=>{for(const r of a)if(r.type==="childList")for(const u of r.addedNodes)u.tagName==="LINK"&&u.rel==="modulepreload"&&s(u)}).observe(document,{childList:!0,subtree:!0});function i(a){const r={};return a.integrity&&(r.integrity=a.integrity),a.referrerPolicy&&(r.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?r.credentials="include":a.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(a){if(a.ep)return;a.ep=!0;const r=i(a);fetch(a.href,r)}})();var eo={exports:{}};(function(e,t){(function(i,s){e.exports=s()})(self,function(){return(()=>{var i={4567:function(a,r,u){var o,l=this&&this.__extends||(o=function(c,n){return o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(h,_){h.__proto__=_}||function(h,_){for(var d in _)Object.prototype.hasOwnProperty.call(_,d)&&(h[d]=_[d])},o(c,n)},function(c,n){if(typeof n!="function"&&n!==null)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function h(){this.constructor=c}o(c,n),c.prototype=n===null?Object.create(n):(h.prototype=n.prototype,new h)});Object.defineProperty(r,"__esModule",{value:!0}),r.AccessibilityManager=void 0;var f=u(9042),m=u(6114),C=u(9924),S=u(3656),p=u(844),v=u(5596),w=u(9631),y=function(c){function n(h,_){var d=c.call(this)||this;d._terminal=h,d._renderService=_,d._liveRegionLineCount=0,d._charsToConsume=[],d._charsToAnnounce="",d._accessibilityTreeRoot=document.createElement("div"),d._accessibilityTreeRoot.classList.add("xterm-accessibility"),d._accessibilityTreeRoot.tabIndex=0,d._rowContainer=document.createElement("div"),d._rowContainer.setAttribute("role","list"),d._rowContainer.classList.add("xterm-accessibility-tree"),d._rowElements=[];for(var b=0;b<d._terminal.rows;b++)d._rowElements[b]=d._createAccessibilityTreeNode(),d._rowContainer.appendChild(d._rowElements[b]);if(d._topBoundaryFocusListener=function(g){return d._onBoundaryFocus(g,0)},d._bottomBoundaryFocusListener=function(g){return d._onBoundaryFocus(g,1)},d._rowElements[0].addEventListener("focus",d._topBoundaryFocusListener),d._rowElements[d._rowElements.length-1].addEventListener("focus",d._bottomBoundaryFocusListener),d._refreshRowsDimensions(),d._accessibilityTreeRoot.appendChild(d._rowContainer),d._renderRowsDebouncer=new C.TimeBasedDebouncer(d._renderRows.bind(d)),d._refreshRows(),d._liveRegion=document.createElement("div"),d._liveRegion.classList.add("live-region"),d._liveRegion.setAttribute("aria-live","assertive"),d._accessibilityTreeRoot.appendChild(d._liveRegion),!d._terminal.element)throw new Error("Cannot enable accessibility before Terminal.open");return d._terminal.element.insertAdjacentElement("afterbegin",d._accessibilityTreeRoot),d.register(d._renderRowsDebouncer),d.register(d._terminal.onResize(function(g){return d._onResize(g.rows)})),d.register(d._terminal.onRender(function(g){return d._refreshRows(g.start,g.end)})),d.register(d._terminal.onScroll(function(){return d._refreshRows()})),d.register(d._terminal.onA11yChar(function(g){return d._onChar(g)})),d.register(d._terminal.onLineFeed(function(){return d._onChar(`
`)})),d.register(d._terminal.onA11yTab(function(g){return d._onTab(g)})),d.register(d._terminal.onKey(function(g){return d._onKey(g.key)})),d.register(d._terminal.onBlur(function(){return d._clearLiveRegion()})),d.register(d._renderService.onDimensionsChange(function(){return d._refreshRowsDimensions()})),d._screenDprMonitor=new v.ScreenDprMonitor,d.register(d._screenDprMonitor),d._screenDprMonitor.setListener(function(){return d._refreshRowsDimensions()}),d.register((0,S.addDisposableDomListener)(window,"resize",function(){return d._refreshRowsDimensions()})),d}return l(n,c),n.prototype.dispose=function(){c.prototype.dispose.call(this),(0,w.removeElementFromParent)(this._accessibilityTreeRoot),this._rowElements.length=0},n.prototype._onBoundaryFocus=function(h,_){var d=h.target,b=this._rowElements[_===0?1:this._rowElements.length-2];if(d.getAttribute("aria-posinset")!==(_===0?"1":""+this._terminal.buffer.lines.length)&&h.relatedTarget===b){var g,A;if(_===0?(g=d,A=this._rowElements.pop(),this._rowContainer.removeChild(A)):(g=this._rowElements.shift(),A=d,this._rowContainer.removeChild(g)),g.removeEventListener("focus",this._topBoundaryFocusListener),A.removeEventListener("focus",this._bottomBoundaryFocusListener),_===0){var R=this._createAccessibilityTreeNode();this._rowElements.unshift(R),this._rowContainer.insertAdjacentElement("afterbegin",R)}else R=this._createAccessibilityTreeNode(),this._rowElements.push(R),this._rowContainer.appendChild(R);this._rowElements[0].addEventListener("focus",this._topBoundaryFocusListener),this._rowElements[this._rowElements.length-1].addEventListener("focus",this._bottomBoundaryFocusListener),this._terminal.scrollLines(_===0?-1:1),this._rowElements[_===0?1:this._rowElements.length-2].focus(),h.preventDefault(),h.stopImmediatePropagation()}},n.prototype._onResize=function(h){this._rowElements[this._rowElements.length-1].removeEventListener("focus",this._bottomBoundaryFocusListener);for(var _=this._rowContainer.children.length;_<this._terminal.rows;_++)this._rowElements[_]=this._createAccessibilityTreeNode(),this._rowContainer.appendChild(this._rowElements[_]);for(;this._rowElements.length>h;)this._rowContainer.removeChild(this._rowElements.pop());this._rowElements[this._rowElements.length-1].addEventListener("focus",this._bottomBoundaryFocusListener),this._refreshRowsDimensions()},n.prototype._createAccessibilityTreeNode=function(){var h=document.createElement("div");return h.setAttribute("role","listitem"),h.tabIndex=-1,this._refreshRowDimensions(h),h},n.prototype._onTab=function(h){for(var _=0;_<h;_++)this._onChar(" ")},n.prototype._onChar=function(h){var _=this;this._liveRegionLineCount<21&&(this._charsToConsume.length>0?this._charsToConsume.shift()!==h&&(this._charsToAnnounce+=h):this._charsToAnnounce+=h,h===`
`&&(this._liveRegionLineCount++,this._liveRegionLineCount===21&&(this._liveRegion.textContent+=f.tooMuchOutput)),m.isMac&&this._liveRegion.textContent&&this._liveRegion.textContent.length>0&&!this._liveRegion.parentNode&&setTimeout(function(){_._accessibilityTreeRoot.appendChild(_._liveRegion)},0))},n.prototype._clearLiveRegion=function(){this._liveRegion.textContent="",this._liveRegionLineCount=0,m.isMac&&(0,w.removeElementFromParent)(this._liveRegion)},n.prototype._onKey=function(h){this._clearLiveRegion(),this._charsToConsume.push(h)},n.prototype._refreshRows=function(h,_){this._renderRowsDebouncer.refresh(h,_,this._terminal.rows)},n.prototype._renderRows=function(h,_){for(var d=this._terminal.buffer,b=d.lines.length.toString(),g=h;g<=_;g++){var A=d.translateBufferLineToString(d.ydisp+g,!0),R=(d.ydisp+g+1).toString(),x=this._rowElements[g];x&&(A.length===0?x.innerText="Â ":x.textContent=A,x.setAttribute("aria-posinset",R),x.setAttribute("aria-setsize",b))}this._announceCharacters()},n.prototype._refreshRowsDimensions=function(){if(this._renderService.dimensions.actualCellHeight){this._rowElements.length!==this._terminal.rows&&this._onResize(this._terminal.rows);for(var h=0;h<this._terminal.rows;h++)this._refreshRowDimensions(this._rowElements[h])}},n.prototype._refreshRowDimensions=function(h){h.style.height=this._renderService.dimensions.actualCellHeight+"px"},n.prototype._announceCharacters=function(){this._charsToAnnounce.length!==0&&(this._liveRegion.textContent+=this._charsToAnnounce,this._charsToAnnounce="")},n}(p.Disposable);r.AccessibilityManager=y},3614:(a,r)=>{function u(m){return m.replace(/\r?\n/g,"\r")}function o(m,C){return C?"\x1B[200~"+m+"\x1B[201~":m}function l(m,C,S){m=o(m=u(m),S.decPrivateModes.bracketedPasteMode),S.triggerDataEvent(m,!0),C.value=""}function f(m,C,S){var p=S.getBoundingClientRect(),v=m.clientX-p.left-10,w=m.clientY-p.top-10;C.style.width="20px",C.style.height="20px",C.style.left=v+"px",C.style.top=w+"px",C.style.zIndex="1000",C.focus()}Object.defineProperty(r,"__esModule",{value:!0}),r.rightClickHandler=r.moveTextAreaUnderMouseCursor=r.paste=r.handlePasteEvent=r.copyHandler=r.bracketTextForPaste=r.prepareTextForTerminal=void 0,r.prepareTextForTerminal=u,r.bracketTextForPaste=o,r.copyHandler=function(m,C){m.clipboardData&&m.clipboardData.setData("text/plain",C.selectionText),m.preventDefault()},r.handlePasteEvent=function(m,C,S){m.stopPropagation(),m.clipboardData&&l(m.clipboardData.getData("text/plain"),C,S)},r.paste=l,r.moveTextAreaUnderMouseCursor=f,r.rightClickHandler=function(m,C,S,p,v){f(m,C,S),v&&p.rightClickSelect(m),C.value=p.selectionText,C.select()}},7239:(a,r)=>{Object.defineProperty(r,"__esModule",{value:!0}),r.ColorContrastCache=void 0;var u=function(){function o(){this._color={},this._rgba={}}return o.prototype.clear=function(){this._color={},this._rgba={}},o.prototype.setCss=function(l,f,m){this._rgba[l]||(this._rgba[l]={}),this._rgba[l][f]=m},o.prototype.getCss=function(l,f){return this._rgba[l]?this._rgba[l][f]:void 0},o.prototype.setColor=function(l,f,m){this._color[l]||(this._color[l]={}),this._color[l][f]=m},o.prototype.getColor=function(l,f){return this._color[l]?this._color[l][f]:void 0},o}();r.ColorContrastCache=u},5680:function(a,r,u){var o=this&&this.__read||function(y,c){var n=typeof Symbol=="function"&&y[Symbol.iterator];if(!n)return y;var h,_,d=n.call(y),b=[];try{for(;(c===void 0||c-- >0)&&!(h=d.next()).done;)b.push(h.value)}catch(g){_={error:g}}finally{try{h&&!h.done&&(n=d.return)&&n.call(d)}finally{if(_)throw _.error}}return b};Object.defineProperty(r,"__esModule",{value:!0}),r.ColorManager=r.DEFAULT_ANSI_COLORS=void 0;var l=u(8055),f=u(7239),m=l.css.toColor("#ffffff"),C=l.css.toColor("#000000"),S=l.css.toColor("#ffffff"),p=l.css.toColor("#000000"),v={css:"rgba(255, 255, 255, 0.3)",rgba:4294967117};r.DEFAULT_ANSI_COLORS=Object.freeze(function(){for(var y=[l.css.toColor("#2e3436"),l.css.toColor("#cc0000"),l.css.toColor("#4e9a06"),l.css.toColor("#c4a000"),l.css.toColor("#3465a4"),l.css.toColor("#75507b"),l.css.toColor("#06989a"),l.css.toColor("#d3d7cf"),l.css.toColor("#555753"),l.css.toColor("#ef2929"),l.css.toColor("#8ae234"),l.css.toColor("#fce94f"),l.css.toColor("#729fcf"),l.css.toColor("#ad7fa8"),l.css.toColor("#34e2e2"),l.css.toColor("#eeeeec")],c=[0,95,135,175,215,255],n=0;n<216;n++){var h=c[n/36%6|0],_=c[n/6%6|0],d=c[n%6];y.push({css:l.channels.toCss(h,_,d),rgba:l.channels.toRgba(h,_,d)})}for(n=0;n<24;n++){var b=8+10*n;y.push({css:l.channels.toCss(b,b,b),rgba:l.channels.toRgba(b,b,b)})}return y}());var w=function(){function y(c,n){this.allowTransparency=n;var h=c.createElement("canvas");h.width=1,h.height=1;var _=h.getContext("2d");if(!_)throw new Error("Could not get rendering context");this._ctx=_,this._ctx.globalCompositeOperation="copy",this._litmusColor=this._ctx.createLinearGradient(0,0,1,1),this._contrastCache=new f.ColorContrastCache,this.colors={foreground:m,background:C,cursor:S,cursorAccent:p,selectionTransparent:v,selectionOpaque:l.color.blend(C,v),selectionForeground:void 0,ansi:r.DEFAULT_ANSI_COLORS.slice(),contrastCache:this._contrastCache},this._updateRestoreColors()}return y.prototype.onOptionsChange=function(c){c==="minimumContrastRatio"&&this._contrastCache.clear()},y.prototype.setTheme=function(c){c===void 0&&(c={}),this.colors.foreground=this._parseColor(c.foreground,m),this.colors.background=this._parseColor(c.background,C),this.colors.cursor=this._parseColor(c.cursor,S,!0),this.colors.cursorAccent=this._parseColor(c.cursorAccent,p,!0),this.colors.selectionTransparent=this._parseColor(c.selection,v,!0),this.colors.selectionOpaque=l.color.blend(this.colors.background,this.colors.selectionTransparent);var n={css:"",rgba:0};this.colors.selectionForeground=c.selectionForeground?this._parseColor(c.selectionForeground,n):void 0,this.colors.selectionForeground===n&&(this.colors.selectionForeground=void 0),l.color.isOpaque(this.colors.selectionTransparent)&&(this.colors.selectionTransparent=l.color.opacity(this.colors.selectionTransparent,.3)),this.colors.ansi[0]=this._parseColor(c.black,r.DEFAULT_ANSI_COLORS[0]),this.colors.ansi[1]=this._parseColor(c.red,r.DEFAULT_ANSI_COLORS[1]),this.colors.ansi[2]=this._parseColor(c.green,r.DEFAULT_ANSI_COLORS[2]),this.colors.ansi[3]=this._parseColor(c.yellow,r.DEFAULT_ANSI_COLORS[3]),this.colors.ansi[4]=this._parseColor(c.blue,r.DEFAULT_ANSI_COLORS[4]),this.colors.ansi[5]=this._parseColor(c.magenta,r.DEFAULT_ANSI_COLORS[5]),this.colors.ansi[6]=this._parseColor(c.cyan,r.DEFAULT_ANSI_COLORS[6]),this.colors.ansi[7]=this._parseColor(c.white,r.DEFAULT_ANSI_COLORS[7]),this.colors.ansi[8]=this._parseColor(c.brightBlack,r.DEFAULT_ANSI_COLORS[8]),this.colors.ansi[9]=this._parseColor(c.brightRed,r.DEFAULT_ANSI_COLORS[9]),this.colors.ansi[10]=this._parseColor(c.brightGreen,r.DEFAULT_ANSI_COLORS[10]),this.colors.ansi[11]=this._parseColor(c.brightYellow,r.DEFAULT_ANSI_COLORS[11]),this.colors.ansi[12]=this._parseColor(c.brightBlue,r.DEFAULT_ANSI_COLORS[12]),this.colors.ansi[13]=this._parseColor(c.brightMagenta,r.DEFAULT_ANSI_COLORS[13]),this.colors.ansi[14]=this._parseColor(c.brightCyan,r.DEFAULT_ANSI_COLORS[14]),this.colors.ansi[15]=this._parseColor(c.brightWhite,r.DEFAULT_ANSI_COLORS[15]),this._contrastCache.clear(),this._updateRestoreColors()},y.prototype.restoreColor=function(c){if(c!==void 0)switch(c){case 256:this.colors.foreground=this._restoreColors.foreground;break;case 257:this.colors.background=this._restoreColors.background;break;case 258:this.colors.cursor=this._restoreColors.cursor;break;default:this.colors.ansi[c]=this._restoreColors.ansi[c]}else for(var n=0;n<this._restoreColors.ansi.length;++n)this.colors.ansi[n]=this._restoreColors.ansi[n]},y.prototype._updateRestoreColors=function(){this._restoreColors={foreground:this.colors.foreground,background:this.colors.background,cursor:this.colors.cursor,ansi:this.colors.ansi.slice()}},y.prototype._parseColor=function(c,n,h){if(h===void 0&&(h=this.allowTransparency),c===void 0)return n;if(this._ctx.fillStyle=this._litmusColor,this._ctx.fillStyle=c,typeof this._ctx.fillStyle!="string")return console.warn("Color: "+c+" is invalid using fallback "+n.css),n;this._ctx.fillRect(0,0,1,1);var _=this._ctx.getImageData(0,0,1,1).data;if(_[3]!==255){if(!h)return console.warn("Color: "+c+" is using transparency, but allowTransparency is false. Using fallback "+n.css+"."),n;var d=o(this._ctx.fillStyle.substring(5,this._ctx.fillStyle.length-1).split(",").map(function(k){return Number(k)}),4),b=d[0],g=d[1],A=d[2],R=d[3],x=Math.round(255*R);return{rgba:l.channels.toRgba(b,g,A,x),css:c}}return{css:this._ctx.fillStyle,rgba:l.channels.toRgba(_[0],_[1],_[2],_[3])}},y}();r.ColorManager=w},9631:function(a,r){var u=this&&this.__values||function(o){var l=typeof Symbol=="function"&&Symbol.iterator,f=l&&o[l],m=0;if(f)return f.call(o);if(o&&typeof o.length=="number")return{next:function(){return o&&m>=o.length&&(o=void 0),{value:o&&o[m++],done:!o}}};throw new TypeError(l?"Object is not iterable.":"Symbol.iterator is not defined.")};Object.defineProperty(r,"__esModule",{value:!0}),r.removeElementFromParent=void 0,r.removeElementFromParent=function(){for(var o,l,f,m=[],C=0;C<arguments.length;C++)m[C]=arguments[C];try{for(var S=u(m),p=S.next();!p.done;p=S.next()){var v=p.value;(f=v==null?void 0:v.parentElement)===null||f===void 0||f.removeChild(v)}}catch(w){o={error:w}}finally{try{p&&!p.done&&(l=S.return)&&l.call(S)}finally{if(o)throw o.error}}}},3656:(a,r)=>{Object.defineProperty(r,"__esModule",{value:!0}),r.addDisposableDomListener=void 0,r.addDisposableDomListener=function(u,o,l,f){u.addEventListener(o,l,f);var m=!1;return{dispose:function(){m||(m=!0,u.removeEventListener(o,l,f))}}}},3551:function(a,r,u){var o=this&&this.__decorate||function(p,v,w,y){var c,n=arguments.length,h=n<3?v:y===null?y=Object.getOwnPropertyDescriptor(v,w):y;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")h=Reflect.decorate(p,v,w,y);else for(var _=p.length-1;_>=0;_--)(c=p[_])&&(h=(n<3?c(h):n>3?c(v,w,h):c(v,w))||h);return n>3&&h&&Object.defineProperty(v,w,h),h},l=this&&this.__param||function(p,v){return function(w,y){v(w,y,p)}};Object.defineProperty(r,"__esModule",{value:!0}),r.MouseZone=r.Linkifier=void 0;var f=u(8460),m=u(2585),C=function(){function p(v,w,y){this._bufferService=v,this._logService=w,this._unicodeService=y,this._linkMatchers=[],this._nextLinkMatcherId=0,this._onShowLinkUnderline=new f.EventEmitter,this._onHideLinkUnderline=new f.EventEmitter,this._onLinkTooltip=new f.EventEmitter,this._rowsToLinkify={start:void 0,end:void 0}}return Object.defineProperty(p.prototype,"onShowLinkUnderline",{get:function(){return this._onShowLinkUnderline.event},enumerable:!1,configurable:!0}),Object.defineProperty(p.prototype,"onHideLinkUnderline",{get:function(){return this._onHideLinkUnderline.event},enumerable:!1,configurable:!0}),Object.defineProperty(p.prototype,"onLinkTooltip",{get:function(){return this._onLinkTooltip.event},enumerable:!1,configurable:!0}),p.prototype.attachToDom=function(v,w){this._element=v,this._mouseZoneManager=w},p.prototype.linkifyRows=function(v,w){var y=this;this._mouseZoneManager&&(this._rowsToLinkify.start===void 0||this._rowsToLinkify.end===void 0?(this._rowsToLinkify.start=v,this._rowsToLinkify.end=w):(this._rowsToLinkify.start=Math.min(this._rowsToLinkify.start,v),this._rowsToLinkify.end=Math.max(this._rowsToLinkify.end,w)),this._mouseZoneManager.clearAll(v,w),this._rowsTimeoutId&&clearTimeout(this._rowsTimeoutId),this._rowsTimeoutId=setTimeout(function(){return y._linkifyRows()},p._timeBeforeLatency))},p.prototype._linkifyRows=function(){this._rowsTimeoutId=void 0;var v=this._bufferService.buffer;if(this._rowsToLinkify.start!==void 0&&this._rowsToLinkify.end!==void 0){var w=v.ydisp+this._rowsToLinkify.start;if(!(w>=v.lines.length)){for(var y=v.ydisp+Math.min(this._rowsToLinkify.end,this._bufferService.rows)+1,c=Math.ceil(2e3/this._bufferService.cols),n=this._bufferService.buffer.iterator(!1,w,y,c,c);n.hasNext();)for(var h=n.next(),_=0;_<this._linkMatchers.length;_++)this._doLinkifyRow(h.range.first,h.content,this._linkMatchers[_]);this._rowsToLinkify.start=void 0,this._rowsToLinkify.end=void 0}}else this._logService.debug("_rowToLinkify was unset before _linkifyRows was called")},p.prototype.registerLinkMatcher=function(v,w,y){if(y===void 0&&(y={}),!w)throw new Error("handler must be defined");var c={id:this._nextLinkMatcherId++,regex:v,handler:w,matchIndex:y.matchIndex,validationCallback:y.validationCallback,hoverTooltipCallback:y.tooltipCallback,hoverLeaveCallback:y.leaveCallback,willLinkActivate:y.willLinkActivate,priority:y.priority||0};return this._addLinkMatcherToList(c),c.id},p.prototype._addLinkMatcherToList=function(v){if(this._linkMatchers.length!==0){for(var w=this._linkMatchers.length-1;w>=0;w--)if(v.priority<=this._linkMatchers[w].priority)return void this._linkMatchers.splice(w+1,0,v);this._linkMatchers.splice(0,0,v)}else this._linkMatchers.push(v)},p.prototype.deregisterLinkMatcher=function(v){for(var w=0;w<this._linkMatchers.length;w++)if(this._linkMatchers[w].id===v)return this._linkMatchers.splice(w,1),!0;return!1},p.prototype._doLinkifyRow=function(v,w,y){for(var c,n=this,h=new RegExp(y.regex.source,(y.regex.flags||"")+"g"),_=-1,d=function(){var g=c[typeof y.matchIndex!="number"?0:y.matchIndex];if(!g)return b._logService.debug("match found without corresponding matchIndex",c,y),"break";if(_=w.indexOf(g,_+1),h.lastIndex=_+g.length,_<0)return"break";var A=b._bufferService.buffer.stringIndexToBufferIndex(v,_);if(A[0]<0)return"break";var R=b._bufferService.buffer.lines.get(A[0]);if(!R)return"break";var x=R.getFg(A[1]),k=x?x>>9&511:void 0;y.validationCallback?y.validationCallback(g,function(O){n._rowsTimeoutId||O&&n._addLink(A[1],A[0]-n._bufferService.buffer.ydisp,g,y,k)}):b._addLink(A[1],A[0]-b._bufferService.buffer.ydisp,g,y,k)},b=this;(c=h.exec(w))!==null&&d()!=="break";);},p.prototype._addLink=function(v,w,y,c,n){var h=this;if(this._mouseZoneManager&&this._element){var _=this._unicodeService.getStringCellWidth(y),d=v%this._bufferService.cols,b=w+Math.floor(v/this._bufferService.cols),g=(d+_)%this._bufferService.cols,A=b+Math.floor((d+_)/this._bufferService.cols);g===0&&(g=this._bufferService.cols,A--),this._mouseZoneManager.add(new S(d+1,b+1,g+1,A+1,function(R){if(c.handler)return c.handler(R,y);var x=window.open();x?(x.opener=null,x.location.href=y):console.warn("Opening link blocked as opener could not be cleared")},function(){h._onShowLinkUnderline.fire(h._createLinkHoverEvent(d,b,g,A,n)),h._element.classList.add("xterm-cursor-pointer")},function(R){h._onLinkTooltip.fire(h._createLinkHoverEvent(d,b,g,A,n)),c.hoverTooltipCallback&&c.hoverTooltipCallback(R,y,{start:{x:d,y:b},end:{x:g,y:A}})},function(){h._onHideLinkUnderline.fire(h._createLinkHoverEvent(d,b,g,A,n)),h._element.classList.remove("xterm-cursor-pointer"),c.hoverLeaveCallback&&c.hoverLeaveCallback()},function(R){return!c.willLinkActivate||c.willLinkActivate(R,y)}))}},p.prototype._createLinkHoverEvent=function(v,w,y,c,n){return{x1:v,y1:w,x2:y,y2:c,cols:this._bufferService.cols,fg:n}},p._timeBeforeLatency=200,p=o([l(0,m.IBufferService),l(1,m.ILogService),l(2,m.IUnicodeService)],p)}();r.Linkifier=C;var S=function(p,v,w,y,c,n,h,_,d){this.x1=p,this.y1=v,this.x2=w,this.y2=y,this.clickCallback=c,this.hoverCallback=n,this.tooltipCallback=h,this.leaveCallback=_,this.willLinkActivate=d};r.MouseZone=S},6465:function(a,r,u){var o,l=this&&this.__extends||(o=function(n,h){return o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(_,d){_.__proto__=d}||function(_,d){for(var b in d)Object.prototype.hasOwnProperty.call(d,b)&&(_[b]=d[b])},o(n,h)},function(n,h){if(typeof h!="function"&&h!==null)throw new TypeError("Class extends value "+String(h)+" is not a constructor or null");function _(){this.constructor=n}o(n,h),n.prototype=h===null?Object.create(h):(_.prototype=h.prototype,new _)}),f=this&&this.__decorate||function(n,h,_,d){var b,g=arguments.length,A=g<3?h:d===null?d=Object.getOwnPropertyDescriptor(h,_):d;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")A=Reflect.decorate(n,h,_,d);else for(var R=n.length-1;R>=0;R--)(b=n[R])&&(A=(g<3?b(A):g>3?b(h,_,A):b(h,_))||A);return g>3&&A&&Object.defineProperty(h,_,A),A},m=this&&this.__param||function(n,h){return function(_,d){h(_,d,n)}},C=this&&this.__values||function(n){var h=typeof Symbol=="function"&&Symbol.iterator,_=h&&n[h],d=0;if(_)return _.call(n);if(n&&typeof n.length=="number")return{next:function(){return n&&d>=n.length&&(n=void 0),{value:n&&n[d++],done:!n}}};throw new TypeError(h?"Object is not iterable.":"Symbol.iterator is not defined.")},S=this&&this.__read||function(n,h){var _=typeof Symbol=="function"&&n[Symbol.iterator];if(!_)return n;var d,b,g=_.call(n),A=[];try{for(;(h===void 0||h-- >0)&&!(d=g.next()).done;)A.push(d.value)}catch(R){b={error:R}}finally{try{d&&!d.done&&(_=g.return)&&_.call(g)}finally{if(b)throw b.error}}return A};Object.defineProperty(r,"__esModule",{value:!0}),r.Linkifier2=void 0;var p=u(2585),v=u(8460),w=u(844),y=u(3656),c=function(n){function h(_){var d=n.call(this)||this;return d._bufferService=_,d._linkProviders=[],d._linkCacheDisposables=[],d._isMouseOut=!0,d._activeLine=-1,d._onShowLinkUnderline=d.register(new v.EventEmitter),d._onHideLinkUnderline=d.register(new v.EventEmitter),d.register((0,w.getDisposeArrayDisposable)(d._linkCacheDisposables)),d}return l(h,n),Object.defineProperty(h.prototype,"currentLink",{get:function(){return this._currentLink},enumerable:!1,configurable:!0}),Object.defineProperty(h.prototype,"onShowLinkUnderline",{get:function(){return this._onShowLinkUnderline.event},enumerable:!1,configurable:!0}),Object.defineProperty(h.prototype,"onHideLinkUnderline",{get:function(){return this._onHideLinkUnderline.event},enumerable:!1,configurable:!0}),h.prototype.registerLinkProvider=function(_){var d=this;return this._linkProviders.push(_),{dispose:function(){var b=d._linkProviders.indexOf(_);b!==-1&&d._linkProviders.splice(b,1)}}},h.prototype.attachToDom=function(_,d,b){var g=this;this._element=_,this._mouseService=d,this._renderService=b,this.register((0,y.addDisposableDomListener)(this._element,"mouseleave",function(){g._isMouseOut=!0,g._clearCurrentLink()})),this.register((0,y.addDisposableDomListener)(this._element,"mousemove",this._onMouseMove.bind(this))),this.register((0,y.addDisposableDomListener)(this._element,"mousedown",this._handleMouseDown.bind(this))),this.register((0,y.addDisposableDomListener)(this._element,"mouseup",this._handleMouseUp.bind(this)))},h.prototype._onMouseMove=function(_){if(this._lastMouseEvent=_,this._element&&this._mouseService){var d=this._positionFromMouseEvent(_,this._element,this._mouseService);if(d){this._isMouseOut=!1;for(var b=_.composedPath(),g=0;g<b.length;g++){var A=b[g];if(A.classList.contains("xterm"))break;if(A.classList.contains("xterm-hover"))return}this._lastBufferCell&&d.x===this._lastBufferCell.x&&d.y===this._lastBufferCell.y||(this._onHover(d),this._lastBufferCell=d)}}},h.prototype._onHover=function(_){if(this._activeLine!==_.y)return this._clearCurrentLink(),void this._askForLink(_,!1);this._currentLink&&this._linkAtPosition(this._currentLink.link,_)||(this._clearCurrentLink(),this._askForLink(_,!0))},h.prototype._askForLink=function(_,d){var b,g,A,R,x=this;this._activeProviderReplies&&d||((A=this._activeProviderReplies)===null||A===void 0||A.forEach(function(D){D==null||D.forEach(function(q){q.link.dispose&&q.link.dispose()})}),this._activeProviderReplies=new Map,this._activeLine=_.y);var k=!1,O=function(D,q){d?!((R=I._activeProviderReplies)===null||R===void 0)&&R.get(D)&&(k=I._checkLinkProviderResult(D,_,k)):q.provideLinks(_.y,function(H){var X,$;if(!x._isMouseOut){var G=H==null?void 0:H.map(function(ie){return{link:ie}});(X=x._activeProviderReplies)===null||X===void 0||X.set(D,G),k=x._checkLinkProviderResult(D,_,k),(($=x._activeProviderReplies)===null||$===void 0?void 0:$.size)===x._linkProviders.length&&x._removeIntersectingLinks(_.y,x._activeProviderReplies)}})},I=this;try{for(var T=C(this._linkProviders.entries()),P=T.next();!P.done;P=T.next()){var M=S(P.value,2);O(M[0],M[1])}}catch(D){b={error:D}}finally{try{P&&!P.done&&(g=T.return)&&g.call(T)}finally{if(b)throw b.error}}},h.prototype._removeIntersectingLinks=function(_,d){for(var b=new Set,g=0;g<d.size;g++){var A=d.get(g);if(A)for(var R=0;R<A.length;R++)for(var x=A[R],k=x.link.range.start.y<_?0:x.link.range.start.x,O=x.link.range.end.y>_?this._bufferService.cols:x.link.range.end.x,I=k;I<=O;I++){if(b.has(I)){A.splice(R--,1);break}b.add(I)}}},h.prototype._checkLinkProviderResult=function(_,d,b){var g,A=this;if(!this._activeProviderReplies)return b;for(var R=this._activeProviderReplies.get(_),x=!1,k=0;k<_;k++)this._activeProviderReplies.has(k)&&!this._activeProviderReplies.get(k)||(x=!0);if(!x&&R){var O=R.find(function(T){return A._linkAtPosition(T.link,d)});O&&(b=!0,this._handleNewLink(O))}if(this._activeProviderReplies.size===this._linkProviders.length&&!b)for(k=0;k<this._activeProviderReplies.size;k++){var I=(g=this._activeProviderReplies.get(k))===null||g===void 0?void 0:g.find(function(T){return A._linkAtPosition(T.link,d)});if(I){b=!0,this._handleNewLink(I);break}}return b},h.prototype._handleMouseDown=function(){this._mouseDownLink=this._currentLink},h.prototype._handleMouseUp=function(_){if(this._element&&this._mouseService&&this._currentLink){var d=this._positionFromMouseEvent(_,this._element,this._mouseService);d&&this._mouseDownLink===this._currentLink&&this._linkAtPosition(this._currentLink.link,d)&&this._currentLink.link.activate(_,this._currentLink.link.text)}},h.prototype._clearCurrentLink=function(_,d){this._element&&this._currentLink&&this._lastMouseEvent&&(!_||!d||this._currentLink.link.range.start.y>=_&&this._currentLink.link.range.end.y<=d)&&(this._linkLeave(this._element,this._currentLink.link,this._lastMouseEvent),this._currentLink=void 0,(0,w.disposeArray)(this._linkCacheDisposables))},h.prototype._handleNewLink=function(_){var d=this;if(this._element&&this._lastMouseEvent&&this._mouseService){var b=this._positionFromMouseEvent(this._lastMouseEvent,this._element,this._mouseService);b&&this._linkAtPosition(_.link,b)&&(this._currentLink=_,this._currentLink.state={decorations:{underline:_.link.decorations===void 0||_.link.decorations.underline,pointerCursor:_.link.decorations===void 0||_.link.decorations.pointerCursor},isHovered:!0},this._linkHover(this._element,_.link,this._lastMouseEvent),_.link.decorations={},Object.defineProperties(_.link.decorations,{pointerCursor:{get:function(){var g,A;return(A=(g=d._currentLink)===null||g===void 0?void 0:g.state)===null||A===void 0?void 0:A.decorations.pointerCursor},set:function(g){var A,R;!((A=d._currentLink)===null||A===void 0)&&A.state&&d._currentLink.state.decorations.pointerCursor!==g&&(d._currentLink.state.decorations.pointerCursor=g,d._currentLink.state.isHovered&&((R=d._element)===null||R===void 0||R.classList.toggle("xterm-cursor-pointer",g)))}},underline:{get:function(){var g,A;return(A=(g=d._currentLink)===null||g===void 0?void 0:g.state)===null||A===void 0?void 0:A.decorations.underline},set:function(g){var A,R,x;!((A=d._currentLink)===null||A===void 0)&&A.state&&((x=(R=d._currentLink)===null||R===void 0?void 0:R.state)===null||x===void 0?void 0:x.decorations.underline)!==g&&(d._currentLink.state.decorations.underline=g,d._currentLink.state.isHovered&&d._fireUnderlineEvent(_.link,g))}}}),this._renderService&&this._linkCacheDisposables.push(this._renderService.onRenderedViewportChange(function(g){var A=g.start===0?0:g.start+1+d._bufferService.buffer.ydisp;d._clearCurrentLink(A,g.end+1+d._bufferService.buffer.ydisp)})))}},h.prototype._linkHover=function(_,d,b){var g;!((g=this._currentLink)===null||g===void 0)&&g.state&&(this._currentLink.state.isHovered=!0,this._currentLink.state.decorations.underline&&this._fireUnderlineEvent(d,!0),this._currentLink.state.decorations.pointerCursor&&_.classList.add("xterm-cursor-pointer")),d.hover&&d.hover(b,d.text)},h.prototype._fireUnderlineEvent=function(_,d){var b=_.range,g=this._bufferService.buffer.ydisp,A=this._createLinkUnderlineEvent(b.start.x-1,b.start.y-g-1,b.end.x,b.end.y-g-1,void 0);(d?this._onShowLinkUnderline:this._onHideLinkUnderline).fire(A)},h.prototype._linkLeave=function(_,d,b){var g;!((g=this._currentLink)===null||g===void 0)&&g.state&&(this._currentLink.state.isHovered=!1,this._currentLink.state.decorations.underline&&this._fireUnderlineEvent(d,!1),this._currentLink.state.decorations.pointerCursor&&_.classList.remove("xterm-cursor-pointer")),d.leave&&d.leave(b,d.text)},h.prototype._linkAtPosition=function(_,d){var b=_.range.start.y===_.range.end.y,g=_.range.start.y<d.y,A=_.range.end.y>d.y;return(b&&_.range.start.x<=d.x&&_.range.end.x>=d.x||g&&_.range.end.x>=d.x||A&&_.range.start.x<=d.x||g&&A)&&_.range.start.y<=d.y&&_.range.end.y>=d.y},h.prototype._positionFromMouseEvent=function(_,d,b){var g=b.getCoords(_,d,this._bufferService.cols,this._bufferService.rows);if(g)return{x:g[0],y:g[1]+this._bufferService.buffer.ydisp}},h.prototype._createLinkUnderlineEvent=function(_,d,b,g,A){return{x1:_,y1:d,x2:b,y2:g,cols:this._bufferService.cols,fg:A}},f([m(0,p.IBufferService)],h)}(w.Disposable);r.Linkifier2=c},9042:(a,r)=>{Object.defineProperty(r,"__esModule",{value:!0}),r.tooMuchOutput=r.promptLabel=void 0,r.promptLabel="Terminal input",r.tooMuchOutput="Too much output to announce, navigate to rows manually to read"},6954:function(a,r,u){var o,l=this&&this.__extends||(o=function(y,c){return o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(n,h){n.__proto__=h}||function(n,h){for(var _ in h)Object.prototype.hasOwnProperty.call(h,_)&&(n[_]=h[_])},o(y,c)},function(y,c){if(typeof c!="function"&&c!==null)throw new TypeError("Class extends value "+String(c)+" is not a constructor or null");function n(){this.constructor=y}o(y,c),y.prototype=c===null?Object.create(c):(n.prototype=c.prototype,new n)}),f=this&&this.__decorate||function(y,c,n,h){var _,d=arguments.length,b=d<3?c:h===null?h=Object.getOwnPropertyDescriptor(c,n):h;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")b=Reflect.decorate(y,c,n,h);else for(var g=y.length-1;g>=0;g--)(_=y[g])&&(b=(d<3?_(b):d>3?_(c,n,b):_(c,n))||b);return d>3&&b&&Object.defineProperty(c,n,b),b},m=this&&this.__param||function(y,c){return function(n,h){c(n,h,y)}};Object.defineProperty(r,"__esModule",{value:!0}),r.MouseZoneManager=void 0;var C=u(844),S=u(3656),p=u(4725),v=u(2585),w=function(y){function c(n,h,_,d,b,g){var A=y.call(this)||this;return A._element=n,A._screenElement=h,A._bufferService=_,A._mouseService=d,A._selectionService=b,A._optionsService=g,A._zones=[],A._areZonesActive=!1,A._lastHoverCoords=[void 0,void 0],A._initialSelectionLength=0,A.register((0,S.addDisposableDomListener)(A._element,"mousedown",function(R){return A._onMouseDown(R)})),A._mouseMoveListener=function(R){return A._onMouseMove(R)},A._mouseLeaveListener=function(R){return A._onMouseLeave(R)},A._clickListener=function(R){return A._onClick(R)},A}return l(c,y),c.prototype.dispose=function(){y.prototype.dispose.call(this),this._deactivate()},c.prototype.add=function(n){this._zones.push(n),this._zones.length===1&&this._activate()},c.prototype.clearAll=function(n,h){if(this._zones.length!==0){n&&h||(n=0,h=this._bufferService.rows-1);for(var _=0;_<this._zones.length;_++){var d=this._zones[_];(d.y1>n&&d.y1<=h+1||d.y2>n&&d.y2<=h+1||d.y1<n&&d.y2>h+1)&&(this._currentZone&&this._currentZone===d&&(this._currentZone.leaveCallback(),this._currentZone=void 0),this._zones.splice(_--,1))}this._zones.length===0&&this._deactivate()}},c.prototype._activate=function(){this._areZonesActive||(this._areZonesActive=!0,this._element.addEventListener("mousemove",this._mouseMoveListener),this._element.addEventListener("mouseleave",this._mouseLeaveListener),this._element.addEventListener("click",this._clickListener))},c.prototype._deactivate=function(){this._areZonesActive&&(this._areZonesActive=!1,this._element.removeEventListener("mousemove",this._mouseMoveListener),this._element.removeEventListener("mouseleave",this._mouseLeaveListener),this._element.removeEventListener("click",this._clickListener))},c.prototype._onMouseMove=function(n){this._lastHoverCoords[0]===n.pageX&&this._lastHoverCoords[1]===n.pageY||(this._onHover(n),this._lastHoverCoords=[n.pageX,n.pageY])},c.prototype._onHover=function(n){var h=this,_=this._findZoneEventAt(n);_!==this._currentZone&&(this._currentZone&&(this._currentZone.leaveCallback(),this._currentZone=void 0,this._tooltipTimeout&&clearTimeout(this._tooltipTimeout)),_&&(this._currentZone=_,_.hoverCallback&&_.hoverCallback(n),this._tooltipTimeout=window.setTimeout(function(){return h._onTooltip(n)},this._optionsService.rawOptions.linkTooltipHoverDuration)))},c.prototype._onTooltip=function(n){this._tooltipTimeout=void 0;var h=this._findZoneEventAt(n);h==null||h.tooltipCallback(n)},c.prototype._onMouseDown=function(n){if(this._initialSelectionLength=this._getSelectionLength(),this._areZonesActive){var h=this._findZoneEventAt(n);h!=null&&h.willLinkActivate(n)&&(n.preventDefault(),n.stopImmediatePropagation())}},c.prototype._onMouseLeave=function(n){this._currentZone&&(this._currentZone.leaveCallback(),this._currentZone=void 0,this._tooltipTimeout&&clearTimeout(this._tooltipTimeout))},c.prototype._onClick=function(n){var h=this._findZoneEventAt(n),_=this._getSelectionLength();h&&_===this._initialSelectionLength&&(h.clickCallback(n),n.preventDefault(),n.stopImmediatePropagation())},c.prototype._getSelectionLength=function(){var n=this._selectionService.selectionText;return n?n.length:0},c.prototype._findZoneEventAt=function(n){var h=this._mouseService.getCoords(n,this._screenElement,this._bufferService.cols,this._bufferService.rows);if(h)for(var _=h[0],d=h[1],b=0;b<this._zones.length;b++){var g=this._zones[b];if(g.y1===g.y2){if(d===g.y1&&_>=g.x1&&_<g.x2)return g}else if(d===g.y1&&_>=g.x1||d===g.y2&&_<g.x2||d>g.y1&&d<g.y2)return g}},f([m(2,v.IBufferService),m(3,p.IMouseService),m(4,p.ISelectionService),m(5,v.IOptionsService)],c)}(C.Disposable);r.MouseZoneManager=w},6193:function(a,r){var u=this&&this.__values||function(l){var f=typeof Symbol=="function"&&Symbol.iterator,m=f&&l[f],C=0;if(m)return m.call(l);if(l&&typeof l.length=="number")return{next:function(){return l&&C>=l.length&&(l=void 0),{value:l&&l[C++],done:!l}}};throw new TypeError(f?"Object is not iterable.":"Symbol.iterator is not defined.")};Object.defineProperty(r,"__esModule",{value:!0}),r.RenderDebouncer=void 0;var o=function(){function l(f){this._renderCallback=f,this._refreshCallbacks=[]}return l.prototype.dispose=function(){this._animationFrame&&(window.cancelAnimationFrame(this._animationFrame),this._animationFrame=void 0)},l.prototype.addRefreshCallback=function(f){var m=this;return this._refreshCallbacks.push(f),this._animationFrame||(this._animationFrame=window.requestAnimationFrame(function(){return m._innerRefresh()})),this._animationFrame},l.prototype.refresh=function(f,m,C){var S=this;this._rowCount=C,f=f!==void 0?f:0,m=m!==void 0?m:this._rowCount-1,this._rowStart=this._rowStart!==void 0?Math.min(this._rowStart,f):f,this._rowEnd=this._rowEnd!==void 0?Math.max(this._rowEnd,m):m,this._animationFrame||(this._animationFrame=window.requestAnimationFrame(function(){return S._innerRefresh()}))},l.prototype._innerRefresh=function(){if(this._animationFrame=void 0,this._rowStart!==void 0&&this._rowEnd!==void 0&&this._rowCount!==void 0){var f=Math.max(this._rowStart,0),m=Math.min(this._rowEnd,this._rowCount-1);this._rowStart=void 0,this._rowEnd=void 0,this._renderCallback(f,m),this._runRefreshCallbacks()}else this._runRefreshCallbacks()},l.prototype._runRefreshCallbacks=function(){var f,m;try{for(var C=u(this._refreshCallbacks),S=C.next();!S.done;S=C.next())(0,S.value)(0)}catch(p){f={error:p}}finally{try{S&&!S.done&&(m=C.return)&&m.call(C)}finally{if(f)throw f.error}}this._refreshCallbacks=[]},l}();r.RenderDebouncer=o},5596:function(a,r,u){var o,l=this&&this.__extends||(o=function(m,C){return o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(S,p){S.__proto__=p}||function(S,p){for(var v in p)Object.prototype.hasOwnProperty.call(p,v)&&(S[v]=p[v])},o(m,C)},function(m,C){if(typeof C!="function"&&C!==null)throw new TypeError("Class extends value "+String(C)+" is not a constructor or null");function S(){this.constructor=m}o(m,C),m.prototype=C===null?Object.create(C):(S.prototype=C.prototype,new S)});Object.defineProperty(r,"__esModule",{value:!0}),r.ScreenDprMonitor=void 0;var f=function(m){function C(){var S=m!==null&&m.apply(this,arguments)||this;return S._currentDevicePixelRatio=window.devicePixelRatio,S}return l(C,m),C.prototype.setListener=function(S){var p=this;this._listener&&this.clearListener(),this._listener=S,this._outerListener=function(){p._listener&&(p._listener(window.devicePixelRatio,p._currentDevicePixelRatio),p._updateDpr())},this._updateDpr()},C.prototype.dispose=function(){m.prototype.dispose.call(this),this.clearListener()},C.prototype._updateDpr=function(){var S;this._outerListener&&((S=this._resolutionMediaMatchList)===null||S===void 0||S.removeListener(this._outerListener),this._currentDevicePixelRatio=window.devicePixelRatio,this._resolutionMediaMatchList=window.matchMedia("screen and (resolution: "+window.devicePixelRatio+"dppx)"),this._resolutionMediaMatchList.addListener(this._outerListener))},C.prototype.clearListener=function(){this._resolutionMediaMatchList&&this._listener&&this._outerListener&&(this._resolutionMediaMatchList.removeListener(this._outerListener),this._resolutionMediaMatchList=void 0,this._listener=void 0,this._outerListener=void 0)},C}(u(844).Disposable);r.ScreenDprMonitor=f},3236:function(a,r,u){var o,l=this&&this.__extends||(o=function(le,K){return o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(F,U){F.__proto__=U}||function(F,U){for(var W in U)Object.prototype.hasOwnProperty.call(U,W)&&(F[W]=U[W])},o(le,K)},function(le,K){if(typeof K!="function"&&K!==null)throw new TypeError("Class extends value "+String(K)+" is not a constructor or null");function F(){this.constructor=le}o(le,K),le.prototype=K===null?Object.create(K):(F.prototype=K.prototype,new F)}),f=this&&this.__values||function(le){var K=typeof Symbol=="function"&&Symbol.iterator,F=K&&le[K],U=0;if(F)return F.call(le);if(le&&typeof le.length=="number")return{next:function(){return le&&U>=le.length&&(le=void 0),{value:le&&le[U++],done:!le}}};throw new TypeError(K?"Object is not iterable.":"Symbol.iterator is not defined.")},m=this&&this.__read||function(le,K){var F=typeof Symbol=="function"&&le[Symbol.iterator];if(!F)return le;var U,W,ae=F.call(le),he=[];try{for(;(K===void 0||K-- >0)&&!(U=ae.next()).done;)he.push(U.value)}catch(me){W={error:me}}finally{try{U&&!U.done&&(F=ae.return)&&F.call(ae)}finally{if(W)throw W.error}}return he},C=this&&this.__spreadArray||function(le,K,F){if(F||arguments.length===2)for(var U,W=0,ae=K.length;W<ae;W++)!U&&W in K||(U||(U=Array.prototype.slice.call(K,0,W)),U[W]=K[W]);return le.concat(U||Array.prototype.slice.call(K))};Object.defineProperty(r,"__esModule",{value:!0}),r.Terminal=void 0;var S=u(2950),p=u(1680),v=u(3614),w=u(2584),y=u(5435),c=u(3525),n=u(3551),h=u(9312),_=u(6114),d=u(3656),b=u(9042),g=u(357),A=u(6954),R=u(4567),x=u(1296),k=u(7399),O=u(8460),I=u(8437),T=u(5680),P=u(3230),M=u(4725),D=u(428),q=u(8934),H=u(6465),X=u(5114),$=u(8969),G=u(8055),ie=u(4269),ee=u(5941),B=u(3107),pe=u(5744),de=u(9074),Oe=u(2585),N=typeof window<"u"?window.document:null,xe=function(le){function K(F){F===void 0&&(F={});var U=le.call(this,F)||this;return U.browser=_,U._keyDownHandled=!1,U._keyDownSeen=!1,U._keyPressHandled=!1,U._unprocessedDeadKey=!1,U._onCursorMove=new O.EventEmitter,U._onKey=new O.EventEmitter,U._onRender=new O.EventEmitter,U._onSelectionChange=new O.EventEmitter,U._onTitleChange=new O.EventEmitter,U._onBell=new O.EventEmitter,U._onFocus=new O.EventEmitter,U._onBlur=new O.EventEmitter,U._onA11yCharEmitter=new O.EventEmitter,U._onA11yTabEmitter=new O.EventEmitter,U._setup(),U.linkifier=U._instantiationService.createInstance(n.Linkifier),U.linkifier2=U.register(U._instantiationService.createInstance(H.Linkifier2)),U._decorationService=U._instantiationService.createInstance(de.DecorationService),U._instantiationService.setService(Oe.IDecorationService,U._decorationService),U.register(U._inputHandler.onRequestBell(function(){return U.bell()})),U.register(U._inputHandler.onRequestRefreshRows(function(W,ae){return U.refresh(W,ae)})),U.register(U._inputHandler.onRequestSendFocus(function(){return U._reportFocus()})),U.register(U._inputHandler.onRequestReset(function(){return U.reset()})),U.register(U._inputHandler.onRequestWindowsOptionsReport(function(W){return U._reportWindowsOptions(W)})),U.register(U._inputHandler.onColor(function(W){return U._handleColorEvent(W)})),U.register((0,O.forwardEvent)(U._inputHandler.onCursorMove,U._onCursorMove)),U.register((0,O.forwardEvent)(U._inputHandler.onTitleChange,U._onTitleChange)),U.register((0,O.forwardEvent)(U._inputHandler.onA11yChar,U._onA11yCharEmitter)),U.register((0,O.forwardEvent)(U._inputHandler.onA11yTab,U._onA11yTabEmitter)),U.register(U._bufferService.onResize(function(W){return U._afterResize(W.cols,W.rows)})),U}return l(K,le),Object.defineProperty(K.prototype,"onCursorMove",{get:function(){return this._onCursorMove.event},enumerable:!1,configurable:!0}),Object.defineProperty(K.prototype,"onKey",{get:function(){return this._onKey.event},enumerable:!1,configurable:!0}),Object.defineProperty(K.prototype,"onRender",{get:function(){return this._onRender.event},enumerable:!1,configurable:!0}),Object.defineProperty(K.prototype,"onSelectionChange",{get:function(){return this._onSelectionChange.event},enumerable:!1,configurable:!0}),Object.defineProperty(K.prototype,"onTitleChange",{get:function(){return this._onTitleChange.event},enumerable:!1,configurable:!0}),Object.defineProperty(K.prototype,"onBell",{get:function(){return this._onBell.event},enumerable:!1,configurable:!0}),Object.defineProperty(K.prototype,"onFocus",{get:function(){return this._onFocus.event},enumerable:!1,configurable:!0}),Object.defineProperty(K.prototype,"onBlur",{get:function(){return this._onBlur.event},enumerable:!1,configurable:!0}),Object.defineProperty(K.prototype,"onA11yChar",{get:function(){return this._onA11yCharEmitter.event},enumerable:!1,configurable:!0}),Object.defineProperty(K.prototype,"onA11yTab",{get:function(){return this._onA11yTabEmitter.event},enumerable:!1,configurable:!0}),K.prototype._handleColorEvent=function(F){var U,W,ae,he;if(this._colorManager){try{for(var me=f(F),De=me.next();!De.done;De=me.next()){var He=De.value,Ne=void 0,re="";switch(He.index){case 256:Ne="foreground",re="10";break;case 257:Ne="background",re="11";break;case 258:Ne="cursor",re="12";break;default:Ne="ansi",re="4;"+He.index}if(Ne)switch(He.type){case 0:var ze=G.color.toColorRGB(Ne==="ansi"?this._colorManager.colors.ansi[He.index]:this._colorManager.colors[Ne]);this.coreService.triggerDataEvent(w.C0.ESC+"]"+re+";"+(0,ee.toRgbString)(ze)+w.C1_ESCAPED.ST);break;case 1:Ne==="ansi"?this._colorManager.colors.ansi[He.index]=G.rgba.toColor.apply(G.rgba,C([],m(He.color),!1)):this._colorManager.colors[Ne]=G.rgba.toColor.apply(G.rgba,C([],m(He.color),!1));break;case 2:this._colorManager.restoreColor(He.index)}}}catch(et){U={error:et}}finally{try{De&&!De.done&&(W=me.return)&&W.call(me)}finally{if(U)throw U.error}}(ae=this._renderService)===null||ae===void 0||ae.setColors(this._colorManager.colors),(he=this.viewport)===null||he===void 0||he.onThemeChange(this._colorManager.colors)}},K.prototype.dispose=function(){var F,U,W;this._isDisposed||(le.prototype.dispose.call(this),(F=this._renderService)===null||F===void 0||F.dispose(),this._customKeyEventHandler=void 0,this.write=function(){},(W=(U=this.element)===null||U===void 0?void 0:U.parentNode)===null||W===void 0||W.removeChild(this.element))},K.prototype._setup=function(){le.prototype._setup.call(this),this._customKeyEventHandler=void 0},Object.defineProperty(K.prototype,"buffer",{get:function(){return this.buffers.active},enumerable:!1,configurable:!0}),K.prototype.focus=function(){this.textarea&&this.textarea.focus({preventScroll:!0})},K.prototype._updateOptions=function(F){var U,W,ae,he;switch(le.prototype._updateOptions.call(this,F),F){case"fontFamily":case"fontSize":(U=this._renderService)===null||U===void 0||U.clear(),(W=this._charSizeService)===null||W===void 0||W.measure();break;case"cursorBlink":case"cursorStyle":this.refresh(this.buffer.y,this.buffer.y);break;case"customGlyphs":case"drawBoldTextInBrightColors":case"letterSpacing":case"lineHeight":case"fontWeight":case"fontWeightBold":case"minimumContrastRatio":this._renderService&&(this._renderService.clear(),this._renderService.onResize(this.cols,this.rows),this.refresh(0,this.rows-1));break;case"rendererType":this._renderService&&(this._renderService.setRenderer(this._createRenderer()),this._renderService.onResize(this.cols,this.rows));break;case"scrollback":(ae=this.viewport)===null||ae===void 0||ae.syncScrollArea();break;case"screenReaderMode":this.optionsService.rawOptions.screenReaderMode?!this._accessibilityManager&&this._renderService&&(this._accessibilityManager=new R.AccessibilityManager(this,this._renderService)):((he=this._accessibilityManager)===null||he===void 0||he.dispose(),this._accessibilityManager=void 0);break;case"tabStopWidth":this.buffers.setupTabStops();break;case"theme":this._setTheme(this.optionsService.rawOptions.theme)}},K.prototype._onTextAreaFocus=function(F){this.coreService.decPrivateModes.sendFocus&&this.coreService.triggerDataEvent(w.C0.ESC+"[I"),this.updateCursorStyle(F),this.element.classList.add("focus"),this._showCursor(),this._onFocus.fire()},K.prototype.blur=function(){var F;return(F=this.textarea)===null||F===void 0?void 0:F.blur()},K.prototype._onTextAreaBlur=function(){this.textarea.value="",this.refresh(this.buffer.y,this.buffer.y),this.coreService.decPrivateModes.sendFocus&&this.coreService.triggerDataEvent(w.C0.ESC+"[O"),this.element.classList.remove("focus"),this._onBlur.fire()},K.prototype._syncTextArea=function(){if(this.textarea&&this.buffer.isCursorInViewport&&!this._compositionHelper.isComposing&&this._renderService){var F=this.buffer.ybase+this.buffer.y,U=this.buffer.lines.get(F);if(U){var W=Math.min(this.buffer.x,this.cols-1),ae=this._renderService.dimensions.actualCellHeight,he=U.getWidth(W),me=this._renderService.dimensions.actualCellWidth*he,De=this.buffer.y*this._renderService.dimensions.actualCellHeight,He=W*this._renderService.dimensions.actualCellWidth;this.textarea.style.left=He+"px",this.textarea.style.top=De+"px",this.textarea.style.width=me+"px",this.textarea.style.height=ae+"px",this.textarea.style.lineHeight=ae+"px",this.textarea.style.zIndex="-5"}}},K.prototype._initGlobal=function(){var F=this;this._bindKeys(),this.register((0,d.addDisposableDomListener)(this.element,"copy",function(W){F.hasSelection()&&(0,v.copyHandler)(W,F._selectionService)}));var U=function(W){return(0,v.handlePasteEvent)(W,F.textarea,F.coreService)};this.register((0,d.addDisposableDomListener)(this.textarea,"paste",U)),this.register((0,d.addDisposableDomListener)(this.element,"paste",U)),_.isFirefox?this.register((0,d.addDisposableDomListener)(this.element,"mousedown",function(W){W.button===2&&(0,v.rightClickHandler)(W,F.textarea,F.screenElement,F._selectionService,F.options.rightClickSelectsWord)})):this.register((0,d.addDisposableDomListener)(this.element,"contextmenu",function(W){(0,v.rightClickHandler)(W,F.textarea,F.screenElement,F._selectionService,F.options.rightClickSelectsWord)})),_.isLinux&&this.register((0,d.addDisposableDomListener)(this.element,"auxclick",function(W){W.button===1&&(0,v.moveTextAreaUnderMouseCursor)(W,F.textarea,F.screenElement)}))},K.prototype._bindKeys=function(){var F=this;this.register((0,d.addDisposableDomListener)(this.textarea,"keyup",function(U){return F._keyUp(U)},!0)),this.register((0,d.addDisposableDomListener)(this.textarea,"keydown",function(U){return F._keyDown(U)},!0)),this.register((0,d.addDisposableDomListener)(this.textarea,"keypress",function(U){return F._keyPress(U)},!0)),this.register((0,d.addDisposableDomListener)(this.textarea,"compositionstart",function(){return F._compositionHelper.compositionstart()})),this.register((0,d.addDisposableDomListener)(this.textarea,"compositionupdate",function(U){return F._compositionHelper.compositionupdate(U)})),this.register((0,d.addDisposableDomListener)(this.textarea,"compositionend",function(){return F._compositionHelper.compositionend()})),this.register((0,d.addDisposableDomListener)(this.textarea,"input",function(U){return F._inputEvent(U)},!0)),this.register(this.onRender(function(){return F._compositionHelper.updateCompositionElements()})),this.register(this.onRender(function(U){return F._queueLinkification(U.start,U.end)}))},K.prototype.open=function(F){var U=this;if(!F)throw new Error("Terminal requires a parent element.");F.isConnected||this._logService.debug("Terminal.open was called on an element that was not attached to the DOM"),this._document=F.ownerDocument,this.element=this._document.createElement("div"),this.element.dir="ltr",this.element.classList.add("terminal"),this.element.classList.add("xterm"),this.element.setAttribute("tabindex","0"),F.appendChild(this.element);var W=N.createDocumentFragment();this._viewportElement=N.createElement("div"),this._viewportElement.classList.add("xterm-viewport"),W.appendChild(this._viewportElement),this._viewportScrollArea=N.createElement("div"),this._viewportScrollArea.classList.add("xterm-scroll-area"),this._viewportElement.appendChild(this._viewportScrollArea),this.screenElement=N.createElement("div"),this.screenElement.classList.add("xterm-screen"),this._helperContainer=N.createElement("div"),this._helperContainer.classList.add("xterm-helpers"),this.screenElement.appendChild(this._helperContainer),W.appendChild(this.screenElement),this.textarea=N.createElement("textarea"),this.textarea.classList.add("xterm-helper-textarea"),this.textarea.setAttribute("aria-label",b.promptLabel),this.textarea.setAttribute("aria-multiline","false"),this.textarea.setAttribute("autocorrect","off"),this.textarea.setAttribute("autocapitalize","off"),this.textarea.setAttribute("spellcheck","false"),this.textarea.tabIndex=0,this.register((0,d.addDisposableDomListener)(this.textarea,"focus",function(me){return U._onTextAreaFocus(me)})),this.register((0,d.addDisposableDomListener)(this.textarea,"blur",function(){return U._onTextAreaBlur()})),this._helperContainer.appendChild(this.textarea);var ae=this._instantiationService.createInstance(X.CoreBrowserService,this.textarea);this._instantiationService.setService(M.ICoreBrowserService,ae),this._charSizeService=this._instantiationService.createInstance(D.CharSizeService,this._document,this._helperContainer),this._instantiationService.setService(M.ICharSizeService,this._charSizeService),this._theme=this.options.theme||this._theme,this._colorManager=new T.ColorManager(N,this.options.allowTransparency),this.register(this.optionsService.onOptionChange(function(me){return U._colorManager.onOptionsChange(me)})),this._colorManager.setTheme(this._theme),this._characterJoinerService=this._instantiationService.createInstance(ie.CharacterJoinerService),this._instantiationService.setService(M.ICharacterJoinerService,this._characterJoinerService);var he=this._createRenderer();this._renderService=this.register(this._instantiationService.createInstance(P.RenderService,he,this.rows,this.screenElement)),this._instantiationService.setService(M.IRenderService,this._renderService),this.register(this._renderService.onRenderedViewportChange(function(me){return U._onRender.fire(me)})),this.onResize(function(me){return U._renderService.resize(me.cols,me.rows)}),this._compositionView=N.createElement("div"),this._compositionView.classList.add("composition-view"),this._compositionHelper=this._instantiationService.createInstance(S.CompositionHelper,this.textarea,this._compositionView),this._helperContainer.appendChild(this._compositionView),this.element.appendChild(W),this._soundService=this._instantiationService.createInstance(g.SoundService),this._instantiationService.setService(M.ISoundService,this._soundService),this._mouseService=this._instantiationService.createInstance(q.MouseService),this._instantiationService.setService(M.IMouseService,this._mouseService),this.viewport=this._instantiationService.createInstance(p.Viewport,function(me){return U.scrollLines(me,!0,1)},this._viewportElement,this._viewportScrollArea,this.element),this.viewport.onThemeChange(this._colorManager.colors),this.register(this._inputHandler.onRequestSyncScrollBar(function(){return U.viewport.syncScrollArea()})),this.register(this.viewport),this.register(this.onCursorMove(function(){U._renderService.onCursorMove(),U._syncTextArea()})),this.register(this.onResize(function(){return U._renderService.onResize(U.cols,U.rows)})),this.register(this.onBlur(function(){return U._renderService.onBlur()})),this.register(this.onFocus(function(){return U._renderService.onFocus()})),this.register(this._renderService.onDimensionsChange(function(){return U.viewport.syncScrollArea()})),this._selectionService=this.register(this._instantiationService.createInstance(h.SelectionService,this.element,this.screenElement,this.linkifier2)),this._instantiationService.setService(M.ISelectionService,this._selectionService),this.register(this._selectionService.onRequestScrollLines(function(me){return U.scrollLines(me.amount,me.suppressScrollEvent)})),this.register(this._selectionService.onSelectionChange(function(){return U._onSelectionChange.fire()})),this.register(this._selectionService.onRequestRedraw(function(me){return U._renderService.onSelectionChanged(me.start,me.end,me.columnSelectMode)})),this.register(this._selectionService.onLinuxMouseSelection(function(me){U.textarea.value=me,U.textarea.focus(),U.textarea.select()})),this.register(this._onScroll.event(function(me){U.viewport.syncScrollArea(),U._selectionService.refresh()})),this.register((0,d.addDisposableDomListener)(this._viewportElement,"scroll",function(){return U._selectionService.refresh()})),this._mouseZoneManager=this._instantiationService.createInstance(A.MouseZoneManager,this.element,this.screenElement),this.register(this._mouseZoneManager),this.register(this.onScroll(function(){return U._mouseZoneManager.clearAll()})),this.linkifier.attachToDom(this.element,this._mouseZoneManager),this.linkifier2.attachToDom(this.screenElement,this._mouseService,this._renderService),this.register(this._instantiationService.createInstance(B.BufferDecorationRenderer,this.screenElement)),this.register((0,d.addDisposableDomListener)(this.element,"mousedown",function(me){return U._selectionService.onMouseDown(me)})),this.coreMouseService.areMouseEventsActive?(this._selectionService.disable(),this.element.classList.add("enable-mouse-events")):this._selectionService.enable(),this.options.screenReaderMode&&(this._accessibilityManager=new R.AccessibilityManager(this,this._renderService)),this.options.overviewRulerWidth&&(this._overviewRulerRenderer=this._instantiationService.createInstance(pe.OverviewRulerRenderer,this._viewportElement,this.screenElement)),this.optionsService.onOptionChange(function(){!U._overviewRulerRenderer&&U.options.overviewRulerWidth&&U._viewportElement&&U.screenElement&&(U._overviewRulerRenderer=U._instantiationService.createInstance(pe.OverviewRulerRenderer,U._viewportElement,U.screenElement))}),this._charSizeService.measure(),this.refresh(0,this.rows-1),this._initGlobal(),this.bindMouse()},K.prototype._createRenderer=function(){switch(this.options.rendererType){case"canvas":return this._instantiationService.createInstance(c.Renderer,this._colorManager.colors,this.screenElement,this.linkifier,this.linkifier2);case"dom":return this._instantiationService.createInstance(x.DomRenderer,this._colorManager.colors,this.element,this.screenElement,this._viewportElement,this.linkifier,this.linkifier2);default:throw new Error('Unrecognized rendererType "'+this.options.rendererType+'"')}},K.prototype._setTheme=function(F){var U,W,ae;this._theme=F,(U=this._colorManager)===null||U===void 0||U.setTheme(F),(W=this._renderService)===null||W===void 0||W.setColors(this._colorManager.colors),(ae=this.viewport)===null||ae===void 0||ae.onThemeChange(this._colorManager.colors)},K.prototype.bindMouse=function(){var F=this,U=this,W=this.element;function ae(re){var ze,et,bt=U._mouseService.getRawByteCoords(re,U.screenElement,U.cols,U.rows);if(!bt)return!1;switch(re.overrideType||re.type){case"mousemove":et=32,re.buttons===void 0?(ze=3,re.button!==void 0&&(ze=re.button<3?re.button:3)):ze=1&re.buttons?0:4&re.buttons?1:2&re.buttons?2:3;break;case"mouseup":et=0,ze=re.button<3?re.button:3;break;case"mousedown":et=1,ze=re.button<3?re.button:3;break;case"wheel":if(U.viewport.getLinesScrolled(re)===0)return!1;et=re.deltaY<0?0:1,ze=4;break;default:return!1}return!(et===void 0||ze===void 0||ze>4)&&U.coreMouseService.triggerMouseEvent({col:bt.x-33,row:bt.y-33,button:ze,action:et,ctrl:re.ctrlKey,alt:re.altKey,shift:re.shiftKey})}var he={mouseup:null,wheel:null,mousedrag:null,mousemove:null},me=function(re){return ae(re),re.buttons||(F._document.removeEventListener("mouseup",he.mouseup),he.mousedrag&&F._document.removeEventListener("mousemove",he.mousedrag)),F.cancel(re)},De=function(re){return ae(re),F.cancel(re,!0)},He=function(re){re.buttons&&ae(re)},Ne=function(re){re.buttons||ae(re)};this.register(this.coreMouseService.onProtocolChange(function(re){re?(F.optionsService.rawOptions.logLevel==="debug"&&F._logService.debug("Binding to mouse events:",F.coreMouseService.explainEvents(re)),F.element.classList.add("enable-mouse-events"),F._selectionService.disable()):(F._logService.debug("Unbinding from mouse events."),F.element.classList.remove("enable-mouse-events"),F._selectionService.enable()),8&re?he.mousemove||(W.addEventListener("mousemove",Ne),he.mousemove=Ne):(W.removeEventListener("mousemove",he.mousemove),he.mousemove=null),16&re?he.wheel||(W.addEventListener("wheel",De,{passive:!1}),he.wheel=De):(W.removeEventListener("wheel",he.wheel),he.wheel=null),2&re?he.mouseup||(he.mouseup=me):(F._document.removeEventListener("mouseup",he.mouseup),he.mouseup=null),4&re?he.mousedrag||(he.mousedrag=He):(F._document.removeEventListener("mousemove",he.mousedrag),he.mousedrag=null)})),this.coreMouseService.activeProtocol=this.coreMouseService.activeProtocol,this.register((0,d.addDisposableDomListener)(W,"mousedown",function(re){if(re.preventDefault(),F.focus(),F.coreMouseService.areMouseEventsActive&&!F._selectionService.shouldForceSelection(re))return ae(re),he.mouseup&&F._document.addEventListener("mouseup",he.mouseup),he.mousedrag&&F._document.addEventListener("mousemove",he.mousedrag),F.cancel(re)})),this.register((0,d.addDisposableDomListener)(W,"wheel",function(re){if(!he.wheel){if(!F.buffer.hasScrollback){var ze=F.viewport.getLinesScrolled(re);if(ze===0)return;for(var et=w.C0.ESC+(F.coreService.decPrivateModes.applicationCursorKeys?"O":"[")+(re.deltaY<0?"A":"B"),bt="",ni=0;ni<Math.abs(ze);ni++)bt+=et;return F.coreService.triggerDataEvent(bt,!0),F.cancel(re,!0)}return F.viewport.onWheel(re)?F.cancel(re):void 0}},{passive:!1})),this.register((0,d.addDisposableDomListener)(W,"touchstart",function(re){if(!F.coreMouseService.areMouseEventsActive)return F.viewport.onTouchStart(re),F.cancel(re)},{passive:!0})),this.register((0,d.addDisposableDomListener)(W,"touchmove",function(re){if(!F.coreMouseService.areMouseEventsActive)return F.viewport.onTouchMove(re)?void 0:F.cancel(re)},{passive:!1}))},K.prototype.refresh=function(F,U){var W;(W=this._renderService)===null||W===void 0||W.refreshRows(F,U)},K.prototype._queueLinkification=function(F,U){var W;(W=this.linkifier)===null||W===void 0||W.linkifyRows(F,U)},K.prototype.updateCursorStyle=function(F){var U;!((U=this._selectionService)===null||U===void 0)&&U.shouldColumnSelect(F)?this.element.classList.add("column-select"):this.element.classList.remove("column-select")},K.prototype._showCursor=function(){this.coreService.isCursorInitialized||(this.coreService.isCursorInitialized=!0,this.refresh(this.buffer.y,this.buffer.y))},K.prototype.scrollLines=function(F,U,W){W===void 0&&(W=0),le.prototype.scrollLines.call(this,F,U,W),this.refresh(0,this.rows-1)},K.prototype.paste=function(F){(0,v.paste)(F,this.textarea,this.coreService)},K.prototype.attachCustomKeyEventHandler=function(F){this._customKeyEventHandler=F},K.prototype.registerLinkMatcher=function(F,U,W){var ae=this.linkifier.registerLinkMatcher(F,U,W);return this.refresh(0,this.rows-1),ae},K.prototype.deregisterLinkMatcher=function(F){this.linkifier.deregisterLinkMatcher(F)&&this.refresh(0,this.rows-1)},K.prototype.registerLinkProvider=function(F){return this.linkifier2.registerLinkProvider(F)},K.prototype.registerCharacterJoiner=function(F){if(!this._characterJoinerService)throw new Error("Terminal must be opened first");var U=this._characterJoinerService.register(F);return this.refresh(0,this.rows-1),U},K.prototype.deregisterCharacterJoiner=function(F){if(!this._characterJoinerService)throw new Error("Terminal must be opened first");this._characterJoinerService.deregister(F)&&this.refresh(0,this.rows-1)},Object.defineProperty(K.prototype,"markers",{get:function(){return this.buffer.markers},enumerable:!1,configurable:!0}),K.prototype.addMarker=function(F){if(this.buffer===this.buffers.normal)return this.buffer.addMarker(this.buffer.ybase+this.buffer.y+F)},K.prototype.registerDecoration=function(F){return this._decorationService.registerDecoration(F)},K.prototype.hasSelection=function(){return!!this._selectionService&&this._selectionService.hasSelection},K.prototype.select=function(F,U,W){this._selectionService.setSelection(F,U,W)},K.prototype.getSelection=function(){return this._selectionService?this._selectionService.selectionText:""},K.prototype.getSelectionPosition=function(){if(this._selectionService&&this._selectionService.hasSelection)return{startColumn:this._selectionService.selectionStart[0],startRow:this._selectionService.selectionStart[1],endColumn:this._selectionService.selectionEnd[0],endRow:this._selectionService.selectionEnd[1]}},K.prototype.clearSelection=function(){var F;(F=this._selectionService)===null||F===void 0||F.clearSelection()},K.prototype.selectAll=function(){var F;(F=this._selectionService)===null||F===void 0||F.selectAll()},K.prototype.selectLines=function(F,U){var W;(W=this._selectionService)===null||W===void 0||W.selectLines(F,U)},K.prototype._keyDown=function(F){if(this._keyDownHandled=!1,this._keyDownSeen=!0,this._customKeyEventHandler&&this._customKeyEventHandler(F)===!1)return!1;var U=this.browser.isMac&&this.options.macOptionIsMeta&&F.altKey;if(!U&&!this._compositionHelper.keydown(F))return this.buffer.ybase!==this.buffer.ydisp&&this._bufferService.scrollToBottom(),!1;U||F.key!=="Dead"&&F.key!=="AltGraph"||(this._unprocessedDeadKey=!0);var W=(0,k.evaluateKeyboardEvent)(F,this.coreService.decPrivateModes.applicationCursorKeys,this.browser.isMac,this.options.macOptionIsMeta);if(this.updateCursorStyle(F),W.type===3||W.type===2){var ae=this.rows-1;return this.scrollLines(W.type===2?-ae:ae),this.cancel(F,!0)}return W.type===1&&this.selectAll(),!!this._isThirdLevelShift(this.browser,F)||(W.cancel&&this.cancel(F,!0),!W.key||!!(F.key&&!F.ctrlKey&&!F.altKey&&!F.metaKey&&F.key.length===1&&F.key.charCodeAt(0)>=65&&F.key.charCodeAt(0)<=90)||(this._unprocessedDeadKey?(this._unprocessedDeadKey=!1,!0):(W.key!==w.C0.ETX&&W.key!==w.C0.CR||(this.textarea.value=""),this._onKey.fire({key:W.key,domEvent:F}),this._showCursor(),this.coreService.triggerDataEvent(W.key,!0),this.optionsService.rawOptions.screenReaderMode?void(this._keyDownHandled=!0):this.cancel(F,!0))))},K.prototype._isThirdLevelShift=function(F,U){var W=F.isMac&&!this.options.macOptionIsMeta&&U.altKey&&!U.ctrlKey&&!U.metaKey||F.isWindows&&U.altKey&&U.ctrlKey&&!U.metaKey||F.isWindows&&U.getModifierState("AltGraph");return U.type==="keypress"?W:W&&(!U.keyCode||U.keyCode>47)},K.prototype._keyUp=function(F){this._keyDownSeen=!1,this._customKeyEventHandler&&this._customKeyEventHandler(F)===!1||(function(U){return U.keyCode===16||U.keyCode===17||U.keyCode===18}(F)||this.focus(),this.updateCursorStyle(F),this._keyPressHandled=!1)},K.prototype._keyPress=function(F){var U;if(this._keyPressHandled=!1,this._keyDownHandled||this._customKeyEventHandler&&this._customKeyEventHandler(F)===!1)return!1;if(this.cancel(F),F.charCode)U=F.charCode;else if(F.which===null||F.which===void 0)U=F.keyCode;else{if(F.which===0||F.charCode===0)return!1;U=F.which}return!(!U||(F.altKey||F.ctrlKey||F.metaKey)&&!this._isThirdLevelShift(this.browser,F)||(U=String.fromCharCode(U),this._onKey.fire({key:U,domEvent:F}),this._showCursor(),this.coreService.triggerDataEvent(U,!0),this._keyPressHandled=!0,this._unprocessedDeadKey=!1,0))},K.prototype._inputEvent=function(F){if(F.data&&F.inputType==="insertText"&&(!F.composed||!this._keyDownSeen)&&!this.optionsService.rawOptions.screenReaderMode){if(this._keyPressHandled)return!1;this._unprocessedDeadKey=!1;var U=F.data;return this.coreService.triggerDataEvent(U,!0),this.cancel(F),!0}return!1},K.prototype.bell=function(){var F;this._soundBell()&&((F=this._soundService)===null||F===void 0||F.playBellSound()),this._onBell.fire()},K.prototype.resize=function(F,U){F!==this.cols||U!==this.rows?le.prototype.resize.call(this,F,U):this._charSizeService&&!this._charSizeService.hasValidSize&&this._charSizeService.measure()},K.prototype._afterResize=function(F,U){var W,ae;(W=this._charSizeService)===null||W===void 0||W.measure(),(ae=this.viewport)===null||ae===void 0||ae.syncScrollArea(!0)},K.prototype.clear=function(){if(this.buffer.ybase!==0||this.buffer.y!==0){this.buffer.clearAllMarkers(),this.buffer.lines.set(0,this.buffer.lines.get(this.buffer.ybase+this.buffer.y)),this.buffer.lines.length=1,this.buffer.ydisp=0,this.buffer.ybase=0,this.buffer.y=0;for(var F=1;F<this.rows;F++)this.buffer.lines.push(this.buffer.getBlankLine(I.DEFAULT_ATTR_DATA));this.refresh(0,this.rows-1),this._onScroll.fire({position:this.buffer.ydisp,source:0})}},K.prototype.reset=function(){var F,U;this.options.rows=this.rows,this.options.cols=this.cols;var W=this._customKeyEventHandler;this._setup(),le.prototype.reset.call(this),(F=this._selectionService)===null||F===void 0||F.reset(),this._decorationService.reset(),this._customKeyEventHandler=W,this.refresh(0,this.rows-1),(U=this.viewport)===null||U===void 0||U.syncScrollArea()},K.prototype.clearTextureAtlas=function(){var F;(F=this._renderService)===null||F===void 0||F.clearTextureAtlas()},K.prototype._reportFocus=function(){var F;!((F=this.element)===null||F===void 0)&&F.classList.contains("focus")?this.coreService.triggerDataEvent(w.C0.ESC+"[I"):this.coreService.triggerDataEvent(w.C0.ESC+"[O")},K.prototype._reportWindowsOptions=function(F){if(this._renderService)switch(F){case y.WindowsOptionsReportType.GET_WIN_SIZE_PIXELS:var U=this._renderService.dimensions.scaledCanvasWidth.toFixed(0),W=this._renderService.dimensions.scaledCanvasHeight.toFixed(0);this.coreService.triggerDataEvent(w.C0.ESC+"[4;"+W+";"+U+"t");break;case y.WindowsOptionsReportType.GET_CELL_SIZE_PIXELS:var ae=this._renderService.dimensions.scaledCellWidth.toFixed(0),he=this._renderService.dimensions.scaledCellHeight.toFixed(0);this.coreService.triggerDataEvent(w.C0.ESC+"[6;"+he+";"+ae+"t")}},K.prototype.cancel=function(F,U){if(this.options.cancelEvents||U)return F.preventDefault(),F.stopPropagation(),!1},K.prototype._visualBell=function(){return!1},K.prototype._soundBell=function(){return this.options.bellStyle==="sound"},K}($.CoreTerminal);r.Terminal=xe},9924:(a,r)=>{Object.defineProperty(r,"__esModule",{value:!0}),r.TimeBasedDebouncer=void 0;var u=function(){function o(l,f){f===void 0&&(f=1e3),this._renderCallback=l,this._debounceThresholdMS=f,this._lastRefreshMs=0,this._additionalRefreshRequested=!1}return o.prototype.dispose=function(){this._refreshTimeoutID&&clearTimeout(this._refreshTimeoutID)},o.prototype.refresh=function(l,f,m){var C=this;this._rowCount=m,l=l!==void 0?l:0,f=f!==void 0?f:this._rowCount-1,this._rowStart=this._rowStart!==void 0?Math.min(this._rowStart,l):l,this._rowEnd=this._rowEnd!==void 0?Math.max(this._rowEnd,f):f;var S=Date.now();if(S-this._lastRefreshMs>=this._debounceThresholdMS)this._lastRefreshMs=S,this._innerRefresh();else if(!this._additionalRefreshRequested){var p=S-this._lastRefreshMs,v=this._debounceThresholdMS-p;this._additionalRefreshRequested=!0,this._refreshTimeoutID=window.setTimeout(function(){C._lastRefreshMs=Date.now(),C._innerRefresh(),C._additionalRefreshRequested=!1,C._refreshTimeoutID=void 0},v)}},o.prototype._innerRefresh=function(){if(this._rowStart!==void 0&&this._rowEnd!==void 0&&this._rowCount!==void 0){var l=Math.max(this._rowStart,0),f=Math.min(this._rowEnd,this._rowCount-1);this._rowStart=void 0,this._rowEnd=void 0,this._renderCallback(l,f)}},o}();r.TimeBasedDebouncer=u},1680:function(a,r,u){var o,l=this&&this.__extends||(o=function(y,c){return o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(n,h){n.__proto__=h}||function(n,h){for(var _ in h)Object.prototype.hasOwnProperty.call(h,_)&&(n[_]=h[_])},o(y,c)},function(y,c){if(typeof c!="function"&&c!==null)throw new TypeError("Class extends value "+String(c)+" is not a constructor or null");function n(){this.constructor=y}o(y,c),y.prototype=c===null?Object.create(c):(n.prototype=c.prototype,new n)}),f=this&&this.__decorate||function(y,c,n,h){var _,d=arguments.length,b=d<3?c:h===null?h=Object.getOwnPropertyDescriptor(c,n):h;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")b=Reflect.decorate(y,c,n,h);else for(var g=y.length-1;g>=0;g--)(_=y[g])&&(b=(d<3?_(b):d>3?_(c,n,b):_(c,n))||b);return d>3&&b&&Object.defineProperty(c,n,b),b},m=this&&this.__param||function(y,c){return function(n,h){c(n,h,y)}};Object.defineProperty(r,"__esModule",{value:!0}),r.Viewport=void 0;var C=u(844),S=u(3656),p=u(4725),v=u(2585),w=function(y){function c(n,h,_,d,b,g,A,R){var x=y.call(this)||this;return x._scrollLines=n,x._viewportElement=h,x._scrollArea=_,x._element=d,x._bufferService=b,x._optionsService=g,x._charSizeService=A,x._renderService=R,x.scrollBarWidth=0,x._currentRowHeight=0,x._currentScaledCellHeight=0,x._lastRecordedBufferLength=0,x._lastRecordedViewportHeight=0,x._lastRecordedBufferHeight=0,x._lastTouchY=0,x._lastScrollTop=0,x._wheelPartialScroll=0,x._refreshAnimationFrame=null,x._ignoreNextScrollEvent=!1,x.scrollBarWidth=x._viewportElement.offsetWidth-x._scrollArea.offsetWidth||15,x.register((0,S.addDisposableDomListener)(x._viewportElement,"scroll",x._onScroll.bind(x))),x._activeBuffer=x._bufferService.buffer,x.register(x._bufferService.buffers.onBufferActivate(function(k){return x._activeBuffer=k.activeBuffer})),x._renderDimensions=x._renderService.dimensions,x.register(x._renderService.onDimensionsChange(function(k){return x._renderDimensions=k})),setTimeout(function(){return x.syncScrollArea()},0),x}return l(c,y),c.prototype.onThemeChange=function(n){this._viewportElement.style.backgroundColor=n.background.css},c.prototype._refresh=function(n){var h=this;if(n)return this._innerRefresh(),void(this._refreshAnimationFrame!==null&&cancelAnimationFrame(this._refreshAnimationFrame));this._refreshAnimationFrame===null&&(this._refreshAnimationFrame=requestAnimationFrame(function(){return h._innerRefresh()}))},c.prototype._innerRefresh=function(){if(this._charSizeService.height>0){this._currentRowHeight=this._renderService.dimensions.scaledCellHeight/window.devicePixelRatio,this._currentScaledCellHeight=this._renderService.dimensions.scaledCellHeight,this._lastRecordedViewportHeight=this._viewportElement.offsetHeight;var n=Math.round(this._currentRowHeight*this._lastRecordedBufferLength)+(this._lastRecordedViewportHeight-this._renderService.dimensions.canvasHeight);this._lastRecordedBufferHeight!==n&&(this._lastRecordedBufferHeight=n,this._scrollArea.style.height=this._lastRecordedBufferHeight+"px")}var h=this._bufferService.buffer.ydisp*this._currentRowHeight;this._viewportElement.scrollTop!==h&&(this._ignoreNextScrollEvent=!0,this._viewportElement.scrollTop=h),this._refreshAnimationFrame=null},c.prototype.syncScrollArea=function(n){if(n===void 0&&(n=!1),this._lastRecordedBufferLength!==this._bufferService.buffer.lines.length)return this._lastRecordedBufferLength=this._bufferService.buffer.lines.length,void this._refresh(n);this._lastRecordedViewportHeight===this._renderService.dimensions.canvasHeight&&this._lastScrollTop===this._activeBuffer.ydisp*this._currentRowHeight&&this._renderDimensions.scaledCellHeight===this._currentScaledCellHeight||this._refresh(n)},c.prototype._onScroll=function(n){if(this._lastScrollTop=this._viewportElement.scrollTop,this._viewportElement.offsetParent){if(this._ignoreNextScrollEvent)return this._ignoreNextScrollEvent=!1,void this._scrollLines(0);var h=Math.round(this._lastScrollTop/this._currentRowHeight)-this._bufferService.buffer.ydisp;this._scrollLines(h)}},c.prototype._bubbleScroll=function(n,h){var _=this._viewportElement.scrollTop+this._lastRecordedViewportHeight;return!(h<0&&this._viewportElement.scrollTop!==0||h>0&&_<this._lastRecordedBufferHeight)||(n.cancelable&&n.preventDefault(),!1)},c.prototype.onWheel=function(n){var h=this._getPixelsScrolled(n);return h!==0&&(this._viewportElement.scrollTop+=h,this._bubbleScroll(n,h))},c.prototype._getPixelsScrolled=function(n){if(n.deltaY===0||n.shiftKey)return 0;var h=this._applyScrollModifier(n.deltaY,n);return n.deltaMode===WheelEvent.DOM_DELTA_LINE?h*=this._currentRowHeight:n.deltaMode===WheelEvent.DOM_DELTA_PAGE&&(h*=this._currentRowHeight*this._bufferService.rows),h},c.prototype.getLinesScrolled=function(n){if(n.deltaY===0||n.shiftKey)return 0;var h=this._applyScrollModifier(n.deltaY,n);return n.deltaMode===WheelEvent.DOM_DELTA_PIXEL?(h/=this._currentRowHeight+0,this._wheelPartialScroll+=h,h=Math.floor(Math.abs(this._wheelPartialScroll))*(this._wheelPartialScroll>0?1:-1),this._wheelPartialScroll%=1):n.deltaMode===WheelEvent.DOM_DELTA_PAGE&&(h*=this._bufferService.rows),h},c.prototype._applyScrollModifier=function(n,h){var _=this._optionsService.rawOptions.fastScrollModifier;return _==="alt"&&h.altKey||_==="ctrl"&&h.ctrlKey||_==="shift"&&h.shiftKey?n*this._optionsService.rawOptions.fastScrollSensitivity*this._optionsService.rawOptions.scrollSensitivity:n*this._optionsService.rawOptions.scrollSensitivity},c.prototype.onTouchStart=function(n){this._lastTouchY=n.touches[0].pageY},c.prototype.onTouchMove=function(n){var h=this._lastTouchY-n.touches[0].pageY;return this._lastTouchY=n.touches[0].pageY,h!==0&&(this._viewportElement.scrollTop+=h,this._bubbleScroll(n,h))},f([m(4,v.IBufferService),m(5,v.IOptionsService),m(6,p.ICharSizeService),m(7,p.IRenderService)],c)}(C.Disposable);r.Viewport=w},3107:function(a,r,u){var o,l=this&&this.__extends||(o=function(c,n){return o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(h,_){h.__proto__=_}||function(h,_){for(var d in _)Object.prototype.hasOwnProperty.call(_,d)&&(h[d]=_[d])},o(c,n)},function(c,n){if(typeof n!="function"&&n!==null)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function h(){this.constructor=c}o(c,n),c.prototype=n===null?Object.create(n):(h.prototype=n.prototype,new h)}),f=this&&this.__decorate||function(c,n,h,_){var d,b=arguments.length,g=b<3?n:_===null?_=Object.getOwnPropertyDescriptor(n,h):_;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")g=Reflect.decorate(c,n,h,_);else for(var A=c.length-1;A>=0;A--)(d=c[A])&&(g=(b<3?d(g):b>3?d(n,h,g):d(n,h))||g);return b>3&&g&&Object.defineProperty(n,h,g),g},m=this&&this.__param||function(c,n){return function(h,_){n(h,_,c)}},C=this&&this.__values||function(c){var n=typeof Symbol=="function"&&Symbol.iterator,h=n&&c[n],_=0;if(h)return h.call(c);if(c&&typeof c.length=="number")return{next:function(){return c&&_>=c.length&&(c=void 0),{value:c&&c[_++],done:!c}}};throw new TypeError(n?"Object is not iterable.":"Symbol.iterator is not defined.")};Object.defineProperty(r,"__esModule",{value:!0}),r.BufferDecorationRenderer=void 0;var S=u(3656),p=u(4725),v=u(844),w=u(2585),y=function(c){function n(h,_,d,b){var g=c.call(this)||this;return g._screenElement=h,g._bufferService=_,g._decorationService=d,g._renderService=b,g._decorationElements=new Map,g._altBufferIsActive=!1,g._dimensionsChanged=!1,g._container=document.createElement("div"),g._container.classList.add("xterm-decoration-container"),g._screenElement.appendChild(g._container),g.register(g._renderService.onRenderedViewportChange(function(){return g._queueRefresh()})),g.register(g._renderService.onDimensionsChange(function(){g._dimensionsChanged=!0,g._queueRefresh()})),g.register((0,S.addDisposableDomListener)(window,"resize",function(){return g._queueRefresh()})),g.register(g._bufferService.buffers.onBufferActivate(function(){g._altBufferIsActive=g._bufferService.buffer===g._bufferService.buffers.alt})),g.register(g._decorationService.onDecorationRegistered(function(){return g._queueRefresh()})),g.register(g._decorationService.onDecorationRemoved(function(A){return g._removeDecoration(A)})),g}return l(n,c),n.prototype.dispose=function(){this._container.remove(),this._decorationElements.clear(),c.prototype.dispose.call(this)},n.prototype._queueRefresh=function(){var h=this;this._animationFrame===void 0&&(this._animationFrame=this._renderService.addRefreshCallback(function(){h.refreshDecorations(),h._animationFrame=void 0}))},n.prototype.refreshDecorations=function(){var h,_;try{for(var d=C(this._decorationService.decorations),b=d.next();!b.done;b=d.next()){var g=b.value;this._renderDecoration(g)}}catch(A){h={error:A}}finally{try{b&&!b.done&&(_=d.return)&&_.call(d)}finally{if(h)throw h.error}}this._dimensionsChanged=!1},n.prototype._renderDecoration=function(h){this._refreshStyle(h),this._dimensionsChanged&&this._refreshXPosition(h)},n.prototype._createElement=function(h){var _,d=document.createElement("div");d.classList.add("xterm-decoration"),d.style.width=Math.round((h.options.width||1)*this._renderService.dimensions.actualCellWidth)+"px",d.style.height=(h.options.height||1)*this._renderService.dimensions.actualCellHeight+"px",d.style.top=(h.marker.line-this._bufferService.buffers.active.ydisp)*this._renderService.dimensions.actualCellHeight+"px",d.style.lineHeight=this._renderService.dimensions.actualCellHeight+"px";var b=(_=h.options.x)!==null&&_!==void 0?_:0;return b&&b>this._bufferService.cols&&(d.style.display="none"),this._refreshXPosition(h,d),d},n.prototype._refreshStyle=function(h){var _=this,d=h.marker.line-this._bufferService.buffers.active.ydisp;if(d<0||d>=this._bufferService.rows)h.element&&(h.element.style.display="none",h.onRenderEmitter.fire(h.element));else{var b=this._decorationElements.get(h);b||(h.onDispose(function(){return _._removeDecoration(h)}),b=this._createElement(h),h.element=b,this._decorationElements.set(h,b),this._container.appendChild(b)),b.style.top=d*this._renderService.dimensions.actualCellHeight+"px",b.style.display=this._altBufferIsActive?"none":"block",h.onRenderEmitter.fire(b)}},n.prototype._refreshXPosition=function(h,_){var d;if(_===void 0&&(_=h.element),_){var b=(d=h.options.x)!==null&&d!==void 0?d:0;(h.options.anchor||"left")==="right"?_.style.right=b?b*this._renderService.dimensions.actualCellWidth+"px":"":_.style.left=b?b*this._renderService.dimensions.actualCellWidth+"px":""}},n.prototype._removeDecoration=function(h){var _;(_=this._decorationElements.get(h))===null||_===void 0||_.remove(),this._decorationElements.delete(h)},f([m(1,w.IBufferService),m(2,w.IDecorationService),m(3,p.IRenderService)],n)}(v.Disposable);r.BufferDecorationRenderer=y},5871:function(a,r){var u=this&&this.__values||function(l){var f=typeof Symbol=="function"&&Symbol.iterator,m=f&&l[f],C=0;if(m)return m.call(l);if(l&&typeof l.length=="number")return{next:function(){return l&&C>=l.length&&(l=void 0),{value:l&&l[C++],done:!l}}};throw new TypeError(f?"Object is not iterable.":"Symbol.iterator is not defined.")};Object.defineProperty(r,"__esModule",{value:!0}),r.ColorZoneStore=void 0;var o=function(){function l(){this._zones=[],this._zonePool=[],this._zonePoolIndex=0,this._linePadding={full:0,left:0,center:0,right:0}}return Object.defineProperty(l.prototype,"zones",{get:function(){return this._zonePool.length=Math.min(this._zonePool.length,this._zones.length),this._zones},enumerable:!1,configurable:!0}),l.prototype.clear=function(){this._zones.length=0,this._zonePoolIndex=0},l.prototype.addDecoration=function(f){var m,C;if(f.options.overviewRulerOptions){try{for(var S=u(this._zones),p=S.next();!p.done;p=S.next()){var v=p.value;if(v.color===f.options.overviewRulerOptions.color&&v.position===f.options.overviewRulerOptions.position){if(this._lineIntersectsZone(v,f.marker.line))return;if(this._lineAdjacentToZone(v,f.marker.line,f.options.overviewRulerOptions.position))return void this._addLineToZone(v,f.marker.line)}}}catch(w){m={error:w}}finally{try{p&&!p.done&&(C=S.return)&&C.call(S)}finally{if(m)throw m.error}}if(this._zonePoolIndex<this._zonePool.length)return this._zonePool[this._zonePoolIndex].color=f.options.overviewRulerOptions.color,this._zonePool[this._zonePoolIndex].position=f.options.overviewRulerOptions.position,this._zonePool[this._zonePoolIndex].startBufferLine=f.marker.line,this._zonePool[this._zonePoolIndex].endBufferLine=f.marker.line,void this._zones.push(this._zonePool[this._zonePoolIndex++]);this._zones.push({color:f.options.overviewRulerOptions.color,position:f.options.overviewRulerOptions.position,startBufferLine:f.marker.line,endBufferLine:f.marker.line}),this._zonePool.push(this._zones[this._zones.length-1]),this._zonePoolIndex++}},l.prototype.setPadding=function(f){this._linePadding=f},l.prototype._lineIntersectsZone=function(f,m){return m>=f.startBufferLine&&m<=f.endBufferLine},l.prototype._lineAdjacentToZone=function(f,m,C){return m>=f.startBufferLine-this._linePadding[C||"full"]&&m<=f.endBufferLine+this._linePadding[C||"full"]},l.prototype._addLineToZone=function(f,m){f.startBufferLine=Math.min(f.startBufferLine,m),f.endBufferLine=Math.max(f.endBufferLine,m)},l}();r.ColorZoneStore=o},5744:function(a,r,u){var o,l=this&&this.__extends||(o=function(d,b){return o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(g,A){g.__proto__=A}||function(g,A){for(var R in A)Object.prototype.hasOwnProperty.call(A,R)&&(g[R]=A[R])},o(d,b)},function(d,b){if(typeof b!="function"&&b!==null)throw new TypeError("Class extends value "+String(b)+" is not a constructor or null");function g(){this.constructor=d}o(d,b),d.prototype=b===null?Object.create(b):(g.prototype=b.prototype,new g)}),f=this&&this.__decorate||function(d,b,g,A){var R,x=arguments.length,k=x<3?b:A===null?A=Object.getOwnPropertyDescriptor(b,g):A;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")k=Reflect.decorate(d,b,g,A);else for(var O=d.length-1;O>=0;O--)(R=d[O])&&(k=(x<3?R(k):x>3?R(b,g,k):R(b,g))||k);return x>3&&k&&Object.defineProperty(b,g,k),k},m=this&&this.__param||function(d,b){return function(g,A){b(g,A,d)}},C=this&&this.__values||function(d){var b=typeof Symbol=="function"&&Symbol.iterator,g=b&&d[b],A=0;if(g)return g.call(d);if(d&&typeof d.length=="number")return{next:function(){return d&&A>=d.length&&(d=void 0),{value:d&&d[A++],done:!d}}};throw new TypeError(b?"Object is not iterable.":"Symbol.iterator is not defined.")};Object.defineProperty(r,"__esModule",{value:!0}),r.OverviewRulerRenderer=void 0;var S=u(5871),p=u(3656),v=u(4725),w=u(844),y=u(2585),c={full:0,left:0,center:0,right:0},n={full:0,left:0,center:0,right:0},h={full:0,left:0,center:0,right:0},_=function(d){function b(g,A,R,x,k,O){var I,T=d.call(this)||this;T._viewportElement=g,T._screenElement=A,T._bufferService=R,T._decorationService=x,T._renderService=k,T._optionsService=O,T._colorZoneStore=new S.ColorZoneStore,T._shouldUpdateDimensions=!0,T._shouldUpdateAnchor=!0,T._lastKnownBufferLength=0,T._canvas=document.createElement("canvas"),T._canvas.classList.add("xterm-decoration-overview-ruler"),T._refreshCanvasDimensions(),(I=T._viewportElement.parentElement)===null||I===void 0||I.insertBefore(T._canvas,T._viewportElement);var P=T._canvas.getContext("2d");if(!P)throw new Error("Ctx cannot be null");return T._ctx=P,T._registerDecorationListeners(),T._registerBufferChangeListeners(),T._registerDimensionChangeListeners(),T}return l(b,d),Object.defineProperty(b.prototype,"_width",{get:function(){return this._optionsService.options.overviewRulerWidth||0},enumerable:!1,configurable:!0}),b.prototype._registerDecorationListeners=function(){var g=this;this.register(this._decorationService.onDecorationRegistered(function(){return g._queueRefresh(void 0,!0)})),this.register(this._decorationService.onDecorationRemoved(function(){return g._queueRefresh(void 0,!0)}))},b.prototype._registerBufferChangeListeners=function(){var g=this;this.register(this._renderService.onRenderedViewportChange(function(){return g._queueRefresh()})),this.register(this._bufferService.buffers.onBufferActivate(function(){g._canvas.style.display=g._bufferService.buffer===g._bufferService.buffers.alt?"none":"block"})),this.register(this._bufferService.onScroll(function(){g._lastKnownBufferLength!==g._bufferService.buffers.normal.lines.length&&(g._refreshDrawHeightConstants(),g._refreshColorZonePadding())}))},b.prototype._registerDimensionChangeListeners=function(){var g=this;this.register(this._renderService.onRender(function(){g._containerHeight&&g._containerHeight===g._screenElement.clientHeight||(g._queueRefresh(!0),g._containerHeight=g._screenElement.clientHeight)})),this.register(this._optionsService.onOptionChange(function(A){A==="overviewRulerWidth"&&g._queueRefresh(!0)})),this.register((0,p.addDisposableDomListener)(window,"resize",function(){g._queueRefresh(!0)})),this._queueRefresh(!0)},b.prototype.dispose=function(){var g;(g=this._canvas)===null||g===void 0||g.remove(),d.prototype.dispose.call(this)},b.prototype._refreshDrawConstants=function(){var g=Math.floor(this._canvas.width/3),A=Math.ceil(this._canvas.width/3);n.full=this._canvas.width,n.left=g,n.center=A,n.right=g,this._refreshDrawHeightConstants(),h.full=0,h.left=0,h.center=n.left,h.right=n.left+n.center},b.prototype._refreshDrawHeightConstants=function(){c.full=Math.round(2*window.devicePixelRatio);var g=this._canvas.height/this._bufferService.buffer.lines.length,A=Math.round(Math.max(Math.min(g,12),6)*window.devicePixelRatio);c.left=A,c.center=A,c.right=A},b.prototype._refreshColorZonePadding=function(){this._colorZoneStore.setPadding({full:Math.floor(this._bufferService.buffers.active.lines.length/(this._canvas.height-1)*c.full),left:Math.floor(this._bufferService.buffers.active.lines.length/(this._canvas.height-1)*c.left),center:Math.floor(this._bufferService.buffers.active.lines.length/(this._canvas.height-1)*c.center),right:Math.floor(this._bufferService.buffers.active.lines.length/(this._canvas.height-1)*c.right)}),this._lastKnownBufferLength=this._bufferService.buffers.normal.lines.length},b.prototype._refreshCanvasDimensions=function(){this._canvas.style.width=this._width+"px",this._canvas.width=Math.round(this._width*window.devicePixelRatio),this._canvas.style.height=this._screenElement.clientHeight+"px",this._canvas.height=Math.round(this._screenElement.clientHeight*window.devicePixelRatio),this._refreshDrawConstants(),this._refreshColorZonePadding()},b.prototype._refreshDecorations=function(){var g,A,R,x,k,O;this._shouldUpdateDimensions&&this._refreshCanvasDimensions(),this._ctx.clearRect(0,0,this._canvas.width,this._canvas.height),this._colorZoneStore.clear();try{for(var I=C(this._decorationService.decorations),T=I.next();!T.done;T=I.next()){var P=T.value;this._colorZoneStore.addDecoration(P)}}catch(G){g={error:G}}finally{try{T&&!T.done&&(A=I.return)&&A.call(I)}finally{if(g)throw g.error}}this._ctx.lineWidth=1;var M=this._colorZoneStore.zones;try{for(var D=C(M),q=D.next();!q.done;q=D.next())($=q.value).position!=="full"&&this._renderColorZone($)}catch(G){R={error:G}}finally{try{q&&!q.done&&(x=D.return)&&x.call(D)}finally{if(R)throw R.error}}try{for(var H=C(M),X=H.next();!X.done;X=H.next()){var $;($=X.value).position==="full"&&this._renderColorZone($)}}catch(G){k={error:G}}finally{try{X&&!X.done&&(O=H.return)&&O.call(H)}finally{if(k)throw k.error}}this._shouldUpdateDimensions=!1,this._shouldUpdateAnchor=!1},b.prototype._renderColorZone=function(g){this._ctx.fillStyle=g.color,this._ctx.fillRect(h[g.position||"full"],Math.round((this._canvas.height-1)*(g.startBufferLine/this._bufferService.buffers.active.lines.length)-c[g.position||"full"]/2),n[g.position||"full"],Math.round((this._canvas.height-1)*((g.endBufferLine-g.startBufferLine)/this._bufferService.buffers.active.lines.length)+c[g.position||"full"]))},b.prototype._queueRefresh=function(g,A){var R=this;this._shouldUpdateDimensions=g||this._shouldUpdateDimensions,this._shouldUpdateAnchor=A||this._shouldUpdateAnchor,this._animationFrame===void 0&&(this._animationFrame=window.requestAnimationFrame(function(){R._refreshDecorations(),R._animationFrame=void 0}))},f([m(2,y.IBufferService),m(3,y.IDecorationService),m(4,v.IRenderService),m(5,y.IOptionsService)],b)}(w.Disposable);r.OverviewRulerRenderer=_},2950:function(a,r,u){var o=this&&this.__decorate||function(S,p,v,w){var y,c=arguments.length,n=c<3?p:w===null?w=Object.getOwnPropertyDescriptor(p,v):w;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")n=Reflect.decorate(S,p,v,w);else for(var h=S.length-1;h>=0;h--)(y=S[h])&&(n=(c<3?y(n):c>3?y(p,v,n):y(p,v))||n);return c>3&&n&&Object.defineProperty(p,v,n),n},l=this&&this.__param||function(S,p){return function(v,w){p(v,w,S)}};Object.defineProperty(r,"__esModule",{value:!0}),r.CompositionHelper=void 0;var f=u(4725),m=u(2585),C=function(){function S(p,v,w,y,c,n){this._textarea=p,this._compositionView=v,this._bufferService=w,this._optionsService=y,this._coreService=c,this._renderService=n,this._isComposing=!1,this._isSendingComposition=!1,this._compositionPosition={start:0,end:0},this._dataAlreadySent=""}return Object.defineProperty(S.prototype,"isComposing",{get:function(){return this._isComposing},enumerable:!1,configurable:!0}),S.prototype.compositionstart=function(){this._isComposing=!0,this._compositionPosition.start=this._textarea.value.length,this._compositionView.textContent="",this._dataAlreadySent="",this._compositionView.classList.add("active")},S.prototype.compositionupdate=function(p){var v=this;this._compositionView.textContent=p.data,this.updateCompositionElements(),setTimeout(function(){v._compositionPosition.end=v._textarea.value.length},0)},S.prototype.compositionend=function(){this._finalizeComposition(!0)},S.prototype.keydown=function(p){if(this._isComposing||this._isSendingComposition){if(p.keyCode===229||p.keyCode===16||p.keyCode===17||p.keyCode===18)return!1;this._finalizeComposition(!1)}return p.keyCode!==229||(this._handleAnyTextareaChanges(),!1)},S.prototype._finalizeComposition=function(p){var v=this;if(this._compositionView.classList.remove("active"),this._isComposing=!1,p){var w={start:this._compositionPosition.start,end:this._compositionPosition.end};this._isSendingComposition=!0,setTimeout(function(){if(v._isSendingComposition){v._isSendingComposition=!1;var c;w.start+=v._dataAlreadySent.length,(c=v._isComposing?v._textarea.value.substring(w.start,w.end):v._textarea.value.substring(w.start)).length>0&&v._coreService.triggerDataEvent(c,!0)}},0)}else{this._isSendingComposition=!1;var y=this._textarea.value.substring(this._compositionPosition.start,this._compositionPosition.end);this._coreService.triggerDataEvent(y,!0)}},S.prototype._handleAnyTextareaChanges=function(){var p=this,v=this._textarea.value;setTimeout(function(){if(!p._isComposing){var w=p._textarea.value.replace(v,"");w.length>0&&(p._dataAlreadySent=w,p._coreService.triggerDataEvent(w,!0))}},0)},S.prototype.updateCompositionElements=function(p){var v=this;if(this._isComposing){if(this._bufferService.buffer.isCursorInViewport){var w=Math.min(this._bufferService.buffer.x,this._bufferService.cols-1),y=this._renderService.dimensions.actualCellHeight,c=this._bufferService.buffer.y*this._renderService.dimensions.actualCellHeight,n=w*this._renderService.dimensions.actualCellWidth;this._compositionView.style.left=n+"px",this._compositionView.style.top=c+"px",this._compositionView.style.height=y+"px",this._compositionView.style.lineHeight=y+"px",this._compositionView.style.fontFamily=this._optionsService.rawOptions.fontFamily,this._compositionView.style.fontSize=this._optionsService.rawOptions.fontSize+"px";var h=this._compositionView.getBoundingClientRect();this._textarea.style.left=n+"px",this._textarea.style.top=c+"px",this._textarea.style.width=Math.max(h.width,1)+"px",this._textarea.style.height=Math.max(h.height,1)+"px",this._textarea.style.lineHeight=h.height+"px"}p||setTimeout(function(){return v.updateCompositionElements(!0)},0)}},o([l(2,m.IBufferService),l(3,m.IOptionsService),l(4,m.ICoreService),l(5,f.IRenderService)],S)}();r.CompositionHelper=C},9806:(a,r)=>{function u(o,l,f){var m=f.getBoundingClientRect(),C=o.getComputedStyle(f),S=parseInt(C.getPropertyValue("padding-left")),p=parseInt(C.getPropertyValue("padding-top"));return[l.clientX-m.left-S,l.clientY-m.top-p]}Object.defineProperty(r,"__esModule",{value:!0}),r.getRawByteCoords=r.getCoords=r.getCoordsRelativeToElement=void 0,r.getCoordsRelativeToElement=u,r.getCoords=function(o,l,f,m,C,S,p,v,w){if(S){var y=u(o,l,f);if(y)return y[0]=Math.ceil((y[0]+(w?p/2:0))/p),y[1]=Math.ceil(y[1]/v),y[0]=Math.min(Math.max(y[0],1),m+(w?1:0)),y[1]=Math.min(Math.max(y[1],1),C),y}},r.getRawByteCoords=function(o){if(o)return{x:o[0]+32,y:o[1]+32}}},9504:(a,r,u)=>{Object.defineProperty(r,"__esModule",{value:!0}),r.moveToCellSequence=void 0;var o=u(2584);function l(v,w,y,c){var n=v-f(y,v),h=w-f(y,w),_=Math.abs(n-h)-function(d,b,g){for(var A=0,R=d-f(g,d),x=b-f(g,b),k=0;k<Math.abs(R-x);k++){var O=m(d,b)==="A"?-1:1,I=g.buffer.lines.get(R+O*k);I!=null&&I.isWrapped&&A++}return A}(v,w,y);return p(_,S(m(v,w),c))}function f(v,w){for(var y=0,c=v.buffer.lines.get(w),n=c==null?void 0:c.isWrapped;n&&w>=0&&w<v.rows;)y++,n=(c=v.buffer.lines.get(--w))==null?void 0:c.isWrapped;return y}function m(v,w){return v>w?"A":"B"}function C(v,w,y,c,n,h){for(var _=v,d=w,b="";_!==y||d!==c;)_+=n?1:-1,n&&_>h.cols-1?(b+=h.buffer.translateBufferLineToString(d,!1,v,_),_=0,v=0,d++):!n&&_<0&&(b+=h.buffer.translateBufferLineToString(d,!1,0,v+1),v=_=h.cols-1,d--);return b+h.buffer.translateBufferLineToString(d,!1,v,_)}function S(v,w){var y=w?"O":"[";return o.C0.ESC+y+v}function p(v,w){v=Math.floor(v);for(var y="",c=0;c<v;c++)y+=w;return y}r.moveToCellSequence=function(v,w,y,c){var n,h=y.buffer.x,_=y.buffer.y;if(!y.buffer.hasScrollback)return function(b,g,A,R,x,k){return l(g,R,x,k).length===0?"":p(C(b,g,b,g-f(x,g),!1,x).length,S("D",k))}(h,_,0,w,y,c)+l(_,w,y,c)+function(b,g,A,R,x,k){var O;O=l(g,R,x,k).length>0?R-f(x,R):g;var I=R,T=function(P,M,D,q,H,X){var $;return $=l(D,q,H,X).length>0?q-f(H,q):M,P<D&&$<=q||P>=D&&$<q?"C":"D"}(b,g,A,R,x,k);return p(C(b,O,A,I,T==="C",x).length,S(T,k))}(h,_,v,w,y,c);if(_===w)return n=h>v?"D":"C",p(Math.abs(h-v),S(n,c));n=_>w?"D":"C";var d=Math.abs(_-w);return p(function(b,g){return g.cols-b}(_>w?v:h,y)+(d-1)*y.cols+1+((_>w?h:v)-1),S(n,c))}},4389:function(a,r,u){var o=this&&this.__assign||function(){return o=Object.assign||function(c){for(var n,h=1,_=arguments.length;h<_;h++)for(var d in n=arguments[h])Object.prototype.hasOwnProperty.call(n,d)&&(c[d]=n[d]);return c},o.apply(this,arguments)},l=this&&this.__values||function(c){var n=typeof Symbol=="function"&&Symbol.iterator,h=n&&c[n],_=0;if(h)return h.call(c);if(c&&typeof c.length=="number")return{next:function(){return c&&_>=c.length&&(c=void 0),{value:c&&c[_++],done:!c}}};throw new TypeError(n?"Object is not iterable.":"Symbol.iterator is not defined.")};Object.defineProperty(r,"__esModule",{value:!0}),r.Terminal=void 0;var f=u(3236),m=u(9042),C=u(7975),S=u(7090),p=u(5741),v=u(8285),w=["cols","rows"],y=function(){function c(n){var h=this;this._core=new f.Terminal(n),this._addonManager=new p.AddonManager,this._publicOptions=o({},this._core.options);var _=function(A){return h._core.options[A]},d=function(A,R){h._checkReadonlyOptions(A),h._core.options[A]=R};for(var b in this._core.options){var g={get:_.bind(this,b),set:d.bind(this,b)};Object.defineProperty(this._publicOptions,b,g)}}return c.prototype._checkReadonlyOptions=function(n){if(w.includes(n))throw new Error('Option "'+n+'" can only be set in the constructor')},c.prototype._checkProposedApi=function(){if(!this._core.optionsService.rawOptions.allowProposedApi)throw new Error("You must set the allowProposedApi option to true to use proposed API")},Object.defineProperty(c.prototype,"onBell",{get:function(){return this._core.onBell},enumerable:!1,configurable:!0}),Object.defineProperty(c.prototype,"onBinary",{get:function(){return this._core.onBinary},enumerable:!1,configurable:!0}),Object.defineProperty(c.prototype,"onCursorMove",{get:function(){return this._core.onCursorMove},enumerable:!1,configurable:!0}),Object.defineProperty(c.prototype,"onData",{get:function(){return this._core.onData},enumerable:!1,configurable:!0}),Object.defineProperty(c.prototype,"onKey",{get:function(){return this._core.onKey},enumerable:!1,configurable:!0}),Object.defineProperty(c.prototype,"onLineFeed",{get:function(){return this._core.onLineFeed},enumerable:!1,configurable:!0}),Object.defineProperty(c.prototype,"onRender",{get:function(){return this._core.onRender},enumerable:!1,configurable:!0}),Object.defineProperty(c.prototype,"onResize",{get:function(){return this._core.onResize},enumerable:!1,configurable:!0}),Object.defineProperty(c.prototype,"onScroll",{get:function(){return this._core.onScroll},enumerable:!1,configurable:!0}),Object.defineProperty(c.prototype,"onSelectionChange",{get:function(){return this._core.onSelectionChange},enumerable:!1,configurable:!0}),Object.defineProperty(c.prototype,"onTitleChange",{get:function(){return this._core.onTitleChange},enumerable:!1,configurable:!0}),Object.defineProperty(c.prototype,"onWriteParsed",{get:function(){return this._core.onWriteParsed},enumerable:!1,configurable:!0}),Object.defineProperty(c.prototype,"element",{get:function(){return this._core.element},enumerable:!1,configurable:!0}),Object.defineProperty(c.prototype,"parser",{get:function(){return this._checkProposedApi(),this._parser||(this._parser=new C.ParserApi(this._core)),this._parser},enumerable:!1,configurable:!0}),Object.defineProperty(c.prototype,"unicode",{get:function(){return this._checkProposedApi(),new S.UnicodeApi(this._core)},enumerable:!1,configurable:!0}),Object.defineProperty(c.prototype,"textarea",{get:function(){return this._core.textarea},enumerable:!1,configurable:!0}),Object.defineProperty(c.prototype,"rows",{get:function(){return this._core.rows},enumerable:!1,configurable:!0}),Object.defineProperty(c.prototype,"cols",{get:function(){return this._core.cols},enumerable:!1,configurable:!0}),Object.defineProperty(c.prototype,"buffer",{get:function(){return this._checkProposedApi(),this._buffer||(this._buffer=new v.BufferNamespaceApi(this._core)),this._buffer},enumerable:!1,configurable:!0}),Object.defineProperty(c.prototype,"markers",{get:function(){return this._checkProposedApi(),this._core.markers},enumerable:!1,configurable:!0}),Object.defineProperty(c.prototype,"modes",{get:function(){var n=this._core.coreService.decPrivateModes,h="none";switch(this._core.coreMouseService.activeProtocol){case"X10":h="x10";break;case"VT200":h="vt200";break;case"DRAG":h="drag";break;case"ANY":h="any"}return{applicationCursorKeysMode:n.applicationCursorKeys,applicationKeypadMode:n.applicationKeypad,bracketedPasteMode:n.bracketedPasteMode,insertMode:this._core.coreService.modes.insertMode,mouseTrackingMode:h,originMode:n.origin,reverseWraparoundMode:n.reverseWraparound,sendFocusMode:n.sendFocus,wraparoundMode:n.wraparound}},enumerable:!1,configurable:!0}),Object.defineProperty(c.prototype,"options",{get:function(){return this._publicOptions},set:function(n){for(var h in n)this._publicOptions[h]=n[h]},enumerable:!1,configurable:!0}),c.prototype.blur=function(){this._core.blur()},c.prototype.focus=function(){this._core.focus()},c.prototype.resize=function(n,h){this._verifyIntegers(n,h),this._core.resize(n,h)},c.prototype.open=function(n){this._core.open(n)},c.prototype.attachCustomKeyEventHandler=function(n){this._core.attachCustomKeyEventHandler(n)},c.prototype.registerLinkMatcher=function(n,h,_){return this._checkProposedApi(),this._core.registerLinkMatcher(n,h,_)},c.prototype.deregisterLinkMatcher=function(n){this._checkProposedApi(),this._core.deregisterLinkMatcher(n)},c.prototype.registerLinkProvider=function(n){return this._checkProposedApi(),this._core.registerLinkProvider(n)},c.prototype.registerCharacterJoiner=function(n){return this._checkProposedApi(),this._core.registerCharacterJoiner(n)},c.prototype.deregisterCharacterJoiner=function(n){this._checkProposedApi(),this._core.deregisterCharacterJoiner(n)},c.prototype.registerMarker=function(n){return n===void 0&&(n=0),this._checkProposedApi(),this._verifyIntegers(n),this._core.addMarker(n)},c.prototype.registerDecoration=function(n){var h,_,d;return this._checkProposedApi(),this._verifyPositiveIntegers((h=n.x)!==null&&h!==void 0?h:0,(_=n.width)!==null&&_!==void 0?_:0,(d=n.height)!==null&&d!==void 0?d:0),this._core.registerDecoration(n)},c.prototype.addMarker=function(n){return this.registerMarker(n)},c.prototype.hasSelection=function(){return this._core.hasSelection()},c.prototype.select=function(n,h,_){this._verifyIntegers(n,h,_),this._core.select(n,h,_)},c.prototype.getSelection=function(){return this._core.getSelection()},c.prototype.getSelectionPosition=function(){return this._core.getSelectionPosition()},c.prototype.clearSelection=function(){this._core.clearSelection()},c.prototype.selectAll=function(){this._core.selectAll()},c.prototype.selectLines=function(n,h){this._verifyIntegers(n,h),this._core.selectLines(n,h)},c.prototype.dispose=function(){this._addonManager.dispose(),this._core.dispose()},c.prototype.scrollLines=function(n){this._verifyIntegers(n),this._core.scrollLines(n)},c.prototype.scrollPages=function(n){this._verifyIntegers(n),this._core.scrollPages(n)},c.prototype.scrollToTop=function(){this._core.scrollToTop()},c.prototype.scrollToBottom=function(){this._core.scrollToBottom()},c.prototype.scrollToLine=function(n){this._verifyIntegers(n),this._core.scrollToLine(n)},c.prototype.clear=function(){this._core.clear()},c.prototype.write=function(n,h){this._core.write(n,h)},c.prototype.writeUtf8=function(n,h){this._core.write(n,h)},c.prototype.writeln=function(n,h){this._core.write(n),this._core.write(`\r
`,h)},c.prototype.paste=function(n){this._core.paste(n)},c.prototype.getOption=function(n){return this._core.optionsService.getOption(n)},c.prototype.setOption=function(n,h){this._checkReadonlyOptions(n),this._core.optionsService.setOption(n,h)},c.prototype.refresh=function(n,h){this._verifyIntegers(n,h),this._core.refresh(n,h)},c.prototype.reset=function(){this._core.reset()},c.prototype.clearTextureAtlas=function(){this._core.clearTextureAtlas()},c.prototype.loadAddon=function(n){return this._addonManager.loadAddon(this,n)},Object.defineProperty(c,"strings",{get:function(){return m},enumerable:!1,configurable:!0}),c.prototype._verifyIntegers=function(){for(var n,h,_=[],d=0;d<arguments.length;d++)_[d]=arguments[d];try{for(var b=l(_),g=b.next();!g.done;g=b.next()){var A=g.value;if(A===1/0||isNaN(A)||A%1!=0)throw new Error("This API only accepts integers")}}catch(R){n={error:R}}finally{try{g&&!g.done&&(h=b.return)&&h.call(b)}finally{if(n)throw n.error}}},c.prototype._verifyPositiveIntegers=function(){for(var n,h,_=[],d=0;d<arguments.length;d++)_[d]=arguments[d];try{for(var b=l(_),g=b.next();!g.done;g=b.next()){var A=g.value;if(A&&(A===1/0||isNaN(A)||A%1!=0||A<0))throw new Error("This API only accepts positive integers")}}catch(R){n={error:R}}finally{try{g&&!g.done&&(h=b.return)&&h.call(b)}finally{if(n)throw n.error}}},c}();r.Terminal=y},1546:function(a,r,u){var o=this&&this.__values||function(c){var n=typeof Symbol=="function"&&Symbol.iterator,h=n&&c[n],_=0;if(h)return h.call(c);if(c&&typeof c.length=="number")return{next:function(){return c&&_>=c.length&&(c=void 0),{value:c&&c[_++],done:!c}}};throw new TypeError(n?"Object is not iterable.":"Symbol.iterator is not defined.")};Object.defineProperty(r,"__esModule",{value:!0}),r.BaseRenderLayer=void 0;var l=u(643),f=u(8803),m=u(1420),C=u(3734),S=u(1752),p=u(8055),v=u(9631),w=u(8978),y=function(){function c(n,h,_,d,b,g,A,R,x){this._container=n,this._alpha=d,this._colors=b,this._rendererId=g,this._bufferService=A,this._optionsService=R,this._decorationService=x,this._scaledCharWidth=0,this._scaledCharHeight=0,this._scaledCellWidth=0,this._scaledCellHeight=0,this._scaledCharLeft=0,this._scaledCharTop=0,this._columnSelectMode=!1,this._currentGlyphIdentifier={chars:"",code:0,bg:0,fg:0,bold:!1,dim:!1,italic:!1},this._canvas=document.createElement("canvas"),this._canvas.classList.add("xterm-"+h+"-layer"),this._canvas.style.zIndex=_.toString(),this._initCanvas(),this._container.appendChild(this._canvas)}return c.prototype.dispose=function(){var n;(0,v.removeElementFromParent)(this._canvas),(n=this._charAtlas)===null||n===void 0||n.dispose()},c.prototype._initCanvas=function(){this._ctx=(0,S.throwIfFalsy)(this._canvas.getContext("2d",{alpha:this._alpha})),this._alpha||this._clearAll()},c.prototype.onOptionsChanged=function(){},c.prototype.onBlur=function(){},c.prototype.onFocus=function(){},c.prototype.onCursorMove=function(){},c.prototype.onGridChanged=function(n,h){},c.prototype.onSelectionChanged=function(n,h,_){_===void 0&&(_=!1),this._selectionStart=n,this._selectionEnd=h,this._columnSelectMode=_},c.prototype.setColors=function(n){this._refreshCharAtlas(n)},c.prototype._setTransparency=function(n){if(n!==this._alpha){var h=this._canvas;this._alpha=n,this._canvas=this._canvas.cloneNode(),this._initCanvas(),this._container.replaceChild(this._canvas,h),this._refreshCharAtlas(this._colors),this.onGridChanged(0,this._bufferService.rows-1)}},c.prototype._refreshCharAtlas=function(n){this._scaledCharWidth<=0&&this._scaledCharHeight<=0||(this._charAtlas=(0,m.acquireCharAtlas)(this._optionsService.rawOptions,this._rendererId,n,this._scaledCharWidth,this._scaledCharHeight),this._charAtlas.warmUp())},c.prototype.resize=function(n){this._scaledCellWidth=n.scaledCellWidth,this._scaledCellHeight=n.scaledCellHeight,this._scaledCharWidth=n.scaledCharWidth,this._scaledCharHeight=n.scaledCharHeight,this._scaledCharLeft=n.scaledCharLeft,this._scaledCharTop=n.scaledCharTop,this._canvas.width=n.scaledCanvasWidth,this._canvas.height=n.scaledCanvasHeight,this._canvas.style.width=n.canvasWidth+"px",this._canvas.style.height=n.canvasHeight+"px",this._alpha||this._clearAll(),this._refreshCharAtlas(this._colors)},c.prototype.clearTextureAtlas=function(){var n;(n=this._charAtlas)===null||n===void 0||n.clear()},c.prototype._fillCells=function(n,h,_,d){this._ctx.fillRect(n*this._scaledCellWidth,h*this._scaledCellHeight,_*this._scaledCellWidth,d*this._scaledCellHeight)},c.prototype._fillMiddleLineAtCells=function(n,h,_){_===void 0&&(_=1);var d=Math.ceil(.5*this._scaledCellHeight);this._ctx.fillRect(n*this._scaledCellWidth,(h+1)*this._scaledCellHeight-d-window.devicePixelRatio,_*this._scaledCellWidth,window.devicePixelRatio)},c.prototype._fillBottomLineAtCells=function(n,h,_){_===void 0&&(_=1),this._ctx.fillRect(n*this._scaledCellWidth,(h+1)*this._scaledCellHeight-window.devicePixelRatio-1,_*this._scaledCellWidth,window.devicePixelRatio)},c.prototype._fillLeftLineAtCell=function(n,h,_){this._ctx.fillRect(n*this._scaledCellWidth,h*this._scaledCellHeight,window.devicePixelRatio*_,this._scaledCellHeight)},c.prototype._strokeRectAtCell=function(n,h,_,d){this._ctx.lineWidth=window.devicePixelRatio,this._ctx.strokeRect(n*this._scaledCellWidth+window.devicePixelRatio/2,h*this._scaledCellHeight+window.devicePixelRatio/2,_*this._scaledCellWidth-window.devicePixelRatio,d*this._scaledCellHeight-window.devicePixelRatio)},c.prototype._clearAll=function(){this._alpha?this._ctx.clearRect(0,0,this._canvas.width,this._canvas.height):(this._ctx.fillStyle=this._colors.background.css,this._ctx.fillRect(0,0,this._canvas.width,this._canvas.height))},c.prototype._clearCells=function(n,h,_,d){this._alpha?this._ctx.clearRect(n*this._scaledCellWidth,h*this._scaledCellHeight,_*this._scaledCellWidth,d*this._scaledCellHeight):(this._ctx.fillStyle=this._colors.background.css,this._ctx.fillRect(n*this._scaledCellWidth,h*this._scaledCellHeight,_*this._scaledCellWidth,d*this._scaledCellHeight))},c.prototype._fillCharTrueColor=function(n,h,_){this._ctx.font=this._getFont(!1,!1),this._ctx.textBaseline=f.TEXT_BASELINE,this._clipRow(_);var d=!1;this._optionsService.rawOptions.customGlyphs!==!1&&(d=(0,w.tryDrawCustomChar)(this._ctx,n.getChars(),h*this._scaledCellWidth,_*this._scaledCellHeight,this._scaledCellWidth,this._scaledCellHeight)),d||this._ctx.fillText(n.getChars(),h*this._scaledCellWidth+this._scaledCharLeft,_*this._scaledCellHeight+this._scaledCharTop+this._scaledCharHeight)},c.prototype._drawChars=function(n,h,_){var d,b,g,A=this._getContrastColor(n,h,_);if(A||n.isFgRGB()||n.isBgRGB())this._drawUncachedChars(n,h,_,A);else{var R,x;n.isInverse()?(R=n.isBgDefault()?f.INVERTED_DEFAULT_COLOR:n.getBgColor(),x=n.isFgDefault()?f.INVERTED_DEFAULT_COLOR:n.getFgColor()):(x=n.isBgDefault()?l.DEFAULT_COLOR:n.getBgColor(),R=n.isFgDefault()?l.DEFAULT_COLOR:n.getFgColor()),R+=this._optionsService.rawOptions.drawBoldTextInBrightColors&&n.isBold()&&R<8?8:0,this._currentGlyphIdentifier.chars=n.getChars()||l.WHITESPACE_CELL_CHAR,this._currentGlyphIdentifier.code=n.getCode()||l.WHITESPACE_CELL_CODE,this._currentGlyphIdentifier.bg=x,this._currentGlyphIdentifier.fg=R,this._currentGlyphIdentifier.bold=!!n.isBold(),this._currentGlyphIdentifier.dim=!!n.isDim(),this._currentGlyphIdentifier.italic=!!n.isItalic();var k=!1;try{for(var O=o(this._decorationService.getDecorationsAtCell(h,_)),I=O.next();!I.done;I=O.next()){var T=I.value;if(T.backgroundColorRGB||T.foregroundColorRGB){k=!0;break}}}catch(P){d={error:P}}finally{try{I&&!I.done&&(b=O.return)&&b.call(O)}finally{if(d)throw d.error}}!k&&(!((g=this._charAtlas)===null||g===void 0)&&g.draw(this._ctx,this._currentGlyphIdentifier,h*this._scaledCellWidth+this._scaledCharLeft,_*this._scaledCellHeight+this._scaledCharTop))||this._drawUncachedChars(n,h,_)}},c.prototype._drawUncachedChars=function(n,h,_,d){if(this._ctx.save(),this._ctx.font=this._getFont(!!n.isBold(),!!n.isItalic()),this._ctx.textBaseline=f.TEXT_BASELINE,n.isInverse())if(d)this._ctx.fillStyle=d.css;else if(n.isBgDefault())this._ctx.fillStyle=p.color.opaque(this._colors.background).css;else if(n.isBgRGB())this._ctx.fillStyle="rgb("+C.AttributeData.toColorRGB(n.getBgColor()).join(",")+")";else{var b=n.getBgColor();this._optionsService.rawOptions.drawBoldTextInBrightColors&&n.isBold()&&b<8&&(b+=8),this._ctx.fillStyle=this._colors.ansi[b].css}else if(d)this._ctx.fillStyle=d.css;else if(n.isFgDefault())this._ctx.fillStyle=this._colors.foreground.css;else if(n.isFgRGB())this._ctx.fillStyle="rgb("+C.AttributeData.toColorRGB(n.getFgColor()).join(",")+")";else{var g=n.getFgColor();this._optionsService.rawOptions.drawBoldTextInBrightColors&&n.isBold()&&g<8&&(g+=8),this._ctx.fillStyle=this._colors.ansi[g].css}this._clipRow(_),n.isDim()&&(this._ctx.globalAlpha=f.DIM_OPACITY);var A=!1;this._optionsService.rawOptions.customGlyphs!==!1&&(A=(0,w.tryDrawCustomChar)(this._ctx,n.getChars(),h*this._scaledCellWidth,_*this._scaledCellHeight,this._scaledCellWidth,this._scaledCellHeight)),A||this._ctx.fillText(n.getChars(),h*this._scaledCellWidth+this._scaledCharLeft,_*this._scaledCellHeight+this._scaledCharTop+this._scaledCharHeight),this._ctx.restore()},c.prototype._clipRow=function(n){this._ctx.beginPath(),this._ctx.rect(0,n*this._scaledCellHeight,this._bufferService.cols*this._scaledCellWidth,this._scaledCellHeight),this._ctx.clip()},c.prototype._getFont=function(n,h){return(h?"italic":"")+" "+(n?this._optionsService.rawOptions.fontWeightBold:this._optionsService.rawOptions.fontWeight)+" "+this._optionsService.rawOptions.fontSize*window.devicePixelRatio+"px "+this._optionsService.rawOptions.fontFamily},c.prototype._getContrastColor=function(n,h,_){var d,b,g,A,R=!1;try{for(var x=o(this._decorationService.getDecorationsAtCell(h,_)),k=x.next();!k.done;k=x.next()){var O=k.value;O.options.layer!=="top"&&R||(O.backgroundColorRGB&&(g=O.backgroundColorRGB.rgba),O.foregroundColorRGB&&(A=O.foregroundColorRGB.rgba),R=O.options.layer==="top")}}catch(pe){d={error:pe}}finally{try{k&&!k.done&&(b=x.return)&&b.call(x)}finally{if(d)throw d.error}}if(R||this._colors.selectionForeground&&this._isCellInSelection(h,_)&&(A=this._colors.selectionForeground.rgba),g||A||this._optionsService.rawOptions.minimumContrastRatio!==1&&!(0,S.excludeFromContrastRatioDemands)(n.getCode())){if(!g&&!A){var I=this._colors.contrastCache.getColor(n.bg,n.fg);if(I!==void 0)return I||void 0}var T=n.getFgColor(),P=n.getFgColorMode(),M=n.getBgColor(),D=n.getBgColorMode(),q=!!n.isInverse(),H=!!n.isInverse();if(q){var X=T;T=M,M=X;var $=P;P=D,D=$}var G=this._resolveBackgroundRgba(g!==void 0?50331648:D,g??M,q),ie=this._resolveForegroundRgba(P,T,q,H),ee=p.rgba.ensureContrastRatio(g??G,A??ie,this._optionsService.rawOptions.minimumContrastRatio);if(!ee){if(!A)return void this._colors.contrastCache.setColor(n.bg,n.fg,null);ee=A}var B={css:p.channels.toCss(ee>>24&255,ee>>16&255,ee>>8&255),rgba:ee};return g||A||this._colors.contrastCache.setColor(n.bg,n.fg,B),B}},c.prototype._resolveBackgroundRgba=function(n,h,_){switch(n){case 16777216:case 33554432:return this._colors.ansi[h].rgba;case 50331648:return h<<8;default:return _?this._colors.foreground.rgba:this._colors.background.rgba}},c.prototype._resolveForegroundRgba=function(n,h,_,d){switch(n){case 16777216:case 33554432:return this._optionsService.rawOptions.drawBoldTextInBrightColors&&d&&h<8&&(h+=8),this._colors.ansi[h].rgba;case 50331648:return h<<8;default:return _?this._colors.background.rgba:this._colors.foreground.rgba}},c.prototype._isCellInSelection=function(n,h){var _=this._selectionStart,d=this._selectionEnd;return!(!_||!d)&&(this._columnSelectMode?n>=_[0]&&h>=_[1]&&n<d[0]&&h<d[1]:h>_[1]&&h<d[1]||_[1]===d[1]&&h===_[1]&&n>=_[0]&&n<d[0]||_[1]<d[1]&&h===d[1]&&n<d[0]||_[1]<d[1]&&h===_[1]&&n>=_[0])},c}();r.BaseRenderLayer=y},2512:function(a,r,u){var o,l=this&&this.__extends||(o=function(n,h){return o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(_,d){_.__proto__=d}||function(_,d){for(var b in d)Object.prototype.hasOwnProperty.call(d,b)&&(_[b]=d[b])},o(n,h)},function(n,h){if(typeof h!="function"&&h!==null)throw new TypeError("Class extends value "+String(h)+" is not a constructor or null");function _(){this.constructor=n}o(n,h),n.prototype=h===null?Object.create(h):(_.prototype=h.prototype,new _)}),f=this&&this.__decorate||function(n,h,_,d){var b,g=arguments.length,A=g<3?h:d===null?d=Object.getOwnPropertyDescriptor(h,_):d;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")A=Reflect.decorate(n,h,_,d);else for(var R=n.length-1;R>=0;R--)(b=n[R])&&(A=(g<3?b(A):g>3?b(h,_,A):b(h,_))||A);return g>3&&A&&Object.defineProperty(h,_,A),A},m=this&&this.__param||function(n,h){return function(_,d){h(_,d,n)}};Object.defineProperty(r,"__esModule",{value:!0}),r.CursorRenderLayer=void 0;var C=u(1546),S=u(511),p=u(2585),v=u(4725),w=600,y=function(n){function h(_,d,b,g,A,R,x,k,O,I){var T=n.call(this,_,"cursor",d,!0,b,g,R,x,I)||this;return T._onRequestRedraw=A,T._coreService=k,T._coreBrowserService=O,T._cell=new S.CellData,T._state={x:0,y:0,isFocused:!1,style:"",width:0},T._cursorRenderers={bar:T._renderBarCursor.bind(T),block:T._renderBlockCursor.bind(T),underline:T._renderUnderlineCursor.bind(T)},T}return l(h,n),h.prototype.dispose=function(){this._cursorBlinkStateManager&&(this._cursorBlinkStateManager.dispose(),this._cursorBlinkStateManager=void 0),n.prototype.dispose.call(this)},h.prototype.resize=function(_){n.prototype.resize.call(this,_),this._state={x:0,y:0,isFocused:!1,style:"",width:0}},h.prototype.reset=function(){var _;this._clearCursor(),(_=this._cursorBlinkStateManager)===null||_===void 0||_.restartBlinkAnimation(),this.onOptionsChanged()},h.prototype.onBlur=function(){var _;(_=this._cursorBlinkStateManager)===null||_===void 0||_.pause(),this._onRequestRedraw.fire({start:this._bufferService.buffer.y,end:this._bufferService.buffer.y})},h.prototype.onFocus=function(){var _;(_=this._cursorBlinkStateManager)===null||_===void 0||_.resume(),this._onRequestRedraw.fire({start:this._bufferService.buffer.y,end:this._bufferService.buffer.y})},h.prototype.onOptionsChanged=function(){var _,d=this;this._optionsService.rawOptions.cursorBlink?this._cursorBlinkStateManager||(this._cursorBlinkStateManager=new c(this._coreBrowserService.isFocused,function(){d._render(!0)})):((_=this._cursorBlinkStateManager)===null||_===void 0||_.dispose(),this._cursorBlinkStateManager=void 0),this._onRequestRedraw.fire({start:this._bufferService.buffer.y,end:this._bufferService.buffer.y})},h.prototype.onCursorMove=function(){var _;(_=this._cursorBlinkStateManager)===null||_===void 0||_.restartBlinkAnimation()},h.prototype.onGridChanged=function(_,d){!this._cursorBlinkStateManager||this._cursorBlinkStateManager.isPaused?this._render(!1):this._cursorBlinkStateManager.restartBlinkAnimation()},h.prototype._render=function(_){if(this._coreService.isCursorInitialized&&!this._coreService.isCursorHidden){var d=this._bufferService.buffer.ybase+this._bufferService.buffer.y,b=d-this._bufferService.buffer.ydisp;if(b<0||b>=this._bufferService.rows)this._clearCursor();else{var g=Math.min(this._bufferService.buffer.x,this._bufferService.cols-1);if(this._bufferService.buffer.lines.get(d).loadCell(g,this._cell),this._cell.content!==void 0){if(!this._coreBrowserService.isFocused){this._clearCursor(),this._ctx.save(),this._ctx.fillStyle=this._colors.cursor.css;var A=this._optionsService.rawOptions.cursorStyle;return A&&A!=="block"?this._cursorRenderers[A](g,b,this._cell):this._renderBlurCursor(g,b,this._cell),this._ctx.restore(),this._state.x=g,this._state.y=b,this._state.isFocused=!1,this._state.style=A,void(this._state.width=this._cell.getWidth())}if(!this._cursorBlinkStateManager||this._cursorBlinkStateManager.isCursorVisible){if(this._state){if(this._state.x===g&&this._state.y===b&&this._state.isFocused===this._coreBrowserService.isFocused&&this._state.style===this._optionsService.rawOptions.cursorStyle&&this._state.width===this._cell.getWidth())return;this._clearCursor()}this._ctx.save(),this._cursorRenderers[this._optionsService.rawOptions.cursorStyle||"block"](g,b,this._cell),this._ctx.restore(),this._state.x=g,this._state.y=b,this._state.isFocused=!1,this._state.style=this._optionsService.rawOptions.cursorStyle,this._state.width=this._cell.getWidth()}else this._clearCursor()}}}else this._clearCursor()},h.prototype._clearCursor=function(){this._state&&(window.devicePixelRatio<1?this._clearAll():this._clearCells(this._state.x,this._state.y,this._state.width,1),this._state={x:0,y:0,isFocused:!1,style:"",width:0})},h.prototype._renderBarCursor=function(_,d,b){this._ctx.save(),this._ctx.fillStyle=this._colors.cursor.css,this._fillLeftLineAtCell(_,d,this._optionsService.rawOptions.cursorWidth),this._ctx.restore()},h.prototype._renderBlockCursor=function(_,d,b){this._ctx.save(),this._ctx.fillStyle=this._colors.cursor.css,this._fillCells(_,d,b.getWidth(),1),this._ctx.fillStyle=this._colors.cursorAccent.css,this._fillCharTrueColor(b,_,d),this._ctx.restore()},h.prototype._renderUnderlineCursor=function(_,d,b){this._ctx.save(),this._ctx.fillStyle=this._colors.cursor.css,this._fillBottomLineAtCells(_,d),this._ctx.restore()},h.prototype._renderBlurCursor=function(_,d,b){this._ctx.save(),this._ctx.strokeStyle=this._colors.cursor.css,this._strokeRectAtCell(_,d,b.getWidth(),1),this._ctx.restore()},f([m(5,p.IBufferService),m(6,p.IOptionsService),m(7,p.ICoreService),m(8,v.ICoreBrowserService),m(9,p.IDecorationService)],h)}(C.BaseRenderLayer);r.CursorRenderLayer=y;var c=function(){function n(h,_){this._renderCallback=_,this.isCursorVisible=!0,h&&this._restartInterval()}return Object.defineProperty(n.prototype,"isPaused",{get:function(){return!(this._blinkStartTimeout||this._blinkInterval)},enumerable:!1,configurable:!0}),n.prototype.dispose=function(){this._blinkInterval&&(window.clearInterval(this._blinkInterval),this._blinkInterval=void 0),this._blinkStartTimeout&&(window.clearTimeout(this._blinkStartTimeout),this._blinkStartTimeout=void 0),this._animationFrame&&(window.cancelAnimationFrame(this._animationFrame),this._animationFrame=void 0)},n.prototype.restartBlinkAnimation=function(){var h=this;this.isPaused||(this._animationTimeRestarted=Date.now(),this.isCursorVisible=!0,this._animationFrame||(this._animationFrame=window.requestAnimationFrame(function(){h._renderCallback(),h._animationFrame=void 0})))},n.prototype._restartInterval=function(h){var _=this;h===void 0&&(h=w),this._blinkInterval&&(window.clearInterval(this._blinkInterval),this._blinkInterval=void 0),this._blinkStartTimeout=window.setTimeout(function(){if(_._animationTimeRestarted){var d=w-(Date.now()-_._animationTimeRestarted);if(_._animationTimeRestarted=void 0,d>0)return void _._restartInterval(d)}_.isCursorVisible=!1,_._animationFrame=window.requestAnimationFrame(function(){_._renderCallback(),_._animationFrame=void 0}),_._blinkInterval=window.setInterval(function(){if(_._animationTimeRestarted){var b=w-(Date.now()-_._animationTimeRestarted);return _._animationTimeRestarted=void 0,void _._restartInterval(b)}_.isCursorVisible=!_.isCursorVisible,_._animationFrame=window.requestAnimationFrame(function(){_._renderCallback(),_._animationFrame=void 0})},w)},h)},n.prototype.pause=function(){this.isCursorVisible=!0,this._blinkInterval&&(window.clearInterval(this._blinkInterval),this._blinkInterval=void 0),this._blinkStartTimeout&&(window.clearTimeout(this._blinkStartTimeout),this._blinkStartTimeout=void 0),this._animationFrame&&(window.cancelAnimationFrame(this._animationFrame),this._animationFrame=void 0)},n.prototype.resume=function(){this.pause(),this._animationTimeRestarted=void 0,this._restartInterval(),this.restartBlinkAnimation()},n}()},8978:function(a,r,u){var o,l,f,m,C,S,p,v,w,y,c,n,h,_,d,b,g,A,R,x,k,O,I,T,P,M,D,q,H,X,$,G,ie,ee,B,pe,de,Oe,N,xe,le,K,F,U,W,ae,he,me,De,He,Ne,re,ze,et,bt,ni,rs,ss,ns,os,as,hs,Fi,Ui,Hi,Ni,zi,ji,Wi,Gi,Ki,Vi,Xi,Yi,Zi,Ji,Qi,$i,er,tr,ir,rr,sr,nr,or,ar,hr,cr,_r,lr,ur,dr,fr,pr,vr,mr,gr,yr,br,wr,Sr,Cr,Er,xr,kr,Ar,Lr,Rr,Or,Tr,Mr,Dr,cs,_s,ls,us,ds,fs,ps,vs,ms,gs,ys,bs,ws,Ss,Cs,Es,on=this&&this.__read||function(z,j){var qe=typeof Symbol=="function"&&z[Symbol.iterator];if(!qe)return z;var tt,wt,at=qe.call(z),Ie=[];try{for(;(j===void 0||j-- >0)&&!(tt=at.next()).done;)Ie.push(tt.value)}catch(ct){wt={error:ct}}finally{try{tt&&!tt.done&&(qe=at.return)&&qe.call(at)}finally{if(wt)throw wt.error}}return Ie},xs=this&&this.__values||function(z){var j=typeof Symbol=="function"&&Symbol.iterator,qe=j&&z[j],tt=0;if(qe)return qe.call(z);if(z&&typeof z.length=="number")return{next:function(){return z&&tt>=z.length&&(z=void 0),{value:z&&z[tt++],done:!z}}};throw new TypeError(j?"Object is not iterable.":"Symbol.iterator is not defined.")};Object.defineProperty(r,"__esModule",{value:!0}),r.tryDrawCustomChar=r.powerlineDefinitions=r.boxDrawingDefinitions=r.blockElementDefinitions=void 0;var an=u(1752);r.blockElementDefinitions={"â":[{x:0,y:0,w:8,h:4}],"â":[{x:0,y:7,w:8,h:1}],"â":[{x:0,y:6,w:8,h:2}],"â":[{x:0,y:5,w:8,h:3}],"â":[{x:0,y:4,w:8,h:4}],"â":[{x:0,y:3,w:8,h:5}],"â":[{x:0,y:2,w:8,h:6}],"â":[{x:0,y:1,w:8,h:7}],"â":[{x:0,y:0,w:8,h:8}],"â":[{x:0,y:0,w:7,h:8}],"â":[{x:0,y:0,w:6,h:8}],"â":[{x:0,y:0,w:5,h:8}],"â":[{x:0,y:0,w:4,h:8}],"â":[{x:0,y:0,w:3,h:8}],"â":[{x:0,y:0,w:2,h:8}],"â":[{x:0,y:0,w:1,h:8}],"â":[{x:4,y:0,w:4,h:8}],"â":[{x:0,y:0,w:9,h:1}],"â":[{x:7,y:0,w:1,h:8}],"â":[{x:0,y:4,w:4,h:4}],"â":[{x:4,y:4,w:4,h:4}],"â":[{x:0,y:0,w:4,h:4}],"â":[{x:0,y:0,w:4,h:8},{x:0,y:4,w:8,h:4}],"â":[{x:0,y:0,w:4,h:4},{x:4,y:4,w:4,h:4}],"â":[{x:0,y:0,w:4,h:8},{x:0,y:0,w:4,h:8}],"â":[{x:0,y:0,w:8,h:4},{x:4,y:0,w:4,h:8}],"â":[{x:4,y:0,w:4,h:4}],"â":[{x:4,y:0,w:4,h:4},{x:0,y:4,w:4,h:4}],"â":[{x:4,y:0,w:4,h:8},{x:0,y:4,w:8,h:4}],"ð­°":[{x:1,y:0,w:1,h:8}],"ð­±":[{x:2,y:0,w:1,h:8}],"ð­²":[{x:3,y:0,w:1,h:8}],"ð­³":[{x:4,y:0,w:1,h:8}],"ð­´":[{x:5,y:0,w:1,h:8}],"ð­µ":[{x:6,y:0,w:1,h:8}],"ð­¶":[{x:0,y:1,w:8,h:1}],"ð­·":[{x:0,y:2,w:8,h:1}],"ð­¸":[{x:0,y:3,w:8,h:1}],"ð­¹":[{x:0,y:4,w:8,h:1}],"ð­º":[{x:0,y:5,w:8,h:1}],"ð­»":[{x:0,y:6,w:8,h:1}],"ð­¼":[{x:0,y:0,w:1,h:8},{x:0,y:7,w:8,h:1}],"ð­½":[{x:0,y:0,w:1,h:8},{x:0,y:0,w:8,h:1}],"ð­¾":[{x:7,y:0,w:1,h:8},{x:0,y:0,w:8,h:1}],"ð­¿":[{x:7,y:0,w:1,h:8},{x:0,y:7,w:8,h:1}],"ð®":[{x:0,y:0,w:8,h:1},{x:0,y:7,w:8,h:1}],"ð®":[{x:0,y:0,w:8,h:1},{x:0,y:2,w:8,h:1},{x:0,y:4,w:8,h:1},{x:0,y:7,w:8,h:1}],"ð®":[{x:0,y:0,w:8,h:2}],"ð®":[{x:0,y:0,w:8,h:3}],"ð®":[{x:0,y:0,w:8,h:5}],"ð®":[{x:0,y:0,w:8,h:6}],"ð®":[{x:0,y:0,w:8,h:7}],"ð®":[{x:6,y:0,w:2,h:8}],"ð®":[{x:5,y:0,w:3,h:8}],"ð®":[{x:3,y:0,w:5,h:8}],"ð®":[{x:2,y:0,w:6,h:8}],"ð®":[{x:1,y:0,w:7,h:8}],"ð®":[{x:0,y:0,w:2,h:2},{x:4,y:0,w:2,h:2},{x:2,y:2,w:2,h:2},{x:6,y:2,w:2,h:2},{x:0,y:4,w:2,h:2},{x:4,y:4,w:2,h:2},{x:2,y:6,w:2,h:2},{x:6,y:6,w:2,h:2}],"ð®":[{x:2,y:0,w:2,h:2},{x:6,y:0,w:2,h:2},{x:0,y:2,w:2,h:2},{x:4,y:2,w:2,h:2},{x:2,y:4,w:2,h:2},{x:6,y:4,w:2,h:2},{x:0,y:6,w:2,h:2},{x:4,y:6,w:2,h:2}],"ð®":[{x:0,y:2,w:8,h:2},{x:0,y:6,w:8,h:2}]};var jo={"â":[[1,0,0,0],[0,0,0,0],[0,0,1,0],[0,0,0,0]],"â":[[1,0],[0,0],[0,1],[0,0]],"â":[[0,1],[1,1],[1,0],[1,1]]};r.boxDrawingDefinitions={"â":(o={},o[1]="M0,.5 L1,.5",o),"â":(l={},l[3]="M0,.5 L1,.5",l),"â":(f={},f[1]="M.5,0 L.5,1",f),"â":(m={},m[3]="M.5,0 L.5,1",m),"â":(C={},C[1]="M0.5,1 L.5,.5 L1,.5",C),"â":(S={},S[3]="M0.5,1 L.5,.5 L1,.5",S),"â":(p={},p[1]="M0,.5 L.5,.5 L.5,1",p),"â":(v={},v[3]="M0,.5 L.5,.5 L.5,1",v),"â":(w={},w[1]="M.5,0 L.5,.5 L1,.5",w),"â":(y={},y[3]="M.5,0 L.5,.5 L1,.5",y),"â":(c={},c[1]="M.5,0 L.5,.5 L0,.5",c),"â":(n={},n[3]="M.5,0 L.5,.5 L0,.5",n),"â":(h={},h[1]="M.5,0 L.5,1 M.5,.5 L1,.5",h),"â£":(_={},_[3]="M.5,0 L.5,1 M.5,.5 L1,.5",_),"â¤":(d={},d[1]="M.5,0 L.5,1 M.5,.5 L0,.5",d),"â«":(b={},b[3]="M.5,0 L.5,1 M.5,.5 L0,.5",b),"â¬":(g={},g[1]="M0,.5 L1,.5 M.5,.5 L.5,1",g),"â³":(A={},A[3]="M0,.5 L1,.5 M.5,.5 L.5,1",A),"â´":(R={},R[1]="M0,.5 L1,.5 M.5,.5 L.5,0",R),"â»":(x={},x[3]="M0,.5 L1,.5 M.5,.5 L.5,0",x),"â¼":(k={},k[1]="M0,.5 L1,.5 M.5,0 L.5,1",k),"â":(O={},O[3]="M0,.5 L1,.5 M.5,0 L.5,1",O),"â´":(I={},I[1]="M.5,.5 L0,.5",I),"â¸":(T={},T[3]="M.5,.5 L0,.5",T),"âµ":(P={},P[1]="M.5,.5 L.5,0",P),"â¹":(M={},M[3]="M.5,.5 L.5,0",M),"â¶":(D={},D[1]="M.5,.5 L1,.5",D),"âº":(q={},q[3]="M.5,.5 L1,.5",q),"â·":(H={},H[1]="M.5,.5 L.5,1",H),"â»":(X={},X[3]="M.5,.5 L.5,1",X),"â":($={},$[1]=function(z,j){return"M0,"+(.5-j)+" L1,"+(.5-j)+" M0,"+(.5+j)+" L1,"+(.5+j)},$),"â":(G={},G[1]=function(z,j){return"M"+(.5-z)+",0 L"+(.5-z)+",1 M"+(.5+z)+",0 L"+(.5+z)+",1"},G),"â":(ie={},ie[1]=function(z,j){return"M.5,1 L.5,"+(.5-j)+" L1,"+(.5-j)+" M.5,"+(.5+j)+" L1,"+(.5+j)},ie),"â":(ee={},ee[1]=function(z,j){return"M"+(.5-z)+",1 L"+(.5-z)+",.5 L1,.5 M"+(.5+z)+",.5 L"+(.5+z)+",1"},ee),"â":(B={},B[1]=function(z,j){return"M1,"+(.5-j)+" L"+(.5-z)+","+(.5-j)+" L"+(.5-z)+",1 M1,"+(.5+j)+" L"+(.5+z)+","+(.5+j)+" L"+(.5+z)+",1"},B),"â":(pe={},pe[1]=function(z,j){return"M0,"+(.5-j)+" L.5,"+(.5-j)+" L.5,1 M0,"+(.5+j)+" L.5,"+(.5+j)},pe),"â":(de={},de[1]=function(z,j){return"M"+(.5+z)+",1 L"+(.5+z)+",.5 L0,.5 M"+(.5-z)+",.5 L"+(.5-z)+",1"},de),"â":(Oe={},Oe[1]=function(z,j){return"M0,"+(.5+j)+" L"+(.5-z)+","+(.5+j)+" L"+(.5-z)+",1 M0,"+(.5-j)+" L"+(.5+z)+","+(.5-j)+" L"+(.5+z)+",1"},Oe),"â":(N={},N[1]=function(z,j){return"M.5,0 L.5,"+(.5+j)+" L1,"+(.5+j)+" M.5,"+(.5-j)+" L1,"+(.5-j)},N),"â":(xe={},xe[1]=function(z,j){return"M1,.5 L"+(.5-z)+",.5 L"+(.5-z)+",0 M"+(.5+z)+",.5 L"+(.5+z)+",0"},xe),"â":(le={},le[1]=function(z,j){return"M1,"+(.5-j)+" L"+(.5+z)+","+(.5-j)+" L"+(.5+z)+",0 M1,"+(.5+j)+" L"+(.5-z)+","+(.5+j)+" L"+(.5-z)+",0"},le),"â":(K={},K[1]=function(z,j){return"M0,"+(.5+j)+" L.5,"+(.5+j)+" L.5,0 M0,"+(.5-j)+" L.5,"+(.5-j)},K),"â":(F={},F[1]=function(z,j){return"M0,.5 L"+(.5+z)+",.5 L"+(.5+z)+",0 M"+(.5-z)+",.5 L"+(.5-z)+",0"},F),"â":(U={},U[1]=function(z,j){return"M0,"+(.5-j)+" L"+(.5-z)+","+(.5-j)+" L"+(.5-z)+",0 M0,"+(.5+j)+" L"+(.5+z)+","+(.5+j)+" L"+(.5+z)+",0"},U),"â":(W={},W[1]=function(z,j){return"M.5,0 L.5,1 M.5,"+(.5-j)+" L1,"+(.5-j)+" M.5,"+(.5+j)+" L1,"+(.5+j)},W),"â":(ae={},ae[1]=function(z,j){return"M"+(.5-z)+",0 L"+(.5-z)+",1 M"+(.5+z)+",0 L"+(.5+z)+",1 M"+(.5+z)+",.5 L1,.5"},ae),"â ":(he={},he[1]=function(z,j){return"M"+(.5-z)+",0 L"+(.5-z)+",1 M1,"+(.5+j)+" L"+(.5+z)+","+(.5+j)+" L"+(.5+z)+",1 M1,"+(.5-j)+" L"+(.5+z)+","+(.5-j)+" L"+(.5+z)+",0"},he),"â¡":(me={},me[1]=function(z,j){return"M.5,0 L.5,1 M0,"+(.5-j)+" L.5,"+(.5-j)+" M0,"+(.5+j)+" L.5,"+(.5+j)},me),"â¢":(De={},De[1]=function(z,j){return"M0,.5 L"+(.5-z)+",.5 M"+(.5-z)+",0 L"+(.5-z)+",1 M"+(.5+z)+",0 L"+(.5+z)+",1"},De),"â£":(He={},He[1]=function(z,j){return"M"+(.5+z)+",0 L"+(.5+z)+",1 M0,"+(.5+j)+" L"+(.5-z)+","+(.5+j)+" L"+(.5-z)+",1 M0,"+(.5-j)+" L"+(.5-z)+","+(.5-j)+" L"+(.5-z)+",0"},He),"â¤":(Ne={},Ne[1]=function(z,j){return"M0,"+(.5-j)+" L1,"+(.5-j)+" M0,"+(.5+j)+" L1,"+(.5+j)+" M.5,"+(.5+j)+" L.5,1"},Ne),"â¥":(re={},re[1]=function(z,j){return"M0,.5 L1,.5 M"+(.5-z)+",.5 L"+(.5-z)+",1 M"+(.5+z)+",.5 L"+(.5+z)+",1"},re),"â¦":(ze={},ze[1]=function(z,j){return"M0,"+(.5-j)+" L1,"+(.5-j)+" M0,"+(.5+j)+" L"+(.5-z)+","+(.5+j)+" L"+(.5-z)+",1 M1,"+(.5+j)+" L"+(.5+z)+","+(.5+j)+" L"+(.5+z)+",1"},ze),"â§":(et={},et[1]=function(z,j){return"M.5,0 L.5,"+(.5-j)+" M0,"+(.5-j)+" L1,"+(.5-j)+" M0,"+(.5+j)+" L1,"+(.5+j)},et),"â¨":(bt={},bt[1]=function(z,j){return"M0,.5 L1,.5 M"+(.5-z)+",.5 L"+(.5-z)+",0 M"+(.5+z)+",.5 L"+(.5+z)+",0"},bt),"â©":(ni={},ni[1]=function(z,j){return"M0,"+(.5+j)+" L1,"+(.5+j)+" M0,"+(.5-j)+" L"+(.5-z)+","+(.5-j)+" L"+(.5-z)+",0 M1,"+(.5-j)+" L"+(.5+z)+","+(.5-j)+" L"+(.5+z)+",0"},ni),"âª":(rs={},rs[1]=function(z,j){return"M.5,0 L.5,1 M0,"+(.5-j)+" L1,"+(.5-j)+" M0,"+(.5+j)+" L1,"+(.5+j)},rs),"â«":(ss={},ss[1]=function(z,j){return"M0,.5 L1,.5 M"+(.5-z)+",0 L"+(.5-z)+",1 M"+(.5+z)+",0 L"+(.5+z)+",1"},ss),"â¬":(ns={},ns[1]=function(z,j){return"M0,"+(.5+j)+" L"+(.5-z)+","+(.5+j)+" L"+(.5-z)+",1 M1,"+(.5+j)+" L"+(.5+z)+","+(.5+j)+" L"+(.5+z)+",1 M0,"+(.5-j)+" L"+(.5-z)+","+(.5-j)+" L"+(.5-z)+",0 M1,"+(.5-j)+" L"+(.5+z)+","+(.5-j)+" L"+(.5+z)+",0"},ns),"â±":(os={},os[1]="M1,0 L0,1",os),"â²":(as={},as[1]="M0,0 L1,1",as),"â³":(hs={},hs[1]="M1,0 L0,1 M0,0 L1,1",hs),"â¼":(Fi={},Fi[1]="M.5,.5 L0,.5",Fi[3]="M.5,.5 L1,.5",Fi),"â½":(Ui={},Ui[1]="M.5,.5 L.5,0",Ui[3]="M.5,.5 L.5,1",Ui),"â¾":(Hi={},Hi[1]="M.5,.5 L1,.5",Hi[3]="M.5,.5 L0,.5",Hi),"â¿":(Ni={},Ni[1]="M.5,.5 L.5,1",Ni[3]="M.5,.5 L.5,0",Ni),"â":(zi={},zi[1]="M.5,.5 L.5,1",zi[3]="M.5,.5 L1,.5",zi),"â":(ji={},ji[1]="M.5,.5 L1,.5",ji[3]="M.5,.5 L.5,1",ji),"â":(Wi={},Wi[1]="M.5,.5 L.5,1",Wi[3]="M.5,.5 L0,.5",Wi),"â":(Gi={},Gi[1]="M.5,.5 L0,.5",Gi[3]="M.5,.5 L.5,1",Gi),"â":(Ki={},Ki[1]="M.5,.5 L.5,0",Ki[3]="M.5,.5 L1,.5",Ki),"â":(Vi={},Vi[1]="M.5,.5 L1,.5",Vi[3]="M.5,.5 L.5,0",Vi),"â":(Xi={},Xi[1]="M.5,.5 L.5,0",Xi[3]="M.5,.5 L0,.5",Xi),"â":(Yi={},Yi[1]="M.5,.5 L0,.5",Yi[3]="M.5,.5 L.5,0",Yi),"â":(Zi={},Zi[1]="M.5,0 L.5,1",Zi[3]="M.5,.5 L1,.5",Zi),"â":(Ji={},Ji[1]="M0.5,1 L.5,.5 L1,.5",Ji[3]="M.5,.5 L.5,0",Ji),"â":(Qi={},Qi[1]="M.5,0 L.5,.5 L1,.5",Qi[3]="M.5,.5 L.5,1",Qi),"â ":($i={},$i[1]="M.5,.5 L1,.5",$i[3]="M.5,0 L.5,1",$i),"â¡":(er={},er[1]="M.5,.5 L.5,1",er[3]="M.5,0 L.5,.5 L1,.5",er),"â¢":(tr={},tr[1]="M.5,.5 L.5,0",tr[3]="M0.5,1 L.5,.5 L1,.5",tr),"â¥":(ir={},ir[1]="M.5,0 L.5,1",ir[3]="M.5,.5 L0,.5",ir),"â¦":(rr={},rr[1]="M0,.5 L.5,.5 L.5,1",rr[3]="M.5,.5 L.5,0",rr),"â§":(sr={},sr[1]="M.5,0 L.5,.5 L0,.5",sr[3]="M.5,.5 L.5,1",sr),"â¨":(nr={},nr[1]="M.5,.5 L0,.5",nr[3]="M.5,0 L.5,1",nr),"â©":(or={},or[1]="M.5,.5 L.5,1",or[3]="M.5,0 L.5,.5 L0,.5",or),"âª":(ar={},ar[1]="M.5,.5 L.5,0",ar[3]="M0,.5 L.5,.5 L.5,1",ar),"â­":(hr={},hr[1]="M0.5,1 L.5,.5 L1,.5",hr[3]="M.5,.5 L0,.5",hr),"â®":(cr={},cr[1]="M0,.5 L.5,.5 L.5,1",cr[3]="M.5,.5 L1,.5",cr),"â¯":(_r={},_r[1]="M.5,.5 L.5,1",_r[3]="M0,.5 L1,.5",_r),"â°":(lr={},lr[1]="M0,.5 L1,.5",lr[3]="M.5,.5 L.5,1",lr),"â±":(ur={},ur[1]="M.5,.5 L1,.5",ur[3]="M0,.5 L.5,.5 L.5,1",ur),"â²":(dr={},dr[1]="M.5,.5 L0,.5",dr[3]="M0.5,1 L.5,.5 L1,.5",dr),"âµ":(fr={},fr[1]="M.5,0 L.5,.5 L1,.5",fr[3]="M.5,.5 L0,.5",fr),"â¶":(pr={},pr[1]="M.5,0 L.5,.5 L0,.5",pr[3]="M.5,.5 L1,.5",pr),"â·":(vr={},vr[1]="M.5,.5 L.5,0",vr[3]="M0,.5 L1,.5",vr),"â¸":(mr={},mr[1]="M0,.5 L1,.5",mr[3]="M.5,.5 L.5,0",mr),"â¹":(gr={},gr[1]="M.5,.5 L1,.5",gr[3]="M.5,0 L.5,.5 L0,.5",gr),"âº":(yr={},yr[1]="M.5,.5 L0,.5",yr[3]="M.5,0 L.5,.5 L1,.5",yr),"â½":(br={},br[1]="M.5,0 L.5,1 M.5,.5 L1,.5",br[3]="M.5,.5 L0,.5",br),"â¾":(wr={},wr[1]="M.5,0 L.5,1 M.5,.5 L0,.5",wr[3]="M.5,.5 L1,.5",wr),"â¿":(Sr={},Sr[1]="M.5,0 L.5,1",Sr[3]="M0,.5 L1,.5",Sr),"â":(Cr={},Cr[1]="M0,.5 L1,.5 M.5,.5 L.5,1",Cr[3]="M.5,.5 L.5,0",Cr),"â":(Er={},Er[1]="M.5,.5 L.5,0 M0,.5 L1,.5",Er[3]="M.5,.5 L.5,1",Er),"â":(xr={},xr[1]="M0,.5 L1,.5",xr[3]="M.5,0 L.5,1",xr),"â":(kr={},kr[1]="M0.5,1 L.5,.5 L1,.5",kr[3]="M.5,0 L.5,.5 L0,.5",kr),"â":(Ar={},Ar[1]="M0,.5 L.5,.5 L.5,1",Ar[3]="M.5,0 L.5,.5 L1,.5",Ar),"â":(Lr={},Lr[1]="M.5,0 L.5,.5 L1,.5",Lr[3]="M0,.5 L.5,.5 L.5,1",Lr),"â":(Rr={},Rr[1]="M.5,0 L.5,.5 L0,.5",Rr[3]="M0.5,1 L.5,.5 L1,.5",Rr),"â":(Or={},Or[1]="M.5,.5 L.5,1",Or[3]="M.5,.5 L.5,0 M0,.5 L1,.5",Or),"â":(Tr={},Tr[1]="M.5,.5 L.5,0",Tr[3]="M0,.5 L1,.5 M.5,.5 L.5,1",Tr),"â":(Mr={},Mr[1]="M.5,.5 L1,.5",Mr[3]="M.5,0 L.5,1 M.5,.5 L0,.5",Mr),"â":(Dr={},Dr[1]="M.5,.5 L0,.5",Dr[3]="M.5,0 L.5,1 M.5,.5 L1,.5",Dr),"â":(cs={},cs[1]="M.1,.5 L.4,.5 M.6,.5 L.9,.5",cs),"â":(_s={},_s[3]="M.1,.5 L.4,.5 M.6,.5 L.9,.5",_s),"â":(ls={},ls[1]="M.0667,.5 L.2667,.5 M.4,.5 L.6,.5 M.7333,.5 L.9333,.5",ls),"â":(us={},us[3]="M.0667,.5 L.2667,.5 M.4,.5 L.6,.5 M.7333,.5 L.9333,.5",us),"â":(ds={},ds[1]="M.05,.5 L.2,.5 M.3,.5 L.45,.5 M.55,.5 L.7,.5 M.8,.5 L.95,.5",ds),"â":(fs={},fs[3]="M.05,.5 L.2,.5 M.3,.5 L.45,.5 M.55,.5 L.7,.5 M.8,.5 L.95,.5",fs),"â":(ps={},ps[1]="M.5,.1 L.5,.4 M.5,.6 L.5,.9",ps),"â":(vs={},vs[3]="M.5,.1 L.5,.4 M.5,.6 L.5,.9",vs),"â":(ms={},ms[1]="M.5,.0667 L.5,.2667 M.5,.4 L.5,.6 M.5,.7333 L.5,.9333",ms),"â":(gs={},gs[3]="M.5,.0667 L.5,.2667 M.5,.4 L.5,.6 M.5,.7333 L.5,.9333",gs),"â":(ys={},ys[1]="M.5,.05 L.5,.2 M.5,.3 L.5,.45 L.5,.55 M.5,.7 L.5,.95",ys),"â":(bs={},bs[3]="M.5,.05 L.5,.2 M.5,.3 L.5,.45 L.5,.55 M.5,.7 L.5,.95",bs),"â­":(ws={},ws[1]="C.5,1,.5,.5,1,.5",ws),"â®":(Ss={},Ss[1]="C.5,1,.5,.5,0,.5",Ss),"â¯":(Cs={},Cs[1]="C.5,0,.5,.5,0,.5",Cs),"â°":(Es={},Es[1]="C.5,0,.5,.5,1,.5",Es)},r.powerlineDefinitions={"î°":{d:"M0,0 L1,.5 L0,1",type:0},"î±":{d:"M0,0 L1,.5 L0,1",type:1,horizontalPadding:.5},"î²":{d:"M1,0 L0,.5 L1,1",type:0},"î³":{d:"M1,0 L0,.5 L1,1",type:1,horizontalPadding:.5}},r.tryDrawCustomChar=function(z,j,qe,tt,wt,at){var Ie=r.blockElementDefinitions[j];if(Ie)return function(Te,it,Yt,Zt,Ft,Ut){for(var je=0;je<it.length;je++){var We=it[je],Ee=Ft/8,Ge=Ut/8;Te.fillRect(Yt+We.x*Ee,Zt+We.y*Ge,We.w*Ee,We.h*Ge)}}(z,Ie,qe,tt,wt,at),!0;var ct=jo[j];if(ct)return function(Te,it,Yt,Zt,Ft,Ut){var je,We=hn.get(it);We||(We=new Map,hn.set(it,We));var Ee=Te.fillStyle;if(typeof Ee!="string")throw new Error('Unexpected fillStyle type "'+Ee+'"');var Ge=We.get(Ee);if(!Ge){var Ye=it[0].length,_t=it.length,Ct=document.createElement("canvas");Ct.width=Ye,Ct.height=_t;var Jt=(0,an.throwIfFalsy)(Ct.getContext("2d")),dt=new ImageData(Ye,_t),oi=void 0,Ht=void 0,Ot=void 0,ai=void 0;if(Ee.startsWith("#"))oi=parseInt(Ee.slice(1,3),16),Ht=parseInt(Ee.slice(3,5),16),Ot=parseInt(Ee.slice(5,7),16),ai=Ee.length>7&&parseInt(Ee.slice(7,9),16)||1;else{if(!Ee.startsWith("rgba"))throw new Error('Unexpected fillStyle color format "'+Ee+'" when drawing pattern glyph');oi=(je=on(Ee.substring(5,Ee.length-1).split(",").map(function(Si){return parseFloat(Si)}),4))[0],Ht=je[1],Ot=je[2],ai=je[3]}for(var Et=0;Et<_t;Et++)for(var xt=0;xt<Ye;xt++)dt.data[4*(Et*Ye+xt)]=oi,dt.data[4*(Et*Ye+xt)+1]=Ht,dt.data[4*(Et*Ye+xt)+2]=Ot,dt.data[4*(Et*Ye+xt)+3]=it[Et][xt]*(255*ai);Jt.putImageData(dt,0,0),Ge=(0,an.throwIfFalsy)(Te.createPattern(Ct,null)),We.set(Ee,Ge)}Te.fillStyle=Ge,Te.fillRect(Yt,Zt,Ft,Ut)}(z,ct,qe,tt,wt,at),!0;var St=r.boxDrawingDefinitions[j];if(St)return function(Te,it,Yt,Zt,Ft,Ut){var je,We,Ee,Ge;Te.strokeStyle=Te.fillStyle;try{for(var Ye=xs(Object.entries(it)),_t=Ye.next();!_t.done;_t=Ye.next()){var Ct=on(_t.value,2),Jt=Ct[0],dt=Ct[1];Te.beginPath(),Te.lineWidth=window.devicePixelRatio*Number.parseInt(Jt);var oi=void 0;oi=typeof dt=="function"?dt(.15,.15/Ut*Ft):dt;try{for(var Ht=(Ee=void 0,xs(oi.split(" "))),Ot=Ht.next();!Ot.done;Ot=Ht.next()){var ai=Ot.value,Et=ai[0],xt=_n[Et];if(xt){var Si=ai.substring(1).split(",");Si[0]&&Si[1]&&xt(Te,ln(Si,Ft,Ut,Yt,Zt))}else console.error('Could not find drawing instructions for "'+Et+'"')}}catch(ks){Ee={error:ks}}finally{try{Ot&&!Ot.done&&(Ge=Ht.return)&&Ge.call(Ht)}finally{if(Ee)throw Ee.error}}Te.stroke(),Te.closePath()}}catch(ks){je={error:ks}}finally{try{_t&&!_t.done&&(We=Ye.return)&&We.call(Ye)}finally{if(je)throw je.error}}}(z,St,qe,tt,wt,at),!0;var wi=r.powerlineDefinitions[j];return!!wi&&(function(Te,it,Yt,Zt,Ft,Ut){var je,We;Te.beginPath(),Te.lineWidth=window.devicePixelRatio;try{for(var Ee=xs(it.d.split(" ")),Ge=Ee.next();!Ge.done;Ge=Ee.next()){var Ye=Ge.value,_t=Ye[0],Ct=_n[_t];if(Ct){var Jt=Ye.substring(1).split(",");Jt[0]&&Jt[1]&&Ct(Te,ln(Jt,Ft,Ut,Yt,Zt,it.horizontalPadding))}else console.error('Could not find drawing instructions for "'+_t+'"')}}catch(dt){je={error:dt}}finally{try{Ge&&!Ge.done&&(We=Ee.return)&&We.call(Ee)}finally{if(je)throw je.error}}it.type===1?(Te.strokeStyle=Te.fillStyle,Te.stroke()):Te.fill(),Te.closePath()}(z,wi,qe,tt,wt,at),!0)};var hn=new Map;function cn(z,j,qe){return qe===void 0&&(qe=0),Math.max(Math.min(z,j),qe)}var _n={C:function(z,j){return z.bezierCurveTo(j[0],j[1],j[2],j[3],j[4],j[5])},L:function(z,j){return z.lineTo(j[0],j[1])},M:function(z,j){return z.moveTo(j[0],j[1])}};function ln(z,j,qe,tt,wt,at){at===void 0&&(at=0);var Ie=z.map(function(wi){return parseFloat(wi)||parseInt(wi)});if(Ie.length<2)throw new Error("Too few arguments for instruction");for(var ct=0;ct<Ie.length;ct+=2)Ie[ct]*=j-2*at*window.devicePixelRatio,Ie[ct]!==0&&(Ie[ct]=cn(Math.round(Ie[ct]+.5)-.5,j,0)),Ie[ct]+=tt+at*window.devicePixelRatio;for(var St=1;St<Ie.length;St+=2)Ie[St]*=qe,Ie[St]!==0&&(Ie[St]=cn(Math.round(Ie[St]+.5)-.5,qe,0)),Ie[St]+=wt;return Ie}},3700:(a,r)=>{Object.defineProperty(r,"__esModule",{value:!0}),r.GridCache=void 0;var u=function(){function o(){this.cache=[]}return o.prototype.resize=function(l,f){for(var m=0;m<l;m++){this.cache.length<=m&&this.cache.push([]);for(var C=this.cache[m].length;C<f;C++)this.cache[m].push(void 0);this.cache[m].length=f}this.cache.length=l},o.prototype.clear=function(){for(var l=0;l<this.cache.length;l++)for(var f=0;f<this.cache[l].length;f++)this.cache[l][f]=void 0},o}();r.GridCache=u},5098:function(a,r,u){var o,l=this&&this.__extends||(o=function(y,c){return o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(n,h){n.__proto__=h}||function(n,h){for(var _ in h)Object.prototype.hasOwnProperty.call(h,_)&&(n[_]=h[_])},o(y,c)},function(y,c){if(typeof c!="function"&&c!==null)throw new TypeError("Class extends value "+String(c)+" is not a constructor or null");function n(){this.constructor=y}o(y,c),y.prototype=c===null?Object.create(c):(n.prototype=c.prototype,new n)}),f=this&&this.__decorate||function(y,c,n,h){var _,d=arguments.length,b=d<3?c:h===null?h=Object.getOwnPropertyDescriptor(c,n):h;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")b=Reflect.decorate(y,c,n,h);else for(var g=y.length-1;g>=0;g--)(_=y[g])&&(b=(d<3?_(b):d>3?_(c,n,b):_(c,n))||b);return d>3&&b&&Object.defineProperty(c,n,b),b},m=this&&this.__param||function(y,c){return function(n,h){c(n,h,y)}};Object.defineProperty(r,"__esModule",{value:!0}),r.LinkRenderLayer=void 0;var C=u(1546),S=u(8803),p=u(2040),v=u(2585),w=function(y){function c(n,h,_,d,b,g,A,R,x){var k=y.call(this,n,"link",h,!0,_,d,A,R,x)||this;return b.onShowLinkUnderline(function(O){return k._onShowLinkUnderline(O)}),b.onHideLinkUnderline(function(O){return k._onHideLinkUnderline(O)}),g.onShowLinkUnderline(function(O){return k._onShowLinkUnderline(O)}),g.onHideLinkUnderline(function(O){return k._onHideLinkUnderline(O)}),k}return l(c,y),c.prototype.resize=function(n){y.prototype.resize.call(this,n),this._state=void 0},c.prototype.reset=function(){this._clearCurrentLink()},c.prototype._clearCurrentLink=function(){if(this._state){this._clearCells(this._state.x1,this._state.y1,this._state.cols-this._state.x1,1);var n=this._state.y2-this._state.y1-1;n>0&&this._clearCells(0,this._state.y1+1,this._state.cols,n),this._clearCells(0,this._state.y2,this._state.x2,1),this._state=void 0}},c.prototype._onShowLinkUnderline=function(n){if(n.fg===S.INVERTED_DEFAULT_COLOR?this._ctx.fillStyle=this._colors.background.css:n.fg&&(0,p.is256Color)(n.fg)?this._ctx.fillStyle=this._colors.ansi[n.fg].css:this._ctx.fillStyle=this._colors.foreground.css,n.y1===n.y2)this._fillBottomLineAtCells(n.x1,n.y1,n.x2-n.x1);else{this._fillBottomLineAtCells(n.x1,n.y1,n.cols-n.x1);for(var h=n.y1+1;h<n.y2;h++)this._fillBottomLineAtCells(0,h,n.cols);this._fillBottomLineAtCells(0,n.y2,n.x2)}this._state=n},c.prototype._onHideLinkUnderline=function(n){this._clearCurrentLink()},f([m(6,v.IBufferService),m(7,v.IOptionsService),m(8,v.IDecorationService)],c)}(C.BaseRenderLayer);r.LinkRenderLayer=w},3525:function(a,r,u){var o,l=this&&this.__extends||(o=function(g,A){return o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(R,x){R.__proto__=x}||function(R,x){for(var k in x)Object.prototype.hasOwnProperty.call(x,k)&&(R[k]=x[k])},o(g,A)},function(g,A){if(typeof A!="function"&&A!==null)throw new TypeError("Class extends value "+String(A)+" is not a constructor or null");function R(){this.constructor=g}o(g,A),g.prototype=A===null?Object.create(A):(R.prototype=A.prototype,new R)}),f=this&&this.__decorate||function(g,A,R,x){var k,O=arguments.length,I=O<3?A:x===null?x=Object.getOwnPropertyDescriptor(A,R):x;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")I=Reflect.decorate(g,A,R,x);else for(var T=g.length-1;T>=0;T--)(k=g[T])&&(I=(O<3?k(I):O>3?k(A,R,I):k(A,R))||I);return O>3&&I&&Object.defineProperty(A,R,I),I},m=this&&this.__param||function(g,A){return function(R,x){A(R,x,g)}},C=this&&this.__values||function(g){var A=typeof Symbol=="function"&&Symbol.iterator,R=A&&g[A],x=0;if(R)return R.call(g);if(g&&typeof g.length=="number")return{next:function(){return g&&x>=g.length&&(g=void 0),{value:g&&g[x++],done:!g}}};throw new TypeError(A?"Object is not iterable.":"Symbol.iterator is not defined.")};Object.defineProperty(r,"__esModule",{value:!0}),r.Renderer=void 0;var S=u(9596),p=u(4149),v=u(2512),w=u(5098),y=u(844),c=u(4725),n=u(2585),h=u(1420),_=u(8460),d=1,b=function(g){function A(R,x,k,O,I,T,P,M){var D=g.call(this)||this;D._colors=R,D._screenElement=x,D._bufferService=T,D._charSizeService=P,D._optionsService=M,D._id=d++,D._onRequestRedraw=new _.EventEmitter;var q=D._optionsService.rawOptions.allowTransparency;return D._renderLayers=[I.createInstance(S.TextRenderLayer,D._screenElement,0,D._colors,q,D._id),I.createInstance(p.SelectionRenderLayer,D._screenElement,1,D._colors,D._id),I.createInstance(w.LinkRenderLayer,D._screenElement,2,D._colors,D._id,k,O),I.createInstance(v.CursorRenderLayer,D._screenElement,3,D._colors,D._id,D._onRequestRedraw)],D.dimensions={scaledCharWidth:0,scaledCharHeight:0,scaledCellWidth:0,scaledCellHeight:0,scaledCharLeft:0,scaledCharTop:0,scaledCanvasWidth:0,scaledCanvasHeight:0,canvasWidth:0,canvasHeight:0,actualCellWidth:0,actualCellHeight:0},D._devicePixelRatio=window.devicePixelRatio,D._updateDimensions(),D.onOptionsChanged(),D}return l(A,g),Object.defineProperty(A.prototype,"onRequestRedraw",{get:function(){return this._onRequestRedraw.event},enumerable:!1,configurable:!0}),A.prototype.dispose=function(){var R,x;try{for(var k=C(this._renderLayers),O=k.next();!O.done;O=k.next())O.value.dispose()}catch(I){R={error:I}}finally{try{O&&!O.done&&(x=k.return)&&x.call(k)}finally{if(R)throw R.error}}g.prototype.dispose.call(this),(0,h.removeTerminalFromCache)(this._id)},A.prototype.onDevicePixelRatioChange=function(){this._devicePixelRatio!==window.devicePixelRatio&&(this._devicePixelRatio=window.devicePixelRatio,this.onResize(this._bufferService.cols,this._bufferService.rows))},A.prototype.setColors=function(R){var x,k;this._colors=R;try{for(var O=C(this._renderLayers),I=O.next();!I.done;I=O.next()){var T=I.value;T.setColors(this._colors),T.reset()}}catch(P){x={error:P}}finally{try{I&&!I.done&&(k=O.return)&&k.call(O)}finally{if(x)throw x.error}}},A.prototype.onResize=function(R,x){var k,O;this._updateDimensions();try{for(var I=C(this._renderLayers),T=I.next();!T.done;T=I.next())T.value.resize(this.dimensions)}catch(P){k={error:P}}finally{try{T&&!T.done&&(O=I.return)&&O.call(I)}finally{if(k)throw k.error}}this._screenElement.style.width=this.dimensions.canvasWidth+"px",this._screenElement.style.height=this.dimensions.canvasHeight+"px"},A.prototype.onCharSizeChanged=function(){this.onResize(this._bufferService.cols,this._bufferService.rows)},A.prototype.onBlur=function(){this._runOperation(function(R){return R.onBlur()})},A.prototype.onFocus=function(){this._runOperation(function(R){return R.onFocus()})},A.prototype.onSelectionChanged=function(R,x,k){k===void 0&&(k=!1),this._runOperation(function(O){return O.onSelectionChanged(R,x,k)}),this._colors.selectionForeground&&this._onRequestRedraw.fire({start:0,end:this._bufferService.rows-1})},A.prototype.onCursorMove=function(){this._runOperation(function(R){return R.onCursorMove()})},A.prototype.onOptionsChanged=function(){this._runOperation(function(R){return R.onOptionsChanged()})},A.prototype.clear=function(){this._runOperation(function(R){return R.reset()})},A.prototype._runOperation=function(R){var x,k;try{for(var O=C(this._renderLayers),I=O.next();!I.done;I=O.next())R(I.value)}catch(T){x={error:T}}finally{try{I&&!I.done&&(k=O.return)&&k.call(O)}finally{if(x)throw x.error}}},A.prototype.renderRows=function(R,x){var k,O;try{for(var I=C(this._renderLayers),T=I.next();!T.done;T=I.next())T.value.onGridChanged(R,x)}catch(P){k={error:P}}finally{try{T&&!T.done&&(O=I.return)&&O.call(I)}finally{if(k)throw k.error}}},A.prototype.clearTextureAtlas=function(){var R,x;try{for(var k=C(this._renderLayers),O=k.next();!O.done;O=k.next())O.value.clearTextureAtlas()}catch(I){R={error:I}}finally{try{O&&!O.done&&(x=k.return)&&x.call(k)}finally{if(R)throw R.error}}},A.prototype._updateDimensions=function(){this._charSizeService.hasValidSize&&(this.dimensions.scaledCharWidth=Math.floor(this._charSizeService.width*window.devicePixelRatio),this.dimensions.scaledCharHeight=Math.ceil(this._charSizeService.height*window.devicePixelRatio),this.dimensions.scaledCellHeight=Math.floor(this.dimensions.scaledCharHeight*this._optionsService.rawOptions.lineHeight),this.dimensions.scaledCharTop=this._optionsService.rawOptions.lineHeight===1?0:Math.round((this.dimensions.scaledCellHeight-this.dimensions.scaledCharHeight)/2),this.dimensions.scaledCellWidth=this.dimensions.scaledCharWidth+Math.round(this._optionsService.rawOptions.letterSpacing),this.dimensions.scaledCharLeft=Math.floor(this._optionsService.rawOptions.letterSpacing/2),this.dimensions.scaledCanvasHeight=this._bufferService.rows*this.dimensions.scaledCellHeight,this.dimensions.scaledCanvasWidth=this._bufferService.cols*this.dimensions.scaledCellWidth,this.dimensions.canvasHeight=Math.round(this.dimensions.scaledCanvasHeight/window.devicePixelRatio),this.dimensions.canvasWidth=Math.round(this.dimensions.scaledCanvasWidth/window.devicePixelRatio),this.dimensions.actualCellHeight=this.dimensions.canvasHeight/this._bufferService.rows,this.dimensions.actualCellWidth=this.dimensions.canvasWidth/this._bufferService.cols)},f([m(4,n.IInstantiationService),m(5,n.IBufferService),m(6,c.ICharSizeService),m(7,n.IOptionsService)],A)}(y.Disposable);r.Renderer=b},1752:(a,r)=>{function u(o){return 57508<=o&&o<=57558}Object.defineProperty(r,"__esModule",{value:!0}),r.excludeFromContrastRatioDemands=r.isPowerlineGlyph=r.throwIfFalsy=void 0,r.throwIfFalsy=function(o){if(!o)throw new Error("value must not be falsy");return o},r.isPowerlineGlyph=u,r.excludeFromContrastRatioDemands=function(o){return u(o)||function(l){return 9472<=l&&l<=9631}(o)}},4149:function(a,r,u){var o,l=this&&this.__extends||(o=function(v,w){return o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(y,c){y.__proto__=c}||function(y,c){for(var n in c)Object.prototype.hasOwnProperty.call(c,n)&&(y[n]=c[n])},o(v,w)},function(v,w){if(typeof w!="function"&&w!==null)throw new TypeError("Class extends value "+String(w)+" is not a constructor or null");function y(){this.constructor=v}o(v,w),v.prototype=w===null?Object.create(w):(y.prototype=w.prototype,new y)}),f=this&&this.__decorate||function(v,w,y,c){var n,h=arguments.length,_=h<3?w:c===null?c=Object.getOwnPropertyDescriptor(w,y):c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")_=Reflect.decorate(v,w,y,c);else for(var d=v.length-1;d>=0;d--)(n=v[d])&&(_=(h<3?n(_):h>3?n(w,y,_):n(w,y))||_);return h>3&&_&&Object.defineProperty(w,y,_),_},m=this&&this.__param||function(v,w){return function(y,c){w(y,c,v)}};Object.defineProperty(r,"__esModule",{value:!0}),r.SelectionRenderLayer=void 0;var C=u(1546),S=u(2585),p=function(v){function w(y,c,n,h,_,d,b){var g=v.call(this,y,"selection",c,!0,n,h,_,d,b)||this;return g._clearState(),g}return l(w,v),w.prototype._clearState=function(){this._state={start:void 0,end:void 0,columnSelectMode:void 0,ydisp:void 0}},w.prototype.resize=function(y){v.prototype.resize.call(this,y),this._clearState()},w.prototype.reset=function(){this._state.start&&this._state.end&&(this._clearState(),this._clearAll())},w.prototype.onSelectionChanged=function(y,c,n){if(v.prototype.onSelectionChanged.call(this,y,c,n),this._didStateChange(y,c,n,this._bufferService.buffer.ydisp))if(this._clearAll(),y&&c){var h=y[1]-this._bufferService.buffer.ydisp,_=c[1]-this._bufferService.buffer.ydisp,d=Math.max(h,0),b=Math.min(_,this._bufferService.rows-1);if(d>=this._bufferService.rows||b<0)this._state.ydisp=this._bufferService.buffer.ydisp;else{if(this._ctx.fillStyle=this._colors.selectionTransparent.css,n){var g=y[0],A=c[0]-g,R=b-d+1;this._fillCells(g,d,A,R)}else{g=h===d?y[0]:0;var x=d===_?c[0]:this._bufferService.cols;this._fillCells(g,d,x-g,1);var k=Math.max(b-d-1,0);if(this._fillCells(0,d+1,this._bufferService.cols,k),d!==b){var O=_===b?c[0]:this._bufferService.cols;this._fillCells(0,b,O,1)}}this._state.start=[y[0],y[1]],this._state.end=[c[0],c[1]],this._state.columnSelectMode=n,this._state.ydisp=this._bufferService.buffer.ydisp}}else this._clearState()},w.prototype._didStateChange=function(y,c,n,h){return!this._areCoordinatesEqual(y,this._state.start)||!this._areCoordinatesEqual(c,this._state.end)||n!==this._state.columnSelectMode||h!==this._state.ydisp},w.prototype._areCoordinatesEqual=function(y,c){return!(!y||!c)&&y[0]===c[0]&&y[1]===c[1]},f([m(4,S.IBufferService),m(5,S.IOptionsService),m(6,S.IDecorationService)],w)}(C.BaseRenderLayer);r.SelectionRenderLayer=p},9596:function(a,r,u){var o,l=this&&this.__extends||(o=function(d,b){return o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(g,A){g.__proto__=A}||function(g,A){for(var R in A)Object.prototype.hasOwnProperty.call(A,R)&&(g[R]=A[R])},o(d,b)},function(d,b){if(typeof b!="function"&&b!==null)throw new TypeError("Class extends value "+String(b)+" is not a constructor or null");function g(){this.constructor=d}o(d,b),d.prototype=b===null?Object.create(b):(g.prototype=b.prototype,new g)}),f=this&&this.__decorate||function(d,b,g,A){var R,x=arguments.length,k=x<3?b:A===null?A=Object.getOwnPropertyDescriptor(b,g):A;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")k=Reflect.decorate(d,b,g,A);else for(var O=d.length-1;O>=0;O--)(R=d[O])&&(k=(x<3?R(k):x>3?R(b,g,k):R(b,g))||k);return x>3&&k&&Object.defineProperty(b,g,k),k},m=this&&this.__param||function(d,b){return function(g,A){b(g,A,d)}},C=this&&this.__values||function(d){var b=typeof Symbol=="function"&&Symbol.iterator,g=b&&d[b],A=0;if(g)return g.call(d);if(d&&typeof d.length=="number")return{next:function(){return d&&A>=d.length&&(d=void 0),{value:d&&d[A++],done:!d}}};throw new TypeError(b?"Object is not iterable.":"Symbol.iterator is not defined.")};Object.defineProperty(r,"__esModule",{value:!0}),r.TextRenderLayer=void 0;var S=u(3700),p=u(1546),v=u(3734),w=u(643),y=u(511),c=u(2585),n=u(4725),h=u(4269),_=function(d){function b(g,A,R,x,k,O,I,T,P){var M=d.call(this,g,"text",A,x,R,k,O,I,P)||this;return M._characterJoinerService=T,M._characterWidth=0,M._characterFont="",M._characterOverlapCache={},M._workCell=new y.CellData,M._state=new S.GridCache,M}return l(b,d),b.prototype.resize=function(g){d.prototype.resize.call(this,g);var A=this._getFont(!1,!1);this._characterWidth===g.scaledCharWidth&&this._characterFont===A||(this._characterWidth=g.scaledCharWidth,this._characterFont=A,this._characterOverlapCache={}),this._state.clear(),this._state.resize(this._bufferService.cols,this._bufferService.rows)},b.prototype.reset=function(){this._state.clear(),this._clearAll()},b.prototype._forEachCell=function(g,A,R){for(var x=g;x<=A;x++)for(var k=x+this._bufferService.buffer.ydisp,O=this._bufferService.buffer.lines.get(k),I=this._characterJoinerService.getJoinedCharacters(k),T=0;T<this._bufferService.cols;T++){O.loadCell(T,this._workCell);var P=this._workCell,M=!1,D=T;if(P.getWidth()!==0){if(I.length>0&&T===I[0][0]){M=!0;var q=I.shift();P=new h.JoinedCellData(this._workCell,O.translateToString(!0,q[0],q[1]),q[1]-q[0]),D=q[1]-1}!M&&this._isOverlapping(P)&&D<O.length-1&&O.getCodePoint(D+1)===w.NULL_CELL_CODE&&(P.content&=-12582913,P.content|=2<<22),R(P,T,x),T=D}}},b.prototype._drawBackground=function(g,A){var R=this,x=this._ctx,k=this._bufferService.cols,O=0,I=0,T=null;x.save(),this._forEachCell(g,A,function(P,M,D){var q,H,X=null;P.isInverse()?X=P.isFgDefault()?R._colors.foreground.css:P.isFgRGB()?"rgb("+v.AttributeData.toColorRGB(P.getFgColor()).join(",")+")":R._colors.ansi[P.getFgColor()].css:P.isBgRGB()?X="rgb("+v.AttributeData.toColorRGB(P.getBgColor()).join(",")+")":P.isBgPalette()&&(X=R._colors.ansi[P.getBgColor()].css);var $=!1;try{for(var G=C(R._decorationService.getDecorationsAtCell(M,R._bufferService.buffer.ydisp+D)),ie=G.next();!ie.done;ie=G.next()){var ee=ie.value;ee.options.layer!=="top"&&$||(ee.backgroundColorRGB&&(X=ee.backgroundColorRGB.css),$=ee.options.layer==="top")}}catch(B){q={error:B}}finally{try{ie&&!ie.done&&(H=G.return)&&H.call(G)}finally{if(q)throw q.error}}T===null&&(O=M,I=D),D!==I?(x.fillStyle=T||"",R._fillCells(O,I,k-O,1),O=M,I=D):T!==X&&(x.fillStyle=T||"",R._fillCells(O,I,M-O,1),O=M,I=D),T=X}),T!==null&&(x.fillStyle=T,this._fillCells(O,I,k-O,1)),x.restore()},b.prototype._drawForeground=function(g,A){var R=this;this._forEachCell(g,A,function(x,k,O){if(!x.isInvisible()&&(R._drawChars(x,k,O),x.isUnderline()||x.isStrikethrough())){if(R._ctx.save(),x.isInverse())if(x.isBgDefault())R._ctx.fillStyle=R._colors.background.css;else if(x.isBgRGB())R._ctx.fillStyle="rgb("+v.AttributeData.toColorRGB(x.getBgColor()).join(",")+")";else{var I=x.getBgColor();R._optionsService.rawOptions.drawBoldTextInBrightColors&&x.isBold()&&I<8&&(I+=8),R._ctx.fillStyle=R._colors.ansi[I].css}else if(x.isFgDefault())R._ctx.fillStyle=R._colors.foreground.css;else if(x.isFgRGB())R._ctx.fillStyle="rgb("+v.AttributeData.toColorRGB(x.getFgColor()).join(",")+")";else{var T=x.getFgColor();R._optionsService.rawOptions.drawBoldTextInBrightColors&&x.isBold()&&T<8&&(T+=8),R._ctx.fillStyle=R._colors.ansi[T].css}x.isStrikethrough()&&R._fillMiddleLineAtCells(k,O,x.getWidth()),x.isUnderline()&&R._fillBottomLineAtCells(k,O,x.getWidth()),R._ctx.restore()}})},b.prototype.onGridChanged=function(g,A){this._state.cache.length!==0&&(this._charAtlas&&this._charAtlas.beginFrame(),this._clearCells(0,g,this._bufferService.cols,A-g+1),this._drawBackground(g,A),this._drawForeground(g,A))},b.prototype.onOptionsChanged=function(){this._setTransparency(this._optionsService.rawOptions.allowTransparency)},b.prototype._isOverlapping=function(g){if(g.getWidth()!==1||g.getCode()<256)return!1;var A=g.getChars();if(this._characterOverlapCache.hasOwnProperty(A))return this._characterOverlapCache[A];this._ctx.save(),this._ctx.font=this._characterFont;var R=Math.floor(this._ctx.measureText(A).width)>this._characterWidth;return this._ctx.restore(),this._characterOverlapCache[A]=R,R},f([m(5,c.IBufferService),m(6,c.IOptionsService),m(7,n.ICharacterJoinerService),m(8,c.IDecorationService)],b)}(p.BaseRenderLayer);r.TextRenderLayer=_},9616:(a,r)=>{Object.defineProperty(r,"__esModule",{value:!0}),r.BaseCharAtlas=void 0;var u=function(){function o(){this._didWarmUp=!1}return o.prototype.dispose=function(){},o.prototype.warmUp=function(){this._didWarmUp||(this._doWarmUp(),this._didWarmUp=!0)},o.prototype._doWarmUp=function(){},o.prototype.clear=function(){},o.prototype.beginFrame=function(){},o}();r.BaseCharAtlas=u},1420:(a,r,u)=>{Object.defineProperty(r,"__esModule",{value:!0}),r.removeTerminalFromCache=r.acquireCharAtlas=void 0;var o=u(2040),l=u(1906),f=[];r.acquireCharAtlas=function(m,C,S,p,v){for(var w=(0,o.generateConfig)(p,v,m,S),y=0;y<f.length;y++){var c=(n=f[y]).ownedBy.indexOf(C);if(c>=0){if((0,o.configEquals)(n.config,w))return n.atlas;n.ownedBy.length===1?(n.atlas.dispose(),f.splice(y,1)):n.ownedBy.splice(c,1);break}}for(y=0;y<f.length;y++){var n=f[y];if((0,o.configEquals)(n.config,w))return n.ownedBy.push(C),n.atlas}var h={atlas:new l.DynamicCharAtlas(document,w),config:w,ownedBy:[C]};return f.push(h),h.atlas},r.removeTerminalFromCache=function(m){for(var C=0;C<f.length;C++){var S=f[C].ownedBy.indexOf(m);if(S!==-1){f[C].ownedBy.length===1?(f[C].atlas.dispose(),f.splice(C,1)):f[C].ownedBy.splice(S,1);break}}}},2040:(a,r,u)=>{Object.defineProperty(r,"__esModule",{value:!0}),r.is256Color=r.configEquals=r.generateConfig=void 0;var o=u(643);r.generateConfig=function(l,f,m,C){var S={foreground:C.foreground,background:C.background,cursor:void 0,cursorAccent:void 0,selection:void 0,ansi:C.ansi.slice()};return{devicePixelRatio:window.devicePixelRatio,scaledCharWidth:l,scaledCharHeight:f,fontFamily:m.fontFamily,fontSize:m.fontSize,fontWeight:m.fontWeight,fontWeightBold:m.fontWeightBold,allowTransparency:m.allowTransparency,colors:S}},r.configEquals=function(l,f){for(var m=0;m<l.colors.ansi.length;m++)if(l.colors.ansi[m].rgba!==f.colors.ansi[m].rgba)return!1;return l.devicePixelRatio===f.devicePixelRatio&&l.fontFamily===f.fontFamily&&l.fontSize===f.fontSize&&l.fontWeight===f.fontWeight&&l.fontWeightBold===f.fontWeightBold&&l.allowTransparency===f.allowTransparency&&l.scaledCharWidth===f.scaledCharWidth&&l.scaledCharHeight===f.scaledCharHeight&&l.colors.foreground===f.colors.foreground&&l.colors.background===f.colors.background},r.is256Color=function(l){return l<o.DEFAULT_COLOR}},8803:(a,r,u)=>{Object.defineProperty(r,"__esModule",{value:!0}),r.CHAR_ATLAS_CELL_SPACING=r.TEXT_BASELINE=r.DIM_OPACITY=r.INVERTED_DEFAULT_COLOR=void 0;var o=u(6114);r.INVERTED_DEFAULT_COLOR=257,r.DIM_OPACITY=.5,r.TEXT_BASELINE=o.isFirefox||o.isLegacyEdge?"bottom":"ideographic",r.CHAR_ATLAS_CELL_SPACING=1},1906:function(a,r,u){var o,l=this&&this.__extends||(o=function(g,A){return o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(R,x){R.__proto__=x}||function(R,x){for(var k in x)Object.prototype.hasOwnProperty.call(x,k)&&(R[k]=x[k])},o(g,A)},function(g,A){if(typeof A!="function"&&A!==null)throw new TypeError("Class extends value "+String(A)+" is not a constructor or null");function R(){this.constructor=g}o(g,A),g.prototype=A===null?Object.create(A):(R.prototype=A.prototype,new R)});Object.defineProperty(r,"__esModule",{value:!0}),r.NoneCharAtlas=r.DynamicCharAtlas=r.getGlyphCacheKey=void 0;var f=u(8803),m=u(9616),C=u(5680),S=u(7001),p=u(6114),v=u(1752),w=u(8055),y=1024,c=1024,n={css:"rgba(0, 0, 0, 0)",rgba:0};function h(g){return g.code<<21|g.bg<<12|g.fg<<3|(g.bold?0:4)+(g.dim?0:2)+(g.italic?0:1)}r.getGlyphCacheKey=h;var _=function(g){function A(R,x){var k=g.call(this)||this;k._config=x,k._drawToCacheCount=0,k._glyphsWaitingOnBitmap=[],k._bitmapCommitTimeout=null,k._bitmap=null,k._cacheCanvas=R.createElement("canvas"),k._cacheCanvas.width=y,k._cacheCanvas.height=c,k._cacheCtx=(0,v.throwIfFalsy)(k._cacheCanvas.getContext("2d",{alpha:!0}));var O=R.createElement("canvas");O.width=k._config.scaledCharWidth,O.height=k._config.scaledCharHeight,k._tmpCtx=(0,v.throwIfFalsy)(O.getContext("2d",{alpha:k._config.allowTransparency})),k._width=Math.floor(y/k._config.scaledCharWidth),k._height=Math.floor(c/k._config.scaledCharHeight);var I=k._width*k._height;return k._cacheMap=new S.LRUMap(I),k._cacheMap.prealloc(I),k}return l(A,g),A.prototype.dispose=function(){this._bitmapCommitTimeout!==null&&(window.clearTimeout(this._bitmapCommitTimeout),this._bitmapCommitTimeout=null)},A.prototype.beginFrame=function(){this._drawToCacheCount=0},A.prototype.clear=function(){if(this._cacheMap.size>0){var R=this._width*this._height;this._cacheMap=new S.LRUMap(R),this._cacheMap.prealloc(R)}this._cacheCtx.clearRect(0,0,y,c),this._tmpCtx.clearRect(0,0,this._config.scaledCharWidth,this._config.scaledCharHeight)},A.prototype.draw=function(R,x,k,O){if(x.code===32)return!0;if(!this._canCache(x))return!1;var I=h(x),T=this._cacheMap.get(I);if(T!=null)return this._drawFromCache(R,T,k,O),!0;if(this._drawToCacheCount<100){var P;P=this._cacheMap.size<this._cacheMap.capacity?this._cacheMap.size:this._cacheMap.peek().index;var M=this._drawToCache(x,P);return this._cacheMap.set(I,M),this._drawFromCache(R,M,k,O),!0}return!1},A.prototype._canCache=function(R){return R.code<256},A.prototype._toCoordinateX=function(R){return R%this._width*this._config.scaledCharWidth},A.prototype._toCoordinateY=function(R){return Math.floor(R/this._width)*this._config.scaledCharHeight},A.prototype._drawFromCache=function(R,x,k,O){if(!x.isEmpty){var I=this._toCoordinateX(x.index),T=this._toCoordinateY(x.index);R.drawImage(x.inBitmap?this._bitmap:this._cacheCanvas,I,T,this._config.scaledCharWidth,this._config.scaledCharHeight,k,O,this._config.scaledCharWidth,this._config.scaledCharHeight)}},A.prototype._getColorFromAnsiIndex=function(R){return R<this._config.colors.ansi.length?this._config.colors.ansi[R]:C.DEFAULT_ANSI_COLORS[R]},A.prototype._getBackgroundColor=function(R){return this._config.allowTransparency?n:R.bg===f.INVERTED_DEFAULT_COLOR?this._config.colors.foreground:R.bg<256?this._getColorFromAnsiIndex(R.bg):this._config.colors.background},A.prototype._getForegroundColor=function(R){return R.fg===f.INVERTED_DEFAULT_COLOR?w.color.opaque(this._config.colors.background):R.fg<256?this._getColorFromAnsiIndex(R.fg):this._config.colors.foreground},A.prototype._drawToCache=function(R,x){this._drawToCacheCount++,this._tmpCtx.save();var k=this._getBackgroundColor(R);this._tmpCtx.globalCompositeOperation="copy",this._tmpCtx.fillStyle=k.css,this._tmpCtx.fillRect(0,0,this._config.scaledCharWidth,this._config.scaledCharHeight),this._tmpCtx.globalCompositeOperation="source-over";var O=R.bold?this._config.fontWeightBold:this._config.fontWeight,I=R.italic?"italic":"";this._tmpCtx.font=I+" "+O+" "+this._config.fontSize*this._config.devicePixelRatio+"px "+this._config.fontFamily,this._tmpCtx.textBaseline=f.TEXT_BASELINE,this._tmpCtx.fillStyle=this._getForegroundColor(R).css,R.dim&&(this._tmpCtx.globalAlpha=f.DIM_OPACITY),this._tmpCtx.fillText(R.chars,0,this._config.scaledCharHeight);var T=this._tmpCtx.getImageData(0,0,this._config.scaledCharWidth,this._config.scaledCharHeight),P=!1;if(this._config.allowTransparency||(P=b(T,k)),P&&R.chars==="_"&&!this._config.allowTransparency)for(var M=1;M<=5&&(this._tmpCtx.fillText(R.chars,0,this._config.scaledCharHeight-M),P=b(T=this._tmpCtx.getImageData(0,0,this._config.scaledCharWidth,this._config.scaledCharHeight),k));M++);this._tmpCtx.restore();var D=this._toCoordinateX(x),q=this._toCoordinateY(x);this._cacheCtx.putImageData(T,D,q);var H={index:x,isEmpty:P,inBitmap:!1};return this._addGlyphToBitmap(H),H},A.prototype._addGlyphToBitmap=function(R){var x=this;!("createImageBitmap"in window)||p.isFirefox||p.isSafari||(this._glyphsWaitingOnBitmap.push(R),this._bitmapCommitTimeout===null&&(this._bitmapCommitTimeout=window.setTimeout(function(){return x._generateBitmap()},100)))},A.prototype._generateBitmap=function(){var R=this,x=this._glyphsWaitingOnBitmap;this._glyphsWaitingOnBitmap=[],window.createImageBitmap(this._cacheCanvas).then(function(k){R._bitmap=k;for(var O=0;O<x.length;O++)x[O].inBitmap=!0}),this._bitmapCommitTimeout=null},A}(m.BaseCharAtlas);r.DynamicCharAtlas=_;var d=function(g){function A(R,x){return g.call(this)||this}return l(A,g),A.prototype.draw=function(R,x,k,O){return!1},A}(m.BaseCharAtlas);function b(g,A){for(var R=!0,x=A.rgba>>>24,k=A.rgba>>>16&255,O=A.rgba>>>8&255,I=0;I<g.data.length;I+=4)g.data[I]===x&&g.data[I+1]===k&&g.data[I+2]===O?g.data[I+3]=0:R=!1;return R}r.NoneCharAtlas=d},7001:(a,r)=>{Object.defineProperty(r,"__esModule",{value:!0}),r.LRUMap=void 0;var u=function(){function o(l){this.capacity=l,this._map={},this._head=null,this._tail=null,this._nodePool=[],this.size=0}return o.prototype._unlinkNode=function(l){var f=l.prev,m=l.next;l===this._head&&(this._head=m),l===this._tail&&(this._tail=f),f!==null&&(f.next=m),m!==null&&(m.prev=f)},o.prototype._appendNode=function(l){var f=this._tail;f!==null&&(f.next=l),l.prev=f,l.next=null,this._tail=l,this._head===null&&(this._head=l)},o.prototype.prealloc=function(l){for(var f=this._nodePool,m=0;m<l;m++)f.push({prev:null,next:null,key:null,value:null})},o.prototype.get=function(l){var f=this._map[l];return f!==void 0?(this._unlinkNode(f),this._appendNode(f),f.value):null},o.prototype.peekValue=function(l){var f=this._map[l];return f!==void 0?f.value:null},o.prototype.peek=function(){var l=this._head;return l===null?null:l.value},o.prototype.set=function(l,f){var m=this._map[l];if(m!==void 0)m=this._map[l],this._unlinkNode(m),m.value=f;else if(this.size>=this.capacity)m=this._head,this._unlinkNode(m),delete this._map[m.key],m.key=l,m.value=f,this._map[l]=m;else{var C=this._nodePool;C.length>0?((m=C.pop()).key=l,m.value=f):m={prev:null,next:null,key:l,value:f},this._map[l]=m,this.size++}this._appendNode(m)},o}();r.LRUMap=u},1296:function(a,r,u){var o,l=this&&this.__extends||(o=function(x,k){return o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(O,I){O.__proto__=I}||function(O,I){for(var T in I)Object.prototype.hasOwnProperty.call(I,T)&&(O[T]=I[T])},o(x,k)},function(x,k){if(typeof k!="function"&&k!==null)throw new TypeError("Class extends value "+String(k)+" is not a constructor or null");function O(){this.constructor=x}o(x,k),x.prototype=k===null?Object.create(k):(O.prototype=k.prototype,new O)}),f=this&&this.__decorate||function(x,k,O,I){var T,P=arguments.length,M=P<3?k:I===null?I=Object.getOwnPropertyDescriptor(k,O):I;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")M=Reflect.decorate(x,k,O,I);else for(var D=x.length-1;D>=0;D--)(T=x[D])&&(M=(P<3?T(M):P>3?T(k,O,M):T(k,O))||M);return P>3&&M&&Object.defineProperty(k,O,M),M},m=this&&this.__param||function(x,k){return function(O,I){k(O,I,x)}},C=this&&this.__values||function(x){var k=typeof Symbol=="function"&&Symbol.iterator,O=k&&x[k],I=0;if(O)return O.call(x);if(x&&typeof x.length=="number")return{next:function(){return x&&I>=x.length&&(x=void 0),{value:x&&x[I++],done:!x}}};throw new TypeError(k?"Object is not iterable.":"Symbol.iterator is not defined.")};Object.defineProperty(r,"__esModule",{value:!0}),r.DomRenderer=void 0;var S=u(3787),p=u(8803),v=u(844),w=u(4725),y=u(2585),c=u(8460),n=u(8055),h=u(9631),_="xterm-dom-renderer-owner-",d="xterm-fg-",b="xterm-bg-",g="xterm-focus",A=1,R=function(x){function k(O,I,T,P,M,D,q,H,X,$){var G=x.call(this)||this;return G._colors=O,G._element=I,G._screenElement=T,G._viewportElement=P,G._linkifier=M,G._linkifier2=D,G._charSizeService=H,G._optionsService=X,G._bufferService=$,G._terminalClass=A++,G._rowElements=[],G._rowContainer=document.createElement("div"),G._rowContainer.classList.add("xterm-rows"),G._rowContainer.style.lineHeight="normal",G._rowContainer.setAttribute("aria-hidden","true"),G._refreshRowElements(G._bufferService.cols,G._bufferService.rows),G._selectionContainer=document.createElement("div"),G._selectionContainer.classList.add("xterm-selection"),G._selectionContainer.setAttribute("aria-hidden","true"),G.dimensions={scaledCharWidth:0,scaledCharHeight:0,scaledCellWidth:0,scaledCellHeight:0,scaledCharLeft:0,scaledCharTop:0,scaledCanvasWidth:0,scaledCanvasHeight:0,canvasWidth:0,canvasHeight:0,actualCellWidth:0,actualCellHeight:0},G._updateDimensions(),G._injectCss(),G._rowFactory=q.createInstance(S.DomRendererRowFactory,document,G._colors),G._element.classList.add(_+G._terminalClass),G._screenElement.appendChild(G._rowContainer),G._screenElement.appendChild(G._selectionContainer),G.register(G._linkifier.onShowLinkUnderline(function(ie){return G._onLinkHover(ie)})),G.register(G._linkifier.onHideLinkUnderline(function(ie){return G._onLinkLeave(ie)})),G.register(G._linkifier2.onShowLinkUnderline(function(ie){return G._onLinkHover(ie)})),G.register(G._linkifier2.onHideLinkUnderline(function(ie){return G._onLinkLeave(ie)})),G}return l(k,x),Object.defineProperty(k.prototype,"onRequestRedraw",{get:function(){return new c.EventEmitter().event},enumerable:!1,configurable:!0}),k.prototype.dispose=function(){this._element.classList.remove(_+this._terminalClass),(0,h.removeElementFromParent)(this._rowContainer,this._selectionContainer,this._themeStyleElement,this._dimensionsStyleElement),x.prototype.dispose.call(this)},k.prototype._updateDimensions=function(){var O,I;this.dimensions.scaledCharWidth=this._charSizeService.width*window.devicePixelRatio,this.dimensions.scaledCharHeight=Math.ceil(this._charSizeService.height*window.devicePixelRatio),this.dimensions.scaledCellWidth=this.dimensions.scaledCharWidth+Math.round(this._optionsService.rawOptions.letterSpacing),this.dimensions.scaledCellHeight=Math.floor(this.dimensions.scaledCharHeight*this._optionsService.rawOptions.lineHeight),this.dimensions.scaledCharLeft=0,this.dimensions.scaledCharTop=0,this.dimensions.scaledCanvasWidth=this.dimensions.scaledCellWidth*this._bufferService.cols,this.dimensions.scaledCanvasHeight=this.dimensions.scaledCellHeight*this._bufferService.rows,this.dimensions.canvasWidth=Math.round(this.dimensions.scaledCanvasWidth/window.devicePixelRatio),this.dimensions.canvasHeight=Math.round(this.dimensions.scaledCanvasHeight/window.devicePixelRatio),this.dimensions.actualCellWidth=this.dimensions.canvasWidth/this._bufferService.cols,this.dimensions.actualCellHeight=this.dimensions.canvasHeight/this._bufferService.rows;try{for(var T=C(this._rowElements),P=T.next();!P.done;P=T.next()){var M=P.value;M.style.width=this.dimensions.canvasWidth+"px",M.style.height=this.dimensions.actualCellHeight+"px",M.style.lineHeight=this.dimensions.actualCellHeight+"px",M.style.overflow="hidden"}}catch(q){O={error:q}}finally{try{P&&!P.done&&(I=T.return)&&I.call(T)}finally{if(O)throw O.error}}this._dimensionsStyleElement||(this._dimensionsStyleElement=document.createElement("style"),this._screenElement.appendChild(this._dimensionsStyleElement));var D=this._terminalSelector+" .xterm-rows span { display: inline-block; height: 100%; vertical-align: top; width: "+this.dimensions.actualCellWidth+"px}";this._dimensionsStyleElement.textContent=D,this._selectionContainer.style.height=this._viewportElement.style.height,this._screenElement.style.width=this.dimensions.canvasWidth+"px",this._screenElement.style.height=this.dimensions.canvasHeight+"px"},k.prototype.setColors=function(O){this._colors=O,this._injectCss()},k.prototype._injectCss=function(){var O=this;this._themeStyleElement||(this._themeStyleElement=document.createElement("style"),this._screenElement.appendChild(this._themeStyleElement));var I=this._terminalSelector+" .xterm-rows { color: "+this._colors.foreground.css+"; font-family: "+this._optionsService.rawOptions.fontFamily+"; font-size: "+this._optionsService.rawOptions.fontSize+"px;}";I+=this._terminalSelector+" span:not(."+S.BOLD_CLASS+") { font-weight: "+this._optionsService.rawOptions.fontWeight+";}"+this._terminalSelector+" span."+S.BOLD_CLASS+" { font-weight: "+this._optionsService.rawOptions.fontWeightBold+";}"+this._terminalSelector+" span."+S.ITALIC_CLASS+" { font-style: italic;}",I+="@keyframes blink_box_shadow_"+this._terminalClass+" { 50% {  box-shadow: none; }}",I+="@keyframes blink_block_"+this._terminalClass+" { 0% {  background-color: "+this._colors.cursor.css+";  color: "+this._colors.cursorAccent.css+"; } 50% {  background-color: "+this._colors.cursorAccent.css+";  color: "+this._colors.cursor.css+"; }}",I+=this._terminalSelector+" .xterm-rows:not(.xterm-focus) ."+S.CURSOR_CLASS+"."+S.CURSOR_STYLE_BLOCK_CLASS+" { outline: 1px solid "+this._colors.cursor.css+"; outline-offset: -1px;}"+this._terminalSelector+" .xterm-rows.xterm-focus ."+S.CURSOR_CLASS+"."+S.CURSOR_BLINK_CLASS+":not(."+S.CURSOR_STYLE_BLOCK_CLASS+") { animation: blink_box_shadow_"+this._terminalClass+" 1s step-end infinite;}"+this._terminalSelector+" .xterm-rows.xterm-focus ."+S.CURSOR_CLASS+"."+S.CURSOR_BLINK_CLASS+"."+S.CURSOR_STYLE_BLOCK_CLASS+" { animation: blink_block_"+this._terminalClass+" 1s step-end infinite;}"+this._terminalSelector+" .xterm-rows.xterm-focus ."+S.CURSOR_CLASS+"."+S.CURSOR_STYLE_BLOCK_CLASS+" { background-color: "+this._colors.cursor.css+"; color: "+this._colors.cursorAccent.css+";}"+this._terminalSelector+" .xterm-rows ."+S.CURSOR_CLASS+"."+S.CURSOR_STYLE_BAR_CLASS+" { box-shadow: "+this._optionsService.rawOptions.cursorWidth+"px 0 0 "+this._colors.cursor.css+" inset;}"+this._terminalSelector+" .xterm-rows ."+S.CURSOR_CLASS+"."+S.CURSOR_STYLE_UNDERLINE_CLASS+" { box-shadow: 0 -1px 0 "+this._colors.cursor.css+" inset;}",I+=this._terminalSelector+" .xterm-selection { position: absolute; top: 0; left: 0; z-index: 1; pointer-events: none;}"+this._terminalSelector+" .xterm-selection div { position: absolute; background-color: "+this._colors.selectionOpaque.css+";}",this._colors.ansi.forEach(function(T,P){I+=O._terminalSelector+" ."+d+P+" { color: "+T.css+"; }"+O._terminalSelector+" ."+b+P+" { background-color: "+T.css+"; }"}),I+=this._terminalSelector+" ."+d+p.INVERTED_DEFAULT_COLOR+" { color: "+n.color.opaque(this._colors.background).css+"; }"+this._terminalSelector+" ."+b+p.INVERTED_DEFAULT_COLOR+" { background-color: "+this._colors.foreground.css+"; }",this._themeStyleElement.textContent=I},k.prototype.onDevicePixelRatioChange=function(){this._updateDimensions()},k.prototype._refreshRowElements=function(O,I){for(var T=this._rowElements.length;T<=I;T++){var P=document.createElement("div");this._rowContainer.appendChild(P),this._rowElements.push(P)}for(;this._rowElements.length>I;)this._rowContainer.removeChild(this._rowElements.pop())},k.prototype.onResize=function(O,I){this._refreshRowElements(O,I),this._updateDimensions()},k.prototype.onCharSizeChanged=function(){this._updateDimensions()},k.prototype.onBlur=function(){this._rowContainer.classList.remove(g)},k.prototype.onFocus=function(){this._rowContainer.classList.add(g)},k.prototype.onSelectionChanged=function(O,I,T){for(;this._selectionContainer.children.length;)this._selectionContainer.removeChild(this._selectionContainer.children[0]);if(this._rowFactory.onSelectionChanged(O,I,T),this.renderRows(0,this._bufferService.rows-1),O&&I){var P=O[1]-this._bufferService.buffer.ydisp,M=I[1]-this._bufferService.buffer.ydisp,D=Math.max(P,0),q=Math.min(M,this._bufferService.rows-1);if(!(D>=this._bufferService.rows||q<0)){var H=document.createDocumentFragment();if(T){var X=O[0]>I[0];H.appendChild(this._createSelectionElement(D,X?I[0]:O[0],X?O[0]:I[0],q-D+1))}else{var $=P===D?O[0]:0,G=D===M?I[0]:this._bufferService.cols;H.appendChild(this._createSelectionElement(D,$,G));var ie=q-D-1;if(H.appendChild(this._createSelectionElement(D+1,0,this._bufferService.cols,ie)),D!==q){var ee=M===q?I[0]:this._bufferService.cols;H.appendChild(this._createSelectionElement(q,0,ee))}}this._selectionContainer.appendChild(H)}}},k.prototype._createSelectionElement=function(O,I,T,P){P===void 0&&(P=1);var M=document.createElement("div");return M.style.height=P*this.dimensions.actualCellHeight+"px",M.style.top=O*this.dimensions.actualCellHeight+"px",M.style.left=I*this.dimensions.actualCellWidth+"px",M.style.width=this.dimensions.actualCellWidth*(T-I)+"px",M},k.prototype.onCursorMove=function(){},k.prototype.onOptionsChanged=function(){this._updateDimensions(),this._injectCss()},k.prototype.clear=function(){var O,I;try{for(var T=C(this._rowElements),P=T.next();!P.done;P=T.next())P.value.innerText=""}catch(M){O={error:M}}finally{try{P&&!P.done&&(I=T.return)&&I.call(T)}finally{if(O)throw O.error}}},k.prototype.renderRows=function(O,I){for(var T=this._bufferService.buffer.ybase+this._bufferService.buffer.y,P=Math.min(this._bufferService.buffer.x,this._bufferService.cols-1),M=this._optionsService.rawOptions.cursorBlink,D=O;D<=I;D++){var q=this._rowElements[D];q.innerText="";var H=D+this._bufferService.buffer.ydisp,X=this._bufferService.buffer.lines.get(H),$=this._optionsService.rawOptions.cursorStyle;q.appendChild(this._rowFactory.createRow(X,H,H===T,$,P,M,this.dimensions.actualCellWidth,this._bufferService.cols))}},Object.defineProperty(k.prototype,"_terminalSelector",{get:function(){return"."+_+this._terminalClass},enumerable:!1,configurable:!0}),k.prototype._onLinkHover=function(O){this._setCellUnderline(O.x1,O.x2,O.y1,O.y2,O.cols,!0)},k.prototype._onLinkLeave=function(O){this._setCellUnderline(O.x1,O.x2,O.y1,O.y2,O.cols,!1)},k.prototype._setCellUnderline=function(O,I,T,P,M,D){for(;O!==I||T!==P;){var q=this._rowElements[T];if(!q)return;var H=q.children[O];H&&(H.style.textDecoration=D?"underline":"none"),++O>=M&&(O=0,T++)}},f([m(6,y.IInstantiationService),m(7,w.ICharSizeService),m(8,y.IOptionsService),m(9,y.IBufferService)],k)}(v.Disposable);r.DomRenderer=R},3787:function(a,r,u){var o=this&&this.__decorate||function(_,d,b,g){var A,R=arguments.length,x=R<3?d:g===null?g=Object.getOwnPropertyDescriptor(d,b):g;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")x=Reflect.decorate(_,d,b,g);else for(var k=_.length-1;k>=0;k--)(A=_[k])&&(x=(R<3?A(x):R>3?A(d,b,x):A(d,b))||x);return R>3&&x&&Object.defineProperty(d,b,x),x},l=this&&this.__param||function(_,d){return function(b,g){d(b,g,_)}},f=this&&this.__values||function(_){var d=typeof Symbol=="function"&&Symbol.iterator,b=d&&_[d],g=0;if(b)return b.call(_);if(_&&typeof _.length=="number")return{next:function(){return _&&g>=_.length&&(_=void 0),{value:_&&_[g++],done:!_}}};throw new TypeError(d?"Object is not iterable.":"Symbol.iterator is not defined.")};Object.defineProperty(r,"__esModule",{value:!0}),r.DomRendererRowFactory=r.CURSOR_STYLE_UNDERLINE_CLASS=r.CURSOR_STYLE_BAR_CLASS=r.CURSOR_STYLE_BLOCK_CLASS=r.CURSOR_BLINK_CLASS=r.CURSOR_CLASS=r.STRIKETHROUGH_CLASS=r.UNDERLINE_CLASS=r.ITALIC_CLASS=r.DIM_CLASS=r.BOLD_CLASS=void 0;var m=u(8803),C=u(643),S=u(511),p=u(2585),v=u(8055),w=u(4725),y=u(4269),c=u(1752);r.BOLD_CLASS="xterm-bold",r.DIM_CLASS="xterm-dim",r.ITALIC_CLASS="xterm-italic",r.UNDERLINE_CLASS="xterm-underline",r.STRIKETHROUGH_CLASS="xterm-strikethrough",r.CURSOR_CLASS="xterm-cursor",r.CURSOR_BLINK_CLASS="xterm-cursor-blink",r.CURSOR_STYLE_BLOCK_CLASS="xterm-cursor-block",r.CURSOR_STYLE_BAR_CLASS="xterm-cursor-bar",r.CURSOR_STYLE_UNDERLINE_CLASS="xterm-cursor-underline";var n=function(){function _(d,b,g,A,R,x){this._document=d,this._colors=b,this._characterJoinerService=g,this._optionsService=A,this._coreService=R,this._decorationService=x,this._workCell=new S.CellData,this._columnSelectMode=!1}return _.prototype.setColors=function(d){this._colors=d},_.prototype.onSelectionChanged=function(d,b,g){this._selectionStart=d,this._selectionEnd=b,this._columnSelectMode=g},_.prototype.createRow=function(d,b,g,A,R,x,k,O){for(var I,T,P=this._document.createDocumentFragment(),M=this._characterJoinerService.getJoinedCharacters(b),D=0,q=Math.min(d.length,O)-1;q>=0;q--)if(d.loadCell(q,this._workCell).getCode()!==C.NULL_CELL_CODE||g&&q===R){D=q+1;break}for(q=0;q<D;q++){d.loadCell(q,this._workCell);var H=this._workCell.getWidth();if(H!==0){var X=!1,$=q,G=this._workCell;if(M.length>0&&q===M[0][0]){X=!0;var ie=M.shift();G=new y.JoinedCellData(this._workCell,d.translateToString(!0,ie[0],ie[1]),ie[1]-ie[0]),$=ie[1]-1,H=G.getWidth()}var ee=this._document.createElement("span");if(H>1&&(ee.style.width=k*H+"px"),X&&(ee.style.display="inline",R>=q&&R<=$&&(R=q)),!this._coreService.isCursorHidden&&g&&q===R)switch(ee.classList.add(r.CURSOR_CLASS),x&&ee.classList.add(r.CURSOR_BLINK_CLASS),A){case"bar":ee.classList.add(r.CURSOR_STYLE_BAR_CLASS);break;case"underline":ee.classList.add(r.CURSOR_STYLE_UNDERLINE_CLASS);break;default:ee.classList.add(r.CURSOR_STYLE_BLOCK_CLASS)}G.isBold()&&ee.classList.add(r.BOLD_CLASS),G.isItalic()&&ee.classList.add(r.ITALIC_CLASS),G.isDim()&&ee.classList.add(r.DIM_CLASS),G.isUnderline()&&ee.classList.add(r.UNDERLINE_CLASS),G.isInvisible()?ee.textContent=C.WHITESPACE_CELL_CHAR:ee.textContent=G.getChars()||C.WHITESPACE_CELL_CHAR,G.isStrikethrough()&&ee.classList.add(r.STRIKETHROUGH_CLASS);var B=G.getFgColor(),pe=G.getFgColorMode(),de=G.getBgColor(),Oe=G.getBgColorMode(),N=!!G.isInverse();if(N){var xe=B;B=de,de=xe;var le=pe;pe=Oe,Oe=le}var K=void 0,F=void 0,U=!1;try{for(var W=(I=void 0,f(this._decorationService.getDecorationsAtCell(q,b))),ae=W.next();!ae.done;ae=W.next()){var he=ae.value;he.options.layer!=="top"&&U||(he.backgroundColorRGB&&(Oe=50331648,de=he.backgroundColorRGB.rgba>>8&16777215,K=he.backgroundColorRGB),he.foregroundColorRGB&&(pe=50331648,B=he.foregroundColorRGB.rgba>>8&16777215,F=he.foregroundColorRGB),U=he.options.layer==="top")}}catch(Ne){I={error:Ne}}finally{try{ae&&!ae.done&&(T=W.return)&&T.call(W)}finally{if(I)throw I.error}}var me=this._isCellInSelection(q,b);U||this._colors.selectionForeground&&me&&(pe=50331648,B=this._colors.selectionForeground.rgba>>8&16777215,F=this._colors.selectionForeground),me&&(K=this._colors.selectionOpaque,U=!0),U&&ee.classList.add("xterm-decoration-top");var De=void 0;switch(Oe){case 16777216:case 33554432:De=this._colors.ansi[de],ee.classList.add("xterm-bg-"+de);break;case 50331648:De=v.rgba.toColor(de>>16,de>>8&255,255&de),this._addStyle(ee,"background-color:#"+h((de>>>0).toString(16),"0",6));break;default:N?(De=this._colors.foreground,ee.classList.add("xterm-bg-"+m.INVERTED_DEFAULT_COLOR)):De=this._colors.background}switch(pe){case 16777216:case 33554432:G.isBold()&&B<8&&this._optionsService.rawOptions.drawBoldTextInBrightColors&&(B+=8),this._applyMinimumContrast(ee,De,this._colors.ansi[B],G,K,void 0)||ee.classList.add("xterm-fg-"+B);break;case 50331648:var He=v.rgba.toColor(B>>16&255,B>>8&255,255&B);this._applyMinimumContrast(ee,De,He,G,K,F)||this._addStyle(ee,"color:#"+h(B.toString(16),"0",6));break;default:this._applyMinimumContrast(ee,De,this._colors.foreground,G,K,void 0)||N&&ee.classList.add("xterm-fg-"+m.INVERTED_DEFAULT_COLOR)}P.appendChild(ee),q=$}}return P},_.prototype._applyMinimumContrast=function(d,b,g,A,R,x){if(this._optionsService.rawOptions.minimumContrastRatio===1||(0,c.excludeFromContrastRatioDemands)(A.getCode()))return!1;var k=void 0;return R||x||(k=this._colors.contrastCache.getColor(b.rgba,g.rgba)),k===void 0&&(k=v.color.ensureContrastRatio(R||b,x||g,this._optionsService.rawOptions.minimumContrastRatio),this._colors.contrastCache.setColor((R||b).rgba,(x||g).rgba,k??null)),!!k&&(this._addStyle(d,"color:"+k.css),!0)},_.prototype._addStyle=function(d,b){d.setAttribute("style",""+(d.getAttribute("style")||"")+b+";")},_.prototype._isCellInSelection=function(d,b){var g=this._selectionStart,A=this._selectionEnd;return!(!g||!A)&&(this._columnSelectMode?g[0]<=A[0]?d>=g[0]&&b>=g[1]&&d<A[0]&&b<=A[1]:d<g[0]&&b>=g[1]&&d>=A[0]&&b<=A[1]:b>g[1]&&b<A[1]||g[1]===A[1]&&b===g[1]&&d>=g[0]&&d<A[0]||g[1]<A[1]&&b===A[1]&&d<A[0]||g[1]<A[1]&&b===g[1]&&d>=g[0])},o([l(2,w.ICharacterJoinerService),l(3,p.IOptionsService),l(4,p.ICoreService),l(5,p.IDecorationService)],_)}();function h(_,d,b){for(;_.length<b;)_=d+_;return _}r.DomRendererRowFactory=n},456:(a,r)=>{Object.defineProperty(r,"__esModule",{value:!0}),r.SelectionModel=void 0;var u=function(){function o(l){this._bufferService=l,this.isSelectAllActive=!1,this.selectionStartLength=0}return o.prototype.clearSelection=function(){this.selectionStart=void 0,this.selectionEnd=void 0,this.isSelectAllActive=!1,this.selectionStartLength=0},Object.defineProperty(o.prototype,"finalSelectionStart",{get:function(){return this.isSelectAllActive?[0,0]:this.selectionEnd&&this.selectionStart&&this.areSelectionValuesReversed()?this.selectionEnd:this.selectionStart},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"finalSelectionEnd",{get:function(){return this.isSelectAllActive?[this._bufferService.cols,this._bufferService.buffer.ybase+this._bufferService.rows-1]:this.selectionStart?!this.selectionEnd||this.areSelectionValuesReversed()?(l=this.selectionStart[0]+this.selectionStartLength)>this._bufferService.cols?l%this._bufferService.cols==0?[this._bufferService.cols,this.selectionStart[1]+Math.floor(l/this._bufferService.cols)-1]:[l%this._bufferService.cols,this.selectionStart[1]+Math.floor(l/this._bufferService.cols)]:[l,this.selectionStart[1]]:this.selectionStartLength&&this.selectionEnd[1]===this.selectionStart[1]?(l=this.selectionStart[0]+this.selectionStartLength)>this._bufferService.cols?[l%this._bufferService.cols,this.selectionStart[1]+Math.floor(l/this._bufferService.cols)]:[Math.max(l,this.selectionEnd[0]),this.selectionEnd[1]]:this.selectionEnd:void 0;var l},enumerable:!1,configurable:!0}),o.prototype.areSelectionValuesReversed=function(){var l=this.selectionStart,f=this.selectionEnd;return!(!l||!f)&&(l[1]>f[1]||l[1]===f[1]&&l[0]>f[0])},o.prototype.onTrim=function(l){return this.selectionStart&&(this.selectionStart[1]-=l),this.selectionEnd&&(this.selectionEnd[1]-=l),this.selectionEnd&&this.selectionEnd[1]<0?(this.clearSelection(),!0):(this.selectionStart&&this.selectionStart[1]<0&&(this.selectionStart[1]=0),!1)},o}();r.SelectionModel=u},428:function(a,r,u){var o=this&&this.__decorate||function(p,v,w,y){var c,n=arguments.length,h=n<3?v:y===null?y=Object.getOwnPropertyDescriptor(v,w):y;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")h=Reflect.decorate(p,v,w,y);else for(var _=p.length-1;_>=0;_--)(c=p[_])&&(h=(n<3?c(h):n>3?c(v,w,h):c(v,w))||h);return n>3&&h&&Object.defineProperty(v,w,h),h},l=this&&this.__param||function(p,v){return function(w,y){v(w,y,p)}};Object.defineProperty(r,"__esModule",{value:!0}),r.CharSizeService=void 0;var f=u(2585),m=u(8460),C=function(){function p(v,w,y){this._optionsService=y,this.width=0,this.height=0,this._onCharSizeChange=new m.EventEmitter,this._measureStrategy=new S(v,w,this._optionsService)}return Object.defineProperty(p.prototype,"hasValidSize",{get:function(){return this.width>0&&this.height>0},enumerable:!1,configurable:!0}),Object.defineProperty(p.prototype,"onCharSizeChange",{get:function(){return this._onCharSizeChange.event},enumerable:!1,configurable:!0}),p.prototype.measure=function(){var v=this._measureStrategy.measure();v.width===this.width&&v.height===this.height||(this.width=v.width,this.height=v.height,this._onCharSizeChange.fire())},o([l(2,f.IOptionsService)],p)}();r.CharSizeService=C;var S=function(){function p(v,w,y){this._document=v,this._parentElement=w,this._optionsService=y,this._result={width:0,height:0},this._measureElement=this._document.createElement("span"),this._measureElement.classList.add("xterm-char-measure-element"),this._measureElement.textContent="W",this._measureElement.setAttribute("aria-hidden","true"),this._parentElement.appendChild(this._measureElement)}return p.prototype.measure=function(){this._measureElement.style.fontFamily=this._optionsService.rawOptions.fontFamily,this._measureElement.style.fontSize=this._optionsService.rawOptions.fontSize+"px";var v=this._measureElement.getBoundingClientRect();return v.width!==0&&v.height!==0&&(this._result.width=v.width,this._result.height=Math.ceil(v.height)),this._result},p}()},4269:function(a,r,u){var o,l=this&&this.__extends||(o=function(c,n){return o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(h,_){h.__proto__=_}||function(h,_){for(var d in _)Object.prototype.hasOwnProperty.call(_,d)&&(h[d]=_[d])},o(c,n)},function(c,n){if(typeof n!="function"&&n!==null)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function h(){this.constructor=c}o(c,n),c.prototype=n===null?Object.create(n):(h.prototype=n.prototype,new h)}),f=this&&this.__decorate||function(c,n,h,_){var d,b=arguments.length,g=b<3?n:_===null?_=Object.getOwnPropertyDescriptor(n,h):_;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")g=Reflect.decorate(c,n,h,_);else for(var A=c.length-1;A>=0;A--)(d=c[A])&&(g=(b<3?d(g):b>3?d(n,h,g):d(n,h))||g);return b>3&&g&&Object.defineProperty(n,h,g),g},m=this&&this.__param||function(c,n){return function(h,_){n(h,_,c)}};Object.defineProperty(r,"__esModule",{value:!0}),r.CharacterJoinerService=r.JoinedCellData=void 0;var C=u(3734),S=u(643),p=u(511),v=u(2585),w=function(c){function n(h,_,d){var b=c.call(this)||this;return b.content=0,b.combinedData="",b.fg=h.fg,b.bg=h.bg,b.combinedData=_,b._width=d,b}return l(n,c),n.prototype.isCombined=function(){return 2097152},n.prototype.getWidth=function(){return this._width},n.prototype.getChars=function(){return this.combinedData},n.prototype.getCode=function(){return 2097151},n.prototype.setFromCharData=function(h){throw new Error("not implemented")},n.prototype.getAsCharData=function(){return[this.fg,this.getChars(),this.getWidth(),this.getCode()]},n}(C.AttributeData);r.JoinedCellData=w;var y=function(){function c(n){this._bufferService=n,this._characterJoiners=[],this._nextCharacterJoinerId=0,this._workCell=new p.CellData}return c.prototype.register=function(n){var h={id:this._nextCharacterJoinerId++,handler:n};return this._characterJoiners.push(h),h.id},c.prototype.deregister=function(n){for(var h=0;h<this._characterJoiners.length;h++)if(this._characterJoiners[h].id===n)return this._characterJoiners.splice(h,1),!0;return!1},c.prototype.getJoinedCharacters=function(n){if(this._characterJoiners.length===0)return[];var h=this._bufferService.buffer.lines.get(n);if(!h||h.length===0)return[];for(var _=[],d=h.translateToString(!0),b=0,g=0,A=0,R=h.getFg(0),x=h.getBg(0),k=0;k<h.getTrimmedLength();k++)if(h.loadCell(k,this._workCell),this._workCell.getWidth()!==0){if(this._workCell.fg!==R||this._workCell.bg!==x){if(k-b>1)for(var O=this._getJoinedRanges(d,A,g,h,b),I=0;I<O.length;I++)_.push(O[I]);b=k,A=g,R=this._workCell.fg,x=this._workCell.bg}g+=this._workCell.getChars().length||S.WHITESPACE_CELL_CHAR.length}if(this._bufferService.cols-b>1)for(O=this._getJoinedRanges(d,A,g,h,b),I=0;I<O.length;I++)_.push(O[I]);return _},c.prototype._getJoinedRanges=function(n,h,_,d,b){var g=n.substring(h,_),A=[];try{A=this._characterJoiners[0].handler(g)}catch(O){console.error(O)}for(var R=1;R<this._characterJoiners.length;R++)try{for(var x=this._characterJoiners[R].handler(g),k=0;k<x.length;k++)c._mergeRanges(A,x[k])}catch(O){console.error(O)}return this._stringRangesToCellRanges(A,d,b),A},c.prototype._stringRangesToCellRanges=function(n,h,_){var d=0,b=!1,g=0,A=n[d];if(A){for(var R=_;R<this._bufferService.cols;R++){var x=h.getWidth(R),k=h.getString(R).length||S.WHITESPACE_CELL_CHAR.length;if(x!==0){if(!b&&A[0]<=g&&(A[0]=R,b=!0),A[1]<=g){if(A[1]=R,!(A=n[++d]))break;A[0]<=g?(A[0]=R,b=!0):b=!1}g+=k}}A&&(A[1]=this._bufferService.cols)}},c._mergeRanges=function(n,h){for(var _=!1,d=0;d<n.length;d++){var b=n[d];if(_){if(h[1]<=b[0])return n[d-1][1]=h[1],n;if(h[1]<=b[1])return n[d-1][1]=Math.max(h[1],b[1]),n.splice(d,1),n;n.splice(d,1),d--}else{if(h[1]<=b[0])return n.splice(d,0,h),n;if(h[1]<=b[1])return b[0]=Math.min(h[0],b[0]),n;h[0]<b[1]&&(b[0]=Math.min(h[0],b[0]),_=!0)}}return _?n[n.length-1][1]=h[1]:n.push(h),n},c=f([m(0,v.IBufferService)],c)}();r.CharacterJoinerService=y},5114:(a,r)=>{Object.defineProperty(r,"__esModule",{value:!0}),r.CoreBrowserService=void 0;var u=function(){function o(l){this._textarea=l}return Object.defineProperty(o.prototype,"isFocused",{get:function(){return(this._textarea.getRootNode?this._textarea.getRootNode():document).activeElement===this._textarea&&document.hasFocus()},enumerable:!1,configurable:!0}),o}();r.CoreBrowserService=u},8934:function(a,r,u){var o=this&&this.__decorate||function(S,p,v,w){var y,c=arguments.length,n=c<3?p:w===null?w=Object.getOwnPropertyDescriptor(p,v):w;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")n=Reflect.decorate(S,p,v,w);else for(var h=S.length-1;h>=0;h--)(y=S[h])&&(n=(c<3?y(n):c>3?y(p,v,n):y(p,v))||n);return c>3&&n&&Object.defineProperty(p,v,n),n},l=this&&this.__param||function(S,p){return function(v,w){p(v,w,S)}};Object.defineProperty(r,"__esModule",{value:!0}),r.MouseService=void 0;var f=u(4725),m=u(9806),C=function(){function S(p,v){this._renderService=p,this._charSizeService=v}return S.prototype.getCoords=function(p,v,w,y,c){return(0,m.getCoords)(window,p,v,w,y,this._charSizeService.hasValidSize,this._renderService.dimensions.actualCellWidth,this._renderService.dimensions.actualCellHeight,c)},S.prototype.getRawByteCoords=function(p,v,w,y){var c=this.getCoords(p,v,w,y);return(0,m.getRawByteCoords)(c)},o([l(0,f.IRenderService),l(1,f.ICharSizeService)],S)}();r.MouseService=C},3230:function(a,r,u){var o,l=this&&this.__extends||(o=function(h,_){return o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var g in b)Object.prototype.hasOwnProperty.call(b,g)&&(d[g]=b[g])},o(h,_)},function(h,_){if(typeof _!="function"&&_!==null)throw new TypeError("Class extends value "+String(_)+" is not a constructor or null");function d(){this.constructor=h}o(h,_),h.prototype=_===null?Object.create(_):(d.prototype=_.prototype,new d)}),f=this&&this.__decorate||function(h,_,d,b){var g,A=arguments.length,R=A<3?_:b===null?b=Object.getOwnPropertyDescriptor(_,d):b;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")R=Reflect.decorate(h,_,d,b);else for(var x=h.length-1;x>=0;x--)(g=h[x])&&(R=(A<3?g(R):A>3?g(_,d,R):g(_,d))||R);return A>3&&R&&Object.defineProperty(_,d,R),R},m=this&&this.__param||function(h,_){return function(d,b){_(d,b,h)}};Object.defineProperty(r,"__esModule",{value:!0}),r.RenderService=void 0;var C=u(6193),S=u(8460),p=u(844),v=u(5596),w=u(3656),y=u(2585),c=u(4725),n=function(h){function _(d,b,g,A,R,x,k){var O=h.call(this)||this;if(O._renderer=d,O._rowCount=b,O._charSizeService=R,O._isPaused=!1,O._needsFullRefresh=!1,O._isNextRenderRedrawOnly=!0,O._needsSelectionRefresh=!1,O._canvasWidth=0,O._canvasHeight=0,O._selectionState={start:void 0,end:void 0,columnSelectMode:!1},O._onDimensionsChange=new S.EventEmitter,O._onRenderedViewportChange=new S.EventEmitter,O._onRender=new S.EventEmitter,O._onRefreshRequest=new S.EventEmitter,O.register({dispose:function(){return O._renderer.dispose()}}),O._renderDebouncer=new C.RenderDebouncer(function(T,P){return O._renderRows(T,P)}),O.register(O._renderDebouncer),O._screenDprMonitor=new v.ScreenDprMonitor,O._screenDprMonitor.setListener(function(){return O.onDevicePixelRatioChange()}),O.register(O._screenDprMonitor),O.register(k.onResize(function(){return O._fullRefresh()})),O.register(k.buffers.onBufferActivate(function(){var T;return(T=O._renderer)===null||T===void 0?void 0:T.clear()})),O.register(A.onOptionChange(function(){return O._handleOptionsChanged()})),O.register(O._charSizeService.onCharSizeChange(function(){return O.onCharSizeChanged()})),O.register(x.onDecorationRegistered(function(){return O._fullRefresh()})),O.register(x.onDecorationRemoved(function(){return O._fullRefresh()})),O._renderer.onRequestRedraw(function(T){return O.refreshRows(T.start,T.end,!0)}),O.register((0,w.addDisposableDomListener)(window,"resize",function(){return O.onDevicePixelRatioChange()})),"IntersectionObserver"in window){var I=new IntersectionObserver(function(T){return O._onIntersectionChange(T[T.length-1])},{threshold:0});I.observe(g),O.register({dispose:function(){return I.disconnect()}})}return O}return l(_,h),Object.defineProperty(_.prototype,"onDimensionsChange",{get:function(){return this._onDimensionsChange.event},enumerable:!1,configurable:!0}),Object.defineProperty(_.prototype,"onRenderedViewportChange",{get:function(){return this._onRenderedViewportChange.event},enumerable:!1,configurable:!0}),Object.defineProperty(_.prototype,"onRender",{get:function(){return this._onRender.event},enumerable:!1,configurable:!0}),Object.defineProperty(_.prototype,"onRefreshRequest",{get:function(){return this._onRefreshRequest.event},enumerable:!1,configurable:!0}),Object.defineProperty(_.prototype,"dimensions",{get:function(){return this._renderer.dimensions},enumerable:!1,configurable:!0}),_.prototype._onIntersectionChange=function(d){this._isPaused=d.isIntersecting===void 0?d.intersectionRatio===0:!d.isIntersecting,this._isPaused||this._charSizeService.hasValidSize||this._charSizeService.measure(),!this._isPaused&&this._needsFullRefresh&&(this.refreshRows(0,this._rowCount-1),this._needsFullRefresh=!1)},_.prototype.refreshRows=function(d,b,g){g===void 0&&(g=!1),this._isPaused?this._needsFullRefresh=!0:(g||(this._isNextRenderRedrawOnly=!1),this._renderDebouncer.refresh(d,b,this._rowCount))},_.prototype._renderRows=function(d,b){this._renderer.renderRows(d,b),this._needsSelectionRefresh&&(this._renderer.onSelectionChanged(this._selectionState.start,this._selectionState.end,this._selectionState.columnSelectMode),this._needsSelectionRefresh=!1),this._isNextRenderRedrawOnly||this._onRenderedViewportChange.fire({start:d,end:b}),this._onRender.fire({start:d,end:b}),this._isNextRenderRedrawOnly=!0},_.prototype.resize=function(d,b){this._rowCount=b,this._fireOnCanvasResize()},_.prototype._handleOptionsChanged=function(){this._renderer.onOptionsChanged(),this.refreshRows(0,this._rowCount-1),this._fireOnCanvasResize()},_.prototype._fireOnCanvasResize=function(){this._renderer.dimensions.canvasWidth===this._canvasWidth&&this._renderer.dimensions.canvasHeight===this._canvasHeight||this._onDimensionsChange.fire(this._renderer.dimensions)},_.prototype.dispose=function(){h.prototype.dispose.call(this)},_.prototype.setRenderer=function(d){var b=this;this._renderer.dispose(),this._renderer=d,this._renderer.onRequestRedraw(function(g){return b.refreshRows(g.start,g.end,!0)}),this._needsSelectionRefresh=!0,this._fullRefresh()},_.prototype.addRefreshCallback=function(d){return this._renderDebouncer.addRefreshCallback(d)},_.prototype._fullRefresh=function(){this._isPaused?this._needsFullRefresh=!0:this.refreshRows(0,this._rowCount-1)},_.prototype.clearTextureAtlas=function(){var d,b;(b=(d=this._renderer)===null||d===void 0?void 0:d.clearTextureAtlas)===null||b===void 0||b.call(d),this._fullRefresh()},_.prototype.setColors=function(d){this._renderer.setColors(d),this._fullRefresh()},_.prototype.onDevicePixelRatioChange=function(){this._charSizeService.measure(),this._renderer.onDevicePixelRatioChange(),this.refreshRows(0,this._rowCount-1)},_.prototype.onResize=function(d,b){this._renderer.onResize(d,b),this._fullRefresh()},_.prototype.onCharSizeChanged=function(){this._renderer.onCharSizeChanged()},_.prototype.onBlur=function(){this._renderer.onBlur()},_.prototype.onFocus=function(){this._renderer.onFocus()},_.prototype.onSelectionChanged=function(d,b,g){this._selectionState.start=d,this._selectionState.end=b,this._selectionState.columnSelectMode=g,this._renderer.onSelectionChanged(d,b,g)},_.prototype.onCursorMove=function(){this._renderer.onCursorMove()},_.prototype.clear=function(){this._renderer.clear()},f([m(3,y.IOptionsService),m(4,c.ICharSizeService),m(5,y.IDecorationService),m(6,y.IBufferService)],_)}(p.Disposable);r.RenderService=n},9312:function(a,r,u){var o,l=this&&this.__extends||(o=function(A,R){return o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(x,k){x.__proto__=k}||function(x,k){for(var O in k)Object.prototype.hasOwnProperty.call(k,O)&&(x[O]=k[O])},o(A,R)},function(A,R){if(typeof R!="function"&&R!==null)throw new TypeError("Class extends value "+String(R)+" is not a constructor or null");function x(){this.constructor=A}o(A,R),A.prototype=R===null?Object.create(R):(x.prototype=R.prototype,new x)}),f=this&&this.__decorate||function(A,R,x,k){var O,I=arguments.length,T=I<3?R:k===null?k=Object.getOwnPropertyDescriptor(R,x):k;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")T=Reflect.decorate(A,R,x,k);else for(var P=A.length-1;P>=0;P--)(O=A[P])&&(T=(I<3?O(T):I>3?O(R,x,T):O(R,x))||T);return I>3&&T&&Object.defineProperty(R,x,T),T},m=this&&this.__param||function(A,R){return function(x,k){R(x,k,A)}};Object.defineProperty(r,"__esModule",{value:!0}),r.SelectionService=void 0;var C=u(6114),S=u(456),p=u(511),v=u(8460),w=u(4725),y=u(2585),c=u(9806),n=u(9504),h=u(844),_=u(4841),d=String.fromCharCode(160),b=new RegExp(d,"g"),g=function(A){function R(x,k,O,I,T,P,M,D){var q=A.call(this)||this;return q._element=x,q._screenElement=k,q._linkifier=O,q._bufferService=I,q._coreService=T,q._mouseService=P,q._optionsService=M,q._renderService=D,q._dragScrollAmount=0,q._enabled=!0,q._workCell=new p.CellData,q._mouseDownTimeStamp=0,q._oldHasSelection=!1,q._oldSelectionStart=void 0,q._oldSelectionEnd=void 0,q._onLinuxMouseSelection=q.register(new v.EventEmitter),q._onRedrawRequest=q.register(new v.EventEmitter),q._onSelectionChange=q.register(new v.EventEmitter),q._onRequestScrollLines=q.register(new v.EventEmitter),q._mouseMoveListener=function(H){return q._onMouseMove(H)},q._mouseUpListener=function(H){return q._onMouseUp(H)},q._coreService.onUserInput(function(){q.hasSelection&&q.clearSelection()}),q._trimListener=q._bufferService.buffer.lines.onTrim(function(H){return q._onTrim(H)}),q.register(q._bufferService.buffers.onBufferActivate(function(H){return q._onBufferActivate(H)})),q.enable(),q._model=new S.SelectionModel(q._bufferService),q._activeSelectionMode=0,q}return l(R,A),Object.defineProperty(R.prototype,"onLinuxMouseSelection",{get:function(){return this._onLinuxMouseSelection.event},enumerable:!1,configurable:!0}),Object.defineProperty(R.prototype,"onRequestRedraw",{get:function(){return this._onRedrawRequest.event},enumerable:!1,configurable:!0}),Object.defineProperty(R.prototype,"onSelectionChange",{get:function(){return this._onSelectionChange.event},enumerable:!1,configurable:!0}),Object.defineProperty(R.prototype,"onRequestScrollLines",{get:function(){return this._onRequestScrollLines.event},enumerable:!1,configurable:!0}),R.prototype.dispose=function(){this._removeMouseDownListeners()},R.prototype.reset=function(){this.clearSelection()},R.prototype.disable=function(){this.clearSelection(),this._enabled=!1},R.prototype.enable=function(){this._enabled=!0},Object.defineProperty(R.prototype,"selectionStart",{get:function(){return this._model.finalSelectionStart},enumerable:!1,configurable:!0}),Object.defineProperty(R.prototype,"selectionEnd",{get:function(){return this._model.finalSelectionEnd},enumerable:!1,configurable:!0}),Object.defineProperty(R.prototype,"hasSelection",{get:function(){var x=this._model.finalSelectionStart,k=this._model.finalSelectionEnd;return!(!x||!k||x[0]===k[0]&&x[1]===k[1])},enumerable:!1,configurable:!0}),Object.defineProperty(R.prototype,"selectionText",{get:function(){var x=this._model.finalSelectionStart,k=this._model.finalSelectionEnd;if(!x||!k)return"";var O=this._bufferService.buffer,I=[];if(this._activeSelectionMode===3){if(x[0]===k[0])return"";for(var T=x[0]<k[0]?x[0]:k[0],P=x[0]<k[0]?k[0]:x[0],M=x[1];M<=k[1];M++){var D=O.translateBufferLineToString(M,!0,T,P);I.push(D)}}else{var q=x[1]===k[1]?k[0]:void 0;for(I.push(O.translateBufferLineToString(x[1],!0,x[0],q)),M=x[1]+1;M<=k[1]-1;M++){var H=O.lines.get(M);D=O.translateBufferLineToString(M,!0),H!=null&&H.isWrapped?I[I.length-1]+=D:I.push(D)}x[1]!==k[1]&&(H=O.lines.get(k[1]),D=O.translateBufferLineToString(k[1],!0,0,k[0]),H&&H.isWrapped?I[I.length-1]+=D:I.push(D))}return I.map(function(X){return X.replace(b," ")}).join(C.isWindows?`\r
`:`
`)},enumerable:!1,configurable:!0}),R.prototype.clearSelection=function(){this._model.clearSelection(),this._removeMouseDownListeners(),this.refresh(),this._onSelectionChange.fire()},R.prototype.refresh=function(x){var k=this;this._refreshAnimationFrame||(this._refreshAnimationFrame=window.requestAnimationFrame(function(){return k._refresh()})),C.isLinux&&x&&this.selectionText.length&&this._onLinuxMouseSelection.fire(this.selectionText)},R.prototype._refresh=function(){this._refreshAnimationFrame=void 0,this._onRedrawRequest.fire({start:this._model.finalSelectionStart,end:this._model.finalSelectionEnd,columnSelectMode:this._activeSelectionMode===3})},R.prototype._isClickInSelection=function(x){var k=this._getMouseBufferCoords(x),O=this._model.finalSelectionStart,I=this._model.finalSelectionEnd;return!!(O&&I&&k)&&this._areCoordsInSelection(k,O,I)},R.prototype.isCellInSelection=function(x,k){var O=this._model.finalSelectionStart,I=this._model.finalSelectionEnd;return!(!O||!I)&&this._areCoordsInSelection([x,k],O,I)},R.prototype._areCoordsInSelection=function(x,k,O){return x[1]>k[1]&&x[1]<O[1]||k[1]===O[1]&&x[1]===k[1]&&x[0]>=k[0]&&x[0]<O[0]||k[1]<O[1]&&x[1]===O[1]&&x[0]<O[0]||k[1]<O[1]&&x[1]===k[1]&&x[0]>=k[0]},R.prototype._selectWordAtCursor=function(x,k){var O,I,T=(I=(O=this._linkifier.currentLink)===null||O===void 0?void 0:O.link)===null||I===void 0?void 0:I.range;if(T)return this._model.selectionStart=[T.start.x-1,T.start.y-1],this._model.selectionStartLength=(0,_.getRangeLength)(T,this._bufferService.cols),this._model.selectionEnd=void 0,!0;var P=this._getMouseBufferCoords(x);return!!P&&(this._selectWordAt(P,k),this._model.selectionEnd=void 0,!0)},R.prototype.selectAll=function(){this._model.isSelectAllActive=!0,this.refresh(),this._onSelectionChange.fire()},R.prototype.selectLines=function(x,k){this._model.clearSelection(),x=Math.max(x,0),k=Math.min(k,this._bufferService.buffer.lines.length-1),this._model.selectionStart=[0,x],this._model.selectionEnd=[this._bufferService.cols,k],this.refresh(),this._onSelectionChange.fire()},R.prototype._onTrim=function(x){this._model.onTrim(x)&&this.refresh()},R.prototype._getMouseBufferCoords=function(x){var k=this._mouseService.getCoords(x,this._screenElement,this._bufferService.cols,this._bufferService.rows,!0);if(k)return k[0]--,k[1]--,k[1]+=this._bufferService.buffer.ydisp,k},R.prototype._getMouseEventScrollAmount=function(x){var k=(0,c.getCoordsRelativeToElement)(window,x,this._screenElement)[1],O=this._renderService.dimensions.canvasHeight;return k>=0&&k<=O?0:(k>O&&(k-=O),k=Math.min(Math.max(k,-50),50),(k/=50)/Math.abs(k)+Math.round(14*k))},R.prototype.shouldForceSelection=function(x){return C.isMac?x.altKey&&this._optionsService.rawOptions.macOptionClickForcesSelection:x.shiftKey},R.prototype.onMouseDown=function(x){if(this._mouseDownTimeStamp=x.timeStamp,(x.button!==2||!this.hasSelection)&&x.button===0){if(!this._enabled){if(!this.shouldForceSelection(x))return;x.stopPropagation()}x.preventDefault(),this._dragScrollAmount=0,this._enabled&&x.shiftKey?this._onIncrementalClick(x):x.detail===1?this._onSingleClick(x):x.detail===2?this._onDoubleClick(x):x.detail===3&&this._onTripleClick(x),this._addMouseDownListeners(),this.refresh(!0)}},R.prototype._addMouseDownListeners=function(){var x=this;this._screenElement.ownerDocument&&(this._screenElement.ownerDocument.addEventListener("mousemove",this._mouseMoveListener),this._screenElement.ownerDocument.addEventListener("mouseup",this._mouseUpListener)),this._dragScrollIntervalTimer=window.setInterval(function(){return x._dragScroll()},50)},R.prototype._removeMouseDownListeners=function(){this._screenElement.ownerDocument&&(this._screenElement.ownerDocument.removeEventListener("mousemove",this._mouseMoveListener),this._screenElement.ownerDocument.removeEventListener("mouseup",this._mouseUpListener)),clearInterval(this._dragScrollIntervalTimer),this._dragScrollIntervalTimer=void 0},R.prototype._onIncrementalClick=function(x){this._model.selectionStart&&(this._model.selectionEnd=this._getMouseBufferCoords(x))},R.prototype._onSingleClick=function(x){if(this._model.selectionStartLength=0,this._model.isSelectAllActive=!1,this._activeSelectionMode=this.shouldColumnSelect(x)?3:0,this._model.selectionStart=this._getMouseBufferCoords(x),this._model.selectionStart){this._model.selectionEnd=void 0;var k=this._bufferService.buffer.lines.get(this._model.selectionStart[1]);k&&k.length!==this._model.selectionStart[0]&&k.hasWidth(this._model.selectionStart[0])===0&&this._model.selectionStart[0]++}},R.prototype._onDoubleClick=function(x){this._selectWordAtCursor(x,!0)&&(this._activeSelectionMode=1)},R.prototype._onTripleClick=function(x){var k=this._getMouseBufferCoords(x);k&&(this._activeSelectionMode=2,this._selectLineAt(k[1]))},R.prototype.shouldColumnSelect=function(x){return x.altKey&&!(C.isMac&&this._optionsService.rawOptions.macOptionClickForcesSelection)},R.prototype._onMouseMove=function(x){if(x.stopImmediatePropagation(),this._model.selectionStart){var k=this._model.selectionEnd?[this._model.selectionEnd[0],this._model.selectionEnd[1]]:null;if(this._model.selectionEnd=this._getMouseBufferCoords(x),this._model.selectionEnd){this._activeSelectionMode===2?this._model.selectionEnd[1]<this._model.selectionStart[1]?this._model.selectionEnd[0]=0:this._model.selectionEnd[0]=this._bufferService.cols:this._activeSelectionMode===1&&this._selectToWordAt(this._model.selectionEnd),this._dragScrollAmount=this._getMouseEventScrollAmount(x),this._activeSelectionMode!==3&&(this._dragScrollAmount>0?this._model.selectionEnd[0]=this._bufferService.cols:this._dragScrollAmount<0&&(this._model.selectionEnd[0]=0));var O=this._bufferService.buffer;if(this._model.selectionEnd[1]<O.lines.length){var I=O.lines.get(this._model.selectionEnd[1]);I&&I.hasWidth(this._model.selectionEnd[0])===0&&this._model.selectionEnd[0]++}k&&k[0]===this._model.selectionEnd[0]&&k[1]===this._model.selectionEnd[1]||this.refresh(!0)}else this.refresh(!0)}},R.prototype._dragScroll=function(){if(this._model.selectionEnd&&this._model.selectionStart&&this._dragScrollAmount){this._onRequestScrollLines.fire({amount:this._dragScrollAmount,suppressScrollEvent:!1});var x=this._bufferService.buffer;this._dragScrollAmount>0?(this._activeSelectionMode!==3&&(this._model.selectionEnd[0]=this._bufferService.cols),this._model.selectionEnd[1]=Math.min(x.ydisp+this._bufferService.rows,x.lines.length-1)):(this._activeSelectionMode!==3&&(this._model.selectionEnd[0]=0),this._model.selectionEnd[1]=x.ydisp),this.refresh()}},R.prototype._onMouseUp=function(x){var k=x.timeStamp-this._mouseDownTimeStamp;if(this._removeMouseDownListeners(),this.selectionText.length<=1&&k<500&&x.altKey&&this._optionsService.getOption("altClickMovesCursor")){if(this._bufferService.buffer.ybase===this._bufferService.buffer.ydisp){var O=this._mouseService.getCoords(x,this._element,this._bufferService.cols,this._bufferService.rows,!1);if(O&&O[0]!==void 0&&O[1]!==void 0){var I=(0,n.moveToCellSequence)(O[0]-1,O[1]-1,this._bufferService,this._coreService.decPrivateModes.applicationCursorKeys);this._coreService.triggerDataEvent(I,!0)}}}else this._fireEventIfSelectionChanged()},R.prototype._fireEventIfSelectionChanged=function(){var x=this._model.finalSelectionStart,k=this._model.finalSelectionEnd,O=!(!x||!k||x[0]===k[0]&&x[1]===k[1]);O?x&&k&&(this._oldSelectionStart&&this._oldSelectionEnd&&x[0]===this._oldSelectionStart[0]&&x[1]===this._oldSelectionStart[1]&&k[0]===this._oldSelectionEnd[0]&&k[1]===this._oldSelectionEnd[1]||this._fireOnSelectionChange(x,k,O)):this._oldHasSelection&&this._fireOnSelectionChange(x,k,O)},R.prototype._fireOnSelectionChange=function(x,k,O){this._oldSelectionStart=x,this._oldSelectionEnd=k,this._oldHasSelection=O,this._onSelectionChange.fire()},R.prototype._onBufferActivate=function(x){var k=this;this.clearSelection(),this._trimListener.dispose(),this._trimListener=x.activeBuffer.lines.onTrim(function(O){return k._onTrim(O)})},R.prototype._convertViewportColToCharacterIndex=function(x,k){for(var O=k[0],I=0;k[0]>=I;I++){var T=x.loadCell(I,this._workCell).getChars().length;this._workCell.getWidth()===0?O--:T>1&&k[0]!==I&&(O+=T-1)}return O},R.prototype.setSelection=function(x,k,O){this._model.clearSelection(),this._removeMouseDownListeners(),this._model.selectionStart=[x,k],this._model.selectionStartLength=O,this.refresh(),this._fireEventIfSelectionChanged()},R.prototype.rightClickSelect=function(x){this._isClickInSelection(x)||(this._selectWordAtCursor(x,!1)&&this.refresh(!0),this._fireEventIfSelectionChanged())},R.prototype._getWordAt=function(x,k,O,I){if(O===void 0&&(O=!0),I===void 0&&(I=!0),!(x[0]>=this._bufferService.cols)){var T=this._bufferService.buffer,P=T.lines.get(x[1]);if(P){var M=T.translateBufferLineToString(x[1],!1),D=this._convertViewportColToCharacterIndex(P,x),q=D,H=x[0]-D,X=0,$=0,G=0,ie=0;if(M.charAt(D)===" "){for(;D>0&&M.charAt(D-1)===" ";)D--;for(;q<M.length&&M.charAt(q+1)===" ";)q++}else{var ee=x[0],B=x[0];P.getWidth(ee)===0&&(X++,ee--),P.getWidth(B)===2&&($++,B++);var pe=P.getString(B).length;for(pe>1&&(ie+=pe-1,q+=pe-1);ee>0&&D>0&&!this._isCharWordSeparator(P.loadCell(ee-1,this._workCell));){P.loadCell(ee-1,this._workCell);var de=this._workCell.getChars().length;this._workCell.getWidth()===0?(X++,ee--):de>1&&(G+=de-1,D-=de-1),D--,ee--}for(;B<P.length&&q+1<M.length&&!this._isCharWordSeparator(P.loadCell(B+1,this._workCell));){P.loadCell(B+1,this._workCell);var Oe=this._workCell.getChars().length;this._workCell.getWidth()===2?($++,B++):Oe>1&&(ie+=Oe-1,q+=Oe-1),q++,B++}}q++;var N=D+H-X+G,xe=Math.min(this._bufferService.cols,q-D+X+$-G-ie);if(k||M.slice(D,q).trim()!==""){if(O&&N===0&&P.getCodePoint(0)!==32){var le=T.lines.get(x[1]-1);if(le&&P.isWrapped&&le.getCodePoint(this._bufferService.cols-1)!==32){var K=this._getWordAt([this._bufferService.cols-1,x[1]-1],!1,!0,!1);if(K){var F=this._bufferService.cols-K.start;N-=F,xe+=F}}}if(I&&N+xe===this._bufferService.cols&&P.getCodePoint(this._bufferService.cols-1)!==32){var U=T.lines.get(x[1]+1);if(U!=null&&U.isWrapped&&U.getCodePoint(0)!==32){var W=this._getWordAt([0,x[1]+1],!1,!1,!0);W&&(xe+=W.length)}}return{start:N,length:xe}}}}},R.prototype._selectWordAt=function(x,k){var O=this._getWordAt(x,k);if(O){for(;O.start<0;)O.start+=this._bufferService.cols,x[1]--;this._model.selectionStart=[O.start,x[1]],this._model.selectionStartLength=O.length}},R.prototype._selectToWordAt=function(x){var k=this._getWordAt(x,!0);if(k){for(var O=x[1];k.start<0;)k.start+=this._bufferService.cols,O--;if(!this._model.areSelectionValuesReversed())for(;k.start+k.length>this._bufferService.cols;)k.length-=this._bufferService.cols,O++;this._model.selectionEnd=[this._model.areSelectionValuesReversed()?k.start:k.start+k.length,O]}},R.prototype._isCharWordSeparator=function(x){return x.getWidth()!==0&&this._optionsService.rawOptions.wordSeparator.indexOf(x.getChars())>=0},R.prototype._selectLineAt=function(x){var k=this._bufferService.buffer.getWrappedRangeForLine(x),O={start:{x:0,y:k.first},end:{x:this._bufferService.cols-1,y:k.last}};this._model.selectionStart=[0,k.first],this._model.selectionEnd=void 0,this._model.selectionStartLength=(0,_.getRangeLength)(O,this._bufferService.cols)},f([m(3,y.IBufferService),m(4,y.ICoreService),m(5,w.IMouseService),m(6,y.IOptionsService),m(7,w.IRenderService)],R)}(h.Disposable);r.SelectionService=g},4725:(a,r,u)=>{Object.defineProperty(r,"__esModule",{value:!0}),r.ICharacterJoinerService=r.ISoundService=r.ISelectionService=r.IRenderService=r.IMouseService=r.ICoreBrowserService=r.ICharSizeService=void 0;var o=u(8343);r.ICharSizeService=(0,o.createDecorator)("CharSizeService"),r.ICoreBrowserService=(0,o.createDecorator)("CoreBrowserService"),r.IMouseService=(0,o.createDecorator)("MouseService"),r.IRenderService=(0,o.createDecorator)("RenderService"),r.ISelectionService=(0,o.createDecorator)("SelectionService"),r.ISoundService=(0,o.createDecorator)("SoundService"),r.ICharacterJoinerService=(0,o.createDecorator)("CharacterJoinerService")},357:function(a,r,u){var o=this&&this.__decorate||function(C,S,p,v){var w,y=arguments.length,c=y<3?S:v===null?v=Object.getOwnPropertyDescriptor(S,p):v;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")c=Reflect.decorate(C,S,p,v);else for(var n=C.length-1;n>=0;n--)(w=C[n])&&(c=(y<3?w(c):y>3?w(S,p,c):w(S,p))||c);return y>3&&c&&Object.defineProperty(S,p,c),c},l=this&&this.__param||function(C,S){return function(p,v){S(p,v,C)}};Object.defineProperty(r,"__esModule",{value:!0}),r.SoundService=void 0;var f=u(2585),m=function(){function C(S){this._optionsService=S}return Object.defineProperty(C,"audioContext",{get:function(){if(!C._audioContext){var S=window.AudioContext||window.webkitAudioContext;if(!S)return console.warn("Web Audio API is not supported by this browser. Consider upgrading to the latest version"),null;C._audioContext=new S}return C._audioContext},enumerable:!1,configurable:!0}),C.prototype.playBellSound=function(){var S=C.audioContext;if(S){var p=S.createBufferSource();S.decodeAudioData(this._base64ToArrayBuffer(this._removeMimeType(this._optionsService.rawOptions.bellSound)),function(v){p.buffer=v,p.connect(S.destination),p.start(0)})}},C.prototype._base64ToArrayBuffer=function(S){for(var p=window.atob(S),v=p.length,w=new Uint8Array(v),y=0;y<v;y++)w[y]=p.charCodeAt(y);return w.buffer},C.prototype._removeMimeType=function(S){return S.split(",")[1]},C=o([l(0,f.IOptionsService)],C)}();r.SoundService=m},6349:(a,r,u)=>{Object.defineProperty(r,"__esModule",{value:!0}),r.CircularList=void 0;var o=u(8460),l=function(){function f(m){this._maxLength=m,this.onDeleteEmitter=new o.EventEmitter,this.onInsertEmitter=new o.EventEmitter,this.onTrimEmitter=new o.EventEmitter,this._array=new Array(this._maxLength),this._startIndex=0,this._length=0}return Object.defineProperty(f.prototype,"onDelete",{get:function(){return this.onDeleteEmitter.event},enumerable:!1,configurable:!0}),Object.defineProperty(f.prototype,"onInsert",{get:function(){return this.onInsertEmitter.event},enumerable:!1,configurable:!0}),Object.defineProperty(f.prototype,"onTrim",{get:function(){return this.onTrimEmitter.event},enumerable:!1,configurable:!0}),Object.defineProperty(f.prototype,"maxLength",{get:function(){return this._maxLength},set:function(m){if(this._maxLength!==m){for(var C=new Array(m),S=0;S<Math.min(m,this.length);S++)C[S]=this._array[this._getCyclicIndex(S)];this._array=C,this._maxLength=m,this._startIndex=0}},enumerable:!1,configurable:!0}),Object.defineProperty(f.prototype,"length",{get:function(){return this._length},set:function(m){if(m>this._length)for(var C=this._length;C<m;C++)this._array[C]=void 0;this._length=m},enumerable:!1,configurable:!0}),f.prototype.get=function(m){return this._array[this._getCyclicIndex(m)]},f.prototype.set=function(m,C){this._array[this._getCyclicIndex(m)]=C},f.prototype.push=function(m){this._array[this._getCyclicIndex(this._length)]=m,this._length===this._maxLength?(this._startIndex=++this._startIndex%this._maxLength,this.onTrimEmitter.fire(1)):this._length++},f.prototype.recycle=function(){if(this._length!==this._maxLength)throw new Error("Can only recycle when the buffer is full");return this._startIndex=++this._startIndex%this._maxLength,this.onTrimEmitter.fire(1),this._array[this._getCyclicIndex(this._length-1)]},Object.defineProperty(f.prototype,"isFull",{get:function(){return this._length===this._maxLength},enumerable:!1,configurable:!0}),f.prototype.pop=function(){return this._array[this._getCyclicIndex(this._length---1)]},f.prototype.splice=function(m,C){for(var S=[],p=2;p<arguments.length;p++)S[p-2]=arguments[p];if(C){for(var v=m;v<this._length-C;v++)this._array[this._getCyclicIndex(v)]=this._array[this._getCyclicIndex(v+C)];this._length-=C,this.onDeleteEmitter.fire({index:m,amount:C})}for(v=this._length-1;v>=m;v--)this._array[this._getCyclicIndex(v+S.length)]=this._array[this._getCyclicIndex(v)];for(v=0;v<S.length;v++)this._array[this._getCyclicIndex(m+v)]=S[v];if(S.length&&this.onInsertEmitter.fire({index:m,amount:S.length}),this._length+S.length>this._maxLength){var w=this._length+S.length-this._maxLength;this._startIndex+=w,this._length=this._maxLength,this.onTrimEmitter.fire(w)}else this._length+=S.length},f.prototype.trimStart=function(m){m>this._length&&(m=this._length),this._startIndex+=m,this._length-=m,this.onTrimEmitter.fire(m)},f.prototype.shiftElements=function(m,C,S){if(!(C<=0)){if(m<0||m>=this._length)throw new Error("start argument out of range");if(m+S<0)throw new Error("Cannot shift elements in list beyond index 0");if(S>0){for(var p=C-1;p>=0;p--)this.set(m+p+S,this.get(m+p));var v=m+C+S-this._length;if(v>0)for(this._length+=v;this._length>this._maxLength;)this._length--,this._startIndex++,this.onTrimEmitter.fire(1)}else for(p=0;p<C;p++)this.set(m+p+S,this.get(m+p))}},f.prototype._getCyclicIndex=function(m){return(this._startIndex+m)%this._maxLength},f}();r.CircularList=l},1439:(a,r)=>{Object.defineProperty(r,"__esModule",{value:!0}),r.clone=void 0,r.clone=function u(o,l){if(l===void 0&&(l=5),typeof o!="object")return o;var f=Array.isArray(o)?[]:{};for(var m in o)f[m]=l<=1?o[m]:o[m]&&u(o[m],l-1);return f}},8055:function(a,r){var u,o,l,f,m=this&&this.__read||function(p,v){var w=typeof Symbol=="function"&&p[Symbol.iterator];if(!w)return p;var y,c,n=w.call(p),h=[];try{for(;(v===void 0||v-- >0)&&!(y=n.next()).done;)h.push(y.value)}catch(_){c={error:_}}finally{try{y&&!y.done&&(w=n.return)&&w.call(n)}finally{if(c)throw c.error}}return h};function C(p){var v=p.toString(16);return v.length<2?"0"+v:v}function S(p,v){return p<v?(v+.05)/(p+.05):(p+.05)/(v+.05)}Object.defineProperty(r,"__esModule",{value:!0}),r.contrastRatio=r.toPaddedHex=r.rgba=r.rgb=r.css=r.color=r.channels=void 0,function(p){p.toCss=function(v,w,y,c){return c!==void 0?"#"+C(v)+C(w)+C(y)+C(c):"#"+C(v)+C(w)+C(y)},p.toRgba=function(v,w,y,c){return c===void 0&&(c=255),(v<<24|w<<16|y<<8|c)>>>0}}(u=r.channels||(r.channels={})),(o=r.color||(r.color={})).blend=function(p,v){var w=(255&v.rgba)/255;if(w===1)return{css:v.css,rgba:v.rgba};var y=v.rgba>>24&255,c=v.rgba>>16&255,n=v.rgba>>8&255,h=p.rgba>>24&255,_=p.rgba>>16&255,d=p.rgba>>8&255,b=h+Math.round((y-h)*w),g=_+Math.round((c-_)*w),A=d+Math.round((n-d)*w);return{css:u.toCss(b,g,A),rgba:u.toRgba(b,g,A)}},o.isOpaque=function(p){return(255&p.rgba)==255},o.ensureContrastRatio=function(p,v,w){var y=f.ensureContrastRatio(p.rgba,v.rgba,w);if(y)return f.toColor(y>>24&255,y>>16&255,y>>8&255)},o.opaque=function(p){var v=(255|p.rgba)>>>0,w=m(f.toChannels(v),3),y=w[0],c=w[1],n=w[2];return{css:u.toCss(y,c,n),rgba:v}},o.opacity=function(p,v){var w=Math.round(255*v),y=m(f.toChannels(p.rgba),3),c=y[0],n=y[1],h=y[2];return{css:u.toCss(c,n,h,w),rgba:u.toRgba(c,n,h,w)}},o.toColorRGB=function(p){return[p.rgba>>24&255,p.rgba>>16&255,p.rgba>>8&255]},(r.css||(r.css={})).toColor=function(p){if(p.match(/#[0-9a-f]{3,8}/i))switch(p.length){case 4:var v=parseInt(p.slice(1,2).repeat(2),16),w=parseInt(p.slice(2,3).repeat(2),16),y=parseInt(p.slice(3,4).repeat(2),16);return f.toColor(v,w,y);case 5:v=parseInt(p.slice(1,2).repeat(2),16),w=parseInt(p.slice(2,3).repeat(2),16),y=parseInt(p.slice(3,4).repeat(2),16);var c=parseInt(p.slice(4,5).repeat(2),16);return f.toColor(v,w,y,c);case 7:return{css:p,rgba:(parseInt(p.slice(1),16)<<8|255)>>>0};case 9:return{css:p,rgba:parseInt(p.slice(1),16)>>>0}}var n=p.match(/rgba?\(\s*(\d{1,3})\s*,\s*(\d{1,3})\s*,\s*(\d{1,3})\s*(,\s*(0|1|\d?\.(\d+))\s*)?\)/);if(n)return v=parseInt(n[1]),w=parseInt(n[2]),y=parseInt(n[3]),c=Math.round(255*(n[5]===void 0?1:parseFloat(n[5]))),f.toColor(v,w,y,c);throw new Error("css.toColor: Unsupported css format")},function(p){function v(w,y,c){var n=w/255,h=y/255,_=c/255;return .2126*(n<=.03928?n/12.92:Math.pow((n+.055)/1.055,2.4))+.7152*(h<=.03928?h/12.92:Math.pow((h+.055)/1.055,2.4))+.0722*(_<=.03928?_/12.92:Math.pow((_+.055)/1.055,2.4))}p.relativeLuminance=function(w){return v(w>>16&255,w>>8&255,255&w)},p.relativeLuminance2=v}(l=r.rgb||(r.rgb={})),function(p){function v(y,c,n){for(var h=y>>24&255,_=y>>16&255,d=y>>8&255,b=c>>24&255,g=c>>16&255,A=c>>8&255,R=S(l.relativeLuminance2(b,g,A),l.relativeLuminance2(h,_,d));R<n&&(b>0||g>0||A>0);)b-=Math.max(0,Math.ceil(.1*b)),g-=Math.max(0,Math.ceil(.1*g)),A-=Math.max(0,Math.ceil(.1*A)),R=S(l.relativeLuminance2(b,g,A),l.relativeLuminance2(h,_,d));return(b<<24|g<<16|A<<8|255)>>>0}function w(y,c,n){for(var h=y>>24&255,_=y>>16&255,d=y>>8&255,b=c>>24&255,g=c>>16&255,A=c>>8&255,R=S(l.relativeLuminance2(b,g,A),l.relativeLuminance2(h,_,d));R<n&&(b<255||g<255||A<255);)b=Math.min(255,b+Math.ceil(.1*(255-b))),g=Math.min(255,g+Math.ceil(.1*(255-g))),A=Math.min(255,A+Math.ceil(.1*(255-A))),R=S(l.relativeLuminance2(b,g,A),l.relativeLuminance2(h,_,d));return(b<<24|g<<16|A<<8|255)>>>0}p.ensureContrastRatio=function(y,c,n){var h=l.relativeLuminance(y>>8),_=l.relativeLuminance(c>>8);if(S(h,_)<n){if(_<h){var d=v(y,c,n),b=S(h,l.relativeLuminance(d>>8));if(b<n){var g=w(y,y,n);return b>S(h,l.relativeLuminance(g>>8))?d:g}return d}var A=w(y,c,n),R=S(h,l.relativeLuminance(A>>8));return R<n?(g=v(y,y,n),R>S(h,l.relativeLuminance(g>>8))?A:g):A}},p.reduceLuminance=v,p.increaseLuminance=w,p.toChannels=function(y){return[y>>24&255,y>>16&255,y>>8&255,255&y]},p.toColor=function(y,c,n,h){return{css:u.toCss(y,c,n,h),rgba:u.toRgba(y,c,n,h)}}}(f=r.rgba||(r.rgba={})),r.toPaddedHex=C,r.contrastRatio=S},8969:function(a,r,u){var o,l=this&&this.__extends||(o=function(k,O){return o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(I,T){I.__proto__=T}||function(I,T){for(var P in T)Object.prototype.hasOwnProperty.call(T,P)&&(I[P]=T[P])},o(k,O)},function(k,O){if(typeof O!="function"&&O!==null)throw new TypeError("Class extends value "+String(O)+" is not a constructor or null");function I(){this.constructor=k}o(k,O),k.prototype=O===null?Object.create(O):(I.prototype=O.prototype,new I)}),f=this&&this.__values||function(k){var O=typeof Symbol=="function"&&Symbol.iterator,I=O&&k[O],T=0;if(I)return I.call(k);if(k&&typeof k.length=="number")return{next:function(){return k&&T>=k.length&&(k=void 0),{value:k&&k[T++],done:!k}}};throw new TypeError(O?"Object is not iterable.":"Symbol.iterator is not defined.")};Object.defineProperty(r,"__esModule",{value:!0}),r.CoreTerminal=void 0;var m=u(844),C=u(2585),S=u(4348),p=u(7866),v=u(744),w=u(7302),y=u(6975),c=u(8460),n=u(1753),h=u(3730),_=u(1480),d=u(7994),b=u(9282),g=u(5435),A=u(5981),R=!1,x=function(k){function O(I){var T=k.call(this)||this;return T._onBinary=new c.EventEmitter,T._onData=new c.EventEmitter,T._onLineFeed=new c.EventEmitter,T._onResize=new c.EventEmitter,T._onScroll=new c.EventEmitter,T._onWriteParsed=new c.EventEmitter,T._instantiationService=new S.InstantiationService,T.optionsService=new w.OptionsService(I),T._instantiationService.setService(C.IOptionsService,T.optionsService),T._bufferService=T.register(T._instantiationService.createInstance(v.BufferService)),T._instantiationService.setService(C.IBufferService,T._bufferService),T._logService=T._instantiationService.createInstance(p.LogService),T._instantiationService.setService(C.ILogService,T._logService),T.coreService=T.register(T._instantiationService.createInstance(y.CoreService,function(){return T.scrollToBottom()})),T._instantiationService.setService(C.ICoreService,T.coreService),T.coreMouseService=T._instantiationService.createInstance(n.CoreMouseService),T._instantiationService.setService(C.ICoreMouseService,T.coreMouseService),T._dirtyRowService=T._instantiationService.createInstance(h.DirtyRowService),T._instantiationService.setService(C.IDirtyRowService,T._dirtyRowService),T.unicodeService=T._instantiationService.createInstance(_.UnicodeService),T._instantiationService.setService(C.IUnicodeService,T.unicodeService),T._charsetService=T._instantiationService.createInstance(d.CharsetService),T._instantiationService.setService(C.ICharsetService,T._charsetService),T._inputHandler=new g.InputHandler(T._bufferService,T._charsetService,T.coreService,T._dirtyRowService,T._logService,T.optionsService,T.coreMouseService,T.unicodeService),T.register((0,c.forwardEvent)(T._inputHandler.onLineFeed,T._onLineFeed)),T.register(T._inputHandler),T.register((0,c.forwardEvent)(T._bufferService.onResize,T._onResize)),T.register((0,c.forwardEvent)(T.coreService.onData,T._onData)),T.register((0,c.forwardEvent)(T.coreService.onBinary,T._onBinary)),T.register(T.optionsService.onOptionChange(function(P){return T._updateOptions(P)})),T.register(T._bufferService.onScroll(function(P){T._onScroll.fire({position:T._bufferService.buffer.ydisp,source:0}),T._dirtyRowService.markRangeDirty(T._bufferService.buffer.scrollTop,T._bufferService.buffer.scrollBottom)})),T.register(T._inputHandler.onScroll(function(P){T._onScroll.fire({position:T._bufferService.buffer.ydisp,source:0}),T._dirtyRowService.markRangeDirty(T._bufferService.buffer.scrollTop,T._bufferService.buffer.scrollBottom)})),T._writeBuffer=new A.WriteBuffer(function(P,M){return T._inputHandler.parse(P,M)}),T.register((0,c.forwardEvent)(T._writeBuffer.onWriteParsed,T._onWriteParsed)),T}return l(O,k),Object.defineProperty(O.prototype,"onBinary",{get:function(){return this._onBinary.event},enumerable:!1,configurable:!0}),Object.defineProperty(O.prototype,"onData",{get:function(){return this._onData.event},enumerable:!1,configurable:!0}),Object.defineProperty(O.prototype,"onLineFeed",{get:function(){return this._onLineFeed.event},enumerable:!1,configurable:!0}),Object.defineProperty(O.prototype,"onResize",{get:function(){return this._onResize.event},enumerable:!1,configurable:!0}),Object.defineProperty(O.prototype,"onWriteParsed",{get:function(){return this._onWriteParsed.event},enumerable:!1,configurable:!0}),Object.defineProperty(O.prototype,"onScroll",{get:function(){var I=this;return this._onScrollApi||(this._onScrollApi=new c.EventEmitter,this.register(this._onScroll.event(function(T){var P;(P=I._onScrollApi)===null||P===void 0||P.fire(T.position)}))),this._onScrollApi.event},enumerable:!1,configurable:!0}),Object.defineProperty(O.prototype,"cols",{get:function(){return this._bufferService.cols},enumerable:!1,configurable:!0}),Object.defineProperty(O.prototype,"rows",{get:function(){return this._bufferService.rows},enumerable:!1,configurable:!0}),Object.defineProperty(O.prototype,"buffers",{get:function(){return this._bufferService.buffers},enumerable:!1,configurable:!0}),Object.defineProperty(O.prototype,"options",{get:function(){return this.optionsService.options},set:function(I){for(var T in I)this.optionsService.options[T]=I[T]},enumerable:!1,configurable:!0}),O.prototype.dispose=function(){var I;this._isDisposed||(k.prototype.dispose.call(this),(I=this._windowsMode)===null||I===void 0||I.dispose(),this._windowsMode=void 0)},O.prototype.write=function(I,T){this._writeBuffer.write(I,T)},O.prototype.writeSync=function(I,T){this._logService.logLevel<=C.LogLevelEnum.WARN&&!R&&(this._logService.warn("writeSync is unreliable and will be removed soon."),R=!0),this._writeBuffer.writeSync(I,T)},O.prototype.resize=function(I,T){isNaN(I)||isNaN(T)||(I=Math.max(I,v.MINIMUM_COLS),T=Math.max(T,v.MINIMUM_ROWS),this._bufferService.resize(I,T))},O.prototype.scroll=function(I,T){T===void 0&&(T=!1),this._bufferService.scroll(I,T)},O.prototype.scrollLines=function(I,T,P){this._bufferService.scrollLines(I,T,P)},O.prototype.scrollPages=function(I){this._bufferService.scrollPages(I)},O.prototype.scrollToTop=function(){this._bufferService.scrollToTop()},O.prototype.scrollToBottom=function(){this._bufferService.scrollToBottom()},O.prototype.scrollToLine=function(I){this._bufferService.scrollToLine(I)},O.prototype.registerEscHandler=function(I,T){return this._inputHandler.registerEscHandler(I,T)},O.prototype.registerDcsHandler=function(I,T){return this._inputHandler.registerDcsHandler(I,T)},O.prototype.registerCsiHandler=function(I,T){return this._inputHandler.registerCsiHandler(I,T)},O.prototype.registerOscHandler=function(I,T){return this._inputHandler.registerOscHandler(I,T)},O.prototype._setup=function(){this.optionsService.rawOptions.windowsMode&&this._enableWindowsMode()},O.prototype.reset=function(){this._inputHandler.reset(),this._bufferService.reset(),this._charsetService.reset(),this.coreService.reset(),this.coreMouseService.reset()},O.prototype._updateOptions=function(I){var T;switch(I){case"scrollback":this.buffers.resize(this.cols,this.rows);break;case"windowsMode":this.optionsService.rawOptions.windowsMode?this._enableWindowsMode():((T=this._windowsMode)===null||T===void 0||T.dispose(),this._windowsMode=void 0)}},O.prototype._enableWindowsMode=function(){var I=this;if(!this._windowsMode){var T=[];T.push(this.onLineFeed(b.updateWindowsModeWrappedState.bind(null,this._bufferService))),T.push(this.registerCsiHandler({final:"H"},function(){return(0,b.updateWindowsModeWrappedState)(I._bufferService),!1})),this._windowsMode={dispose:function(){var P,M;try{for(var D=f(T),q=D.next();!q.done;q=D.next())q.value.dispose()}catch(H){P={error:H}}finally{try{q&&!q.done&&(M=D.return)&&M.call(D)}finally{if(P)throw P.error}}}}}},O}(m.Disposable);r.CoreTerminal=x},8460:(a,r)=>{Object.defineProperty(r,"__esModule",{value:!0}),r.forwardEvent=r.EventEmitter=void 0;var u=function(){function o(){this._listeners=[],this._disposed=!1}return Object.defineProperty(o.prototype,"event",{get:function(){var l=this;return this._event||(this._event=function(f){return l._listeners.push(f),{dispose:function(){if(!l._disposed){for(var m=0;m<l._listeners.length;m++)if(l._listeners[m]===f)return void l._listeners.splice(m,1)}}}}),this._event},enumerable:!1,configurable:!0}),o.prototype.fire=function(l,f){for(var m=[],C=0;C<this._listeners.length;C++)m.push(this._listeners[C]);for(C=0;C<m.length;C++)m[C].call(void 0,l,f)},o.prototype.dispose=function(){this._listeners&&(this._listeners.length=0),this._disposed=!0},o}();r.EventEmitter=u,r.forwardEvent=function(o,l){return o(function(f){return l.fire(f)})}},5435:function(a,r,u){var o,l=this&&this.__extends||(o=function(T,P){return o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(M,D){M.__proto__=D}||function(M,D){for(var q in D)Object.prototype.hasOwnProperty.call(D,q)&&(M[q]=D[q])},o(T,P)},function(T,P){if(typeof P!="function"&&P!==null)throw new TypeError("Class extends value "+String(P)+" is not a constructor or null");function M(){this.constructor=T}o(T,P),T.prototype=P===null?Object.create(P):(M.prototype=P.prototype,new M)});Object.defineProperty(r,"__esModule",{value:!0}),r.InputHandler=r.WindowsOptionsReportType=void 0;var f,m=u(2584),C=u(7116),S=u(2015),p=u(844),v=u(8273),w=u(482),y=u(8437),c=u(8460),n=u(643),h=u(511),_=u(3734),d=u(2585),b=u(6242),g=u(6351),A=u(5941),R={"(":0,")":1,"*":2,"+":3,"-":1,".":2},x=131072;function k(T,P){if(T>24)return P.setWinLines||!1;switch(T){case 1:return!!P.restoreWin;case 2:return!!P.minimizeWin;case 3:return!!P.setWinPosition;case 4:return!!P.setWinSizePixels;case 5:return!!P.raiseWin;case 6:return!!P.lowerWin;case 7:return!!P.refreshWin;case 8:return!!P.setWinSizeChars;case 9:return!!P.maximizeWin;case 10:return!!P.fullscreenWin;case 11:return!!P.getWinState;case 13:return!!P.getWinPosition;case 14:return!!P.getWinSizePixels;case 15:return!!P.getScreenSizePixels;case 16:return!!P.getCellSizePixels;case 18:return!!P.getWinSizeChars;case 19:return!!P.getScreenSizeChars;case 20:return!!P.getIconTitle;case 21:return!!P.getWinTitle;case 22:return!!P.pushTitle;case 23:return!!P.popTitle;case 24:return!!P.setWinLines}return!1}(function(T){T[T.GET_WIN_SIZE_PIXELS=0]="GET_WIN_SIZE_PIXELS",T[T.GET_CELL_SIZE_PIXELS=1]="GET_CELL_SIZE_PIXELS"})(f=r.WindowsOptionsReportType||(r.WindowsOptionsReportType={}));var O=function(){function T(P,M,D,q){this._bufferService=P,this._coreService=M,this._logService=D,this._optionsService=q,this._data=new Uint32Array(0)}return T.prototype.hook=function(P){this._data=new Uint32Array(0)},T.prototype.put=function(P,M,D){this._data=(0,v.concat)(this._data,P.subarray(M,D))},T.prototype.unhook=function(P){if(!P)return this._data=new Uint32Array(0),!0;var M=(0,w.utf32ToString)(this._data);switch(this._data=new Uint32Array(0),M){case'"q':this._coreService.triggerDataEvent(m.C0.ESC+'P1$r0"q'+m.C0.ESC+"\\");break;case'"p':this._coreService.triggerDataEvent(m.C0.ESC+'P1$r61;1"p'+m.C0.ESC+"\\");break;case"r":var D=this._bufferService.buffer.scrollTop+1+";"+(this._bufferService.buffer.scrollBottom+1)+"r";this._coreService.triggerDataEvent(m.C0.ESC+"P1$r"+D+m.C0.ESC+"\\");break;case"m":this._coreService.triggerDataEvent(m.C0.ESC+"P1$r0m"+m.C0.ESC+"\\");break;case" q":var q={block:2,underline:4,bar:6}[this._optionsService.rawOptions.cursorStyle];q-=this._optionsService.rawOptions.cursorBlink?1:0,this._coreService.triggerDataEvent(m.C0.ESC+"P1$r"+q+" q"+m.C0.ESC+"\\");break;default:this._logService.debug("Unknown DCS $q %s",M),this._coreService.triggerDataEvent(m.C0.ESC+"P0$r"+m.C0.ESC+"\\")}return!0},T}(),I=function(T){function P(M,D,q,H,X,$,G,ie,ee){ee===void 0&&(ee=new S.EscapeSequenceParser);var B=T.call(this)||this;B._bufferService=M,B._charsetService=D,B._coreService=q,B._dirtyRowService=H,B._logService=X,B._optionsService=$,B._coreMouseService=G,B._unicodeService=ie,B._parser=ee,B._parseBuffer=new Uint32Array(4096),B._stringDecoder=new w.StringToUtf32,B._utf8Decoder=new w.Utf8ToUtf32,B._workCell=new h.CellData,B._windowTitle="",B._iconName="",B._windowTitleStack=[],B._iconNameStack=[],B._curAttrData=y.DEFAULT_ATTR_DATA.clone(),B._eraseAttrDataInternal=y.DEFAULT_ATTR_DATA.clone(),B._onRequestBell=new c.EventEmitter,B._onRequestRefreshRows=new c.EventEmitter,B._onRequestReset=new c.EventEmitter,B._onRequestSendFocus=new c.EventEmitter,B._onRequestSyncScrollBar=new c.EventEmitter,B._onRequestWindowsOptionsReport=new c.EventEmitter,B._onA11yChar=new c.EventEmitter,B._onA11yTab=new c.EventEmitter,B._onCursorMove=new c.EventEmitter,B._onLineFeed=new c.EventEmitter,B._onScroll=new c.EventEmitter,B._onTitleChange=new c.EventEmitter,B._onColor=new c.EventEmitter,B._parseStack={paused:!1,cursorStartX:0,cursorStartY:0,decodedLength:0,position:0},B._specialColors=[256,257,258],B.register(B._parser),B._activeBuffer=B._bufferService.buffer,B.register(B._bufferService.buffers.onBufferActivate(function(N){return B._activeBuffer=N.activeBuffer})),B._parser.setCsiHandlerFallback(function(N,xe){B._logService.debug("Unknown CSI code: ",{identifier:B._parser.identToString(N),params:xe.toArray()})}),B._parser.setEscHandlerFallback(function(N){B._logService.debug("Unknown ESC code: ",{identifier:B._parser.identToString(N)})}),B._parser.setExecuteHandlerFallback(function(N){B._logService.debug("Unknown EXECUTE code: ",{code:N})}),B._parser.setOscHandlerFallback(function(N,xe,le){B._logService.debug("Unknown OSC code: ",{identifier:N,action:xe,data:le})}),B._parser.setDcsHandlerFallback(function(N,xe,le){xe==="HOOK"&&(le=le.toArray()),B._logService.debug("Unknown DCS code: ",{identifier:B._parser.identToString(N),action:xe,payload:le})}),B._parser.setPrintHandler(function(N,xe,le){return B.print(N,xe,le)}),B._parser.registerCsiHandler({final:"@"},function(N){return B.insertChars(N)}),B._parser.registerCsiHandler({intermediates:" ",final:"@"},function(N){return B.scrollLeft(N)}),B._parser.registerCsiHandler({final:"A"},function(N){return B.cursorUp(N)}),B._parser.registerCsiHandler({intermediates:" ",final:"A"},function(N){return B.scrollRight(N)}),B._parser.registerCsiHandler({final:"B"},function(N){return B.cursorDown(N)}),B._parser.registerCsiHandler({final:"C"},function(N){return B.cursorForward(N)}),B._parser.registerCsiHandler({final:"D"},function(N){return B.cursorBackward(N)}),B._parser.registerCsiHandler({final:"E"},function(N){return B.cursorNextLine(N)}),B._parser.registerCsiHandler({final:"F"},function(N){return B.cursorPrecedingLine(N)}),B._parser.registerCsiHandler({final:"G"},function(N){return B.cursorCharAbsolute(N)}),B._parser.registerCsiHandler({final:"H"},function(N){return B.cursorPosition(N)}),B._parser.registerCsiHandler({final:"I"},function(N){return B.cursorForwardTab(N)}),B._parser.registerCsiHandler({final:"J"},function(N){return B.eraseInDisplay(N)}),B._parser.registerCsiHandler({prefix:"?",final:"J"},function(N){return B.eraseInDisplay(N)}),B._parser.registerCsiHandler({final:"K"},function(N){return B.eraseInLine(N)}),B._parser.registerCsiHandler({prefix:"?",final:"K"},function(N){return B.eraseInLine(N)}),B._parser.registerCsiHandler({final:"L"},function(N){return B.insertLines(N)}),B._parser.registerCsiHandler({final:"M"},function(N){return B.deleteLines(N)}),B._parser.registerCsiHandler({final:"P"},function(N){return B.deleteChars(N)}),B._parser.registerCsiHandler({final:"S"},function(N){return B.scrollUp(N)}),B._parser.registerCsiHandler({final:"T"},function(N){return B.scrollDown(N)}),B._parser.registerCsiHandler({final:"X"},function(N){return B.eraseChars(N)}),B._parser.registerCsiHandler({final:"Z"},function(N){return B.cursorBackwardTab(N)}),B._parser.registerCsiHandler({final:"`"},function(N){return B.charPosAbsolute(N)}),B._parser.registerCsiHandler({final:"a"},function(N){return B.hPositionRelative(N)}),B._parser.registerCsiHandler({final:"b"},function(N){return B.repeatPrecedingCharacter(N)}),B._parser.registerCsiHandler({final:"c"},function(N){return B.sendDeviceAttributesPrimary(N)}),B._parser.registerCsiHandler({prefix:">",final:"c"},function(N){return B.sendDeviceAttributesSecondary(N)}),B._parser.registerCsiHandler({final:"d"},function(N){return B.linePosAbsolute(N)}),B._parser.registerCsiHandler({final:"e"},function(N){return B.vPositionRelative(N)}),B._parser.registerCsiHandler({final:"f"},function(N){return B.hVPosition(N)}),B._parser.registerCsiHandler({final:"g"},function(N){return B.tabClear(N)}),B._parser.registerCsiHandler({final:"h"},function(N){return B.setMode(N)}),B._parser.registerCsiHandler({prefix:"?",final:"h"},function(N){return B.setModePrivate(N)}),B._parser.registerCsiHandler({final:"l"},function(N){return B.resetMode(N)}),B._parser.registerCsiHandler({prefix:"?",final:"l"},function(N){return B.resetModePrivate(N)}),B._parser.registerCsiHandler({final:"m"},function(N){return B.charAttributes(N)}),B._parser.registerCsiHandler({final:"n"},function(N){return B.deviceStatus(N)}),B._parser.registerCsiHandler({prefix:"?",final:"n"},function(N){return B.deviceStatusPrivate(N)}),B._parser.registerCsiHandler({intermediates:"!",final:"p"},function(N){return B.softReset(N)}),B._parser.registerCsiHandler({intermediates:" ",final:"q"},function(N){return B.setCursorStyle(N)}),B._parser.registerCsiHandler({final:"r"},function(N){return B.setScrollRegion(N)}),B._parser.registerCsiHandler({final:"s"},function(N){return B.saveCursor(N)}),B._parser.registerCsiHandler({final:"t"},function(N){return B.windowOptions(N)}),B._parser.registerCsiHandler({final:"u"},function(N){return B.restoreCursor(N)}),B._parser.registerCsiHandler({intermediates:"'",final:"}"},function(N){return B.insertColumns(N)}),B._parser.registerCsiHandler({intermediates:"'",final:"~"},function(N){return B.deleteColumns(N)}),B._parser.setExecuteHandler(m.C0.BEL,function(){return B.bell()}),B._parser.setExecuteHandler(m.C0.LF,function(){return B.lineFeed()}),B._parser.setExecuteHandler(m.C0.VT,function(){return B.lineFeed()}),B._parser.setExecuteHandler(m.C0.FF,function(){return B.lineFeed()}),B._parser.setExecuteHandler(m.C0.CR,function(){return B.carriageReturn()}),B._parser.setExecuteHandler(m.C0.BS,function(){return B.backspace()}),B._parser.setExecuteHandler(m.C0.HT,function(){return B.tab()}),B._parser.setExecuteHandler(m.C0.SO,function(){return B.shiftOut()}),B._parser.setExecuteHandler(m.C0.SI,function(){return B.shiftIn()}),B._parser.setExecuteHandler(m.C1.IND,function(){return B.index()}),B._parser.setExecuteHandler(m.C1.NEL,function(){return B.nextLine()}),B._parser.setExecuteHandler(m.C1.HTS,function(){return B.tabSet()}),B._parser.registerOscHandler(0,new b.OscHandler(function(N){return B.setTitle(N),B.setIconName(N),!0})),B._parser.registerOscHandler(1,new b.OscHandler(function(N){return B.setIconName(N)})),B._parser.registerOscHandler(2,new b.OscHandler(function(N){return B.setTitle(N)})),B._parser.registerOscHandler(4,new b.OscHandler(function(N){return B.setOrReportIndexedColor(N)})),B._parser.registerOscHandler(10,new b.OscHandler(function(N){return B.setOrReportFgColor(N)})),B._parser.registerOscHandler(11,new b.OscHandler(function(N){return B.setOrReportBgColor(N)})),B._parser.registerOscHandler(12,new b.OscHandler(function(N){return B.setOrReportCursorColor(N)})),B._parser.registerOscHandler(104,new b.OscHandler(function(N){return B.restoreIndexedColor(N)})),B._parser.registerOscHandler(110,new b.OscHandler(function(N){return B.restoreFgColor(N)})),B._parser.registerOscHandler(111,new b.OscHandler(function(N){return B.restoreBgColor(N)})),B._parser.registerOscHandler(112,new b.OscHandler(function(N){return B.restoreCursorColor(N)})),B._parser.registerEscHandler({final:"7"},function(){return B.saveCursor()}),B._parser.registerEscHandler({final:"8"},function(){return B.restoreCursor()}),B._parser.registerEscHandler({final:"D"},function(){return B.index()}),B._parser.registerEscHandler({final:"E"},function(){return B.nextLine()}),B._parser.registerEscHandler({final:"H"},function(){return B.tabSet()}),B._parser.registerEscHandler({final:"M"},function(){return B.reverseIndex()}),B._parser.registerEscHandler({final:"="},function(){return B.keypadApplicationMode()}),B._parser.registerEscHandler({final:">"},function(){return B.keypadNumericMode()}),B._parser.registerEscHandler({final:"c"},function(){return B.fullReset()}),B._parser.registerEscHandler({final:"n"},function(){return B.setgLevel(2)}),B._parser.registerEscHandler({final:"o"},function(){return B.setgLevel(3)}),B._parser.registerEscHandler({final:"|"},function(){return B.setgLevel(3)}),B._parser.registerEscHandler({final:"}"},function(){return B.setgLevel(2)}),B._parser.registerEscHandler({final:"~"},function(){return B.setgLevel(1)}),B._parser.registerEscHandler({intermediates:"%",final:"@"},function(){return B.selectDefaultCharset()}),B._parser.registerEscHandler({intermediates:"%",final:"G"},function(){return B.selectDefaultCharset()});var pe=function(N){de._parser.registerEscHandler({intermediates:"(",final:N},function(){return B.selectCharset("("+N)}),de._parser.registerEscHandler({intermediates:")",final:N},function(){return B.selectCharset(")"+N)}),de._parser.registerEscHandler({intermediates:"*",final:N},function(){return B.selectCharset("*"+N)}),de._parser.registerEscHandler({intermediates:"+",final:N},function(){return B.selectCharset("+"+N)}),de._parser.registerEscHandler({intermediates:"-",final:N},function(){return B.selectCharset("-"+N)}),de._parser.registerEscHandler({intermediates:".",final:N},function(){return B.selectCharset("."+N)}),de._parser.registerEscHandler({intermediates:"/",final:N},function(){return B.selectCharset("/"+N)})},de=this;for(var Oe in C.CHARSETS)pe(Oe);return B._parser.registerEscHandler({intermediates:"#",final:"8"},function(){return B.screenAlignmentPattern()}),B._parser.setErrorHandler(function(N){return B._logService.error("Parsing error: ",N),N}),B._parser.registerDcsHandler({intermediates:"$",final:"q"},new O(B._bufferService,B._coreService,B._logService,B._optionsService)),B}return l(P,T),Object.defineProperty(P.prototype,"onRequestBell",{get:function(){return this._onRequestBell.event},enumerable:!1,configurable:!0}),Object.defineProperty(P.prototype,"onRequestRefreshRows",{get:function(){return this._onRequestRefreshRows.event},enumerable:!1,configurable:!0}),Object.defineProperty(P.prototype,"onRequestReset",{get:function(){return this._onRequestReset.event},enumerable:!1,configurable:!0}),Object.defineProperty(P.prototype,"onRequestSendFocus",{get:function(){return this._onRequestSendFocus.event},enumerable:!1,configurable:!0}),Object.defineProperty(P.prototype,"onRequestSyncScrollBar",{get:function(){return this._onRequestSyncScrollBar.event},enumerable:!1,configurable:!0}),Object.defineProperty(P.prototype,"onRequestWindowsOptionsReport",{get:function(){return this._onRequestWindowsOptionsReport.event},enumerable:!1,configurable:!0}),Object.defineProperty(P.prototype,"onA11yChar",{get:function(){return this._onA11yChar.event},enumerable:!1,configurable:!0}),Object.defineProperty(P.prototype,"onA11yTab",{get:function(){return this._onA11yTab.event},enumerable:!1,configurable:!0}),Object.defineProperty(P.prototype,"onCursorMove",{get:function(){return this._onCursorMove.event},enumerable:!1,configurable:!0}),Object.defineProperty(P.prototype,"onLineFeed",{get:function(){return this._onLineFeed.event},enumerable:!1,configurable:!0}),Object.defineProperty(P.prototype,"onScroll",{get:function(){return this._onScroll.event},enumerable:!1,configurable:!0}),Object.defineProperty(P.prototype,"onTitleChange",{get:function(){return this._onTitleChange.event},enumerable:!1,configurable:!0}),Object.defineProperty(P.prototype,"onColor",{get:function(){return this._onColor.event},enumerable:!1,configurable:!0}),P.prototype.dispose=function(){T.prototype.dispose.call(this)},P.prototype._preserveStack=function(M,D,q,H){this._parseStack.paused=!0,this._parseStack.cursorStartX=M,this._parseStack.cursorStartY=D,this._parseStack.decodedLength=q,this._parseStack.position=H},P.prototype._logSlowResolvingAsync=function(M){this._logService.logLevel<=d.LogLevelEnum.WARN&&Promise.race([M,new Promise(function(D,q){return setTimeout(function(){return q("#SLOW_TIMEOUT")},5e3)})]).catch(function(D){if(D!=="#SLOW_TIMEOUT")throw D;console.warn("async parser handler taking longer than 5000 ms")})},P.prototype.parse=function(M,D){var q,H=this._activeBuffer.x,X=this._activeBuffer.y,$=0,G=this._parseStack.paused;if(G){if(q=this._parser.parse(this._parseBuffer,this._parseStack.decodedLength,D))return this._logSlowResolvingAsync(q),q;H=this._parseStack.cursorStartX,X=this._parseStack.cursorStartY,this._parseStack.paused=!1,M.length>x&&($=this._parseStack.position+x)}if(this._logService.logLevel<=d.LogLevelEnum.DEBUG&&this._logService.debug("parsing data"+(typeof M=="string"?' "'+M+'"':' "'+Array.prototype.map.call(M,function(pe){return String.fromCharCode(pe)}).join("")+'"'),typeof M=="string"?M.split("").map(function(pe){return pe.charCodeAt(0)}):M),this._parseBuffer.length<M.length&&this._parseBuffer.length<x&&(this._parseBuffer=new Uint32Array(Math.min(M.length,x))),G||this._dirtyRowService.clearRange(),M.length>x)for(var ie=$;ie<M.length;ie+=x){var ee=ie+x<M.length?ie+x:M.length,B=typeof M=="string"?this._stringDecoder.decode(M.substring(ie,ee),this._parseBuffer):this._utf8Decoder.decode(M.subarray(ie,ee),this._parseBuffer);if(q=this._parser.parse(this._parseBuffer,B))return this._preserveStack(H,X,B,ie),this._logSlowResolvingAsync(q),q}else if(!G&&(B=typeof M=="string"?this._stringDecoder.decode(M,this._parseBuffer):this._utf8Decoder.decode(M,this._parseBuffer),q=this._parser.parse(this._parseBuffer,B)))return this._preserveStack(H,X,B,0),this._logSlowResolvingAsync(q),q;this._activeBuffer.x===H&&this._activeBuffer.y===X||this._onCursorMove.fire(),this._onRequestRefreshRows.fire(this._dirtyRowService.start,this._dirtyRowService.end)},P.prototype.print=function(M,D,q){var H,X,$=this._charsetService.charset,G=this._optionsService.rawOptions.screenReaderMode,ie=this._bufferService.cols,ee=this._coreService.decPrivateModes.wraparound,B=this._coreService.modes.insertMode,pe=this._curAttrData,de=this._activeBuffer.lines.get(this._activeBuffer.ybase+this._activeBuffer.y);this._dirtyRowService.markDirty(this._activeBuffer.y),this._activeBuffer.x&&q-D>0&&de.getWidth(this._activeBuffer.x-1)===2&&de.setCellFromCodePoint(this._activeBuffer.x-1,0,1,pe.fg,pe.bg,pe.extended);for(var Oe=D;Oe<q;++Oe){if(H=M[Oe],X=this._unicodeService.wcwidth(H),H<127&&$){var N=$[String.fromCharCode(H)];N&&(H=N.charCodeAt(0))}if(G&&this._onA11yChar.fire((0,w.stringFromCodePoint)(H)),X||!this._activeBuffer.x){if(this._activeBuffer.x+X-1>=ie){if(ee){for(;this._activeBuffer.x<ie;)de.setCellFromCodePoint(this._activeBuffer.x++,0,1,pe.fg,pe.bg,pe.extended);this._activeBuffer.x=0,this._activeBuffer.y++,this._activeBuffer.y===this._activeBuffer.scrollBottom+1?(this._activeBuffer.y--,this._bufferService.scroll(this._eraseAttrData(),!0)):(this._activeBuffer.y>=this._bufferService.rows&&(this._activeBuffer.y=this._bufferService.rows-1),this._activeBuffer.lines.get(this._activeBuffer.ybase+this._activeBuffer.y).isWrapped=!0),de=this._activeBuffer.lines.get(this._activeBuffer.ybase+this._activeBuffer.y)}else if(this._activeBuffer.x=ie-1,X===2)continue}if(B&&(de.insertCells(this._activeBuffer.x,X,this._activeBuffer.getNullCell(pe),pe),de.getWidth(ie-1)===2&&de.setCellFromCodePoint(ie-1,n.NULL_CELL_CODE,n.NULL_CELL_WIDTH,pe.fg,pe.bg,pe.extended)),de.setCellFromCodePoint(this._activeBuffer.x++,H,X,pe.fg,pe.bg,pe.extended),X>0)for(;--X;)de.setCellFromCodePoint(this._activeBuffer.x++,0,0,pe.fg,pe.bg,pe.extended)}else de.getWidth(this._activeBuffer.x-1)?de.addCodepointToCell(this._activeBuffer.x-1,H):de.addCodepointToCell(this._activeBuffer.x-2,H)}q-D>0&&(de.loadCell(this._activeBuffer.x-1,this._workCell),this._workCell.getWidth()===2||this._workCell.getCode()>65535?this._parser.precedingCodepoint=0:this._workCell.isCombined()?this._parser.precedingCodepoint=this._workCell.getChars().charCodeAt(0):this._parser.precedingCodepoint=this._workCell.content),this._activeBuffer.x<ie&&q-D>0&&de.getWidth(this._activeBuffer.x)===0&&!de.hasContent(this._activeBuffer.x)&&de.setCellFromCodePoint(this._activeBuffer.x,0,1,pe.fg,pe.bg,pe.extended),this._dirtyRowService.markDirty(this._activeBuffer.y)},P.prototype.registerCsiHandler=function(M,D){var q=this;return M.final!=="t"||M.prefix||M.intermediates?this._parser.registerCsiHandler(M,D):this._parser.registerCsiHandler(M,function(H){return!k(H.params[0],q._optionsService.rawOptions.windowOptions)||D(H)})},P.prototype.registerDcsHandler=function(M,D){return this._parser.registerDcsHandler(M,new g.DcsHandler(D))},P.prototype.registerEscHandler=function(M,D){return this._parser.registerEscHandler(M,D)},P.prototype.registerOscHandler=function(M,D){return this._parser.registerOscHandler(M,new b.OscHandler(D))},P.prototype.bell=function(){return this._onRequestBell.fire(),!0},P.prototype.lineFeed=function(){return this._dirtyRowService.markDirty(this._activeBuffer.y),this._optionsService.rawOptions.convertEol&&(this._activeBuffer.x=0),this._activeBuffer.y++,this._activeBuffer.y===this._activeBuffer.scrollBottom+1?(this._activeBuffer.y--,this._bufferService.scroll(this._eraseAttrData())):this._activeBuffer.y>=this._bufferService.rows&&(this._activeBuffer.y=this._bufferService.rows-1),this._activeBuffer.x>=this._bufferService.cols&&this._activeBuffer.x--,this._dirtyRowService.markDirty(this._activeBuffer.y),this._onLineFeed.fire(),!0},P.prototype.carriageReturn=function(){return this._activeBuffer.x=0,!0},P.prototype.backspace=function(){var M;if(!this._coreService.decPrivateModes.reverseWraparound)return this._restrictCursor(),this._activeBuffer.x>0&&this._activeBuffer.x--,!0;if(this._restrictCursor(this._bufferService.cols),this._activeBuffer.x>0)this._activeBuffer.x--;else if(this._activeBuffer.x===0&&this._activeBuffer.y>this._activeBuffer.scrollTop&&this._activeBuffer.y<=this._activeBuffer.scrollBottom&&(!((M=this._activeBuffer.lines.get(this._activeBuffer.ybase+this._activeBuffer.y))===null||M===void 0)&&M.isWrapped)){this._activeBuffer.lines.get(this._activeBuffer.ybase+this._activeBuffer.y).isWrapped=!1,this._activeBuffer.y--,this._activeBuffer.x=this._bufferService.cols-1;var D=this._activeBuffer.lines.get(this._activeBuffer.ybase+this._activeBuffer.y);D.hasWidth(this._activeBuffer.x)&&!D.hasContent(this._activeBuffer.x)&&this._activeBuffer.x--}return this._restrictCursor(),!0},P.prototype.tab=function(){if(this._activeBuffer.x>=this._bufferService.cols)return!0;var M=this._activeBuffer.x;return this._activeBuffer.x=this._activeBuffer.nextStop(),this._optionsService.rawOptions.screenReaderMode&&this._onA11yTab.fire(this._activeBuffer.x-M),!0},P.prototype.shiftOut=function(){return this._charsetService.setgLevel(1),!0},P.prototype.shiftIn=function(){return this._charsetService.setgLevel(0),!0},P.prototype._restrictCursor=function(M){M===void 0&&(M=this._bufferService.cols-1),this._activeBuffer.x=Math.min(M,Math.max(0,this._activeBuffer.x)),this._activeBuffer.y=this._coreService.decPrivateModes.origin?Math.min(this._activeBuffer.scrollBottom,Math.max(this._activeBuffer.scrollTop,this._activeBuffer.y)):Math.min(this._bufferService.rows-1,Math.max(0,this._activeBuffer.y)),this._dirtyRowService.markDirty(this._activeBuffer.y)},P.prototype._setCursor=function(M,D){this._dirtyRowService.markDirty(this._activeBuffer.y),this._coreService.decPrivateModes.origin?(this._activeBuffer.x=M,this._activeBuffer.y=this._activeBuffer.scrollTop+D):(this._activeBuffer.x=M,this._activeBuffer.y=D),this._restrictCursor(),this._dirtyRowService.markDirty(this._activeBuffer.y)},P.prototype._moveCursor=function(M,D){this._restrictCursor(),this._setCursor(this._activeBuffer.x+M,this._activeBuffer.y+D)},P.prototype.cursorUp=function(M){var D=this._activeBuffer.y-this._activeBuffer.scrollTop;return D>=0?this._moveCursor(0,-Math.min(D,M.params[0]||1)):this._moveCursor(0,-(M.params[0]||1)),!0},P.prototype.cursorDown=function(M){var D=this._activeBuffer.scrollBottom-this._activeBuffer.y;return D>=0?this._moveCursor(0,Math.min(D,M.params[0]||1)):this._moveCursor(0,M.params[0]||1),!0},P.prototype.cursorForward=function(M){return this._moveCursor(M.params[0]||1,0),!0},P.prototype.cursorBackward=function(M){return this._moveCursor(-(M.params[0]||1),0),!0},P.prototype.cursorNextLine=function(M){return this.cursorDown(M),this._activeBuffer.x=0,!0},P.prototype.cursorPrecedingLine=function(M){return this.cursorUp(M),this._activeBuffer.x=0,!0},P.prototype.cursorCharAbsolute=function(M){return this._setCursor((M.params[0]||1)-1,this._activeBuffer.y),!0},P.prototype.cursorPosition=function(M){return this._setCursor(M.length>=2?(M.params[1]||1)-1:0,(M.params[0]||1)-1),!0},P.prototype.charPosAbsolute=function(M){return this._setCursor((M.params[0]||1)-1,this._activeBuffer.y),!0},P.prototype.hPositionRelative=function(M){return this._moveCursor(M.params[0]||1,0),!0},P.prototype.linePosAbsolute=function(M){return this._setCursor(this._activeBuffer.x,(M.params[0]||1)-1),!0},P.prototype.vPositionRelative=function(M){return this._moveCursor(0,M.params[0]||1),!0},P.prototype.hVPosition=function(M){return this.cursorPosition(M),!0},P.prototype.tabClear=function(M){var D=M.params[0];return D===0?delete this._activeBuffer.tabs[this._activeBuffer.x]:D===3&&(this._activeBuffer.tabs={}),!0},P.prototype.cursorForwardTab=function(M){if(this._activeBuffer.x>=this._bufferService.cols)return!0;for(var D=M.params[0]||1;D--;)this._activeBuffer.x=this._activeBuffer.nextStop();return!0},P.prototype.cursorBackwardTab=function(M){if(this._activeBuffer.x>=this._bufferService.cols)return!0;for(var D=M.params[0]||1;D--;)this._activeBuffer.x=this._activeBuffer.prevStop();return!0},P.prototype._eraseInBufferLine=function(M,D,q,H){H===void 0&&(H=!1);var X=this._activeBuffer.lines.get(this._activeBuffer.ybase+M);X.replaceCells(D,q,this._activeBuffer.getNullCell(this._eraseAttrData()),this._eraseAttrData()),H&&(X.isWrapped=!1)},P.prototype._resetBufferLine=function(M){var D=this._activeBuffer.lines.get(this._activeBuffer.ybase+M);D.fill(this._activeBuffer.getNullCell(this._eraseAttrData())),this._bufferService.buffer.clearMarkers(this._activeBuffer.ybase+M),D.isWrapped=!1},P.prototype.eraseInDisplay=function(M){var D;switch(this._restrictCursor(this._bufferService.cols),M.params[0]){case 0:for(D=this._activeBuffer.y,this._dirtyRowService.markDirty(D),this._eraseInBufferLine(D++,this._activeBuffer.x,this._bufferService.cols,this._activeBuffer.x===0);D<this._bufferService.rows;D++)this._resetBufferLine(D);this._dirtyRowService.markDirty(D);break;case 1:for(D=this._activeBuffer.y,this._dirtyRowService.markDirty(D),this._eraseInBufferLine(D,0,this._activeBuffer.x+1,!0),this._activeBuffer.x+1>=this._bufferService.cols&&(this._activeBuffer.lines.get(D+1).isWrapped=!1);D--;)this._resetBufferLine(D);this._dirtyRowService.markDirty(0);break;case 2:for(D=this._bufferService.rows,this._dirtyRowService.markDirty(D-1);D--;)this._resetBufferLine(D);this._dirtyRowService.markDirty(0);break;case 3:var q=this._activeBuffer.lines.length-this._bufferService.rows;q>0&&(this._activeBuffer.lines.trimStart(q),this._activeBuffer.ybase=Math.max(this._activeBuffer.ybase-q,0),this._activeBuffer.ydisp=Math.max(this._activeBuffer.ydisp-q,0),this._onScroll.fire(0))}return!0},P.prototype.eraseInLine=function(M){switch(this._restrictCursor(this._bufferService.cols),M.params[0]){case 0:this._eraseInBufferLine(this._activeBuffer.y,this._activeBuffer.x,this._bufferService.cols,this._activeBuffer.x===0);break;case 1:this._eraseInBufferLine(this._activeBuffer.y,0,this._activeBuffer.x+1,!1);break;case 2:this._eraseInBufferLine(this._activeBuffer.y,0,this._bufferService.cols,!0)}return this._dirtyRowService.markDirty(this._activeBuffer.y),!0},P.prototype.insertLines=function(M){this._restrictCursor();var D=M.params[0]||1;if(this._activeBuffer.y>this._activeBuffer.scrollBottom||this._activeBuffer.y<this._activeBuffer.scrollTop)return!0;for(var q=this._activeBuffer.ybase+this._activeBuffer.y,H=this._bufferService.rows-1-this._activeBuffer.scrollBottom,X=this._bufferService.rows-1+this._activeBuffer.ybase-H+1;D--;)this._activeBuffer.lines.splice(X-1,1),this._activeBuffer.lines.splice(q,0,this._activeBuffer.getBlankLine(this._eraseAttrData()));return this._dirtyRowService.markRangeDirty(this._activeBuffer.y,this._activeBuffer.scrollBottom),this._activeBuffer.x=0,!0},P.prototype.deleteLines=function(M){this._restrictCursor();var D=M.params[0]||1;if(this._activeBuffer.y>this._activeBuffer.scrollBottom||this._activeBuffer.y<this._activeBuffer.scrollTop)return!0;var q,H=this._activeBuffer.ybase+this._activeBuffer.y;for(q=this._bufferService.rows-1-this._activeBuffer.scrollBottom,q=this._bufferService.rows-1+this._activeBuffer.ybase-q;D--;)this._activeBuffer.lines.splice(H,1),this._activeBuffer.lines.splice(q,0,this._activeBuffer.getBlankLine(this._eraseAttrData()));return this._dirtyRowService.markRangeDirty(this._activeBuffer.y,this._activeBuffer.scrollBottom),this._activeBuffer.x=0,!0},P.prototype.insertChars=function(M){this._restrictCursor();var D=this._activeBuffer.lines.get(this._activeBuffer.ybase+this._activeBuffer.y);return D&&(D.insertCells(this._activeBuffer.x,M.params[0]||1,this._activeBuffer.getNullCell(this._eraseAttrData()),this._eraseAttrData()),this._dirtyRowService.markDirty(this._activeBuffer.y)),!0},P.prototype.deleteChars=function(M){this._restrictCursor();var D=this._activeBuffer.lines.get(this._activeBuffer.ybase+this._activeBuffer.y);return D&&(D.deleteCells(this._activeBuffer.x,M.params[0]||1,this._activeBuffer.getNullCell(this._eraseAttrData()),this._eraseAttrData()),this._dirtyRowService.markDirty(this._activeBuffer.y)),!0},P.prototype.scrollUp=function(M){for(var D=M.params[0]||1;D--;)this._activeBuffer.lines.splice(this._activeBuffer.ybase+this._activeBuffer.scrollTop,1),this._activeBuffer.lines.splice(this._activeBuffer.ybase+this._activeBuffer.scrollBottom,0,this._activeBuffer.getBlankLine(this._eraseAttrData()));return this._dirtyRowService.markRangeDirty(this._activeBuffer.scrollTop,this._activeBuffer.scrollBottom),!0},P.prototype.scrollDown=function(M){for(var D=M.params[0]||1;D--;)this._activeBuffer.lines.splice(this._activeBuffer.ybase+this._activeBuffer.scrollBottom,1),this._activeBuffer.lines.splice(this._activeBuffer.ybase+this._activeBuffer.scrollTop,0,this._activeBuffer.getBlankLine(y.DEFAULT_ATTR_DATA));return this._dirtyRowService.markRangeDirty(this._activeBuffer.scrollTop,this._activeBuffer.scrollBottom),!0},P.prototype.scrollLeft=function(M){if(this._activeBuffer.y>this._activeBuffer.scrollBottom||this._activeBuffer.y<this._activeBuffer.scrollTop)return!0;for(var D=M.params[0]||1,q=this._activeBuffer.scrollTop;q<=this._activeBuffer.scrollBottom;++q){var H=this._activeBuffer.lines.get(this._activeBuffer.ybase+q);H.deleteCells(0,D,this._activeBuffer.getNullCell(this._eraseAttrData()),this._eraseAttrData()),H.isWrapped=!1}return this._dirtyRowService.markRangeDirty(this._activeBuffer.scrollTop,this._activeBuffer.scrollBottom),!0},P.prototype.scrollRight=function(M){if(this._activeBuffer.y>this._activeBuffer.scrollBottom||this._activeBuffer.y<this._activeBuffer.scrollTop)return!0;for(var D=M.params[0]||1,q=this._activeBuffer.scrollTop;q<=this._activeBuffer.scrollBottom;++q){var H=this._activeBuffer.lines.get(this._activeBuffer.ybase+q);H.insertCells(0,D,this._activeBuffer.getNullCell(this._eraseAttrData()),this._eraseAttrData()),H.isWrapped=!1}return this._dirtyRowService.markRangeDirty(this._activeBuffer.scrollTop,this._activeBuffer.scrollBottom),!0},P.prototype.insertColumns=function(M){if(this._activeBuffer.y>this._activeBuffer.scrollBottom||this._activeBuffer.y<this._activeBuffer.scrollTop)return!0;for(var D=M.params[0]||1,q=this._activeBuffer.scrollTop;q<=this._activeBuffer.scrollBottom;++q){var H=this._activeBuffer.lines.get(this._activeBuffer.ybase+q);H.insertCells(this._activeBuffer.x,D,this._activeBuffer.getNullCell(this._eraseAttrData()),this._eraseAttrData()),H.isWrapped=!1}return this._dirtyRowService.markRangeDirty(this._activeBuffer.scrollTop,this._activeBuffer.scrollBottom),!0},P.prototype.deleteColumns=function(M){if(this._activeBuffer.y>this._activeBuffer.scrollBottom||this._activeBuffer.y<this._activeBuffer.scrollTop)return!0;for(var D=M.params[0]||1,q=this._activeBuffer.scrollTop;q<=this._activeBuffer.scrollBottom;++q){var H=this._activeBuffer.lines.get(this._activeBuffer.ybase+q);H.deleteCells(this._activeBuffer.x,D,this._activeBuffer.getNullCell(this._eraseAttrData()),this._eraseAttrData()),H.isWrapped=!1}return this._dirtyRowService.markRangeDirty(this._activeBuffer.scrollTop,this._activeBuffer.scrollBottom),!0},P.prototype.eraseChars=function(M){this._restrictCursor();var D=this._activeBuffer.lines.get(this._activeBuffer.ybase+this._activeBuffer.y);return D&&(D.replaceCells(this._activeBuffer.x,this._activeBuffer.x+(M.params[0]||1),this._activeBuffer.getNullCell(this._eraseAttrData()),this._eraseAttrData()),this._dirtyRowService.markDirty(this._activeBuffer.y)),!0},P.prototype.repeatPrecedingCharacter=function(M){if(!this._parser.precedingCodepoint)return!0;for(var D=M.params[0]||1,q=new Uint32Array(D),H=0;H<D;++H)q[H]=this._parser.precedingCodepoint;return this.print(q,0,q.length),!0},P.prototype.sendDeviceAttributesPrimary=function(M){return M.params[0]>0||(this._is("xterm")||this._is("rxvt-unicode")||this._is("screen")?this._coreService.triggerDataEvent(m.C0.ESC+"[?1;2c"):this._is("linux")&&this._coreService.triggerDataEvent(m.C0.ESC+"[?6c")),!0},P.prototype.sendDeviceAttributesSecondary=function(M){return M.params[0]>0||(this._is("xterm")?this._coreService.triggerDataEvent(m.C0.ESC+"[>0;276;0c"):this._is("rxvt-unicode")?this._coreService.triggerDataEvent(m.C0.ESC+"[>85;95;0c"):this._is("linux")?this._coreService.triggerDataEvent(M.params[0]+"c"):this._is("screen")&&this._coreService.triggerDataEvent(m.C0.ESC+"[>83;40003;0c")),!0},P.prototype._is=function(M){return(this._optionsService.rawOptions.termName+"").indexOf(M)===0},P.prototype.setMode=function(M){for(var D=0;D<M.length;D++)M.params[D]===4&&(this._coreService.modes.insertMode=!0);return!0},P.prototype.setModePrivate=function(M){for(var D=0;D<M.length;D++)switch(M.params[D]){case 1:this._coreService.decPrivateModes.applicationCursorKeys=!0;break;case 2:this._charsetService.setgCharset(0,C.DEFAULT_CHARSET),this._charsetService.setgCharset(1,C.DEFAULT_CHARSET),this._charsetService.setgCharset(2,C.DEFAULT_CHARSET),this._charsetService.setgCharset(3,C.DEFAULT_CHARSET);break;case 3:this._optionsService.rawOptions.windowOptions.setWinLines&&(this._bufferService.resize(132,this._bufferService.rows),this._onRequestReset.fire());break;case 6:this._coreService.decPrivateModes.origin=!0,this._setCursor(0,0);break;case 7:this._coreService.decPrivateModes.wraparound=!0;break;case 12:break;case 45:this._coreService.decPrivateModes.reverseWraparound=!0;break;case 66:this._logService.debug("Serial port requested application keypad."),this._coreService.decPrivateModes.applicationKeypad=!0,this._onRequestSyncScrollBar.fire();break;case 9:this._coreMouseService.activeProtocol="X10";break;case 1e3:this._coreMouseService.activeProtocol="VT200";break;case 1002:this._coreMouseService.activeProtocol="DRAG";break;case 1003:this._coreMouseService.activeProtocol="ANY";break;case 1004:this._coreService.decPrivateModes.sendFocus=!0,this._onRequestSendFocus.fire();break;case 1005:this._logService.debug("DECSET 1005 not supported (see #2507)");break;case 1006:this._coreMouseService.activeEncoding="SGR";break;case 1015:this._logService.debug("DECSET 1015 not supported (see #2507)");break;case 25:this._coreService.isCursorHidden=!1;break;case 1048:this.saveCursor();break;case 1049:this.saveCursor();case 47:case 1047:this._bufferService.buffers.activateAltBuffer(this._eraseAttrData()),this._coreService.isCursorInitialized=!0,this._onRequestRefreshRows.fire(0,this._bufferService.rows-1),this._onRequestSyncScrollBar.fire();break;case 2004:this._coreService.decPrivateModes.bracketedPasteMode=!0}return!0},P.prototype.resetMode=function(M){for(var D=0;D<M.length;D++)M.params[D]===4&&(this._coreService.modes.insertMode=!1);return!0},P.prototype.resetModePrivate=function(M){for(var D=0;D<M.length;D++)switch(M.params[D]){case 1:this._coreService.decPrivateModes.applicationCursorKeys=!1;break;case 3:this._optionsService.rawOptions.windowOptions.setWinLines&&(this._bufferService.resize(80,this._bufferService.rows),this._onRequestReset.fire());break;case 6:this._coreService.decPrivateModes.origin=!1,this._setCursor(0,0);break;case 7:this._coreService.decPrivateModes.wraparound=!1;break;case 12:break;case 45:this._coreService.decPrivateModes.reverseWraparound=!1;break;case 66:this._logService.debug("Switching back to normal keypad."),this._coreService.decPrivateModes.applicationKeypad=!1,this._onRequestSyncScrollBar.fire();break;case 9:case 1e3:case 1002:case 1003:this._coreMouseService.activeProtocol="NONE";break;case 1004:this._coreService.decPrivateModes.sendFocus=!1;break;case 1005:this._logService.debug("DECRST 1005 not supported (see #2507)");break;case 1006:this._coreMouseService.activeEncoding="DEFAULT";break;case 1015:this._logService.debug("DECRST 1015 not supported (see #2507)");break;case 25:this._coreService.isCursorHidden=!0;break;case 1048:this.restoreCursor();break;case 1049:case 47:case 1047:this._bufferService.buffers.activateNormalBuffer(),M.params[D]===1049&&this.restoreCursor(),this._coreService.isCursorInitialized=!0,this._onRequestRefreshRows.fire(0,this._bufferService.rows-1),this._onRequestSyncScrollBar.fire();break;case 2004:this._coreService.decPrivateModes.bracketedPasteMode=!1}return!0},P.prototype._updateAttrColor=function(M,D,q,H,X){return D===2?(M|=50331648,M&=-16777216,M|=_.AttributeData.fromColorRGB([q,H,X])):D===5&&(M&=-50331904,M|=33554432|255&q),M},P.prototype._extractColor=function(M,D,q){var H=[0,0,-1,0,0,0],X=0,$=0;do{if(H[$+X]=M.params[D+$],M.hasSubParams(D+$)){var G=M.getSubParams(D+$),ie=0;do H[1]===5&&(X=1),H[$+ie+1+X]=G[ie];while(++ie<G.length&&ie+$+1+X<H.length);break}if(H[1]===5&&$+X>=2||H[1]===2&&$+X>=5)break;H[1]&&(X=1)}while(++$+D<M.length&&$+X<H.length);for(ie=2;ie<H.length;++ie)H[ie]===-1&&(H[ie]=0);switch(H[0]){case 38:q.fg=this._updateAttrColor(q.fg,H[1],H[3],H[4],H[5]);break;case 48:q.bg=this._updateAttrColor(q.bg,H[1],H[3],H[4],H[5]);break;case 58:q.extended=q.extended.clone(),q.extended.underlineColor=this._updateAttrColor(q.extended.underlineColor,H[1],H[3],H[4],H[5])}return $},P.prototype._processUnderline=function(M,D){D.extended=D.extended.clone(),(!~M||M>5)&&(M=1),D.extended.underlineStyle=M,D.fg|=268435456,M===0&&(D.fg&=-268435457),D.updateExtended()},P.prototype.charAttributes=function(M){if(M.length===1&&M.params[0]===0)return this._curAttrData.fg=y.DEFAULT_ATTR_DATA.fg,this._curAttrData.bg=y.DEFAULT_ATTR_DATA.bg,!0;for(var D,q=M.length,H=this._curAttrData,X=0;X<q;X++)(D=M.params[X])>=30&&D<=37?(H.fg&=-50331904,H.fg|=16777216|D-30):D>=40&&D<=47?(H.bg&=-50331904,H.bg|=16777216|D-40):D>=90&&D<=97?(H.fg&=-50331904,H.fg|=16777224|D-90):D>=100&&D<=107?(H.bg&=-50331904,H.bg|=16777224|D-100):D===0?(H.fg=y.DEFAULT_ATTR_DATA.fg,H.bg=y.DEFAULT_ATTR_DATA.bg):D===1?H.fg|=134217728:D===3?H.bg|=67108864:D===4?(H.fg|=268435456,this._processUnderline(M.hasSubParams(X)?M.getSubParams(X)[0]:1,H)):D===5?H.fg|=536870912:D===7?H.fg|=67108864:D===8?H.fg|=1073741824:D===9?H.fg|=2147483648:D===2?H.bg|=134217728:D===21?this._processUnderline(2,H):D===22?(H.fg&=-134217729,H.bg&=-134217729):D===23?H.bg&=-67108865:D===24?H.fg&=-268435457:D===25?H.fg&=-536870913:D===27?H.fg&=-67108865:D===28?H.fg&=-1073741825:D===29?H.fg&=2147483647:D===39?(H.fg&=-67108864,H.fg|=16777215&y.DEFAULT_ATTR_DATA.fg):D===49?(H.bg&=-67108864,H.bg|=16777215&y.DEFAULT_ATTR_DATA.bg):D===38||D===48||D===58?X+=this._extractColor(M,X,H):D===59?(H.extended=H.extended.clone(),H.extended.underlineColor=-1,H.updateExtended()):D===100?(H.fg&=-67108864,H.fg|=16777215&y.DEFAULT_ATTR_DATA.fg,H.bg&=-67108864,H.bg|=16777215&y.DEFAULT_ATTR_DATA.bg):this._logService.debug("Unknown SGR attribute: %d.",D);return!0},P.prototype.deviceStatus=function(M){switch(M.params[0]){case 5:this._coreService.triggerDataEvent(m.C0.ESC+"[0n");break;case 6:var D=this._activeBuffer.y+1,q=this._activeBuffer.x+1;this._coreService.triggerDataEvent(m.C0.ESC+"["+D+";"+q+"R")}return!0},P.prototype.deviceStatusPrivate=function(M){if(M.params[0]===6){var D=this._activeBuffer.y+1,q=this._activeBuffer.x+1;this._coreService.triggerDataEvent(m.C0.ESC+"[?"+D+";"+q+"R")}return!0},P.prototype.softReset=function(M){return this._coreService.isCursorHidden=!1,this._onRequestSyncScrollBar.fire(),this._activeBuffer.scrollTop=0,this._activeBuffer.scrollBottom=this._bufferService.rows-1,this._curAttrData=y.DEFAULT_ATTR_DATA.clone(),this._coreService.reset(),this._charsetService.reset(),this._activeBuffer.savedX=0,this._activeBuffer.savedY=this._activeBuffer.ybase,this._activeBuffer.savedCurAttrData.fg=this._curAttrData.fg,this._activeBuffer.savedCurAttrData.bg=this._curAttrData.bg,this._activeBuffer.savedCharset=this._charsetService.charset,this._coreService.decPrivateModes.origin=!1,!0},P.prototype.setCursorStyle=function(M){var D=M.params[0]||1;switch(D){case 1:case 2:this._optionsService.options.cursorStyle="block";break;case 3:case 4:this._optionsService.options.cursorStyle="underline";break;case 5:case 6:this._optionsService.options.cursorStyle="bar"}var q=D%2==1;return this._optionsService.options.cursorBlink=q,!0},P.prototype.setScrollRegion=function(M){var D,q=M.params[0]||1;return(M.length<2||(D=M.params[1])>this._bufferService.rows||D===0)&&(D=this._bufferService.rows),D>q&&(this._activeBuffer.scrollTop=q-1,this._activeBuffer.scrollBottom=D-1,this._setCursor(0,0)),!0},P.prototype.windowOptions=function(M){if(!k(M.params[0],this._optionsService.rawOptions.windowOptions))return!0;var D=M.length>1?M.params[1]:0;switch(M.params[0]){case 14:D!==2&&this._onRequestWindowsOptionsReport.fire(f.GET_WIN_SIZE_PIXELS);break;case 16:this._onRequestWindowsOptionsReport.fire(f.GET_CELL_SIZE_PIXELS);break;case 18:this._bufferService&&this._coreService.triggerDataEvent(m.C0.ESC+"[8;"+this._bufferService.rows+";"+this._bufferService.cols+"t");break;case 22:D!==0&&D!==2||(this._windowTitleStack.push(this._windowTitle),this._windowTitleStack.length>10&&this._windowTitleStack.shift()),D!==0&&D!==1||(this._iconNameStack.push(this._iconName),this._iconNameStack.length>10&&this._iconNameStack.shift());break;case 23:D!==0&&D!==2||this._windowTitleStack.length&&this.setTitle(this._windowTitleStack.pop()),D!==0&&D!==1||this._iconNameStack.length&&this.setIconName(this._iconNameStack.pop())}return!0},P.prototype.saveCursor=function(M){return this._activeBuffer.savedX=this._activeBuffer.x,this._activeBuffer.savedY=this._activeBuffer.ybase+this._activeBuffer.y,this._activeBuffer.savedCurAttrData.fg=this._curAttrData.fg,this._activeBuffer.savedCurAttrData.bg=this._curAttrData.bg,this._activeBuffer.savedCharset=this._charsetService.charset,!0},P.prototype.restoreCursor=function(M){return this._activeBuffer.x=this._activeBuffer.savedX||0,this._activeBuffer.y=Math.max(this._activeBuffer.savedY-this._activeBuffer.ybase,0),this._curAttrData.fg=this._activeBuffer.savedCurAttrData.fg,this._curAttrData.bg=this._activeBuffer.savedCurAttrData.bg,this._charsetService.charset=this._savedCharset,this._activeBuffer.savedCharset&&(this._charsetService.charset=this._activeBuffer.savedCharset),this._restrictCursor(),!0},P.prototype.setTitle=function(M){return this._windowTitle=M,this._onTitleChange.fire(M),!0},P.prototype.setIconName=function(M){return this._iconName=M,!0},P.prototype.setOrReportIndexedColor=function(M){for(var D=[],q=M.split(";");q.length>1;){var H=q.shift(),X=q.shift();if(/^\d+$/.exec(H)){var $=parseInt(H);if(0<=$&&$<256)if(X==="?")D.push({type:0,index:$});else{var G=(0,A.parseColor)(X);G&&D.push({type:1,index:$,color:G})}}}return D.length&&this._onColor.fire(D),!0},P.prototype._setOrReportSpecialColor=function(M,D){for(var q=M.split(";"),H=0;H<q.length&&!(D>=this._specialColors.length);++H,++D)if(q[H]==="?")this._onColor.fire([{type:0,index:this._specialColors[D]}]);else{var X=(0,A.parseColor)(q[H]);X&&this._onColor.fire([{type:1,index:this._specialColors[D],color:X}])}return!0},P.prototype.setOrReportFgColor=function(M){return this._setOrReportSpecialColor(M,0)},P.prototype.setOrReportBgColor=function(M){return this._setOrReportSpecialColor(M,1)},P.prototype.setOrReportCursorColor=function(M){return this._setOrReportSpecialColor(M,2)},P.prototype.restoreIndexedColor=function(M){if(!M)return this._onColor.fire([{type:2}]),!0;for(var D=[],q=M.split(";"),H=0;H<q.length;++H)if(/^\d+$/.exec(q[H])){var X=parseInt(q[H]);0<=X&&X<256&&D.push({type:2,index:X})}return D.length&&this._onColor.fire(D),!0},P.prototype.restoreFgColor=function(M){return this._onColor.fire([{type:2,index:256}]),!0},P.prototype.restoreBgColor=function(M){return this._onColor.fire([{type:2,index:257}]),!0},P.prototype.restoreCursorColor=function(M){return this._onColor.fire([{type:2,index:258}]),!0},P.prototype.nextLine=function(){return this._activeBuffer.x=0,this.index(),!0},P.prototype.keypadApplicationMode=function(){return this._logService.debug("Serial port requested application keypad."),this._coreService.decPrivateModes.applicationKeypad=!0,this._onRequestSyncScrollBar.fire(),!0},P.prototype.keypadNumericMode=function(){return this._logService.debug("Switching back to normal keypad."),this._coreService.decPrivateModes.applicationKeypad=!1,this._onRequestSyncScrollBar.fire(),!0},P.prototype.selectDefaultCharset=function(){return this._charsetService.setgLevel(0),this._charsetService.setgCharset(0,C.DEFAULT_CHARSET),!0},P.prototype.selectCharset=function(M){return M.length!==2?(this.selectDefaultCharset(),!0):(M[0]==="/"||this._charsetService.setgCharset(R[M[0]],C.CHARSETS[M[1]]||C.DEFAULT_CHARSET),!0)},P.prototype.index=function(){return this._restrictCursor(),this._activeBuffer.y++,this._activeBuffer.y===this._activeBuffer.scrollBottom+1?(this._activeBuffer.y--,this._bufferService.scroll(this._eraseAttrData())):this._activeBuffer.y>=this._bufferService.rows&&(this._activeBuffer.y=this._bufferService.rows-1),this._restrictCursor(),!0},P.prototype.tabSet=function(){return this._activeBuffer.tabs[this._activeBuffer.x]=!0,!0},P.prototype.reverseIndex=function(){if(this._restrictCursor(),this._activeBuffer.y===this._activeBuffer.scrollTop){var M=this._activeBuffer.scrollBottom-this._activeBuffer.scrollTop;this._activeBuffer.lines.shiftElements(this._activeBuffer.ybase+this._activeBuffer.y,M,1),this._activeBuffer.lines.set(this._activeBuffer.ybase+this._activeBuffer.y,this._activeBuffer.getBlankLine(this._eraseAttrData())),this._dirtyRowService.markRangeDirty(this._activeBuffer.scrollTop,this._activeBuffer.scrollBottom)}else this._activeBuffer.y--,this._restrictCursor();return!0},P.prototype.fullReset=function(){return this._parser.reset(),this._onRequestReset.fire(),!0},P.prototype.reset=function(){this._curAttrData=y.DEFAULT_ATTR_DATA.clone(),this._eraseAttrDataInternal=y.DEFAULT_ATTR_DATA.clone()},P.prototype._eraseAttrData=function(){return this._eraseAttrDataInternal.bg&=-67108864,this._eraseAttrDataInternal.bg|=67108863&this._curAttrData.bg,this._eraseAttrDataInternal},P.prototype.setgLevel=function(M){return this._charsetService.setgLevel(M),!0},P.prototype.screenAlignmentPattern=function(){var M=new h.CellData;M.content=1<<22|"E".charCodeAt(0),M.fg=this._curAttrData.fg,M.bg=this._curAttrData.bg,this._setCursor(0,0);for(var D=0;D<this._bufferService.rows;++D){var q=this._activeBuffer.ybase+this._activeBuffer.y+D,H=this._activeBuffer.lines.get(q);H&&(H.fill(M),H.isWrapped=!1)}return this._dirtyRowService.markAllDirty(),this._setCursor(0,0),!0},P}(p.Disposable);r.InputHandler=I},844:function(a,r){var u=this&&this.__values||function(f){var m=typeof Symbol=="function"&&Symbol.iterator,C=m&&f[m],S=0;if(C)return C.call(f);if(f&&typeof f.length=="number")return{next:function(){return f&&S>=f.length&&(f=void 0),{value:f&&f[S++],done:!f}}};throw new TypeError(m?"Object is not iterable.":"Symbol.iterator is not defined.")};Object.defineProperty(r,"__esModule",{value:!0}),r.getDisposeArrayDisposable=r.disposeArray=r.Disposable=void 0;var o=function(){function f(){this._disposables=[],this._isDisposed=!1}return f.prototype.dispose=function(){var m,C;this._isDisposed=!0;try{for(var S=u(this._disposables),p=S.next();!p.done;p=S.next())p.value.dispose()}catch(v){m={error:v}}finally{try{p&&!p.done&&(C=S.return)&&C.call(S)}finally{if(m)throw m.error}}this._disposables.length=0},f.prototype.register=function(m){return this._disposables.push(m),m},f.prototype.unregister=function(m){var C=this._disposables.indexOf(m);C!==-1&&this._disposables.splice(C,1)},f}();function l(f){var m,C;try{for(var S=u(f),p=S.next();!p.done;p=S.next())p.value.dispose()}catch(v){m={error:v}}finally{try{p&&!p.done&&(C=S.return)&&C.call(S)}finally{if(m)throw m.error}}f.length=0}r.Disposable=o,r.disposeArray=l,r.getDisposeArrayDisposable=function(f){return{dispose:function(){return l(f)}}}},6114:(a,r)=>{Object.defineProperty(r,"__esModule",{value:!0}),r.isLinux=r.isWindows=r.isIphone=r.isIpad=r.isMac=r.isSafari=r.isLegacyEdge=r.isFirefox=void 0;var u=typeof navigator>"u",o=u?"node":navigator.userAgent,l=u?"node":navigator.platform;r.isFirefox=o.includes("Firefox"),r.isLegacyEdge=o.includes("Edge"),r.isSafari=/^((?!chrome|android).)*safari/i.test(o),r.isMac=["Macintosh","MacIntel","MacPPC","Mac68K"].includes(l),r.isIpad=l==="iPad",r.isIphone=l==="iPhone",r.isWindows=["Windows","Win16","Win32","WinCE"].includes(l),r.isLinux=l.indexOf("Linux")>=0},6106:function(a,r){var u=this&&this.__generator||function(l,f){var m,C,S,p,v={label:0,sent:function(){if(1&S[0])throw S[1];return S[1]},trys:[],ops:[]};return p={next:w(0),throw:w(1),return:w(2)},typeof Symbol=="function"&&(p[Symbol.iterator]=function(){return this}),p;function w(y){return function(c){return function(n){if(m)throw new TypeError("Generator is already executing.");for(;v;)try{if(m=1,C&&(S=2&n[0]?C.return:n[0]?C.throw||((S=C.return)&&S.call(C),0):C.next)&&!(S=S.call(C,n[1])).done)return S;switch(C=0,S&&(n=[2&n[0],S.value]),n[0]){case 0:case 1:S=n;break;case 4:return v.label++,{value:n[1],done:!1};case 5:v.label++,C=n[1],n=[0];continue;case 7:n=v.ops.pop(),v.trys.pop();continue;default:if(!((S=(S=v.trys).length>0&&S[S.length-1])||n[0]!==6&&n[0]!==2)){v=0;continue}if(n[0]===3&&(!S||n[1]>S[0]&&n[1]<S[3])){v.label=n[1];break}if(n[0]===6&&v.label<S[1]){v.label=S[1],S=n;break}if(S&&v.label<S[2]){v.label=S[2],v.ops.push(n);break}S[2]&&v.ops.pop(),v.trys.pop();continue}n=f.call(l,v)}catch(h){n=[6,h],C=0}finally{m=S=0}if(5&n[0])throw n[1];return{value:n[0]?n[1]:void 0,done:!0}}([y,c])}}};Object.defineProperty(r,"__esModule",{value:!0}),r.SortedList=void 0;var o=function(){function l(f){this._getKey=f,this._array=[]}return l.prototype.clear=function(){this._array.length=0},l.prototype.insert=function(f){if(this._array.length!==0){var m=this._search(this._getKey(f),0,this._array.length-1);this._array.splice(m,0,f)}else this._array.push(f)},l.prototype.delete=function(f){if(this._array.length===0)return!1;var m=this._getKey(f),C=this._search(m,0,this._array.length-1);if(this._getKey(this._array[C])!==m)return!1;do if(this._array[C]===f)return this._array.splice(C,1),!0;while(++C<this._array.length&&this._getKey(this._array[C])===m);return!1},l.prototype.getKeyIterator=function(f){var m;return u(this,function(C){switch(C.label){case 0:if(this._array.length===0)return[2];if((m=this._search(f,0,this._array.length-1))<0||m>=this._array.length)return[2];if(this._getKey(this._array[m])!==f)return[2];C.label=1;case 1:return[4,this._array[m]];case 2:C.sent(),C.label=3;case 3:if(++m<this._array.length&&this._getKey(this._array[m])===f)return[3,1];C.label=4;case 4:return[2]}})},l.prototype.values=function(){return this._array.values()},l.prototype._search=function(f,m,C){if(C<m)return m;var S=Math.floor((m+C)/2);if(this._getKey(this._array[S])>f)return this._search(f,m,S-1);if(this._getKey(this._array[S])<f)return this._search(f,S+1,C);for(;S>0&&this._getKey(this._array[S-1])===f;)S--;return S},l}();r.SortedList=o},8273:(a,r)=>{function u(o,l,f,m){if(f===void 0&&(f=0),m===void 0&&(m=o.length),f>=o.length)return o;f=(o.length+f)%o.length,m=m>=o.length?o.length:(o.length+m)%o.length;for(var C=f;C<m;++C)o[C]=l;return o}Object.defineProperty(r,"__esModule",{value:!0}),r.concat=r.fillFallback=r.fill=void 0,r.fill=function(o,l,f,m){return o.fill?o.fill(l,f,m):u(o,l,f,m)},r.fillFallback=u,r.concat=function(o,l){var f=new o.constructor(o.length+l.length);return f.set(o),f.set(l,o.length),f}},9282:(a,r,u)=>{Object.defineProperty(r,"__esModule",{value:!0}),r.updateWindowsModeWrappedState=void 0;var o=u(643);r.updateWindowsModeWrappedState=function(l){var f=l.buffer.lines.get(l.buffer.ybase+l.buffer.y-1),m=f==null?void 0:f.get(l.cols-1),C=l.buffer.lines.get(l.buffer.ybase+l.buffer.y);C&&m&&(C.isWrapped=m[o.CHAR_DATA_CODE_INDEX]!==o.NULL_CELL_CODE&&m[o.CHAR_DATA_CODE_INDEX]!==o.WHITESPACE_CELL_CODE)}},3734:(a,r)=>{Object.defineProperty(r,"__esModule",{value:!0}),r.ExtendedAttrs=r.AttributeData=void 0;var u=function(){function l(){this.fg=0,this.bg=0,this.extended=new o}return l.toColorRGB=function(f){return[f>>>16&255,f>>>8&255,255&f]},l.fromColorRGB=function(f){return(255&f[0])<<16|(255&f[1])<<8|255&f[2]},l.prototype.clone=function(){var f=new l;return f.fg=this.fg,f.bg=this.bg,f.extended=this.extended.clone(),f},l.prototype.isInverse=function(){return 67108864&this.fg},l.prototype.isBold=function(){return 134217728&this.fg},l.prototype.isUnderline=function(){return 268435456&this.fg},l.prototype.isBlink=function(){return 536870912&this.fg},l.prototype.isInvisible=function(){return 1073741824&this.fg},l.prototype.isItalic=function(){return 67108864&this.bg},l.prototype.isDim=function(){return 134217728&this.bg},l.prototype.isStrikethrough=function(){return 2147483648&this.fg},l.prototype.getFgColorMode=function(){return 50331648&this.fg},l.prototype.getBgColorMode=function(){return 50331648&this.bg},l.prototype.isFgRGB=function(){return(50331648&this.fg)==50331648},l.prototype.isBgRGB=function(){return(50331648&this.bg)==50331648},l.prototype.isFgPalette=function(){return(50331648&this.fg)==16777216||(50331648&this.fg)==33554432},l.prototype.isBgPalette=function(){return(50331648&this.bg)==16777216||(50331648&this.bg)==33554432},l.prototype.isFgDefault=function(){return(50331648&this.fg)==0},l.prototype.isBgDefault=function(){return(50331648&this.bg)==0},l.prototype.isAttributeDefault=function(){return this.fg===0&&this.bg===0},l.prototype.getFgColor=function(){switch(50331648&this.fg){case 16777216:case 33554432:return 255&this.fg;case 50331648:return 16777215&this.fg;default:return-1}},l.prototype.getBgColor=function(){switch(50331648&this.bg){case 16777216:case 33554432:return 255&this.bg;case 50331648:return 16777215&this.bg;default:return-1}},l.prototype.hasExtendedAttrs=function(){return 268435456&this.bg},l.prototype.updateExtended=function(){this.extended.isEmpty()?this.bg&=-268435457:this.bg|=268435456},l.prototype.getUnderlineColor=function(){if(268435456&this.bg&&~this.extended.underlineColor)switch(50331648&this.extended.underlineColor){case 16777216:case 33554432:return 255&this.extended.underlineColor;case 50331648:return 16777215&this.extended.underlineColor;default:return this.getFgColor()}return this.getFgColor()},l.prototype.getUnderlineColorMode=function(){return 268435456&this.bg&&~this.extended.underlineColor?50331648&this.extended.underlineColor:this.getFgColorMode()},l.prototype.isUnderlineColorRGB=function(){return 268435456&this.bg&&~this.extended.underlineColor?(50331648&this.extended.underlineColor)==50331648:this.isFgRGB()},l.prototype.isUnderlineColorPalette=function(){return 268435456&this.bg&&~this.extended.underlineColor?(50331648&this.extended.underlineColor)==16777216||(50331648&this.extended.underlineColor)==33554432:this.isFgPalette()},l.prototype.isUnderlineColorDefault=function(){return 268435456&this.bg&&~this.extended.underlineColor?(50331648&this.extended.underlineColor)==0:this.isFgDefault()},l.prototype.getUnderlineStyle=function(){return 268435456&this.fg?268435456&this.bg?this.extended.underlineStyle:1:0},l}();r.AttributeData=u;var o=function(){function l(f,m){f===void 0&&(f=0),m===void 0&&(m=-1),this.underlineStyle=f,this.underlineColor=m}return l.prototype.clone=function(){return new l(this.underlineStyle,this.underlineColor)},l.prototype.isEmpty=function(){return this.underlineStyle===0},l}();r.ExtendedAttrs=o},9092:function(a,r,u){var o=this&&this.__read||function(h,_){var d=typeof Symbol=="function"&&h[Symbol.iterator];if(!d)return h;var b,g,A=d.call(h),R=[];try{for(;(_===void 0||_-- >0)&&!(b=A.next()).done;)R.push(b.value)}catch(x){g={error:x}}finally{try{b&&!b.done&&(d=A.return)&&d.call(A)}finally{if(g)throw g.error}}return R},l=this&&this.__spreadArray||function(h,_,d){if(d||arguments.length===2)for(var b,g=0,A=_.length;g<A;g++)!b&&g in _||(b||(b=Array.prototype.slice.call(_,0,g)),b[g]=_[g]);return h.concat(b||Array.prototype.slice.call(_))};Object.defineProperty(r,"__esModule",{value:!0}),r.BufferStringIterator=r.Buffer=r.MAX_BUFFER_SIZE=void 0;var f=u(6349),m=u(8437),C=u(511),S=u(643),p=u(4634),v=u(4863),w=u(7116),y=u(3734);r.MAX_BUFFER_SIZE=4294967295;var c=function(){function h(_,d,b){this._hasScrollback=_,this._optionsService=d,this._bufferService=b,this.ydisp=0,this.ybase=0,this.y=0,this.x=0,this.savedY=0,this.savedX=0,this.savedCurAttrData=m.DEFAULT_ATTR_DATA.clone(),this.savedCharset=w.DEFAULT_CHARSET,this.markers=[],this._nullCell=C.CellData.fromCharData([0,S.NULL_CELL_CHAR,S.NULL_CELL_WIDTH,S.NULL_CELL_CODE]),this._whitespaceCell=C.CellData.fromCharData([0,S.WHITESPACE_CELL_CHAR,S.WHITESPACE_CELL_WIDTH,S.WHITESPACE_CELL_CODE]),this._isClearing=!1,this._cols=this._bufferService.cols,this._rows=this._bufferService.rows,this.lines=new f.CircularList(this._getCorrectBufferLength(this._rows)),this.scrollTop=0,this.scrollBottom=this._rows-1,this.setupTabStops()}return h.prototype.getNullCell=function(_){return _?(this._nullCell.fg=_.fg,this._nullCell.bg=_.bg,this._nullCell.extended=_.extended):(this._nullCell.fg=0,this._nullCell.bg=0,this._nullCell.extended=new y.ExtendedAttrs),this._nullCell},h.prototype.getWhitespaceCell=function(_){return _?(this._whitespaceCell.fg=_.fg,this._whitespaceCell.bg=_.bg,this._whitespaceCell.extended=_.extended):(this._whitespaceCell.fg=0,this._whitespaceCell.bg=0,this._whitespaceCell.extended=new y.ExtendedAttrs),this._whitespaceCell},h.prototype.getBlankLine=function(_,d){return new m.BufferLine(this._bufferService.cols,this.getNullCell(_),d)},Object.defineProperty(h.prototype,"hasScrollback",{get:function(){return this._hasScrollback&&this.lines.maxLength>this._rows},enumerable:!1,configurable:!0}),Object.defineProperty(h.prototype,"isCursorInViewport",{get:function(){var _=this.ybase+this.y-this.ydisp;return _>=0&&_<this._rows},enumerable:!1,configurable:!0}),h.prototype._getCorrectBufferLength=function(_){if(!this._hasScrollback)return _;var d=_+this._optionsService.rawOptions.scrollback;return d>r.MAX_BUFFER_SIZE?r.MAX_BUFFER_SIZE:d},h.prototype.fillViewportRows=function(_){if(this.lines.length===0){_===void 0&&(_=m.DEFAULT_ATTR_DATA);for(var d=this._rows;d--;)this.lines.push(this.getBlankLine(_))}},h.prototype.clear=function(){this.ydisp=0,this.ybase=0,this.y=0,this.x=0,this.lines=new f.CircularList(this._getCorrectBufferLength(this._rows)),this.scrollTop=0,this.scrollBottom=this._rows-1,this.setupTabStops()},h.prototype.resize=function(_,d){var b=this.getNullCell(m.DEFAULT_ATTR_DATA),g=this._getCorrectBufferLength(d);if(g>this.lines.maxLength&&(this.lines.maxLength=g),this.lines.length>0){if(this._cols<_)for(var A=0;A<this.lines.length;A++)this.lines.get(A).resize(_,b);var R=0;if(this._rows<d)for(var x=this._rows;x<d;x++)this.lines.length<d+this.ybase&&(this._optionsService.rawOptions.windowsMode?this.lines.push(new m.BufferLine(_,b)):this.ybase>0&&this.lines.length<=this.ybase+this.y+R+1?(this.ybase--,R++,this.ydisp>0&&this.ydisp--):this.lines.push(new m.BufferLine(_,b)));else for(x=this._rows;x>d;x--)this.lines.length>d+this.ybase&&(this.lines.length>this.ybase+this.y+1?this.lines.pop():(this.ybase++,this.ydisp++));if(g<this.lines.maxLength){var k=this.lines.length-g;k>0&&(this.lines.trimStart(k),this.ybase=Math.max(this.ybase-k,0),this.ydisp=Math.max(this.ydisp-k,0),this.savedY=Math.max(this.savedY-k,0)),this.lines.maxLength=g}this.x=Math.min(this.x,_-1),this.y=Math.min(this.y,d-1),R&&(this.y+=R),this.savedX=Math.min(this.savedX,_-1),this.scrollTop=0}if(this.scrollBottom=d-1,this._isReflowEnabled&&(this._reflow(_,d),this._cols>_))for(A=0;A<this.lines.length;A++)this.lines.get(A).resize(_,b);this._cols=_,this._rows=d},Object.defineProperty(h.prototype,"_isReflowEnabled",{get:function(){return this._hasScrollback&&!this._optionsService.rawOptions.windowsMode},enumerable:!1,configurable:!0}),h.prototype._reflow=function(_,d){this._cols!==_&&(_>this._cols?this._reflowLarger(_,d):this._reflowSmaller(_,d))},h.prototype._reflowLarger=function(_,d){var b=(0,p.reflowLargerGetLinesToRemove)(this.lines,this._cols,_,this.ybase+this.y,this.getNullCell(m.DEFAULT_ATTR_DATA));if(b.length>0){var g=(0,p.reflowLargerCreateNewLayout)(this.lines,b);(0,p.reflowLargerApplyNewLayout)(this.lines,g.layout),this._reflowLargerAdjustViewport(_,d,g.countRemoved)}},h.prototype._reflowLargerAdjustViewport=function(_,d,b){for(var g=this.getNullCell(m.DEFAULT_ATTR_DATA),A=b;A-- >0;)this.ybase===0?(this.y>0&&this.y--,this.lines.length<d&&this.lines.push(new m.BufferLine(_,g))):(this.ydisp===this.ybase&&this.ydisp--,this.ybase--);this.savedY=Math.max(this.savedY-b,0)},h.prototype._reflowSmaller=function(_,d){for(var b=this.getNullCell(m.DEFAULT_ATTR_DATA),g=[],A=0,R=this.lines.length-1;R>=0;R--){var x=this.lines.get(R);if(!(!x||!x.isWrapped&&x.getTrimmedLength()<=_)){for(var k=[x];x.isWrapped&&R>0;)x=this.lines.get(--R),k.unshift(x);var O=this.ybase+this.y;if(!(O>=R&&O<R+k.length)){var I,T=k[k.length-1].getTrimmedLength(),P=(0,p.reflowSmallerGetNewLineLengths)(k,this._cols,_),M=P.length-k.length;I=this.ybase===0&&this.y!==this.lines.length-1?Math.max(0,this.y-this.lines.maxLength+M):Math.max(0,this.lines.length-this.lines.maxLength+M);for(var D=[],q=0;q<M;q++){var H=this.getBlankLine(m.DEFAULT_ATTR_DATA,!0);D.push(H)}D.length>0&&(g.push({start:R+k.length+A,newLines:D}),A+=D.length),k.push.apply(k,l([],o(D),!1));var X=P.length-1,$=P[X];$===0&&($=P[--X]);for(var G=k.length-M-1,ie=T;G>=0;){var ee=Math.min(ie,$);if(k[X]===void 0)break;if(k[X].copyCellsFrom(k[G],ie-ee,$-ee,ee,!0),($-=ee)==0&&($=P[--X]),(ie-=ee)==0){G--;var B=Math.max(G,0);ie=(0,p.getWrappedLineTrimmedLength)(k,B,this._cols)}}for(q=0;q<k.length;q++)P[q]<_&&k[q].setCell(P[q],b);for(var pe=M-I;pe-- >0;)this.ybase===0?this.y<d-1?(this.y++,this.lines.pop()):(this.ybase++,this.ydisp++):this.ybase<Math.min(this.lines.maxLength,this.lines.length+A)-d&&(this.ybase===this.ydisp&&this.ydisp++,this.ybase++);this.savedY=Math.min(this.savedY+M,this.ybase+d-1)}}}if(g.length>0){var de=[],Oe=[];for(q=0;q<this.lines.length;q++)Oe.push(this.lines.get(q));var N=this.lines.length,xe=N-1,le=0,K=g[le];this.lines.length=Math.min(this.lines.maxLength,this.lines.length+A);var F=0;for(q=Math.min(this.lines.maxLength-1,N+A-1);q>=0;q--)if(K&&K.start>xe+F){for(var U=K.newLines.length-1;U>=0;U--)this.lines.set(q--,K.newLines[U]);q++,de.push({index:xe+1,amount:K.newLines.length}),F+=K.newLines.length,K=g[++le]}else this.lines.set(q,Oe[xe--]);var W=0;for(q=de.length-1;q>=0;q--)de[q].index+=W,this.lines.onInsertEmitter.fire(de[q]),W+=de[q].amount;var ae=Math.max(0,N+A-this.lines.maxLength);ae>0&&this.lines.onTrimEmitter.fire(ae)}},h.prototype.stringIndexToBufferIndex=function(_,d,b){for(b===void 0&&(b=!1);d;){var g=this.lines.get(_);if(!g)return[-1,-1];for(var A=b?g.getTrimmedLength():g.length,R=0;R<A;++R)if(g.get(R)[S.CHAR_DATA_WIDTH_INDEX]&&(d-=g.get(R)[S.CHAR_DATA_CHAR_INDEX].length||1),d<0)return[_,R];_++}return[_,0]},h.prototype.translateBufferLineToString=function(_,d,b,g){b===void 0&&(b=0);var A=this.lines.get(_);return A?A.translateToString(d,b,g):""},h.prototype.getWrappedRangeForLine=function(_){for(var d=_,b=_;d>0&&this.lines.get(d).isWrapped;)d--;for(;b+1<this.lines.length&&this.lines.get(b+1).isWrapped;)b++;return{first:d,last:b}},h.prototype.setupTabStops=function(_){for(_!=null?this.tabs[_]||(_=this.prevStop(_)):(this.tabs={},_=0);_<this._cols;_+=this._optionsService.rawOptions.tabStopWidth)this.tabs[_]=!0},h.prototype.prevStop=function(_){for(_==null&&(_=this.x);!this.tabs[--_]&&_>0;);return _>=this._cols?this._cols-1:_<0?0:_},h.prototype.nextStop=function(_){for(_==null&&(_=this.x);!this.tabs[++_]&&_<this._cols;);return _>=this._cols?this._cols-1:_<0?0:_},h.prototype.clearMarkers=function(_){this._isClearing=!0;for(var d=0;d<this.markers.length;d++)this.markers[d].line===_&&(this.markers[d].dispose(),this.markers.splice(d--,1));this._isClearing=!1},h.prototype.clearAllMarkers=function(){this._isClearing=!0;for(var _=0;_<this.markers.length;_++)this.markers[_].dispose(),this.markers.splice(_--,1);this._isClearing=!1},h.prototype.addMarker=function(_){var d=this,b=new v.Marker(_);return this.markers.push(b),b.register(this.lines.onTrim(function(g){b.line-=g,b.line<0&&b.dispose()})),b.register(this.lines.onInsert(function(g){b.line>=g.index&&(b.line+=g.amount)})),b.register(this.lines.onDelete(function(g){b.line>=g.index&&b.line<g.index+g.amount&&b.dispose(),b.line>g.index&&(b.line-=g.amount)})),b.register(b.onDispose(function(){return d._removeMarker(b)})),b},h.prototype._removeMarker=function(_){this._isClearing||this.markers.splice(this.markers.indexOf(_),1)},h.prototype.iterator=function(_,d,b,g,A){return new n(this,_,d,b,g,A)},h}();r.Buffer=c;var n=function(){function h(_,d,b,g,A,R){b===void 0&&(b=0),g===void 0&&(g=_.lines.length),A===void 0&&(A=0),R===void 0&&(R=0),this._buffer=_,this._trimRight=d,this._startIndex=b,this._endIndex=g,this._startOverscan=A,this._endOverscan=R,this._startIndex<0&&(this._startIndex=0),this._endIndex>this._buffer.lines.length&&(this._endIndex=this._buffer.lines.length),this._current=this._startIndex}return h.prototype.hasNext=function(){return this._current<this._endIndex},h.prototype.next=function(){var _=this._buffer.getWrappedRangeForLine(this._current);_.first<this._startIndex-this._startOverscan&&(_.first=this._startIndex-this._startOverscan),_.last>this._endIndex+this._endOverscan&&(_.last=this._endIndex+this._endOverscan),_.first=Math.max(_.first,0),_.last=Math.min(_.last,this._buffer.lines.length);for(var d="",b=_.first;b<=_.last;++b)d+=this._buffer.translateBufferLineToString(b,this._trimRight);return this._current=_.last+1,{range:_,content:d}},h}();r.BufferStringIterator=n},8437:(a,r,u)=>{Object.defineProperty(r,"__esModule",{value:!0}),r.BufferLine=r.DEFAULT_ATTR_DATA=void 0;var o=u(482),l=u(643),f=u(511),m=u(3734);r.DEFAULT_ATTR_DATA=Object.freeze(new m.AttributeData);var C=function(){function S(p,v,w){w===void 0&&(w=!1),this.isWrapped=w,this._combined={},this._extendedAttrs={},this._data=new Uint32Array(3*p);for(var y=v||f.CellData.fromCharData([0,l.NULL_CELL_CHAR,l.NULL_CELL_WIDTH,l.NULL_CELL_CODE]),c=0;c<p;++c)this.setCell(c,y);this.length=p}return S.prototype.get=function(p){var v=this._data[3*p+0],w=2097151&v;return[this._data[3*p+1],2097152&v?this._combined[p]:w?(0,o.stringFromCodePoint)(w):"",v>>22,2097152&v?this._combined[p].charCodeAt(this._combined[p].length-1):w]},S.prototype.set=function(p,v){this._data[3*p+1]=v[l.CHAR_DATA_ATTR_INDEX],v[l.CHAR_DATA_CHAR_INDEX].length>1?(this._combined[p]=v[1],this._data[3*p+0]=2097152|p|v[l.CHAR_DATA_WIDTH_INDEX]<<22):this._data[3*p+0]=v[l.CHAR_DATA_CHAR_INDEX].charCodeAt(0)|v[l.CHAR_DATA_WIDTH_INDEX]<<22},S.prototype.getWidth=function(p){return this._data[3*p+0]>>22},S.prototype.hasWidth=function(p){return 12582912&this._data[3*p+0]},S.prototype.getFg=function(p){return this._data[3*p+1]},S.prototype.getBg=function(p){return this._data[3*p+2]},S.prototype.hasContent=function(p){return 4194303&this._data[3*p+0]},S.prototype.getCodePoint=function(p){var v=this._data[3*p+0];return 2097152&v?this._combined[p].charCodeAt(this._combined[p].length-1):2097151&v},S.prototype.isCombined=function(p){return 2097152&this._data[3*p+0]},S.prototype.getString=function(p){var v=this._data[3*p+0];return 2097152&v?this._combined[p]:2097151&v?(0,o.stringFromCodePoint)(2097151&v):""},S.prototype.loadCell=function(p,v){var w=3*p;return v.content=this._data[w+0],v.fg=this._data[w+1],v.bg=this._data[w+2],2097152&v.content&&(v.combinedData=this._combined[p]),268435456&v.bg&&(v.extended=this._extendedAttrs[p]),v},S.prototype.setCell=function(p,v){2097152&v.content&&(this._combined[p]=v.combinedData),268435456&v.bg&&(this._extendedAttrs[p]=v.extended),this._data[3*p+0]=v.content,this._data[3*p+1]=v.fg,this._data[3*p+2]=v.bg},S.prototype.setCellFromCodePoint=function(p,v,w,y,c,n){268435456&c&&(this._extendedAttrs[p]=n),this._data[3*p+0]=v|w<<22,this._data[3*p+1]=y,this._data[3*p+2]=c},S.prototype.addCodepointToCell=function(p,v){var w=this._data[3*p+0];2097152&w?this._combined[p]+=(0,o.stringFromCodePoint)(v):(2097151&w?(this._combined[p]=(0,o.stringFromCodePoint)(2097151&w)+(0,o.stringFromCodePoint)(v),w&=-2097152,w|=2097152):w=v|1<<22,this._data[3*p+0]=w)},S.prototype.insertCells=function(p,v,w,y){if((p%=this.length)&&this.getWidth(p-1)===2&&this.setCellFromCodePoint(p-1,0,1,(y==null?void 0:y.fg)||0,(y==null?void 0:y.bg)||0,(y==null?void 0:y.extended)||new m.ExtendedAttrs),v<this.length-p){for(var c=new f.CellData,n=this.length-p-v-1;n>=0;--n)this.setCell(p+v+n,this.loadCell(p+n,c));for(n=0;n<v;++n)this.setCell(p+n,w)}else for(n=p;n<this.length;++n)this.setCell(n,w);this.getWidth(this.length-1)===2&&this.setCellFromCodePoint(this.length-1,0,1,(y==null?void 0:y.fg)||0,(y==null?void 0:y.bg)||0,(y==null?void 0:y.extended)||new m.ExtendedAttrs)},S.prototype.deleteCells=function(p,v,w,y){if(p%=this.length,v<this.length-p){for(var c=new f.CellData,n=0;n<this.length-p-v;++n)this.setCell(p+n,this.loadCell(p+v+n,c));for(n=this.length-v;n<this.length;++n)this.setCell(n,w)}else for(n=p;n<this.length;++n)this.setCell(n,w);p&&this.getWidth(p-1)===2&&this.setCellFromCodePoint(p-1,0,1,(y==null?void 0:y.fg)||0,(y==null?void 0:y.bg)||0,(y==null?void 0:y.extended)||new m.ExtendedAttrs),this.getWidth(p)!==0||this.hasContent(p)||this.setCellFromCodePoint(p,0,1,(y==null?void 0:y.fg)||0,(y==null?void 0:y.bg)||0,(y==null?void 0:y.extended)||new m.ExtendedAttrs)},S.prototype.replaceCells=function(p,v,w,y){for(p&&this.getWidth(p-1)===2&&this.setCellFromCodePoint(p-1,0,1,(y==null?void 0:y.fg)||0,(y==null?void 0:y.bg)||0,(y==null?void 0:y.extended)||new m.ExtendedAttrs),v<this.length&&this.getWidth(v-1)===2&&this.setCellFromCodePoint(v,0,1,(y==null?void 0:y.fg)||0,(y==null?void 0:y.bg)||0,(y==null?void 0:y.extended)||new m.ExtendedAttrs);p<v&&p<this.length;)this.setCell(p++,w)},S.prototype.resize=function(p,v){if(p!==this.length){if(p>this.length){var w=new Uint32Array(3*p);this.length&&(3*p<this._data.length?w.set(this._data.subarray(0,3*p)):w.set(this._data)),this._data=w;for(var y=this.length;y<p;++y)this.setCell(y,v)}else if(p){(w=new Uint32Array(3*p)).set(this._data.subarray(0,3*p)),this._data=w;var c=Object.keys(this._combined);for(y=0;y<c.length;y++){var n=parseInt(c[y],10);n>=p&&delete this._combined[n]}}else this._data=new Uint32Array(0),this._combined={};this.length=p}},S.prototype.fill=function(p){this._combined={},this._extendedAttrs={};for(var v=0;v<this.length;++v)this.setCell(v,p)},S.prototype.copyFrom=function(p){for(var v in this.length!==p.length?this._data=new Uint32Array(p._data):this._data.set(p._data),this.length=p.length,this._combined={},p._combined)this._combined[v]=p._combined[v];for(var v in this._extendedAttrs={},p._extendedAttrs)this._extendedAttrs[v]=p._extendedAttrs[v];this.isWrapped=p.isWrapped},S.prototype.clone=function(){var p=new S(0);for(var v in p._data=new Uint32Array(this._data),p.length=this.length,this._combined)p._combined[v]=this._combined[v];for(var v in this._extendedAttrs)p._extendedAttrs[v]=this._extendedAttrs[v];return p.isWrapped=this.isWrapped,p},S.prototype.getTrimmedLength=function(){for(var p=this.length-1;p>=0;--p)if(4194303&this._data[3*p+0])return p+(this._data[3*p+0]>>22);return 0},S.prototype.copyCellsFrom=function(p,v,w,y,c){var n=p._data;if(c)for(var h=y-1;h>=0;h--)for(var _=0;_<3;_++)this._data[3*(w+h)+_]=n[3*(v+h)+_];else for(h=0;h<y;h++)for(_=0;_<3;_++)this._data[3*(w+h)+_]=n[3*(v+h)+_];var d=Object.keys(p._combined);for(_=0;_<d.length;_++){var b=parseInt(d[_],10);b>=v&&(this._combined[b-v+w]=p._combined[b])}},S.prototype.translateToString=function(p,v,w){p===void 0&&(p=!1),v===void 0&&(v=0),w===void 0&&(w=this.length),p&&(w=Math.min(w,this.getTrimmedLength()));for(var y="";v<w;){var c=this._data[3*v+0],n=2097151&c;y+=2097152&c?this._combined[v]:n?(0,o.stringFromCodePoint)(n):l.WHITESPACE_CELL_CHAR,v+=c>>22||1}return y},S}();r.BufferLine=C},4841:(a,r)=>{Object.defineProperty(r,"__esModule",{value:!0}),r.getRangeLength=void 0,r.getRangeLength=function(u,o){if(u.start.y>u.end.y)throw new Error("Buffer range end ("+u.end.x+", "+u.end.y+") cannot be before start ("+u.start.x+", "+u.start.y+")");return o*(u.end.y-u.start.y)+(u.end.x-u.start.x+1)}},4634:(a,r)=>{function u(o,l,f){if(l===o.length-1)return o[l].getTrimmedLength();var m=!o[l].hasContent(f-1)&&o[l].getWidth(f-1)===1,C=o[l+1].getWidth(0)===2;return m&&C?f-1:f}Object.defineProperty(r,"__esModule",{value:!0}),r.getWrappedLineTrimmedLength=r.reflowSmallerGetNewLineLengths=r.reflowLargerApplyNewLayout=r.reflowLargerCreateNewLayout=r.reflowLargerGetLinesToRemove=void 0,r.reflowLargerGetLinesToRemove=function(o,l,f,m,C){for(var S=[],p=0;p<o.length-1;p++){var v=p,w=o.get(++v);if(w.isWrapped){for(var y=[o.get(p)];v<o.length&&w.isWrapped;)y.push(w),w=o.get(++v);if(m>=p&&m<v)p+=y.length-1;else{for(var c=0,n=u(y,c,l),h=1,_=0;h<y.length;){var d=u(y,h,l),b=d-_,g=f-n,A=Math.min(b,g);y[c].copyCellsFrom(y[h],_,n,A,!1),(n+=A)===f&&(c++,n=0),(_+=A)===d&&(h++,_=0),n===0&&c!==0&&y[c-1].getWidth(f-1)===2&&(y[c].copyCellsFrom(y[c-1],f-1,n++,1,!1),y[c-1].setCell(f-1,C))}y[c].replaceCells(n,f,C);for(var R=0,x=y.length-1;x>0&&(x>c||y[x].getTrimmedLength()===0);x--)R++;R>0&&(S.push(p+y.length-R),S.push(R)),p+=y.length-1}}}return S},r.reflowLargerCreateNewLayout=function(o,l){for(var f=[],m=0,C=l[m],S=0,p=0;p<o.length;p++)if(C===p){var v=l[++m];o.onDeleteEmitter.fire({index:p-S,amount:v}),p+=v-1,S+=v,C=l[++m]}else f.push(p);return{layout:f,countRemoved:S}},r.reflowLargerApplyNewLayout=function(o,l){for(var f=[],m=0;m<l.length;m++)f.push(o.get(l[m]));for(m=0;m<f.length;m++)o.set(m,f[m]);o.length=l.length},r.reflowSmallerGetNewLineLengths=function(o,l,f){for(var m=[],C=o.map(function(n,h){return u(o,h,l)}).reduce(function(n,h){return n+h}),S=0,p=0,v=0;v<C;){if(C-v<f){m.push(C-v);break}S+=f;var w=u(o,p,l);S>w&&(S-=w,p++);var y=o[p].getWidth(S-1)===2;y&&S--;var c=y?f-1:f;m.push(c),v+=c}return m},r.getWrappedLineTrimmedLength=u},5295:function(a,r,u){var o,l=this&&this.__extends||(o=function(S,p){return o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(v,w){v.__proto__=w}||function(v,w){for(var y in w)Object.prototype.hasOwnProperty.call(w,y)&&(v[y]=w[y])},o(S,p)},function(S,p){if(typeof p!="function"&&p!==null)throw new TypeError("Class extends value "+String(p)+" is not a constructor or null");function v(){this.constructor=S}o(S,p),S.prototype=p===null?Object.create(p):(v.prototype=p.prototype,new v)});Object.defineProperty(r,"__esModule",{value:!0}),r.BufferSet=void 0;var f=u(9092),m=u(8460),C=function(S){function p(v,w){var y=S.call(this)||this;return y._optionsService=v,y._bufferService=w,y._onBufferActivate=y.register(new m.EventEmitter),y.reset(),y}return l(p,S),Object.defineProperty(p.prototype,"onBufferActivate",{get:function(){return this._onBufferActivate.event},enumerable:!1,configurable:!0}),p.prototype.reset=function(){this._normal=new f.Buffer(!0,this._optionsService,this._bufferService),this._normal.fillViewportRows(),this._alt=new f.Buffer(!1,this._optionsService,this._bufferService),this._activeBuffer=this._normal,this._onBufferActivate.fire({activeBuffer:this._normal,inactiveBuffer:this._alt}),this.setupTabStops()},Object.defineProperty(p.prototype,"alt",{get:function(){return this._alt},enumerable:!1,configurable:!0}),Object.defineProperty(p.prototype,"active",{get:function(){return this._activeBuffer},enumerable:!1,configurable:!0}),Object.defineProperty(p.prototype,"normal",{get:function(){return this._normal},enumerable:!1,configurable:!0}),p.prototype.activateNormalBuffer=function(){this._activeBuffer!==this._normal&&(this._normal.x=this._alt.x,this._normal.y=this._alt.y,this._alt.clear(),this._activeBuffer=this._normal,this._onBufferActivate.fire({activeBuffer:this._normal,inactiveBuffer:this._alt}))},p.prototype.activateAltBuffer=function(v){this._activeBuffer!==this._alt&&(this._alt.fillViewportRows(v),this._alt.x=this._normal.x,this._alt.y=this._normal.y,this._activeBuffer=this._alt,this._onBufferActivate.fire({activeBuffer:this._alt,inactiveBuffer:this._normal}))},p.prototype.resize=function(v,w){this._normal.resize(v,w),this._alt.resize(v,w)},p.prototype.setupTabStops=function(v){this._normal.setupTabStops(v),this._alt.setupTabStops(v)},p}(u(844).Disposable);r.BufferSet=C},511:function(a,r,u){var o,l=this&&this.__extends||(o=function(p,v){return o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(w,y){w.__proto__=y}||function(w,y){for(var c in y)Object.prototype.hasOwnProperty.call(y,c)&&(w[c]=y[c])},o(p,v)},function(p,v){if(typeof v!="function"&&v!==null)throw new TypeError("Class extends value "+String(v)+" is not a constructor or null");function w(){this.constructor=p}o(p,v),p.prototype=v===null?Object.create(v):(w.prototype=v.prototype,new w)});Object.defineProperty(r,"__esModule",{value:!0}),r.CellData=void 0;var f=u(482),m=u(643),C=u(3734),S=function(p){function v(){var w=p!==null&&p.apply(this,arguments)||this;return w.content=0,w.fg=0,w.bg=0,w.extended=new C.ExtendedAttrs,w.combinedData="",w}return l(v,p),v.fromCharData=function(w){var y=new v;return y.setFromCharData(w),y},v.prototype.isCombined=function(){return 2097152&this.content},v.prototype.getWidth=function(){return this.content>>22},v.prototype.getChars=function(){return 2097152&this.content?this.combinedData:2097151&this.content?(0,f.stringFromCodePoint)(2097151&this.content):""},v.prototype.getCode=function(){return this.isCombined()?this.combinedData.charCodeAt(this.combinedData.length-1):2097151&this.content},v.prototype.setFromCharData=function(w){this.fg=w[m.CHAR_DATA_ATTR_INDEX],this.bg=0;var y=!1;if(w[m.CHAR_DATA_CHAR_INDEX].length>2)y=!0;else if(w[m.CHAR_DATA_CHAR_INDEX].length===2){var c=w[m.CHAR_DATA_CHAR_INDEX].charCodeAt(0);if(55296<=c&&c<=56319){var n=w[m.CHAR_DATA_CHAR_INDEX].charCodeAt(1);56320<=n&&n<=57343?this.content=1024*(c-55296)+n-56320+65536|w[m.CHAR_DATA_WIDTH_INDEX]<<22:y=!0}else y=!0}else this.content=w[m.CHAR_DATA_CHAR_INDEX].charCodeAt(0)|w[m.CHAR_DATA_WIDTH_INDEX]<<22;y&&(this.combinedData=w[m.CHAR_DATA_CHAR_INDEX],this.content=2097152|w[m.CHAR_DATA_WIDTH_INDEX]<<22)},v.prototype.getAsCharData=function(){return[this.fg,this.getChars(),this.getWidth(),this.getCode()]},v}(C.AttributeData);r.CellData=S},643:(a,r)=>{Object.defineProperty(r,"__esModule",{value:!0}),r.WHITESPACE_CELL_CODE=r.WHITESPACE_CELL_WIDTH=r.WHITESPACE_CELL_CHAR=r.NULL_CELL_CODE=r.NULL_CELL_WIDTH=r.NULL_CELL_CHAR=r.CHAR_DATA_CODE_INDEX=r.CHAR_DATA_WIDTH_INDEX=r.CHAR_DATA_CHAR_INDEX=r.CHAR_DATA_ATTR_INDEX=r.DEFAULT_ATTR=r.DEFAULT_COLOR=void 0,r.DEFAULT_COLOR=256,r.DEFAULT_ATTR=256|r.DEFAULT_COLOR<<9,r.CHAR_DATA_ATTR_INDEX=0,r.CHAR_DATA_CHAR_INDEX=1,r.CHAR_DATA_WIDTH_INDEX=2,r.CHAR_DATA_CODE_INDEX=3,r.NULL_CELL_CHAR="",r.NULL_CELL_WIDTH=1,r.NULL_CELL_CODE=0,r.WHITESPACE_CELL_CHAR=" ",r.WHITESPACE_CELL_WIDTH=1,r.WHITESPACE_CELL_CODE=32},4863:function(a,r,u){var o,l=this&&this.__extends||(o=function(C,S){return o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(p,v){p.__proto__=v}||function(p,v){for(var w in v)Object.prototype.hasOwnProperty.call(v,w)&&(p[w]=v[w])},o(C,S)},function(C,S){if(typeof S!="function"&&S!==null)throw new TypeError("Class extends value "+String(S)+" is not a constructor or null");function p(){this.constructor=C}o(C,S),C.prototype=S===null?Object.create(S):(p.prototype=S.prototype,new p)});Object.defineProperty(r,"__esModule",{value:!0}),r.Marker=void 0;var f=u(8460),m=function(C){function S(p){var v=C.call(this)||this;return v.line=p,v._id=S._nextId++,v.isDisposed=!1,v._onDispose=new f.EventEmitter,v}return l(S,C),Object.defineProperty(S.prototype,"id",{get:function(){return this._id},enumerable:!1,configurable:!0}),Object.defineProperty(S.prototype,"onDispose",{get:function(){return this._onDispose.event},enumerable:!1,configurable:!0}),S.prototype.dispose=function(){this.isDisposed||(this.isDisposed=!0,this.line=-1,this._onDispose.fire(),C.prototype.dispose.call(this))},S._nextId=1,S}(u(844).Disposable);r.Marker=m},7116:(a,r)=>{Object.defineProperty(r,"__esModule",{value:!0}),r.DEFAULT_CHARSET=r.CHARSETS=void 0,r.CHARSETS={},r.DEFAULT_CHARSET=r.CHARSETS.B,r.CHARSETS[0]={"`":"â",a:"â",b:"â",c:"â",d:"â",e:"â",f:"Â°",g:"Â±",h:"â¤",i:"â",j:"â",k:"â",l:"â",m:"â",n:"â¼",o:"âº",p:"â»",q:"â",r:"â¼",s:"â½",t:"â",u:"â¤",v:"â´",w:"â¬",x:"â",y:"â¤",z:"â¥","{":"Ï","|":"â ","}":"Â£","~":"Â·"},r.CHARSETS.A={"#":"Â£"},r.CHARSETS.B=void 0,r.CHARSETS[4]={"#":"Â£","@":"Â¾","[":"ij","\\":"Â½","]":"|","{":"Â¨","|":"f","}":"Â¼","~":"Â´"},r.CHARSETS.C=r.CHARSETS[5]={"[":"Ã","\\":"Ã","]":"Ã","^":"Ã","`":"Ã©","{":"Ã¤","|":"Ã¶","}":"Ã¥","~":"Ã¼"},r.CHARSETS.R={"#":"Â£","@":"Ã ","[":"Â°","\\":"Ã§","]":"Â§","{":"Ã©","|":"Ã¹","}":"Ã¨","~":"Â¨"},r.CHARSETS.Q={"@":"Ã ","[":"Ã¢","\\":"Ã§","]":"Ãª","^":"Ã®","`":"Ã´","{":"Ã©","|":"Ã¹","}":"Ã¨","~":"Ã»"},r.CHARSETS.K={"@":"Â§","[":"Ã","\\":"Ã","]":"Ã","{":"Ã¤","|":"Ã¶","}":"Ã¼","~":"Ã"},r.CHARSETS.Y={"#":"Â£","@":"Â§","[":"Â°","\\":"Ã§","]":"Ã©","`":"Ã¹","{":"Ã ","|":"Ã²","}":"Ã¨","~":"Ã¬"},r.CHARSETS.E=r.CHARSETS[6]={"@":"Ã","[":"Ã","\\":"Ã","]":"Ã","^":"Ã","`":"Ã¤","{":"Ã¦","|":"Ã¸","}":"Ã¥","~":"Ã¼"},r.CHARSETS.Z={"#":"Â£","@":"Â§","[":"Â¡","\\":"Ã","]":"Â¿","{":"Â°","|":"Ã±","}":"Ã§"},r.CHARSETS.H=r.CHARSETS[7]={"@":"Ã","[":"Ã","\\":"Ã","]":"Ã","^":"Ã","`":"Ã©","{":"Ã¤","|":"Ã¶","}":"Ã¥","~":"Ã¼"},r.CHARSETS["="]={"#":"Ã¹","@":"Ã ","[":"Ã©","\\":"Ã§","]":"Ãª","^":"Ã®",_:"Ã¨","`":"Ã´","{":"Ã¤","|":"Ã¶","}":"Ã¼","~":"Ã»"}},2584:(a,r)=>{var u,o;Object.defineProperty(r,"__esModule",{value:!0}),r.C1_ESCAPED=r.C1=r.C0=void 0,function(l){l.NUL="\0",l.SOH="",l.STX="",l.ETX="",l.EOT="",l.ENQ="",l.ACK="",l.BEL="\x07",l.BS="\b",l.HT="	",l.LF=`
`,l.VT="\v",l.FF="\f",l.CR="\r",l.SO="",l.SI="",l.DLE="",l.DC1="",l.DC2="",l.DC3="",l.DC4="",l.NAK="",l.SYN="",l.ETB="",l.CAN="",l.EM="",l.SUB="",l.ESC="\x1B",l.FS="",l.GS="",l.RS="",l.US="",l.SP=" ",l.DEL=""}(u=r.C0||(r.C0={})),(o=r.C1||(r.C1={})).PAD="Â",o.HOP="Â",o.BPH="Â",o.NBH="Â",o.IND="Â",o.NEL="Â",o.SSA="Â",o.ESA="Â",o.HTS="Â",o.HTJ="Â",o.VTS="Â",o.PLD="Â",o.PLU="Â",o.RI="Â",o.SS2="Â",o.SS3="Â",o.DCS="Â",o.PU1="Â",o.PU2="Â",o.STS="Â",o.CCH="Â",o.MW="Â",o.SPA="Â",o.EPA="Â",o.SOS="Â",o.SGCI="Â",o.SCI="Â",o.CSI="Â",o.ST="Â",o.OSC="Â",o.PM="Â",o.APC="Â",(r.C1_ESCAPED||(r.C1_ESCAPED={})).ST=u.ESC+"\\"},7399:(a,r,u)=>{Object.defineProperty(r,"__esModule",{value:!0}),r.evaluateKeyboardEvent=void 0;var o=u(2584),l={48:["0",")"],49:["1","!"],50:["2","@"],51:["3","#"],52:["4","$"],53:["5","%"],54:["6","^"],55:["7","&"],56:["8","*"],57:["9","("],186:[";",":"],187:["=","+"],188:[",","<"],189:["-","_"],190:[".",">"],191:["/","?"],192:["`","~"],219:["[","{"],220:["\\","|"],221:["]","}"],222:["'",'"']};r.evaluateKeyboardEvent=function(f,m,C,S){var p={type:0,cancel:!1,key:void 0},v=(f.shiftKey?1:0)|(f.altKey?2:0)|(f.ctrlKey?4:0)|(f.metaKey?8:0);switch(f.keyCode){case 0:f.key==="UIKeyInputUpArrow"?p.key=m?o.C0.ESC+"OA":o.C0.ESC+"[A":f.key==="UIKeyInputLeftArrow"?p.key=m?o.C0.ESC+"OD":o.C0.ESC+"[D":f.key==="UIKeyInputRightArrow"?p.key=m?o.C0.ESC+"OC":o.C0.ESC+"[C":f.key==="UIKeyInputDownArrow"&&(p.key=m?o.C0.ESC+"OB":o.C0.ESC+"[B");break;case 8:if(f.shiftKey){p.key=o.C0.BS;break}if(f.altKey){p.key=o.C0.ESC+o.C0.DEL;break}p.key=o.C0.DEL;break;case 9:if(f.shiftKey){p.key=o.C0.ESC+"[Z";break}p.key=o.C0.HT,p.cancel=!0;break;case 13:p.key=f.altKey?o.C0.ESC+o.C0.CR:o.C0.CR,p.cancel=!0;break;case 27:p.key=o.C0.ESC,f.altKey&&(p.key=o.C0.ESC+o.C0.ESC),p.cancel=!0;break;case 37:if(f.metaKey)break;v?(p.key=o.C0.ESC+"[1;"+(v+1)+"D",p.key===o.C0.ESC+"[1;3D"&&(p.key=o.C0.ESC+(C?"b":"[1;5D"))):p.key=m?o.C0.ESC+"OD":o.C0.ESC+"[D";break;case 39:if(f.metaKey)break;v?(p.key=o.C0.ESC+"[1;"+(v+1)+"C",p.key===o.C0.ESC+"[1;3C"&&(p.key=o.C0.ESC+(C?"f":"[1;5C"))):p.key=m?o.C0.ESC+"OC":o.C0.ESC+"[C";break;case 38:if(f.metaKey)break;v?(p.key=o.C0.ESC+"[1;"+(v+1)+"A",C||p.key!==o.C0.ESC+"[1;3A"||(p.key=o.C0.ESC+"[1;5A")):p.key=m?o.C0.ESC+"OA":o.C0.ESC+"[A";break;case 40:if(f.metaKey)break;v?(p.key=o.C0.ESC+"[1;"+(v+1)+"B",C||p.key!==o.C0.ESC+"[1;3B"||(p.key=o.C0.ESC+"[1;5B")):p.key=m?o.C0.ESC+"OB":o.C0.ESC+"[B";break;case 45:f.shiftKey||f.ctrlKey||(p.key=o.C0.ESC+"[2~");break;case 46:p.key=v?o.C0.ESC+"[3;"+(v+1)+"~":o.C0.ESC+"[3~";break;case 36:p.key=v?o.C0.ESC+"[1;"+(v+1)+"H":m?o.C0.ESC+"OH":o.C0.ESC+"[H";break;case 35:p.key=v?o.C0.ESC+"[1;"+(v+1)+"F":m?o.C0.ESC+"OF":o.C0.ESC+"[F";break;case 33:f.shiftKey?p.type=2:f.ctrlKey?p.key=o.C0.ESC+"[5;"+(v+1)+"~":p.key=o.C0.ESC+"[5~";break;case 34:f.shiftKey?p.type=3:f.ctrlKey?p.key=o.C0.ESC+"[6;"+(v+1)+"~":p.key=o.C0.ESC+"[6~";break;case 112:p.key=v?o.C0.ESC+"[1;"+(v+1)+"P":o.C0.ESC+"OP";break;case 113:p.key=v?o.C0.ESC+"[1;"+(v+1)+"Q":o.C0.ESC+"OQ";break;case 114:p.key=v?o.C0.ESC+"[1;"+(v+1)+"R":o.C0.ESC+"OR";break;case 115:p.key=v?o.C0.ESC+"[1;"+(v+1)+"S":o.C0.ESC+"OS";break;case 116:p.key=v?o.C0.ESC+"[15;"+(v+1)+"~":o.C0.ESC+"[15~";break;case 117:p.key=v?o.C0.ESC+"[17;"+(v+1)+"~":o.C0.ESC+"[17~";break;case 118:p.key=v?o.C0.ESC+"[18;"+(v+1)+"~":o.C0.ESC+"[18~";break;case 119:p.key=v?o.C0.ESC+"[19;"+(v+1)+"~":o.C0.ESC+"[19~";break;case 120:p.key=v?o.C0.ESC+"[20;"+(v+1)+"~":o.C0.ESC+"[20~";break;case 121:p.key=v?o.C0.ESC+"[21;"+(v+1)+"~":o.C0.ESC+"[21~";break;case 122:p.key=v?o.C0.ESC+"[23;"+(v+1)+"~":o.C0.ESC+"[23~";break;case 123:p.key=v?o.C0.ESC+"[24;"+(v+1)+"~":o.C0.ESC+"[24~";break;default:if(!f.ctrlKey||f.shiftKey||f.altKey||f.metaKey)if(C&&!S||!f.altKey||f.metaKey)!C||f.altKey||f.ctrlKey||f.shiftKey||!f.metaKey?f.key&&!f.ctrlKey&&!f.altKey&&!f.metaKey&&f.keyCode>=48&&f.key.length===1?p.key=f.key:f.key&&f.ctrlKey&&(f.key==="_"&&(p.key=o.C0.US),f.key==="@"&&(p.key=o.C0.NUL)):f.keyCode===65&&(p.type=1);else{var w=l[f.keyCode],y=w==null?void 0:w[f.shiftKey?1:0];if(y)p.key=o.C0.ESC+y;else if(f.keyCode>=65&&f.keyCode<=90){var c=f.ctrlKey?f.keyCode-64:f.keyCode+32,n=String.fromCharCode(c);f.shiftKey&&(n=n.toUpperCase()),p.key=o.C0.ESC+n}else f.key==="Dead"&&f.code.startsWith("Key")&&(n=f.code.slice(3,4),f.shiftKey||(n=n.toLowerCase()),p.key=o.C0.ESC+n,p.cancel=!0)}else f.keyCode>=65&&f.keyCode<=90?p.key=String.fromCharCode(f.keyCode-64):f.keyCode===32?p.key=o.C0.NUL:f.keyCode>=51&&f.keyCode<=55?p.key=String.fromCharCode(f.keyCode-51+27):f.keyCode===56?p.key=o.C0.DEL:f.keyCode===219?p.key=o.C0.ESC:f.keyCode===220?p.key=o.C0.FS:f.keyCode===221&&(p.key=o.C0.GS)}return p}},482:(a,r)=>{Object.defineProperty(r,"__esModule",{value:!0}),r.Utf8ToUtf32=r.StringToUtf32=r.utf32ToString=r.stringFromCodePoint=void 0,r.stringFromCodePoint=function(l){return l>65535?(l-=65536,String.fromCharCode(55296+(l>>10))+String.fromCharCode(l%1024+56320)):String.fromCharCode(l)},r.utf32ToString=function(l,f,m){f===void 0&&(f=0),m===void 0&&(m=l.length);for(var C="",S=f;S<m;++S){var p=l[S];p>65535?(p-=65536,C+=String.fromCharCode(55296+(p>>10))+String.fromCharCode(p%1024+56320)):C+=String.fromCharCode(p)}return C};var u=function(){function l(){this._interim=0}return l.prototype.clear=function(){this._interim=0},l.prototype.decode=function(f,m){var C=f.length;if(!C)return 0;var S=0,p=0;this._interim&&(56320<=(y=f.charCodeAt(p++))&&y<=57343?m[S++]=1024*(this._interim-55296)+y-56320+65536:(m[S++]=this._interim,m[S++]=y),this._interim=0);for(var v=p;v<C;++v){var w=f.charCodeAt(v);if(55296<=w&&w<=56319){if(++v>=C)return this._interim=w,S;var y;56320<=(y=f.charCodeAt(v))&&y<=57343?m[S++]=1024*(w-55296)+y-56320+65536:(m[S++]=w,m[S++]=y)}else w!==65279&&(m[S++]=w)}return S},l}();r.StringToUtf32=u;var o=function(){function l(){this.interim=new Uint8Array(3)}return l.prototype.clear=function(){this.interim.fill(0)},l.prototype.decode=function(f,m){var C=f.length;if(!C)return 0;var S,p,v,w,y=0,c=0,n=0;if(this.interim[0]){var h=!1,_=this.interim[0];_&=(224&_)==192?31:(240&_)==224?15:7;for(var d=0,b=void 0;(b=63&this.interim[++d])&&d<4;)_<<=6,_|=b;for(var g=(224&this.interim[0])==192?2:(240&this.interim[0])==224?3:4,A=g-d;n<A;){if(n>=C)return 0;if((192&(b=f[n++]))!=128){n--,h=!0;break}this.interim[d++]=b,_<<=6,_|=63&b}h||(g===2?_<128?n--:m[y++]=_:g===3?_<2048||_>=55296&&_<=57343||_===65279||(m[y++]=_):_<65536||_>1114111||(m[y++]=_)),this.interim.fill(0)}for(var R=C-4,x=n;x<C;){for(;!(!(x<R)||128&(S=f[x])||128&(p=f[x+1])||128&(v=f[x+2])||128&(w=f[x+3]));)m[y++]=S,m[y++]=p,m[y++]=v,m[y++]=w,x+=4;if((S=f[x++])<128)m[y++]=S;else if((224&S)==192){if(x>=C)return this.interim[0]=S,y;if((192&(p=f[x++]))!=128){x--;continue}if((c=(31&S)<<6|63&p)<128){x--;continue}m[y++]=c}else if((240&S)==224){if(x>=C)return this.interim[0]=S,y;if((192&(p=f[x++]))!=128){x--;continue}if(x>=C)return this.interim[0]=S,this.interim[1]=p,y;if((192&(v=f[x++]))!=128){x--;continue}if((c=(15&S)<<12|(63&p)<<6|63&v)<2048||c>=55296&&c<=57343||c===65279)continue;m[y++]=c}else if((248&S)==240){if(x>=C)return this.interim[0]=S,y;if((192&(p=f[x++]))!=128){x--;continue}if(x>=C)return this.interim[0]=S,this.interim[1]=p,y;if((192&(v=f[x++]))!=128){x--;continue}if(x>=C)return this.interim[0]=S,this.interim[1]=p,this.interim[2]=v,y;if((192&(w=f[x++]))!=128){x--;continue}if((c=(7&S)<<18|(63&p)<<12|(63&v)<<6|63&w)<65536||c>1114111)continue;m[y++]=c}}return y},l}();r.Utf8ToUtf32=o},225:(a,r,u)=>{Object.defineProperty(r,"__esModule",{value:!0}),r.UnicodeV6=void 0;var o,l=u(8273),f=[[768,879],[1155,1158],[1160,1161],[1425,1469],[1471,1471],[1473,1474],[1476,1477],[1479,1479],[1536,1539],[1552,1557],[1611,1630],[1648,1648],[1750,1764],[1767,1768],[1770,1773],[1807,1807],[1809,1809],[1840,1866],[1958,1968],[2027,2035],[2305,2306],[2364,2364],[2369,2376],[2381,2381],[2385,2388],[2402,2403],[2433,2433],[2492,2492],[2497,2500],[2509,2509],[2530,2531],[2561,2562],[2620,2620],[2625,2626],[2631,2632],[2635,2637],[2672,2673],[2689,2690],[2748,2748],[2753,2757],[2759,2760],[2765,2765],[2786,2787],[2817,2817],[2876,2876],[2879,2879],[2881,2883],[2893,2893],[2902,2902],[2946,2946],[3008,3008],[3021,3021],[3134,3136],[3142,3144],[3146,3149],[3157,3158],[3260,3260],[3263,3263],[3270,3270],[3276,3277],[3298,3299],[3393,3395],[3405,3405],[3530,3530],[3538,3540],[3542,3542],[3633,3633],[3636,3642],[3655,3662],[3761,3761],[3764,3769],[3771,3772],[3784,3789],[3864,3865],[3893,3893],[3895,3895],[3897,3897],[3953,3966],[3968,3972],[3974,3975],[3984,3991],[3993,4028],[4038,4038],[4141,4144],[4146,4146],[4150,4151],[4153,4153],[4184,4185],[4448,4607],[4959,4959],[5906,5908],[5938,5940],[5970,5971],[6002,6003],[6068,6069],[6071,6077],[6086,6086],[6089,6099],[6109,6109],[6155,6157],[6313,6313],[6432,6434],[6439,6440],[6450,6450],[6457,6459],[6679,6680],[6912,6915],[6964,6964],[6966,6970],[6972,6972],[6978,6978],[7019,7027],[7616,7626],[7678,7679],[8203,8207],[8234,8238],[8288,8291],[8298,8303],[8400,8431],[12330,12335],[12441,12442],[43014,43014],[43019,43019],[43045,43046],[64286,64286],[65024,65039],[65056,65059],[65279,65279],[65529,65531]],m=[[68097,68099],[68101,68102],[68108,68111],[68152,68154],[68159,68159],[119143,119145],[119155,119170],[119173,119179],[119210,119213],[119362,119364],[917505,917505],[917536,917631],[917760,917999]],C=function(){function S(){if(this.version="6",!o){o=new Uint8Array(65536),(0,l.fill)(o,1),o[0]=0,(0,l.fill)(o,0,1,32),(0,l.fill)(o,0,127,160),(0,l.fill)(o,2,4352,4448),o[9001]=2,o[9002]=2,(0,l.fill)(o,2,11904,42192),o[12351]=1,(0,l.fill)(o,2,44032,55204),(0,l.fill)(o,2,63744,64256),(0,l.fill)(o,2,65040,65050),(0,l.fill)(o,2,65072,65136),(0,l.fill)(o,2,65280,65377),(0,l.fill)(o,2,65504,65511);for(var p=0;p<f.length;++p)(0,l.fill)(o,0,f[p][0],f[p][1]+1)}}return S.prototype.wcwidth=function(p){return p<32?0:p<127?1:p<65536?o[p]:function(v,w){var y,c=0,n=w.length-1;if(v<w[0][0]||v>w[n][1])return!1;for(;n>=c;)if(v>w[y=c+n>>1][1])c=y+1;else{if(!(v<w[y][0]))return!0;n=y-1}return!1}(p,m)?0:p>=131072&&p<=196605||p>=196608&&p<=262141?2:1},S}();r.UnicodeV6=C},5981:(a,r,u)=>{Object.defineProperty(r,"__esModule",{value:!0}),r.WriteBuffer=void 0;var o=u(8460),l=typeof queueMicrotask>"u"?function(m){Promise.resolve().then(m)}:queueMicrotask,f=function(){function m(C){this._action=C,this._writeBuffer=[],this._callbacks=[],this._pendingData=0,this._bufferOffset=0,this._isSyncWriting=!1,this._syncCalls=0,this._onWriteParsed=new o.EventEmitter}return Object.defineProperty(m.prototype,"onWriteParsed",{get:function(){return this._onWriteParsed.event},enumerable:!1,configurable:!0}),m.prototype.writeSync=function(C,S){if(S!==void 0&&this._syncCalls>S)this._syncCalls=0;else if(this._pendingData+=C.length,this._writeBuffer.push(C),this._callbacks.push(void 0),this._syncCalls++,!this._isSyncWriting){var p;for(this._isSyncWriting=!0;p=this._writeBuffer.shift();){this._action(p);var v=this._callbacks.shift();v&&v()}this._pendingData=0,this._bufferOffset=2147483647,this._isSyncWriting=!1,this._syncCalls=0}},m.prototype.write=function(C,S){var p=this;if(this._pendingData>5e7)throw new Error("write data discarded, use flow control to avoid losing data");this._writeBuffer.length||(this._bufferOffset=0,setTimeout(function(){return p._innerWrite()})),this._pendingData+=C.length,this._writeBuffer.push(C),this._callbacks.push(S)},m.prototype._innerWrite=function(C,S){var p=this;C===void 0&&(C=0),S===void 0&&(S=!0);for(var v=C||Date.now();this._writeBuffer.length>this._bufferOffset;){var w=this._writeBuffer[this._bufferOffset],y=this._action(w,S);if(y)return void y.catch(function(n){return l(function(){throw n}),Promise.resolve(!1)}).then(function(n){return Date.now()-v>=12?setTimeout(function(){return p._innerWrite(0,n)}):p._innerWrite(v,n)});var c=this._callbacks[this._bufferOffset];if(c&&c(),this._bufferOffset++,this._pendingData-=w.length,Date.now()-v>=12)break}this._writeBuffer.length>this._bufferOffset?(this._bufferOffset>50&&(this._writeBuffer=this._writeBuffer.slice(this._bufferOffset),this._callbacks=this._callbacks.slice(this._bufferOffset),this._bufferOffset=0),setTimeout(function(){return p._innerWrite()})):(this._writeBuffer.length=0,this._callbacks.length=0,this._pendingData=0,this._bufferOffset=0),this._onWriteParsed.fire()},m}();r.WriteBuffer=f},5941:function(a,r){var u=this&&this.__read||function(m,C){var S=typeof Symbol=="function"&&m[Symbol.iterator];if(!S)return m;var p,v,w=S.call(m),y=[];try{for(;(C===void 0||C-- >0)&&!(p=w.next()).done;)y.push(p.value)}catch(c){v={error:c}}finally{try{p&&!p.done&&(S=w.return)&&S.call(w)}finally{if(v)throw v.error}}return y};Object.defineProperty(r,"__esModule",{value:!0}),r.toRgbString=r.parseColor=void 0;var o=/^([\da-f])\/([\da-f])\/([\da-f])$|^([\da-f]{2})\/([\da-f]{2})\/([\da-f]{2})$|^([\da-f]{3})\/([\da-f]{3})\/([\da-f]{3})$|^([\da-f]{4})\/([\da-f]{4})\/([\da-f]{4})$/,l=/^[\da-f]+$/;function f(m,C){var S=m.toString(16),p=S.length<2?"0"+S:S;switch(C){case 4:return S[0];case 8:return p;case 12:return(p+p).slice(0,3);default:return p+p}}r.parseColor=function(m){if(m){var C=m.toLowerCase();if(C.indexOf("rgb:")===0){C=C.slice(4);var S=o.exec(C);if(S){var p=S[1]?15:S[4]?255:S[7]?4095:65535;return[Math.round(parseInt(S[1]||S[4]||S[7]||S[10],16)/p*255),Math.round(parseInt(S[2]||S[5]||S[8]||S[11],16)/p*255),Math.round(parseInt(S[3]||S[6]||S[9]||S[12],16)/p*255)]}}else if(C.indexOf("#")===0&&(C=C.slice(1),l.exec(C)&&[3,6,9,12].includes(C.length))){for(var v=C.length/3,w=[0,0,0],y=0;y<3;++y){var c=parseInt(C.slice(v*y,v*y+v),16);w[y]=v===1?c<<4:v===2?c:v===3?c>>4:c>>8}return w}}},r.toRgbString=function(m,C){C===void 0&&(C=16);var S=u(m,3),p=S[0],v=S[1],w=S[2];return"rgb:"+f(p,C)+"/"+f(v,C)+"/"+f(w,C)}},5770:(a,r)=>{Object.defineProperty(r,"__esModule",{value:!0}),r.PAYLOAD_LIMIT=void 0,r.PAYLOAD_LIMIT=1e7},6351:(a,r,u)=>{Object.defineProperty(r,"__esModule",{value:!0}),r.DcsHandler=r.DcsParser=void 0;var o=u(482),l=u(8742),f=u(5770),m=[],C=function(){function v(){this._handlers=Object.create(null),this._active=m,this._ident=0,this._handlerFb=function(){},this._stack={paused:!1,loopPosition:0,fallThrough:!1}}return v.prototype.dispose=function(){this._handlers=Object.create(null),this._handlerFb=function(){},this._active=m},v.prototype.registerHandler=function(w,y){this._handlers[w]===void 0&&(this._handlers[w]=[]);var c=this._handlers[w];return c.push(y),{dispose:function(){var n=c.indexOf(y);n!==-1&&c.splice(n,1)}}},v.prototype.clearHandler=function(w){this._handlers[w]&&delete this._handlers[w]},v.prototype.setHandlerFallback=function(w){this._handlerFb=w},v.prototype.reset=function(){if(this._active.length)for(var w=this._stack.paused?this._stack.loopPosition-1:this._active.length-1;w>=0;--w)this._active[w].unhook(!1);this._stack.paused=!1,this._active=m,this._ident=0},v.prototype.hook=function(w,y){if(this.reset(),this._ident=w,this._active=this._handlers[w]||m,this._active.length)for(var c=this._active.length-1;c>=0;c--)this._active[c].hook(y);else this._handlerFb(this._ident,"HOOK",y)},v.prototype.put=function(w,y,c){if(this._active.length)for(var n=this._active.length-1;n>=0;n--)this._active[n].put(w,y,c);else this._handlerFb(this._ident,"PUT",(0,o.utf32ToString)(w,y,c))},v.prototype.unhook=function(w,y){if(y===void 0&&(y=!0),this._active.length){var c=!1,n=this._active.length-1,h=!1;if(this._stack.paused&&(n=this._stack.loopPosition-1,c=y,h=this._stack.fallThrough,this._stack.paused=!1),!h&&c===!1){for(;n>=0&&(c=this._active[n].unhook(w))!==!0;n--)if(c instanceof Promise)return this._stack.paused=!0,this._stack.loopPosition=n,this._stack.fallThrough=!1,c;n--}for(;n>=0;n--)if((c=this._active[n].unhook(!1))instanceof Promise)return this._stack.paused=!0,this._stack.loopPosition=n,this._stack.fallThrough=!0,c}else this._handlerFb(this._ident,"UNHOOK",w);this._active=m,this._ident=0},v}();r.DcsParser=C;var S=new l.Params;S.addParam(0);var p=function(){function v(w){this._handler=w,this._data="",this._params=S,this._hitLimit=!1}return v.prototype.hook=function(w){this._params=w.length>1||w.params[0]?w.clone():S,this._data="",this._hitLimit=!1},v.prototype.put=function(w,y,c){this._hitLimit||(this._data+=(0,o.utf32ToString)(w,y,c),this._data.length>f.PAYLOAD_LIMIT&&(this._data="",this._hitLimit=!0))},v.prototype.unhook=function(w){var y=this,c=!1;if(this._hitLimit)c=!1;else if(w&&(c=this._handler(this._data,this._params))instanceof Promise)return c.then(function(n){return y._params=S,y._data="",y._hitLimit=!1,n});return this._params=S,this._data="",this._hitLimit=!1,c},v}();r.DcsHandler=p},2015:function(a,r,u){var o,l=this&&this.__extends||(o=function(c,n){return o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(h,_){h.__proto__=_}||function(h,_){for(var d in _)Object.prototype.hasOwnProperty.call(_,d)&&(h[d]=_[d])},o(c,n)},function(c,n){if(typeof n!="function"&&n!==null)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function h(){this.constructor=c}o(c,n),c.prototype=n===null?Object.create(n):(h.prototype=n.prototype,new h)});Object.defineProperty(r,"__esModule",{value:!0}),r.EscapeSequenceParser=r.VT500_TRANSITION_TABLE=r.TransitionTable=void 0;var f=u(844),m=u(8273),C=u(8742),S=u(6242),p=u(6351),v=function(){function c(n){this.table=new Uint8Array(n)}return c.prototype.setDefault=function(n,h){(0,m.fill)(this.table,n<<4|h)},c.prototype.add=function(n,h,_,d){this.table[h<<8|n]=_<<4|d},c.prototype.addMany=function(n,h,_,d){for(var b=0;b<n.length;b++)this.table[h<<8|n[b]]=_<<4|d},c}();r.TransitionTable=v;var w=160;r.VT500_TRANSITION_TABLE=function(){var c=new v(4095),n=Array.apply(null,Array(256)).map(function(A,R){return R}),h=function(A,R){return n.slice(A,R)},_=h(32,127),d=h(0,24);d.push(25),d.push.apply(d,h(28,32));var b,g=h(0,14);for(b in c.setDefault(1,0),c.addMany(_,0,2,0),g)c.addMany([24,26,153,154],b,3,0),c.addMany(h(128,144),b,3,0),c.addMany(h(144,152),b,3,0),c.add(156,b,0,0),c.add(27,b,11,1),c.add(157,b,4,8),c.addMany([152,158,159],b,0,7),c.add(155,b,11,3),c.add(144,b,11,9);return c.addMany(d,0,3,0),c.addMany(d,1,3,1),c.add(127,1,0,1),c.addMany(d,8,0,8),c.addMany(d,3,3,3),c.add(127,3,0,3),c.addMany(d,4,3,4),c.add(127,4,0,4),c.addMany(d,6,3,6),c.addMany(d,5,3,5),c.add(127,5,0,5),c.addMany(d,2,3,2),c.add(127,2,0,2),c.add(93,1,4,8),c.addMany(_,8,5,8),c.add(127,8,5,8),c.addMany([156,27,24,26,7],8,6,0),c.addMany(h(28,32),8,0,8),c.addMany([88,94,95],1,0,7),c.addMany(_,7,0,7),c.addMany(d,7,0,7),c.add(156,7,0,0),c.add(127,7,0,7),c.add(91,1,11,3),c.addMany(h(64,127),3,7,0),c.addMany(h(48,60),3,8,4),c.addMany([60,61,62,63],3,9,4),c.addMany(h(48,60),4,8,4),c.addMany(h(64,127),4,7,0),c.addMany([60,61,62,63],4,0,6),c.addMany(h(32,64),6,0,6),c.add(127,6,0,6),c.addMany(h(64,127),6,0,0),c.addMany(h(32,48),3,9,5),c.addMany(h(32,48),5,9,5),c.addMany(h(48,64),5,0,6),c.addMany(h(64,127),5,7,0),c.addMany(h(32,48),4,9,5),c.addMany(h(32,48),1,9,2),c.addMany(h(32,48),2,9,2),c.addMany(h(48,127),2,10,0),c.addMany(h(48,80),1,10,0),c.addMany(h(81,88),1,10,0),c.addMany([89,90,92],1,10,0),c.addMany(h(96,127),1,10,0),c.add(80,1,11,9),c.addMany(d,9,0,9),c.add(127,9,0,9),c.addMany(h(28,32),9,0,9),c.addMany(h(32,48),9,9,12),c.addMany(h(48,60),9,8,10),c.addMany([60,61,62,63],9,9,10),c.addMany(d,11,0,11),c.addMany(h(32,128),11,0,11),c.addMany(h(28,32),11,0,11),c.addMany(d,10,0,10),c.add(127,10,0,10),c.addMany(h(28,32),10,0,10),c.addMany(h(48,60),10,8,10),c.addMany([60,61,62,63],10,0,11),c.addMany(h(32,48),10,9,12),c.addMany(d,12,0,12),c.add(127,12,0,12),c.addMany(h(28,32),12,0,12),c.addMany(h(32,48),12,9,12),c.addMany(h(48,64),12,0,11),c.addMany(h(64,127),12,12,13),c.addMany(h(64,127),10,12,13),c.addMany(h(64,127),9,12,13),c.addMany(d,13,13,13),c.addMany(_,13,13,13),c.add(127,13,0,13),c.addMany([27,156,24,26],13,14,0),c.add(w,0,2,0),c.add(w,8,5,8),c.add(w,6,0,6),c.add(w,11,0,11),c.add(w,13,13,13),c}();var y=function(c){function n(h){h===void 0&&(h=r.VT500_TRANSITION_TABLE);var _=c.call(this)||this;return _._transitions=h,_._parseStack={state:0,handlers:[],handlerPos:0,transition:0,chunkPos:0},_.initialState=0,_.currentState=_.initialState,_._params=new C.Params,_._params.addParam(0),_._collect=0,_.precedingCodepoint=0,_._printHandlerFb=function(d,b,g){},_._executeHandlerFb=function(d){},_._csiHandlerFb=function(d,b){},_._escHandlerFb=function(d){},_._errorHandlerFb=function(d){return d},_._printHandler=_._printHandlerFb,_._executeHandlers=Object.create(null),_._csiHandlers=Object.create(null),_._escHandlers=Object.create(null),_._oscParser=new S.OscParser,_._dcsParser=new p.DcsParser,_._errorHandler=_._errorHandlerFb,_.registerEscHandler({final:"\\"},function(){return!0}),_}return l(n,c),n.prototype._identifier=function(h,_){_===void 0&&(_=[64,126]);var d=0;if(h.prefix){if(h.prefix.length>1)throw new Error("only one byte as prefix supported");if((d=h.prefix.charCodeAt(0))&&60>d||d>63)throw new Error("prefix must be in range 0x3c .. 0x3f")}if(h.intermediates){if(h.intermediates.length>2)throw new Error("only two bytes as intermediates are supported");for(var b=0;b<h.intermediates.length;++b){var g=h.intermediates.charCodeAt(b);if(32>g||g>47)throw new Error("intermediate must be in range 0x20 .. 0x2f");d<<=8,d|=g}}if(h.final.length!==1)throw new Error("final must be a single byte");var A=h.final.charCodeAt(0);if(_[0]>A||A>_[1])throw new Error("final must be in range "+_[0]+" .. "+_[1]);return(d<<=8)|A},n.prototype.identToString=function(h){for(var _=[];h;)_.push(String.fromCharCode(255&h)),h>>=8;return _.reverse().join("")},n.prototype.dispose=function(){this._csiHandlers=Object.create(null),this._executeHandlers=Object.create(null),this._escHandlers=Object.create(null),this._oscParser.dispose(),this._dcsParser.dispose()},n.prototype.setPrintHandler=function(h){this._printHandler=h},n.prototype.clearPrintHandler=function(){this._printHandler=this._printHandlerFb},n.prototype.registerEscHandler=function(h,_){var d=this._identifier(h,[48,126]);this._escHandlers[d]===void 0&&(this._escHandlers[d]=[]);var b=this._escHandlers[d];return b.push(_),{dispose:function(){var g=b.indexOf(_);g!==-1&&b.splice(g,1)}}},n.prototype.clearEscHandler=function(h){this._escHandlers[this._identifier(h,[48,126])]&&delete this._escHandlers[this._identifier(h,[48,126])]},n.prototype.setEscHandlerFallback=function(h){this._escHandlerFb=h},n.prototype.setExecuteHandler=function(h,_){this._executeHandlers[h.charCodeAt(0)]=_},n.prototype.clearExecuteHandler=function(h){this._executeHandlers[h.charCodeAt(0)]&&delete this._executeHandlers[h.charCodeAt(0)]},n.prototype.setExecuteHandlerFallback=function(h){this._executeHandlerFb=h},n.prototype.registerCsiHandler=function(h,_){var d=this._identifier(h);this._csiHandlers[d]===void 0&&(this._csiHandlers[d]=[]);var b=this._csiHandlers[d];return b.push(_),{dispose:function(){var g=b.indexOf(_);g!==-1&&b.splice(g,1)}}},n.prototype.clearCsiHandler=function(h){this._csiHandlers[this._identifier(h)]&&delete this._csiHandlers[this._identifier(h)]},n.prototype.setCsiHandlerFallback=function(h){this._csiHandlerFb=h},n.prototype.registerDcsHandler=function(h,_){return this._dcsParser.registerHandler(this._identifier(h),_)},n.prototype.clearDcsHandler=function(h){this._dcsParser.clearHandler(this._identifier(h))},n.prototype.setDcsHandlerFallback=function(h){this._dcsParser.setHandlerFallback(h)},n.prototype.registerOscHandler=function(h,_){return this._oscParser.registerHandler(h,_)},n.prototype.clearOscHandler=function(h){this._oscParser.clearHandler(h)},n.prototype.setOscHandlerFallback=function(h){this._oscParser.setHandlerFallback(h)},n.prototype.setErrorHandler=function(h){this._errorHandler=h},n.prototype.clearErrorHandler=function(){this._errorHandler=this._errorHandlerFb},n.prototype.reset=function(){this.currentState=this.initialState,this._oscParser.reset(),this._dcsParser.reset(),this._params.reset(),this._params.addParam(0),this._collect=0,this.precedingCodepoint=0,this._parseStack.state!==0&&(this._parseStack.state=2,this._parseStack.handlers=[])},n.prototype._preserveStack=function(h,_,d,b,g){this._parseStack.state=h,this._parseStack.handlers=_,this._parseStack.handlerPos=d,this._parseStack.transition=b,this._parseStack.chunkPos=g},n.prototype.parse=function(h,_,d){var b,g=0,A=0,R=0;if(this._parseStack.state)if(this._parseStack.state===2)this._parseStack.state=0,R=this._parseStack.chunkPos+1;else{if(d===void 0||this._parseStack.state===1)throw this._parseStack.state=1,new Error("improper continuation due to previous async handler, giving up parsing");var x=this._parseStack.handlers,k=this._parseStack.handlerPos-1;switch(this._parseStack.state){case 3:if(d===!1&&k>-1){for(;k>=0&&(b=x[k](this._params))!==!0;k--)if(b instanceof Promise)return this._parseStack.handlerPos=k,b}this._parseStack.handlers=[];break;case 4:if(d===!1&&k>-1){for(;k>=0&&(b=x[k]())!==!0;k--)if(b instanceof Promise)return this._parseStack.handlerPos=k,b}this._parseStack.handlers=[];break;case 6:if(g=h[this._parseStack.chunkPos],b=this._dcsParser.unhook(g!==24&&g!==26,d))return b;g===27&&(this._parseStack.transition|=1),this._params.reset(),this._params.addParam(0),this._collect=0;break;case 5:if(g=h[this._parseStack.chunkPos],b=this._oscParser.end(g!==24&&g!==26,d))return b;g===27&&(this._parseStack.transition|=1),this._params.reset(),this._params.addParam(0),this._collect=0}this._parseStack.state=0,R=this._parseStack.chunkPos+1,this.precedingCodepoint=0,this.currentState=15&this._parseStack.transition}for(var O=R;O<_;++O){switch(g=h[O],(A=this._transitions.table[this.currentState<<8|(g<160?g:w)])>>4){case 2:for(var I=O+1;;++I){if(I>=_||(g=h[I])<32||g>126&&g<w){this._printHandler(h,O,I),O=I-1;break}if(++I>=_||(g=h[I])<32||g>126&&g<w){this._printHandler(h,O,I),O=I-1;break}if(++I>=_||(g=h[I])<32||g>126&&g<w){this._printHandler(h,O,I),O=I-1;break}if(++I>=_||(g=h[I])<32||g>126&&g<w){this._printHandler(h,O,I),O=I-1;break}}break;case 3:this._executeHandlers[g]?this._executeHandlers[g]():this._executeHandlerFb(g),this.precedingCodepoint=0;break;case 0:break;case 1:if(this._errorHandler({position:O,code:g,currentState:this.currentState,collect:this._collect,params:this._params,abort:!1}).abort)return;break;case 7:for(var T=(x=this._csiHandlers[this._collect<<8|g])?x.length-1:-1;T>=0&&(b=x[T](this._params))!==!0;T--)if(b instanceof Promise)return this._preserveStack(3,x,T,A,O),b;T<0&&this._csiHandlerFb(this._collect<<8|g,this._params),this.precedingCodepoint=0;break;case 8:do switch(g){case 59:this._params.addParam(0);break;case 58:this._params.addSubParam(-1);break;default:this._params.addDigit(g-48)}while(++O<_&&(g=h[O])>47&&g<60);O--;break;case 9:this._collect<<=8,this._collect|=g;break;case 10:for(var P=this._escHandlers[this._collect<<8|g],M=P?P.length-1:-1;M>=0&&(b=P[M]())!==!0;M--)if(b instanceof Promise)return this._preserveStack(4,P,M,A,O),b;M<0&&this._escHandlerFb(this._collect<<8|g),this.precedingCodepoint=0;break;case 11:this._params.reset(),this._params.addParam(0),this._collect=0;break;case 12:this._dcsParser.hook(this._collect<<8|g,this._params);break;case 13:for(var D=O+1;;++D)if(D>=_||(g=h[D])===24||g===26||g===27||g>127&&g<w){this._dcsParser.put(h,O,D),O=D-1;break}break;case 14:if(b=this._dcsParser.unhook(g!==24&&g!==26))return this._preserveStack(6,[],0,A,O),b;g===27&&(A|=1),this._params.reset(),this._params.addParam(0),this._collect=0,this.precedingCodepoint=0;break;case 4:this._oscParser.start();break;case 5:for(var q=O+1;;q++)if(q>=_||(g=h[q])<32||g>127&&g<w){this._oscParser.put(h,O,q),O=q-1;break}break;case 6:if(b=this._oscParser.end(g!==24&&g!==26))return this._preserveStack(5,[],0,A,O),b;g===27&&(A|=1),this._params.reset(),this._params.addParam(0),this._collect=0,this.precedingCodepoint=0}this.currentState=15&A}},n}(f.Disposable);r.EscapeSequenceParser=y},6242:(a,r,u)=>{Object.defineProperty(r,"__esModule",{value:!0}),r.OscHandler=r.OscParser=void 0;var o=u(5770),l=u(482),f=[],m=function(){function S(){this._state=0,this._active=f,this._id=-1,this._handlers=Object.create(null),this._handlerFb=function(){},this._stack={paused:!1,loopPosition:0,fallThrough:!1}}return S.prototype.registerHandler=function(p,v){this._handlers[p]===void 0&&(this._handlers[p]=[]);var w=this._handlers[p];return w.push(v),{dispose:function(){var y=w.indexOf(v);y!==-1&&w.splice(y,1)}}},S.prototype.clearHandler=function(p){this._handlers[p]&&delete this._handlers[p]},S.prototype.setHandlerFallback=function(p){this._handlerFb=p},S.prototype.dispose=function(){this._handlers=Object.create(null),this._handlerFb=function(){},this._active=f},S.prototype.reset=function(){if(this._state===2)for(var p=this._stack.paused?this._stack.loopPosition-1:this._active.length-1;p>=0;--p)this._active[p].end(!1);this._stack.paused=!1,this._active=f,this._id=-1,this._state=0},S.prototype._start=function(){if(this._active=this._handlers[this._id]||f,this._active.length)for(var p=this._active.length-1;p>=0;p--)this._active[p].start();else this._handlerFb(this._id,"START")},S.prototype._put=function(p,v,w){if(this._active.length)for(var y=this._active.length-1;y>=0;y--)this._active[y].put(p,v,w);else this._handlerFb(this._id,"PUT",(0,l.utf32ToString)(p,v,w))},S.prototype.start=function(){this.reset(),this._state=1},S.prototype.put=function(p,v,w){if(this._state!==3){if(this._state===1)for(;v<w;){var y=p[v++];if(y===59){this._state=2,this._start();break}if(y<48||57<y)return void(this._state=3);this._id===-1&&(this._id=0),this._id=10*this._id+y-48}this._state===2&&w-v>0&&this._put(p,v,w)}},S.prototype.end=function(p,v){if(v===void 0&&(v=!0),this._state!==0){if(this._state!==3)if(this._state===1&&this._start(),this._active.length){var w=!1,y=this._active.length-1,c=!1;if(this._stack.paused&&(y=this._stack.loopPosition-1,w=v,c=this._stack.fallThrough,this._stack.paused=!1),!c&&w===!1){for(;y>=0&&(w=this._active[y].end(p))!==!0;y--)if(w instanceof Promise)return this._stack.paused=!0,this._stack.loopPosition=y,this._stack.fallThrough=!1,w;y--}for(;y>=0;y--)if((w=this._active[y].end(!1))instanceof Promise)return this._stack.paused=!0,this._stack.loopPosition=y,this._stack.fallThrough=!0,w}else this._handlerFb(this._id,"END",p);this._active=f,this._id=-1,this._state=0}},S}();r.OscParser=m;var C=function(){function S(p){this._handler=p,this._data="",this._hitLimit=!1}return S.prototype.start=function(){this._data="",this._hitLimit=!1},S.prototype.put=function(p,v,w){this._hitLimit||(this._data+=(0,l.utf32ToString)(p,v,w),this._data.length>o.PAYLOAD_LIMIT&&(this._data="",this._hitLimit=!0))},S.prototype.end=function(p){var v=this,w=!1;if(this._hitLimit)w=!1;else if(p&&(w=this._handler(this._data))instanceof Promise)return w.then(function(y){return v._data="",v._hitLimit=!1,y});return this._data="",this._hitLimit=!1,w},S}();r.OscHandler=C},8742:(a,r)=>{Object.defineProperty(r,"__esModule",{value:!0}),r.Params=void 0;var u=2147483647,o=function(){function l(f,m){if(f===void 0&&(f=32),m===void 0&&(m=32),this.maxLength=f,this.maxSubParamsLength=m,m>256)throw new Error("maxSubParamsLength must not be greater than 256");this.params=new Int32Array(f),this.length=0,this._subParams=new Int32Array(m),this._subParamsLength=0,this._subParamsIdx=new Uint16Array(f),this._rejectDigits=!1,this._rejectSubDigits=!1,this._digitIsSub=!1}return l.fromArray=function(f){var m=new l;if(!f.length)return m;for(var C=Array.isArray(f[0])?1:0;C<f.length;++C){var S=f[C];if(Array.isArray(S))for(var p=0;p<S.length;++p)m.addSubParam(S[p]);else m.addParam(S)}return m},l.prototype.clone=function(){var f=new l(this.maxLength,this.maxSubParamsLength);return f.params.set(this.params),f.length=this.length,f._subParams.set(this._subParams),f._subParamsLength=this._subParamsLength,f._subParamsIdx.set(this._subParamsIdx),f._rejectDigits=this._rejectDigits,f._rejectSubDigits=this._rejectSubDigits,f._digitIsSub=this._digitIsSub,f},l.prototype.toArray=function(){for(var f=[],m=0;m<this.length;++m){f.push(this.params[m]);var C=this._subParamsIdx[m]>>8,S=255&this._subParamsIdx[m];S-C>0&&f.push(Array.prototype.slice.call(this._subParams,C,S))}return f},l.prototype.reset=function(){this.length=0,this._subParamsLength=0,this._rejectDigits=!1,this._rejectSubDigits=!1,this._digitIsSub=!1},l.prototype.addParam=function(f){if(this._digitIsSub=!1,this.length>=this.maxLength)this._rejectDigits=!0;else{if(f<-1)throw new Error("values lesser than -1 are not allowed");this._subParamsIdx[this.length]=this._subParamsLength<<8|this._subParamsLength,this.params[this.length++]=f>u?u:f}},l.prototype.addSubParam=function(f){if(this._digitIsSub=!0,this.length)if(this._rejectDigits||this._subParamsLength>=this.maxSubParamsLength)this._rejectSubDigits=!0;else{if(f<-1)throw new Error("values lesser than -1 are not allowed");this._subParams[this._subParamsLength++]=f>u?u:f,this._subParamsIdx[this.length-1]++}},l.prototype.hasSubParams=function(f){return(255&this._subParamsIdx[f])-(this._subParamsIdx[f]>>8)>0},l.prototype.getSubParams=function(f){var m=this._subParamsIdx[f]>>8,C=255&this._subParamsIdx[f];return C-m>0?this._subParams.subarray(m,C):null},l.prototype.getSubParamsAll=function(){for(var f={},m=0;m<this.length;++m){var C=this._subParamsIdx[m]>>8,S=255&this._subParamsIdx[m];S-C>0&&(f[m]=this._subParams.slice(C,S))}return f},l.prototype.addDigit=function(f){var m;if(!(this._rejectDigits||!(m=this._digitIsSub?this._subParamsLength:this.length)||this._digitIsSub&&this._rejectSubDigits)){var C=this._digitIsSub?this._subParams:this.params,S=C[m-1];C[m-1]=~S?Math.min(10*S+f,u):f}},l}();r.Params=o},5741:(a,r)=>{Object.defineProperty(r,"__esModule",{value:!0}),r.AddonManager=void 0;var u=function(){function o(){this._addons=[]}return o.prototype.dispose=function(){for(var l=this._addons.length-1;l>=0;l--)this._addons[l].instance.dispose()},o.prototype.loadAddon=function(l,f){var m=this,C={instance:f,dispose:f.dispose,isDisposed:!1};this._addons.push(C),f.dispose=function(){return m._wrappedAddonDispose(C)},f.activate(l)},o.prototype._wrappedAddonDispose=function(l){if(!l.isDisposed){for(var f=-1,m=0;m<this._addons.length;m++)if(this._addons[m]===l){f=m;break}if(f===-1)throw new Error("Could not dispose an addon that has not been loaded");l.isDisposed=!0,l.dispose.apply(l.instance),this._addons.splice(f,1)}},o}();r.AddonManager=u},8771:(a,r,u)=>{Object.defineProperty(r,"__esModule",{value:!0}),r.BufferApiView=void 0;var o=u(3785),l=u(511),f=function(){function m(C,S){this._buffer=C,this.type=S}return m.prototype.init=function(C){return this._buffer=C,this},Object.defineProperty(m.prototype,"cursorY",{get:function(){return this._buffer.y},enumerable:!1,configurable:!0}),Object.defineProperty(m.prototype,"cursorX",{get:function(){return this._buffer.x},enumerable:!1,configurable:!0}),Object.defineProperty(m.prototype,"viewportY",{get:function(){return this._buffer.ydisp},enumerable:!1,configurable:!0}),Object.defineProperty(m.prototype,"baseY",{get:function(){return this._buffer.ybase},enumerable:!1,configurable:!0}),Object.defineProperty(m.prototype,"length",{get:function(){return this._buffer.lines.length},enumerable:!1,configurable:!0}),m.prototype.getLine=function(C){var S=this._buffer.lines.get(C);if(S)return new o.BufferLineApiView(S)},m.prototype.getNullCell=function(){return new l.CellData},m}();r.BufferApiView=f},3785:(a,r,u)=>{Object.defineProperty(r,"__esModule",{value:!0}),r.BufferLineApiView=void 0;var o=u(511),l=function(){function f(m){this._line=m}return Object.defineProperty(f.prototype,"isWrapped",{get:function(){return this._line.isWrapped},enumerable:!1,configurable:!0}),Object.defineProperty(f.prototype,"length",{get:function(){return this._line.length},enumerable:!1,configurable:!0}),f.prototype.getCell=function(m,C){if(!(m<0||m>=this._line.length))return C?(this._line.loadCell(m,C),C):this._line.loadCell(m,new o.CellData)},f.prototype.translateToString=function(m,C,S){return this._line.translateToString(m,C,S)},f}();r.BufferLineApiView=l},8285:(a,r,u)=>{Object.defineProperty(r,"__esModule",{value:!0}),r.BufferNamespaceApi=void 0;var o=u(8771),l=u(8460),f=function(){function m(C){var S=this;this._core=C,this._onBufferChange=new l.EventEmitter,this._normal=new o.BufferApiView(this._core.buffers.normal,"normal"),this._alternate=new o.BufferApiView(this._core.buffers.alt,"alternate"),this._core.buffers.onBufferActivate(function(){return S._onBufferChange.fire(S.active)})}return Object.defineProperty(m.prototype,"onBufferChange",{get:function(){return this._onBufferChange.event},enumerable:!1,configurable:!0}),Object.defineProperty(m.prototype,"active",{get:function(){if(this._core.buffers.active===this._core.buffers.normal)return this.normal;if(this._core.buffers.active===this._core.buffers.alt)return this.alternate;throw new Error("Active buffer is neither normal nor alternate")},enumerable:!1,configurable:!0}),Object.defineProperty(m.prototype,"normal",{get:function(){return this._normal.init(this._core.buffers.normal)},enumerable:!1,configurable:!0}),Object.defineProperty(m.prototype,"alternate",{get:function(){return this._alternate.init(this._core.buffers.alt)},enumerable:!1,configurable:!0}),m}();r.BufferNamespaceApi=f},7975:(a,r)=>{Object.defineProperty(r,"__esModule",{value:!0}),r.ParserApi=void 0;var u=function(){function o(l){this._core=l}return o.prototype.registerCsiHandler=function(l,f){return this._core.registerCsiHandler(l,function(m){return f(m.toArray())})},o.prototype.addCsiHandler=function(l,f){return this.registerCsiHandler(l,f)},o.prototype.registerDcsHandler=function(l,f){return this._core.registerDcsHandler(l,function(m,C){return f(m,C.toArray())})},o.prototype.addDcsHandler=function(l,f){return this.registerDcsHandler(l,f)},o.prototype.registerEscHandler=function(l,f){return this._core.registerEscHandler(l,f)},o.prototype.addEscHandler=function(l,f){return this.registerEscHandler(l,f)},o.prototype.registerOscHandler=function(l,f){return this._core.registerOscHandler(l,f)},o.prototype.addOscHandler=function(l,f){return this.registerOscHandler(l,f)},o}();r.ParserApi=u},7090:(a,r)=>{Object.defineProperty(r,"__esModule",{value:!0}),r.UnicodeApi=void 0;var u=function(){function o(l){this._core=l}return o.prototype.register=function(l){this._core.unicodeService.register(l)},Object.defineProperty(o.prototype,"versions",{get:function(){return this._core.unicodeService.versions},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"activeVersion",{get:function(){return this._core.unicodeService.activeVersion},set:function(l){this._core.unicodeService.activeVersion=l},enumerable:!1,configurable:!0}),o}();r.UnicodeApi=u},744:function(a,r,u){var o,l=this&&this.__extends||(o=function(y,c){return o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(n,h){n.__proto__=h}||function(n,h){for(var _ in h)Object.prototype.hasOwnProperty.call(h,_)&&(n[_]=h[_])},o(y,c)},function(y,c){if(typeof c!="function"&&c!==null)throw new TypeError("Class extends value "+String(c)+" is not a constructor or null");function n(){this.constructor=y}o(y,c),y.prototype=c===null?Object.create(c):(n.prototype=c.prototype,new n)}),f=this&&this.__decorate||function(y,c,n,h){var _,d=arguments.length,b=d<3?c:h===null?h=Object.getOwnPropertyDescriptor(c,n):h;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")b=Reflect.decorate(y,c,n,h);else for(var g=y.length-1;g>=0;g--)(_=y[g])&&(b=(d<3?_(b):d>3?_(c,n,b):_(c,n))||b);return d>3&&b&&Object.defineProperty(c,n,b),b},m=this&&this.__param||function(y,c){return function(n,h){c(n,h,y)}};Object.defineProperty(r,"__esModule",{value:!0}),r.BufferService=r.MINIMUM_ROWS=r.MINIMUM_COLS=void 0;var C=u(2585),S=u(5295),p=u(8460),v=u(844);r.MINIMUM_COLS=2,r.MINIMUM_ROWS=1;var w=function(y){function c(n){var h=y.call(this)||this;return h._optionsService=n,h.isUserScrolling=!1,h._onResize=new p.EventEmitter,h._onScroll=new p.EventEmitter,h.cols=Math.max(n.rawOptions.cols||0,r.MINIMUM_COLS),h.rows=Math.max(n.rawOptions.rows||0,r.MINIMUM_ROWS),h.buffers=new S.BufferSet(n,h),h}return l(c,y),Object.defineProperty(c.prototype,"onResize",{get:function(){return this._onResize.event},enumerable:!1,configurable:!0}),Object.defineProperty(c.prototype,"onScroll",{get:function(){return this._onScroll.event},enumerable:!1,configurable:!0}),Object.defineProperty(c.prototype,"buffer",{get:function(){return this.buffers.active},enumerable:!1,configurable:!0}),c.prototype.dispose=function(){y.prototype.dispose.call(this),this.buffers.dispose()},c.prototype.resize=function(n,h){this.cols=n,this.rows=h,this.buffers.resize(n,h),this.buffers.setupTabStops(this.cols),this._onResize.fire({cols:n,rows:h})},c.prototype.reset=function(){this.buffers.reset(),this.isUserScrolling=!1},c.prototype.scroll=function(n,h){h===void 0&&(h=!1);var _,d=this.buffer;(_=this._cachedBlankLine)&&_.length===this.cols&&_.getFg(0)===n.fg&&_.getBg(0)===n.bg||(_=d.getBlankLine(n,h),this._cachedBlankLine=_),_.isWrapped=h;var b=d.ybase+d.scrollTop,g=d.ybase+d.scrollBottom;if(d.scrollTop===0){var A=d.lines.isFull;g===d.lines.length-1?A?d.lines.recycle().copyFrom(_):d.lines.push(_.clone()):d.lines.splice(g+1,0,_.clone()),A?this.isUserScrolling&&(d.ydisp=Math.max(d.ydisp-1,0)):(d.ybase++,this.isUserScrolling||d.ydisp++)}else{var R=g-b+1;d.lines.shiftElements(b+1,R-1,-1),d.lines.set(g,_.clone())}this.isUserScrolling||(d.ydisp=d.ybase),this._onScroll.fire(d.ydisp)},c.prototype.scrollLines=function(n,h,_){var d=this.buffer;if(n<0){if(d.ydisp===0)return;this.isUserScrolling=!0}else n+d.ydisp>=d.ybase&&(this.isUserScrolling=!1);var b=d.ydisp;d.ydisp=Math.max(Math.min(d.ydisp+n,d.ybase),0),b!==d.ydisp&&(h||this._onScroll.fire(d.ydisp))},c.prototype.scrollPages=function(n){this.scrollLines(n*(this.rows-1))},c.prototype.scrollToTop=function(){this.scrollLines(-this.buffer.ydisp)},c.prototype.scrollToBottom=function(){this.scrollLines(this.buffer.ybase-this.buffer.ydisp)},c.prototype.scrollToLine=function(n){var h=n-this.buffer.ydisp;h!==0&&this.scrollLines(h)},f([m(0,C.IOptionsService)],c)}(v.Disposable);r.BufferService=w},7994:(a,r)=>{Object.defineProperty(r,"__esModule",{value:!0}),r.CharsetService=void 0;var u=function(){function o(){this.glevel=0,this._charsets=[]}return o.prototype.reset=function(){this.charset=void 0,this._charsets=[],this.glevel=0},o.prototype.setgLevel=function(l){this.glevel=l,this.charset=this._charsets[l]},o.prototype.setgCharset=function(l,f){this._charsets[l]=f,this.glevel===l&&(this.charset=f)},o}();r.CharsetService=u},1753:function(a,r,u){var o=this&&this.__decorate||function(c,n,h,_){var d,b=arguments.length,g=b<3?n:_===null?_=Object.getOwnPropertyDescriptor(n,h):_;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")g=Reflect.decorate(c,n,h,_);else for(var A=c.length-1;A>=0;A--)(d=c[A])&&(g=(b<3?d(g):b>3?d(n,h,g):d(n,h))||g);return b>3&&g&&Object.defineProperty(n,h,g),g},l=this&&this.__param||function(c,n){return function(h,_){n(h,_,c)}},f=this&&this.__values||function(c){var n=typeof Symbol=="function"&&Symbol.iterator,h=n&&c[n],_=0;if(h)return h.call(c);if(c&&typeof c.length=="number")return{next:function(){return c&&_>=c.length&&(c=void 0),{value:c&&c[_++],done:!c}}};throw new TypeError(n?"Object is not iterable.":"Symbol.iterator is not defined.")};Object.defineProperty(r,"__esModule",{value:!0}),r.CoreMouseService=void 0;var m=u(2585),C=u(8460),S={NONE:{events:0,restrict:function(){return!1}},X10:{events:1,restrict:function(c){return c.button!==4&&c.action===1&&(c.ctrl=!1,c.alt=!1,c.shift=!1,!0)}},VT200:{events:19,restrict:function(c){return c.action!==32}},DRAG:{events:23,restrict:function(c){return c.action!==32||c.button!==3}},ANY:{events:31,restrict:function(c){return!0}}};function p(c,n){var h=(c.ctrl?16:0)|(c.shift?4:0)|(c.alt?8:0);return c.button===4?(h|=64,h|=c.action):(h|=3&c.button,4&c.button&&(h|=64),8&c.button&&(h|=128),c.action===32?h|=32:c.action!==0||n||(h|=3)),h}var v=String.fromCharCode,w={DEFAULT:function(c){var n=[p(c,!1)+32,c.col+32,c.row+32];return n[0]>255||n[1]>255||n[2]>255?"":"\x1B[M"+v(n[0])+v(n[1])+v(n[2])},SGR:function(c){var n=c.action===0&&c.button!==4?"m":"M";return"\x1B[<"+p(c,!0)+";"+c.col+";"+c.row+n}},y=function(){function c(n,h){var _,d,b,g;this._bufferService=n,this._coreService=h,this._protocols={},this._encodings={},this._activeProtocol="",this._activeEncoding="",this._onProtocolChange=new C.EventEmitter,this._lastEvent=null;try{for(var A=f(Object.keys(S)),R=A.next();!R.done;R=A.next()){var x=R.value;this.addProtocol(x,S[x])}}catch(T){_={error:T}}finally{try{R&&!R.done&&(d=A.return)&&d.call(A)}finally{if(_)throw _.error}}try{for(var k=f(Object.keys(w)),O=k.next();!O.done;O=k.next()){var I=O.value;this.addEncoding(I,w[I])}}catch(T){b={error:T}}finally{try{O&&!O.done&&(g=k.return)&&g.call(k)}finally{if(b)throw b.error}}this.reset()}return c.prototype.addProtocol=function(n,h){this._protocols[n]=h},c.prototype.addEncoding=function(n,h){this._encodings[n]=h},Object.defineProperty(c.prototype,"activeProtocol",{get:function(){return this._activeProtocol},set:function(n){if(!this._protocols[n])throw new Error('unknown protocol "'+n+'"');this._activeProtocol=n,this._onProtocolChange.fire(this._protocols[n].events)},enumerable:!1,configurable:!0}),Object.defineProperty(c.prototype,"areMouseEventsActive",{get:function(){return this._protocols[this._activeProtocol].events!==0},enumerable:!1,configurable:!0}),Object.defineProperty(c.prototype,"activeEncoding",{get:function(){return this._activeEncoding},set:function(n){if(!this._encodings[n])throw new Error('unknown encoding "'+n+'"');this._activeEncoding=n},enumerable:!1,configurable:!0}),c.prototype.reset=function(){this.activeProtocol="NONE",this.activeEncoding="DEFAULT",this._lastEvent=null},Object.defineProperty(c.prototype,"onProtocolChange",{get:function(){return this._onProtocolChange.event},enumerable:!1,configurable:!0}),c.prototype.triggerMouseEvent=function(n){if(n.col<0||n.col>=this._bufferService.cols||n.row<0||n.row>=this._bufferService.rows||n.button===4&&n.action===32||n.button===3&&n.action!==32||n.button!==4&&(n.action===2||n.action===3)||(n.col++,n.row++,n.action===32&&this._lastEvent&&this._compareEvents(this._lastEvent,n))||!this._protocols[this._activeProtocol].restrict(n))return!1;var h=this._encodings[this._activeEncoding](n);return h&&(this._activeEncoding==="DEFAULT"?this._coreService.triggerBinaryEvent(h):this._coreService.triggerDataEvent(h,!0)),this._lastEvent=n,!0},c.prototype.explainEvents=function(n){return{down:!!(1&n),up:!!(2&n),drag:!!(4&n),move:!!(8&n),wheel:!!(16&n)}},c.prototype._compareEvents=function(n,h){return n.col===h.col&&n.row===h.row&&n.button===h.button&&n.action===h.action&&n.ctrl===h.ctrl&&n.alt===h.alt&&n.shift===h.shift},o([l(0,m.IBufferService),l(1,m.ICoreService)],c)}();r.CoreMouseService=y},6975:function(a,r,u){var o,l=this&&this.__extends||(o=function(n,h){return o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(_,d){_.__proto__=d}||function(_,d){for(var b in d)Object.prototype.hasOwnProperty.call(d,b)&&(_[b]=d[b])},o(n,h)},function(n,h){if(typeof h!="function"&&h!==null)throw new TypeError("Class extends value "+String(h)+" is not a constructor or null");function _(){this.constructor=n}o(n,h),n.prototype=h===null?Object.create(h):(_.prototype=h.prototype,new _)}),f=this&&this.__decorate||function(n,h,_,d){var b,g=arguments.length,A=g<3?h:d===null?d=Object.getOwnPropertyDescriptor(h,_):d;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")A=Reflect.decorate(n,h,_,d);else for(var R=n.length-1;R>=0;R--)(b=n[R])&&(A=(g<3?b(A):g>3?b(h,_,A):b(h,_))||A);return g>3&&A&&Object.defineProperty(h,_,A),A},m=this&&this.__param||function(n,h){return function(_,d){h(_,d,n)}};Object.defineProperty(r,"__esModule",{value:!0}),r.CoreService=void 0;var C=u(2585),S=u(8460),p=u(1439),v=u(844),w=Object.freeze({insertMode:!1}),y=Object.freeze({applicationCursorKeys:!1,applicationKeypad:!1,bracketedPasteMode:!1,origin:!1,reverseWraparound:!1,sendFocus:!1,wraparound:!0}),c=function(n){function h(_,d,b,g){var A=n.call(this)||this;return A._bufferService=d,A._logService=b,A._optionsService=g,A.isCursorInitialized=!1,A.isCursorHidden=!1,A._onData=A.register(new S.EventEmitter),A._onUserInput=A.register(new S.EventEmitter),A._onBinary=A.register(new S.EventEmitter),A._scrollToBottom=_,A.register({dispose:function(){return A._scrollToBottom=void 0}}),A.modes=(0,p.clone)(w),A.decPrivateModes=(0,p.clone)(y),A}return l(h,n),Object.defineProperty(h.prototype,"onData",{get:function(){return this._onData.event},enumerable:!1,configurable:!0}),Object.defineProperty(h.prototype,"onUserInput",{get:function(){return this._onUserInput.event},enumerable:!1,configurable:!0}),Object.defineProperty(h.prototype,"onBinary",{get:function(){return this._onBinary.event},enumerable:!1,configurable:!0}),h.prototype.reset=function(){this.modes=(0,p.clone)(w),this.decPrivateModes=(0,p.clone)(y)},h.prototype.triggerDataEvent=function(_,d){if(d===void 0&&(d=!1),!this._optionsService.rawOptions.disableStdin){var b=this._bufferService.buffer;b.ybase!==b.ydisp&&this._scrollToBottom(),d&&this._onUserInput.fire(),this._logService.debug('sending data "'+_+'"',function(){return _.split("").map(function(g){return g.charCodeAt(0)})}),this._onData.fire(_)}},h.prototype.triggerBinaryEvent=function(_){this._optionsService.rawOptions.disableStdin||(this._logService.debug('sending binary "'+_+'"',function(){return _.split("").map(function(d){return d.charCodeAt(0)})}),this._onBinary.fire(_))},f([m(1,C.IBufferService),m(2,C.ILogService),m(3,C.IOptionsService)],h)}(v.Disposable);r.CoreService=c},9074:function(a,r,u){var o,l=this&&this.__extends||(o=function(c,n){return o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(h,_){h.__proto__=_}||function(h,_){for(var d in _)Object.prototype.hasOwnProperty.call(_,d)&&(h[d]=_[d])},o(c,n)},function(c,n){if(typeof n!="function"&&n!==null)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function h(){this.constructor=c}o(c,n),c.prototype=n===null?Object.create(n):(h.prototype=n.prototype,new h)}),f=this&&this.__generator||function(c,n){var h,_,d,b,g={label:0,sent:function(){if(1&d[0])throw d[1];return d[1]},trys:[],ops:[]};return b={next:A(0),throw:A(1),return:A(2)},typeof Symbol=="function"&&(b[Symbol.iterator]=function(){return this}),b;function A(R){return function(x){return function(k){if(h)throw new TypeError("Generator is already executing.");for(;g;)try{if(h=1,_&&(d=2&k[0]?_.return:k[0]?_.throw||((d=_.return)&&d.call(_),0):_.next)&&!(d=d.call(_,k[1])).done)return d;switch(_=0,d&&(k=[2&k[0],d.value]),k[0]){case 0:case 1:d=k;break;case 4:return g.label++,{value:k[1],done:!1};case 5:g.label++,_=k[1],k=[0];continue;case 7:k=g.ops.pop(),g.trys.pop();continue;default:if(!((d=(d=g.trys).length>0&&d[d.length-1])||k[0]!==6&&k[0]!==2)){g=0;continue}if(k[0]===3&&(!d||k[1]>d[0]&&k[1]<d[3])){g.label=k[1];break}if(k[0]===6&&g.label<d[1]){g.label=d[1],d=k;break}if(d&&g.label<d[2]){g.label=d[2],g.ops.push(k);break}d[2]&&g.ops.pop(),g.trys.pop();continue}k=n.call(c,g)}catch(O){k=[6,O],_=0}finally{h=d=0}if(5&k[0])throw k[1];return{value:k[0]?k[1]:void 0,done:!0}}([R,x])}}},m=this&&this.__values||function(c){var n=typeof Symbol=="function"&&Symbol.iterator,h=n&&c[n],_=0;if(h)return h.call(c);if(c&&typeof c.length=="number")return{next:function(){return c&&_>=c.length&&(c=void 0),{value:c&&c[_++],done:!c}}};throw new TypeError(n?"Object is not iterable.":"Symbol.iterator is not defined.")};Object.defineProperty(r,"__esModule",{value:!0}),r.DecorationService=void 0;var C=u(8055),S=u(8460),p=u(844),v=u(6106),w=function(c){function n(){var h=c.call(this)||this;return h._decorations=new v.SortedList(function(_){return _.marker.line}),h._onDecorationRegistered=h.register(new S.EventEmitter),h._onDecorationRemoved=h.register(new S.EventEmitter),h}return l(n,c),Object.defineProperty(n.prototype,"onDecorationRegistered",{get:function(){return this._onDecorationRegistered.event},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"onDecorationRemoved",{get:function(){return this._onDecorationRemoved.event},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"decorations",{get:function(){return this._decorations.values()},enumerable:!1,configurable:!0}),n.prototype.registerDecoration=function(h){var _=this;if(!h.marker.isDisposed){var d=new y(h);if(d){var b=d.marker.onDispose(function(){return d.dispose()});d.onDispose(function(){d&&(_._decorations.delete(d)&&_._onDecorationRemoved.fire(d),b.dispose())}),this._decorations.insert(d),this._onDecorationRegistered.fire(d)}return d}},n.prototype.reset=function(){var h,_;try{for(var d=m(this._decorations.values()),b=d.next();!b.done;b=d.next())b.value.dispose()}catch(g){h={error:g}}finally{try{b&&!b.done&&(_=d.return)&&_.call(d)}finally{if(h)throw h.error}}this._decorations.clear()},n.prototype.getDecorationsAtLine=function(h){return f(this,function(_){return[2,this._decorations.getKeyIterator(h)]})},n.prototype.getDecorationsAtCell=function(h,_,d){var b,g,A,R,x,k,O,I,T,P,M;return f(this,function(D){switch(D.label){case 0:b=0,g=0,D.label=1;case 1:D.trys.push([1,6,7,8]),A=m(this._decorations.getKeyIterator(_)),R=A.next(),D.label=2;case 2:return R.done?[3,5]:(x=R.value,b=(T=x.options.x)!==null&&T!==void 0?T:0,g=b+((P=x.options.width)!==null&&P!==void 0?P:1),!(h>=b&&h<g)||d&&((M=x.options.layer)!==null&&M!==void 0?M:"bottom")!==d?[3,4]:[4,x]);case 3:D.sent(),D.label=4;case 4:return R=A.next(),[3,2];case 5:return[3,8];case 6:return k=D.sent(),O={error:k},[3,8];case 7:try{R&&!R.done&&(I=A.return)&&I.call(A)}finally{if(O)throw O.error}return[7];case 8:return[2]}})},n.prototype.dispose=function(){var h,_;try{for(var d=m(this._decorations.values()),b=d.next();!b.done;b=d.next()){var g=b.value;this._onDecorationRemoved.fire(g)}}catch(A){h={error:A}}finally{try{b&&!b.done&&(_=d.return)&&_.call(d)}finally{if(h)throw h.error}}this.reset()},n}(p.Disposable);r.DecorationService=w;var y=function(c){function n(h){var _=c.call(this)||this;return _.options=h,_.isDisposed=!1,_.onRenderEmitter=_.register(new S.EventEmitter),_.onRender=_.onRenderEmitter.event,_._onDispose=_.register(new S.EventEmitter),_.onDispose=_._onDispose.event,_._cachedBg=null,_._cachedFg=null,_.marker=h.marker,_.options.overviewRulerOptions&&!_.options.overviewRulerOptions.position&&(_.options.overviewRulerOptions.position="full"),_}return l(n,c),Object.defineProperty(n.prototype,"backgroundColorRGB",{get:function(){return this._cachedBg===null&&(this.options.backgroundColor?this._cachedBg=C.css.toColor(this.options.backgroundColor):this._cachedBg=void 0),this._cachedBg},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"foregroundColorRGB",{get:function(){return this._cachedFg===null&&(this.options.foregroundColor?this._cachedFg=C.css.toColor(this.options.foregroundColor):this._cachedFg=void 0),this._cachedFg},enumerable:!1,configurable:!0}),n.prototype.dispose=function(){this._isDisposed||(this._isDisposed=!0,this._onDispose.fire(),c.prototype.dispose.call(this))},n}(p.Disposable)},3730:function(a,r,u){var o=this&&this.__decorate||function(C,S,p,v){var w,y=arguments.length,c=y<3?S:v===null?v=Object.getOwnPropertyDescriptor(S,p):v;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")c=Reflect.decorate(C,S,p,v);else for(var n=C.length-1;n>=0;n--)(w=C[n])&&(c=(y<3?w(c):y>3?w(S,p,c):w(S,p))||c);return y>3&&c&&Object.defineProperty(S,p,c),c},l=this&&this.__param||function(C,S){return function(p,v){S(p,v,C)}};Object.defineProperty(r,"__esModule",{value:!0}),r.DirtyRowService=void 0;var f=u(2585),m=function(){function C(S){this._bufferService=S,this.clearRange()}return Object.defineProperty(C.prototype,"start",{get:function(){return this._start},enumerable:!1,configurable:!0}),Object.defineProperty(C.prototype,"end",{get:function(){return this._end},enumerable:!1,configurable:!0}),C.prototype.clearRange=function(){this._start=this._bufferService.buffer.y,this._end=this._bufferService.buffer.y},C.prototype.markDirty=function(S){S<this._start?this._start=S:S>this._end&&(this._end=S)},C.prototype.markRangeDirty=function(S,p){if(S>p){var v=S;S=p,p=v}S<this._start&&(this._start=S),p>this._end&&(this._end=p)},C.prototype.markAllDirty=function(){this.markRangeDirty(0,this._bufferService.rows-1)},o([l(0,f.IBufferService)],C)}();r.DirtyRowService=m},4348:function(a,r,u){var o=this&&this.__values||function(v){var w=typeof Symbol=="function"&&Symbol.iterator,y=w&&v[w],c=0;if(y)return y.call(v);if(v&&typeof v.length=="number")return{next:function(){return v&&c>=v.length&&(v=void 0),{value:v&&v[c++],done:!v}}};throw new TypeError(w?"Object is not iterable.":"Symbol.iterator is not defined.")},l=this&&this.__read||function(v,w){var y=typeof Symbol=="function"&&v[Symbol.iterator];if(!y)return v;var c,n,h=y.call(v),_=[];try{for(;(w===void 0||w-- >0)&&!(c=h.next()).done;)_.push(c.value)}catch(d){n={error:d}}finally{try{c&&!c.done&&(y=h.return)&&y.call(h)}finally{if(n)throw n.error}}return _},f=this&&this.__spreadArray||function(v,w,y){if(y||arguments.length===2)for(var c,n=0,h=w.length;n<h;n++)!c&&n in w||(c||(c=Array.prototype.slice.call(w,0,n)),c[n]=w[n]);return v.concat(c||Array.prototype.slice.call(w))};Object.defineProperty(r,"__esModule",{value:!0}),r.InstantiationService=r.ServiceCollection=void 0;var m=u(2585),C=u(8343),S=function(){function v(){for(var w,y,c=[],n=0;n<arguments.length;n++)c[n]=arguments[n];this._entries=new Map;try{for(var h=o(c),_=h.next();!_.done;_=h.next()){var d=l(_.value,2),b=d[0],g=d[1];this.set(b,g)}}catch(A){w={error:A}}finally{try{_&&!_.done&&(y=h.return)&&y.call(h)}finally{if(w)throw w.error}}}return v.prototype.set=function(w,y){var c=this._entries.get(w);return this._entries.set(w,y),c},v.prototype.forEach=function(w){this._entries.forEach(function(y,c){return w(c,y)})},v.prototype.has=function(w){return this._entries.has(w)},v.prototype.get=function(w){return this._entries.get(w)},v}();r.ServiceCollection=S;var p=function(){function v(){this._services=new S,this._services.set(m.IInstantiationService,this)}return v.prototype.setService=function(w,y){this._services.set(w,y)},v.prototype.getService=function(w){return this._services.get(w)},v.prototype.createInstance=function(w){for(var y,c,n=[],h=1;h<arguments.length;h++)n[h-1]=arguments[h];var _=(0,C.getServiceDependencies)(w).sort(function(k,O){return k.index-O.index}),d=[];try{for(var b=o(_),g=b.next();!g.done;g=b.next()){var A=g.value,R=this._services.get(A.id);if(!R)throw new Error("[createInstance] "+w.name+" depends on UNKNOWN service "+A.id+".");d.push(R)}}catch(k){y={error:k}}finally{try{g&&!g.done&&(c=b.return)&&c.call(b)}finally{if(y)throw y.error}}var x=_.length>0?_[0].index:n.length;if(n.length!==x)throw new Error("[createInstance] First service dependency of "+w.name+" at position "+(x+1)+" conflicts with "+n.length+" static arguments");return new(w.bind.apply(w,f([void 0],l(f(f([],l(n),!1),l(d),!1)),!1)))},v}();r.InstantiationService=p},7866:function(a,r,u){var o=this&&this.__decorate||function(v,w,y,c){var n,h=arguments.length,_=h<3?w:c===null?c=Object.getOwnPropertyDescriptor(w,y):c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")_=Reflect.decorate(v,w,y,c);else for(var d=v.length-1;d>=0;d--)(n=v[d])&&(_=(h<3?n(_):h>3?n(w,y,_):n(w,y))||_);return h>3&&_&&Object.defineProperty(w,y,_),_},l=this&&this.__param||function(v,w){return function(y,c){w(y,c,v)}},f=this&&this.__read||function(v,w){var y=typeof Symbol=="function"&&v[Symbol.iterator];if(!y)return v;var c,n,h=y.call(v),_=[];try{for(;(w===void 0||w-- >0)&&!(c=h.next()).done;)_.push(c.value)}catch(d){n={error:d}}finally{try{c&&!c.done&&(y=h.return)&&y.call(h)}finally{if(n)throw n.error}}return _},m=this&&this.__spreadArray||function(v,w,y){if(y||arguments.length===2)for(var c,n=0,h=w.length;n<h;n++)!c&&n in w||(c||(c=Array.prototype.slice.call(w,0,n)),c[n]=w[n]);return v.concat(c||Array.prototype.slice.call(w))};Object.defineProperty(r,"__esModule",{value:!0}),r.LogService=void 0;var C=u(2585),S={debug:C.LogLevelEnum.DEBUG,info:C.LogLevelEnum.INFO,warn:C.LogLevelEnum.WARN,error:C.LogLevelEnum.ERROR,off:C.LogLevelEnum.OFF},p=function(){function v(w){var y=this;this._optionsService=w,this.logLevel=C.LogLevelEnum.OFF,this._updateLogLevel(),this._optionsService.onOptionChange(function(c){c==="logLevel"&&y._updateLogLevel()})}return v.prototype._updateLogLevel=function(){this.logLevel=S[this._optionsService.rawOptions.logLevel]},v.prototype._evalLazyOptionalParams=function(w){for(var y=0;y<w.length;y++)typeof w[y]=="function"&&(w[y]=w[y]())},v.prototype._log=function(w,y,c){this._evalLazyOptionalParams(c),w.call.apply(w,m([console,"xterm.js: "+y],f(c),!1))},v.prototype.debug=function(w){for(var y=[],c=1;c<arguments.length;c++)y[c-1]=arguments[c];this.logLevel<=C.LogLevelEnum.DEBUG&&this._log(console.log,w,y)},v.prototype.info=function(w){for(var y=[],c=1;c<arguments.length;c++)y[c-1]=arguments[c];this.logLevel<=C.LogLevelEnum.INFO&&this._log(console.info,w,y)},v.prototype.warn=function(w){for(var y=[],c=1;c<arguments.length;c++)y[c-1]=arguments[c];this.logLevel<=C.LogLevelEnum.WARN&&this._log(console.warn,w,y)},v.prototype.error=function(w){for(var y=[],c=1;c<arguments.length;c++)y[c-1]=arguments[c];this.logLevel<=C.LogLevelEnum.ERROR&&this._log(console.error,w,y)},o([l(0,C.IOptionsService)],v)}();r.LogService=p},7302:function(a,r,u){var o=this&&this.__assign||function(){return o=Object.assign||function(S){for(var p,v=1,w=arguments.length;v<w;v++)for(var y in p=arguments[v])Object.prototype.hasOwnProperty.call(p,y)&&(S[y]=p[y]);return S},o.apply(this,arguments)};Object.defineProperty(r,"__esModule",{value:!0}),r.OptionsService=r.DEFAULT_OPTIONS=r.DEFAULT_BELL_SOUND=void 0;var l=u(8460),f=u(6114);r.DEFAULT_BELL_SOUND="data:audio/mp3;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4LjMyLjEwNAAAAAAAAAAAAAAA//tQxAADB8AhSmxhIIEVCSiJrDCQBTcu3UrAIwUdkRgQbFAZC1CQEwTJ9mjRvBA4UOLD8nKVOWfh+UlK3z/177OXrfOdKl7pyn3Xf//WreyTRUoAWgBgkOAGbZHBgG1OF6zM82DWbZaUmMBptgQhGjsyYqc9ae9XFz280948NMBWInljyzsNRFLPWdnZGWrddDsjK1unuSrVN9jJsK8KuQtQCtMBjCEtImISdNKJOopIpBFpNSMbIHCSRpRR5iakjTiyzLhchUUBwCgyKiweBv/7UsQbg8isVNoMPMjAAAA0gAAABEVFGmgqK////9bP/6XCykxBTUUzLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq",r.DEFAULT_OPTIONS={cols:80,rows:24,cursorBlink:!1,cursorStyle:"block",cursorWidth:1,customGlyphs:!0,bellSound:r.DEFAULT_BELL_SOUND,bellStyle:"none",drawBoldTextInBrightColors:!0,fastScrollModifier:"alt",fastScrollSensitivity:5,fontFamily:"courier-new, courier, monospace",fontSize:15,fontWeight:"normal",fontWeightBold:"bold",lineHeight:1,linkTooltipHoverDuration:500,letterSpacing:0,logLevel:"info",scrollback:1e3,scrollSensitivity:1,screenReaderMode:!1,macOptionIsMeta:!1,macOptionClickForcesSelection:!1,minimumContrastRatio:1,disableStdin:!1,allowProposedApi:!0,allowTransparency:!1,tabStopWidth:8,theme:{},rightClickSelectsWord:f.isMac,rendererType:"canvas",windowOptions:{},windowsMode:!1,wordSeparator:" ()[]{}',\"`",altClickMovesCursor:!0,convertEol:!1,termName:"xterm",cancelEvents:!1,overviewRulerWidth:void 0};var m=["normal","bold","100","200","300","400","500","600","700","800","900"],C=function(){function S(p){this._onOptionChange=new l.EventEmitter;var v=o({},r.DEFAULT_OPTIONS);for(var w in p)if(w in v)try{var y=p[w];v[w]=this._sanitizeAndValidateOption(w,y)}catch(c){console.error(c)}this.rawOptions=v,this.options=o({},v),this._setupOptions()}return Object.defineProperty(S.prototype,"onOptionChange",{get:function(){return this._onOptionChange.event},enumerable:!1,configurable:!0}),S.prototype._setupOptions=function(){var p=this,v=function(n){if(!(n in r.DEFAULT_OPTIONS))throw new Error('No option with key "'+n+'"');return p.rawOptions[n]},w=function(n,h){if(!(n in r.DEFAULT_OPTIONS))throw new Error('No option with key "'+n+'"');h=p._sanitizeAndValidateOption(n,h),p.rawOptions[n]!==h&&(p.rawOptions[n]=h,p._onOptionChange.fire(n))};for(var y in this.rawOptions){var c={get:v.bind(this,y),set:w.bind(this,y)};Object.defineProperty(this.options,y,c)}},S.prototype.setOption=function(p,v){this.options[p]=v},S.prototype._sanitizeAndValidateOption=function(p,v){switch(p){case"bellStyle":case"cursorStyle":case"rendererType":case"wordSeparator":v||(v=r.DEFAULT_OPTIONS[p]);break;case"fontWeight":case"fontWeightBold":if(typeof v=="number"&&1<=v&&v<=1e3)break;v=m.includes(v)?v:r.DEFAULT_OPTIONS[p];break;case"cursorWidth":v=Math.floor(v);case"lineHeight":case"tabStopWidth":if(v<1)throw new Error(p+" cannot be less than 1, value: "+v);break;case"minimumContrastRatio":v=Math.max(1,Math.min(21,Math.round(10*v)/10));break;case"scrollback":if((v=Math.min(v,4294967295))<0)throw new Error(p+" cannot be less than 0, value: "+v);break;case"fastScrollSensitivity":case"scrollSensitivity":if(v<=0)throw new Error(p+" cannot be less than or equal to 0, value: "+v);case"rows":case"cols":if(!v&&v!==0)throw new Error(p+" must be numeric, value: "+v)}return v},S.prototype.getOption=function(p){return this.options[p]},S}();r.OptionsService=C},8343:(a,r)=>{function u(o,l,f){l.di$target===l?l.di$dependencies.push({id:o,index:f}):(l.di$dependencies=[{id:o,index:f}],l.di$target=l)}Object.defineProperty(r,"__esModule",{value:!0}),r.createDecorator=r.getServiceDependencies=r.serviceRegistry=void 0,r.serviceRegistry=new Map,r.getServiceDependencies=function(o){return o.di$dependencies||[]},r.createDecorator=function(o){if(r.serviceRegistry.has(o))return r.serviceRegistry.get(o);var l=function(f,m,C){if(arguments.length!==3)throw new Error("@IServiceName-decorator can only be used to decorate a parameter");u(l,f,C)};return l.toString=function(){return o},r.serviceRegistry.set(o,l),l}},2585:(a,r,u)=>{Object.defineProperty(r,"__esModule",{value:!0}),r.IDecorationService=r.IUnicodeService=r.IOptionsService=r.ILogService=r.LogLevelEnum=r.IInstantiationService=r.IDirtyRowService=r.ICharsetService=r.ICoreService=r.ICoreMouseService=r.IBufferService=void 0;var o,l=u(8343);r.IBufferService=(0,l.createDecorator)("BufferService"),r.ICoreMouseService=(0,l.createDecorator)("CoreMouseService"),r.ICoreService=(0,l.createDecorator)("CoreService"),r.ICharsetService=(0,l.createDecorator)("CharsetService"),r.IDirtyRowService=(0,l.createDecorator)("DirtyRowService"),r.IInstantiationService=(0,l.createDecorator)("InstantiationService"),(o=r.LogLevelEnum||(r.LogLevelEnum={}))[o.DEBUG=0]="DEBUG",o[o.INFO=1]="INFO",o[o.WARN=2]="WARN",o[o.ERROR=3]="ERROR",o[o.OFF=4]="OFF",r.ILogService=(0,l.createDecorator)("LogService"),r.IOptionsService=(0,l.createDecorator)("OptionsService"),r.IUnicodeService=(0,l.createDecorator)("UnicodeService"),r.IDecorationService=(0,l.createDecorator)("DecorationService")},1480:(a,r,u)=>{Object.defineProperty(r,"__esModule",{value:!0}),r.UnicodeService=void 0;var o=u(8460),l=u(225),f=function(){function m(){this._providers=Object.create(null),this._active="",this._onChange=new o.EventEmitter;var C=new l.UnicodeV6;this.register(C),this._active=C.version,this._activeProvider=C}return Object.defineProperty(m.prototype,"onChange",{get:function(){return this._onChange.event},enumerable:!1,configurable:!0}),Object.defineProperty(m.prototype,"versions",{get:function(){return Object.keys(this._providers)},enumerable:!1,configurable:!0}),Object.defineProperty(m.prototype,"activeVersion",{get:function(){return this._active},set:function(C){if(!this._providers[C])throw new Error('unknown Unicode version "'+C+'"');this._active=C,this._activeProvider=this._providers[C],this._onChange.fire(C)},enumerable:!1,configurable:!0}),m.prototype.register=function(C){this._providers[C.version]=C},m.prototype.wcwidth=function(C){return this._activeProvider.wcwidth(C)},m.prototype.getStringCellWidth=function(C){for(var S=0,p=C.length,v=0;v<p;++v){var w=C.charCodeAt(v);if(55296<=w&&w<=56319){if(++v>=p)return S+this.wcwidth(w);var y=C.charCodeAt(v);56320<=y&&y<=57343?w=1024*(w-55296)+y-56320+65536:S+=this.wcwidth(y)}S+=this.wcwidth(w)}return S},m}();r.UnicodeService=f}},s={};return function a(r){var u=s[r];if(u!==void 0)return u.exports;var o=s[r]={exports:{}};return i[r].call(o.exports,o,o.exports,a),o.exports}(4389)})()})})(eo);var Go=eo.exports,ve=ve||{};ve.scope={};ve.ASSUME_ES5=!1;ve.ASSUME_NO_NATIVE_MAP=!1;ve.ASSUME_NO_NATIVE_SET=!1;ve.SIMPLE_FROUND_POLYFILL=!1;ve.ISOLATE_POLYFILLS=!1;ve.FORCE_POLYFILL_PROMISE=!1;ve.FORCE_POLYFILL_PROMISE_WHEN_NO_UNHANDLED_REJECTION=!1;ve.defineProperty=ve.ASSUME_ES5||typeof Object.defineProperties=="function"?Object.defineProperty:function(e,t,i){return e==Array.prototype||e==Object.prototype||(e[t]=i.value),e};ve.getGlobal=function(e){e=[typeof globalThis=="object"&&globalThis,e,typeof window=="object"&&window,typeof self=="object"&&self,typeof global=="object"&&global];for(var t=0;t<e.length;++t){var i=e[t];if(i&&i.Math==Math)return i}throw Error("Cannot find global object")};ve.global=ve.getGlobal(globalThis);ve.IS_SYMBOL_NATIVE=typeof Symbol=="function"&&typeof Symbol("x")=="symbol";ve.TRUST_ES6_POLYFILLS=!ve.ISOLATE_POLYFILLS||ve.IS_SYMBOL_NATIVE;ve.polyfills={};ve.propertyToPolyfillSymbol={};ve.POLYFILL_PREFIX="$jscp$";ve.polyfill=function(e,t,i,s){t&&(ve.ISOLATE_POLYFILLS?ve.polyfillIsolated(e,t,i,s):ve.polyfillUnisolated(e,t,i,s))};ve.polyfillUnisolated=function(e,t,i,s){for(i=ve.global,e=e.split("."),s=0;s<e.length-1;s++){var a=e[s];if(!(a in i))return;i=i[a]}e=e[e.length-1],s=i[e],t=t(s),t!=s&&t!=null&&ve.defineProperty(i,e,{configurable:!0,writable:!0,value:t})};ve.polyfillIsolated=function(e,t,i,s){var a=e.split(".");e=a.length===1,s=a[0],s=!e&&s in ve.polyfills?ve.polyfills:ve.global;for(var r=0;r<a.length-1;r++){var u=a[r];if(!(u in s))return;s=s[u]}a=a[a.length-1],i=ve.IS_SYMBOL_NATIVE&&i==="es6"?s[a]:null,t=t(i),t!=null&&(e?ve.defineProperty(ve.polyfills,a,{configurable:!0,writable:!0,value:t}):t!==i&&(ve.propertyToPolyfillSymbol[a]===void 0&&(i=1e9*Math.random()>>>0,ve.propertyToPolyfillSymbol[a]=ve.IS_SYMBOL_NATIVE?ve.global.Symbol(a):ve.POLYFILL_PREFIX+i+"$"+a),ve.defineProperty(s,ve.propertyToPolyfillSymbol[a],{configurable:!0,writable:!0,value:t})))};ve.polyfill("globalThis",function(e){return e||ve.global},"es_2020","es3");ve.polyfill("String.prototype.trimRight",function(e){function t(){return this.replace(/[\s\xa0]+$/,"")}return e||t},"es_2019","es3");var zt=2,ke=16,ft=32,Se=64,Pe=128,Q=256,Mt=512,st=2048,Me=8192,Ke=16384,Z=32768,Wt=65536,Ve=262144,oe=524288,Y=1048576,we=2097152,$t=4194304,ce=8388608,Vr=512,Ko=2,Vo=0,Xo=3,ht=17,Nr=1<<ht,Yo=32,Zo=0,Jo=1,Qo=3,$o=5,ea=15,ta=13,ia=25,ra=32768,Ci=49152,sa=1431127377,to=900,Xr=1024,pi=0,vi=1,ei=2,js=0,qr=1,Yr=2;function na(e,t){function i(x){return x=x.toString(16),"#"+"0".repeat(6-x.length)+x}function s(x,k,O,I){x.style.width="",x.style.height="",I&&(x.style.transform="");var T=x.getBoundingClientRect();I?x.style.transform=(k===1?"":" scaleX("+k+")")+(O===1?"":" scaleY("+O+")"):(k%1===0&&O%1===0?(a.style.imageRendering="crisp-edges",a.style.imageRendering="pixelated",a.style["-ms-interpolation-mode"]="nearest-neighbor"):(a.style.imageRendering="",a.style["-ms-interpolation-mode"]=""),I=window.devicePixelRatio||1,I%1!==0&&(k/=I,O/=I)),k!==1&&(x.style.width=T.width*k+"px"),O!==1&&(x.style.height=T.height*O+"px")}console.assert(e,"1st argument must be a DOM container");var a=e.getElementsByTagName("canvas")[0],r=a.getContext("2d",{alpha:!1}),u=e.getElementsByTagName("div")[0],o=document.createElement("div"),l,f,m=1,C=1,S=1,p,v=!1,w,y,c,n=!1,h=this;e=new Uint16Array([199,252,233,226,228,224,229,231,234,235,232,239,238,236,196,197,201,230,198,244,246,242,251,249,255,214,220,162,163,165,8359,402,225,237,243,250,241,209,170,186,191,8976,172,189,188,161,171,187,9617,9618,9619,9474,9508,9569,9570,9558,9557,9571,9553,9559,9565,9564,9563,9488,9492,9524,9516,9500,9472,9532,9566,9567,9562,9556,9577,9574,9568,9552,9580,9575,9576,9572,9573,9561,9560,9554,9555,9579,9578,9496,9484,9608,9604,9612,9616,9600,945,223,915,960,931,963,181,964,934,920,937,948,8734,966,949,8745,8801,177,8805,8804,8992,8993,247,8776,176,8729,183,8730,8319,178,9632,160]);for(var _=new Uint16Array([32,9786,9787,9829,9830,9827,9824,8226,9688,9675,9689,9794,9792,9834,9835,9788,9658,9668,8597,8252,182,167,9644,8616,8593,8595,8594,8592,8735,8596,9650,9660]),d=[],b,g=0;256>g;g++)b=127<g?e[g-128]:32>g?_[g]:g,d[g]=String.fromCharCode(b);r.imageSmoothingEnabled=!1,o.style.position="absolute",o.style.backgroundColor="#ccc",o.style.width="7px",o.style.display="inline-block",u.style.display="block",a.style.display="none",this.bus=t,t.register("screen-set-mode",function(x){this.set_mode(x)},this),t.register("screen-fill-buffer-end",function(x){this.update_buffer(x)},this),t.register("screen-put-char",function(x){this.put_char(x[0],x[1],x[2],x[3],x[4])},this),t.register("screen-update-cursor",function(x){this.update_cursor(x[0],x[1])},this),t.register("screen-update-cursor-scanline",function(x){this.update_cursor_scanline(x[0],x[1])},this),t.register("screen-clear",function(){this.clear_screen()},this),t.register("screen-set-size-text",function(x){this.set_size_text(x[0],x[1])},this),t.register("screen-set-size-graphical",function(x){this.set_size_graphical(x[0],x[1],x[2],x[3])},this),this.init=function(){this.set_size_text(80,25),this.timer()},this.make_screenshot=function(){const x=new Image;if(v)x.src=a.toDataURL("image/png");else{const k=[9,16],O=document.createElement("canvas");O.width=y*k[0],O.height=c*k[1];const I=O.getContext("2d");I.imageSmoothingEnabled=!1,I.font=window.getComputedStyle(u).font,I.textBaseline="top";for(let T=0;T<y;T++)for(let P=0;P<c;P++){const M=3*(P*y+T);I.fillStyle=i(w[M+1]),I.fillRect(T*k[0],P*k[1],k[0],k[1]),I.fillStyle=i(w[M+2]),I.fillText(d[w[M]],T*k[0],P*k[1])}o.style.display!=="none"&&(I.fillStyle=o.style.backgroundColor,I.fillRect(f*k[0],l*k[1]+parseInt(o.style.marginTop,10)-1,parseInt(o.style.width,10),parseInt(o.style.height,10))),x.src=O.toDataURL("image/png")}try{window.open("").document.write(x.outerHTML)}catch{}},this.put_char=function(x,k,O,I,T){x<c&&k<y&&(k=3*(x*y+k),w[k]=O,w[k+1]=I,w[k+2]=T,p[x]=1)},this.timer=function(){n||requestAnimationFrame(v?R:A)};var A=function(){for(var x=0;x<c;x++)p[x]&&(h.text_update_row(x),p[x]=0);this.timer()}.bind(this),R=function(){this.bus.send("screen-fill-buffer"),this.timer()}.bind(this);this.destroy=function(){n=!0},this.set_mode=function(x){(v=x)?(u.style.display="none",a.style.display="block"):(u.style.display="block",a.style.display="none")},this.clear_screen=function(){r.fillStyle="#000",r.fillRect(0,0,a.width,a.height)},this.set_size_text=function(x,k){if(x!==y||k!==c){for(p=new Int8Array(k),w=new Int32Array(x*k*3),y=x,c=k;u.childNodes.length>k;)u.removeChild(u.firstChild);for(;u.childNodes.length<k;)u.appendChild(document.createElement("div"));for(x=0;x<k;x++)this.text_update_row(x);s(u,m,C,!0)}},this.set_size_graphical=function(x,k,O,I){a.style.display="block",a.width=x,a.height=k,S=640>=x&&2*x<window.innerWidth&&2*x<window.innerHeight?2:1,s(a,m*S,C*S,!1)},this.set_scale=function(x,k){m=x,C=k,s(u,m,C,!0),s(a,m*S,C*S,!1)},this.set_scale(m,C),this.update_cursor_scanline=function(x,k){x&32?o.style.display="none":(o.style.display="inline",o.style.height=Math.min(15,k-x)+"px",o.style.marginTop=Math.min(15,x)+"px")},this.update_cursor=function(x,k){(x!==l||k!==f)&&(p[x]=1,p[l]=1,l=x,f=k)},this.text_update_row=function(x){for(var k=3*x*y,O,I=u.childNodes[x],T=document.createElement("div"),P=0;P<y;){var M=document.createElement("span"),D=w[k+1],q=w[k+2];for(M.style.backgroundColor=i(D),M.style.color=i(q),O="";P<y&&w[k+1]===D&&w[k+2]===q;){var H=w[k];if(O+=d[H],d[H],P++,k+=3,x===l){if(P===f)break;if(P===f+1){T.appendChild(o);break}}}M.textContent=O,T.appendChild(M)}I.parentNode.replaceChild(T,I)},this.update_buffer=function(x){x.forEach(k=>{r.putImageData(k.image_data,k.screen_x-k.buffer_x,k.screen_y-k.buffer_y,k.buffer_x,k.buffer_y,k.buffer_width,k.buffer_height)})},this.init()}const oa=0,aa=254;var Dt=1,Qt=2,io=17,un=95,Os=39,ha=1,ca=2,_a=4,la=8,ua=16,da=32,fa=64,pa=128,va=256;const ma=0,Ts=1,li=2,dn=Object.freeze(["shared","exclusive","unlock"]),fn=0,ga=1;var ya=-1,Ir=1,As=2;function kt(e,t,i){this.fs=e,this.bus=i,this.configspace_tagname=[104,111,115,116,57,112],this.configspace_taglen=this.configspace_tagname.length,this.VERSION="9P2000.L",this.msize=this.BLOCKSIZE=8192,this.replybuffer=new Uint8Array(2*this.msize),this.replybuffersize=0,this.fids=[],this.virtio=new $e(t,{name:"virtio-9p",pci_id:48,device_id:4169,subsystem_device_id:9,common:{initial_port:43008,queues:[{size_supported:32,notify_offset:0}],features:[oa,Ro,Lo,Ao],on_driver_ok:()=>{}},notification:{initial_port:43264,single_handler:!1,handlers:[s=>{if(s===0){for(;this.virtqueue.has_request();)s=this.virtqueue.pop_request(),this.ReceiveRequest(s);this.virtqueue.notify_me_after(0)}}]},isr_status:{initial_port:42752},device_specific:{initial_port:42496,struct:[{bytes:2,name:"mount tag length",read:()=>this.configspace_taglen,write:s=>{}}].concat(V.range(aa).map(s=>({bytes:1,name:"mount tag name "+s,read:()=>this.configspace_tagname[s]||0,write:a=>{}})))}}),this.virtqueue=this.virtio.queues[0]}kt.prototype.get_state=function(){var e=[];return e[0]=this.configspace_tagname,e[1]=this.configspace_taglen,e[2]=this.virtio,e[3]=this.VERSION,e[4]=this.BLOCKSIZE,e[5]=this.msize,e[6]=this.replybuffer,e[7]=this.replybuffersize,e[8]=this.fids.map(function(t){return[t.inodeid,t.type,t.uid,t.dbg_name]}),e[9]=this.fs,e};kt.prototype.set_state=function(e){this.configspace_tagname=e[0],this.configspace_taglen=e[1],this.virtio.set_state(e[2]),this.virtqueue=this.virtio.queues[0],this.VERSION=e[3],this.BLOCKSIZE=e[4],this.msize=e[5],this.replybuffer=e[6],this.replybuffersize=e[7],this.fids=e[8].map(function(t){return{inodeid:t[0],type:t[1],uid:t[2],dbg_name:t[3]}}),this.fs.set_state(e[9])};kt.prototype.Createfid=function(e,t,i,s){return{inodeid:e,type:t,uid:i,dbg_name:s}};kt.prototype.update_dbg_name=function(e,t){for(const i of this.fids)i.inodeid===e&&(i.dbg_name=t)};kt.prototype.Reset=function(){this.fids=[]};kt.prototype.BuildReply=function(e,t,i){fe.Marshall(["w","b","h"],[i+7,e+1,t],this.replybuffer,0),i+7>=this.replybuffer.length&&ye.Debug("Error in 9p: payloadsize exceeds maximum length"),this.replybuffersize=i+7};kt.prototype.SendError=function(e,t,i){t=fe.Marshall(["w"],[i],this.replybuffer,7),this.BuildReply(6,e,t)};kt.prototype.SendReply=function(e){0<=this.replybuffersize,e.set_next_blob(this.replybuffer.subarray(0,this.replybuffersize)),this.virtqueue.push_reply(e),this.virtqueue.flush_replies()};kt.prototype.ReceiveRequest=async function(e){var t=new Uint8Array(e.length_readable);e.get_next_blob(t);var i={offset:0},s=fe.Unmarshall(["w","b","h"],t,i),a=s[0],r=s[1],u=s[2];switch(r){case 8:a=this.fs.GetTotalSize(),t=this.fs.GetSpace(),s=[16914839],s[1]=this.BLOCKSIZE,s[2]=Math.floor(t/s[1]),s[3]=s[2]-Math.floor(a/s[1]),s[4]=s[2]-Math.floor(a/s[1]),s[5]=this.fs.CountUsedInodes(),s[6]=this.fs.CountFreeInodes(),s[7]=0,s[8]=256,a=fe.Marshall("wwddddddw".split(""),s,this.replybuffer,7),this.BuildReply(r,u,a),this.SendReply(e);break;case 112:case 12:s=fe.Unmarshall(["w","w"],t,i);var o=s[0];i=s[1],ye.Debug("[open] fid="+o+", mode="+i),t=this.fids[o].inodeid;var l=this.fs.GetInode(t);ye.Debug("file open "+this.fids[o].dbg_name),s=this.fs.OpenInode(t,i),this.fs.AddEvent(this.fids[o].inodeid,function(){ye.Debug("file opened "+this.fids[o].dbg_name+" tag:"+u);var S=[];S[0]=l.qid,S[1]=this.msize-24,fe.Marshall(["Q","w"],S,this.replybuffer,7),this.BuildReply(r,u,17),this.SendReply(e)}.bind(this));break;case 70:if(s=fe.Unmarshall(["w","w","s"],t,i),t=s[0],o=s[1],a=s[2],ye.Debug("[link] dfid="+t+", name="+a),s=this.fs.Link(this.fids[t].inodeid,this.fids[o].inodeid,a),0>s){a="",s===-Dt?a="Operation not permitted":(a="Unknown error: "+-s,void 0),this.SendError(u,a,-s),this.SendReply(e);break}this.BuildReply(r,u,0),this.SendReply(e);break;case 16:s=fe.Unmarshall(["w","s","s","w"],t,i),o=s[0],a=s[1],t=s[2],s=s[3],ye.Debug("[symlink] fid="+o+", name="+a+", symgt="+t+", gid="+s),t=this.fs.CreateSymlink(a,this.fids[o].inodeid,t),l=this.fs.GetInode(t),l.uid=this.fids[o].uid,l.gid=s,fe.Marshall(["Q"],[l.qid],this.replybuffer,7),this.BuildReply(r,u,13),this.SendReply(e);break;case 18:s=fe.Unmarshall("wswwww".split(""),t,i),o=s[0],a=s[1],i=s[2],t=s[3];var f=s[4];s=s[5],ye.Debug("[mknod] fid="+o+", name="+a+", major="+t+", minor="+f),t=this.fs.CreateNode(a,this.fids[o].inodeid,t,f),l=this.fs.GetInode(t),l.mode=i,l.uid=this.fids[o].uid,l.gid=s,fe.Marshall(["Q"],[l.qid],this.replybuffer,7),this.BuildReply(r,u,13),this.SendReply(e);break;case 22:s=fe.Unmarshall(["w"],t,i),o=s[0],l=this.fs.GetInode(this.fids[o].inodeid),ye.Debug("[readlink] fid="+o+" name="+this.fids[o].dbg_name+" target="+l.symlink),a=fe.Marshall(["s"],[l.symlink],this.replybuffer,7),this.BuildReply(r,u,a),this.SendReply(e);break;case 72:s=fe.Unmarshall(["w","s","w","w"],t,i),o=s[0],a=s[1],i=s[2],s=s[3],ye.Debug("[mkdir] fid="+o+", name="+a+", mode="+i+", gid="+s),t=this.fs.CreateDirectory(a,this.fids[o].inodeid),l=this.fs.GetInode(t),l.mode=i|mt,l.uid=this.fids[o].uid,l.gid=s,fe.Marshall(["Q"],[l.qid],this.replybuffer,7),this.BuildReply(r,u,13),this.SendReply(e);break;case 14:s=fe.Unmarshall(["w","s","w","w","w"],t,i),o=s[0],a=s[1],t=s[2],i=s[3],s=s[4],this.bus.send("9p-create",[a,this.fids[o].inodeid]),ye.Debug("[create] fid="+o+", name="+a+", flags="+t+", mode="+i+", gid="+s),t=this.fs.CreateFile(a,this.fids[o].inodeid),this.fids[o].inodeid=t,this.fids[o].type=Ir,this.fids[o].dbg_name=a,l=this.fs.GetInode(t),l.uid=this.fids[o].uid,l.gid=s,l.mode=i,fe.Marshall(["Q","w"],[l.qid,this.msize-24],this.replybuffer,7),this.BuildReply(r,u,17),this.SendReply(e);break;case 52:s=fe.Unmarshall("wbwddws".split(""),t,i),o=s[0],t=s[2],a=s[4]===0?1/0:s[4],a=this.fs.DescribeLock(s[1],s[3],a,s[5],s[6]),ye.Debug("[lock] fid="+o+", type="+dn[a.type]+", start="+a.start+", length="+a.length+", proc_id="+a.proc_id),s=this.fs.Lock(this.fids[o].inodeid,a,t),fe.Marshall(["b"],[s],this.replybuffer,7),this.BuildReply(r,u,1),this.SendReply(e);break;case 54:s=fe.Unmarshall("wbddws".split(""),t,i),o=s[0],a=s[3]===0?1/0:s[3],a=this.fs.DescribeLock(s[1],s[2],a,s[4],s[5]),ye.Debug("[getlock] fid="+o+", type="+dn[a.type]+", start="+a.start+", length="+a.length+", proc_id="+a.proc_id),s=this.fs.GetLock(this.fids[o].inodeid,a),s||(s=a,s.type=li),a=fe.Marshall(["b","d","d","w","s"],[s.type,s.start,s.length===1/0?0:s.length,s.proc_id,s.client_id],this.replybuffer,7),this.BuildReply(r,u,a),this.SendReply(e);break;case 24:if(s=fe.Unmarshall(["w","d"],t,i),o=s[0],l=this.fs.GetInode(this.fids[o].inodeid),ye.Debug("[getattr]: fid="+o+" name="+this.fids[o].dbg_name+" request mask="+s[1]),!l||l.status===Kr){ye.Debug("getattr: unlinked"),this.SendError(u,"No such file or directory",Qt),this.SendReply(e);break}s[0]|=4096,s[0]=s[1],s[1]=l.qid,s[2]=l.mode,s[3]=l.uid,s[4]=l.gid,s[5]=l.nlinks,s[6]=l.major<<8|l.minor,s[7]=l.size,s[8]=this.BLOCKSIZE,s[9]=Math.floor(l.size/512+1),s[10]=l.atime,s[11]=0,s[12]=l.mtime,s[13]=0,s[14]=l.ctime,s[15]=0,s[16]=0,s[17]=0,s[18]=0,s[19]=0,fe.Marshall("dQwwwddddddddddddddd".split(""),s,this.replybuffer,7),this.BuildReply(r,u,153),this.SendReply(e);break;case 26:s=fe.Unmarshall("wwwwwddddd".split(""),t,i),o=s[0],l=this.fs.GetInode(this.fids[o].inodeid),ye.Debug("[setattr]: fid="+o+" request mask="+s[1]+" name="+this.fids[o].dbg_name),s[1]&ha&&(l.mode=s[2]),s[1]&ca&&(l.uid=s[3]),s[1]&_a&&(l.gid=s[4]),s[1]&ua&&(l.atime=Math.floor(new Date().getTime()/1e3)),s[1]&da&&(l.mtime=Math.floor(new Date().getTime()/1e3)),s[1]&fa&&(l.ctime=Math.floor(new Date().getTime()/1e3)),s[1]&pa&&(l.atime=s[6]),s[1]&va&&(l.mtime=s[8]),s[1]&la&&await this.fs.ChangeSize(this.fids[o].inodeid,s[5]),this.BuildReply(r,u,0),this.SendReply(e);break;case 50:s=fe.Unmarshall(["w","d"],t,i),o=s[0],this.BuildReply(r,u,0),this.SendReply(e);break;case 40:case 116:if(s=fe.Unmarshall(["w","d","w"],t,i),o=s[0],a=s[1],f=s[2],l=this.fs.GetInode(this.fids[o].inodeid),r==40&&ye.Debug("[treaddir]: fid="+o+" offset="+a+" count="+f),r==116&&ye.Debug("[read]: fid="+o+" ("+this.fids[o].dbg_name+") offset="+a+" count="+f+" fidtype="+this.fids[o].type),!l||l.status===Kr){ye.Debug("read/treaddir: unlinked"),this.SendError(u,"No such file or directory",Qt),this.SendReply(e);break}if(this.fids[o].type==As)for(l.caps.length<a+f&&(f=l.caps.length-a),s=0;s<f;s++)this.replybuffer[11+s]=l.caps[a+s];else this.fs.OpenInode(this.fids[o].inodeid,void 0),s=this.fids[o].inodeid,f=Math.min(f,this.replybuffer.length-11),l.size<a+f?f=l.size-a:r==40&&(f=this.fs.RoundToDirentry(s,a+f)-a),a>l.size&&(f=0),this.bus.send("9p-read-start",[this.fids[o].dbg_name]),s=await this.fs.Read(s,a,f),this.bus.send("9p-read-end",[this.fids[o].dbg_name,f]),s&&this.replybuffer.set(s,11);fe.Marshall(["w"],[f],this.replybuffer,7),this.BuildReply(r,u,4+f),this.SendReply(e);break;case 118:if(s=fe.Unmarshall(["w","d","w"],t,i),o=s[0],a=s[1],f=s[2],s=this.fids[o].dbg_name,ye.Debug("[write]: fid="+o+" ("+s+") offset="+a+" count="+f+" fidtype="+this.fids[o].type),this.fids[o].type===As){this.SendError(u,"Setxattr not supported",un),this.SendReply(e);break}else await this.fs.Write(this.fids[o].inodeid,a,f,t.subarray(i.offset));this.bus.send("9p-write-end",[s,f]),fe.Marshall(["w"],[f],this.replybuffer,7),this.BuildReply(r,u,4),this.SendReply(e);break;case 74:if(s=fe.Unmarshall(["w","s","w","s"],t,i),i=s[0],f=s[1],a=s[2],t=s[3],ye.Debug("[renameat]: oldname="+f+" newname="+t),s=await this.fs.Rename(this.fids[i].inodeid,f,this.fids[a].inodeid,t),0>s){a="",s===-Qt?a="No such file or directory":s===-Dt?a="Operation not permitted":s===-Os?a="Directory not empty":(a="Unknown error: "+-s,void 0),this.SendError(u,a,-s),this.SendReply(e);break}this.BuildReply(r,u,0),this.SendReply(e);break;case 76:if(s=fe.Unmarshall(["w","s","w"],t,i),i=s[0],a=s[1],t=s[2],ye.Debug("[unlink]: dirfd="+i+" name="+a+" flags="+t),o=this.fs.Search(this.fids[i].inodeid,a),o==-1){this.SendError(u,"No such file or directory",Qt),this.SendReply(e);break}if(s=this.fs.Unlink(this.fids[i].inodeid,a),0>s){a="",s===-Os?a="Directory not empty":s===-Dt?a="Operation not permitted":(a="Unknown error: "+-s,void 0),this.SendError(u,a,-s),this.SendReply(e);break}this.BuildReply(r,u,0),this.SendReply(e);break;case 100:s=fe.Unmarshall(["w","s"],t,i),ye.Debug("[version]: msize="+s[0]+" version="+s[1]),this.msize=s[0],a=fe.Marshall(["w","s"],[this.msize,this.VERSION],this.replybuffer,7),this.BuildReply(r,u,a),this.SendReply(e);break;case 104:s=fe.Unmarshall(["w","w","s","s","w"],t,i),o=s[0],a=s[4],ye.Debug("[attach]: fid="+o+" afid="+Dc(s[1])+" uname="+s[2]+" aname="+s[3]),this.fids[o]=this.Createfid(0,Ir,a,""),l=this.fs.GetInode(this.fids[o].inodeid),fe.Marshall(["Q"],[l.qid],this.replybuffer,7),this.BuildReply(r,u,13),this.SendReply(e),this.bus.send("9p-attach");break;case 108:s=fe.Unmarshall(["h"],t,i),ye.Debug("[flush] "+u),this.BuildReply(r,u,0),this.SendReply(e);break;case 110:s=fe.Unmarshall(["w","w","h"],t,i),o=s[0],f=s[1];var m=s[2];if(ye.Debug("[walk]: fid="+s[0]+" nwfid="+s[1]+" nwname="+m),m==0){this.fids[f]=this.Createfid(this.fids[o].inodeid,Ir,this.fids[o].uid,this.fids[o].dbg_name),fe.Marshall(["h"],[0],this.replybuffer,7),this.BuildReply(r,u,2),this.SendReply(e);break}for(a=[],s=0;s<m;s++)a.push("s");i=fe.Unmarshall(a,t,i),t=this.fids[o].inodeid,a=9;var C=0;for(ye.Debug("walk in dir "+this.fids[o].dbg_name+" to: "+i.toString()),s=0;s<m;s++){if(t=this.fs.Search(t,i[s]),t==-1){ye.Debug("Could not find: "+i[s]);break}a+=fe.Marshall(["Q"],[this.fs.GetInode(t).qid],this.replybuffer,a),C++,this.fids[f]=this.Createfid(t,Ir,this.fids[o].uid,i[s])}fe.Marshall(["h"],[C],this.replybuffer,7),this.BuildReply(r,u,a-7),this.SendReply(e);break;case 120:s=fe.Unmarshall(["w"],t,i),ye.Debug("[clunk]: fid="+s[0]),this.fids[s[0]]&&0<=this.fids[s[0]].inodeid&&(await this.fs.CloseInode(this.fids[s[0]].inodeid),this.fids[s[0]].inodeid=-1,this.fids[s[0]].type=ya),this.BuildReply(r,u,0),this.SendReply(e);break;case 32:s=fe.Unmarshall(["w","s","d","w"],t,i),o=s[0],a=s[1],i=s[2],t=s[3],ye.Debug("[txattrcreate]: fid="+o+" name="+a+" attr_size="+i+" flags="+t),this.fids[o].type=As,this.BuildReply(r,u,0),this.SendReply(e);break;case 30:s=fe.Unmarshall(["w","w","s"],t,i),o=s[0],a=s[2],ye.Debug("[xattrwalk]: fid="+s[0]+" newfid="+s[1]+" name="+s[2]),this.SendError(u,"Setxattr not supported",un),this.SendReply(e);break;default:ye.Debug("Error in Virtio9p: Unknown id "+r+" received")}};var mi=!1,ba=1,wa=1e6;function Be(e){this.ports=[],this.cpu=e;for(var t=0;65536>t;t++)this.ports[t]=this.create_empty_entry();var i=e.memory_size[0];for(t=0;t<<ht<i;t++)e.memory_map_read8[t]=e.memory_map_write8[t]=void 0,e.memory_map_read32[t]=e.memory_map_write32[t]=void 0;this.mmap_register(i,4294967296-i,function(s){return E("Read from unmapped memory space, addr="+L(s>>>0,8),ft),255},function(s,a){E("Write to unmapped memory space, addr="+L(s>>>0,8)+" value="+L(a,2),ft)},function(s){return E("Read from unmapped memory space, addr="+L(s>>>0,8),ft),-1},function(s,a){E("Write to unmapped memory space, addr="+L(s>>>0,8)+" value="+L(a>>>0,8),ft)})}Be.prototype.create_empty_entry=function(){return{read8:this.empty_port_read8,read16:this.empty_port_read16,read32:this.empty_port_read32,write8:this.empty_port_write,write16:this.empty_port_write,write32:this.empty_port_write,device:void 0}};Be.prototype.empty_port_read8=function(){return 255};Be.prototype.empty_port_read16=function(){return 65535};Be.prototype.empty_port_read32=function(){return-1};Be.prototype.empty_port_write=function(e){};Be.prototype.register_read=function(e,t,i,s,a){i&&(this.ports[e].read8=i),s&&(this.ports[e].read16=s),a&&(this.ports[e].read32=a),this.ports[e].device=t};Be.prototype.register_write=function(e,t,i,s,a){i&&(this.ports[e].write8=i),s&&(this.ports[e].write16=s),a&&(this.ports[e].write32=a),this.ports[e].device=t};Be.prototype.register_read_consecutive=function(e,t,i,s,a,r){function u(){return i.call(this)|s.call(this)<<8}function o(){return a.call(this)|r.call(this)<<8}function l(){return i.call(this)|s.call(this)<<8|a.call(this)<<16|r.call(this)<<24}a&&r?(this.register_read(e,t,i,u,l),this.register_read(e+1,t,s),this.register_read(e+2,t,a,o),this.register_read(e+3,t,r)):(this.register_read(e,t,i,u),this.register_read(e+1,t,s))};Be.prototype.register_write_consecutive=function(e,t,i,s,a,r){function u(f){i.call(this,f&255),s.call(this,f>>8&255)}function o(f){a.call(this,f&255),r.call(this,f>>8&255)}function l(f){i.call(this,f&255),s.call(this,f>>8&255),a.call(this,f>>16&255),r.call(this,f>>>24)}a&&r?(this.register_write(e,t,i,u,l),this.register_write(e+1,t,s),this.register_write(e+2,t,a,o),this.register_write(e+3,t,r)):(this.register_write(e,t,i,u),this.register_write(e+1,t,s))};Be.prototype.mmap_read32_shim=function(e){var t=this.cpu.memory_map_read8[e>>>ht];return t(e)|t(e+1)<<8|t(e+2)<<16|t(e+3)<<24};Be.prototype.mmap_write32_shim=function(e,t){var i=this.cpu.memory_map_write8[e>>>ht];i(e,t&255),i(e+1,t>>8&255),i(e+2,t>>16&255),i(e+3,t>>>24)};Be.prototype.mmap_register=function(e,t,i,s,a,r){for(E("mmap_register addr="+L(e>>>0,8)+" size="+L(t,8),ft),a||(a=this.mmap_read32_shim.bind(this)),r||(r=this.mmap_write32_shim.bind(this)),e>>>=ht;0<t;e++)this.cpu.memory_map_read8[e]=i,this.cpu.memory_map_write8[e]=s,this.cpu.memory_map_read32[e]=a,this.cpu.memory_map_write32[e]=r,t-=Nr};Be.prototype.port_write8=function(e,t){var i=this.ports[e];return(i.write8===this.empty_port_write||mi)&&E("write8 port #"+L(e,4)+" <- "+L(t,2)+this.get_port_description(e),ft),i.write8.call(i.device,t)};Be.prototype.port_write16=function(e,t){var i=this.ports[e];return(i.write16===this.empty_port_write||mi)&&E("write16 port #"+L(e,4)+" <- "+L(t,4)+this.get_port_description(e),ft),i.write16.call(i.device,t)};Be.prototype.port_write32=function(e,t){var i=this.ports[e];return(i.write32===this.empty_port_write||mi)&&E("write32 port #"+L(e,4)+" <- "+L(t>>>0,8)+this.get_port_description(e),ft),i.write32.call(i.device,t)};Be.prototype.port_read8=function(e){var t=this.ports[e];return(t.read8===this.empty_port_read8||mi)&&E("read8 port  #"+L(e,4)+this.get_port_description(e),ft),t=t.read8.call(t.device),256>t,""+L(e),t};Be.prototype.port_read16=function(e){var t=this.ports[e];return(t.read16===this.empty_port_read16||mi)&&E("read16 port  #"+L(e,4)+this.get_port_description(e),ft),t=t.read16.call(t.device),65536>t&&0<=t,""+L(e),t};Be.prototype.port_read32=function(e){var t=this.ports[e];return(t.read32===this.empty_port_read32||mi)&&E("read32 port  #"+L(e,4)+this.get_port_description(e),ft),e=t.read32.call(t.device),e};var pn={4:"PORT_DMA_ADDR_2",5:"PORT_DMA_CNT_2",10:"PORT_DMA1_MASK_REG",11:"PORT_DMA1_MODE_REG",12:"PORT_DMA1_CLEAR_FF_REG",13:"PORT_DMA1_MASTER_CLEAR",32:"PORT_PIC1_CMD",33:"PORT_PIC1_DATA",64:"PORT_PIT_COUNTER0",65:"PORT_PIT_COUNTER1",66:"PORT_PIT_COUNTER2",67:"PORT_PIT_MODE",96:"PORT_PS2_DATA",97:"PORT_PS2_CTRLB",100:"PORT_PS2_STATUS",112:"PORT_CMOS_INDEX",113:"PORT_CMOS_DATA",128:"PORT_DIAG",129:"PORT_DMA_PAGE_2",146:"PORT_A20",160:"PORT_PIC2_CMD",161:"PORT_PIC2_DATA",178:"PORT_SMI_CMD",179:"PORT_SMI_STATUS",212:"PORT_DMA2_MASK_REG",214:"PORT_DMA2_MODE_REG",218:"PORT_DMA2_MASTER_CLEAR",240:"PORT_MATH_CLEAR",368:"PORT_ATA2_CMD_BASE",496:"PORT_ATA1_CMD_BASE",632:"PORT_LPT2",744:"PORT_SERIAL4",760:"PORT_SERIAL2",884:"PORT_ATA2_CTRL_BASE",888:"PORT_LPT1",1e3:"PORT_SERIAL3",1008:"PORT_FD_BASE",1010:"PORT_FD_DOR",1012:"PORT_FD_STATUS",1013:"PORT_FD_DATA",1014:"PORT_HD_DATA",1015:"PORT_FD_DIR",1016:"PORT_SERIAL1",3320:"PORT_PCI_CMD",3321:"PORT_PCI_REBOOT",3324:"PORT_PCI_DATA",1026:"PORT_BIOS_DEBUG",1296:"PORT_QEMU_CFG_CTL",1297:"PORT_QEMU_CFG_DATA",45056:"PORT_ACPI_PM_BASE",45312:"PORT_SMB_BASE",35072:"PORT_BIOS_APM"};Be.prototype.get_port_description=function(e){return pn[e]?"  ("+pn[e]+")":""};function be(e,t){this.stopping=this.running=!1,this.tick_counter=0,this.worker=null,this.cpu=new ue(e,t,()=>{this.idle&&this.next_tick(0)}),this.bus=e,e.register("cpu-init",this.init,this),e.register("cpu-run",this.run,this),e.register("cpu-stop",this.stop,this),e.register("cpu-restart",this.restart,this),this.register_yield()}be.prototype.run=function(){this.stopping=!1,this.running||(this.running=!0,this.bus.send("emulator-started")),this.next_tick(0)};be.prototype.do_tick=function(){if(this.stopping||!this.running)this.stopping=this.running=!1,this.bus.send("emulator-stopped");else{this.idle=!1;var e=this.cpu.main_run();this.next_tick(e)}};be.prototype.next_tick=function(e){const t=++this.tick_counter;this.idle=!0,this.yield(e,t)};be.prototype.yield_callback=function(e){e===this.tick_counter&&this.do_tick()};be.prototype.stop=function(){this.running&&(this.stopping=!0)};be.prototype.destroy=function(){this.unregister_yield()};be.prototype.restart=function(){this.cpu.reset_cpu(),this.cpu.load_bios()};be.prototype.init=function(e){this.cpu.init(e,this.bus),this.bus.send("emulator-ready")};if(typeof process<"u")be.prototype.yield=function(e,t){1>e?global.setImmediate(i=>this.yield_callback(i),t):setTimeout(i=>this.yield_callback(i),e,t)},be.prototype.register_yield=function(){},be.prototype.unregister_yield=function(){};else if(typeof Worker<"u"){let e=function(){globalThis.onmessage=function(t){const i=t.data.t;1>i?postMessage(t.data.tick):setTimeout(()=>postMessage(t.data.tick),i)}};var a=e;be.prototype.register_yield=function(){const t=URL.createObjectURL(new Blob(["("+e.toString()+")()"],{type:"text/javascript"}));this.worker=new Worker(t),this.worker.onmessage=i=>this.yield_callback(i.data),URL.revokeObjectURL(t)},be.prototype.yield=function(t,i){this.worker.postMessage({t,tick:i})},be.prototype.unregister_yield=function(){this.worker.terminate(),this.worker=null}}else be.prototype.yield=function(e){setTimeout(()=>{this.do_tick()},e)},be.prototype.register_yield=function(){},be.prototype.unregister_yield=function(){};be.prototype.save_state=function(){return this.cpu.save_state()};be.prototype.restore_state=function(e){return this.cpu.restore_state(e)};if(typeof performance=="object"&&performance.now)be.microtick=performance.now.bind(performance);else if(typeof require=="function"){const{performance:e}=require("perf_hooks");be.microtick=e.now.bind(e)}else be.microtick=typeof process=="object"&&process.hrtime?function(){var e=process.hrtime();return 1e3*e[0]+e[1]/1e6}:Date.now;var Ce=Ce||{};Ce.exportSymbol=function(){};Ce.exportProperty=function(){};var V=V||{};V.pads=function(e,t){return(e||e===0?e+"":"").padEnd(t," ")};V.pad0=function(e,t){return(e||e===0?e+"":"").padStart(t,"0")};V.zeros=function(e){return Array(e).fill(0)};V.range=function(e){return Array.from(Array(e).keys())};V.view=function(e,t,i,s){return new Proxy({},{get:function(a,r,u){return a=new e(t.buffer,i,s),u=a[r],typeof u=="function"?u.bind(a):u},set:function(a,r,u,o){return new e(t.buffer,i,s)[r]=u,!0}})};function L(e,t){return e=e?e.toString(16):"","0x"+V.pad0(e.toUpperCase(),t||1)}if(typeof crypto<"u"&&crypto.getRandomValues){let e=new Int32Array(1);V.get_rand_int=function(){return crypto.getRandomValues(e),e[0]}}else if(typeof require<"u"){const e=require("crypto");V.get_rand_int=function(){return e.randomBytes(4).readInt32LE(0)}}function lt(e){this.buffer=e,this.byteLength=e.byteLength,this.onprogress=this.onload=void 0}lt.prototype.load=function(){this.onload&&this.onload({buffer:this.buffer})};lt.prototype.get=function(e,t,i){e+t<=this.byteLength,i(new Uint8Array(this.buffer,e,t))};lt.prototype.set=function(e,t,i){e+t.byteLength<=this.byteLength,new Uint8Array(this.buffer,e,t.byteLength).set(t),i()};lt.prototype.get_buffer=function(e){e(this.buffer)};lt.prototype.get_state=function(){const e=[];return e[0]=this.byteLength,e[1]=new Uint8Array(this.buffer),e};lt.prototype.set_state=function(e){this.byteLength=e[0],this.buffer=e[1].slice().buffer};(function(){if(typeof Math.clz32=="function")V.int_log2_byte=function(s){return 31-Math.clz32(s)},V.int_log2=function(s){return 31-Math.clz32(s)};else{for(var e=new Int8Array(256),t=0,i=-2;256>t;t++)t&t-1||i++,e[t]=i;V.int_log2_byte=function(s){return e[s]},V.int_log2=function(s){s>>>=0;var a=s>>>16;if(a){var r=a>>>8;return r?24+e[r]:16+e[a]}return(r=s>>>8)?8+e[r]:e[s]}}})();function _i(e){var t=new Uint8Array(e),i,s;this.length=0,this.push=function(a){this.length!==e&&this.length++,t[s]=a,s=s+1&e-1},this.shift=function(){if(this.length){var a=t[i];return i=i+1&e-1,this.length--,a}return-1},this.peek=function(){return this.length?t[i]:-1},this.clear=function(){this.length=s=i=0},this.clear()}function ti(e){this.size=e,this.data=new Float32Array(e),this.length=this.end=this.start=0}ti.prototype.push=function(e){this.length===this.size?this.start=this.start+1&this.size-1:this.length++,this.data[this.end]=e,this.end=this.end+1&this.size-1};ti.prototype.shift=function(){if(this.length){var e=this.data[this.start];return this.start=this.start+1&this.size-1,this.length--,e}};ti.prototype.shift_block=function(e){var t=new Float32Array(e);e>this.length&&(e=this.length);var i=this.start+e,s=this.data.subarray(this.start,i);return t.set(s),i>=this.size&&(i-=this.size,t.set(this.data.subarray(0,i),s.length)),this.start=i,this.length-=e,t};ti.prototype.peek=function(){if(this.length)return this.data[this.start]};ti.prototype.clear=function(){this.length=this.end=this.start=0};V.Bitmap=function(e){typeof e=="number"?this.view=new Uint8Array(e+7>>3):e instanceof ArrayBuffer?this.view=new Uint8Array(e):console.assert(!1)};V.Bitmap.prototype.set=function(e,t){const i=e>>3;e=1<<(e&7),this.view[i]=t?this.view[i]|e:this.view[i]&~e};V.Bitmap.prototype.get=function(e){return this.view[e>>3]>>(e&7)&1};V.Bitmap.prototype.get_buffer=function(){return this.view.buffer};var Sa=2048,Ca=512;function Ze(e,t,i,s,a,r){this.master=new ge(this,e,t,s,a,0,r),this.slave=new ge(this,e,i,!1,a,1,r),this.current_interface=this.master,this.cpu=e,a===0?(this.ata_port=496,this.irq=14,this.pci_id=240):a===1?(this.ata_port=368,this.irq=15,this.pci_id=248):void 0,this.ata_port_high=this.ata_port|516,this.master_port=46080,this.pci_space=[134,128,16,112,5,0,160,2,0,128,1,1,0,0,0,0,this.ata_port&255|1,this.ata_port>>8,0,0,this.ata_port_high&255|1,this.ata_port_high>>8,0,0,0,0,0,0,0,0,0,0,this.master_port&255|1,this.master_port>>8,0,0,0,0,0,0,0,0,0,0,67,16,212,130,0,0,0,0,0,0,0,0,0,0,0,0,this.irq,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.pci_bars=[{size:8},{size:4},void 0,void 0,{size:16}],this.name="ide"+a,this.device_control=2,e.io.register_read(this.ata_port|7,this,function(){return E("lower irq",Z),this.cpu.device_lower_irq(this.irq),this.read_status()}),e.io.register_read(this.ata_port_high|2,this,this.read_status),e.io.register_write(this.ata_port_high|2,this,this.write_control),e.io.register_read(this.ata_port|0,this,function(){return this.current_interface.read_data(1)},function(){return this.current_interface.read_data(2)},function(){return this.current_interface.read_data(4)}),e.io.register_read(this.ata_port|1,this,function(){return E("Read error: "+L(this.current_interface.error&255)+" slave="+(this.current_interface===this.slave),Z),this.current_interface.error&255}),e.io.register_read(this.ata_port|2,this,function(){return E("Read bytecount: "+L(this.current_interface.bytecount&255),Z),this.current_interface.bytecount&255}),e.io.register_read(this.ata_port|3,this,function(){return E("Read sector: "+L(this.current_interface.sector&255),Z),this.current_interface.sector&255}),e.io.register_read(this.ata_port|4,this,function(){return E("Read 1F4: "+L(this.current_interface.cylinder_low&255),Z),this.current_interface.cylinder_low&255}),e.io.register_read(this.ata_port|5,this,function(){return E("Read 1F5: "+L(this.current_interface.cylinder_high&255),Z),this.current_interface.cylinder_high&255}),e.io.register_read(this.ata_port|6,this,function(){return E("Read 1F6",Z),this.current_interface.drive_head&255}),e.io.register_write(this.ata_port|0,this,function(u){this.current_interface.write_data_port8(u)},function(u){this.current_interface.write_data_port16(u)},function(u){this.current_interface.write_data_port32(u)}),e.io.register_write(this.ata_port|1,this,function(u){E("1F1/lba_count: "+L(u),Z),this.master.lba_count=(this.master.lba_count<<8|u)&65535,this.slave.lba_count=(this.slave.lba_count<<8|u)&65535}),e.io.register_write(this.ata_port|2,this,function(u){E("1F2/bytecount: "+L(u),Z),this.master.bytecount=(this.master.bytecount<<8|u)&65535,this.slave.bytecount=(this.slave.bytecount<<8|u)&65535}),e.io.register_write(this.ata_port|3,this,function(u){E("1F3/sector: "+L(u),Z),this.master.sector=(this.master.sector<<8|u)&65535,this.slave.sector=(this.slave.sector<<8|u)&65535}),e.io.register_write(this.ata_port|4,this,function(u){E("1F4/sector low: "+L(u),Z),this.master.cylinder_low=(this.master.cylinder_low<<8|u)&65535,this.slave.cylinder_low=(this.slave.cylinder_low<<8|u)&65535}),e.io.register_write(this.ata_port|5,this,function(u){E("1F5/sector high: "+L(u),Z),this.master.cylinder_high=(this.master.cylinder_high<<8|u)&65535,this.slave.cylinder_high=(this.slave.cylinder_high<<8|u)&65535}),e.io.register_write(this.ata_port|6,this,function(u){var o=u&16;E("1F6/drive: "+L(u,2),Z),o?(E("Slave",Z),this.current_interface=this.slave):this.current_interface=this.master,this.master.drive_head=u,this.slave.drive_head=u,this.master.is_lba=this.slave.is_lba=u>>6&1,this.master.head=this.slave.head=u&15}),this.dma_command=this.dma_status=this.prdt_addr=0,e.io.register_write(this.ata_port|7,this,function(u){E("lower irq",Z),this.cpu.device_lower_irq(this.irq),this.current_interface.ata_command(u)}),e.io.register_read(this.master_port|4,this,void 0,void 0,this.dma_read_addr),e.io.register_write(this.master_port|4,this,void 0,void 0,this.dma_set_addr),e.io.register_read(this.master_port,this,this.dma_read_command8,void 0,this.dma_read_command),e.io.register_write(this.master_port,this,this.dma_write_command8,void 0,this.dma_write_command),e.io.register_read(this.master_port|2,this,this.dma_read_status),e.io.register_write(this.master_port|2,this,this.dma_write_status),e.io.register_read(this.master_port|8,this,function(){return E("DMA read 0x8",Z),0}),e.io.register_read(this.master_port|10,this,function(){return E("DMA read 0xA",Z),0}),e.devices.pci.register_device(this)}Ze.prototype.read_status=function(){if(this.current_interface.buffer){var e=this.current_interface.status;return E("ATA read status: "+L(e,2),Z),e}return 0};Ze.prototype.write_control=function(e){E("set device control: "+L(e,2)+" interrupts "+(e&2?"disabled":"enabled"),Z),e&4&&(E("Reset via control port",Z),this.cpu.device_lower_irq(this.irq),this.master.device_reset(),this.slave.device_reset()),this.device_control=e};Ze.prototype.dma_read_addr=function(){return E("dma get address: "+L(this.prdt_addr,8),Z),this.prdt_addr};Ze.prototype.dma_set_addr=function(e){E("dma set address: "+L(e,8),Z),this.prdt_addr=e};Ze.prototype.dma_read_status=function(){return E("DMA read status: "+L(this.dma_status),Z),this.dma_status};Ze.prototype.dma_write_status=function(e){E("DMA set status: "+L(e),Z),this.dma_status&=~(e&6)};Ze.prototype.dma_read_command=function(){return this.dma_read_command8()|this.dma_read_status()<<16};Ze.prototype.dma_read_command8=function(){return E("DMA read command: "+L(this.dma_command),Z),this.dma_command};Ze.prototype.dma_write_command=function(e){E("DMA write command: "+L(e),Z),this.dma_write_command8(e&255),this.dma_write_status(e>>16&255)};Ze.prototype.dma_write_command8=function(e){E("DMA write command8: "+L(e),Z);let t=this.dma_command;if(this.dma_command=e&9,(t&1)!==(e&1))if(!(e&1))this.dma_status&=-2;else switch(this.dma_status|=1,this.current_interface.current_command){case 37:case 200:this.current_interface.do_ata_read_sectors_dma();break;case 202:case 53:this.current_interface.do_ata_write_sectors_dma();break;case 160:this.current_interface.do_atapi_dma();break;default:E("Spurious dma command write, current command: "+L(this.current_interface.current_command),Z)}};Ze.prototype.push_irq=function(){!(this.device_control&2)&&(E("push irq",Z),this.dma_status|=4,this.cpu.device_raise_irq(this.irq))};Ze.prototype.get_state=function(){var e=[];return e[0]=this.master,e[1]=this.slave,e[2]=this.ata_port,e[3]=this.irq,e[4]=this.pci_id,e[5]=this.ata_port_high,e[6]=this.master_port,e[7]=this.name,e[8]=this.device_control,e[9]=this.prdt_addr,e[10]=this.dma_status,e[11]=this.current_interface===this.master,e[12]=this.dma_command,e};Ze.prototype.set_state=function(e){this.master.set_state(e[0]),this.slave.set_state(e[1]),this.ata_port=e[2],this.irq=e[3],this.pci_id=e[4],this.ata_port_high=e[5],this.master_port=e[6],this.name=e[7],this.device_control=e[8],this.prdt_addr=e[9],this.dma_status=e[10],this.current_interface=e[11]?this.master:this.slave,this.dma_command=e[12]};function ge(e,t,i,s,a,r,u){this.device=e,this.bus=u,this.nr=a,this.cpu=t,this.buffer=i,this.sector_size=s?Sa:Ca,this.is_atapi=s,this.cylinder_count=this.sectors_per_track=this.head_count=this.sector_count=0,this.buffer&&(this.sector_count=this.buffer.byteLength/this.sector_size,this.sector_count!==(this.sector_count|0)&&(E("Warning: Disk size not aligned with sector size",Z),this.sector_count=Math.ceil(this.sector_count)),s?(this.head_count=1,this.sectors_per_track=0):(this.head_count=16,this.sectors_per_track=63),this.cylinder_count=this.sector_count/this.head_count/this.sectors_per_track,this.cylinder_count!==(this.cylinder_count|0)&&(E("Warning: Rounding up cylinder count. Choose different head number",Z),this.cylinder_count=Math.floor(this.cylinder_count)),e=t.devices.rtc,e.cmos_write(Cn,e.cmos_read(Cn)|1<<4*this.nr),e.cmos_write(Sn,e.cmos_read(Sn)&15|240),t=Ha,e.cmos_write(t+0,this.cylinder_count&255),e.cmos_write(t+1,this.cylinder_count>>8&255),e.cmos_write(t+2,this.head_count&255),e.cmos_write(t+3,255),e.cmos_write(t+4,255),e.cmos_write(t+5,200),e.cmos_write(t+6,this.cylinder_count&255),e.cmos_write(t+7,this.cylinder_count>>8&255),e.cmos_write(t+8,this.sectors_per_track&255)),this.stats={sectors_read:0,sectors_written:0,bytes_read:0,bytes_written:0,loading:!1},this.buffer=i,this.drive_head=this.head=this.cylinder_high=this.cylinder_low=this.lba_count=this.sector=this.bytecount=this.is_lba=0,this.status=80,this.sectors_per_drq=128,this.data_pointer=this.error=0,this.data=new Uint8Array(65536),this.data16=new Uint16Array(this.data.buffer),this.data32=new Int32Array(this.data.buffer),this.data_end=this.data_length=0,this.current_atapi_command=this.current_command=-1,this.last_io_id=this.write_dest=0,this.in_progress_io_ids=new Set,this.cancelled_io_ids=new Set,Object.seal(this)}ge.prototype.device_reset=function(){this.is_atapi?(this.status=0,this.sector=this.error=this.bytecount=1,this.cylinder_low=20,this.cylinder_high=235):(this.status=81,this.sector=this.error=this.bytecount=1,this.cylinder_high=this.cylinder_low=0),this.cancel_io_operations()};ge.prototype.push_irq=function(){this.device.push_irq()};ge.prototype.ata_command=function(e){if(E("ATA Command: "+L(e)+" slave="+(this.drive_head>>4&1),Z),this.buffer)switch(this.current_command=e,this.error=0,e){case 8:E("ATA device reset",Z),this.data_length=this.data_end=this.data_pointer=0,this.device_reset(),this.push_irq();break;case 16:this.status=80,this.cylinder_low=0,this.push_irq();break;case 248:this.status=80,e=this.sector_count-1,this.sector=e&255,this.cylinder_low=e>>8&255,this.cylinder_high=e>>16&255,this.drive_head=this.drive_head&240|e>>24&15,this.push_irq();break;case 39:this.status=80,e=this.sector_count-1,this.sector=e&255,this.cylinder_low=e>>8&255,this.cylinder_high=e>>16&255,this.sector|=e>>24<<8&65280,this.push_irq();break;case 32:case 36:case 41:case 196:this.ata_read_sectors(e);break;case 48:case 52:case 57:case 197:this.ata_write_sectors(e);break;case 144:this.push_irq(),this.error=257,this.status=80;break;case 145:this.status=80,this.push_irq();break;case 160:this.is_atapi&&(this.status=88,this.data_allocate(12),this.data_end=12,this.bytecount=1,this.push_irq());break;case 161:E("ATA identify packet device",Z),this.is_atapi?(this.create_identify_packet(),this.status=88,this.cylinder_low=20,this.cylinder_high=235):this.status=65,this.push_irq();break;case 198:E("Logical sectors per DRQ Block: "+L(this.bytecount&255),Z),this.sectors_per_drq=this.bytecount&255,this.status=80,this.push_irq();break;case 37:case 200:this.ata_read_sectors_dma(e);break;case 53:case 202:this.ata_write_sectors_dma(e);break;case 64:E("read verify sectors",Z),this.status=80,this.push_irq();break;case 218:E("Unimplemented: get media status",Z),this.status=65,this.error=4,this.push_irq();break;case 224:E("ATA standby immediate",Z),this.status=80,this.push_irq();break;case 225:E("ATA idle immediate",Z),this.status=80,this.push_irq();break;case 231:E("ATA flush cache",Z),this.status=80,this.push_irq();break;case 236:if(E("ATA identify device",Z),this.is_atapi){this.status=65,this.error=4,this.push_irq();break}this.create_identify_packet(),this.status=88,this.push_irq();break;case 234:E("flush cache ext",Z),this.status=80,this.push_irq();break;case 239:E("set features: "+L(this.bytecount&255),Z),this.status=80,this.push_irq();break;case 222:this.status=80,this.push_irq();break;case 245:E("security freeze lock",Z),this.status=80,this.push_irq();break;case 249:E("Unimplemented: set max address",Z),this.status=65,this.error=4;break;default:""+L(e),this.status=65,this.error=4}else E("abort: No buffer",Z),this.error=4,this.status=65,this.push_irq()};ge.prototype.atapi_handle=function(){switch(E("ATAPI Command: "+L(this.data[0])+" slave="+(this.drive_head>>4&1),Z),this.data_pointer=0,this.current_atapi_command=this.data[0],this.current_atapi_command){case 0:E("test unit ready",Z),this.data_allocate(0),this.data_end=this.data_length,this.status=80;break;case 3:this.data_allocate(this.data[4]),this.data_end=this.data_length,this.status=88,this.data[0]=240,this.data[2]=5,this.data[7]=8;break;case 18:var e=this.data[4];this.status=88,E("inquiry: "+L(this.data[1],2)+" length="+e,Z),this.data.set([5,128,1,49,31,0,0,0,83,79,78,89,32,32,32,32,67,68,45,82,79,77,32,67,68,85,45,49,48,48,48,32,49,46,49,97]),this.data_end=this.data_length=Math.min(36,e);break;case 26:this.data_allocate(this.data[4]),this.data_end=this.data_length,this.status=88;break;case 30:this.data_allocate(0),this.data_end=this.data_length,this.status=80;break;case 37:e=this.sector_count-1,this.data_set(new Uint8Array([e>>24&255,e>>16&255,e>>8&255,e&255,0,0,this.sector_size>>8&255,this.sector_size&255])),this.data_end=this.data_length,this.status=88;break;case 40:this.lba_count&1?this.atapi_read_dma(this.data):this.atapi_read(this.data);break;case 66:e=this.data[8],this.data_allocate(Math.min(8,e)),this.data_end=this.data_length,E("read q subcode: length="+e,Z),this.status=88;break;case 67:e=this.data[8]|this.data[7]<<8;var t=this.data[9]>>6;this.data_allocate(e),this.data_end=this.data_length,E("read toc: "+L(t,2)+" length="+e+" "+(this.data[1]&2)+" "+L(this.data[6]),Z),t===0?(e=this.sector_count,this.data.set(new Uint8Array([0,18,1,1,0,20,1,0,0,0,0,0,0,22,170,0,e>>24,e>>16&255,e>>8&255,e&255]))):t===1?this.data.set(new Uint8Array([0,10,1,1,0,0,0,0,0,0,0,0])):void 0,this.status=88;break;case 70:e=this.data[8]|this.data[7]<<8,e=Math.min(e,32),this.data_allocate(e),this.data_end=this.data_length,this.data[0]=e-4>>24&255,this.data[1]=e-4>>16&255,this.data[2]=e-4>>8&255,this.data[3]=e-4&255,this.data[6]=8,this.data[10]=3,this.status=88;break;case 81:this.data_allocate(0),this.data_end=this.data_length,this.status=80;break;case 82:E("Unimplemented ATAPI command: "+L(this.data[0]),Z),this.status=81,this.data_length=0,this.error=80;break;case 90:e=this.data[8]|this.data[7]<<8,t=this.data[2],E("mode sense: "+L(t)+" length="+e,Z),t===42&&this.data_allocate(Math.min(30,e)),this.data_end=this.data_length,this.status=88;break;case 189:this.data_allocate(this.data[9]|this.data[8]<<8),this.data_end=this.data_length,this.data[5]=1,this.status=88;break;case 74:this.status=81,this.data_length=0,this.error=80,E("Unimplemented ATAPI command: "+L(this.data[0]),Z);break;case 190:E("Unimplemented ATAPI command: "+L(this.data[0]),Z),this.data_allocate(0),this.data_end=this.data_length,this.status=80;break;default:this.status=81,this.data_length=0,this.error=80,E("Unimplemented ATAPI command: "+L(this.data[0]),Z)}this.bytecount=this.bytecount&-8|2,!(this.status&128)&&this.push_irq(),!(this.status&128)&&this.data_length===0&&(this.bytecount|=1,this.status&=-9)};ge.prototype.do_write=function(){this.status=80,this.data_length<=this.data.length;var e=this.data.subarray(0,this.data_length);this.data_length%512,this.ata_advance(this.current_command,this.data_length/512),this.push_irq(),this.buffer.set(this.write_dest,e,function(){}),this.report_write(this.data_length)};ge.prototype.atapi_read=function(e){var t=e[2]<<24|e[3]<<16|e[4]<<8|e[5],i=e[7]<<8|e[8];e=e[1];var s=i*this.sector_size,a=t*this.sector_size;E("CD read lba="+L(t)+" lbacount="+L(i)+" bytecount="+L(s)+" flags="+L(e),Z),this.data_length=0;var r=this.cylinder_high<<8&65280|this.cylinder_low&255;E(L(this.cylinder_high,2)+" "+L(this.cylinder_low,2),Z),this.cylinder_low=this.cylinder_high=0,r===65535&&r--,r>s&&(r=s),a>=this.buffer.byteLength?(""+L(a+s)+L(this.buffer.byteLength),this.status=255,this.push_irq()):s===0?(this.status=80,this.data_pointer=0):(s=Math.min(s,this.buffer.byteLength-a),this.status=208,this.report_read_start(),this.read_buffer(a,s,u=>{E("cd read: data arrived",Z),this.data_set(u),this.status=88,this.bytecount=this.bytecount&-8|2,this.push_irq(),this.data_end=r&=-4,this.data_end>this.data_length&&(this.data_end=this.data_length),this.cylinder_low=this.data_end&255,this.cylinder_high=this.data_end>>8&255,this.report_read_end(s)}))};ge.prototype.atapi_read_dma=function(e){var t=e[2]<<24|e[3]<<16|e[4]<<8|e[5],i=e[7]<<8|e[8];e=e[1];var s=i*this.sector_size,a=t*this.sector_size;E("CD read DMA lba="+L(t)+" lbacount="+L(i)+" bytecount="+L(s)+" flags="+L(e),Z),a>=this.buffer.byteLength?(""+L(a+s)+L(this.buffer.byteLength),this.status=255,this.push_irq()):(this.status=208,this.report_read_start(),this.read_buffer(a,s,r=>{E("atapi_read_dma: Data arrived"),this.report_read_end(s),this.status=88,this.bytecount=this.bytecount&-8|2,this.data_set(r),this.do_atapi_dma()}))};ge.prototype.do_atapi_dma=function(){if(!(this.device.dma_status&1))E("do_atapi_dma: Status not set",Z);else if(!(this.status&8))E("do_atapi_dma: DRQ not set",Z);else{E("atapi dma transfer len="+this.data_length,Z);var e=this.device.prdt_addr,t=0,i=this.data;do{var s=this.cpu.read32s(e),a=this.cpu.read16(e+4),r=this.cpu.read8(e+7)&128;if(a||(a=65536),E("dma read dest="+L(s)+" count="+L(a)+" datalen="+L(this.data_length),Z),this.cpu.write_blob(i.subarray(t,Math.min(t+a,this.data_length)),s),t+=a,e+=8,t>=this.data_length&&!r){E("leave early end="+ +r+" offset="+L(t)+" data_length="+L(this.data_length)+" cmd="+L(this.current_command),Z);break}}while(!r);E("end offset="+t,Z),this.status=80,this.device.dma_status&=-2,this.bytecount=this.bytecount&-8|3,this.push_irq()}};ge.prototype.read_data=function(e){if(this.data_pointer<this.data_end){this.data_pointer+e-1<this.data_end,this.data_pointer%e,L(this.data_pointer)+""+e;var t=e===1?this.data[this.data_pointer]:e===2?this.data16[this.data_pointer>>>1]:this.data32[this.data_pointer>>>2];return this.data_pointer+=e,!(this.data_pointer&(this.data_end&4095?255:4095))&&E("Read 1F0: "+L(this.data[this.data_pointer],2)+" cur="+L(this.data_pointer)+" cnt="+L(this.data_length),Z),this.data_pointer>=this.data_end&&this.read_end(),t}return E("Read 1F0: empty",Z),this.data_pointer+=e,0};ge.prototype.read_end=function(){if(E("read_end cmd="+L(this.current_command)+" data_pointer="+L(this.data_pointer)+" end="+L(this.data_end)+" length="+L(this.data_length),Z),this.current_command===160)if(this.data_end===this.data_length)this.status=80,this.bytecount=this.bytecount&-8|3,this.push_irq();else{this.status=88,this.bytecount=this.bytecount&-8|2,this.push_irq();var e=this.cylinder_high<<8&65280|this.cylinder_low&255;this.data_end+e>this.data_length?(this.cylinder_low=this.data_length-this.data_end&255,this.cylinder_high=this.data_length-this.data_end>>8&255,this.data_end=this.data_length):this.data_end+=e,E("data_end="+L(this.data_end),Z)}else this.error=0,this.data_pointer>=this.data_length?this.status=80:(this.current_command===196||this.current_command===41?(e=Math.min(this.sectors_per_drq,(this.data_length-this.data_end)/512),void 0):(this.current_command===32||this.current_command,e=1),this.ata_advance(this.current_command,e),this.data_end+=512*e,this.status=88),this.push_irq()};ge.prototype.write_data_port=function(e,t){this.data_pointer%t,this.data_pointer>=this.data_end?E("Redundant write to data port: "+L(e)+" count="+L(this.data_end)+" cur="+L(this.data_pointer),Z):((!(this.data_pointer+t&(this.data_end&4095?255:4095))||20>this.data_end)&&E("Data port: "+L(e>>>0)+" count="+L(this.data_end)+" cur="+L(this.data_pointer),Z),t===1?this.data[this.data_pointer++]=e:t===2?(this.data16[this.data_pointer>>>1]=e,this.data_pointer+=2):(this.data32[this.data_pointer>>>2]=e,this.data_pointer+=4),this.data_pointer<=this.data_end,this.data_pointer===this.data_end&&this.write_end())};ge.prototype.write_data_port8=function(e){this.write_data_port(e,1)};ge.prototype.write_data_port16=function(e){this.write_data_port(e,2)};ge.prototype.write_data_port32=function(e){this.write_data_port(e,4)};ge.prototype.write_end=function(){this.current_command===160?this.atapi_handle():(E("write_end data_pointer="+L(this.data_pointer)+" data_length="+L(this.data_length),Z),this.data_pointer>=this.data_length?this.do_write():(this.current_command===48||this.current_command===52||this.current_command,""+L(this.current_command),this.status=88,this.data_end+=512,this.push_irq()))};ge.prototype.ata_advance=function(e,t){E("Advance sectors="+t+" old_bytecount="+this.bytecount,Z),this.bytecount-=t,e===36||e===41||e===52||e===57||e===37||e===53?(e=t+this.get_lba48(),this.sector=e&255|e>>16&65280,this.cylinder_low=e>>8&255,this.cylinder_high=e>>16&255):this.is_lba?(e=t+this.get_lba28(),this.sector=e&255,this.cylinder_low=e>>8&255,this.cylinder_high=e>>16&255,this.head=this.head&-16|e&15):(e=t+this.get_chs(),t=e/(this.head_count*this.sectors_per_track)|0,this.cylinder_low=t&255,this.cylinder_high=t>>8&255,this.head=(e/this.sectors_per_track|0)%this.head_count&15,this.sector=e%this.sectors_per_track+1&255,this.get_chs(),void 0)};ge.prototype.ata_read_sectors=function(e){var t=e===36||e===41,i=this.get_count(t);t=this.get_lba(t);var s=e===32||e===36,a=i*this.sector_size,r=t*this.sector_size;E("ATA read cmd="+L(e)+" mode="+(this.is_lba?"lba":"chs")+" lba="+L(t)+" lbacount="+L(i)+" bytecount="+L(a),Z),r+a>this.buffer.byteLength?(this.status=255,this.push_irq()):(this.status=192,this.report_read_start(),this.read_buffer(r,a,u=>{E("ata_read: Data arrived",Z),this.data_set(u),this.status=88,this.data_end=s?512:Math.min(a,512*this.sectors_per_drq),this.ata_advance(e,s?1:Math.min(i,this.sectors_per_track)),this.push_irq(),this.report_read_end(a)}))};ge.prototype.ata_read_sectors_dma=function(e){var t=e===37;e=this.get_count(t),t=this.get_lba(t);var i=e*this.sector_size,s=t*this.sector_size;E("ATA DMA read lba="+L(t)+" lbacount="+L(e)+" bytecount="+L(i),Z),s+i>this.buffer.byteLength?(this.status=255,this.push_irq()):(this.status=88,this.device.dma_status|=1)};ge.prototype.do_ata_read_sectors_dma=function(){var e=this.current_command===37,t=this.get_count(e);e=this.get_lba(e);var i=t*this.sector_size,s=e*this.sector_size;e<this.buffer.byteLength,this.report_read_start(),this.device.prdt_addr,this.read_buffer(s,i,a=>{E("do_ata_read_sectors_dma: Data arrived",Z);var r=this.device.prdt_addr,u=0;do{var o=this.cpu.read32s(r),l=this.cpu.read16(r+4),f=this.cpu.read8(r+7)&128;l||(l=65536,E("dma: prd count was 0",Z)),E("dma read transfer dest="+L(o)+" prd_count="+L(l),Z),this.cpu.write_blob(a.subarray(u,u+l),o),u+=l,r+=8}while(!f);this.ata_advance(this.current_command,t),this.status=80,this.device.dma_status&=-2,this.current_command=-1,this.push_irq(),this.report_read_end(i)})};ge.prototype.ata_write_sectors=function(e){var t=e===52||e===57,i=this.get_count(t);t=this.get_lba(t),e=e===48||e===52;var s=i*this.sector_size,a=t*this.sector_size;E("ATA write lba="+L(t)+" mode="+(this.is_lba?"lba":"chs")+" lbacount="+L(i)+" bytecount="+L(s),Z),a+s>this.buffer.byteLength?(this.status=255,this.push_irq()):(this.status=88,this.data_allocate_noclear(s),this.data_end=e?512:Math.min(s,512*this.sectors_per_drq),this.write_dest=a)};ge.prototype.ata_write_sectors_dma=function(e){var t=e===53;e=this.get_count(t),t=this.get_lba(t);var i=e*this.sector_size,s=t*this.sector_size;E("ATA DMA write lba="+L(t)+" lbacount="+L(e)+" bytecount="+L(i),Z),s+i>this.buffer.byteLength?(this.status=255,this.push_irq()):(this.status=88,this.device.dma_status|=1)};ge.prototype.do_ata_write_sectors_dma=function(){var e=this.current_command===53,t=this.get_count(e),i=this.get_lba(e);e=t*this.sector_size,i*=this.sector_size;var s=this.device.prdt_addr,a=0;E("prdt addr: "+L(s,8),Z);const r=new Uint8Array(e);do{var u=this.cpu.read32s(s),o=this.cpu.read16(s+4),l=this.cpu.read8(s+7)&128;o||(o=65536,E("dma: prd count was 0",Z)),E("dma write transfer dest="+L(u)+" prd_count="+L(o),Z),u=this.cpu.mem8.subarray(u,u+o),u.length,r.set(u,a),a+=o,s+=8}while(!l);r.length,this.buffer.set(i,r,()=>{E("dma write completed",Z),this.ata_advance(this.current_command,t),this.status=80,this.push_irq(),this.device.dma_status&=-2,this.current_command=-1}),this.report_write(e)};ge.prototype.get_chs=function(){var e=this.cylinder_low&255|this.cylinder_high<<8&65280,t=this.head,i=this.sector&255;return E("get_chs: c="+e+" h="+t+" s="+i,Z),(e*this.head_count+t)*this.sectors_per_track+i-1};ge.prototype.get_lba28=function(){return this.sector&255|this.cylinder_low<<8&65280|this.cylinder_high<<16&16711680|(this.head&15)<<24};ge.prototype.get_lba48=function(){return(this.sector&255|this.cylinder_low<<8&65280|this.cylinder_high<<16&16711680|this.sector>>8<<24&4278190080)>>>0};ge.prototype.get_lba=function(e){return e?this.get_lba48():this.is_lba?this.get_lba28():this.get_chs()};ge.prototype.get_count=function(e){return e?(e=this.bytecount,e===0&&(e=65536)):(e=this.bytecount&255,e===0&&(e=256)),e};ge.prototype.create_identify_packet=function(){if(this.drive_head&16)this.data_allocate(0);else{for(var e=0;512>e;e++)this.data[e]=0;e=Math.min(16383,this.cylinder_count),this.data_set([64,this.is_atapi?133:0,e,e>>8,0,0,this.head_count,this.head_count>>8,this.sectors_per_track/512,this.sectors_per_track/512>>8,0,2,this.sectors_per_track,this.sectors_per_track>>8,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,0,0,2,4,0,0,0,0,0,0,0,0,0,56,118,32,54,68,72,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,128,0,1,0,0,2,0,0,0,2,0,2,7,0,e,e>>8,this.head_count,this.head_count>>8,this.sectors_per_track,0,this.sector_count&255,this.sector_count>>8&255,this.sector_count>>16&255,this.sector_count>>24&255,0,0,this.sector_count&255,this.sector_count>>8&255,this.sector_count>>16&255,this.sector_count>>24&255,0,0,this.current_command===160?0:7,this.current_command===160?0:4,0,0,30,0,30,0,30,0,30,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,126,0,0,0,0,0,0,116,0,64,0,64,0,116,0,64,0,0,0,0,0,0,0,0,0,0,1,96,0,0,0,0,0,0,0,0,0,0,0,0,this.sector_count&255,this.sector_count>>8&255,this.sector_count>>16&255,this.sector_count>>24&255]),this.data_end=this.data_length=512}};ge.prototype.data_allocate=function(e){this.data_allocate_noclear(e);for(var t=0;t<e+3>>2;t++)this.data32[t]=0};ge.prototype.data_allocate_noclear=function(e){this.data.length<e&&(this.data=new Uint8Array(e+3&-4),this.data16=new Uint16Array(this.data.buffer),this.data32=new Int32Array(this.data.buffer)),this.data_length=e,this.data_pointer=0};ge.prototype.data_set=function(e){this.data_allocate_noclear(e.length),this.data.set(e)};ge.prototype.report_read_start=function(){this.stats.loading=!0,this.bus.send("ide-read-start")};ge.prototype.report_read_end=function(e){this.stats.loading=!1;var t=e/this.sector_size|0;this.stats.sectors_read+=t,this.stats.bytes_read+=e,this.bus.send("ide-read-end",[this.nr,e,t])};ge.prototype.report_write=function(e){var t=e/this.sector_size|0;this.stats.sectors_written+=t,this.stats.bytes_written+=e,this.bus.send("ide-write-end",[this.nr,e,t])};ge.prototype.read_buffer=function(e,t,i){const s=this.last_io_id++;this.in_progress_io_ids.add(s),this.buffer.get(e,t,a=>{this.cancelled_io_ids.delete(s)?(this.in_progress_io_ids.has(s),void 0):(this.in_progress_io_ids.delete(s),i(a))})};ge.prototype.cancel_io_operations=function(){for(const e of this.in_progress_io_ids)this.cancelled_io_ids.add(e);this.in_progress_io_ids.clear()};ge.prototype.get_state=function(){var e=[];return e[0]=this.bytecount,e[1]=this.cylinder_count,e[2]=this.cylinder_high,e[3]=this.cylinder_low,e[4]=this.data_pointer,e[5]=0,e[6]=0,e[7]=0,e[8]=0,e[9]=this.drive_head,e[10]=this.error,e[11]=this.head,e[12]=this.head_count,e[13]=this.is_atapi,e[14]=this.is_lba,e[15]=this.lba_count,e[16]=this.data,e[17]=this.data_length,e[18]=this.sector,e[19]=this.sector_count,e[20]=this.sector_size,e[21]=this.sectors_per_drq,e[22]=this.sectors_per_track,e[23]=this.status,e[24]=this.write_dest,e[25]=this.current_command,e[26]=this.data_end,e[27]=this.current_atapi_command,e[28]=this.buffer,e};ge.prototype.set_state=function(e){this.bytecount=e[0],this.cylinder_count=e[1],this.cylinder_high=e[2],this.cylinder_low=e[3],this.data_pointer=e[4],this.drive_head=e[9],this.error=e[10],this.head=e[11],this.head_count=e[12],this.is_atapi=e[13],this.is_lba=e[14],this.lba_count=e[15],this.data=e[16],this.data_length=e[17],this.sector=e[18],this.sector_count=e[19],this.sector_size=e[20],this.sectors_per_drq=e[21],this.sectors_per_track=e[22],this.status=e[23],this.write_dest=e[24],this.current_command=e[25],this.data_end=e[26],this.current_atapi_command=e[27],this.data16=new Uint16Array(this.data.buffer),this.data32=new Int32Array(this.data.buffer),this.buffer&&this.buffer.set_state(e[28])};var vn=3320,Ei=3324;function gt(e){this.pci_addr=new Uint8Array(4),this.pci_value=new Uint8Array(4),this.pci_response=new Uint8Array(4),this.pci_status=new Uint8Array(4),this.pci_addr32=new Int32Array(this.pci_addr.buffer),this.pci_value32=new Int32Array(this.pci_value.buffer),this.pci_response32=new Int32Array(this.pci_response.buffer),this.pci_status32=new Int32Array(this.pci_status.buffer),this.device_spaces=[],this.devices=[],this.cpu=e;for(var t=0;256>t;t++)this.device_spaces[t]=void 0,this.devices[t]=void 0;this.io=e.io,e.io.register_write(Ei,this,function(i){this.pci_write8(this.pci_addr32[0],i)},function(i){this.pci_write16(this.pci_addr32[0],i)},function(i){this.pci_write32(this.pci_addr32[0],i)}),e.io.register_write(Ei+1,this,function(i){this.pci_write8(this.pci_addr32[0]+1|0,i)}),e.io.register_write(Ei+2,this,function(i){this.pci_write8(this.pci_addr32[0]+2|0,i)},function(i){this.pci_write16(this.pci_addr32[0]+2|0,i)}),e.io.register_write(Ei+3,this,function(i){this.pci_write8(this.pci_addr32[0]+3|0,i)}),e.io.register_read_consecutive(Ei,this,function(){return this.pci_response[0]},function(){return this.pci_response[1]},function(){return this.pci_response[2]},function(){return this.pci_response[3]}),e.io.register_read_consecutive(vn,this,function(){return this.pci_status[0]},function(){return this.pci_status[1]},function(){return this.pci_status[2]},function(){return this.pci_status[3]}),e.io.register_write_consecutive(vn,this,function(i){this.pci_addr[0]=i&252},function(i){(this.pci_addr[1]&6)===2&&(i&6)===6?(E("CPU reboot via PCI"),e.reboot_internal()):this.pci_addr[1]=i},function(i){this.pci_addr[2]=i},function(i){this.pci_addr[3]=i,this.pci_query()}),this.register_device({pci_id:0,pci_space:[134,128,55,18,0,0,0,0,2,0,0,6,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,16,0,0,0,0,0,0],pci_bars:[],name:"82441FX PMC"}),this.isa_bridge={pci_id:8,pci_space:[134,128,0,112,7,0,0,2,0,0,1,6,0,0,128,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],pci_bars:[],name:"82371SB PIIX3 ISA"},this.isa_bridge_space=this.register_device(this.isa_bridge),this.isa_bridge_space8=new Uint8Array(this.isa_bridge_space.buffer)}gt.prototype.get_state=function(){for(var e=[],t=0;256>t;t++)e[t]=this.device_spaces[t];return e[256]=this.pci_addr,e[257]=this.pci_value,e[258]=this.pci_response,e[259]=this.pci_status,e};gt.prototype.set_state=function(e){for(var t=0;256>t;t++){var i=this.devices[t],s=e[t];if(i&&s){for(var a=0;a<i.pci_bars.length;a++){var r=s[4+a];if(r&1){var u=i.pci_bars[a];this.set_io_bars(u,u.original_bar&65534,r&65534)}}this.device_spaces[t].set(s)}else i&&E("Warning: While restoring PCI device: Device exists in current configuration but not in snapshot ("+i.name+")"),s&&E("Warning: While restoring PCI device: Device doesn't exist in current configuration but does in snapshot (device "+L(t,2)+")")}this.pci_addr.set(e[256]),this.pci_value.set(e[257]),this.pci_response.set(e[258]),this.pci_status.set(e[259])};gt.prototype.pci_query=function(){var e=this.pci_addr[2]<<8|this.pci_addr[1],t=this.pci_addr[0]&252,i=e>>3&31,s="query enabled="+(this.pci_addr[3]>>7)+(" bdf="+L(e,4));s+=" dev="+L(i,2),s+=" addr="+L(t,2),i=this.device_spaces[e],i!==void 0?(this.pci_status32[0]=-2147483648,this.pci_response32[0]=t<i.byteLength?i[t>>2]:0,s+=" "+L(this.pci_addr32[0]>>>0,8)+" -> "+L(this.pci_response32[0]>>>0,8),t>=i.byteLength&&(s+=" (undef)"),s+=" ("+this.devices[e].name+")",E(s,st)):(this.pci_response32[0]=-1,this.pci_status32[0]=0)};gt.prototype.pci_write8=function(e,t){var i=e>>8&65535;e&=255;var s=new Uint8Array(this.device_spaces[i].buffer),a=this.devices[i];s&&(16<=e&&44>e||48<=e&&52>e,""+L(e),E("PCI write8 dev="+L(i>>3,2)+" ("+a.name+") addr="+L(e,4)+" value="+L(t,2),st),s[e]=t)};gt.prototype.pci_write16=function(e,t){var i=e>>8&65535;e&=255;var s=new Uint16Array(this.device_spaces[i].buffer),a=this.devices[i];s&&(16<=e&&44>e?E("Warning: PCI: Expected 32-bit write, got 16-bit (addr: "+L(e)+")"):(48<=e&&52>e,""+L(e),E("PCI writ16 dev="+L(i>>3,2)+" ("+a.name+") addr="+L(e,4)+" value="+L(t,4),st),s[e>>>1]=t))};gt.prototype.pci_write32=function(e,t){var i=e>>8&65535;e&=255;var s=this.device_spaces[i],a=this.devices[i];if(s)if(16<=e&&40>e){var r=e-16>>2,u=a.pci_bars[r];E("BAR"+r+" exists="+(u?"y":"n")+" changed to "+L(t>>>0)+" dev="+L(i>>3,2)+" ("+a.name+") ",st),u?(u.size&u.size-1,i=e>>2,a=s[i]&1,(t|3|u.size-1)===-1?(t=~(u.size-1)|a,a===0&&(s[i]=t)):a===0&&(r=u.original_bar,(t&-16)!==(r&-16)&&E("Warning: Changing memory bar not supported, ignored",st),s[i]=r),a===1&&(a=s[i]&65534,r=t&65534,E("io bar changed from "+L(a>>>0,8)+" to "+L(r>>>0,8)+" size="+u.size,st),this.set_io_bars(u,a,r),s[i]=t|1)):s[e>>2]=0,E("BAR effective value: "+L(s[e>>2]>>>0),st)}else e===48?(E("PCI write rom address dev="+L(i>>3,2)+" ("+a.name+") value="+L(t>>>0,8),st),s[e>>2]=a.pci_rom_size?(t|2047)===-1?-a.pci_rom_size|0:a.pci_rom_address|0:0):e===4?E("PCI write dev="+L(i>>3,2)+" ("+a.name+") addr="+L(e,4)+" value="+L(t>>>0,8),st):(E("PCI write dev="+L(i>>3,2)+" ("+a.name+") addr="+L(e,4)+" value="+L(t>>>0,8),st),s[e>>>2]=t)};gt.prototype.register_device=function(e){e.pci_id,e.pci_space,e.pci_bars;var t=e.pci_id;E("PCI register bdf="+L(t)+" ("+e.name+")",st),this.devices[t],64<=e.pci_space.length,t<this.devices.length;var i=new Int32Array(64);i.set(new Int32Array(new Uint8Array(e.pci_space).buffer)),this.device_spaces[t]=i,this.devices[t]=e,t=i.slice(4,10);for(var s=0;s<e.pci_bars.length;s++){var a=e.pci_bars[s];if(a){var r=t[s],u=r&1;if(a.original_bar=r,a.entries=[],u!==0)for(r&=-2,u=0;u<a.size;u++)a.entries[u]=this.io.ports[r+u]}}return i};gt.prototype.set_io_bars=function(e,t,i){var s=e.size;E("Move io bars: from="+L(t)+" to="+L(i)+" count="+s,st);for(var a=this.io.ports,r=0;r<s;r++){var u=a[t+r];4096<=t+r&&(a[t+r]=this.io.create_empty_entry()),u.read8===this.io.empty_port_read8&&u.read16===this.io.empty_port_read16&&u.read32===this.io.empty_port_read32&&u.write8===this.io.empty_port_write&&u.write16===this.io.empty_port_write&&u.write32===this.io.empty_port_write&&E("Warning: Bad IO bar: Source not mapped, port="+L(t+r,4),st),u=e.entries[r];var o=a[i+r];4096<=i+r&&(a[i+r]=u),o.read8!==this.io.empty_port_read8&&o.read16!==this.io.empty_port_read16&&o.read32!==this.io.empty_port_read32&&o.write8!==this.io.empty_port_write&&o.write16!==this.io.empty_port_write&&o.write32!==this.io.empty_port_write||E("Warning: Bad IO bar: Target already mapped, port="+L(i+r,4),st)}};gt.prototype.raise_irq=function(e){var t=this.device_spaces[e];this.cpu.device_raise_irq(this.isa_bridge_space8[96+((t[15]>>8&255)-1+((e>>3)-1&255)&3)])};gt.prototype.lower_irq=function(e){var t=this.device_spaces[e];this.cpu.device_lower_irq(this.isa_bridge_space8[96+((t[15]>>8&255)+(e>>3&255)-2&3)])};function Fe(e,t,i){if(this.io=e.io,this.cpu=e,this.dma=e.devices.dma,this.bytes_expecting=0,this.receiving_command=new Uint8Array(10),this.receiving_index=0,this.next_command=null,this.response_data=new Uint8Array(10),this.response_length=this.response_index=0,this.fda_image=t,this.fdb_image=i,this.last_head=this.last_cylinder=this.drive=this.status_reg2=this.status_reg1=this.status_reg0=0,this.last_sector=1,this.dor=0,t){var s={[163840]:{type:1,tracks:40,sectors:8,heads:1},[184320]:{type:1,tracks:40,sectors:9,heads:1},[204800]:{type:1,tracks:40,sectors:10,heads:1},[327680]:{type:1,tracks:40,sectors:8,heads:2},[368640]:{type:1,tracks:40,sectors:9,heads:2},[409600]:{type:1,tracks:40,sectors:10,heads:2},[737280]:{type:3,tracks:80,sectors:9,heads:2},[1228800]:{type:2,tracks:80,sectors:15,heads:2},[1474560]:{type:4,tracks:80,sectors:18,heads:2},[1763328]:{type:5,tracks:82,sectors:21,heads:2},[2949120]:{type:5,tracks:80,sectors:36,heads:2},512:{type:1,tracks:1,sectors:1,heads:1}};let a=t.byteLength;i=s[a],i||(a=1474560<t.byteLength?2949120:1474560,i=s[a],E("Warning: Unkown floppy size: "+t.byteLength+", assuming "+a)),e.devices.rtc.cmos_write(wn,i.type<<4),e=i.sectors,t=i.heads,i=i.tracks,this.sectors_per_track=e,this.number_of_heads=t,this.number_of_cylinders=i}else e.devices.rtc.cmos_write(wn,64),this.number_of_cylinders=this.number_of_heads=this.sectors_per_track=0;this.io.register_read(1008,this,this.port3F0_read),this.io.register_read(1010,this,this.port3F2_read),this.io.register_read(1012,this,this.port3F4_read),this.io.register_read(1013,this,this.port3F5_read),this.io.register_read(1015,this,this.port3F7_read),this.io.register_write(1010,this,this.port3F2_write),this.io.register_write(1013,this,this.port3F5_write)}Fe.prototype.get_state=function(){var e=[];return e[0]=this.bytes_expecting,e[1]=this.receiving_command,e[2]=this.receiving_index,e[4]=this.response_data,e[5]=this.response_index,e[6]=this.response_length,e[8]=this.status_reg0,e[9]=this.status_reg1,e[10]=this.status_reg2,e[11]=this.drive,e[12]=this.last_cylinder,e[13]=this.last_head,e[14]=this.last_sector,e[15]=this.dor,e[16]=this.sectors_per_track,e[17]=this.number_of_heads,e[18]=this.number_of_cylinders,e};Fe.prototype.set_state=function(e){this.bytes_expecting=e[0],this.receiving_command=e[1],this.receiving_index=e[2],this.next_command=e[3],this.response_data=e[4],this.response_index=e[5],this.response_length=e[6],this.status_reg0=e[8],this.status_reg1=e[9],this.status_reg2=e[10],this.drive=e[11],this.last_cylinder=e[12],this.last_head=e[13],this.last_sector=e[14],this.dor=e[15],this.sectors_per_track=e[16],this.number_of_heads=e[17],this.number_of_cylinders=e[18]};Fe.prototype.port3F0_read=function(){return E("3F0 read",Me),0};Fe.prototype.port3F4_read=function(){E("3F4 read",Me);var e=128;return this.response_index<this.response_length&&(e|=80),!(this.dor&8)&&(e|=32),e};Fe.prototype.port3F7_read=function(){return E("3F7 read",Me),0};Fe.prototype.port3F5_read=function(){return this.response_index<this.response_length?(E("3F5 read: "+this.response_data[this.response_index],Me),this.cpu.device_lower_irq(6),this.response_data[this.response_index++]):(E("3F5 read, empty",Me),255)};Fe.prototype.port3F5_write=function(e){if(this.fda_image)if(E("3F5 write "+L(e),Me),0<this.bytes_expecting)this.receiving_command[this.receiving_index++]=e,this.bytes_expecting--,this.bytes_expecting===0&&this.next_command.call(this,this.receiving_command);else{switch(e){case 3:this.next_command=this.fix_drive_data,this.bytes_expecting=2;break;case 4:this.next_command=this.check_drive_status,this.bytes_expecting=1;break;case 5:case 69:case 197:this.next_command=function(t){this.do_sector(!0,t)},this.bytes_expecting=8;break;case 230:this.next_command=function(t){this.do_sector(!1,t)},this.bytes_expecting=8;break;case 7:this.next_command=this.calibrate,this.bytes_expecting=1;break;case 8:this.check_interrupt_status();break;case 74:this.next_command=this.read_sector_id,this.bytes_expecting=1;break;case 15:this.bytes_expecting=2,this.next_command=this.seek;break;case 14:E("dump registers",Me),this.response_data[0]=128,this.response_index=0,this.response_length=1,this.bytes_expecting=0;break;default:""+L(e)}this.receiving_index=0}};Fe.prototype.port3F2_read=function(){return E("read 3F2: DOR",Me),this.dor};Fe.prototype.port3F2_write=function(e){(e&4)===4&&!(this.dor&4)&&this.cpu.device_raise_irq(6),E("start motors: "+L(e>>4),Me),E("enable dma: "+!!(e&8),Me),E("reset fdc: "+!!(e&4),Me),E("drive select: "+(e&3),Me),E("DOR = "+L(e),Me),this.dor=e};Fe.prototype.check_drive_status=function(e){E("check drive status",Me),this.response_index=0,this.response_length=1,this.response_data[0]=32};Fe.prototype.seek=function(e){E("seek",Me),e[0]&3,this.last_cylinder=e[1],this.last_head=e[0]>>2&1,this.raise_irq()};Fe.prototype.calibrate=function(e){E("floppy calibrate",Me),this.raise_irq()};Fe.prototype.check_interrupt_status=function(){E("floppy check interrupt status",Me),this.response_index=0,this.response_length=2,this.response_data[0]=32,this.response_data[1]=this.last_cylinder};Fe.prototype.do_sector=function(e,t){var i=t[2],s=t[1],a=t[3],r=128<<t[4],u=t[5]-t[3]+1,o=((i+this.number_of_heads*s)*this.sectors_per_track+a-1)*r;E("Floppy "+(e?"Write":"Read"),Me),E("from "+L(o)+" length "+L(u*r),Me),E(s+" / "+i+" / "+a,Me),t[4]||E("FDC: sector count is zero, use data length instead",Me),this.fda_image&&(e?this.dma.do_write(this.fda_image,o,u*r,2,this.done.bind(this,t,s,i,a)):this.dma.do_read(this.fda_image,o,u*r,2,this.done.bind(this,t,s,i,a)))};Fe.prototype.done=function(e,t,i,s,a){a||(s++,s>this.sectors_per_track&&(s=1,i++,i>=this.number_of_heads&&(i=0,t++)),this.last_cylinder=t,this.last_head=i,this.last_sector=s,this.response_index=0,this.response_length=7,this.response_data[0]=i<<2|32,this.response_data[1]=0,this.response_data[2]=0,this.response_data[3]=t,this.response_data[4]=i,this.response_data[5]=s,this.response_data[6]=e[4],this.raise_irq())};Fe.prototype.fix_drive_data=function(e){E("floppy fix drive data "+e,Me)};Fe.prototype.read_sector_id=function(e){E("floppy read sector id "+e,Me),this.response_index=0,this.response_length=7,this.response_data[0]=0,this.response_data[1]=0,this.response_data[2]=0,this.response_data[3]=0,this.response_data[4]=0,this.response_data[5]=0,this.response_data[6]=0,this.raise_irq()};Fe.prototype.raise_irq=function(){this.dor&8&&this.cpu.device_raise_irq(6)};ue.prototype.mmap_read8=function(e){return e=this.memory_map_read8[e>>>ht](e),e};ue.prototype.mmap_write8=function(e,t){this.memory_map_write8[e>>>ht](e,t)};ue.prototype.mmap_read16=function(e){var t=this.memory_map_read8[e>>>ht];return e=t(e)|t(e+1|0)<<8,e};ue.prototype.mmap_write16=function(e,t){var i=this.memory_map_write8[e>>>ht];i(e,t&255),i(e+1|0,t>>8)};ue.prototype.mmap_read32=function(e){return this.memory_map_read32[e>>>ht](e)};ue.prototype.mmap_write32=function(e,t){this.memory_map_write32[e>>>ht](e,t)};ue.prototype.mmap_write64=function(e,t,i){var s=e>>>ht;s=this.memory_map_write32[s],s(e,t),s(e+4,i)};ue.prototype.mmap_write128=function(e,t,i,s,a){var r=e>>>ht;r=this.memory_map_write32[r],r(e,t),r(e+4,i),r(e+8,s),r(e+12,a)};ue.prototype.write_blob=function(e,t){e&&0<=e.length,e.length&&(this.in_mapped_range(t),this.in_mapped_range(t+e.length-1),this.jit_dirty_cache(t,t+e.length),this.mem8.set(e,t))};ue.prototype.read_blob=function(e,t){return t&&(this.in_mapped_range(e),this.in_mapped_range(e+t-1),void 0),this.mem8.subarray(e,e+t)};function Le(e){this.cpu=e,this.channel_page=new Uint8Array(8),this.channel_pagehi=new Uint8Array(8),this.channel_addr=new Uint16Array(8),this.channel_addr_init=new Uint16Array(8),this.channel_count=new Uint16Array(8),this.channel_count_init=new Uint16Array(8),this.channel_mask=new Uint8Array(8),this.channel_mode=new Uint8Array(8),this.unmask_listeners=[],this.lsb_msb_flipflop=0,e=e.io,e.register_write(0,this,this.port_addr_write.bind(this,0)),e.register_write(2,this,this.port_addr_write.bind(this,1)),e.register_write(4,this,this.port_addr_write.bind(this,2)),e.register_write(6,this,this.port_addr_write.bind(this,3)),e.register_write(1,this,this.port_count_write.bind(this,0)),e.register_write(3,this,this.port_count_write.bind(this,1)),e.register_write(5,this,this.port_count_write.bind(this,2)),e.register_write(7,this,this.port_count_write.bind(this,3)),e.register_read(0,this,this.port_addr_read.bind(this,0)),e.register_read(2,this,this.port_addr_read.bind(this,1)),e.register_read(4,this,this.port_addr_read.bind(this,2)),e.register_read(6,this,this.port_addr_read.bind(this,3)),e.register_read(1,this,this.port_count_read.bind(this,0)),e.register_read(3,this,this.port_count_read.bind(this,1)),e.register_read(5,this,this.port_count_read.bind(this,2)),e.register_read(7,this,this.port_count_read.bind(this,3)),e.register_write(192,this,this.port_addr_write.bind(this,4)),e.register_write(196,this,this.port_addr_write.bind(this,5)),e.register_write(200,this,this.port_addr_write.bind(this,6)),e.register_write(204,this,this.port_addr_write.bind(this,7)),e.register_write(194,this,this.port_count_write.bind(this,4)),e.register_write(198,this,this.port_count_write.bind(this,5)),e.register_write(202,this,this.port_count_write.bind(this,6)),e.register_write(206,this,this.port_count_write.bind(this,7)),e.register_read(192,this,this.port_addr_read.bind(this,4)),e.register_read(196,this,this.port_addr_read.bind(this,5)),e.register_read(200,this,this.port_addr_read.bind(this,6)),e.register_read(204,this,this.port_addr_read.bind(this,7)),e.register_read(194,this,this.port_count_read.bind(this,4)),e.register_read(198,this,this.port_count_read.bind(this,5)),e.register_read(202,this,this.port_count_read.bind(this,6)),e.register_read(206,this,this.port_count_read.bind(this,7)),e.register_write(135,this,this.port_page_write.bind(this,0)),e.register_write(131,this,this.port_page_write.bind(this,1)),e.register_write(129,this,this.port_page_write.bind(this,2)),e.register_write(130,this,this.port_page_write.bind(this,3)),e.register_write(143,this,this.port_page_write.bind(this,4)),e.register_write(139,this,this.port_page_write.bind(this,5)),e.register_write(137,this,this.port_page_write.bind(this,6)),e.register_write(138,this,this.port_page_write.bind(this,7)),e.register_read(135,this,this.port_page_read.bind(this,0)),e.register_read(131,this,this.port_page_read.bind(this,1)),e.register_read(129,this,this.port_page_read.bind(this,2)),e.register_read(130,this,this.port_page_read.bind(this,3)),e.register_read(143,this,this.port_page_read.bind(this,4)),e.register_read(139,this,this.port_page_read.bind(this,5)),e.register_read(137,this,this.port_page_read.bind(this,6)),e.register_read(138,this,this.port_page_read.bind(this,7)),e.register_write(1159,this,this.port_pagehi_write.bind(this,0)),e.register_write(1155,this,this.port_pagehi_write.bind(this,1)),e.register_write(1153,this,this.port_pagehi_write.bind(this,2)),e.register_write(1154,this,this.port_pagehi_write.bind(this,3)),e.register_write(1163,this,this.port_pagehi_write.bind(this,5)),e.register_write(1161,this,this.port_pagehi_write.bind(this,6)),e.register_write(1162,this,this.port_pagehi_write.bind(this,7)),e.register_read(1159,this,this.port_pagehi_read.bind(this,0)),e.register_read(1155,this,this.port_pagehi_read.bind(this,1)),e.register_read(1153,this,this.port_pagehi_read.bind(this,2)),e.register_read(1154,this,this.port_pagehi_read.bind(this,3)),e.register_read(1163,this,this.port_pagehi_read.bind(this,5)),e.register_read(1161,this,this.port_pagehi_read.bind(this,6)),e.register_read(1162,this,this.port_pagehi_read.bind(this,7)),e.register_write(10,this,this.port_singlemask_write.bind(this,0)),e.register_write(212,this,this.port_singlemask_write.bind(this,4)),e.register_write(15,this,this.port_multimask_write.bind(this,0)),e.register_write(222,this,this.port_multimask_write.bind(this,4)),e.register_read(15,this,this.port_multimask_read.bind(this,0)),e.register_read(222,this,this.port_multimask_read.bind(this,4)),e.register_write(11,this,this.port_mode_write.bind(this,0)),e.register_write(214,this,this.port_mode_write.bind(this,4)),e.register_write(12,this,this.portC_write),e.register_write(216,this,this.portC_write)}Le.prototype.get_state=function(){return[this.channel_page,this.channel_pagehi,this.channel_addr,this.channel_addr_init,this.channel_count,this.channel_count_init,this.channel_mask,this.channel_mode,this.lsb_msb_flipflop]};Le.prototype.set_state=function(e){this.channel_page=e[0],this.channel_pagehi=e[1],this.channel_addr=e[2],this.channel_addr_init=e[3],this.channel_count=e[4],this.channel_count_init=e[5],this.channel_mask=e[6],this.channel_mode=e[7],this.lsb_msb_flipflop=e[8]};Le.prototype.port_count_write=function(e,t){E("count write ["+e+"] = "+L(t),ke),this.channel_count[e]=this.flipflop_get(this.channel_count[e],t,!1),this.channel_count_init[e]=this.flipflop_get(this.channel_count_init[e],t,!0)};Le.prototype.port_count_read=function(e){return E("count read ["+e+"] -> "+L(this.channel_count[e]),ke),this.flipflop_read(this.channel_count[e])};Le.prototype.port_addr_write=function(e,t){E("addr write ["+e+"] = "+L(t),ke),this.channel_addr[e]=this.flipflop_get(this.channel_addr[e],t,!1),this.channel_addr_init[e]=this.flipflop_get(this.channel_addr_init[e],t,!0)};Le.prototype.port_addr_read=function(e){return E("addr read ["+e+"] -> "+L(this.channel_addr[e]),ke),this.flipflop_read(this.channel_addr[e])};Le.prototype.port_pagehi_write=function(e,t){E("pagehi write ["+e+"] = "+L(t),ke),this.channel_pagehi[e]=t};Le.prototype.port_pagehi_read=function(e){return E("pagehi read ["+e+"]",ke),this.channel_pagehi[e]};Le.prototype.port_page_write=function(e,t){E("page write ["+e+"] = "+L(t),ke),this.channel_page[e]=t};Le.prototype.port_page_read=function(e){return E("page read ["+e+"]",ke),this.channel_page[e]};Le.prototype.port_singlemask_write=function(e,t){e=(t&3)+e,t=t&4?1:0,E("singlechannel mask write ["+e+"] = "+t,ke),this.update_mask(e,t)};Le.prototype.port_multimask_write=function(e,t){E("multichannel mask write: "+L(t),ke);for(var i=0;4>i;i++)this.update_mask(e+i,t&1<<i)};Le.prototype.port_multimask_read=function(e){var t=0|this.channel_mask[e+0];return t|=this.channel_mask[e+1]<<1,t|=this.channel_mask[e+2]<<2,t|=this.channel_mask[e+3]<<3,E("multichannel mask read: "+L(t),ke),t};Le.prototype.port_mode_write=function(e,t){e=(t&3)+e,E("mode write ["+e+"] = "+L(t),ke),this.channel_mode[e]=t};Le.prototype.portC_write=function(e){E("flipflop reset",ke),this.lsb_msb_flipflop=0};Le.prototype.on_unmask=function(e,t){this.unmask_listeners.push({fn:e,this_value:t})};Le.prototype.update_mask=function(e,t){if(this.channel_mask[e]!==t&&(this.channel_mask[e]=t,!t))for(E("firing on_unmask("+e+")",ke),t=0;t<this.unmask_listeners.length;t++)this.unmask_listeners[t].fn.call(this.unmask_listeners[t].this_value,e)};Le.prototype.do_read=function(e,t,i,s,a){var r=this.count_get_8bit(s),u=this.address_get_8bit(s);if(E("DMA write channel "+s,ke),E("to "+L(u)+" len "+L(r),ke),i<r&&E("DMA should read more than provided: "+L(i)+" "+L(r),ke),t+r>e.byteLength)E("DMA read outside of buffer",ke),a(!0);else{var o=this.cpu;this.channel_addr[s]+=r,e.get(t,r,function(l){o.write_blob(l,u),a(!1)})}};Le.prototype.do_write=function(e,t,i,s,a){var r=this.channel_count[s]+1&65535,u=5<=s?2:1,o=r*u,l=this.address_get_8bit(s),f=!1,m=!1,C=this.channel_mode[s]&16;E("DMA write channel "+s,ke),E("to "+L(l)+" len "+L(o),ke),i<o?(E("DMA should read more than provided",ke),r=Math.floor(i/u),o=r*u,f=!0):i>o&&(E("DMA attempted to read more than provided",ke),m=!0),t+o>e.byteLength?(E("DMA write outside of buffer",ke),a(!0)):(this.channel_addr[s]+=r,this.channel_count[s]-=r,!f&&C&&(E("DMA autoinit",ke),this.channel_addr[s]=this.channel_addr_init[s],this.channel_count[s]=this.channel_count_init[s]),e.set(t,this.cpu.mem8.subarray(l,l+o),()=>{m&&C?(E("DMA continuing from start",ke),this.do_write(e,t+o,i-o,s,a)):a(!1)}))};Le.prototype.address_get_8bit=function(e){var t=this.channel_addr[e];return 5<=e&&(t<<=1),t=t&65535|this.channel_page[e]<<16,t|=this.channel_pagehi[e]<<24};Le.prototype.count_get_8bit=function(e){var t=this.channel_count[e]+1;return 5<=e&&(t*=2),t};Le.prototype.flipflop_get=function(e,t,i){return i||(this.lsb_msb_flipflop^=1),this.lsb_msb_flipflop?e&-256|t:e&-65281|t<<8};Le.prototype.flipflop_read=function(e){return(this.lsb_msb_flipflop^=1)?e&255:e>>8&255};var ii=1193.1816666;function At(e,t){this.cpu=e,this.bus=t,this.counter_start_time=new Float64Array(3),this.counter_start_value=new Uint16Array(3),this.counter_next_low=new Uint8Array(4),this.counter_enabled=new Uint8Array(4),this.counter_mode=new Uint8Array(4),this.counter_read_mode=new Uint8Array(4),this.counter_latch=new Uint8Array(4),this.counter_latch_value=new Uint16Array(3),this.counter_reload=new Uint16Array(3),e.io.register_read(97,this,function(){var i=be.microtick(),s=66.66666666666667*i&1;return i=this.did_rollover(2,i),s<<4|i<<5}),e.io.register_write(97,this,function(i){i&1?this.bus.send("pcspeaker-enable"):this.bus.send("pcspeaker-disable")}),e.io.register_read(64,this,function(){return this.counter_read(0)}),e.io.register_read(65,this,function(){return this.counter_read(1)}),e.io.register_read(66,this,function(){return this.counter_read(2)}),e.io.register_write(64,this,function(i){this.counter_write(0,i)}),e.io.register_write(65,this,function(i){this.counter_write(1,i)}),e.io.register_write(66,this,function(i){this.counter_write(2,i),this.bus.send("pcspeaker-update",[this.counter_mode[2],this.counter_reload[2]])}),e.io.register_write(67,this,this.port43_write)}At.prototype.get_state=function(){var e=[];return e[0]=this.counter_next_low,e[1]=this.counter_enabled,e[2]=this.counter_mode,e[3]=this.counter_read_mode,e[4]=this.counter_latch,e[5]=this.counter_latch_value,e[6]=this.counter_reload,e[7]=this.counter_start_time,e[8]=this.counter_start_value,e};At.prototype.set_state=function(e){this.counter_next_low=e[0],this.counter_enabled=e[1],this.counter_mode=e[2],this.counter_read_mode=e[3],this.counter_latch=e[4],this.counter_latch_value=e[5],this.counter_reload=e[6],this.counter_start_time=e[7],this.counter_start_value=e[8]};At.prototype.timer=function(e,t){var i=100;return t||(this.counter_enabled[0]&&this.did_rollover(0,e)?(this.counter_start_value[0]=this.get_counter_value(0,e),this.counter_start_time[0]=e,E("pit interrupt. new value: "+this.counter_start_value[0],Mt),this.cpu.device_lower_irq(0),this.cpu.device_raise_irq(0),this.counter_mode[0]===0&&(this.counter_enabled[0]=0)):this.cpu.device_lower_irq(0),this.counter_enabled[0]&&(i=(this.counter_start_value[0]-Math.floor((e-this.counter_start_time[0])*ii))/ii)),i};At.prototype.get_counter_value=function(e,t){if(!this.counter_enabled[e])return 0;var i=t-this.counter_start_time[e],s=Math.floor(i*ii);return t=this.counter_start_value[e]-s,E("diff="+i+" dticks="+s+" value="+t+" reload="+this.counter_reload[e],Mt),i=this.counter_reload[e],t>=i?(E("Warning: Counter"+e+" value "+t+" is larger than reload "+i,Mt),t%=i):0>t&&(t=t%i+i),t};At.prototype.did_rollover=function(e,t){return t-=this.counter_start_time[e],0>t?(E("Warning: PIT timer difference is negative, resetting (timer "+e+")"),!0):this.counter_start_value[e]<Math.floor(t*ii)};At.prototype.counter_read=function(e){var t=this.counter_latch[e];return t?(this.counter_latch[e]--,t===2?this.counter_latch_value[e]&255:this.counter_latch_value[e]>>8):(t=this.counter_next_low[e],this.counter_mode[e]===3&&(this.counter_next_low[e]^=1),e=this.get_counter_value(e,be.microtick()),t?e&255:e>>8)};At.prototype.counter_write=function(e,t){this.counter_reload[e]=this.counter_next_low[e]?this.counter_reload[e]&-256|t:this.counter_reload[e]&255|t<<8,this.counter_read_mode[e]===3&&this.counter_next_low[e]||(this.counter_reload[e]||(this.counter_reload[e]=65535),this.counter_start_value[e]=this.counter_reload[e],this.counter_enabled[e]=!0,this.counter_start_time[e]=be.microtick(),E("counter"+e+" reload="+L(this.counter_reload[e])+" tick="+(this.counter_reload[e]||65536)/ii+"ms",Mt)),this.counter_read_mode[e]===3&&(this.counter_next_low[e]^=1)};At.prototype.port43_write=function(e){var t=e>>1&7,i=e&1,s=e>>6&3;e=e>>4&3,s===1&&E("Unimplemented timer1",Mt),s===3?E("Unimplemented read back",Mt):e===0?(this.counter_latch[s]=2,t=this.get_counter_value(s,be.microtick()),E("latch: "+t,Mt),this.counter_latch_value[s]=t?t-1:0):(6<=t&&(t&=-5),E("Control: mode="+t+" ctr="+s+" read_mode="+e+" bcd="+i,Mt),this.counter_next_low[s]=e===1?0:1,s===0&&this.cpu.device_lower_irq(0),t!==0&&t!==3&&t!==2&&E("Unimplemented counter mode: "+L(t),Mt),this.counter_mode[s]=t,this.counter_read_mode[s]=e,s===2&&this.bus.send("pcspeaker-update",[this.counter_mode[2],this.counter_reload[2]]))};At.prototype.dump=function(){const e=this.counter_reload[0];E("counter0 ticks every "+(e||65536)/ii+"ms (reload="+e+")")};var rt=65536,Fr=2560,Ur=1600,Ea=32,Ai=3758096384,Di=8*rt,mn=4*rt,ro=Uint32Array.from([655360,655360,720896,753664]),Ws=Uint32Array.from([131072,65536,32768,32768]);function ne(e,t,i){this.cpu=e,this.bus=t,this.vga_memory_size=i,this.cursor_address=0,this.cursor_scanline_start=14,this.cursor_scanline_end=15,this.max_cols=80,this.max_rows=25,this.virtual_height=this.virtual_width=this.screen_height=this.screen_width=0,this.layers=[],this.start_address_latched=this.start_address=0,this.crtc=new Uint8Array(25),this.line_compare=this.offset_register=this.preset_row_scan=this.underline_location_register=this.vertical_blank_start=this.vertical_display_enable_end=this.horizontal_blank_start=this.horizontal_display_enable_end=this.crtc_mode=0,this.graphical_mode_is_linear=!0,this.graphical_mode=!1,setTimeout(()=>{t.send("screen-set-mode",this.graphical_mode)},0),this.vga256_palette=new Int32Array(256),this.svga_height=this.svga_width=this.latch_dword=0,this.svga_enabled=!1,this.svga_bpp=32,this.svga_offset=this.svga_bank_offset=0,this.pci_space=[52,18,17,17,3,1,0,0,0,0,0,3,0,0,0,0,8,Ai>>>8,Ai>>>16,Ai>>>24,0,0,0,0,0,0,191,254,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,244,26,0,17,0,0,190,254,0,0,0,0,0,0,0,0,0,0,0,0],this.pci_id=144,this.pci_bars=[{size:i}],this.pci_rom_size=65536,this.pci_rom_address=4272947200,this.name="vga",this.stats={is_graphical:!1,res_x:0,res_y:0,bpp:0},this.dac_state=this.dac_color_index_read=this.dac_color_index_write=this.index_crtc=0,this.dac_mask=255,this.dac_map=new Uint8Array(16),this.attribute_controller_index=-1,this.palette_source=32,this.color_select=this.horizontal_panning=this.color_plane_enable=this.attribute_mode=0,this.sequencer_index=-1,this.plane_write_bm=15,this.clocking_mode=this.sequencer_memory_mode=0,this.graphics_index=-1,this.planar_rotate_reg=this.planar_mode=this.plane_read=0,this.planar_bitmap=255,this.max_scan_line=this.color_dont_care=this.color_compare=this.miscellaneous_graphics_register=this.planar_setreset_enable=this.planar_setreset=0,this.port_3DA_value=this.miscellaneous_output_register=255,i=e.io,i.register_write(960,this,this.port3C0_write),i.register_read(960,this,this.port3C0_read,this.port3C0_read16),i.register_read(961,this,this.port3C1_read),i.register_write(962,this,this.port3C2_write),i.register_write_consecutive(964,this,this.port3C4_write,this.port3C5_write),i.register_read(964,this,this.port3C4_read),i.register_read(965,this,this.port3C5_read),i.register_write_consecutive(974,this,this.port3CE_write,this.port3CF_write),i.register_read(974,this,this.port3CE_read),i.register_read(975,this,this.port3CF_read),i.register_read(966,this,this.port3C6_read),i.register_write(966,this,this.port3C6_write),i.register_write(967,this,this.port3C7_write),i.register_read(967,this,this.port3C7_read),i.register_write(968,this,this.port3C8_write),i.register_read(968,this,this.port3C8_read),i.register_write(969,this,this.port3C9_write),i.register_read(969,this,this.port3C9_read),i.register_read(972,this,this.port3CC_read),i.register_write_consecutive(980,this,this.port3D4_write,this.port3D5_write),i.register_read(980,this,this.port3D4_read),i.register_read(981,this,this.port3D5_read,()=>(E("Warning: 16-bit read from 3D5",Q),this.port3D5_read())),i.register_read(970,this,function(){return E("3CA read",Q),0}),i.register_read(986,this,this.port3DA_read),i.register_read(954,this,this.port3DA_read),this.dispi_index=-1,this.dispi_enable_value=0,i.register_write(462,this,void 0,this.port1CE_write),i.register_write(463,this,void 0,this.port1CF_write),i.register_read(463,this,void 0,this.port1CF_read),this.vga_memory_size===void 0||this.vga_memory_size<mn?(this.vga_memory_size=mn,E("vga memory size rounded up to "+this.vga_memory_size,Q)):this.vga_memory_size&rt-1&&(this.vga_memory_size|=rt-1,this.vga_memory_size++);const s=e.svga_allocate_memory(this.vga_memory_size);this.svga_memory=V.view(Uint8Array,e.wasm_memory,s,this.vga_memory_size),this.diff_addr_min=this.vga_memory_size,this.diff_addr_max=0,this.diff_plot_min=this.vga_memory_size,this.diff_plot_max=0,this.image_data=null,t.register("screen-fill-buffer",function(){this.screen_fill_buffer()},this),this.vga_memory=new Uint8Array(4*rt),this.plane0=new Uint8Array(this.vga_memory.buffer,0*rt,rt),this.plane1=new Uint8Array(this.vga_memory.buffer,1*rt,rt),this.plane2=new Uint8Array(this.vga_memory.buffer,2*rt,rt),this.plane3=new Uint8Array(this.vga_memory.buffer,3*rt,rt),this.pixel_buffer=new Uint8Array(Di);var a=this;i.mmap_register(655360,131072,function(r){return a.vga_memory_read(r)},function(r,u){a.vga_memory_write(r,u)}),e.devices.pci.register_device(this)}ne.prototype.get_state=function(){var e=[];return e[0]=this.vga_memory_size,e[1]=this.cursor_address,e[2]=this.cursor_scanline_start,e[3]=this.cursor_scanline_end,e[4]=this.max_cols,e[5]=this.max_rows,e[6]=this.vga_memory,e[7]=this.dac_state,e[8]=this.start_address,e[9]=this.graphical_mode,e[10]=this.vga256_palette,e[11]=this.latch_dword,e[12]=this.color_compare,e[13]=this.color_dont_care,e[14]=this.miscellaneous_graphics_register,e[15]=this.svga_width,e[16]=this.svga_height,e[17]=this.crtc_mode,e[18]=this.svga_enabled,e[19]=this.svga_bpp,e[20]=this.svga_bank_offset,e[21]=this.svga_offset,e[22]=this.index_crtc,e[23]=this.dac_color_index_write,e[24]=this.dac_color_index_read,e[25]=this.dac_map,e[26]=this.sequencer_index,e[27]=this.plane_write_bm,e[28]=this.sequencer_memory_mode,e[29]=this.graphics_index,e[30]=this.plane_read,e[31]=this.planar_mode,e[32]=this.planar_rotate_reg,e[33]=this.planar_bitmap,e[34]=this.max_scan_line,e[35]=this.miscellaneous_output_register,e[36]=this.port_3DA_value,e[37]=this.dispi_index,e[38]=this.dispi_enable_value,e[39]=this.svga_memory,e[40]=this.graphical_mode_is_linear,e[41]=this.attribute_controller_index,e[42]=this.offset_register,e[43]=this.planar_setreset,e[44]=this.planar_setreset_enable,e[45]=this.start_address_latched,e[46]=this.crtc,e[47]=this.horizontal_display_enable_end,e[48]=this.horizontal_blank_start,e[49]=this.vertical_display_enable_end,e[50]=this.vertical_blank_start,e[51]=this.underline_location_register,e[52]=this.preset_row_scan,e[53]=this.offset_register,e[54]=this.palette_source,e[55]=this.attribute_mode,e[56]=this.color_plane_enable,e[57]=this.horizontal_panning,e[58]=this.color_select,e[59]=this.clocking_mode,e[60]=this.line_compare,e[61]=this.pixel_buffer,e[62]=this.dac_mask,e};ne.prototype.set_state=function(e){this.vga_memory_size=e[0],this.cursor_address=e[1],this.cursor_scanline_start=e[2],this.cursor_scanline_end=e[3],this.max_cols=e[4],this.max_rows=e[5],e[6]&&this.vga_memory.set(e[6]),this.dac_state=e[7],this.start_address=e[8],this.graphical_mode=e[9],this.vga256_palette=e[10],this.latch_dword=e[11],this.color_compare=e[12],this.color_dont_care=e[13],this.miscellaneous_graphics_register=e[14],this.svga_width=e[15],this.svga_height=e[16],this.crtc_mode=e[17],this.svga_enabled=e[18],this.svga_bpp=e[19],this.svga_bank_offset=e[20],this.svga_offset=e[21],this.index_crtc=e[22],this.dac_color_index_write=e[23],this.dac_color_index_read=e[24],this.dac_map=e[25],this.sequencer_index=e[26],this.plane_write_bm=e[27],this.sequencer_memory_mode=e[28],this.graphics_index=e[29],this.plane_read=e[30],this.planar_mode=e[31],this.planar_rotate_reg=e[32],this.planar_bitmap=e[33],this.max_scan_line=e[34],this.miscellaneous_output_register=e[35],this.port_3DA_value=e[36],this.dispi_index=e[37],this.dispi_enable_value=e[38],this.svga_memory.set(e[39]),this.graphical_mode_is_linear=e[40],this.attribute_controller_index=e[41],this.offset_register=e[42],this.planar_setreset=e[43],this.planar_setreset_enable=e[44],this.start_address_latched=e[45],this.crtc.set(e[46]),this.horizontal_display_enable_end=e[47],this.horizontal_blank_start=e[48],this.vertical_display_enable_end=e[49],this.vertical_blank_start=e[50],this.underline_location_register=e[51],this.preset_row_scan=e[52],this.offset_register=e[53],this.palette_source=e[54],this.attribute_mode=e[55],this.color_plane_enable=e[56],this.horizontal_panning=e[57],this.color_select=e[58],this.clocking_mode=e[59],this.line_compare=e[60],e[61]&&this.pixel_buffer.set(e[61]),this.dac_mask=e[62]===void 0?255:e[62],this.bus.send("screen-set-mode",this.graphical_mode),this.graphical_mode?(this.screen_height=this.screen_width=0,this.svga_enabled?(this.set_size_graphical(this.svga_width,this.svga_height,this.svga_bpp,this.svga_width,this.svga_height),this.update_layers()):(this.update_vga_size(),this.update_layers(),this.complete_replot())):(this.set_size_text(this.max_cols,this.max_rows),this.update_cursor_scanline(),this.update_cursor()),this.complete_redraw()};ne.prototype.vga_memory_read=function(e){if(this.svga_enabled&&this.graphical_mode_is_linear)return this.cpu.read8((e-655360|this.svga_bank_offset)+Ai|0);var t=this.miscellaneous_graphics_register>>2&3;return e-=ro[t],0>e||e>=Ws[t]?(E("vga read outside memory space: addr:"+L(e),Q),0):(this.latch_dword=this.plane0[e],this.latch_dword|=this.plane1[e]<<8,this.latch_dword|=this.plane2[e]<<16,this.latch_dword|=this.plane3[e]<<24,this.planar_mode&8?(t=255,this.color_dont_care&1&&(t&=this.plane0[e]^~(this.color_compare&1?255:0)),this.color_dont_care&2&&(t&=this.plane1[e]^~(this.color_compare&2?255:0)),this.color_dont_care&4&&(t&=this.plane2[e]^~(this.color_compare&4?255:0)),this.color_dont_care&8&&(t&=this.plane3[e]^~(this.color_compare&8?255:0)),t):(t=this.plane_read,this.graphical_mode?this.sequencer_memory_mode&8?(t=e&3,e&=-4):this.planar_mode&16&&(t=e&1,e&=-2):t=0,this.vga_memory[t<<16|e]))};ne.prototype.vga_memory_write=function(e,t){if(this.svga_enabled&&this.graphical_mode&&this.graphical_mode_is_linear)this.cpu.write8((e-655360|this.svga_bank_offset)+Ai|0,t);else{var i=this.miscellaneous_graphics_register>>2&3;e-=ro[i],0>e||e>=Ws[i]?E("vga write outside memory space: addr:"+L(e)+", value:"+L(t),Q):this.graphical_mode?this.vga_memory_write_graphical(e,t):this.plane_write_bm&3&&this.vga_memory_write_text_mode(e,t)}};ne.prototype.vga_memory_write_graphical=function(e,t){var i=this.planar_mode&3,s=this.apply_feed(this.planar_bitmap),a=this.apply_expand(this.planar_setreset),r=this.apply_expand(this.planar_setreset_enable);switch(i){case 0:t=this.apply_rotate(t);var u=this.apply_feed(t);u=this.apply_setreset(u,r),u=this.apply_logical(u,this.latch_dword),u=this.apply_bitmask(u,s);break;case 1:u=this.latch_dword;break;case 2:u=this.apply_expand(t),u=this.apply_logical(u,this.latch_dword),u=this.apply_bitmask(u,s);break;case 3:t=this.apply_rotate(t),s&=this.apply_feed(t),u=this.apply_bitmask(a,s)}switch(t=15,this.sequencer_memory_mode&12){case 0:t=5<<(e&1),e&=-2;break;case 8:case 12:t=1<<(e&3),e&=-4}t&=this.plane_write_bm,t&1&&(this.plane0[e]=u>>0&255),t&2&&(this.plane1[e]=u>>8&255),t&4&&(this.plane2[e]=u>>16&255),t&8&&(this.plane3[e]=u>>24&255),e=this.vga_addr_to_pixel(e),this.partial_replot(e,e+7)};ne.prototype.apply_feed=function(e){return e|e<<8|e<<16|e<<24};ne.prototype.apply_expand=function(e){return(e&1?255:0)|(e&2?255:0)<<8|(e&4?255:0)<<16|(e&8?255:0)<<24};ne.prototype.apply_rotate=function(e){return(e|e<<8)>>>(this.planar_rotate_reg&7)&255};ne.prototype.apply_setreset=function(e,t){var i=this.apply_expand(this.planar_setreset);return(e|t&i)&(~t|i)};ne.prototype.apply_logical=function(e,t){switch(this.planar_rotate_reg&24){case 8:return e&t;case 16:return e|t;case 24:return e^t}return e};ne.prototype.apply_bitmask=function(e,t){return t&e|~t&this.latch_dword};ne.prototype.text_mode_redraw=function(){for(var e=this.start_address<<1,t,i,s=0;s<this.max_rows;s++)for(var a=0;a<this.max_cols;a++)t=this.vga_memory[e],i=this.vga_memory[e|1],this.bus.send("screen-put-char",[s,a,t,this.vga256_palette[this.dac_mask&this.dac_map[i>>4&15]],this.vga256_palette[this.dac_mask&this.dac_map[i&15]]]),e+=2};ne.prototype.vga_memory_write_text_mode=function(e,t){var i=(e>>1)-this.start_address,s=i/this.max_cols|0;if(i%=this.max_cols,e&1)var a=t,r=this.vga_memory[e&-2];else r=t,a=this.vga_memory[e|1];this.bus.send("screen-put-char",[s,i,r,this.vga256_palette[this.dac_mask&this.dac_map[a>>4&15]],this.vga256_palette[this.dac_mask&this.dac_map[a&15]]]),this.vga_memory[e]=t};ne.prototype.update_cursor=function(){var e=(this.cursor_address-this.start_address)/this.max_cols|0,t=(this.cursor_address-this.start_address)%this.max_cols;e=Math.min(this.max_rows-1,e),this.bus.send("screen-update-cursor",[e,t])};ne.prototype.complete_redraw=function(){E("complete redraw",Q),this.graphical_mode?this.svga_enabled?this.cpu.svga_mark_dirty():(this.diff_addr_min=0,this.diff_addr_max=Di):this.text_mode_redraw()};ne.prototype.complete_replot=function(){E("complete replot",Q),this.graphical_mode&&!this.svga_enabled&&(this.diff_plot_min=0,this.diff_plot_max=Di,this.complete_redraw())};ne.prototype.partial_redraw=function(e,t){e<this.diff_addr_min&&(this.diff_addr_min=e),t>this.diff_addr_max&&(this.diff_addr_max=t)};ne.prototype.partial_replot=function(e,t){e<this.diff_plot_min&&(this.diff_plot_min=e),t>this.diff_plot_max&&(this.diff_plot_max=t),this.partial_redraw(e,t)};ne.prototype.reset_diffs=function(){this.diff_addr_min=this.vga_memory_size,this.diff_addr_max=0,this.diff_plot_min=this.vga_memory_size,this.diff_plot_max=0};ne.prototype.destroy=function(){};ne.prototype.vga_bytes_per_line=function(){var e=this.offset_register<<2;return this.underline_location_register&64?e<<=1:this.crtc_mode&64&&(e>>>=1),e};ne.prototype.vga_addr_shift_count=function(){var e=128+(~this.underline_location_register&this.crtc_mode&64);return e-=this.underline_location_register&64,e-=this.attribute_mode&64,e>>>6};ne.prototype.vga_addr_to_pixel=function(e){var t=this.vga_addr_shift_count();if(~this.crtc_mode&3){var i=e-this.start_address;i&=this.crtc_mode<<13|-24577,i<<=t;var s=i/this.virtual_width|0;switch(i%=this.virtual_width,this.crtc_mode&3){case 2:s=s<<1|e>>13&1;break;case 1:s=s<<1|e>>14&1;break;case 0:s=s<<2|e>>13&3}return s*this.virtual_width+i+(this.start_address<<t)}return e<<t};ne.prototype.scan_line_to_screen_row=function(e){return this.max_scan_line&128&&(e>>>=1),e=Math.ceil(e/(1+(this.max_scan_line&31))),this.crtc_mode&1||(e<<=1),this.crtc_mode&2||(e<<=1),e};ne.prototype.set_size_text=function(e,t){this.max_cols=e,this.max_rows=t,this.bus.send("screen-set-size-text",[e,t])};ne.prototype.set_size_graphical=function(e,t,i,s,a){if(!this.stats.is_graphical||this.stats.bpp!==i||this.screen_width!==e||this.screen_height!==t||this.virtual_width!==s||this.virtual_height!==a){if(this.screen_width=e,this.screen_height=t,this.virtual_width=s,this.virtual_height=a,this.stats.bpp=i,this.stats.is_graphical=!0,this.stats.res_x=e,this.stats.res_y=t,typeof ImageData<"u"){const r=s*a,u=this.cpu.svga_allocate_dest_buffer(r)>>>0;this.dest_buffet_offset=u,this.image_data=new ImageData(new Uint8ClampedArray(this.cpu.wasm_memory.buffer,u,4*r),s,a),this.cpu.svga_mark_dirty()}this.bus.send("screen-set-size-graphical",[e,t,s,a,i])}};ne.prototype.update_vga_size=function(){if(!this.svga_enabled){var e=Math.min(1+this.horizontal_display_enable_end,this.horizontal_blank_start),t=Math.min(1+this.vertical_display_enable_end,this.vertical_blank_start);if(e&&t)if(this.graphical_mode){e<<=3;var i=this.offset_register<<4;this.attribute_mode&64&&(e>>>=1,i>>>=1),t=this.scan_line_to_screen_row(t);var s=Math.ceil(Ws[0]/this.vga_bytes_per_line());this.set_size_graphical(e,t,8,i,s),this.update_vertical_retrace(),this.update_layers()}else this.max_scan_line&128&&(t>>>=1),i=t/(1+(this.max_scan_line&31))|0,e&&i&&this.set_size_text(e,i)}};ne.prototype.update_layers=function(){if(this.graphical_mode||this.text_mode_redraw(),this.svga_enabled)this.layers=[];else if(this.virtual_width&&this.screen_width)if(!this.palette_source||this.clocking_mode&32)this.layers=[],this.bus.send("screen-clear");else{var e=this.start_address_latched,t=this.horizontal_panning;this.attribute_mode&64&&(t>>>=1);var i=this.preset_row_scan>>5&3,s=this.vga_addr_to_pixel(e+i);e=s/this.virtual_width|0;var a=s%this.virtual_width+t;s=this.scan_line_to_screen_row(1+this.line_compare),s=Math.min(s,this.screen_height);var r=this.screen_height-s;this.layers=[],a=-a;for(var u=0;a<this.screen_width;a+=this.virtual_width,u++)this.layers.push({image_data:this.image_data,screen_x:a,screen_y:0,buffer_x:0,buffer_y:e+u,buffer_width:this.virtual_width,buffer_height:s});for(e=0,this.attribute_mode&32||(e=this.vga_addr_to_pixel(i)+t),a=-e,u=0;a<this.screen_width;a+=this.virtual_width,u++)this.layers.push({image_data:this.image_data,screen_x:a,screen_y:s,buffer_x:0,buffer_y:u,buffer_width:this.virtual_width,buffer_height:r})}};ne.prototype.update_vertical_retrace=function(){this.port_3DA_value|=8,this.start_address_latched!==this.start_address&&(this.start_address_latched=this.start_address,this.update_layers())};ne.prototype.update_cursor_scanline=function(){this.bus.send("screen-update-cursor-scanline",[this.cursor_scanline_start,this.cursor_scanline_end])};ne.prototype.port3C0_write=function(e){if(this.attribute_controller_index===-1)E("attribute controller index register: "+L(e),Q),this.attribute_controller_index=e&31,E("attribute actual index: "+L(this.attribute_controller_index),Q),this.palette_source!==(e&32)&&(this.palette_source=e&32,this.update_layers());else{if(16>this.attribute_controller_index)E("internal palette: "+L(this.attribute_controller_index)+" -> "+L(e),Q),this.dac_map[this.attribute_controller_index]=e,this.attribute_mode&64||this.complete_redraw();else switch(this.attribute_controller_index){case 16:if(E("3C0 / attribute mode control: "+L(e),Q),this.attribute_mode!==e){var t=this.attribute_mode;this.attribute_mode=e;var i=0<(e&1);this.svga_enabled||this.graphical_mode===i||(this.graphical_mode=i,this.bus.send("screen-set-mode",this.graphical_mode)),(t^e)&64&&this.complete_replot(),this.update_vga_size(),this.complete_redraw()}break;case 18:E("3C0 / color plane enable: "+L(e),Q),this.color_plane_enable!==e&&(this.color_plane_enable=e,this.complete_redraw());break;case 19:E("3C0 / horizontal panning: "+L(e),Q),this.horizontal_panning!==e&&(this.horizontal_panning=e&15,this.update_layers());break;case 20:E("3C0 / color select: "+L(e),Q),this.color_select!==e&&(this.color_select=e,this.complete_redraw());break;default:E("3C0 / attribute controller write "+L(this.attribute_controller_index)+": "+L(e),Q)}this.attribute_controller_index=-1}};ne.prototype.port3C0_read=function(){return E("3C0 read",Q),this.attribute_controller_index|this.palette_source};ne.prototype.port3C0_read16=function(){return E("3C0 read16",Q),this.port3C0_read()&255|this.port3C1_read()<<8&65280};ne.prototype.port3C1_read=function(){if(16>this.attribute_controller_index)return E("3C1 / internal palette read: "+L(this.attribute_controller_index)+" -> "+L(this.dac_map[this.attribute_controller_index]),Q),this.dac_map[this.attribute_controller_index]&255;switch(this.attribute_controller_index){case 16:return E("3C1 / attribute mode read: "+L(this.attribute_mode),Q),this.attribute_mode;case 18:return E("3C1 / color plane enable read: "+L(this.color_plane_enable),Q),this.color_plane_enable;case 19:return E("3C1 / horizontal panning read: "+L(this.horizontal_panning),Q),this.horizontal_panning;case 20:return E("3C1 / color select read: "+L(this.color_select),Q),this.color_select;default:E("3C1 / attribute controller read "+L(this.attribute_controller_index),Q)}return 255};ne.prototype.port3C2_write=function(e){E("3C2 / miscellaneous output register = "+L(e),Q),this.miscellaneous_output_register=e};ne.prototype.port3C4_write=function(e){this.sequencer_index=e};ne.prototype.port3C4_read=function(){return this.sequencer_index};ne.prototype.port3C5_write=function(e){switch(this.sequencer_index){case 1:E("clocking mode: "+L(e),Q);var t=this.clocking_mode;this.clocking_mode=e,(t^e)&32&&this.update_layers();break;case 2:E("plane write mask: "+L(e),Q),this.plane_write_bm=e;break;case 4:E("sequencer memory mode: "+L(e),Q),this.sequencer_memory_mode=e;break;default:E("3C5 / sequencer write "+L(this.sequencer_index)+": "+L(e),Q)}};ne.prototype.port3C5_read=function(){switch(E("3C5 / sequencer read "+L(this.sequencer_index),Q),this.sequencer_index){case 1:return this.clocking_mode;case 2:return this.plane_write_bm;case 4:return this.sequencer_memory_mode;case 6:return 18}return 0};ne.prototype.port3C6_write=function(e){this.dac_mask=e};ne.prototype.port3C6_read=function(){return this.dac_mask};ne.prototype.port3C7_write=function(e){E("3C7 write: "+L(e),Q),this.dac_color_index_read=3*e,this.dac_state&=0};ne.prototype.port3C7_read=function(){return this.dac_state};ne.prototype.port3C8_write=function(e){this.dac_color_index_write=3*e,this.dac_state|=3};ne.prototype.port3C8_read=function(){return this.dac_color_index_write/3&255};ne.prototype.port3C9_write=function(e){var t=this.dac_color_index_write/3|0,i=this.dac_color_index_write%3,s=this.vga256_palette[t];if(!(this.dispi_enable_value&32)){e&=63;const a=e&1;e=e<<2|a<<1|a}i===0?s=s&-16711681|e<<16:i===1?s=s&-65281|e<<8:(s=s&-256|e,E("dac set color, index="+L(t)+" value="+L(s),Q)),this.vga256_palette[t]!==s&&(this.vga256_palette[t]=s,this.complete_redraw()),this.dac_color_index_write++};ne.prototype.port3C9_read=function(){E("3C9 read",Q);var e=this.vga256_palette[this.dac_color_index_read/3|0]>>8*(2-this.dac_color_index_read%3)&255;return this.dac_color_index_read++,this.dispi_enable_value&32?e:e>>2};ne.prototype.port3CC_read=function(){return E("3CC read",Q),this.miscellaneous_output_register};ne.prototype.port3CE_write=function(e){this.graphics_index=e};ne.prototype.port3CE_read=function(){return this.graphics_index};ne.prototype.port3CF_write=function(e){switch(this.graphics_index){case 0:this.planar_setreset=e,E("plane set/reset: "+L(e),Q);break;case 1:this.planar_setreset_enable=e,E("plane set/reset enable: "+L(e),Q);break;case 2:this.color_compare=e,E("color compare: "+L(e),Q);break;case 3:this.planar_rotate_reg=e,E("plane rotate: "+L(e),Q);break;case 4:this.plane_read=e,E("plane read: "+L(e),Q);break;case 5:var t=this.planar_mode;this.planar_mode=e,E("planar mode: "+L(e),Q),(t^e)&96&&this.complete_replot();break;case 6:E("miscellaneous graphics register: "+L(e),Q),this.miscellaneous_graphics_register!==e&&(this.miscellaneous_graphics_register=e,this.update_vga_size());break;case 7:this.color_dont_care=e,E("color don't care: "+L(e),Q);break;case 8:this.planar_bitmap=e,E("planar bitmap: "+L(e),Q);break;default:E("3CF / graphics write "+L(this.graphics_index)+": "+L(e),Q)}};ne.prototype.port3CF_read=function(){switch(E("3CF / graphics read "+L(this.graphics_index),Q),this.graphics_index){case 0:return this.planar_setreset;case 1:return this.planar_setreset_enable;case 2:return this.color_compare;case 3:return this.planar_rotate_reg;case 4:return this.plane_read;case 5:return this.planar_mode;case 6:return this.miscellaneous_graphics_register;case 7:return this.color_dont_care;case 8:return this.planar_bitmap}return 0};ne.prototype.port3D4_write=function(e){E("3D4 / crtc index: "+e,Q),this.index_crtc=e};ne.prototype.port3D4_read=function(){return E("3D4 read / crtc index: "+this.index_crtc,Q),this.index_crtc};ne.prototype.port3D5_write=function(e){switch(this.index_crtc){case 1:E("3D5 / hdisp enable end write: "+L(e),Q),this.horizontal_display_enable_end!==e&&(this.horizontal_display_enable_end=e,this.update_vga_size());break;case 2:this.horizontal_blank_start!==e&&(this.horizontal_blank_start=e,this.update_vga_size());break;case 7:E("3D5 / overflow register write: "+L(e),Q);var t=this.vertical_display_enable_end;this.vertical_display_enable_end&=255,this.vertical_display_enable_end=this.vertical_display_enable_end|e<<3&512|e<<7&256,t!=this.vertical_display_enable_end&&this.update_vga_size(),this.line_compare=this.line_compare&767|e<<4&256,t=this.vertical_blank_start,this.vertical_blank_start=this.vertical_blank_start&767|e<<5&256,t!==this.vertical_blank_start&&this.update_vga_size(),this.update_layers();break;case 8:E("3D5 / preset row scan write: "+L(e),Q),this.preset_row_scan=e,this.update_layers();break;case 9:E("3D5 / max scan line write: "+L(e),Q),this.max_scan_line=e,this.line_compare=this.line_compare&511|e<<3&512,t=this.vertical_blank_start,this.vertical_blank_start=this.vertical_blank_start&511|e<<4&512,t!==this.vertical_blank_start&&this.update_vga_size(),this.update_layers();break;case 10:E("3D5 / cursor scanline start write: "+L(e),Q),this.cursor_scanline_start=e,this.update_cursor_scanline();break;case 11:E("3D5 / cursor scanline end write: "+L(e),Q),this.cursor_scanline_end=e,this.update_cursor_scanline();break;case 12:(this.start_address>>8&255)!==e&&(this.start_address=this.start_address&255|e<<8,this.update_layers(),~this.crtc_mode&3&&this.complete_replot()),E("3D5 / start addr hi write: "+L(e)+" -> "+L(this.start_address,4),Q);break;case 13:(this.start_address&255)!==e&&(this.start_address=this.start_address&65280|e,this.update_layers(),~this.crtc_mode&3&&this.complete_replot()),E("3D5 / start addr lo write: "+L(e)+" -> "+L(this.start_address,4),Q);break;case 14:E("3D5 / cursor address hi write: "+L(e),Q),this.cursor_address=this.cursor_address&255|e<<8,this.update_cursor();break;case 15:E("3D5 / cursor address lo write: "+L(e),Q),this.cursor_address=this.cursor_address&65280|e,this.update_cursor();break;case 18:E("3D5 / vdisp enable end write: "+L(e),Q),(this.vertical_display_enable_end&255)!==e&&(this.vertical_display_enable_end=this.vertical_display_enable_end&768|e,this.update_vga_size());break;case 19:E("3D5 / offset register write: "+L(e),Q),this.offset_register!==e&&(this.offset_register=e,this.update_vga_size(),~this.crtc_mode&3&&this.complete_replot());break;case 20:E("3D5 / underline location write: "+L(e),Q),this.underline_location_register!==e&&(t=this.underline_location_register,this.underline_location_register=e,this.update_vga_size(),(t^e)&64&&this.complete_replot());break;case 21:E("3D5 / vertical blank start write: "+L(e),Q),(this.vertical_blank_start&255)!==e&&(this.vertical_blank_start=this.vertical_blank_start&768|e,this.update_vga_size());break;case 23:E("3D5 / crtc mode write: "+L(e),Q),this.crtc_mode!==e&&(t=this.crtc_mode,this.crtc_mode=e,this.update_vga_size(),(t^e)&67&&this.complete_replot());break;case 24:E("3D5 / line compare write: "+L(e),Q),this.line_compare=this.line_compare&768|e,this.update_layers();break;default:this.index_crtc<this.crtc.length&&(this.crtc[this.index_crtc]=e),E("3D5 / CRTC write "+L(this.index_crtc)+": "+L(e),Q)}};ne.prototype.port3D5_read=function(){switch(E("3D5 read "+L(this.index_crtc),Q),this.index_crtc){case 1:return this.horizontal_display_enable_end;case 2:return this.horizontal_blank_start;case 7:return this.vertical_display_enable_end>>7&2|this.vertical_blank_start>>5&8|this.line_compare>>4&16|this.vertical_display_enable_end>>3&64;case 8:return this.preset_row_scan;case 9:return this.max_scan_line;case 10:return this.cursor_scanline_start;case 11:return this.cursor_scanline_end;case 12:return this.start_address&255;case 13:return this.start_address>>8;case 14:return this.cursor_address>>8;case 15:return this.cursor_address&255;case 18:return this.vertical_display_enable_end&255;case 19:return this.offset_register;case 20:return this.underline_location_register;case 21:return this.vertical_blank_start&255;case 23:return this.crtc_mode;case 24:return this.line_compare&255}return this.index_crtc<this.crtc.length?this.crtc[this.index_crtc]:0};ne.prototype.port3DA_read=function(){E("3DA read - status 1 and clear attr index",Q);var e=this.port_3DA_value;return this.graphical_mode?(this.port_3DA_value^=1,this.port_3DA_value&=1):(this.port_3DA_value&1&&(this.port_3DA_value^=8),this.port_3DA_value^=1),this.attribute_controller_index=-1,e};ne.prototype.port1CE_write=function(e){this.dispi_index=e};ne.prototype.port1CF_write=function(e){switch(E("1CF / dispi write "+L(this.dispi_index)+": "+L(e),Q),this.dispi_index){case 1:this.svga_width=e,this.svga_width>Fr&&(E("svga_width reduced from "+this.svga_width+" to "+Fr,Q),this.svga_width=Fr);break;case 2:this.svga_height=e,this.svga_height>Ur&&(E("svga_height reduced from "+this.svga_height+" to "+Ur,Q),this.svga_height=Ur);break;case 3:this.svga_bpp=e;break;case 4:this.svga_enabled=(e&1)===1,this.dispi_enable_value=e;break;case 5:E("SVGA bank offset: "+L(e<<16),Q),this.svga_bank_offset=e<<16;break;case 9:const t=e*this.svga_width;E("SVGA offset: "+L(t)+" y="+L(e),Q),this.svga_offset!==t&&(this.svga_offset=t,this.complete_redraw())}!this.svga_enabled||this.svga_width&&this.svga_height||(E("SVGA: disabled because of invalid width/height: "+this.svga_width+"x"+this.svga_height,Q),this.svga_enabled=!1),this.svga_bpp,this.svga_bpp===4||this.svga_bpp===8||this.svga_bpp===15||this.svga_bpp===16||this.svga_bpp===24||this.svga_bpp,""+this.svga_bpp,E("SVGA: enabled="+this.svga_enabled+", "+this.svga_width+"x"+this.svga_height+"x"+this.svga_bpp,Q),this.svga_enabled&&this.dispi_index===4&&(this.set_size_graphical(this.svga_width,this.svga_height,this.svga_bpp,this.svga_width,this.svga_height),this.bus.send("screen-set-mode",!0),this.graphical_mode_is_linear=this.graphical_mode=!0),this.svga_enabled||(this.svga_bank_offset=0),this.update_layers()};ne.prototype.port1CF_read=function(){return E("1CF / dispi read "+L(this.dispi_index),Q),this.svga_register_read(this.dispi_index)};ne.prototype.svga_register_read=function(e){switch(e){case 0:return 45248;case 1:return this.dispi_enable_value&2?Fr:this.svga_width;case 2:return this.dispi_enable_value&2?Ur:this.svga_height;case 3:return this.dispi_enable_value&2?Ea:this.svga_bpp;case 4:return this.dispi_enable_value;case 5:return this.svga_bank_offset>>>16;case 6:return this.screen_width?this.screen_width:1;case 8:return 0;case 10:return this.vga_memory_size/rt|0}return 255};ne.prototype.vga_replot=function(){for(var e=this.diff_plot_min&-16,t=Math.min(this.diff_plot_max|15,Di-1),i=this.vga_addr_shift_count(),s=~this.crtc_mode&3,a=this.planar_mode&96,r=this.attribute_mode&64;e<=t;){var u=e>>>i;if(s){var o=e/this.virtual_width|0,l=e-this.virtual_width*o;switch(s){case 1:u=(o&1)<<13,o>>>=1;break;case 2:u=(o&1)<<14,o>>>=1;break;case 3:u=(o&3)<<13,o>>>=2}u|=(o*this.virtual_width+l>>>i)+this.start_address}o=this.plane0[u],l=this.plane1[u];var f=this.plane2[u],m=this.plane3[u];switch(u=new Uint8Array(8),a){case 0:o<<=0,l<<=1,f<<=2,m<<=3;for(var C=7;0<=C;C--)u[7-C]=o>>C&1|l>>C&2|f>>C&4|m>>C&8;break;case 32:u[0]=o>>6&3|f>>4&12,u[1]=o>>4&3|f>>2&12,u[2]=o>>2&3|f>>0&12,u[3]=o>>0&3|f<<2&12,u[4]=l>>6&3|m>>4&12,u[5]=l>>4&3|m>>2&12,u[6]=l>>2&3|m>>0&12,u[7]=l>>0&3|m<<2&12;break;case 64:case 96:u[0]=o>>4&15,u[1]=o>>0&15,u[2]=l>>4&15,u[3]=l>>0&15,u[4]=f>>4&15,u[5]=f>>0&15,u[6]=m>>4&15,u[7]=m>>0&15}if(r)for(o=C=0;4>C;C++,e++,o+=2)this.pixel_buffer[e]=u[o]<<4|u[o+1];else for(C=0;8>C;C++,e++)this.pixel_buffer[e]=u[C]}};ne.prototype.vga_redraw=function(){var e=this.diff_addr_min,t=Math.min(this.diff_addr_max,Di-1);const i=new Int32Array(this.cpu.wasm_memory.buffer,this.dest_buffet_offset,this.virtual_width*this.virtual_height);var s=255,a=0;if(this.attribute_mode&128&&(s&=207,a|=this.color_select<<4&48),this.attribute_mode&64)for(;e<=t;e++){var r=this.pixel_buffer[e]&s|a;r=this.vga256_palette[r],i[e]=r&65280|r<<16|r>>16|4278190080}else for(s&=63,a|=this.color_select<<4&192;e<=t;e++)r=this.dac_map[this.pixel_buffer[e]&this.color_plane_enable]&s|a,r=this.vga256_palette[r],i[e]=r&65280|r<<16|r>>16|4278190080};ne.prototype.screen_fill_buffer=function(){if(this.graphical_mode){if(this.image_data.data.byteLength===0){var e=new Uint8ClampedArray(this.cpu.wasm_memory.buffer,this.dest_buffet_offset,4*this.virtual_width*this.virtual_height);this.image_data=new ImageData(e,this.virtual_width,this.virtual_height),this.update_layers()}if(this.svga_enabled){e=0;let s=this.svga_height;if(this.svga_bpp===8){const a=new Int32Array(this.cpu.wasm_memory.buffer,this.dest_buffet_offset,this.screen_width*this.screen_height),r=new Uint8Array(this.cpu.wasm_memory.buffer,this.svga_memory.byteOffset,this.vga_memory_size);for(var t=0;t<a.length;t++){var i=this.vga256_palette[r[t]];a[t]=i&65280|i<<16|i>>16|4278190080}}else this.cpu.svga_fill_pixel_buffer(this.svga_bpp,this.svga_offset),t=this.svga_bpp===15?2:this.svga_bpp/8,e=((this.cpu.svga_dirty_bitmap_min_offset[0]/t|0)-this.svga_offset)/this.svga_width|0,s=(((this.cpu.svga_dirty_bitmap_max_offset[0]/t|0)-this.svga_offset)/this.svga_width|0)+1;e<s&&(e=Math.max(e,0),s=Math.min(s,this.svga_height),this.bus.send("screen-fill-buffer-end",[{image_data:this.image_data,screen_x:0,screen_y:e,buffer_x:0,buffer_y:e,buffer_width:this.svga_width,buffer_height:s-e}]))}else this.vga_replot(),this.vga_redraw(),this.bus.send("screen-fill-buffer-end",this.layers);this.reset_diffs()}this.update_vertical_retrace()};function Je(e,t){this.cpu=e,this.bus=t,this.use_mouse=this.enable_mouse_stream=!1,this.have_mouse=!0,this.mouse_clicks=this.mouse_delta_y=this.mouse_delta_x=0,this.have_keyboard=!0,this.next_read_resolution=this.next_read_rate=this.next_handle_scan_code_set=this.next_read_led=this.next_read_sample=this.next_is_mouse_command=this.enable_keyboard_stream=!1,this.kbd_buffer=new _i(1024),this.last_port60_byte=0,this.sample_rate=100,this.mouse_id=this.mouse_detect_state=0,this.mouse_reset_workaround=!1,this.wheel_movement=0,this.resolution=4,this.scaling2=!1,this.last_mouse_packet=-1,this.mouse_buffer=new _i(1024),this.next_byte_is_aux=this.next_byte_is_ready=!1,this.bus.register("keyboard-code",function(i){this.kbd_send_code(i)},this),this.bus.register("mouse-click",function(i){this.mouse_send_click(i[0],i[1],i[2])},this),this.bus.register("mouse-delta",function(i){this.mouse_send_delta(i[0],i[1])},this),this.bus.register("mouse-wheel",function(i){this.wheel_movement-=i[0],this.wheel_movement-=2*i[1],this.wheel_movement=Math.min(7,Math.max(-8,this.wheel_movement)),this.send_mouse_packet(0,0)},this),this.command_register=5,this.controller_output_port=0,this.read_controller_output_port=this.read_command_register=this.read_output_register=!1,e.io.register_read(96,this,this.port60_read),e.io.register_read(100,this,this.port64_read),e.io.register_write(96,this,this.port60_write),e.io.register_write(100,this,this.port64_write)}Je.prototype.get_state=function(){var e=[];return e[0]=this.enable_mouse_stream,e[1]=this.use_mouse,e[2]=this.have_mouse,e[3]=this.mouse_delta_x,e[4]=this.mouse_delta_y,e[5]=this.mouse_clicks,e[6]=this.have_keyboard,e[7]=this.enable_keyboard_stream,e[8]=this.next_is_mouse_command,e[9]=this.next_read_sample,e[10]=this.next_read_led,e[11]=this.next_handle_scan_code_set,e[12]=this.next_read_rate,e[13]=this.next_read_resolution,e[15]=this.last_port60_byte,e[16]=this.sample_rate,e[17]=this.resolution,e[18]=this.scaling2,e[20]=this.command_register,e[21]=this.read_output_register,e[22]=this.read_command_register,e[23]=this.controller_output_port,e[24]=this.read_controller_output_port,e[25]=this.mouse_id,e[26]=this.mouse_detect_state,e[27]=this.mouse_reset_workaround,e};Je.prototype.set_state=function(e){this.enable_mouse_stream=e[0],this.use_mouse=e[1],this.have_mouse=e[2],this.mouse_delta_x=e[3],this.mouse_delta_y=e[4],this.mouse_clicks=e[5],this.have_keyboard=e[6],this.enable_keyboard_stream=e[7],this.next_is_mouse_command=e[8],this.next_read_sample=e[9],this.next_read_led=e[10],this.next_handle_scan_code_set=e[11],this.next_read_rate=e[12],this.next_read_resolution=e[13],this.last_port60_byte=e[15],this.sample_rate=e[16],this.resolution=e[17],this.scaling2=e[18],this.command_register=e[20],this.read_output_register=e[21],this.read_command_register=e[22],this.controller_output_port=e[23],this.read_controller_output_port=e[24],this.mouse_id=e[25]||0,this.mouse_detect_state=e[26]||0,this.mouse_reset_workaround=e[27]||!1,this.next_byte_is_aux=this.next_byte_is_ready=!1,this.kbd_buffer.clear(),this.mouse_buffer.clear(),this.bus.send("mouse-enable",this.use_mouse)};Je.prototype.raise_irq=function(){this.next_byte_is_ready||(this.kbd_buffer.length?this.kbd_irq():this.mouse_buffer.length&&this.mouse_irq())};Je.prototype.mouse_irq=function(){this.next_byte_is_aux=this.next_byte_is_ready=!0,this.command_register&2&&(E("Mouse irq",Se),this.cpu.device_lower_irq(12),this.cpu.device_raise_irq(12))};Je.prototype.kbd_irq=function(){this.next_byte_is_ready=!0,this.next_byte_is_aux=!1,this.command_register&1&&(E("Keyboard irq",Se),this.cpu.device_lower_irq(1),this.cpu.device_raise_irq(1))};Je.prototype.kbd_send_code=function(e){this.enable_keyboard_stream&&(E("adding kbd code: "+L(e),Se),this.kbd_buffer.push(e),this.raise_irq())};Je.prototype.mouse_send_delta=function(e,t){if(this.have_mouse&&this.use_mouse){var i=this.resolution*this.sample_rate/80;this.mouse_delta_x+=e*i,this.mouse_delta_y+=t*i,this.enable_mouse_stream&&(e=this.mouse_delta_x|0,t=this.mouse_delta_y|0,e||t)&&(this.mouse_delta_x-=e,this.mouse_delta_y-=t,this.send_mouse_packet(e,t))}};Je.prototype.mouse_send_click=function(e,t,i){this.have_mouse&&this.use_mouse&&(this.mouse_clicks=e|i<<1|t<<2,this.enable_mouse_stream&&this.send_mouse_packet(0,0))};Je.prototype.send_mouse_packet=function(e,t){var i=(0>t)<<5|(0>e)<<4|8|this.mouse_clicks;this.last_mouse_packet=Date.now(),this.mouse_buffer.push(i),this.mouse_buffer.push(e),this.mouse_buffer.push(t),this.mouse_id===4?(this.mouse_buffer.push(0|this.wheel_movement&15),this.wheel_movement=0):this.mouse_id===3&&(this.mouse_buffer.push(this.wheel_movement&255),this.wheel_movement=0),this.raise_irq()};Je.prototype.apply_scaling2=function(e){var t=e>>31;switch(Math.abs(e)){case 0:case 1:case 3:return e;case 2:return t;case 4:return 6*t;case 5:return 9*t;default:return e<<1}};Je.prototype.port60_read=function(){return this.next_byte_is_ready=!1,!this.kbd_buffer.length&&!this.mouse_buffer.length?(E("Port 60 read: Empty",Se),this.last_port60_byte):(this.next_byte_is_aux?(this.cpu.device_lower_irq(12),this.last_port60_byte=this.mouse_buffer.shift(),E("Port 60 read (mouse): "+L(this.last_port60_byte),Se)):(this.cpu.device_lower_irq(1),this.last_port60_byte=this.kbd_buffer.shift(),E("Port 60 read (kbd)  : "+L(this.last_port60_byte),Se)),(this.kbd_buffer.length||this.mouse_buffer.length)&&this.raise_irq(),this.last_port60_byte)};Je.prototype.port64_read=function(){var e=16;return this.next_byte_is_ready&&(e|=1),this.next_byte_is_aux&&(e|=32),E("port 64 read: "+L(e),Se),e};Je.prototype.port60_write=function(e){if(E("port 60 write: "+L(e),Se),this.read_command_register)this.command_register=e,this.read_command_register=!1,E("Keyboard command register = "+L(this.command_register),Se);else if(this.read_output_register)this.read_output_register=!1,this.mouse_buffer.clear(),this.mouse_buffer.push(e),this.mouse_irq();else if(this.next_read_sample){switch(this.next_read_sample=!1,this.mouse_buffer.clear(),this.mouse_buffer.push(250),this.sample_rate=e,this.mouse_detect_state){case-1:e===60?(this.mouse_reset_workaround=!0,this.mouse_detect_state=0):(this.mouse_reset_workaround=!1,this.mouse_detect_state=e===200?1:0);break;case 0:e===200&&(this.mouse_detect_state=1);break;case 1:this.mouse_detect_state=e===100?2:e===200?3:0;break;case 2:e===80&&(this.mouse_id=3),this.mouse_detect_state=-1;break;case 3:e===80&&(this.mouse_id=4),this.mouse_detect_state=-1}E("mouse sample rate: "+L(e)+", mouse id: "+L(this.mouse_id),Se),this.sample_rate||(E("invalid sample rate, reset to 100",Se),this.sample_rate=100),this.mouse_irq()}else if(this.next_read_resolution)this.next_read_resolution=!1,this.mouse_buffer.clear(),this.mouse_buffer.push(250),3<e?(this.resolution=4,E("invalid resolution, resetting to 4",Se)):(this.resolution=1<<e,E("resolution: "+this.resolution,Se)),this.mouse_irq();else if(this.next_read_led)this.next_read_led=!1,this.kbd_buffer.push(250),this.kbd_irq();else if(this.next_handle_scan_code_set)this.next_handle_scan_code_set=!1,this.kbd_buffer.push(250),this.kbd_irq(),e||this.kbd_buffer.push(2);else if(this.next_read_rate)this.next_read_rate=!1,this.kbd_buffer.push(250),this.kbd_irq();else if(this.next_is_mouse_command){if(this.next_is_mouse_command=!1,E("Port 60 data register write: "+L(e),Se),this.have_mouse){switch(this.kbd_buffer.clear(),this.mouse_buffer.clear(),this.mouse_buffer.push(250),e){case 230:E("Scaling 1:1",Se),this.scaling2=!1;break;case 231:E("Scaling 2:1",Se),this.scaling2=!0;break;case 232:this.next_read_resolution=!0;break;case 233:this.send_mouse_packet(0,0);break;case 235:E("unimplemented request single packet",Se),this.send_mouse_packet(0,0);break;case 242:E("required id: "+L(this.mouse_id),Se),this.mouse_buffer.push(this.mouse_id),this.mouse_clicks=this.mouse_delta_x=this.mouse_delta_y=0,this.raise_irq();break;case 243:this.next_read_sample=!0;break;case 244:this.use_mouse=this.enable_mouse_stream=!0,this.bus.send("mouse-enable",!0),this.mouse_clicks=this.mouse_delta_x=this.mouse_delta_y=0;break;case 245:this.enable_mouse_stream=!1;break;case 246:this.enable_mouse_stream=!1,this.sample_rate=100,this.scaling2=!1,this.resolution=4;break;case 255:E("Mouse reset",Se),this.mouse_buffer.push(170),this.mouse_buffer.push(0),this.use_mouse=!0,this.bus.send("mouse-enable",!0),this.enable_mouse_stream=!1,this.sample_rate=100,this.scaling2=!1,this.resolution=4,this.mouse_reset_workaround||(this.mouse_id=0),this.mouse_clicks=this.mouse_delta_x=this.mouse_delta_y=0;break;default:E("Unimplemented mouse command: "+L(e),Se)}this.mouse_irq()}}else if(this.read_controller_output_port)this.read_controller_output_port=!1,this.controller_output_port=e;else{switch(E("Port 60 data register write: "+L(e),Se),this.mouse_buffer.clear(),this.kbd_buffer.clear(),this.kbd_buffer.push(250),e){case 237:this.next_read_led=!0;break;case 240:this.next_handle_scan_code_set=!0;break;case 242:this.kbd_buffer.push(171),this.kbd_buffer.push(83);break;case 243:this.next_read_rate=!0;break;case 244:E("kbd enable scanning",Se),this.enable_keyboard_stream=!0;break;case 245:E("kbd disable scanning",Se),this.enable_keyboard_stream=!1;break;case 246:break;case 255:this.kbd_buffer.clear(),this.kbd_buffer.push(250),this.kbd_buffer.push(170),this.kbd_buffer.push(0);break;default:E("Unimplemented keyboard command: "+L(e),Se)}this.kbd_irq()}};Je.prototype.port64_write=function(e){switch(E("port 64 write: "+L(e),Se),e){case 32:this.kbd_buffer.clear(),this.mouse_buffer.clear(),this.kbd_buffer.push(this.command_register),this.kbd_irq();break;case 96:this.read_command_register=!0;break;case 209:this.read_controller_output_port=!0;break;case 211:this.read_output_register=!0;break;case 212:this.next_is_mouse_command=!0;break;case 167:E("Disable second port",Se),this.command_register|=32;break;case 168:E("Enable second port",Se),this.command_register&=-33;break;case 169:this.kbd_buffer.clear(),this.mouse_buffer.clear(),this.kbd_buffer.push(0),this.kbd_irq();break;case 170:this.kbd_buffer.clear(),this.mouse_buffer.clear(),this.kbd_buffer.push(85),this.kbd_irq();break;case 171:this.kbd_buffer.clear(),this.mouse_buffer.clear(),this.kbd_buffer.push(0),this.kbd_irq();break;case 173:E("Disable Keyboard",Se),this.command_register|=16;break;case 174:E("Enable Keyboard",Se),this.command_register&=-17;break;case 254:E("CPU reboot via PS2"),this.cpu.reboot_internal();break;default:E("port 64: Unimplemented command byte: "+L(e),Se)}};var Ls=!1;function Lt(e,t){this.irq_value=this.irr=this.isr=this.irq_map=this.irq_mask=0,this.requested_irq=-1,this.master=t,this.is_master=this.master===void 0,this.slave=void 0,this.name=this.is_master?"master":"slave ",this.expect_icw4=!1,this.read_isr=this.state=0,this.auto_eoi=1,this.elcr=this.special_mask_mode=0,this.cpu=e,this.is_master?(this.slave=new Lt(this.cpu,this),this.check_irqs=function(){if(0<=this.requested_irq)this.cpu.handle_irqs();else{var i=this.irr&this.irq_mask;if(i){i&=-i;var s=this.special_mask_mode?this.irq_mask:-1;this.isr&&(this.isr&-this.isr&s)<=i?E("master> higher prio: isr="+L(this.isr,2)+" mask="+L(this.irq_mask&255,2)+" irq="+L(i,2),Pe):(s=V.int_log2_byte(i),this.requested_irq=s,this.cpu.handle_irqs())}}},this.acknowledge_irq=function(){if(this.requested_irq!==-1)if(this.irr===0)this.requested_irq=-1;else{this.irr,0<=this.requested_irq;var i=1<<this.requested_irq;!(this.elcr&i)&&(this.irr&=~i),this.auto_eoi||(this.isr|=i),this.requested_irq===2?this.slave.acknowledge_irq():this.cpu.pic_call_irq(this.irq_map|this.requested_irq),this.requested_irq=-1,this.check_irqs()}}):(this.check_irqs=function(){if(0<=this.requested_irq)this.cpu.handle_irqs();else{var i=this.irr&this.irq_mask;if(i){i&=-i;var s=this.special_mask_mode?this.irq_mask:-1;this.isr&&(this.isr&-this.isr&s)<=i||(s=V.int_log2_byte(i),this.requested_irq=s,this.master.set_irq(2))}}},this.acknowledge_irq=function(){if(this.requested_irq!==-1)if(this.irr===0)this.requested_irq=-1,this.master.irq_value&=-5,this.cpu.pic_call_irq(this.irq_map|7);else{this.irr,0<=this.requested_irq;var i=1<<this.requested_irq;!(this.elcr&i)&&(this.irr&=~i),this.auto_eoi||(this.isr|=i),this.master.irq_value&=-5,this.cpu.pic_call_irq(this.irq_map|this.requested_irq),this.requested_irq=-1,this.check_irqs()}}),this.dump=function(){E("mask: "+L(this.irq_mask&255),Pe),E("base: "+L(this.irq_map),Pe),E("requested: "+L(this.irr),Pe),E("serviced: "+L(this.isr),Pe),this.is_master&&this.slave.dump()},this.is_master?(e=32,t=1232):(e=160,t=1233),this.cpu.io.register_write(e,this,this.port20_write),this.cpu.io.register_read(e,this,this.port20_read),this.cpu.io.register_write(e|1,this,this.port21_write),this.cpu.io.register_read(e|1,this,this.port21_read),this.cpu.io.register_write(t,this,this.port4D0_write),this.cpu.io.register_read(t,this,this.port4D0_read),this.is_master?(this.set_irq=function(i){if(8<=i)this.slave.set_irq(i-8);else{var s=1<<i;this.irq_value&s||(this.irr|=s,this.irq_value|=s,this.check_irqs())}},this.clear_irq=function(i){8<=i?this.slave.clear_irq(i-8):(i=1<<i,this.irq_value&i&&(this.irq_value&=~i,this.irr&=~i,this.check_irqs()))}):(this.set_irq=function(i){var s=1<<i;this.irq_value&s||(this.irr|=s,this.irq_value|=s,this.check_irqs())},this.clear_irq=function(i){i=1<<i,this.irq_value&i&&(this.irq_value&=~i,this.irr&=~i,this.check_irqs())}),this.get_isr=function(){return this.isr}}Lt.prototype.get_state=function(){var e=[];return e[0]=this.irq_mask,e[1]=this.irq_map,e[2]=this.isr,e[3]=this.irr,e[4]=this.is_master,e[5]=this.slave,e[6]=this.expect_icw4,e[7]=this.state,e[8]=this.read_isr,e[9]=this.auto_eoi,e[10]=this.elcr,e};Lt.prototype.set_state=function(e){this.irq_mask=e[0],this.irq_map=e[1],this.isr=e[2],this.irr=e[3],this.is_master=e[4],this.slave&&this.slave.set_state(e[5]),this.expect_icw4=e[6],this.state=e[7],this.read_isr=e[8],this.auto_eoi=e[9],this.elcr=e[10]};Lt.prototype.port20_write=function(e){if(e&16)E("icw1 = "+L(e),Pe),this.irq_value=this.irq_mask=this.irr=this.isr=0,this.auto_eoi=1,this.requested_irq=-1,this.expect_icw4=e&1,this.state=1;else if(e&8)E("ocw3: "+L(e),Pe),e&2&&(this.read_isr=e&1),e&64&&(this.special_mask_mode=(e&32)===32,E("special mask mode: "+this.special_mask_mode,Pe));else{E("eoi: "+L(e)+" ("+this.name+")",Pe);var t=e>>5;t===1?(this.isr&=this.isr-1,E("new isr: "+L(this.isr,2),Pe)):t===3?this.isr&=~(1<<(e&7)):(e&200)===192?E("lowest priority: "+L(e&7),Pe):(E("Unknown eoi: "+L(e),Pe),this.isr&=this.isr-1),this.check_irqs()}};Lt.prototype.port20_read=function(){return this.read_isr?(E("read port 20h (isr): "+L(this.isr),Pe),this.isr):(E("read port 20h (irr): "+L(this.irr),Pe),this.irr)};Lt.prototype.port21_write=function(e){this.state===0?this.expect_icw4?(this.expect_icw4=!1,this.auto_eoi=e&2,E("icw4: "+L(e)+" autoeoi="+this.auto_eoi,Pe),!(e&1)&&void 0):(this.irq_mask=~e,this.check_irqs()):this.state===1?(this.irq_map=e,E("interrupts are mapped to "+L(this.irq_map)+" ("+this.name+")",Pe),this.state++):this.state===2&&(this.state=0,E("icw3: "+L(e),Pe))};Lt.prototype.port21_read=function(){return E("21h read "+L(~this.irq_mask&255),Pe),~this.irq_mask&255};Lt.prototype.port4D0_read=function(){return E("elcr read: "+L(this.elcr,2),Pe),this.elcr};Lt.prototype.port4D0_write=function(e){E("elcr write: "+L(e,2),Pe),this.elcr=e};var xa=0,gn=1,ka=2,yn=3,Aa=4,bn=5,La=7,Ra=8,Oa=9,Ta=10,Ma=11,Da=12,Ia=13,wn=16,Sn=18,Pa=20,Ba=21,qa=22,Fa=23,Ua=24,Ha=27,Na=48,za=49,ja=50,Wa=52,Ga=53,Ka=56,Cn=57,Va=61,Xa=91,Ya=92,Za=93,Ja=95;function ut(e){this.cpu=e,this.cmos_index=0,this.cmos_data=new Uint8Array(128),this.last_update=this.rtc_time=Date.now(),this.next_interrupt_alarm=this.next_interrupt=0,this.periodic_interrupt=!1,this.periodic_interrupt_time=.9765625,this.cmos_a=38,this.cmos_b=2,this.nmi_disabled=this.cmos_c=0,e.io.register_write(112,this,function(t){this.cmos_index=t&127,this.nmi_disabled=t>>7}),e.io.register_write(113,this,this.cmos_port_write),e.io.register_read(113,this,this.cmos_port_read)}ut.prototype.get_state=function(){var e=[];return e[0]=this.cmos_index,e[1]=this.cmos_data,e[2]=this.rtc_time,e[3]=this.last_update,e[4]=this.next_interrupt,e[5]=this.next_interrupt_alarm,e[6]=this.periodic_interrupt,e[7]=this.periodic_interrupt_time,e[8]=this.cmos_a,e[9]=this.cmos_b,e[10]=this.cmos_c,e[11]=this.nmi_disabled,e};ut.prototype.set_state=function(e){this.cmos_index=e[0],this.cmos_data=e[1],this.rtc_time=e[2],this.last_update=e[3],this.next_interrupt=e[4],this.next_interrupt_alarm=e[5],this.periodic_interrupt=e[6],this.periodic_interrupt_time=e[7],this.cmos_a=e[8],this.cmos_b=e[9],this.cmos_c=e[10],this.nmi_disabled=e[11]};ut.prototype.timer=function(e,t){return e=Date.now(),this.rtc_time+=e-this.last_update,this.last_update=e,this.periodic_interrupt&&this.next_interrupt<e?(this.cpu.device_raise_irq(8),this.cmos_c|=192,this.next_interrupt+=this.periodic_interrupt_time*Math.ceil((e-this.next_interrupt)/this.periodic_interrupt_time)):this.next_interrupt_alarm&&this.next_interrupt_alarm<e&&(this.cpu.device_raise_irq(8),this.cmos_c|=160,this.next_interrupt_alarm=0),t=100,this.periodic_interrupt&&this.next_interrupt&&(t=Math.min(t,Math.max(0,this.next_interrupt-e))),this.next_interrupt_alarm&&(t=Math.min(t,Math.max(0,this.next_interrupt_alarm-e))),t};ut.prototype.bcd_pack=function(e){for(var t=0,i=0,s;e;)s=e%10,i|=s<<4*t,t++,e=(e-s)/10;return i};ut.prototype.bcd_unpack=function(e){const t=e&15,i=e>>4&15;return t+10*i};ut.prototype.encode_time=function(e){return this.cmos_b&4?e:this.bcd_pack(e)};ut.prototype.decode_time=function(e){return this.cmos_b&4?e:this.bcd_unpack(e)};ut.prototype.cmos_port_read=function(){var e=this.cmos_index;switch(e){case xa:return this.encode_time(new Date(this.rtc_time).getUTCSeconds());case ka:return this.encode_time(new Date(this.rtc_time).getUTCMinutes());case Aa:return this.encode_time(new Date(this.rtc_time).getUTCHours());case La:return this.encode_time(new Date(this.rtc_time).getUTCDate());case Ra:return this.encode_time(new Date(this.rtc_time).getUTCMonth()+1);case Oa:return this.encode_time(new Date(this.rtc_time).getUTCFullYear()%100);case Ta:return this.cmos_a;case Ma:return this.cmos_b;case Da:return this.cpu.device_lower_irq(8),E("cmos reg C read",Wt),e=this.cmos_c,this.cmos_c&=-241,e;case Ia:return 0;case ja:return this.encode_time(new Date(this.rtc_time).getUTCFullYear()/100|0);default:return E("cmos read from index "+L(e),Wt),this.cmos_data[this.cmos_index]}};ut.prototype.cmos_port_write=function(e){switch(this.cmos_index){case 10:this.cmos_a=e&127,this.periodic_interrupt_time=1e3/(32768>>(this.cmos_a&15)-1),E("Periodic interrupt, a="+L(this.cmos_a,2)+" t="+this.periodic_interrupt_time,Wt);break;case 11:if(this.cmos_b=e,this.cmos_b&64&&(this.next_interrupt=Date.now()),this.cmos_b&32){e=new Date;const t=this.decode_time(this.cmos_data[gn]),i=this.decode_time(this.cmos_data[yn]),s=this.decode_time(this.cmos_data[bn]),a=new Date(Date.UTC(e.getUTCFullYear(),e.getUTCMonth(),e.getUTCDate(),s,i,t));E("RTC alarm scheduled for "+a+" hh:mm:ss="+s+":"+i+":"+t+" ms_from_now="+(a-e),Wt),this.next_interrupt_alarm=+a}this.cmos_b&16&&E("Unimplemented: updated interrupt",Wt),E("cmos b="+L(this.cmos_b,2),Wt);break;case gn:case yn:case bn:this.cmos_write(this.cmos_index,e);break;default:E("cmos write index "+L(this.cmos_index)+": "+L(e),Wt)}this.periodic_interrupt=(this.cmos_b&64)===64&&0<(this.cmos_a&15)};ut.prototype.cmos_read=function(e){return this.cmos_data[e]};ut.prototype.cmos_write=function(e,t){E("cmos "+L(e)+" <- "+L(t),Wt),this.cmos_data[e]=t};var Hr=128,Qa=8,$a=2,En=1,xn=0,so=1,Tt=2,zr=4,jr=12,no=1,eh=32,th=64;function pt(e,t,i){switch(this.bus=i,this.cpu=e,this.ints=1<<Tt,this.line_control=this.baud_rate=0,this.lsr=th|eh,this.ier=this.fifo_control=0,this.iir=so,this.irq=this.scratch_register=this.modem_status=this.modem_control=0,this.input=new _i(4096),this.current_line=[],t){case 1016:this.com=0,this.irq=4;break;case 760:this.com=1,this.irq=3;break;case 1e3:this.com=2,this.irq=4;break;case 744:this.irq=this.com=3;break;default:E("Invalid serial port: "+L(t),Ke),this.com=0,this.irq=4}this.bus.register("serial"+this.com+"-input",function(s){this.data_received(s)},this),e=e.io,e.register_write(t,this,function(s){this.write_data(s)},function(s){this.write_data(s&255),this.write_data(s>>8)}),e.register_write(t|1,this,function(s){this.line_control&Hr?(this.baud_rate=this.baud_rate&255|s<<8,E("baud rate: "+L(this.baud_rate),Ke)):(!(this.ier&Tt)&&s&Tt&&this.ThrowInterrupt(Tt),this.ier=s&15,E("interrupt enable: "+L(s),Ke),this.CheckInterrupt())}),e.register_read(t,this,function(){if(this.line_control&Hr)return this.baud_rate&255;var s=this.input.shift();return E(s===-1?"Read input empty":"Read input: "+L(s),Ke),this.input.length===0&&(this.lsr&=~no,this.ClearInterrupt(jr),this.ClearInterrupt(zr)),s}),e.register_read(t|1,this,function(){return this.line_control&Hr?this.baud_rate>>8:this.ier&15}),e.register_read(t|2,this,function(){var s=this.iir&15;return E("read interrupt identification: "+L(this.iir),Ke),this.iir==Tt&&this.ClearInterrupt(Tt),this.fifo_control&1&&(s|=192),s}),e.register_write(t|2,this,function(s){E("fifo control: "+L(s),Ke),this.fifo_control=s}),e.register_read(t|3,this,function(){return E("read line control: "+L(this.line_control),Ke),this.line_control}),e.register_write(t|3,this,function(s){E("line control: "+L(s),Ke),this.line_control=s}),e.register_read(t|4,this,function(){return this.modem_control}),e.register_write(t|4,this,function(s){E("modem control: "+L(s),Ke),this.modem_control=s}),e.register_read(t|5,this,function(){return E("read line status: "+L(this.lsr),Ke),this.lsr}),e.register_write(t|5,this,function(s){E("Factory test write",Ke)}),e.register_read(t|6,this,function(){return E("read modem status: "+L(this.modem_status),Ke),this.modem_status}),e.register_write(t|6,this,function(s){E("Unkown register write (base+6)",Ke)}),e.register_read(t|7,this,function(){return this.scratch_register}),e.register_write(t|7,this,function(s){this.scratch_register=s})}pt.prototype.get_state=function(){var e=[];return e[0]=this.ints,e[1]=this.baud_rate,e[2]=this.line_control,e[3]=this.lsr,e[4]=this.fifo_control,e[5]=this.ier,e[6]=this.iir,e[7]=this.modem_control,e[8]=this.modem_status,e[9]=this.scratch_register,e[10]=this.irq,e};pt.prototype.set_state=function(e){this.ints=e[0],this.baud_rate=e[1],this.line_control=e[2],this.lsr=e[3],this.fifo_control=e[4],this.ier=e[5],this.iir=e[6],this.modem_control=e[7],this.modem_status=e[8],this.scratch_register=e[9],this.irq=e[10]};pt.prototype.CheckInterrupt=function(){this.ints&1<<jr&&this.ier&En?(this.iir=jr,this.cpu.device_raise_irq(this.irq)):this.ints&1<<zr&&this.ier&En?(this.iir=zr,this.cpu.device_raise_irq(this.irq)):this.ints&1<<Tt&&this.ier&$a?(this.iir=Tt,this.cpu.device_raise_irq(this.irq)):this.ints&1<<xn&&this.ier&Qa?(this.iir=xn,this.cpu.device_raise_irq(this.irq)):(this.iir=so,this.cpu.device_lower_irq(this.irq))};pt.prototype.ThrowInterrupt=function(e){this.ints|=1<<e,this.CheckInterrupt()};pt.prototype.ClearInterrupt=function(e){this.ints&=~(1<<e),this.CheckInterrupt()};pt.prototype.data_received=function(e){E("input: "+L(e),Ke),this.input.push(e),this.lsr|=no,this.fifo_control&1?this.ThrowInterrupt(jr):this.ThrowInterrupt(zr)};pt.prototype.write_data=function(e){if(this.bus.send("serial"+this.com+"-output-raw",e),this.line_control&Hr)this.baud_rate=this.baud_rate&-256|e;else if(E("data: "+L(e),Ke),this.ThrowInterrupt(Tt),e!==255){var t=String.fromCharCode(e);this.bus.send("serial"+this.com+"-output-char",t),this.current_line.push(e),t===`
`&&(e=String.fromCharCode.apply("",this.current_line).trimRight().replace(/[\x00-\x08\x0b-\x1f\x7f\x80-\xff]/g,""),E("SERIAL: "+e),this.bus.send("serial"+this.com+"-output-line",String.fromCharCode.apply("",this.current_line)),this.current_line=[])}};var kn=3579545;function Ii(e){this.cpu=e;var t=e.io;e.devices.pci.register_device({pci_id:56,pci_space:[134,128,19,113,7,0,128,2,8,0,128,6,0,0,128,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,9,1,0,0],pci_bars:[],name:"acpi"}),this.timer_imprecision_offset=this.timer_last_value=0,this.status=1,this.pm1_enable=this.pm1_status=0,this.last_timer=this.get_timer(be.microtick()),this.gpe=new Uint8Array(4),t.register_read(45056,this,void 0,function(){return E("ACPI pm1_status read",Ve),this.pm1_status}),t.register_write(45056,this,void 0,function(i){E("ACPI pm1_status write: "+L(i,4),Ve),this.pm1_status&=~i}),t.register_read(45058,this,void 0,function(){return E("ACPI pm1_enable read",Ve),this.pm1_enable}),t.register_write(45058,this,void 0,function(i){E("ACPI pm1_enable write: "+L(i),Ve),this.pm1_enable=i}),t.register_read(45060,this,void 0,function(){return E("ACPI status read",Ve),this.status}),t.register_write(45060,this,void 0,function(i){E("ACPI status write: "+L(i),Ve),this.status=i}),t.register_read(45064,this,void 0,void 0,function(){return this.get_timer(be.microtick())&16777215}),t.register_read(45024,this,function(){return E("Read gpe#0",Ve),this.gpe[0]}),t.register_read(45025,this,function(){return E("Read gpe#1",Ve),this.gpe[1]}),t.register_read(45026,this,function(){return E("Read gpe#2",Ve),this.gpe[2]}),t.register_read(45027,this,function(){return E("Read gpe#3",Ve),this.gpe[3]}),t.register_write(45024,this,function(i){E("Write gpe#0: "+L(i),Ve),this.gpe[0]=i}),t.register_write(45025,this,function(i){E("Write gpe#1: "+L(i),Ve),this.gpe[1]=i}),t.register_write(45026,this,function(i){E("Write gpe#2: "+L(i),Ve),this.gpe[2]=i}),t.register_write(45027,this,function(i){E("Write gpe#3: "+L(i),Ve),this.gpe[3]=i})}Ii.prototype.timer=function(e){e=this.get_timer(e);var t=((e^this.last_timer)&8388608)!==0;return this.pm1_enable&1&&t?(E("ACPI raise irq",Ve),this.pm1_status|=1,this.cpu.device_raise_irq(9)):this.cpu.device_lower_irq(9),this.last_timer=e,100};Ii.prototype.get_timer=function(e){return e=Math.round(kn/1e3*e),e===this.timer_last_value?this.timer_imprecision_offset<kn/1e3&&this.timer_imprecision_offset++:(e>this.timer_last_value,this.timer_last_value+this.timer_imprecision_offset<=e?(this.timer_imprecision_offset=0,this.timer_last_value=e):E("Warning: Overshot pmtimer, waiting; current="+e+" last="+this.timer_last_value+" offset="+this.timer_imprecision_offset,Ve)),this.timer_last_value+this.timer_imprecision_offset};Ii.prototype.get_state=function(){var e=[];return e[0]=this.status,e[1]=this.pm1_status,e[2]=this.pm1_enable,e[3]=this.gpe,e};Ii.prototype.set_state=function(e){this.status=e[0],this.pm1_status=e[1],this.pm1_enable=e[2],this.gpe=e[3]};var Wr=!1,Gs=4276092928,ih=393216,rh=0,sh=131072,oo="Fixed (0);Lowest Prio (1);SMI (2);Reserved (3);NMI (4);INIT (5);Reserved (6);ExtINT (7)".split(";"),ao=["physical","logical"];function Xe(e){this.cpu=e,this.timer_divider=this.apic_id=0,this.timer_divider_shift=1,this.timer_current_count=this.timer_initial_count=0,this.next_tick=be.microtick(),this.lvt_error=this.lvt_int1=this.lvt_int0=this.lvt_perf_counter=this.lvt_timer=ri,this.icr1=this.icr0=this.tpr=0,this.irr=new Int32Array(8),this.isr=new Int32Array(8),this.tmr=new Int32Array(8),this.spurious_vector=254,this.destination_format=-1,this.read_error=this.error=this.local_destination=0,e.io.mmap_register(Gs,1048576,t=>{E("Unsupported read8 from apic: "+L(t>>>0),oe);var i=t&3;return this.read32(t&-4)>>8*i&255},(t,i)=>{E("Unsupported write8 from apic: "+L(t)+" <- "+L(i),oe)},t=>this.read32(t),(t,i)=>this.write32(t,i))}Xe.prototype.read32=function(e){switch(e=e-Gs|0,e){case 32:return E("APIC read id",oe),this.apic_id;case 48:return E("APIC read version",oe),327700;case 128:return this.tpr;case 208:return E("Read local destination",oe),this.local_destination;case 224:return E("Read destination format",oe),this.destination_format;case 240:return this.spurious_vector;case 256:case 272:case 288:case 304:case 320:case 336:case 352:case 368:return e=e-256>>4,E("Read isr "+e+": "+L(this.isr[e]>>>0,8),oe),this.isr[e];case 384:case 400:case 416:case 432:case 448:case 464:case 480:case 496:return e=e-384>>4,E("Read tmr "+e+": "+L(this.tmr[e]>>>0,8),oe),this.tmr[e];case 512:case 528:case 544:case 560:case 576:case 592:case 608:case 624:return e=e-512>>4,E("Read irr "+e+": "+L(this.irr[e]>>>0,8),oe),this.irr[e];case 640:return E("Read error: "+L(this.read_error>>>0,8),oe),this.read_error;case 768:return this.icr0;case 784:return E("APIC read icr1",oe),this.icr1;case 800:return E("read timer lvt",oe),this.lvt_timer;case 832:return E("read lvt perf counter",oe),this.lvt_perf_counter;case 848:return E("read lvt int0",oe),this.lvt_int0;case 864:return E("read lvt int1",oe),this.lvt_int1;case 880:return E("read lvt error",oe),this.lvt_error;case 992:return E("read timer divider",oe),this.timer_divider;case 896:return E("read timer initial count",oe),this.timer_initial_count;case 912:return E("read timer current count: "+L(this.timer_current_count>>>0,8),oe),this.timer_current_count;default:return E("APIC read "+L(e),oe),0}};Xe.prototype.write32=function(e,t){switch(e=e-Gs|0,e){case 48:E("APIC write version: "+L(t>>>0,8)+", ignored",oe);break;case 128:this.tpr=t&255,this.check_vector();break;case 176:e=this.highest_isr(),e!==-1?(this.register_clear_bit(this.isr,e),this.register_get_bit(this.tmr,e)&&this.cpu.devices.ioapic.remote_eoi(e),this.check_vector()):E("Bad eoi: No isr set",oe);break;case 208:E("Set local destination: "+L(t>>>0,8),oe),this.local_destination=t&4278190080;break;case 224:E("Set destination format: "+L(t>>>0,8),oe),this.destination_format=t|16777215;break;case 240:E("Set spurious vector: "+L(t>>>0,8),oe),this.spurious_vector=t;break;case 640:E("Write error: "+L(t>>>0,8),oe),this.read_error=this.error,this.error=0;break;case 768:e=t&255;var i=t>>8&7,s=t>>11&1,a=t>>15&1,r=t>>18&3,u=this.icr1>>>24;E("APIC write icr0: "+L(t,8)+" vector="+L(e,2)+" destination_mode="+ao[s]+" delivery_mode="+oo[i]+" destination_shorthand="+["no","self","all with self","all without self"][r],oe),this.icr0=t&-4097,r===0?this.route(e,i,a,u,s):r===1?this.deliver(e,Gr,a):r===2?this.deliver(e,i,a):r!==3&&void 0;break;case 784:E("APIC write icr1: "+L(t>>>0,8),oe),this.icr1=t;break;case 800:E("timer lvt: "+L(t>>>0,8),oe),this.lvt_timer=t;break;case 832:E("lvt perf counter: "+L(t>>>0,8),oe),this.lvt_perf_counter=t;break;case 848:E("lvt int0: "+L(t>>>0,8),oe),this.lvt_int0=t;break;case 864:E("lvt int1: "+L(t>>>0,8),oe),this.lvt_int1=t;break;case 880:E("lvt error: "+L(t>>>0,8),oe),this.lvt_error=t;break;case 992:E("timer divider: "+L(t>>>0,8),oe),this.timer_divider=t,t=t&3|(t&8)>>1,this.timer_divider_shift=t===7?0:t+1;break;case 896:E("timer initial: "+L(t>>>0,8),oe),this.timer_initial_count=t>>>0,this.timer_current_count=t>>>0,this.next_tick=be.microtick(),this.timer_active=!0;break;case 912:E("timer current: "+L(t>>>0,8),oe);break;default:E("APIC write32 "+L(e)+" <- "+L(t>>>0,8),oe)}};Xe.prototype.timer=function(e){if(this.timer_current_count===0)return 100;const t=wa/(1<<this.timer_divider_shift);return e=(e-this.next_tick)*t>>>0,this.next_tick+=e/t,this.timer_current_count-=e,0>=this.timer_current_count&&(e=this.lvt_timer&ih,e===sh?(this.timer_current_count%=this.timer_initial_count,0>=this.timer_current_count&&(this.timer_current_count+=this.timer_initial_count),this.timer_current_count,!(this.lvt_timer&ri)&&this.deliver(this.lvt_timer&255,Gr,!1)):e===rh&&(this.timer_current_count=0,E("APIC timer one shot end",oe),!(this.lvt_timer&ri)&&this.deliver(this.lvt_timer&255,Gr,!1))),Math.max(0,this.timer_current_count/t)};Xe.prototype.route=function(e,t,i,s,a){this.deliver(e,t,i)};Xe.prototype.deliver=function(e,t,i){t!==hh&&t!==ah&&(this.register_get_bit(this.irr,e)?E("Not delivered: irr already set, vector="+L(e,2),oe):(this.register_set_bit(this.irr,e),i?this.register_set_bit(this.tmr,e):this.register_clear_bit(this.tmr,e),this.check_vector()))};Xe.prototype.highest_irr=function(){var e=this.register_get_highest_bit(this.irr);return e};Xe.prototype.highest_isr=function(){var e=this.register_get_highest_bit(this.isr);return e};Xe.prototype.check_vector=function(){var e=this.highest_irr();if(e!==-1){var t=this.highest_isr();t>=e||(e&240)<=(this.tpr&240)||this.cpu.handle_irqs()}};Xe.prototype.acknowledge_irq=function(){var e=this.highest_irr();if(e!==-1){var t=this.highest_isr();t>=e||(e&240)<=(this.tpr&240)||(this.register_clear_bit(this.irr,e),this.register_set_bit(this.isr,e),this.cpu.pic_call_irq(e),this.check_vector())}};Xe.prototype.get_state=function(){var e=[];return e[0]=this.apic_id,e[1]=this.timer_divider,e[2]=this.timer_divider_shift,e[3]=this.timer_initial_count,e[4]=this.timer_current_count,e[5]=this.next_tick,e[6]=this.lvt_timer,e[7]=this.lvt_perf_counter,e[8]=this.lvt_int0,e[9]=this.lvt_int1,e[10]=this.lvt_error,e[11]=this.tpr,e[12]=this.icr0,e[13]=this.icr1,e[14]=this.irr,e[15]=this.isr,e[16]=this.tmr,e[17]=this.spurious_vector,e[18]=this.destination_format,e[19]=this.local_destination,e[20]=this.error,e[21]=this.read_error,e};Xe.prototype.set_state=function(e){this.apic_id=e[0],this.timer_divider=e[1],this.timer_divider_shift=e[2],this.timer_initial_count=e[3],this.timer_current_count=e[4],this.next_tick=e[5],this.lvt_timer=e[6],this.lvt_perf_counter=e[7],this.lvt_int0=e[8],this.lvt_int1=e[9],this.lvt_error=e[10],this.tpr=e[11],this.icr0=e[12],this.icr1=e[13],this.irr=e[14],this.isr=e[15],this.tmr=e[16],this.spurious_vector=e[17],this.destination_format=e[18],this.local_destination=e[19],this.error=e[20],this.read_error=e[21]};Xe.prototype.register_get_bit=function(e,t){return e[t>>5]>>(t&31)&1};Xe.prototype.register_set_bit=function(e,t){e[t>>5]|=1<<(t&31)};Xe.prototype.register_clear_bit=function(e,t){e[t>>5]&=~(1<<(t&31))};Xe.prototype.register_get_highest_bit=function(e){for(var t=7;0<=t;t--){var i=e[t];if(i)return V.int_log2(i>>>0)|t<<5}return-1};var Pr=4273995776,An=0,xi=16,Vt=24,nh=0,Li=32768,ri=65536,ho=4096,Oi=16384,Ln=Oi|ho|4294836224,Gr=0,oh=1,ah=4,hh=5;function Bt(e){this.cpu=e,this.ioredtbl_config=new Int32Array(Vt),this.ioredtbl_destination=new Int32Array(Vt);for(var t=0;t<this.ioredtbl_config.length;t++)this.ioredtbl_config[t]=ri;this.ioregsel=0,this.ioapic_id=nh,this.irq_value=this.irr=0,e.io.mmap_register(Pr,Nr,i=>(i=i-Pr|0,i>=xi&&i<xi+4?(i-=xi,E("ioapic read8 byte "+i+" "+L(this.ioregsel),oe),this.read(this.ioregsel)>>8*i&255):(E("Unexpected IOAPIC register read: "+L(i>>>0),oe),0)),(i,s)=>{""+L(i>>>0)},i=>(i=i-Pr|0,i===An?this.ioregsel:i===xi?this.read(this.ioregsel):(E("Unexpected IOAPIC register read: "+L(i>>>0),oe),0)),(i,s)=>{i=i-Pr|0,i===An?this.ioregsel=s:i===xi?this.write(this.ioregsel,s):(E("Unexpected IOAPIC register write: "+L(i>>>0)+" <- "+L(s>>>0,8),oe),void 0)})}Bt.prototype.remote_eoi=function(e){for(var t=0;t<Vt;t++){var i=this.ioredtbl_config[t];(i&255)===e&&i&Oi&&(E("Clear remote IRR for irq="+L(t),oe),this.ioredtbl_config[t]&=~Oi,this.check_irq(t))}};Bt.prototype.check_irq=function(e){var t=1<<e;if(this.irr&t){var i=this.ioredtbl_config[e];if(!(i&ri)){var s=i>>8&7,a=i>>11&1,r=i&255,u=this.ioredtbl_destination[e]>>>24,o=(i&Li)===Li;if(!(i&Li))this.irr&=~t;else if(this.ioredtbl_config[e]|=Oi,i&Oi){E("No route: level interrupt and remote IRR still set",oe);return}s===Gr||s===oh?this.cpu.devices.apic.route(r,s,o,u,a):void 0,this.ioredtbl_config[e]&=~ho}}};Bt.prototype.set_irq=function(e){if(!(e>=Vt)){var t=1<<e;!(this.irq_value&t)&&(this.irq_value|=t,(this.ioredtbl_config[e]&(Li|ri))!==ri&&(this.irr|=t,this.check_irq(e)))}};Bt.prototype.clear_irq=function(e){if(!(e>=Vt)){var t=1<<e;(this.irq_value&t)===t&&(this.irq_value&=~t,this.ioredtbl_config[e]&Li&&(this.irr&=~t))}};Bt.prototype.read=function(e){if(e===0)return E("IOAPIC Read id",oe),this.ioapic_id<<24;if(e===1)return E("IOAPIC Read version",oe),17|Vt-1<<16;if(e===2)return E("IOAPIC Read arbitration id",oe),this.ioapic_id<<24;if(16<=e&&e<16+2*Vt){var t=e-16>>1;return e&1?(e=this.ioredtbl_destination[t],E("IOAPIC Read destination irq="+L(t)+" -> "+L(e,8),oe)):(e=this.ioredtbl_config[t],E("IOAPIC Read config irq="+L(t)+" -> "+L(e,8),oe)),e}return E("IOAPIC register read outside of range "+L(e),oe),0};Bt.prototype.write=function(e,t){if(e===0)this.ioapic_id=t>>>24&15;else if(e===1||e===2)E("Invalid write: "+e,oe);else if(16<=e&&e<16+2*Vt){var i=e-16>>1;if(e&1)this.ioredtbl_destination[i]=t&4278190080,E("Write destination "+L(t>>>0,8)+" irq="+L(i)+" dest="+L(t>>>24,2),oe);else{this.ioredtbl_config[i]=t&~Ln|this.ioredtbl_config[i]&Ln,e=t&255;var s=t>>8&7,a=t>>11&1,r=t>>15&1,u=t>>16&1;E("Write config "+L(t>>>0,8)+" irq="+L(i)+" vector="+L(e,2)+" deliverymode="+oo[s]+" destmode="+ao[a]+" is_level="+r+" disabled="+u,oe),this.check_irq(i)}}else E("IOAPIC register write outside of range "+L(e)+": "+L(t>>>0,8),oe)};Bt.prototype.get_state=function(){var e=[];return e[0]=this.ioredtbl_config,e[1]=this.ioredtbl_destination,e[2]=this.ioregsel,e[3]=this.ioapic_id,e[4]=this.irr,e[5]=this.irq_value,e};Bt.prototype.set_state=function(e){this.ioredtbl_config=e[0],this.ioredtbl_destination=e[1],this.ioregsel=e[2],this.ioapic_id=e[3],this.irr=e[4],this.irq_value=e[5]};var Ms=6,co=-2039052682,Ds=0,Is=1,Ps=2,_o=3,Gt=16;const ch=4247762216;function hi(e){this.message=e}hi.prototype=Error();const _h={Uint8Array,Int8Array,Uint16Array,Int16Array,Uint32Array,Int32Array,Float32Array,Float64Array};function Bs(e,t){if(typeof e!="object"||e===null)return e;if(e instanceof Array)return e.map(r=>Bs(r,t));if(e.constructor===Object&&(console.log(e),e.constructor,void 0),e.BYTES_PER_ELEMENT){var i=new Uint8Array(e.buffer,e.byteOffset,e.length*e.BYTES_PER_ELEMENT);return e=e.constructor.name.replace("bound ",""),{__state_type__:e,buffer_id:t.push(i)-1}}i=e.get_state(),e=[];for(var s=0;s<i.length;s++){var a=i[s];e[s]=Bs(a,t)}return e}function qs(e,t){if(typeof e!="object"||e===null)return e;if(e instanceof Array){for(var i=0;i<e.length;i++)e[i]=qs(e[i],t);return e}i=e.__state_type__;const s=_h[i];return new s(t[e.buffer_id])}ue.prototype.save_state=function(){for(var e=[],t=Bs(this,e),i=[],s=0,a=0;a<e.length;a++){var r=e[a].byteLength;i[a]={offset:s,length:r},s+=r,s=s+3&-4}t=JSON.stringify({buffer_infos:i,state:t}),t=new TextEncoder().encode(t),a=Gt+t.length,a=a+3&-4;var u=a+s;s=new ArrayBuffer(u);var o=new Int32Array(s,0,Gt/4);for(new Uint8Array(s,Gt,t.length).set(t),r=new Uint8Array(s,a),o[Ds]=co,o[Is]=Ms,o[Ps]=u,o[_o]=t.length,a=0;a<e.length;a++)u=e[a],u.constructor,r.set(u,i[a].offset);return E("State: json size "+(t.byteLength>>10)+"k"),E("State: Total buffers size "+(r.byteLength>>10)+"k"),s};ue.prototype.restore_state=function(e){function t(S,p){const v=S.length;if(v<Gt)throw new hi("Invalid length: "+v);if(S=new Int32Array(S.buffer,S.byteOffset,4),S[Ds]!==co)throw new hi("Invalid header: "+L(S[Ds]>>>0));if(S[Is]!==Ms)throw new hi("Version mismatch: dump="+S[Is]+" we="+Ms);if(p&&S[Ps]!==v)throw new hi("Length doesn't match header: real="+v+" header="+S[Ps]);return S[_o]}function i(S){return S=new TextDecoder().decode(S),JSON.parse(S)}if(e=new Uint8Array(e),new Uint32Array(e.buffer,0,1)[0]===ch){var s=this.zstd_create_ctx(e.length);new Uint8Array(this.wasm_memory.buffer,this.zstd_get_src_ptr(s),e.length).set(e);var a=this.zstd_read(s,16),r=new Uint8Array(this.wasm_memory.buffer,a,16),u=t(r,!1);this.zstd_read_free(a,16),a=this.zstd_read(s,u),r=new Uint8Array(this.wasm_memory.buffer,a,u),r=i(r),this.zstd_read_free(a,u),a=r.state;var o=r.buffer_infos;r=[],u=Gt+u;for(var l of o){if(o=(u+3&-4)-u,1048576<l.length){var f=this.zstd_read(s,o);this.zstd_read_free(f,o),f=new Uint8Array(l.length),r.push(f.buffer);for(var m=0;m<l.length;){var C=l.length-m;C=Math.min(C,1048576);const S=this.zstd_read(s,C);f.set(new Uint8Array(this.wasm_memory.buffer,S,C),m),this.zstd_read_free(S,C),m+=C}}else f=this.zstd_read(s,o+l.length),m=f+o,r.push(this.wasm_memory.buffer.slice(m,m+l.length)),this.zstd_read_free(f,o+l.length);u+=o+l.length}a=qs(a,r),this.set_state(a),this.zstd_free_ctx(s)}else{if(s=t(e,!0),0>s||s+12>=e.length)throw new hi("Invalid info block length: "+s);l=e.subarray(Gt,Gt+s),a=i(l),l=a.state,a=a.buffer_infos;let S=Gt+s;S=S+3&-4,s=a.map(p=>{const v=S+p.offset;return e.buffer.slice(v,v+p.length)}),l=qs(l,s),this.set_state(l)}};var Rn=0,On=1,Tn=2,Mn=3,lh=4,uh=4,Dn=5,In=6,Pn=7,Bn=8,qn=9,Fn=10,Un=11,dh=12,fh=12,ph=13,vh=13,mh=14,gh=14,yh=15,bh=15,Hn=16,Nn=31,wh=1,Sh=2,Ks=64,Ch=128,Eh=1,lo=64,xh=76,Vs=128;function uo(e,t,i){e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]&&e[4]===t[4]&&e[5]===t[5]&&(E("Replace mac in eth destination field",Y),e[0]=i[0],e[1]=i[1],e[2]=i[2],e[3]=i[3],e[4]=i[4],e[5]=i[5]),e[6]===t[0]&&e[7]===t[1]&&e[8]===t[2]&&e[9]===t[3]&&e[10]===t[4]&&e[11]===t[5]&&(E("Replace mac in eth source field",Y),e[6]=i[0],e[7]=i[1],e[8]=i[2],e[9]=i[3],e[10]=i[4],e[11]=i[5]);var s=e[12]<<8|e[13];if(s===2048){if(e=e.subarray(14),s=e[0]>>4,s!==4)E("Expected ipv4.version==4 but got: "+s,Y);else if(e[0]&15,e[9]===17){e=e.subarray(20),s=e[0]<<8|e[1];var a=e[2]<<8|e[3];if(E("udp srcport="+s+" dstport="+a+" checksum="+L(e[6]<<8|e[7],4),Y),s===67||a===67)if(s=e.subarray(8),a=s[236]<<24|s[237]<<16|s[238]<<8|s[239],a!==1669485411)E("dhcp packet didn't match magic: "+L(a,8));else for(s[28]===t[0]&&s[29]===t[1]&&s[30]===t[2]&&s[31]===t[3]&&s[32]===t[4]&&s[33]===t[5]&&(E("Replace mac in dhcp.chaddr",Y),s[28]=i[0],s[29]=i[1],s[30]=i[2],s[31]=i[3],s[32]=i[4],s[33]=i[5],e[6]=e[7]=0),a=240;a<s.length;){const r=s[a++];if(r===255)break;const u=s[a++];r===61&&s[a+0]===1&&s[a+1]===t[0]&&s[a+2]===t[1]&&s[a+3]===t[2]&&s[a+4]===t[3]&&s[a+5]===t[4]&&s[a+6]===t[5]&&(E("Replace mac in dhcp.clientidentifier",Y),s[a+1]=i[0],s[a+2]=i[1],s[a+3]=i[2],s[a+4]=i[3],s[a+5]=i[4],s[a+6]=i[5],e[6]=e[7]=0),a+=u}}}else s===2054&&(e=e.subarray(14),E("arp oper="+e[7]+" "+Ti(e.subarray(8,14))+" "+Ti(e.subarray(18,24)),Y),e[8]===t[0]&&e[9]===t[1]&&e[10]===t[2]&&e[11]===t[3]&&e[12]===t[4]&&e[13]===t[5]&&(E("Replace mac in arp.sha",Y),e[8]=i[0],e[9]=i[1],e[10]=i[2],e[11]=i[3],e[12]=i[4],e[13]=i[5]))}function Ti(e){return[e[0].toString(16).padStart(2,"0"),e[1].toString(16).padStart(2,"0"),e[2].toString(16).padStart(2,"0"),e[3].toString(16).padStart(2,"0"),e[4].toString(16).padStart(2,"0"),e[5].toString(16).padStart(2,"0")].join(":")}function ot(e,t,i,s){for(this.cpu=e,this.pci=e.devices.pci,this.preserve_mac_from_state_image=i,this.mac_address_translation=s,this.bus=t,this.bus.register("net0-receive",function(a){this.receive(a)},this),this.port=768,this.name="ne2k",this.pci_space=[236,16,41,128,3,1,0,0,0,0,0,2,0,0,0,0,this.port&255|1,this.port>>8,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,244,26,0,17,0,0,184,254,0,0,0,0,0,0,0,0,0,1,0,0],this.pci_id=40,this.pci_bars=[{size:32}],this.imr=this.isr=0,this.cr=1,this.tpsr=this.tcnt=this.rcnt=this.dcfg=0,this.memory=new Uint8Array(32768),this.txcr=this.rxcr=0,this.tsr=1,this.mac=new Uint8Array([0,34,21,255*Math.random()|0,255*Math.random()|0,255*Math.random()|0]),this.mac_address_in_state=null,t=0;6>t;t++)this.memory[t<<1]=this.memory[t<<1|1]=this.mac[t];this.memory[28]=this.memory[29]=87,this.memory[30]=this.memory[31]=87,E("Mac: "+Ti(this.mac),Y),this.rsar=0,this.pstart=lo,this.pstop=Vs,this.boundary=this.curpg=xh,t=e.io,t.register_read(this.port|Rn,this,function(){return E("Read cmd",Y),this.cr}),t.register_write(this.port|Rn,this,function(a){this.cr=a,E("Write command: "+L(a,2)+" newpg="+(this.cr>>6)+" txcr="+L(this.txcr,2),Y),this.cr&1||(a&24&&this.rcnt===0&&this.do_interrupt(Ks),a&4&&(a=this.tpsr<<8,a=this.memory.subarray(a,a+this.tcnt),this.mac_address_in_state&&(a=new Uint8Array(a),uo(a,this.mac_address_in_state,this.mac)),this.bus.send("net0-send",a),this.bus.send("eth-transmit-end",[a.length]),this.cr&=-5,this.do_interrupt(Sh),E("Command: Transfer. length="+L(a.byteLength),Y)))}),t.register_read(this.port|vh,this,function(){return E("Read counter0",Y),0}),t.register_read(this.port|gh,this,function(){return E("Read8 counter1",Y),0},function(){return E("Read16 counter1",Y),0}),t.register_read(this.port|bh,this,function(){return E("Read counter2",Y),0}),t.register_read(this.port|Nn,this,function(){return this.get_page(),E("Read reset",Y),this.do_interrupt(Ch),0}),t.register_write(this.port|Nn,this,function(a){this.get_page(),E("Write reset: "+L(a,2),Y)}),t.register_read(this.port|On,this,function(){var a=this.get_page();return a===0?this.pstart:a===1?(E("Read pg1/01 (mac[0])",Y),this.mac[0]):a===2?this.pstart:(E("Read pg"+a+"/01"),0)}),t.register_write(this.port|On,this,function(a){var r=this.get_page();r===0?(E("start page: "+L(a,2),Y),this.pstart=a):r===1?(E("mac[0] = "+L(a),Y),this.mac[0]=a):r===3?E("Unimplemented: Write pg3/01 (9346CR): "+L(a),Y):(E("Write pg"+r+"/01: "+L(a),Y),void 0)}),t.register_read(this.port|Tn,this,function(){var a=this.get_page();return a===0?this.pstop:a===1?(E("Read pg1/02 (mac[1])",Y),this.mac[1]):a===2?this.pstop:(E("Read pg"+a+"/02",Y),0)}),t.register_write(this.port|Tn,this,function(a){var r=this.get_page();r===0?(E("stop page: "+L(a,2),Y),a>this.memory.length>>8&&(a=this.memory.length>>8,E("XXX: Adjusting stop page to "+L(a),Y)),this.pstop=a):r===1?(E("mac[1] = "+L(a),Y),this.mac[1]=a):(E("Write pg"+r+"/02: "+L(a),Y),void 0)}),t.register_read(this.port|Pn,this,function(){var a=this.get_page();if(a===0)return E("Read isr: "+L(this.isr,2),Y),this.isr;if(a===1)return E("Read curpg: "+L(this.curpg,2),Y),this.curpg}),t.register_write(this.port|Pn,this,function(a){var r=this.get_page();r===0?(E("Write isr: "+L(a,2),Y),this.isr&=~a,this.update_irq()):r===1?(E("Write curpg: "+L(a,2),Y),this.curpg=a):void 0}),t.register_write(this.port|ph,this,function(a){var r=this.get_page();r===0?(this.txcr=a,E("Write tx config: "+L(a,2),Y)):E("Unimplemented: Write pg"+r+"/0d "+L(a,2),Y)}),t.register_write(this.port|mh,this,function(a){var r=this.get_page();r===0?(E("Write data configuration: "+L(a,2),Y),this.dcfg=a):E("Unimplemented: Write pg"+r+"/0e "+L(a,2),Y)}),t.register_read(this.port|Fn,this,function(){return this.get_page()===0?(E("Read pg0/0a",Y),80):0}),t.register_write(this.port|Fn,this,function(a){var r=this.get_page();r===0?(E("Write remote byte count low: "+L(a,2),Y),this.rcnt=this.rcnt&65280|a&255):E("Unimplemented: Write pg"+r+"/0a "+L(a,2),Y)}),t.register_read(this.port|Un,this,function(){return this.get_page()===0?(E("Read pg0/0b",Y),67):0}),t.register_write(this.port|Un,this,function(a){var r=this.get_page();r===0?(E("Write remote byte count high: "+L(a,2),Y),this.rcnt=this.rcnt&255|a<<8&65280):E("Unimplemented: Write pg"+r+"/0b "+L(a,2),Y)}),t.register_read(this.port|Bn,this,function(){var a=this.get_page();if(a===0)return E("Read remote start address low",Y),this.rsar&255;E("Unimplemented: Read pg"+a+"/08",Y)}),t.register_write(this.port|Bn,this,function(a){var r=this.get_page();r===0?(E("Write remote start address low: "+L(a,2),Y),this.rsar=this.rsar&65280|a&255):E("Unimplemented: Write pg"+r+"/08 "+L(a,2),Y)}),t.register_read(this.port|qn,this,function(){var a=this.get_page();if(a===0)return E("Read remote start address high",Y),this.rsar>>8&255;E("Unimplemented: Read pg"+a+"/09",Y)}),t.register_write(this.port|qn,this,function(a){var r=this.get_page();r===0?(E("Write remote start address low: "+L(a,2),Y),this.rsar=this.rsar&255|a<<8&65280):E("Unimplemented: Write pg"+r+"/09 "+L(a,2),Y)}),t.register_write(this.port|yh,this,function(a){var r=this.get_page();r===0?(E("Write interrupt mask register: "+L(a,2)+" isr="+L(this.isr,2),Y),this.imr=a,this.update_irq()):E("Unimplemented: Write pg"+r+"/0f "+L(a,2),Y)}),t.register_read(this.port|Mn,this,function(){var a=this.get_page();return a===0?(E("Read boundary: "+L(this.boundary,2),Y),this.boundary):a===1?(E("Read pg1/03 (mac[2])",Y),this.mac[2]):(a===3?E("Unimplemented: Read pg3/03 (CONFIG0)",Y):(E("Read pg"+a+"/03",Y),void 0),0)}),t.register_write(this.port|Mn,this,function(a){var r=this.get_page();r===0?(E("Write boundary: "+L(a,2),Y),this.boundary=a):r===1?(E("mac[2] = "+L(a),Y),this.mac[2]=a):(E("Write pg"+r+"/03: "+L(a),Y),void 0)}),t.register_read(this.port|lh,this,function(){var a=this.get_page();return a===0?this.tsr:a===1?(E("Read pg1/04 (mac[3])",Y),this.mac[3]):(E("Read pg"+a+"/04",Y),0)}),t.register_write(this.port|uh,this,function(a){var r=this.get_page();r===0?(E("Write tpsr: "+L(a,2),Y),this.tpsr=a):r===1?(E("mac[3] = "+L(a),Y),this.mac[3]=a):(E("Write pg"+r+"/04: "+L(a),Y),void 0)}),t.register_read(this.port|Dn,this,function(){var a=this.get_page();return a===0?(E("Unimplemented: Read pg0/05 (NCR: Number of Collisions Register)",Y),0):a===1?(E("Read pg1/05 (mac[4])",Y),this.mac[4]):(a===3?E("Unimplemented: Read pg3/05 (CONFIG2)",Y):(E("Read pg"+a+"/05",Y),void 0),0)}),t.register_write(this.port|Dn,this,function(a){var r=this.get_page();r===0?(E("Write tcnt low: "+L(a,2),Y),this.tcnt=this.tcnt&-256|a):r===1?(E("mac[4] = "+L(a),Y),this.mac[4]=a):r===3?E("Unimplemented: Write pg3/05 (CONFIG2): "+L(a),Y):(E("Write pg"+r+"/05: "+L(a),Y),void 0)}),t.register_read(this.port|In,this,function(){var a=this.get_page();return a===0?0:a===1?(E("Read pg1/06 (mac[5])",Y),this.mac[5]):(a===3?E("Unimplemented: Read pg3/06 (CONFIG3)",Y):(E("Read pg"+a+"/06",Y),void 0),0)}),t.register_write(this.port|In,this,function(a){var r=this.get_page();r===0?(E("Write tcnt high: "+L(a,2),Y),this.tcnt=this.tcnt&255|a<<8):r===1?(E("mac[5] = "+L(a),Y),this.mac[5]=a):r===3?E("Unimplemented: Write pg3/06 (CONFIG3): "+L(a),Y):(E("Write pg"+r+"/06: "+L(a),Y),void 0)}),t.register_read(this.port|dh,this,function(){var a=this.get_page();return a===0?9:(E("Unimplemented: Read pg"+a+"/0c",Y),0)}),t.register_write(this.port|fh,this,function(a){var r=this.get_page();r===0?(E("RX configuration reg write: "+L(a,2),Y),this.rxcr=a):E("Unimplemented: Write pg"+r+"/0c: "+L(a),Y)}),t.register_read(this.port|Hn|0,this,this.data_port_read8,this.data_port_read16,this.data_port_read32),t.register_write(this.port|Hn|0,this,this.data_port_write16,this.data_port_write16,this.data_port_write32),e.devices.pci.register_device(this)}ot.prototype.get_state=function(){var e=[];return e[0]=this.isr,e[1]=this.imr,e[2]=this.cr,e[3]=this.dcfg,e[4]=this.rcnt,e[5]=this.tcnt,e[6]=this.tpsr,e[7]=this.rsar,e[8]=this.pstart,e[9]=this.curpg,e[10]=this.boundary,e[11]=this.pstop,e[12]=this.rxcr,e[13]=this.txcr,e[14]=this.tsr,e[15]=this.mac,e[16]=this.memory,e};ot.prototype.set_state=function(e){this.isr=e[0],this.imr=e[1],this.cr=e[2],this.dcfg=e[3],this.rcnt=e[4],this.tcnt=e[5],this.tpsr=e[6],this.rsar=e[7],this.pstart=e[8],this.curpg=e[9],this.boundary=e[10],this.pstop=e[11],this.rxcr=e[12],this.txcr=e[13],this.tsr=e[14],this.preserve_mac_from_state_image?(this.mac=e[15],this.memory=e[16]):this.mac_address_translation&&(this.mac_address_in_state=e[15],this.memory=e[16],E("Using mac address translation guest_os_mac="+Ti(this.mac_address_in_state)+" real_mac="+Ti(this.mac),Y))};ot.prototype.do_interrupt=function(e){E("Do interrupt "+L(e,2),Y),this.isr|=e,this.update_irq()};ot.prototype.update_irq=function(){this.imr&this.isr?this.pci.raise_irq(this.pci_id):this.pci.lower_irq(this.pci_id)};ot.prototype.data_port_write=function(e){(16>=this.rsar||this.rsar>=lo<<8&&this.rsar<Vs<<8)&&(this.memory[this.rsar]=e),this.rsar++,this.rcnt--,this.rsar>=this.pstop<<8&&(this.rsar+=this.pstart-this.pstop<<8),this.rcnt===0&&this.do_interrupt(Ks)};ot.prototype.data_port_write16=function(e){this.data_port_write(e),this.dcfg&1&&this.data_port_write(e>>8)};ot.prototype.data_port_write32=function(e){this.data_port_write(e),this.data_port_write(e>>8),this.data_port_write(e>>16),this.data_port_write(e>>24)};ot.prototype.data_port_read=function(){let e=0;return this.rsar<Vs<<8&&(e=this.memory[this.rsar]),this.rsar++,this.rcnt--,this.rsar>=this.pstop<<8&&(this.rsar+=this.pstart-this.pstop<<8),this.rcnt===0&&this.do_interrupt(Ks),e};ot.prototype.data_port_read8=function(){return this.data_port_read16()&255};ot.prototype.data_port_read16=function(){return this.dcfg&1?this.data_port_read()|this.data_port_read()<<8:this.data_port_read()};ot.prototype.data_port_read32=function(){return this.data_port_read()|this.data_port_read()<<8|this.data_port_read()<<16|this.data_port_read()<<24};ot.prototype.receive=function(e){if(!(this.cr&1)&&(this.bus.send("eth-receive-end",[e.length]),this.rxcr&16||this.rxcr&4&&e[0]===255&&e[1]===255&&e[2]===255&&e[3]===255&&e[4]===255&&e[5]===255||!(this.rxcr&8&&(e[0]&1)===1||e[0]!==this.mac[0]||e[1]!==this.mac[1]||e[2]!==this.mac[2]||e[3]!==this.mac[3]||e[4]!==this.mac[4]||e[5]!==this.mac[5]))){this.mac_address_in_state&&(e=new Uint8Array(e),uo(e,this.mac,this.mac_address_in_state));var t=this.curpg<<8,i=Math.max(60,e.length)+4,s=t+4,a=this.curpg+1+(i>>8),r=t+i,u=1+(i>>8),o=this.boundary>this.curpg?this.boundary-this.curpg:this.pstop-this.curpg+this.boundary-this.pstart;o<u&&this.boundary!==0?E("Buffer full, dropping packet pstart="+L(this.pstart)+" pstop="+L(this.pstop)+" curpg="+L(this.curpg)+" needed="+L(u)+" boundary="+L(this.boundary)+" available="+L(o),Y):(r>this.pstop<<8?(60<=e.length,r=(this.pstop<<8)-s,this.memory.set(e.subarray(0,r),s),this.memory.set(e.subarray(r),this.pstart<<8),E("rcv cut="+L(r),Y)):(this.memory.set(e,s),60>e.length&&this.memory.fill(0,s+e.length,s+60)),a>=this.pstop&&(a+=this.pstart-this.pstop),this.memory[t]=Eh,this.memory[t+1]=a,this.memory[t+2]=i,this.memory[t+3]=i>>8,this.curpg=a,E("rcv offset="+L(t)+" len="+L(i)+" next="+L(a),Y),this.do_interrupt(wh))}};ot.prototype.get_page=function(){return this.cr>>6&3};var zn="COPYRIGHT (C) CREATIVE TECHNOLOGY LTD, 1992.",Zr=0,Rs=64,jn=65536,kh=65536,Ah=1024,fo=0,Xs=1,po=3,Ys=5,vo=6,mo=7,go=2,Zs=5,yo=7,bo=10,si=1,wo=2,So=new Uint8Array(256),Co=[],Jr=[],Qr=[],Eo=new Uint8Array(256),Js=[];function se(e,t){this.cpu=e,this.bus=t,this.write_buffer=new _i(Rs),this.read_buffer=new _i(Rs),this.read_buffer_lastvalue=0,this.command=Zr,this.mixer_current_address=this.command_size=0,this.mixer_registers=new Uint8Array(256),this.mixer_reset(),this.dummy_speaker_enabled=!1,this.test_register=0,this.dsp_signed=this.dsp_16bit=this.dsp_stereo=this.dsp_highspeed=!1,this.dac_buffers=[new ti(jn),new ti(jn)],this.dma=e.devices.dma,this.dma_channel=this.dma_irq=this.dma_bytes_block=this.dma_bytes_left=this.dma_bytes_count=this.dma_sample_count=0,this.dma_channel_8bit=Xs,this.dma_channel_16bit=Ys,this.dma_autoinit=!1,this.dma_buffer=new ArrayBuffer(kh),this.dma_buffer_int8=new Int8Array(this.dma_buffer),this.dma_buffer_uint8=new Uint8Array(this.dma_buffer),this.dma_buffer_int16=new Int16Array(this.dma_buffer),this.dma_buffer_uint16=new Uint16Array(this.dma_buffer),this.dma_syncbuffer=new lt(this.dma_buffer),this.dma_paused=this.dma_waiting_transfer=!1,this.sampling_rate=22050,t.send("dac-tell-sampling-rate",this.sampling_rate),this.bytes_per_sample=1,this.e2_value=170,this.e2_count=0,this.asp_registers=new Uint8Array(256),this.mpu_read_buffer=new _i(Rs),this.fm_current_address1=this.fm_current_address0=this.mpu_read_buffer_lastvalue=0,this.fm_waveform_select_enable=!1,this.irq=Zs,this.irq_triggered=new Uint8Array(16),e.io.register_read_consecutive(544,this,this.port2x0_read,this.port2x1_read,this.port2x2_read,this.port2x3_read),e.io.register_read_consecutive(904,this,this.port2x0_read,this.port2x1_read),e.io.register_read_consecutive(548,this,this.port2x4_read,this.port2x5_read),e.io.register_read(550,this,this.port2x6_read),e.io.register_read(551,this,this.port2x7_read),e.io.register_read(552,this,this.port2x8_read),e.io.register_read(553,this,this.port2x9_read),e.io.register_read(554,this,this.port2xA_read),e.io.register_read(555,this,this.port2xB_read),e.io.register_read(556,this,this.port2xC_read),e.io.register_read(557,this,this.port2xD_read),e.io.register_read_consecutive(558,this,this.port2xE_read,this.port2xF_read),e.io.register_write_consecutive(544,this,this.port2x0_write,this.port2x1_write,this.port2x2_write,this.port2x3_write),e.io.register_write_consecutive(904,this,this.port2x0_write,this.port2x1_write),e.io.register_write_consecutive(548,this,this.port2x4_write,this.port2x5_write),e.io.register_write(550,this,this.port2x6_write),e.io.register_write(551,this,this.port2x7_write),e.io.register_write_consecutive(552,this,this.port2x8_write,this.port2x9_write),e.io.register_write(554,this,this.port2xA_write),e.io.register_write(555,this,this.port2xB_write),e.io.register_write(556,this,this.port2xC_write),e.io.register_write(557,this,this.port2xD_write),e.io.register_write(558,this,this.port2xE_write),e.io.register_write(559,this,this.port2xF_write),e.io.register_read_consecutive(816,this,this.port3x0_read,this.port3x1_read),e.io.register_write_consecutive(816,this,this.port3x0_write,this.port3x1_write),this.dma.on_unmask(this.dma_on_unmask,this),t.register("dac-request-data",function(){this.dac_handle_request()},this),t.register("speaker-has-initialized",function(){this.mixer_reset()},this),t.send("speaker-confirm-initialized"),this.dsp_reset()}se.prototype.dsp_reset=function(){this.write_buffer.clear(),this.read_buffer.clear(),this.command=Zr,this.command_size=0,this.dummy_speaker_enabled=!1,this.test_register=0,this.dsp_signed=this.dsp_16bit=this.dsp_stereo=this.dsp_highspeed=!1,this.dac_buffers[0].clear(),this.dac_buffers[1].clear(),this.dma_channel=this.dma_irq=this.dma_bytes_block=this.dma_bytes_left=this.dma_bytes_count=this.dma_sample_count=0,this.dma_autoinit=!1,this.dma_buffer_uint8.fill(0),this.dma_paused=this.dma_waiting_transfer=!1,this.e2_value=170,this.e2_count=0,this.sampling_rate=22050,this.bytes_per_sample=1,this.lower_irq(si),this.irq_triggered.fill(0),this.asp_registers.fill(0),this.asp_registers[5]=1,this.asp_registers[9]=248};se.prototype.get_state=function(){var e=[];return e[2]=this.read_buffer_lastvalue,e[3]=this.command,e[4]=this.command_size,e[5]=this.mixer_current_address,e[6]=this.mixer_registers,e[7]=this.dummy_speaker_enabled,e[8]=this.test_register,e[9]=this.dsp_highspeed,e[10]=this.dsp_stereo,e[11]=this.dsp_16bit,e[12]=this.dsp_signed,e[15]=this.dma_sample_count,e[16]=this.dma_bytes_count,e[17]=this.dma_bytes_left,e[18]=this.dma_bytes_block,e[19]=this.dma_irq,e[20]=this.dma_channel,e[21]=this.dma_channel_8bit,e[22]=this.dma_channel_16bit,e[23]=this.dma_autoinit,e[24]=this.dma_buffer_uint8,e[25]=this.dma_waiting_transfer,e[26]=this.dma_paused,e[27]=this.sampling_rate,e[28]=this.bytes_per_sample,e[29]=this.e2_value,e[30]=this.e2_count,e[31]=this.asp_registers,e[33]=this.mpu_read_buffer_last_value,e[34]=this.irq,e[35]=this.irq_triggered,e};se.prototype.set_state=function(e){this.read_buffer_lastvalue=e[2],this.command=e[3],this.command_size=e[4],this.mixer_current_address=e[5],this.mixer_registers=e[6],this.mixer_full_update(),this.dummy_speaker_enabled=e[7],this.test_register=e[8],this.dsp_highspeed=e[9],this.dsp_stereo=e[10],this.dsp_16bit=e[11],this.dsp_signed=e[12],this.dma_sample_count=e[15],this.dma_bytes_count=e[16],this.dma_bytes_left=e[17],this.dma_bytes_block=e[18],this.dma_irq=e[19],this.dma_channel=e[20],this.dma_channel_8bit=e[21],this.dma_channel_16bit=e[22],this.dma_autoinit=e[23],this.dma_buffer_uint8=e[24],this.dma_waiting_transfer=e[25],this.dma_paused=e[26],this.sampling_rate=e[27],this.bytes_per_sample=e[28],this.e2_value=e[29],this.e2_count=e[30],this.asp_registers=e[31],this.mpu_read_buffer_last_value=e[33],this.irq=e[34],this.irq_triggered=e[35],this.dma_buffer=this.dma_buffer_uint8.buffer,this.dma_buffer_int8=new Int8Array(this.dma_buffer),this.dma_buffer_int16=new Int16Array(this.dma_buffer),this.dma_buffer_uint16=new Uint16Array(this.dma_buffer),this.dma_syncbuffer=new lt(this.dma_buffer),this.dma_paused?this.bus.send("dac-disable"):this.bus.send("dac-enable")};se.prototype.port2x0_read=function(){return E("220 read: fm music status port (unimplemented)",ce),255};se.prototype.port2x1_read=function(){return E("221 read: fm music data port (write only)",ce),255};se.prototype.port2x2_read=function(){return E("222 read: advanced fm music status port (unimplemented)",ce),255};se.prototype.port2x3_read=function(){return E("223 read: advanced music data port (write only)",ce),255};se.prototype.port2x4_read=function(){return E("224 read: mixer address port",ce),this.mixer_current_address};se.prototype.port2x5_read=function(){return E("225 read: mixer data port",ce),this.mixer_read(this.mixer_current_address)};se.prototype.port2x6_read=function(){return E("226 read: (write only)",ce),255};se.prototype.port2x7_read=function(){return E("227 read: undocumented",ce),255};se.prototype.port2x8_read=function(){return E("228 read: fm music status port (unimplemented)",ce),255};se.prototype.port2x9_read=function(){return E("229 read: fm music data port (write only)",ce),255};se.prototype.port2xA_read=function(){return E("22A read: read data",ce),this.read_buffer.length&&(this.read_buffer_lastvalue=this.read_buffer.shift()),E(" <- "+this.read_buffer_lastvalue+" "+L(this.read_buffer_lastvalue)+" '"+String.fromCharCode(this.read_buffer_lastvalue)+"'",ce),this.read_buffer_lastvalue};se.prototype.port2xB_read=function(){return E("22B read: undocumented",ce),255};se.prototype.port2xC_read=function(){return E("22C read: write-buffer status",ce),127};se.prototype.port2xD_read=function(){return E("22D read: undocumented",ce),255};se.prototype.port2xE_read=function(){return E("22E read: read-buffer status / irq 8bit ack.",ce),this.irq_triggered[si]&&this.lower_irq(si),(this.read_buffer.length&&!this.dsp_highspeed)<<7|127};se.prototype.port2xF_read=function(){return E("22F read: irq 16bit ack",ce),this.lower_irq(wo),0};se.prototype.port2x0_write=function(e){E("220 write: (unimplemented) fm register 0 address = "+L(e),ce),this.fm_current_address0=0};se.prototype.port2x1_write=function(e){E("221 write: (unimplemented) fm register 0 data = "+L(e),ce);var t=Js[this.fm_current_address0];t||(t=this.fm_default_write),t.call(this,e,0,this.fm_current_address0)};se.prototype.port2x2_write=function(e){E("222 write: (unimplemented) fm register 1 address = "+L(e),ce),this.fm_current_address1=0};se.prototype.port2x3_write=function(e){E("223 write: (unimplemented) fm register 1 data ="+L(e),ce);var t=Js[this.fm_current_address1];t||(t=this.fm_default_write),t.call(this,e,1,this.fm_current_address1)};se.prototype.port2x4_write=function(e){E("224 write: mixer address = "+L(e),ce),this.mixer_current_address=e};se.prototype.port2x5_write=function(e){E("225 write: mixer data = "+L(e),ce),this.mixer_write(this.mixer_current_address,e)};se.prototype.port2x6_write=function(e){E("226 write: reset = "+L(e),ce),this.dsp_highspeed?(E(" -> exit highspeed",ce),this.dsp_highspeed=!1):e&&(E(" -> reset",ce),this.dsp_reset()),this.read_buffer.clear(),this.read_buffer.push(170)};se.prototype.port2x7_write=function(e){E("227 write: undocumented",ce)};se.prototype.port2x8_write=function(e){E("228 write: fm music register port (unimplemented)",ce)};se.prototype.port2x9_write=function(e){E("229 write: fm music data port (unimplemented)",ce)};se.prototype.port2xA_write=function(e){E("22A write: dsp read data port (read only)",ce)};se.prototype.port2xB_write=function(e){E("22B write: undocumented",ce)};se.prototype.port2xC_write=function(e){E("22C write: write command/data",ce),this.command===Zr?(E("22C write: command = "+L(e),ce),this.command=e,this.write_buffer.clear(),this.command_size=So[e]):(E("22C write: data: "+L(e),ce),this.write_buffer.push(e)),this.write_buffer.length>=this.command_size&&this.command_do()};se.prototype.port2xD_write=function(e){E("22D write: undocumented",ce)};se.prototype.port2xE_write=function(e){E("22E write: dsp read buffer status (read only)",ce)};se.prototype.port2xF_write=function(e){E("22F write: undocumented",ce)};se.prototype.port3x0_read=function(){return E("330 read: mpu data",ce),this.mpu_read_buffer.length&&(this.mpu_read_buffer_lastvalue=this.mpu_read_buffer.shift()),E(" <- "+L(this.mpu_read_buffer_lastvalue),ce),this.mpu_read_buffer_lastvalue};se.prototype.port3x0_write=function(e){E("330 write: mpu data (unimplemented) : "+L(e),ce)};se.prototype.port3x1_read=function(){return E("331 read: mpu status",ce),0|128*!this.mpu_read_buffer.length};se.prototype.port3x1_write=function(e){E("331 write: mpu command: "+L(e),ce),e==255&&(this.mpu_read_buffer.clear(),this.mpu_read_buffer.push(254))};se.prototype.command_do=function(){var e=Co[this.command];e||(e=this.dsp_default_handler),e.call(this),this.command=Zr,this.command_size=0,this.write_buffer.clear()};se.prototype.dsp_default_handler=function(){E("Unhandled command: "+L(this.command),ce)};function _e(e,t,i){i||(i=se.prototype.dsp_default_handler);for(var s=0;s<e.length;s++)So[e[s]]=t,Co[e[s]]=i}function xo(e){for(var t=[],i=0;16>i;i++)t.push(e+i);return t}_e([14],2,function(){this.asp_registers[this.write_buffer.shift()]=this.write_buffer.shift()});_e([15],1,function(){this.read_buffer.clear(),this.read_buffer.push(this.asp_registers[this.write_buffer.shift()])});_e([16],1,function(){var e=ko(this.write_buffer.shift(),127.5,-1);this.dac_buffers[0].push(e),this.dac_buffers[1].push(e),this.bus.send("dac-enable")});_e([20,21],2,function(){this.dma_irq=si,this.dma_channel=this.dma_channel_8bit,this.dsp_highspeed=this.dsp_16bit=this.dsp_signed=this.dma_autoinit=!1,this.dma_transfer_size_set(),this.dma_transfer_start()});_e([22],2);_e([23],2);_e([28],0,function(){this.dma_irq=si,this.dma_channel=this.dma_channel_8bit,this.dma_autoinit=!0,this.dsp_highspeed=this.dsp_16bit=this.dsp_signed=!1,this.dma_transfer_start()});_e([31],0);_e([32],0,function(){this.read_buffer.clear(),this.read_buffer.push(127)});_e([36],2);_e([44],0);_e([48],0);_e([49],0);_e([52],0);_e([53],0);_e([54],0);_e([55],0);_e([56],0);_e([64],1,function(){this.sampling_rate_change(1e6/(256-this.write_buffer.shift())/this.get_channel_count())});_e([65,66],2,function(){this.sampling_rate_change(this.write_buffer.shift()<<8|this.write_buffer.shift())});_e([72],2,function(){this.dma_transfer_size_set()});_e([116],2);_e([117],2);_e([118],2);_e([119],2);_e([125],0);_e([127],0);_e([128],2);_e([144],0,function(){this.dma_irq=si,this.dma_channel=this.dma_channel_8bit,this.dma_autoinit=!0,this.dsp_signed=!1,this.dsp_highspeed=!0,this.dsp_16bit=!1,this.dma_transfer_start()});_e([145],0);_e([152],0);_e([153],0);_e([160],0);_e([168],0);_e(xo(176),3,function(){if(this.command&8)this.dsp_default_handler();else{var e=this.write_buffer.shift();this.dma_irq=wo,this.dma_channel=this.dma_channel_16bit,this.dma_autoinit=!!(this.command&4),this.dsp_signed=!!(e&16),this.dsp_stereo=!!(e&32),this.dsp_16bit=!0,this.dma_transfer_size_set(),this.dma_transfer_start()}});_e(xo(192),3,function(){if(this.command&8)this.dsp_default_handler();else{var e=this.write_buffer.shift();this.dma_irq=si,this.dma_channel=this.dma_channel_8bit,this.dma_autoinit=!!(this.command&4),this.dsp_signed=!!(e&16),this.dsp_stereo=!!(e&32),this.dsp_16bit=!1,this.dma_transfer_size_set(),this.dma_transfer_start()}});_e([208],0,function(){this.dma_paused=!0,this.bus.send("dac-disable")});_e([209],0,function(){this.dummy_speaker_enabled=!0});_e([211],0,function(){this.dummy_speaker_enabled=!1});_e([212],0,function(){this.dma_paused=!1,this.bus.send("dac-enable")});_e([213],0,function(){this.dma_paused=!0,this.bus.send("dac-disable")});_e([214],0,function(){this.dma_paused=!1,this.bus.send("dac-enable")});_e([216],0,function(){this.read_buffer.clear(),this.read_buffer.push(255*this.dummy_speaker_enabled)});_e([217,218],0,function(){this.dma_autoinit=!1});_e([224],1,function(){this.read_buffer.clear(),this.read_buffer.push(~this.write_buffer.shift())});_e([225],0,function(){this.read_buffer.clear(),this.read_buffer.push(4),this.read_buffer.push(5)});_e([226],1);_e([227],0,function(){this.read_buffer.clear();for(var e=0;e<zn.length;e++)this.read_buffer.push(zn.charCodeAt(e));this.read_buffer.push(0)});_e([228],1,function(){this.test_register=this.write_buffer.shift()});_e([232],0,function(){this.read_buffer.clear(),this.read_buffer.push(this.test_register)});_e([242,243],0,function(){this.raise_irq()});var $r=new Uint8Array(256);$r[14]=255;$r[15]=7;$r[55]=56;_e([249],1,function(){var e=this.write_buffer.shift();E("dsp 0xf9: unknown function. input: "+e,ce),this.read_buffer.clear(),this.read_buffer.push($r[e])});se.prototype.mixer_read=function(e){var t=Jr[e];return t?t=t.call(this):(t=this.mixer_registers[e],E("unhandled mixer register read. addr:"+L(e)+" data:"+L(t),ce)),t};se.prototype.mixer_write=function(e,t){var i=Qr[e];i?i.call(this,t):E("unhandled mixer register write. addr:"+L(e)+" data:"+L(t),ce)};se.prototype.mixer_default_read=function(){return E("mixer register read. addr:"+L(this.mixer_current_address),ce),this.mixer_registers[this.mixer_current_address]};se.prototype.mixer_default_write=function(e){E("mixer register write. addr:"+L(this.mixer_current_address)+" data:"+L(e),ce),this.mixer_registers[this.mixer_current_address]=e};se.prototype.mixer_reset=function(){this.mixer_registers[4]=204,this.mixer_registers[34]=204,this.mixer_registers[38]=204,this.mixer_registers[40]=0,this.mixer_registers[46]=0,this.mixer_registers[10]=0,this.mixer_registers[48]=192,this.mixer_registers[49]=192,this.mixer_registers[50]=192,this.mixer_registers[51]=192,this.mixer_registers[52]=192,this.mixer_registers[53]=192,this.mixer_registers[54]=0,this.mixer_registers[55]=0,this.mixer_registers[56]=0,this.mixer_registers[57]=0,this.mixer_registers[59]=0,this.mixer_registers[60]=31,this.mixer_registers[61]=21,this.mixer_registers[62]=11,this.mixer_registers[63]=0,this.mixer_registers[64]=0,this.mixer_registers[65]=0,this.mixer_registers[66]=0,this.mixer_registers[67]=0,this.mixer_registers[68]=128,this.mixer_registers[69]=128,this.mixer_registers[70]=128,this.mixer_registers[71]=128,this.mixer_full_update()};se.prototype.mixer_full_update=function(){for(var e=1;e<this.mixer_registers.length;e++)Eo[e]||this.mixer_write(e,this.mixer_registers[e])};function yt(e,t){t||(t=se.prototype.mixer_default_read),Jr[e]=t}function Rt(e,t){t||(t=se.prototype.mixer_default_write),Qr[e]=t}function Pi(e,t,i){Eo[e]=1,Jr[e]=function(){return this.mixer_registers[t]&240|this.mixer_registers[i]>>>4},Qr[e]=function(s){this.mixer_registers[e]=s;var a=s<<4&240|this.mixer_registers[i]&15;this.mixer_write(t,s&240|this.mixer_registers[t]&15),this.mixer_write(i,a)}}function es(e,t,i){Jr[e]=se.prototype.mixer_default_read,Qr[e]=function(s){this.mixer_registers[e]=s,this.bus.send("mixer-volume",[t,i,(s>>>2)-62])}}yt(0,function(){return this.mixer_reset(),0});Rt(0);Pi(4,50,51);Pi(34,48,49);Pi(38,52,53);Pi(40,54,55);Pi(46,56,57);es(48,js,pi);es(49,js,vi);es(50,Yr,pi);es(51,Yr,vi);yt(59);Rt(59,function(e){this.mixer_registers[59]=e,this.bus.send("mixer-volume",[qr,ei,6*(e>>>6)-18])});yt(65);Rt(65,function(e){this.mixer_registers[65]=e,this.bus.send("mixer-gain-left",6*(e>>>6))});yt(66);Rt(66,function(e){this.mixer_registers[66]=e,this.bus.send("mixer-gain-right",6*(e>>>6))});yt(68);Rt(68,function(e){this.mixer_registers[68]=e,e>>>=3,this.bus.send("mixer-treble-left",e-(16>e?14:16))});yt(69);Rt(69,function(e){this.mixer_registers[69]=e,e>>>=3,this.bus.send("mixer-treble-right",e-(16>e?14:16))});yt(70);Rt(70,function(e){this.mixer_registers[70]=e,e>>>=3,this.bus.send("mixer-bass-right",e-(16>e?14:16))});yt(71);Rt(71,function(e){this.mixer_registers[71]=e,e>>>=3,this.bus.send("mixer-bass-right",e-(16>e?14:16))});yt(128,function(){switch(this.irq){case go:return 1;case Zs:return 2;case yo:return 4;case bo:return 8;default:return 0}});Rt(128,function(e){e&1&&(this.irq=go),e&2&&(this.irq=Zs),e&4&&(this.irq=yo),e&8&&(this.irq=bo)});yt(129,function(){var e=0;switch(this.dma_channel_8bit){case fo:e|=1;break;case Xs:e|=2;break;case po:e|=8}switch(this.dma_channel_16bit){case Ys:e|=32;break;case vo:e|=64;break;case mo:e|=128}return e});Rt(129,function(e){e&1&&(this.dma_channel_8bit=fo),e&2&&(this.dma_channel_8bit=Xs),e&8&&(this.dma_channel_8bit=po),e&32&&(this.dma_channel_16bit=Ys),e&64&&(this.dma_channel_16bit=vo),e&128&&(this.dma_channel_16bit=mo)});yt(130,function(){for(var e=32,t=0;16>t;t++)e|=t*this.irq_triggered[t];return e});se.prototype.fm_default_write=function(e,t,i){E("unhandled fm register write. addr:"+t+"|"+L(i)+" data:"+L(e),ce)};function Qe(e,t){t||(t=se.prototype.fm_default_write);for(var i=0;i<e.length;i++)Js[e[i]]=t}function Xt(e,t){for(var i=[];e<=t;e++)i.push(e);return i}var Ue=new Uint8Array(32);Ue[0]=0;Ue[1]=1;Ue[2]=2;Ue[3]=3;Ue[4]=4;Ue[5]=5;Ue[8]=6;Ue[9]=7;Ue[10]=8;Ue[11]=9;Ue[12]=10;Ue[13]=11;Ue[16]=12;Ue[17]=13;Ue[18]=14;Ue[19]=15;Ue[20]=16;Ue[21]=17;function Bi(e,t){return 18*e+Ue[t]}Qe([1],function(e,t,i){this.fm_waveform_select_enable[t]=e&1,this.fm_update_waveforms()});Qe([2]);Qe([3]);Qe([4],function(e,t,i){});Qe([5],function(e,t,i){t===0&&this.fm_default_write(e,t,i)});Qe([8],function(e,t,i){});Qe(Xt(32,53),function(e,t,i){Bi(t,i-32)});Qe(Xt(64,85),function(e,t,i){Bi(t,i-64)});Qe(Xt(96,117),function(e,t,i){Bi(t,i-96)});Qe(Xt(128,149),function(e,t,i){Bi(t,i-128)});Qe(Xt(160,168),function(e,t,i){});Qe(Xt(176,184),function(e,t,i){});Qe([189],function(e,t,i){});Qe(Xt(192,200),function(e,t,i){});Qe(Xt(224,245),function(e,t,i){Bi(t,i-224)});se.prototype.fm_update_waveforms=function(){};se.prototype.sampling_rate_change=function(e){this.sampling_rate=e,this.bus.send("dac-tell-sampling-rate",e)};se.prototype.get_channel_count=function(){return this.dsp_stereo?2:1};se.prototype.dma_transfer_size_set=function(){this.dma_sample_count=1+(this.write_buffer.shift()<<0)+(this.write_buffer.shift()<<8)};se.prototype.dma_transfer_start=function(){E("begin dma transfer",ce),this.bytes_per_sample=1,this.dsp_16bit&&(this.bytes_per_sample*=2),this.dma_bytes_count=this.dma_sample_count*this.bytes_per_sample,this.dma_bytes_block=Ah*this.bytes_per_sample,this.dma_bytes_block=Math.min(Math.max(this.dma_bytes_count>>2&-4,32),this.dma_bytes_block),this.dma_waiting_transfer=!0,this.dma.channel_mask[this.dma_channel]||this.dma_on_unmask(this.dma_channel)};se.prototype.dma_on_unmask=function(e){e===this.dma_channel&&this.dma_waiting_transfer&&(this.dma_waiting_transfer=!1,this.dma_bytes_left=this.dma_bytes_count,this.dma_paused=!1,this.bus.send("dac-enable"))};se.prototype.dma_transfer_next=function(){E("dma transfering next block",ce);var e=Math.min(this.dma_bytes_left,this.dma_bytes_block),t=Math.floor(e/this.bytes_per_sample);this.dma.do_write(this.dma_syncbuffer,0,e,this.dma_channel,i=>{E("dma block transfer "+(i?"unsuccessful":"successful"),ce),i||(this.dma_to_dac(t),this.dma_bytes_left-=e,this.dma_bytes_left||(this.raise_irq(this.dma_irq),this.dma_autoinit&&(this.dma_bytes_left=this.dma_bytes_count)))})};se.prototype.dma_to_dac=function(e){for(var t=this.dsp_16bit?32767.5:127.5,i=this.dsp_signed?0:-1,s=this.dsp_stereo?1:2,a=this.dsp_16bit?this.dsp_signed?this.dma_buffer_int16:this.dma_buffer_uint16:this.dsp_signed?this.dma_buffer_int8:this.dma_buffer_uint8,r=0,u=0;u<e;u++)for(var o=ko(a[u],t,i),l=0;l<s;l++)this.dac_buffers[r].push(o),r^=1;this.dac_send()};se.prototype.dac_handle_request=function(){!this.dma_bytes_left||this.dma_paused?this.dac_send():this.dma_transfer_next()};se.prototype.dac_send=function(){if(this.dac_buffers[0].length){var e=this.dac_buffers[0].shift_block(this.dac_buffers[0].length),t=this.dac_buffers[1].shift_block(this.dac_buffers[1].length);this.bus.send("dac-send-data",[e,t],[e.buffer,t.buffer])}};se.prototype.raise_irq=function(e){E("raise irq",ce),this.irq_triggered[e]=1,this.cpu.device_raise_irq(this.irq)};se.prototype.lower_irq=function(e){E("lower irq",ce),this.irq_triggered[e]=0,this.cpu.device_lower_irq(this.irq)};function ko(e,t,i){return Lh(e/t+i,-1,1)}function Lh(e,t,i){return(e<t)*t+(e>i)*i+(t<=e&&e<=i)*e}const Br=6900,Wn=9,Gn=16,Rh=1,Oh=2,Th=3,Mh=4,Dh=5,Ih=1,Ph=2,Ri=4,Kn=8,Fs=64,Bh=128,Vn=1,qh=2,Ao=28,Lo=29,Ro=32,ci=16,Oo=2,Us=8,Fh=65535,Uh=1,Hh=2,Nh=4,zh=1;function $e(e,t){this.cpu=e,this.pci=e.devices.pci,this.device_id=t.device_id,this.pci_space=[Br&255,Br>>8,t.device_id&255,t.device_id>>8,7,5,16,0,1,0,2,0,0,0,0,0,1,168,0,0,0,16,191,254,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,Br&255,Br>>8,t.subsystem_device_id&255,t.subsystem_device_id>>8,0,0,0,0,64,0,0,0,0,0,0,0,0,1,0,0],this.pci_space=this.pci_space.concat(V.zeros(256-this.pci_space.length)),this.pci_id=t.pci_id,this.pci_bars=[],this.name=t.name,this.driver_feature_select=this.device_feature_select=0,this.device_feature=new Uint32Array(4),this.driver_feature=new Uint32Array(4);for(var i of t.common.features)0<=i,""+this.name,128>i,""+this.name,this.device_feature[i>>>5]|=1<<(i&31),this.driver_feature[i>>>5]|=1<<(i&31);t.common.features.includes(Ro),""+this.name,this.features_ok=!0,this.device_status=0,this.config_has_changed=!1,this.config_generation=0,this.queues=[];for(var s of t.common.queues)this.queues.push(new Re(e,this,s));this.queue_select=0,this.queue_selected=this.queues[0],this.isr_status=0;var a;a=[],a.push(this.create_common_capability(t.common)),a.push(this.create_notification_capability(t.notification)),a.push(this.create_isr_capability(t.isr_status)),t.device_specific&&a.push(this.create_device_specific_capability(t.device_specific)),this.init_capabilities(a),e.devices.pci.register_device(this),this.reset()}$e.prototype.create_common_capability=function(e){return{type:Rh,bar:0,port:e.initial_port,use_mmio:!1,offset:0,extra:new Uint8Array(0),struct:[{bytes:4,name:"device_feature_select",read:()=>this.device_feature_select,write:t=>{this.device_feature_select=t}},{bytes:4,name:"device_feature",read:()=>this.device_feature[this.device_feature_select]||0,write:t=>{}},{bytes:4,name:"driver_feature_select",read:()=>this.driver_feature_select,write:t=>{this.driver_feature_select=t}},{bytes:4,name:"driver_feature",read:()=>this.driver_feature[this.driver_feature_select]||0,write:t=>{const i=this.device_feature[this.driver_feature_select];this.driver_feature_select<this.driver_feature.length&&(this.driver_feature[this.driver_feature_select]=t&i),this.features_ok=this.features_ok&&!(t&~i)}},{bytes:2,name:"msix_config",read:()=>(E("No msi-x capability supported.",we),65535),write:t=>{E("No msi-x capability supported.",we)}},{bytes:2,name:"num_queues",read:()=>this.queues.length,write:t=>{}},{bytes:1,name:"device_status",read:()=>this.device_status,write:t=>{t===0?(E("Reset device<"+this.name+">",we),this.reset()):t&Bh?E("Warning: Device<"+this.name+"> status failed",we):E("Device<"+this.name+"> status: "+(t&Ih?"ACKNOWLEDGE ":"")+(t&Ph?"DRIVER ":"")+(t&Ri?"DRIVER_OK":"")+(t&Kn?"FEATURES_OK ":"")+(t&Fs?"DEVICE_NEEDS_RESET":""),we),t&~this.device_status&Ri&&this.device_status&Fs&&this.notify_config_changes(),this.features_ok||(t&=~Kn),this.device_status=t,t&~this.device_status&Ri&&e.on_driver_ok()}},{bytes:1,name:"config_generation",read:()=>this.config_generation,write:t=>{}},{bytes:2,name:"queue_select",read:()=>this.queue_select,write:t=>{this.queue_select=t,this.queue_select<this.queues.length?this.queues_selected=this.queues[this.queue_select]:this.queue_selected=null}},{bytes:2,name:"queue_size",read:()=>this.queue_selected?this.queue_selected.size:0,write:t=>{this.queue_selected&&(t&t-1&&(E("Warning: dev<"+this.name+"> Given queue size was not a power of 2. Rounding up to next power of 2.",we),t=1<<V.int_log2(t-1)+1),t>this.queue_selected.size_supported&&(E("Warning: dev<"+this.name+"> Trying to set queue size greater than supported. Clamping to supported size.",we),t=this.queue_selected.size_supported),this.queue_selected.set_size(t))}},{bytes:2,name:"queue_msix_vector",read:()=>(E("No msi-x capability supported.",we),65535),write:t=>{E("No msi-x capability supported.",we)}},{bytes:2,name:"queue_enable",read:()=>this.queue_selected?this.queue_selected.enabled|0:0,write:t=>{this.queue_selected&&(t===1?this.queue_selected.is_configured()?this.queue_selected.enable():E("Driver bug: tried enabling unconfigured queue",we):t===0&&E("Driver bug: tried writing 0 to queue_enable",we))}},{bytes:2,name:"queue_notify_off",read:()=>this.queue_selected?this.queue_selected.notify_offset:0,write:t=>{}},{bytes:4,name:"queue_desc (low dword)",read:()=>this.queue_selected?this.queue_selected.desc_addr:0,write:t=>{this.queue_selected&&(this.queue_selected.desc_addr=t)}},{bytes:4,name:"queue_desc (high dword)",read:()=>0,write:t=>{E("Warning: High dword of 64 bit queue_desc ignored",we)}},{bytes:4,name:"queue_avail (low dword)",read:()=>this.queue_selected?this.queue_selected.avail_addr:0,write:t=>{this.queue_selected&&(this.queue_selected.avail_addr=t)}},{bytes:4,name:"queue_avail (high dword)",read:()=>0,write:t=>{E("Warning: High dword of 64 bit queue_avail ignored",we)}},{bytes:4,name:"queue_used (low dword)",read:()=>this.queue_selected?this.queue_selected.used_addr:0,write:t=>{this.queue_selected&&(this.queue_selected.used_addr=t)}},{bytes:4,name:"queue_used (high dword)",read:()=>0,write:t=>{E("Warning: High dword of 64 bit queue_used ignored",we)}}]}};$e.prototype.create_notification_capability=function(e){const t=[];let i;e.single_handler?(e.handlers.length,""+this.name,i=0):i=2;for(const[s,a]of e.handlers.entries())t.push({bytes:2,name:"notify"+s,read:()=>65535,write:a||(r=>{})});return{type:Oh,bar:1,port:e.initial_port,use_mmio:!1,offset:0,extra:new Uint8Array([i&255,i>>8&255,i>>16&255,i>>24]),struct:t}};$e.prototype.create_isr_capability=function(e){return{type:Th,bar:2,port:e.initial_port,use_mmio:!1,offset:0,extra:new Uint8Array(0),struct:[{bytes:1,name:"isr_status",read:()=>{const t=this.isr_status;return this.lower_irq(),t},write:t=>{}}]}};$e.prototype.create_device_specific_capability=function(e){return~e.offset&3,""+this.name,{type:Mh,bar:3,port:e.initial_port,use_mmio:!1,offset:0,extra:new Uint8Array(0),struct:e.struct}};$e.prototype.init_capabilities=function(e){let t=this.pci_space[52]=64;var i=t;for(const a of e){e=Gn+a.extra.length,i=t,t=i+e,256>=t,""+this.name,0<=a.bar&&6>a.bar,""+this.name;var s=a.struct.reduce((r,u)=>r+u.bytes,0);s+=a.offset,s=16>s?16:1<<V.int_log2(s-1)+1,a.port&s-1,""+this.name,this.pci_bars[a.bar]={size:s},this.pci_space[i]=Wn,this.pci_space[i+1]=t,this.pci_space[i+2]=e,this.pci_space[i+3]=a.type,this.pci_space[i+4]=a.bar,this.pci_space[i+5]=0,this.pci_space[i+6]=0,this.pci_space[i+7]=0,this.pci_space[i+8]=a.offset&255,this.pci_space[i+9]=a.offset>>>8&255,this.pci_space[i+10]=a.offset>>>16&255,this.pci_space[i+11]=a.offset>>>24,this.pci_space[i+12]=s&255,this.pci_space[i+13]=s>>>8&255,this.pci_space[i+14]=s>>>16&255,this.pci_space[i+15]=s>>>24;for(const[r,u]of a.extra.entries())this.pci_space[i+16+r]=u;i=16+4*a.bar,this.pci_space[i]=a.port&254|!a.use_mmio,this.pci_space[i+1]=a.port>>>8&255,this.pci_space[i+2]=a.port>>>16&255,this.pci_space[i+3]=a.port>>>24&255,i=a.port+a.offset;for(const r of a.struct){let u=r.read;if(e=r.write,a.use_mmio)""+this.name;else{s=function(l){return E("Warning: 8-bit read from 16-bit virtio port",we),u(l&-2)>>((l&1)<<3)&255};const o=function(l){return E("Warning: 8-bit read from 32-bit virtio port",we),u(l&-4)>>((l&3)<<3)&255};switch(r.bytes){case 4:this.cpu.io.register_read(i,this,o,void 0,u),this.cpu.io.register_write(i,this,void 0,void 0,e);break;case 2:this.cpu.io.register_read(i,this,s,u),this.cpu.io.register_write(i,this,void 0,e);break;case 1:this.cpu.io.register_read(i,this,u),this.cpu.io.register_write(i,this,e);break;default:""+this.name+r.bytes}}i+=r.bytes}}i=Gn+4,256>=t+i,""+this.name,this.pci_space[t]=Wn,this.pci_space[t+1]=0,this.pci_space[t+2]=i,this.pci_space[t+3]=Dh,this.pci_space[t+4]=0,this.pci_space[t+5]=0,this.pci_space[t+6]=0,this.pci_space[t+7]=0,this.pci_space[t+8]=0,this.pci_space[t+9]=0,this.pci_space[t+10]=0,this.pci_space[t+11]=0,this.pci_space[t+12]=0,this.pci_space[t+13]=0,this.pci_space[t+14]=0,this.pci_space[t+15]=0,this.pci_space[t+16]=0,this.pci_space[t+17]=0,this.pci_space[t+18]=0,this.pci_space[t+19]=0};$e.prototype.get_state=function(){let e=[];return e[0]=this.device_feature_select,e[1]=this.driver_feature_select,e[2]=this.device_feature,e[3]=this.driver_feature,e[4]=this.features_ok,e[5]=this.device_status,e[6]=this.config_has_changed,e[7]=this.config_generation,e[8]=this.isr_status,e[9]=this.queue_select,e=e.concat(this.queues)};$e.prototype.set_state=function(e){this.device_feature_select=e[0],this.driver_feature_select=e[1],this.device_feature=e[2],this.driver_feature=e[3],this.features_ok=e[4],this.device_status=e[5],this.config_has_changed=e[6],this.config_generation=e[7],this.isr_status=e[8],this.queue_select=e[9];let t=0;for(let i of e.slice(10))this.queues[t].set_state(i),t++;this.queue_selected=this.queues[this.queue_select]||null};$e.prototype.reset=function(){this.driver_feature_select=this.device_feature_select=0,this.driver_feature.set(this.device_feature),this.features_ok=!0,this.queue_select=this.device_status=0,this.queue_selected=this.queues[0];for(const e of this.queues)e.reset();this.config_has_changed=!1,this.config_generation=0,this.lower_irq()};$e.prototype.notify_config_changes=function(){this.config_has_changed=!0,this.device_status&Ri?this.raise_irq(qh):(""+this.name,void 0)};$e.prototype.update_config_generation=function(){this.config_has_changed&&(this.config_generation++,this.config_generation&=255,this.config_has_changed=!1)};$e.prototype.is_feature_negotiated=function(e){return 0<(this.driver_feature[e>>>5]&1<<(e&31))};$e.prototype.needs_reset=function(){E("Device<"+this.name+"> experienced error - requires reset",we),this.device_status|=Fs,this.device_status&Ri&&this.notify_config_changes()};$e.prototype.raise_irq=function(e){E("Raise irq "+L(e),we),this.isr_status|=e,this.pci.raise_irq(this.pci_id)};$e.prototype.lower_irq=function(){E("Lower irq ",we),this.isr_status=0,this.pci.lower_irq(this.pci_id)};function Re(e,t,i){this.cpu=e,this.virtio=t,this.size_supported=this.size=i.size_supported,this.mask=this.size-1,this.enabled=!1,this.notify_offset=i.notify_offset,this.num_staged_replies=this.used_addr=this.avail_last_idx=this.avail_addr=this.desc_addr=0,this.reset()}Re.prototype.get_state=function(){const e=[];return e[0]=this.size,e[1]=this.size_supported,e[2]=this.enabled,e[3]=this.notify_offset,e[4]=this.desc_addr,e[5]=this.avail_addr,e[6]=this.avail_last_idx,e[7]=this.used_addr,e[8]=this.num_staged_replies,e};Re.prototype.set_state=function(e){this.size=e[0],this.size_supported=e[1],this.enabled=e[2],this.notify_offset=e[3],this.desc_addr=e[4],this.avail_addr=e[5],this.avail_last_idx=e[6],this.used_addr=e[7],this.num_staged_replies=e[8],this.mask=this.size-1};Re.prototype.reset=function(){this.enabled=!1,this.num_staged_replies=this.used_addr=this.avail_last_idx=this.avail_addr=this.desc_addr=0,this.set_size(this.size_supported)};Re.prototype.is_configured=function(){return this.desc_addr&&this.avail_addr&&this.used_addr};Re.prototype.enable=function(){this.is_configured(),this.enabled=!0};Re.prototype.set_size=function(e){e<=this.size_supported,this.size=e,this.mask=e-1};Re.prototype.count_requests=function(){return this.avail_addr,this.avail_get_idx()-this.avail_last_idx&this.mask};Re.prototype.has_request=function(){return this.avail_addr,(this.avail_get_idx()&this.mask)!==this.avail_last_idx};Re.prototype.pop_request=function(){this.avail_addr,this.has_request();var e=this.avail_get_entry(this.avail_last_idx);return E("Pop request: avail_last_idx="+this.avail_last_idx+" desc_idx="+e,we),e=new Qs(this,e),this.avail_last_idx=this.avail_last_idx+1&this.mask,e};Re.prototype.push_reply=function(e){this.used_addr,this.num_staged_replies<this.size;const t=this.used_get_idx()+this.num_staged_replies&this.mask;E("Push reply: used_idx="+t+" desc_idx="+e.head_idx,we),this.used_set_entry(t,e.head_idx,e.length_written),this.num_staged_replies++};Re.prototype.flush_replies=function(){if(this.used_addr,this.num_staged_replies===0)E("flush_replies: Nothing to flush",we);else{E("Flushing "+this.num_staged_replies+" replies",we);var e=this.used_get_idx()+this.num_staged_replies&Fh;this.used_set_idx(e),this.num_staged_replies=0,this.virtio.is_feature_negotiated(Lo)?(this.avail_get_used_event(),this.virtio.raise_irq(Vn)):~this.avail_get_flags()&zh&&this.virtio.raise_irq(Vn)}};Re.prototype.notify_me_after=function(e){e=this.avail_get_idx()+e&65535,this.used_set_avail_event(e)};Re.prototype.get_descriptor=function(e,t){return{addr_low:this.cpu.read32s(e+t*ci),addr_high:this.cpu.read32s(e+t*ci+4),len:this.cpu.read32s(e+t*ci+8),flags:this.cpu.read16(e+t*ci+12),next:this.cpu.read16(e+t*ci+14)}};Re.prototype.avail_get_flags=function(){return this.cpu.read16(this.avail_addr)};Re.prototype.avail_get_idx=function(){return this.cpu.read16(this.avail_addr+2)};Re.prototype.avail_get_entry=function(e){return this.cpu.read16(this.avail_addr+4+Oo*e)};Re.prototype.avail_get_used_event=function(){return this.cpu.read16(this.avail_addr+4+Oo*this.size)};Re.prototype.used_get_flags=function(){return this.cpu.read16(this.used_addr)};Re.prototype.used_set_flags=function(e){this.cpu.write16(this.used_addr,e)};Re.prototype.used_get_idx=function(){return this.cpu.read16(this.used_addr+2)};Re.prototype.used_set_idx=function(e){this.cpu.write16(this.used_addr+2,e)};Re.prototype.used_set_entry=function(e,t,i){this.cpu.write32(this.used_addr+4+Us*e,t),this.cpu.write32(this.used_addr+8+Us*e,i)};Re.prototype.used_set_avail_event=function(e){this.cpu.write16(this.used_addr+4+Us*this.size,e)};function Qs(e,t){this.cpu=e.cpu,this.virtio=e.virtio,this.head_idx=t,this.read_buffers=[],this.length_readable=this.read_buffer_offset=this.read_buffer_idx=0,this.write_buffers=[],this.length_writable=this.length_written=this.write_buffer_offset=this.write_buffer_idx=0;let i=e.desc_addr,s=0,a=e.size,r=!1;const u=this.virtio.is_feature_negotiated(Ao);E("<<< Descriptor chain start",we);do{const o=e.get_descriptor(i,t);if(E("descriptor: idx="+t+" addr="+L(o.addr_high,8)+":"+L(o.addr_low,8)+" len="+L(o.len,8)+" flags="+L(o.flags,4)+" next="+L(o.next,4),we),u&&o.flags&Nh)i=o.addr_low,s=t=0,a=o.len/ci,E("start indirect",we);else{if(o.flags&Hh)r=!0,this.write_buffers.push(o),this.length_writable+=o.len;else{if(r){E("Driver bug: readonly buffer after writeonly buffer within chain",we);break}this.read_buffers.push(o),this.length_readable+=o.len}if(s++,s>a){E("Driver bug: descriptor chain cycle detected",we);break}if(o.flags&Uh)t=o.next;else break}}while(1);E("Descriptor chain end >>>",we)}Qs.prototype.get_next_blob=function(e){let t=0,i=e.length;for(;i;){if(this.read_buffer_idx===this.read_buffers.length){E("Device<"+this.virtio.name+"> Read more than device-readable buffers has",we);break}var s=this.read_buffers[this.read_buffer_idx];const a=s.addr_low+this.read_buffer_offset;s=s.len-this.read_buffer_offset,s>i?(s=i,this.read_buffer_offset+=i):(this.read_buffer_idx++,this.read_buffer_offset=0),e.set(this.cpu.read_blob(a,s),t),t+=s,i-=s}return t};Qs.prototype.set_next_blob=function(e){let t=0,i=e.length;for(;i;){if(this.write_buffer_idx===this.write_buffers.length){E("Device<"+this.virtio.name+"> Write more than device-writable capacity",we);break}var s=this.write_buffers[this.write_buffer_idx];const a=s.addr_low+this.write_buffer_offset;s=s.len-this.write_buffer_offset,s>i?(s=i,this.write_buffer_offset+=i):(this.write_buffer_idx++,this.write_buffer_offset=0),this.cpu.write_blob(e.subarray(t,t+s),a),t+=s,i-=s}return this.length_written+=t,t};var To={};function ui(){this.listeners={},this.pair=void 0}ui.prototype.register=function(e,t,i){var s=this.listeners[e];s===void 0&&(s=this.listeners[e]=[]),s.push({fn:t,this_value:i})};ui.prototype.unregister=function(e,t){var i=this.listeners[e];i!==void 0&&(this.listeners[e]=i.filter(function(s){return s.fn!==t}))};ui.prototype.send=function(e,t,i){if(this.pair&&(e=this.pair.listeners[e],e!==void 0))for(i=0;i<e.length;i++){var s=e[i];s.fn.call(s.this_value,t)}};ui.prototype.send_async=function(e,t){setTimeout(this.send.bind(this,e,t),0)};To.create=function(){var e=new ui,t=new ui;return e.pair=t,t.pair=e,[e,t]};var E=function(){return function(){}}();function ue(e,t,i){this.next_tick_immediately=i,this.wm=t,this.wasm_patch(),this.create_jit_imports(),this.wasm_memory=t=this.wm.exports.memory,this.memory_size=V.view(Uint32Array,t,812,1),this.mem8=new Uint8Array(0),this.mem32s=new Int32Array(this.mem8.buffer),this.segment_is_null=V.view(Uint8Array,t,724,8),this.segment_offsets=V.view(Int32Array,t,736,8),this.segment_limits=V.view(Uint32Array,t,768,8),this.protected_mode=V.view(Int32Array,t,800,1),this.idtr_size=V.view(Int32Array,t,564,1),this.idtr_offset=V.view(Int32Array,t,568,1),this.gdtr_size=V.view(Int32Array,t,572,1),this.gdtr_offset=V.view(Int32Array,t,576,1),this.tss_size_32=V.view(Int32Array,t,1128,1),this.page_fault=V.view(Uint32Array,t,540,8),this.cr=V.view(Int32Array,t,580,8),this.cpl=V.view(Uint8Array,t,612,1),this.is_32=V.view(Int32Array,t,804,1),this.stack_size_32=V.view(Int32Array,t,808,1),this.in_hlt=V.view(Uint8Array,t,616,1),this.last_virt_eip=V.view(Int32Array,t,620,1),this.eip_phys=V.view(Int32Array,t,624,1),this.sysenter_cs=V.view(Int32Array,t,636,1),this.sysenter_esp=V.view(Int32Array,t,640,1),this.sysenter_eip=V.view(Int32Array,t,644,1),this.prefixes=V.view(Int32Array,t,648,1),this.flags=V.view(Int32Array,t,120,1),this.flags_changed=V.view(Int32Array,t,116,1),this.last_op1=V.view(Int32Array,t,96,1),this.last_op_size=V.view(Int32Array,t,104,1),this.last_result=V.view(Int32Array,t,112,1),this.current_tsc=V.view(Uint32Array,t,960,2),this.devices={},this.instruction_pointer=V.view(Int32Array,t,556,1),this.previous_ip=V.view(Int32Array,t,560,1),this.apic_enabled=V.view(Uint8Array,t,548,1),this.acpi_enabled=V.view(Uint8Array,t,552,1),this.memory_map_read8=[],this.memory_map_write8=[],this.memory_map_read32=[],this.memory_map_write32=[],this.bios={main:null,vga:null},this.instruction_counter=V.view(Uint32Array,t,664,1),this.reg32=V.view(Int32Array,t,64,8),this.fpu_st=V.view(Int32Array,t,1152,32),this.fpu_stack_empty=V.view(Uint8Array,t,816,1),this.fpu_stack_empty[0]=255,this.fpu_stack_ptr=V.view(Uint8Array,t,1032,1),this.fpu_stack_ptr[0]=0,this.fpu_control_word=V.view(Uint16Array,t,1036,1),this.fpu_control_word[0]=895,this.fpu_status_word=V.view(Uint16Array,t,1040,1),this.fpu_status_word[0]=0,this.fpu_ip=V.view(Int32Array,t,1048,1),this.fpu_ip[0]=0,this.fpu_ip_selector=V.view(Int32Array,t,1052,1),this.fpu_ip_selector[0]=0,this.fpu_opcode=V.view(Int32Array,t,1044,1),this.fpu_opcode[0]=0,this.fpu_dp=V.view(Int32Array,t,1056,1),this.fpu_dp[0]=0,this.fpu_dp_selector=V.view(Int32Array,t,1060,1),this.fpu_dp_selector[0]=0,this.reg_xmm32s=V.view(Int32Array,t,832,32),this.mxcsr=V.view(Int32Array,t,824,1),this.sreg=V.view(Uint16Array,t,668,8),this.dreg=V.view(Int32Array,t,684,8),this.reg_pdpte=V.view(Int32Array,t,968,8),this.svga_dirty_bitmap_min_offset=V.view(Uint32Array,t,716,1),this.svga_dirty_bitmap_max_offset=V.view(Uint32Array,t,720,1),this.fw_value=[],this.fw_pointer=0,this.option_roms=[],this.io=void 0,this.bus=e,this.set_tsc(0,0),this.debug_init()}ue.prototype.clear_opstats=function(){new Uint8Array(this.wasm_memory.buffer,32768,131072).fill(0),this.wm.exports.profiler_init()};ue.prototype.create_jit_imports=function(){const e=Object.create(null);e.m=this.wm.exports.memory;for(let t of Object.keys(this.wm.exports))t.startsWith("_")||t.startsWith("zstd")||t.endsWith("_js")||(e[t]=this.wm.exports[t]);this.jit_imports=e};ue.prototype.wasm_patch=function(){const e=i=>this.wm.exports[i],t=i=>{const s=e(i);return console.assert(s,"Missing import: "+i),s};this.reset_cpu=t("reset_cpu"),this.getiopl=t("getiopl"),this.get_eflags=t("get_eflags"),this.get_eflags_no_arith=t("get_eflags_no_arith"),this.pic_call_irq=t("pic_call_irq"),this.do_many_cycles_native=t("do_many_cycles_native"),this.cycle_internal=t("cycle_internal"),this.read8=t("read8"),this.read16=t("read16"),this.read32s=t("read32s"),this.write8=t("write8"),this.write16=t("write16"),this.write32=t("write32"),this.in_mapped_range=t("in_mapped_range"),this.fpu_load_tag_word=t("fpu_load_tag_word"),this.fpu_load_status_word=t("fpu_load_status_word"),this.fpu_get_sti_f64=t("fpu_get_sti_f64"),this.translate_address_system_read=t("translate_address_system_read_js"),this.get_seg_cs=t("get_seg_cs"),this.get_real_eip=t("get_real_eip"),this.clear_tlb=t("clear_tlb"),this.full_clear_tlb=t("full_clear_tlb"),this.set_tsc=t("set_tsc"),this.store_current_tsc=t("store_current_tsc"),this.jit_clear_cache=t("jit_clear_cache_js"),this.jit_dirty_cache=t("jit_dirty_cache"),this.codegen_finalize_finished=t("codegen_finalize_finished"),this.allocate_memory=t("allocate_memory"),this.zero_memory=t("zero_memory"),this.svga_allocate_memory=t("svga_allocate_memory"),this.svga_allocate_dest_buffer=t("svga_allocate_dest_buffer"),this.svga_fill_pixel_buffer=t("svga_fill_pixel_buffer"),this.svga_mark_dirty=t("svga_mark_dirty"),this.zstd_create_ctx=t("zstd_create_ctx"),this.zstd_get_src_ptr=t("zstd_get_src_ptr"),this.zstd_free_ctx=t("zstd_free_ctx"),this.zstd_read=t("zstd_read"),this.zstd_read_free=t("zstd_read_free")};ue.prototype.jit_force_generate=function(e){this.jit_force_generate_unsafe?this.jit_force_generate_unsafe(e):void 0};ue.prototype.jit_clear_func=function(e){this.wm.wasm_table.set(e+Xr,null)};ue.prototype.jit_clear_all_funcs=function(){const e=this.wm.wasm_table;for(let t=0;t<to;t++)e.set(Xr+t,null)};ue.prototype.get_state=function(){var e=[];e[0]=this.memory_size[0],e[1]=this.segment_is_null,e[2]=this.segment_offsets,e[3]=this.segment_limits,e[4]=this.protected_mode[0],e[5]=this.idtr_offset[0],e[6]=this.idtr_size[0],e[7]=this.gdtr_offset[0],e[8]=this.gdtr_size[0],e[9]=this.page_fault[0],e[10]=this.cr,e[11]=this.cpl[0],e[13]=this.is_32[0],e[16]=this.stack_size_32[0],e[17]=this.in_hlt[0],e[18]=this.last_virt_eip[0],e[19]=this.eip_phys[0],e[22]=this.sysenter_cs[0],e[23]=this.sysenter_eip[0],e[24]=this.sysenter_esp[0],e[25]=this.prefixes[0],e[26]=this.flags[0],e[27]=this.flags_changed[0],e[28]=this.last_op1[0],e[30]=this.last_op_size[0],e[37]=this.instruction_pointer[0],e[38]=this.previous_ip[0],e[39]=this.reg32,e[40]=this.sreg,e[41]=this.dreg,e[42]=this.reg_pdpte,this.store_current_tsc(),e[43]=this.current_tsc,e[45]=this.devices.virtio_9p,e[46]=this.devices.apic,e[47]=this.devices.rtc,e[48]=this.devices.pci,e[49]=this.devices.dma,e[50]=this.devices.acpi,e[51]=this.devices.hpet,e[52]=this.devices.vga,e[53]=this.devices.ps2,e[54]=this.devices.uart0,e[55]=this.devices.fdc,e[56]=this.devices.cdrom,e[57]=this.devices.hda,e[58]=this.devices.pit,e[59]=this.devices.net,e[60]=this.devices.pic,e[61]=this.devices.sb16,e[62]=this.fw_value,e[63]=this.devices.ioapic,e[64]=this.tss_size_32[0],e[66]=this.reg_xmm32s,e[67]=this.fpu_st,e[68]=this.fpu_stack_empty[0],e[69]=this.fpu_stack_ptr[0],e[70]=this.fpu_control_word[0],e[71]=this.fpu_ip[0],e[72]=this.fpu_ip_selector[0],e[73]=this.fpu_dp[0],e[74]=this.fpu_dp_selector[0],e[75]=this.fpu_opcode[0];const{packed_memory:t,bitmap:i}=this.pack_memory();return e[77]=t,e[78]=new Uint8Array(i.get_buffer()),e[79]=this.devices.uart1,e[80]=this.devices.uart2,e[81]=this.devices.uart3,e};ue.prototype.set_state=function(e){this.memory_size[0]=e[0],this.mem8.length!==this.memory_size[0]&&console.warn("Note: Memory size mismatch. we="+this.mem8.length+" state="+this.memory_size[0]),this.segment_is_null.set(e[1]),this.segment_offsets.set(e[2]),this.segment_limits.set(e[3]),this.protected_mode[0]=e[4],this.idtr_offset[0]=e[5],this.idtr_size[0]=e[6],this.gdtr_offset[0]=e[7],this.gdtr_size[0]=e[8],this.page_fault[0]=e[9],this.cr.set(e[10]),this.cpl[0]=e[11],this.is_32[0]=e[13],this.stack_size_32[0]=e[16],this.in_hlt[0]=e[17],this.last_virt_eip[0]=e[18],this.eip_phys[0]=e[19],this.sysenter_cs[0]=e[22],this.sysenter_eip[0]=e[23],this.sysenter_esp[0]=e[24],this.prefixes[0]=e[25],this.flags[0]=e[26],this.flags_changed[0]=e[27],this.last_op1[0]=e[28],this.last_op_size[0]=e[30],this.instruction_pointer[0]=e[37],this.previous_ip[0]=e[38],this.reg32.set(e[39]),this.sreg.set(e[40]),this.dreg.set(e[41]),e[42]&&this.reg_pdpte.set(e[42]),this.set_tsc(e[43][0],e[43][1]),this.devices.virtio_9p&&this.devices.virtio_9p.set_state(e[45]),this.devices.apic&&this.devices.apic.set_state(e[46]),this.devices.rtc&&this.devices.rtc.set_state(e[47]),this.devices.pci&&this.devices.pci.set_state(e[48]),this.devices.dma&&this.devices.dma.set_state(e[49]),this.devices.acpi&&this.devices.acpi.set_state(e[50]),this.devices.hpet&&this.devices.hpet.set_state(e[51]),this.devices.vga&&this.devices.vga.set_state(e[52]),this.devices.ps2&&this.devices.ps2.set_state(e[53]),this.devices.uart0&&this.devices.uart0.set_state(e[54]),this.devices.fdc&&this.devices.fdc.set_state(e[55]),this.devices.cdrom&&this.devices.cdrom.set_state(e[56]),this.devices.hda&&this.devices.hda.set_state(e[57]),this.devices.pit&&this.devices.pit.set_state(e[58]),this.devices.net&&this.devices.net.set_state(e[59]),this.devices.pic&&this.devices.pic.set_state(e[60]),this.devices.sb16&&this.devices.sb16.set_state(e[61]),this.devices.uart1&&this.devices.uart1.set_state(e[79]),this.devices.uart2&&this.devices.uart2.set_state(e[80]),this.devices.uart3&&this.devices.uart3.set_state(e[81]),this.fw_value=e[62],this.devices.ioapic&&this.devices.ioapic.set_state(e[63]),this.tss_size_32[0]=e[64],this.reg_xmm32s.set(e[66]),this.fpu_st.set(e[67]),this.fpu_stack_empty[0]=e[68],this.fpu_stack_ptr[0]=e[69],this.fpu_control_word[0]=e[70],this.fpu_ip[0]=e[71],this.fpu_ip_selector[0]=e[72],this.fpu_dp[0]=e[73],this.fpu_dp_selector[0]=e[74],this.fpu_opcode[0]=e[75];const t=new V.Bitmap(e[78].buffer);this.unpack_memory(t,e[77]),this.full_clear_tlb(),this.jit_clear_cache()};ue.prototype.pack_memory=function(){this.mem8.length&4095;for(var e=this.mem8.length>>12,t=[],i=0;i<e;i++){var s=i<<12;s=this.mem32s.subarray(s>>2,s+4096>>2);let a=!0;for(let r=0;r<s.length;r++)if(s[r]!==0){a=!1;break}a||t.push(i)}e=new V.Bitmap(e),i=new Uint8Array(t.length<<12);for(let[a,r]of t.entries())e.set(r,1),t=r<<12,t=this.mem8.subarray(t,t+4096),i.set(t,a<<12);return{bitmap:e,packed_memory:i}};ue.prototype.unpack_memory=function(e,t){this.zero_memory(this.memory_size[0]);const i=this.memory_size[0]>>12;let s=0;for(let r=0;r<i;r++)if(e.get(r)){var a=s<<12;a=t.subarray(a,a+4096),this.mem8.set(a,r<<12),s++}};ue.prototype.main_run=function(){if(this.in_hlt[0]){var e=this.hlt_loop();if(this.in_hlt[0])return e}let t=e=be.microtick();for(;t-e<ba;){this.do_many_cycles(),t=be.microtick();const i=this.run_hardware_timers(t);if(this.handle_irqs(),this.in_hlt[0])return i}return 0};ue.prototype.reboot_internal=function(){this.reset_cpu(),this.fw_value=[],this.devices.virtio&&this.devices.virtio.reset(),this.load_bios()};ue.prototype.reset_memory=function(){this.mem8.fill(0)};ue.prototype.create_memory=function(e){1048576>e?e=1048576:0>(e|0)&&(e=Math.pow(2,31)-Nr),e=(e-1|Nr-1)+1|0,console.assert(this.memory_size[0]===0,"Expected uninitialised memory"),this.memory_size[0]=e;const t=this.allocate_memory(e);this.mem8=V.view(Uint8Array,this.wasm_memory,t,e),this.mem32s=V.view(Uint32Array,this.wasm_memory,t,e>>2)};Ce.exportProperty(ue.prototype,"create_memory",ue.prototype.create_memory);ue.prototype.init=function(e,t){typeof e.log_level=="number"&&e.log_level,this.create_memory(typeof e.memory_size=="number"?e.memory_size:67108864),this.acpi_enabled[0]=+e.acpi,this.reset_cpu();var i=new Be(this);if(this.io=i,this.bios.main=e.bios,this.bios.vga=e.vga_bios,this.load_bios(),e.bzimage){const{option_rom:a}=mc(this.mem8,e.bzimage,e.initrd,e.cmdline||"");a&&this.option_roms.push(a)}i.register_read(179,this,function(){return E("port 0xB3 read"),0});var s=0;i.register_read(146,this,function(){return s}),i.register_write(146,this,function(a){s=a}),i.register_read(1297,this,function(){return this.fw_pointer<this.fw_value.length?this.fw_value[this.fw_pointer++]:0}),i.register_write(1296,this,void 0,function(a){function r(l){return new Uint8Array(new Int32Array([l]).buffer)}function u(l){return l>>8|l<<8&65280}function o(l){return l<<24|l<<8&16711680|l>>8&65280|l>>>24}if(E("bios config port, index="+L(a)),this.fw_pointer=0,a===Zo)this.fw_value=r(sa);else if(a===Jo)this.fw_value=r(0);else if(a===Qo)this.fw_value=r(this.memory_size[0]);else if(a===$o)this.fw_value=r(1);else if(a===ea)this.fw_value=r(1);else if(a===ta)this.fw_value=new Uint8Array(16);else if(a===ia){a=new Int32Array(4+64*this.option_roms.length);const l=new Uint8Array(a.buffer);a[0]=o(this.option_roms.length);for(let f=0;f<this.option_roms.length;f++){const{name:m,data:C}=this.option_roms[f],S=4+64*f;a[S+0>>2]=o(C.length),a[S+4>>2]=u(Ci+f),56>m.length;for(let p=0;p<m.length;p++)l[S+8+p]=m.charCodeAt(p)}this.fw_value=l}else a>=ra&&a<Ci?this.fw_value=r(0):a>=Ci&&a-Ci<this.option_roms.length?this.fw_value=this.option_roms[a-Ci].data:(E("Warning: Unimplemented fw index: "+L(a)),this.fw_value=r(0))}),this.devices={},e.load_devices&&(this.devices.pic=new Lt(this),this.devices.pci=new gt(this),this.acpi_enabled[0]&&(this.devices.ioapic=new Bt(this),this.devices.apic=new Xe(this),this.devices.acpi=new Ii(this)),this.devices.rtc=new ut(this),this.fill_cmos(this.devices.rtc,e),this.devices.dma=new Le(this),this.devices.vga=new ne(this,t,e.vga_memory_size||8388608),this.devices.ps2=new Je(this,t),this.devices.uart0=new pt(this,1016,t),e.uart1&&(this.devices.uart1=new pt(this,760,t)),e.uart2&&(this.devices.uart2=new pt(this,1e3,t)),e.uart3&&(this.devices.uart3=new pt(this,744,t)),this.devices.fdc=new Fe(this,e.fda,e.fdb),i=0,e.hda&&(this.devices.hda=new Ze(this,e.hda,e.hdb,!1,i++,t)),e.cdrom&&(this.devices.cdrom=new Ze(this,e.cdrom,void 0,!0,i++,t)),this.devices.pit=new At(this,t),e.enable_ne2k&&(this.devices.net=new ot(this,t,e.preserve_mac_from_state_image,e.mac_address_translation)),e.fs9p&&(this.devices.virtio_9p=new kt(e.fs9p,this,t)),this.devices.sb16=new se(this,t)),e.multiboot&&this.load_multiboot(e.multiboot)};ue.prototype.load_multiboot=function(e){if(E("Trying multiboot from buffer of size "+e.byteLength,zt),8192>e.byteLength){var t=new Int32Array(2048);new Uint8Array(t.buffer).set(new Uint8Array(e))}else t=new Int32Array(e,0,2048);for(var i=0;8192>i;i+=4)if(t[i>>2]===464367618){var s=t[i+4>>2];if(464367618+s+t[i+8>>2]|0)E("Multiboot checksum check failed",zt);else{E("Multiboot magic found, flags: "+L(s>>>0,8),zt),this.reg32[Vo]=732803074,this.reg32[Xo]=31744,this.write32(31744,0),this.cr[0]=1,this.protected_mode[0]=1,this.flags[0]=Ko,this.is_32[0]=1,this.stack_size_32[0]=1;for(var a=0;6>a;a++)this.segment_is_null[a]=0,this.segment_offsets[a]=0,this.segment_limits[a]=4294967295,this.sreg[a]=45058;if(s&65536){E("Multiboot specifies its own address table",zt),a=t[i+12>>2];var r=t[i+16>>2];s=t[i+20>>2];var u=t[i+24>>2];t=t[i+28>>2],E("header="+L(a,8)+" load="+L(r,8)+" load_end="+L(s,8)+" bss_end="+L(u,8)+" entry="+L(t,8)),i-=a-r,s===0?s=void 0:s-=r,e=new Uint8Array(e,i,s),this.write_blob(e,r),this.instruction_pointer[0]=this.get_seg_cs()+t|0}else if(t[0]===1179403647){E("Multiboot image is in elf format",zt),i=Gh(e),this.instruction_pointer[0]=this.get_seg_cs()+i.header.entry|0;for(r of i.program_headers)r.type!==0&&(r.type===1?(r.paddr,r.vaddr,r.filesz<=r.memsz,r.paddr+r.memsz<this.memory_size[0]?r.filesz&&(i=new Uint8Array(e,r.offset,r.filesz),this.write_blob(i,r.paddr)):E("Warning: Skipped loading section, paddr="+L(r.paddr)+" memsz="+r.memsz,zt)):r.type!==2&&r.type!==3&&r.type!==4&&r.type!==6&&r.type!==1685382480&&r.type!==1685382481&&r.type!==1685382483&&(""+L(r.type),void 0))}this.io.register_write_consecutive(244,this,function(o){throw console.log("Test exited with code "+L(o,2)),"HALT"},function(){},function(){},function(){});for(let o=14;15>=o;o++)this.io.register_write(8192+o,this,function(l){E("kvm-unit-test: Set irq "+L(o)+" to "+L(l,2)),l?this.device_raise_irq(o):this.device_lower_irq(o)});E("Starting multiboot kernel at:",zt),this.debug.dump_state(),this.debug.dump_regs();break}}};ue.prototype.fill_cmos=function(e,t){var i=t.boot_order||531;e.cmos_write(Ka,1|i>>4&240),e.cmos_write(Va,i&255),e.cmos_write(Ba,128),e.cmos_write(qa,2),i=0,1048576<=this.memory_size[0]&&(i=this.memory_size[0]-1048576>>10,i=Math.min(i,65535)),e.cmos_write(Fa,i&255),e.cmos_write(Ua,i>>8&255),e.cmos_write(Na,i&255),e.cmos_write(za,i>>8&255),i=0,16777216<=this.memory_size[0]&&(i=this.memory_size[0]-16777216>>16,i=Math.min(i,65535)),e.cmos_write(Wa,i&255),e.cmos_write(Ga,i>>8&255),e.cmos_write(Xa,0),e.cmos_write(Ya,0),e.cmos_write(Za,0),e.cmos_write(Pa,47),e.cmos_write(Ja,0),t.fastboot&&e.cmos_write(63,1)};ue.prototype.load_bios=function(){var e=this.bios.main,t=this.bios.vga;if(e){var i=new Uint8Array(e);if(this.write_blob(i,1048576-e.byteLength),t){var s=new Uint8Array(t);this.write_blob(s,786432),this.io.mmap_register(4272947200,1048576,function(a){return a=a-4272947200|0,a<s.length?s[a]:0},function(a,r){})}else E("Warning: No VGA BIOS");this.io.mmap_register(4293918720,1048576,function(a){return this.mem8[a&1048575]}.bind(this),function(a,r){this.mem8[a&1048575]=r}.bind(this))}else E("Warning: No BIOS")};ue.prototype.do_many_cycles=function(){this.do_many_cycles_native()};ue.prototype.cycle=function(){this.cycle_internal()};Ce.exportProperty(ue.prototype,"cycle",ue.prototype.cycle);ue.prototype.codegen_finalize=function(e,t,i,s,a){s>>>=0,a>>>=0;const r=new Uint8Array(this.wasm_memory.buffer,s,a);s=WebAssembly.instantiate(r,{e:this.jit_imports}).then(u=>{u=u.instance.exports.f,this.codegen_finalize_finished(e,t,i),this.wm.wasm_table.set(e+Xr,u),this.test_hook_did_finalize_wasm&&this.test_hook_did_finalize_wasm(r)})};ue.prototype.log_uncompiled_code=function(e,t){};ue.prototype.dump_function_code=function(e,t){};ue.prototype.hlt_loop=function(){if(this.get_eflags_no_arith()&Vr){const e=this.run_hardware_timers(be.microtick());return this.handle_irqs(),e}return 100};ue.prototype.run_hardware_timers=function(e){var t,i,s;t=this.devices.pit.timer(e,!1),i=this.devices.rtc.timer(e,!1),s=100;let a=100,r=100;return this.acpi_enabled[0]&&(a=this.devices.acpi.timer(e),r=this.devices.apic.timer(e)),Math.min(t,i,s,a,r)};ue.prototype.hlt_op=function(){!(this.get_eflags_no_arith()&Vr)&&this.bus.send("cpu-event-halt"),this.in_hlt[0]=1,this.hlt_loop()};ue.prototype.handle_irqs=function(){this.get_eflags_no_arith()&Vr&&(this.pic_acknowledge(),this.next_tick_immediately())};ue.prototype.pic_acknowledge=function(){this.get_eflags_no_arith()&Vr,this.devices.pic&&this.devices.pic.acknowledge_irq(),this.devices.apic&&this.devices.apic.acknowledge_irq()};ue.prototype.device_raise_irq=function(e){this.devices.pic&&this.devices.pic.set_irq(e),this.devices.ioapic&&this.devices.ioapic.set_irq(e)};ue.prototype.device_lower_irq=function(e){this.devices.pic&&this.devices.pic.clear_irq(e),this.devices.ioapic&&this.devices.ioapic.clear_irq(e)};typeof window<"u"?window.CPU=ue:typeof vt<"u"&&typeof vt.exports<"u"?vt.exports.CPU=ue:typeof importScripts=="function"&&(self.CPU=ue);ue.prototype.debug_init=function(){function e(l){}function t(){}function i(l,f,m){}var s=this,a={};this.debug=a,a.init=function(){},a.get_regs_short=t,a.dump_regs=function(){},a.get_state=e,a.dump_state=function(l){},a.dump_stack=function(l,f){},a.dump_page_structures=function(){if(s.cr[4]&Yo){E("PAE enabled");for(var l=0;4>l;l++)s.read32s(s.cr[3]+8*l)}else E("PAE disabled"),s.cr[3]},a.dump_gdt_ldt=function(){},a.dump_idt=function(){},a.get_memory_dump=function(l,f){},a.memory_hex_dump=function(l,f){},a.used_memory_dump=function(){},a.debug_interrupt=function(l){};let r,u;a.dump_code=function(l,f,m){if(!u){if(r===void 0&&(r=typeof require=="function"?require("./capstone-x86.min.js.js"):window.cs,r===void 0)){E("Warning: Missing capstone library, disassembly not available");return}u=[new r.Capstone(r.ARCH_X86,r.MODE_16),new r.Capstone(r.ARCH_X86,r.MODE_32)]}try{u[l].disasm(f,m).forEach(function(C){E(L(C.address>>>0)+": "+V.pads(C.bytes.map(S=>L(S,2).slice(-2)).join(" "),20)+" "+C.mnemonic+" "+C.op_str)}),E("")}catch{E("Could not disassemble: "+Array.from(f).map(S=>L(S,2)).join(" "))}};let o;a.dump_wasm=function(l){if(o===void 0&&(o=typeof require=="function"?require("./libwabt.js.js"):new window.WabtModule,o===void 0)){E("Warning: Missing libwabt, wasm dump not available");return}l=l.slice();try{var f=o.readWasm(l,{readDebugNames:!1});f.generateNames(),f.applyNames();const S=f.toText({foldExprs:!0,inlineExport:!0});E(S)}catch(S){var m=new Blob([l]),C=document.createElement("a");C.download="failed.wasm",C.href=window.URL.createObjectURL(m),C.dataset.downloadurl=["application/octet-stream",C.download,C.href].join(":"),C.click(),window.URL.revokeObjectURL(C.src),console.log(S.toString())}finally{f&&f.destroy()}}};const jh=1179403647;let di=DataView.prototype,ki={size:1,get:di.getUint8,set:di.setUint8},Nt={size:2,get:di.getUint16,set:di.setUint16},Ae={size:4,get:di.getUint32,set:di.setUint32},Wh=function(e){return{size:e,get:t=>-1}},Mo=$s([{magic:Ae},{class:ki},{data:ki},{version0:ki},{osabi:ki},{abiversion:ki},{pad0:Wh(7)},{type:Nt},{machine:Nt},{version1:Ae},{entry:Ae},{phoff:Ae},{shoff:Ae},{flags:Ae},{ehsize:Nt},{phentsize:Nt},{phnum:Nt},{shentsize:Nt},{shnum:Nt},{shstrndx:Nt}]);console.assert(Mo.reduce((e,t)=>e+t.size,0)===52);let Do=$s([{type:Ae},{offset:Ae},{vaddr:Ae},{paddr:Ae},{filesz:Ae},{memsz:Ae},{flags:Ae},{align:Ae}]);console.assert(Do.reduce((e,t)=>e+t.size,0)===32);let Io=$s([{name:Ae},{type:Ae},{flags:Ae},{addr:Ae},{offset:Ae},{size:Ae},{link:Ae},{info:Ae},{addralign:Ae},{entsize:Ae}]);console.assert(Io.reduce((e,t)=>e+t.size,0)===40);function $s(e){return e.map(function(t){var i=Object.keys(t);return console.assert(i.length===1),i=i[0],t=t[i],console.assert(0<t.size),{name:i,type:t,size:t.size,get:t.get,set:t.set}})}function Gh(e){e=new DataView(e);let[t,i]=Po(e,Mo);console.assert(i===52);var s;return console.assert(t.magic===jh,"Bad magic"),console.assert(t.class===1,"Unimplemented: 64 bit elf"),console.assert(t.data===1,"Unimplemented: big endian"),console.assert(t.version0===1,"Bad version0"),console.assert(t.type===2,"Unimplemented type"),console.assert(t.version1===1,"Bad version1"),console.assert(t.ehsize===52,"Bad header size"),console.assert(t.phentsize===32,"Bad program header size"),console.assert(t.shentsize===40,"Bad section header size"),[s]=Xn(Hs(e,t.phoff,t.phentsize*t.phnum),Do,t.phnum),[e]=Xn(Hs(e,t.shoff,t.shentsize*t.shnum),Io,t.shnum),{header:t,program_headers:s,sections_headers:e}}function Po(e,t){let i={},s=0;for(let a of t)t=a.get.call(e,s,!0),console.assert(i[a.name]===void 0),i[a.name]=t,s+=a.size;return[i,s]}function Xn(e,t,i){let s=[],a=0;for(var r=0;r<i;r++){let[u,o]=Po(Hs(e,a),t);s.push(u),a+=o}return[s,a]}function Hs(e,t,i){return new DataView(e.buffer,e.byteOffset+t,i)}const Kh=497,Vh=506,Xh=510,Yn=514,Yh=518,Zh=528,Zn=529,Jh=532,Qh=536,$h=540,ec=548,tc=552,ic=556,rc=560,sc=564,nc=565,oc=566,ac=568,hc=584,cc=588,Jn=600,_c=608,lc=43605,uc=1400005704,dc=255,fc=32,pc=64,vc=128;function mc(e,t,i,s){E("Trying to load kernel of size "+t.byteLength);var a=new Uint8Array(t);const r=new Uint16Array(t),u=new Uint32Array(t);var o=a[Kh]||4,l=r[Xh>>1];if(l!==lc)E("Bad checksum1: "+L(l));else if(l=r[Yn>>1]|r[Yn+2>>1]<<16,l!==uc)E("Bad checksum2: "+L(l));else{l=r[Yh>>1];var f=a[Zn],m=r[oc>>1],C=u[ic>>2],S=u[rc>>2],p=a[sc],v=a[nc],w=u[ac>>2],y=u[hc>>2],c=u[cc>>2],n=u[Jn>>2],h=u[Jn+4>>2],_=u[_c>>2];for(E("kernel boot protocol version: "+L(l)),E("flags="+L(f)+" xflags="+L(m)),E("code32_start="+L(u[Jh>>2])),E("initrd_addr_max="+L(C)),E("kernel_alignment="+L(S)),E("relocatable="+p),E("min_alignment="+L(v)),E("cmdline max="+L(w)),E("payload offset="+L(y)+" size="+L(c)),E("pref_address="+L(h)+":"+L(n)),E("init_size="+L(_)),a[Zh]=dc,a[Zn]=f&~fc&~pc|vc,r[ec>>1]=56832,r[Vh>>1]=65535,E("heap_end_ptr="+L(56832)),s+="\0",s.length<w,E("cmd_line_ptr="+L(581632)),u[tc>>2]=581632,a=0;a<s.length;a++)e[581632+a]=s.charCodeAt(a);return o=512*(o+1),E("prot_mode_kernel_start="+L(o)),s=new Uint8Array(t,0,o),t=new Uint8Array(t,o),a=o=0,i&&(o=67108864,a=i.byteLength,1048576+t.length<o,e.set(new Uint8Array(i),o)),u[Qh>>2]=o,u[$h>>2]=a,655360>524288+s.length,e.set(s,524288),e.set(t,1048576),{option_rom:{name:"genroms/kernel.bin",data:gc(32768,57344)}}}}function gc(e,t){const i=new Uint8Array(256);new Uint16Array(i.buffer)[0]=43605,i[2]=1;var s=3;for(i[s++]=250,i[s++]=184,i[s++]=e>>0,i[s++]=e>>8,i[s++]=142,i[s++]=192,i[s++]=142,i[s++]=216,i[s++]=142,i[s++]=224,i[s++]=142,i[s++]=232,i[s++]=142,i[s++]=208,i[s++]=188,i[s++]=t>>0,i[s++]=t>>8,i[s++]=234,i[s++]=0,i[s++]=0,i[s++]=e+32>>0,i[s++]=e+32>>8,e=s,t=i[e]=0,s=0;s<i.length;s++)t+=i[s];return i[e]=-t,i}var Qn=42,yc=128;function bc(e){function t(p){return!p.altKey&&o[56]&&r(56,!1),a(p,!1)}function i(p){return!p.altKey&&o[56]&&r(56,!1),a(p,!0)}function s(p){p=Object.keys(o);for(var v,w=0;w<p.length;w++)v=+p[w],o[v]&&r(v,!1);o={}}function a(p,v){var w;if((w=l.bus)&&(w=p.shiftKey&&p.ctrlKey&&(p.keyCode===73||p.keyCode===74||p.keyCode===75)||!l.emu_enabled?!1:p.target?p.target.classList.contains("phone_keyboard")||p.target.nodeName!=="INPUT"&&p.target.nodeName!=="TEXTAREA":!0),w){e:{if(p.code!==void 0&&(w=S[p.code],w!==void 0))break e;w=f[p.keyCode]}if(w)return r(w,v,p.repeat),p.preventDefault&&p.preventDefault(),!1;console.log("Missing char in map: keyCode="+(p.keyCode||-1).toString(16)+" code="+p.code)}}function r(p,v,w){if(v)o[p]&&!w&&r(p,!1);else if(!o[p])return;(o[p]=v)||(p|=128),255<p?(u(p>>8),u(p&255)):u(p)}function u(p){l.bus.send("keyboard-code",p)}var o={},l=this;this.emu_enabled=!0;var f=new Uint16Array([0,0,0,0,0,0,0,0,14,15,0,0,0,28,0,0,42,29,56,0,58,0,0,0,0,0,0,1,0,0,0,0,57,57417,57425,57423,57415,57419,57416,57421,80,0,0,0,0,82,83,0,11,2,3,4,5,6,7,8,9,10,0,39,0,13,0,0,0,30,48,46,32,18,33,34,35,23,36,37,38,50,49,24,25,16,19,31,20,22,47,17,45,21,44,57435,57436,57437,0,0,82,79,80,81,75,76,77,71,72,73,0,0,0,0,0,0,59,60,61,62,63,64,65,66,67,68,87,88,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,69,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,12,0,0,0,0,0,0,0,0,0,0,0,0,39,13,51,12,52,53,41,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,26,43,27,40,0,57435,57400,0,0,0,0,0,0,0,0,0,0,0,0,0,0]),m={8:8,10:13,32:32,39:222,44:188,45:189,46:190,47:191,48:48,49:49,50:50,51:51,52:52,53:53,54:54,55:55,56:56,57:57,59:186,61:187,91:219,92:220,93:221,96:192,97:65,98:66,99:67,100:68,101:69,102:70,103:71,104:72,105:73,106:74,107:75,108:76,109:77,110:78,111:79,112:80,113:81,114:82,115:83,116:84,117:85,118:86,119:87,120:88,121:89,122:90},C={33:49,34:222,35:51,36:52,37:53,38:55,40:57,41:48,42:56,43:187,58:186,60:188,62:190,63:191,64:50,65:65,66:66,67:67,68:68,69:69,70:70,71:71,72:72,73:73,74:74,75:75,76:76,77:77,78:78,79:79,80:80,81:81,82:82,83:83,84:84,85:85,86:86,87:87,88:88,89:89,90:90,94:54,95:189,123:219,124:220,125:221,126:192},S={Escape:1,Digit1:2,Digit2:3,Digit3:4,Digit4:5,Digit5:6,Digit6:7,Digit7:8,Digit8:9,Digit9:10,Digit0:11,Minus:12,Equal:13,Backspace:14,Tab:15,KeyQ:16,KeyW:17,KeyE:18,KeyR:19,KeyT:20,KeyY:21,KeyU:22,KeyI:23,KeyO:24,KeyP:25,BracketLeft:26,BracketRight:27,Enter:28,ControlLeft:29,KeyA:30,KeyS:31,KeyD:32,KeyF:33,KeyG:34,KeyH:35,KeyJ:36,KeyK:37,KeyL:38,Semicolon:39,Quote:40,Backquote:41,ShiftLeft:42,Backslash:43,KeyZ:44,KeyX:45,KeyC:46,KeyV:47,KeyB:48,KeyN:49,KeyM:50,Comma:51,Period:52,Slash:53,ShiftRight:54,NumpadMultiply:55,AltLeft:56,Space:57,CapsLock:58,F1:59,F2:60,F3:61,F4:62,F5:63,F6:64,F7:65,F8:66,F9:67,F10:68,NumLock:69,ScrollLock:70,Numpad7:71,Numpad8:72,Numpad9:73,NumpadSubtract:74,Numpad4:75,Numpad5:76,Numpad6:77,NumpadAdd:78,Numpad1:79,Numpad2:80,Numpad3:81,Numpad0:82,NumpadDecimal:83,IntlBackslash:86,F11:87,F12:88,NumpadEnter:57372,ControlRight:57373,NumpadDivide:57397,AltRight:57400,Home:57415,ArrowUp:57416,PageUp:57417,ArrowLeft:57419,ArrowRight:57421,End:57423,ArrowDown:57424,PageDown:57425,Insert:57426,Delete:57427,OSLeft:57435,OSRight:57436,ContextMenu:57437};this.bus=e,this.destroy=function(){typeof window<"u"&&(window.removeEventListener("keyup",t,!1),window.removeEventListener("keydown",i,!1),window.removeEventListener("blur",s,!1))},this.init=function(){typeof window<"u"&&(this.destroy(),window.addEventListener("keyup",t,!1),window.addEventListener("keydown",i,!1),window.addEventListener("blur",s,!1))},this.init(),this.simulate_press=function(p){p={keyCode:p},a(p,!0),a(p,!1)},this.simulate_char=function(p){var v=p.charCodeAt(0);v in m?this.simulate_press(m[v]):v in C?(u(Qn),this.simulate_press(C[v]),u(Qn|yc)):console.log("ascii -> keyCode not found: ",v,p)}}function wc(e,t){function i(y){if(!w.enabled||!w.emu_enabled)return!1;var c=t||document.body,n;if(!(n=document.pointerLockElement))e:{for(y=y.target;y.parentNode;){if(y===c){n=!0;break e}y=y.parentNode}n=!1}return n}function s(y){i(y)&&(y=y.changedTouches)&&y.length&&(y=y[y.length-1],p=y.clientX,v=y.clientY)}function a(y){(m||S||C)&&(w.bus.send("mouse-click",[!1,!1,!1]),m=S=C=!1)}function r(y){if(w.bus&&i(y)&&w.is_running){var c=0,n=0,h=y.changedTouches;h?h.length&&(h=h[h.length-1],c=h.clientX-p,n=h.clientY-v,p=h.clientX,v=h.clientY,y.preventDefault()):typeof y.movementX=="number"?(c=y.movementX,n=y.movementY):typeof y.webkitMovementX=="number"?(c=y.webkitMovementX,n=y.webkitMovementY):typeof y.mozMovementX=="number"?(c=y.mozMovementX,n=y.mozMovementY):(c=y.clientX-p,n=y.clientY-v,p=y.clientX,v=y.clientY),w.bus.send("mouse-delta",[.15*c,-(.15*n)]),t&&w.bus.send("mouse-absolute",[y.pageX-t.offsetLeft,y.pageY-t.offsetTop,t.offsetWidth,t.offsetHeight])}}function u(y){i(y)&&l(y,!0)}function o(y){i(y)&&l(y,!1)}function l(y,c){w.bus&&(y.which===1?m=c:y.which===2?S=c:y.which===3?C=c:E("Unknown event.which: "+y.which),w.bus.send("mouse-click",[m,S,C]),y.preventDefault())}function f(y){if(i(y)){var c=y.wheelDelta||-y.detail;0>c?c=-1:0<c&&(c=1),w.bus.send("mouse-wheel",[c,0]),y.preventDefault()}}var m=!1,C=!1,S=!1,p=0,v=0,w=this;this.enabled=!1,this.emu_enabled=!0,this.bus=e,this.bus.register("mouse-enable",function(y){this.enabled=y},this),this.is_running=!1,this.bus.register("emulator-stopped",function(){this.is_running=!1},this),this.bus.register("emulator-started",function(){this.is_running=!0},this),this.destroy=function(){typeof window<"u"&&(window.removeEventListener("touchstart",s,!1),window.removeEventListener("touchend",a,!1),window.removeEventListener("touchmove",r,!1),window.removeEventListener("mousemove",r,!1),window.removeEventListener("mousedown",u,!1),window.removeEventListener("mouseup",o,!1),window.removeEventListener("wheel",f,{passive:!1}))},this.init=function(){typeof window<"u"&&(this.destroy(),window.addEventListener("touchstart",s,!1),window.addEventListener("touchend",a,!1),window.addEventListener("touchmove",r,!1),window.addEventListener("mousemove",r,!1),window.addEventListener("mousedown",u,!1),window.addEventListener("mouseup",o,!1),window.addEventListener("wheel",f,{passive:!1}))},this.init()}var Bo=.2,Sc=8e3;function qo(e){if(typeof window<"u")if(window.AudioContext||window.webkitAudioContext){var t=window.AudioWorklet?en:tn;this.bus=e,this.audio_context=window.AudioContext?new AudioContext:new webkitAudioContext,this.mixer=new gi(e,this.audio_context),this.pcspeaker=new Fo(e,this.audio_context,this.mixer),this.dac=new t(e,this.audio_context,this.mixer),this.pcspeaker.start(),e.register("emulator-stopped",function(){this.audio_context.suspend()},this),e.register("emulator-started",function(){this.audio_context.resume()},this),e.register("speaker-confirm-initialized",function(){e.send("speaker-has-initialized")},this),e.send("speaker-has-initialized")}else console.warn("Web browser doesn't support Web Audio API")}qo.prototype.destroy=function(){this.audio_context&&this.audio_context.close(),this.dac&&this.dac.node_processor&&this.dac.node_processor.port.close()};function gi(e,t){function i(s){return function(a){s.gain.setValueAtTime(a,this.audio_context.currentTime)}}this.audio_context=t,this.sources=new Map,this.gain_right=this.gain_left=this.volume_right=this.volume_left=this.volume_both=1,this.node_treble_left=this.audio_context.createBiquadFilter(),this.node_treble_right=this.audio_context.createBiquadFilter(),this.node_treble_left.type="highshelf",this.node_treble_right.type="highshelf",this.node_treble_left.frequency.setValueAtTime(2e3,this.audio_context.currentTime),this.node_treble_right.frequency.setValueAtTime(2e3,this.audio_context.currentTime),this.node_bass_left=this.audio_context.createBiquadFilter(),this.node_bass_right=this.audio_context.createBiquadFilter(),this.node_bass_left.type="lowshelf",this.node_bass_right.type="lowshelf",this.node_bass_left.frequency.setValueAtTime(200,this.audio_context.currentTime),this.node_bass_right.frequency.setValueAtTime(200,this.audio_context.currentTime),this.node_gain_left=this.audio_context.createGain(),this.node_gain_right=this.audio_context.createGain(),this.node_merger=this.audio_context.createChannelMerger(2),this.input_left=this.node_treble_left,this.input_right=this.node_treble_right,this.node_treble_left.connect(this.node_bass_left),this.node_bass_left.connect(this.node_gain_left),this.node_gain_left.connect(this.node_merger,0,0),this.node_treble_right.connect(this.node_bass_right),this.node_bass_right.connect(this.node_gain_right),this.node_gain_right.connect(this.node_merger,0,1),this.node_merger.connect(this.audio_context.destination),e.register("mixer-connect",function(s){this.connect_source(s[0],s[1])},this),e.register("mixer-disconnect",function(s){this.disconnect_source(s[0],s[1])},this),e.register("mixer-volume",function(s){var a=s[0],r=s[1];s=Math.pow(10,s[2]/20);var u=a===js?this:this.sources.get(a);u===void 0?void 0:u.set_volume(s,r)},this),e.register("mixer-gain-left",function(s){this.gain_left=Math.pow(10,s/20),this.update()},this),e.register("mixer-gain-right",function(s){this.gain_right=Math.pow(10,s/20),this.update()},this),e.register("mixer-treble-left",i(this.node_treble_left),this),e.register("mixer-treble-right",i(this.node_treble_right),this),e.register("mixer-bass-left",i(this.node_bass_left),this),e.register("mixer-bass-right",i(this.node_bass_right),this)}gi.prototype.add_source=function(e,t){return e=new yi(this.audio_context,e,this.input_left,this.input_right),this.sources.has(t),this.sources.set(t,e),e};gi.prototype.connect_source=function(e,t){var i=this.sources.get(e);i===void 0?void 0:i.connect(t)};gi.prototype.disconnect_source=function(e,t){var i=this.sources.get(e);i===void 0?void 0:i.disconnect(t)};gi.prototype.set_volume=function(e,t){switch(t===void 0&&(t=ei),t){case pi:this.volume_left=e;break;case vi:this.volume_right=e;break;case ei:this.volume_both=e;break;default:return}this.update()};gi.prototype.update=function(){var e=this.volume_both*this.volume_right*this.gain_right;this.node_gain_left.gain.setValueAtTime(this.volume_both*this.volume_left*this.gain_left,this.audio_context.currentTime),this.node_gain_right.gain.setValueAtTime(e,this.audio_context.currentTime)};function yi(e,t,i,s){this.audio_context=e,this.connected_right=this.connected_left=!0,this.volume_right=this.volume_left=this.volume_both=this.gain_hidden=1,this.node_splitter=e.createChannelSplitter(2),this.node_gain_left=e.createGain(),this.node_gain_right=e.createGain(),t.connect(this.node_splitter),this.node_splitter.connect(this.node_gain_left,0),this.node_gain_left.connect(i),this.node_splitter.connect(this.node_gain_right,1),this.node_gain_right.connect(s)}yi.prototype.update=function(){var e=this.connected_right*this.gain_hidden*this.volume_both*this.volume_right;this.node_gain_left.gain.setValueAtTime(this.connected_left*this.gain_hidden*this.volume_both*this.volume_left,this.audio_context.currentTime),this.node_gain_right.gain.setValueAtTime(e,this.audio_context.currentTime)};yi.prototype.connect=function(e){var t=!e||e===ei;(t||e===pi)&&(this.connected_left=!0),(t||e===vi)&&(this.connected_right=!0),this.update()};yi.prototype.disconnect=function(e){var t=!e||e===ei;(t||e===pi)&&(this.connected_left=!1),(t||e===vi)&&(this.connected_right=!1),this.update()};yi.prototype.set_volume=function(e,t){switch(t===void 0&&(t=ei),t){case pi:this.volume_left=e;break;case vi:this.volume_right=e;break;case ei:this.volume_both=e;break;default:return}this.update()};yi.prototype.set_gain_hidden=function(e){this.gain_hidden=e};function Fo(e,t,i){this.node_oscillator=t.createOscillator(),this.node_oscillator.type="square",this.node_oscillator.frequency.setValueAtTime(440,t.currentTime),this.mixer_connection=i.add_source(this.node_oscillator,qr),this.mixer_connection.disconnect(),e.register("pcspeaker-enable",function(){i.connect_source(qr)},this),e.register("pcspeaker-disable",function(){i.disconnect_source(qr)},this),e.register("pcspeaker-update",function(s){var a=s[1],r=0;s[0]===3&&(r=1e3*ii/a,r=Math.min(r,this.node_oscillator.frequency.maxValue),r=Math.max(r,0)),this.node_oscillator.frequency.setValueAtTime(r,t.currentTime)},this)}Fo.prototype.start=function(){this.node_oscillator.start()};function en(e,t,i){this.bus=e,this.audio_context=t,this.enabled=!1,this.sampling_rate=48e3,t=function(){function u(f){return f===0?1:(f*=Math.PI,Math.sin(f)/f)}function o(){var f=Reflect.construct(AudioWorkletProcessor,[],o);return f.kernel_size=3,f.queue_data=Array(1024),f.queue_start=0,f.queue_end=0,f.queue_length=0,f.queue_size=f.queue_data.length,f.queued_samples=0,f.source_buffer_previous=l,f.source_buffer_current=l,f.source_samples_per_destination=1,f.source_block_start=0,f.source_time=0,f.source_offset=0,f.port.onmessage=m=>{switch(m.data.type){case"queue":f.queue_push(m.data.value);break;case"sampling-rate":f.source_samples_per_destination=m.data.value/sampleRate}},f}var l=[new Float32Array(256),new Float32Array(256)];Reflect.setPrototypeOf(o.prototype,AudioWorkletProcessor.prototype),Reflect.setPrototypeOf(o,AudioWorkletProcessor),o.prototype.process=o.prototype.process=function(f,m,C){for(f=0;f<m[0][0].length;f++){for(var S=C=0,p=this.source_offset+this.kernel_size,v=this.source_offset-this.kernel_size+1;v<=p;v++){var w=this.source_block_start+v;C+=this.get_sample(w,0)*this.kernel(this.source_time-v),S+=this.get_sample(w,1)*this.kernel(this.source_time-v)}(isNaN(C)||isNaN(S))&&(C=S=0,this.dbg_log("ERROR: NaN values! Ignoring for now.")),m[0][0][f]=C,m[0][1][f]=S,this.source_time+=this.source_samples_per_destination,this.source_offset=Math.floor(this.source_time)}return m=this.source_offset,m+=this.kernel_size+2,this.source_time-=this.source_offset,this.source_block_start+=this.source_offset,this.source_offset=0,this.ensure_enough_data(m),!0},o.prototype.kernel=function(f){return u(f)*u(f/this.kernel_size)},o.prototype.get_sample=function(f,m){return 0>f?(f+=this.source_buffer_previous[0].length,this.source_buffer_previous[m][f]):this.source_buffer_current[m][f]},o.prototype.ensure_enough_data=function(f){var m=this.source_buffer_current[0].length;m-this.source_block_start<f&&(this.prepare_next_buffer(),this.source_block_start-=m)},o.prototype.prepare_next_buffer=function(){256>this.queued_samples&&this.queue_length&&this.dbg_log("Not enough samples - should not happen during midway of playback"),this.source_buffer_previous=this.source_buffer_current,this.source_buffer_current=this.queue_shift();var f=this.source_buffer_current[0].length;if(256>f){for(var m=this.queue_start,C=0;256>f&&C<this.queue_length;)f+=this.queue_data[m][0].length,m=m+1&this.queue_size-1,C++;f=Math.max(f,256),f=[new Float32Array(f),new Float32Array(f)],f[0].set(this.source_buffer_current[0]),f[1].set(this.source_buffer_current[1]),m=this.source_buffer_current[0].length;for(var S=0;S<C;S++){var p=this.queue_shift();f[0].set(p[0],m),f[1].set(p[1],m),m+=p[0].length}this.source_buffer_current=f}this.pump()},o.prototype.pump=function(){1024>this.queued_samples/this.source_samples_per_destination&&this.port.postMessage({type:"pump"})},o.prototype.queue_push=function(f){this.queue_length<this.queue_size&&(this.queue_data[this.queue_end]=f,this.queue_end=this.queue_end+1&this.queue_size-1,this.queue_length++,this.queued_samples+=f[0].length,this.pump())},o.prototype.queue_shift=function(){if(!this.queue_length)return l;var f=this.queue_data[this.queue_start];return this.queue_data[this.queue_start]=null,this.queue_start=this.queue_start+1&this.queue_size-1,this.queue_length--,this.queued_samples-=f[0].length,f},o.prototype.dbg_log=function(f){},registerProcessor("dac-processor",o)}.toString();var s=t.indexOf("{")+1,a=t.lastIndexOf("}");t=t.substring(s,a),t=new Blob([t],{type:"application/javascript"});var r=URL.createObjectURL(t);this.node_processor=null,this.node_output=this.audio_context.createGain(),this.audio_context.audioWorklet.addModule(r).then(()=>{URL.revokeObjectURL(r),this.node_processor=new AudioWorkletNode(this.audio_context,"dac-processor",{numberOfInputs:0,numberOfOutputs:1,outputChannelCount:[2],parameterData:{},processorOptions:{}}),this.node_processor.port.postMessage({type:"sampling-rate",value:this.sampling_rate}),this.node_processor.port.onmessage=u=>{switch(u.data.type){case"pump":this.pump();break;case"debug-log":E("SpeakerWorkletDAC - Worklet: "+u.data.value)}},this.node_processor.connect(this.node_output)}),this.mixer_connection=i.add_source(this.node_output,Yr),this.mixer_connection.set_gain_hidden(3),e.register("dac-send-data",function(u){this.queue(u)},this),e.register("dac-enable",function(u){this.enabled=!0},this),e.register("dac-disable",function(){this.enabled=!1},this),e.register("dac-tell-sampling-rate",function(u){this.sampling_rate=u,this.node_processor&&this.node_processor.port.postMessage({type:"sampling-rate",value:u})},this)}en.prototype.queue=function(e){this.node_processor&&this.node_processor.port.postMessage({type:"queue",value:e},[e[0].buffer,e[1].buffer])};en.prototype.pump=function(){this.enabled&&this.bus.send("dac-request-data")};function tn(e,t,i){this.bus=e,this.audio_context=t,this.enabled=!1,this.sampling_rate=22050,this.buffered_time=0,this.rate_ratio=1,this.node_lowpass=this.audio_context.createBiquadFilter(),this.node_lowpass.type="lowpass",this.node_output=this.node_lowpass,this.mixer_connection=i.add_source(this.node_output,Yr),this.mixer_connection.set_gain_hidden(3),e.register("dac-send-data",function(s){this.queue(s)},this),e.register("dac-enable",function(s){this.enabled=!0,this.pump()},this),e.register("dac-disable",function(){this.enabled=!1},this),e.register("dac-tell-sampling-rate",function(s){this.sampling_rate=s,this.rate_ratio=Math.ceil(Sc/s),this.node_lowpass.frequency.setValueAtTime(s/2,this.audio_context.currentTime)},this)}tn.prototype.queue=function(e){var t=e[0].length,i=t/this.sampling_rate;if(1<this.rate_ratio)for(var s=this.audio_context.createBuffer(2,t*this.rate_ratio,this.sampling_rate*this.rate_ratio),a=s.getChannelData(0),r=s.getChannelData(1),u=0,o=0;o<t;o++)for(var l=0;l<this.rate_ratio;l++,u++)a[u]=e[0][o],r[u]=e[1][o];else s=this.audio_context.createBuffer(2,t,this.sampling_rate),s.copyToChannel?(s.copyToChannel(e[0],0),s.copyToChannel(e[1],1)):(s.getChannelData(0).set(e[0]),s.getChannelData(1).set(e[1]));if(e=this.audio_context.createBufferSource(),e.buffer=s,e.connect(this.node_lowpass),e.addEventListener("ended",this.pump.bind(this)),s=this.audio_context.currentTime,this.buffered_time<s)for(E("Speaker DAC - Creating/Recreating reserve - shouldn't occur frequently during playback"),this.buffered_time=s,s=Bo-i,t=0;t<=s;)t+=i,this.buffered_time+=i,setTimeout(()=>this.pump(),1e3*t);e.start(this.buffered_time),this.buffered_time+=i,setTimeout(()=>this.pump(),0)};tn.prototype.pump=function(){this.enabled&&(this.buffered_time-this.audio_context.currentTime>Bo||this.bus.send("dac-request-data"))};function Cc(e,t){function i(o){u.bus&&u.enabled&&(u.send_char(o.which),o.preventDefault())}function s(o){var l=o.which;l===8?(u.send_char(127),o.preventDefault()):l===9&&(u.send_char(9),o.preventDefault())}function a(o){if(u.enabled){for(var l=o.clipboardData.getData("text/plain"),f=0;f<l.length;f++)u.send_char(l.charCodeAt(f));o.preventDefault()}}function r(o){o.target!==e&&e.blur()}var u=this;this.enabled=!0,this.bus=t,this.text="",this.text_new_line=!1,this.last_update=0,this.bus.register("serial0-output-char",function(o){this.show_char(o)},this),this.destroy=function(){e.removeEventListener("keypress",i,!1),e.removeEventListener("keydown",s,!1),e.removeEventListener("paste",a,!1),window.removeEventListener("mousedown",r,!1)},this.init=function(){this.destroy(),e.style.display="block",e.addEventListener("keypress",i,!1),e.addEventListener("keydown",s,!1),e.addEventListener("paste",a,!1),window.addEventListener("mousedown",r,!1)},this.init(),this.show_char=function(o){o==="\b"?(this.text=this.text.slice(0,-1),this.update()):o!=="\r"&&(this.text+=o,o===`
`&&(this.text_new_line=!0),this.update())},this.update=function(){var o=Date.now(),l=o-this.last_update;16>l?this.update_timer===void 0&&(this.update_timer=setTimeout(()=>{this.update_timer=void 0;var f=Date.now();15<=f-this.last_update,this.last_update=f,this.render()},16-l)):(this.update_timer!==void 0&&(clearTimeout(this.update_timer),this.update_timer=void 0),this.last_update=o,this.render())},this.render=function(){e.value=this.text,this.text_new_line&&(this.text_new_line=!1,e.scrollTop=1e9)},this.send_char=function(o){u.bus&&u.bus.send("serial0-input",o)}}function Uo(e,t,i){if(this.element=e,i){var s=this.term=new i;s.setOption("logLevel","off"),s.write("This is the serial console. Whatever you type or paste here will be sent to COM1");var a=s.onData(function(r){for(let u=0;u<r.length;u++)t.send("serial0-input",r.charCodeAt(u))});t.register("serial0-output-char",function(r){s.write(r)},this),this.destroy=function(){a.dispose(),s.dispose()}}}Uo.prototype.show=function(){this.term&&this.term.open(this.element)};function qt(e,t){this.bus=t,this.socket=void 0,this.send_queue=[],this.url=e,this.reconnect_interval=1e4,this.last_connect_attempt=Date.now()-this.reconnect_interval,this.send_queue_limit=64,this.bus.register("net0-send",function(i){this.send(i)},this)}qt.prototype.handle_message=function(e){this.bus&&this.bus.send("net0-receive",new Uint8Array(e.data))};qt.prototype.handle_close=function(e){this.connect(),setTimeout(this.connect.bind(this),this.reconnect_interval)};qt.prototype.handle_open=function(e){for(e=0;e<this.send_queue.length;e++)this.send(this.send_queue[e]);this.send_queue=[]};qt.prototype.handle_error=function(e){};qt.prototype.destroy=function(){this.socket&&this.socket.close()};qt.prototype.connect=function(){if(typeof WebSocket<"u"){if(this.socket){var e=this.socket.readyState;if(e===0||e===1)return}e=Date.now(),this.last_connect_attempt+this.reconnect_interval>e||(this.last_connect_attempt=Date.now(),this.socket=new WebSocket(this.url),this.socket.binaryType="arraybuffer",this.socket.onopen=this.handle_open.bind(this),this.socket.onmessage=this.handle_message.bind(this),this.socket.onclose=this.handle_close.bind(this),this.socket.onerror=this.handle_error.bind(this))}};qt.prototype.send=function(e){this.socket&&this.socket.readyState===1?this.socket.send(e):(this.send_queue.push(e),this.send_queue.length>2*this.send_queue_limit&&(this.send_queue=this.send_queue.slice(-this.send_queue_limit)),this.connect())};qt.prototype.change_proxy=function(e){this.url=e,this.socket&&(this.socket.onclose=function(){},this.socket.onerror=function(){},this.socket.close(),this.socket=void 0)};(function(){function e(o,l,f){function m(){const w=f||0;setTimeout(()=>{e(o,l,w+1)},1e3*([1,1,2,3,5,8,13,21][w]||34))}var C=new XMLHttpRequest;if(C.open(l.method||"get",o,!0),C.responseType=l.as_json?"json":"arraybuffer",l.headers)for(var S=Object.keys(l.headers),p=0;p<S.length;p++){var v=S[p];C.setRequestHeader(v,l.headers[v])}l.range&&(S=l.range.start,C.setRequestHeader("Range","bytes="+S+"-"+(S+l.range.length-1)),C.onreadystatechange=function(){C.status===200&&C.abort()}),C.onload=function(w){C.readyState===4&&(C.status!==200&&C.status!==206?(console.error("Loading the image "+o+" failed (status %d)",C.status),500<=C.status&&600>C.status&&m()):C.response&&l.done&&l.done(C.response,C))},C.onerror=function(w){console.error("Loading the image "+o+" failed",w),m()},l.progress&&(C.onprogress=function(w){l.progress(w)}),C.send(null)}function t(o,l){let f=require("fs");l.range?(l.as_json,f.open(o,"r",(m,C)=>{if(m)throw m;let S=l.range.length;var p=Buffer.allocUnsafe(S);f.read(C,p,0,S,l.range.start,(v,w)=>{if(v)throw v;l.done&&l.done(new Uint8Array(p)),f.close(C,y=>{if(y)throw y})})})):f.readFile(o,{encoding:l.as_json?"utf-8":null},function(m,C){m?console.log("Could not read file:",o,m):(m=C,m=l.as_json?JSON.parse(m):new Uint8Array(m).buffer,l.done(m))})}function i(o,l){this.filename=o,this.block_size=256,this.byteLength=l,this.block_cache=new Map,this.block_cache_is_write=new Set,this.onprogress=this.onload=void 0}function s(o,l,f,m){const C=o.match(/(.*)(\..*)/);C?(this.basename=C[1],this.extension=C[2]):(this.basename=o,this.extension=""),this.block_size=256,this.block_cache=new Map,this.block_cache_is_write=new Set,this.byteLength=l,this.fixed_chunk_size=f,this.partfile_alt_format=!!m,this.cache_reads=!!f,this.onprogress=this.onload=void 0}function a(o){this.file=o,this.byteLength=o.size,1073741824<o.size&&console.warn("SyncFileBuffer: Allocating buffer of "+(o.size>>20)+" MB ..."),this.buffer=new ArrayBuffer(o.size),this.onprogress=this.onload=void 0}function r(o){this.file=o,this.byteLength=o.size,this.block_size=256,this.block_cache=new Map,this.block_cache_is_write=new Set,this.onprogress=this.onload=void 0}V.load_file=typeof XMLHttpRequest>"u"?t:e,V.AsyncXHRBuffer=i,V.AsyncXHRPartfileBuffer=s,V.AsyncFileBuffer=r,V.SyncFileBuffer=a,V.read_sized_string_from_mem=function(o,l,f){return String.fromCharCode(...new Uint8Array(o.buffer,l>>>0,f>>>0))};var u=typeof XMLHttpRequest>"u"?function(o,l){require("fs").stat(o,(f,m)=>{f?l(f):l(null,m.size)})}:function(o,l){V.load_file(o,{done:(f,m)=>{f=m.getResponseHeader("Content-Range")||"",(m=f.match(/\/(\d+)\s*$/))?l(null,+m[1]):l("`Range: bytes=...` header not supported (Got `"+f+"`)")},headers:{Range:"bytes=0-0"}})};i.prototype.load=function(){this.byteLength!==void 0?this.onload&&this.onload(Object.create(null)):u(this.filename,(o,l)=>{if(o)throw Error("Cannot use: "+this.filename+". "+o);this.byteLength=l,this.onload&&this.onload(Object.create(null))})},i.prototype.get_from_cache=function(o,l){var f=l/this.block_size;o/=this.block_size;for(var m=0;m<f;m++)if(!this.block_cache.get(o+m))return;if(f===1)return this.block_cache.get(o);for(l=new Uint8Array(l),m=0;m<f;m++)l.set(this.block_cache.get(o+m),m*this.block_size);return l},i.prototype.get=function(o,l,f){console.assert(o+l<=this.byteLength),console.assert(o%this.block_size===0),console.assert(l%this.block_size===0),console.assert(l);var m=this.get_from_cache(o,l);m?f(m):V.load_file(this.filename,{done:function(C){C=new Uint8Array(C),this.handle_read(o,l,C),f(C)}.bind(this),range:{start:o,length:l}})},i.prototype.set=function(o,l,f){console.assert(o+l.byteLength<=this.byteLength);var m=l.length;console.assert(o%this.block_size===0),console.assert(m%this.block_size===0),console.assert(m),o/=this.block_size,m/=this.block_size;for(var C=0;C<m;C++){var S=this.block_cache.get(o+C);S===void 0&&(S=new Uint8Array(this.block_size),this.block_cache.set(o+C,S));var p=l.subarray(C*this.block_size,(C+1)*this.block_size);S.set(p),console.assert(S.byteLength===p.length),this.block_cache_is_write.add(o+C)}f()},i.prototype.handle_read=function(o,l,f){o/=this.block_size,l/=this.block_size;for(var m=0;m<l;m++){var C=this.block_cache.get(o+m);C?f.set(C,m*this.block_size):this.cache_reads&&(C=new Uint8Array(this.block_size),C.set(f.subarray(m*this.block_size,(m+1)*this.block_size)),this.block_cache.set(o+m,C))}},i.prototype.get_buffer=function(o){o()},i.prototype.get_state=function(){const o=[],l=[];for(let[f,m]of this.block_cache)this.block_cache_is_write.has(f)&&l.push([f,m]);return o[0]=l,o},i.prototype.set_state=function(o){o=o[0],this.block_cache.clear(),this.block_cache_is_write.clear();for(let[l,f]of o)this.block_cache.set(l,f),this.block_cache_is_write.add(l)},s.prototype.load=function(){this.byteLength===void 0&&void 0,this.onload&&this.onload(Object.create(null))},s.prototype.get=function(o,l,f){console.assert(o+l<=this.byteLength),console.assert(o%this.block_size===0),console.assert(l%this.block_size===0),console.assert(l);var m=this.get_from_cache(o,l);if(m)f(m);else if(this.fixed_chunk_size){const S=Math.floor(o/this.fixed_chunk_size),p=o-S*this.fixed_chunk_size,v=Math.ceil((p+l)/this.fixed_chunk_size),w=new Uint8Array(v*this.fixed_chunk_size);let y=0;for(let c=0;c<v;c++){var C=(S+c)*this.fixed_chunk_size;m=this.partfile_alt_format?this.basename+"-"+(S+c+"").padStart(8,"0")+this.extension:this.basename+"-"+C+"-"+(C+this.fixed_chunk_size)+this.extension,(C=this.get_from_cache(C,this.fixed_chunk_size))?(w.set(C,c*this.fixed_chunk_size),y++,y===v&&(m=w.subarray(p,p+l),f(m))):V.load_file(m,{done:function(n){var h=c*this.fixed_chunk_size;n=new Uint8Array(n),this.handle_read((S+c)*this.fixed_chunk_size,this.fixed_chunk_size|0,n),w.set(n,h),y++,y===v&&(h=w.subarray(p,p+l),f(h))}.bind(this)})}}else V.load_file(this.basename+"-"+o+"-"+(o+l)+this.extension,{done:function(S){S.byteLength,S=new Uint8Array(S),this.handle_read(o,l,S),f(S)}.bind(this)})},s.prototype.get_from_cache=i.prototype.get_from_cache,s.prototype.set=i.prototype.set,s.prototype.handle_read=i.prototype.handle_read,s.prototype.get_state=i.prototype.get_state,s.prototype.set_state=i.prototype.set_state,a.prototype.load=function(){this.load_next(0)},a.prototype.load_next=function(o){var l=new FileReader;if(l.onload=function(m){m=new Uint8Array(m.target.result),new Uint8Array(this.buffer,o).set(m),this.load_next(o+4194304)}.bind(this),this.onprogress&&this.onprogress({loaded:o,total:this.byteLength,lengthComputable:!0}),o<this.byteLength){var f=this.file.slice(o,Math.min(o+4194304,this.byteLength));l.readAsArrayBuffer(f)}else this.file=void 0,this.onload&&this.onload({buffer:this.buffer})},a.prototype.get=function(o,l,f){console.assert(o+l<=this.byteLength),f(new Uint8Array(this.buffer,o,l))},a.prototype.set=function(o,l,f){console.assert(o+l.byteLength<=this.byteLength),new Uint8Array(this.buffer,o,l.byteLength).set(l),f()},a.prototype.get_buffer=function(o){o(this.buffer)},a.prototype.get_state=function(){const o=[];return o[0]=this.byteLength,o[1]=new Uint8Array(this.buffer),o},a.prototype.set_state=function(o){this.byteLength=o[0],this.buffer=o[1].slice().buffer},r.prototype.load=function(){this.onload&&this.onload(Object.create(null))},r.prototype.get=function(o,l,f){console.assert(o%this.block_size===0),console.assert(l%this.block_size===0),console.assert(l);var m=this.get_from_cache(o,l);m?f(m):(m=new FileReader,m.onload=function(C){C=new Uint8Array(C.target.result),this.handle_read(o,l,C),f(C)}.bind(this),m.readAsArrayBuffer(this.file.slice(o,o+l)))},r.prototype.get_from_cache=i.prototype.get_from_cache,r.prototype.set=i.prototype.set,r.prototype.handle_read=i.prototype.handle_read,r.prototype.get_state=i.prototype.get_state,r.prototype.get_buffer=function(o){o()},r.prototype.get_as_file=function(o){for(var l=[],f=Array.from(this.block_cache.keys()).sort(function(v,w){return v-w}),m=0,C=0;C<f.length;C++){var S=f[C],p=this.block_cache.get(S);S*=this.block_size,console.assert(S>=m),S!==m&&(l.push(this.file.slice(m,S)),m=S),l.push(p),m+=p.length}return m!==this.file.size&&l.push(this.file.slice(m)),o=new File(l,o),console.assert(o.size===this.file.size),o}})();function J(e){this.cpu_is_running=!1;var t=To.create();this.bus=t[0],this.emulator_bus=t[1];var i,s;const a=new WebAssembly.Table({element:"anyfunc",initial:to+Xr});t={cpu_exception_hook:u=>this.cpu_exception_hook&&this.cpu_exception_hook(u),hlt_op:function(){return i.hlt_op()},abort:function(){},microtick:be.microtick,get_rand_int:function(){return V.get_rand_int()},pic_acknowledge:function(){i.pic_acknowledge()},io_port_read8:function(u){return i.io.port_read8(u)},io_port_read16:function(u){return i.io.port_read16(u)},io_port_read32:function(u){return i.io.port_read32(u)},io_port_write8:function(u,o){i.io.port_write8(u,o)},io_port_write16:function(u,o){i.io.port_write16(u,o)},io_port_write32:function(u,o){i.io.port_write32(u,o)},mmap_read8:function(u){return i.mmap_read8(u)},mmap_read16:function(u){return i.mmap_read16(u)},mmap_read32:function(u){return i.mmap_read32(u)},mmap_write8:function(u,o){i.mmap_write8(u,o)},mmap_write16:function(u,o){i.mmap_write16(u,o)},mmap_write32:function(u,o){i.mmap_write32(u,o)},mmap_write64:function(u,o,l){i.mmap_write64(u,o,l)},mmap_write128:function(u,o,l,f,m){i.mmap_write128(u,o,l,f,m)},log_from_wasm:function(u,o){u=V.read_sized_string_from_mem(s,u,o),E(u,zt)},console_log_from_wasm:function(u,o){u=V.read_sized_string_from_mem(s,u,o),console.error(u)},dbg_trace_from_wasm:function(){},codegen_finalize:(u,o,l,f,m)=>{i.codegen_finalize(u,o,l,f,m)},jit_clear_func:u=>i.jit_clear_func(u),jit_clear_all_funcs:()=>i.jit_clear_all_funcs(),__indirect_function_table:a};let r=e.wasm_fn;r||(r=u=>new Promise(o=>{let l="v86.wasm",f="v86-fallback.wasm";if(e.wasm_path){l=e.wasm_path;const m=l.lastIndexOf("/");f=(m===-1?"":l.substr(0,m))+"/"+f}else typeof window>"u"&&typeof __dirname=="string"?(l=__dirname+"/"+l,f=__dirname+"/"+f):(l="build/"+l,f="build/"+f);V.load_file(l,{done:async m=>{try{const{instance:C}=await WebAssembly.instantiate(m,u);o(C.exports)}catch{V.load_file(f,{done:async S=>{({instance:S}=await WebAssembly.instantiate(S,u)),o(S.exports)}})}},progress:m=>{this.emulator_bus.send("download-progress",{file_index:0,file_count:1,file_name:l,lengthComputable:m.lengthComputable,total:m.total,loaded:m.loaded})}})})),r({env:t}).then(u=>{s=u.memory,u.rust_init(),u=this.v86=new be(this.emulator_bus,{exports:u,wasm_table:a}),i=u.cpu,this.continue_init(u,e)})}J.prototype.continue_init=async function(e,t){function i(p,v){switch(p){case"hda":r.hda=this.disk_images.hda=v;break;case"hdb":r.hdb=this.disk_images.hdb=v;break;case"cdrom":r.cdrom=this.disk_images.cdrom=v;break;case"fda":r.fda=this.disk_images.fda=v;break;case"fdb":r.fdb=this.disk_images.fdb=v;break;case"multiboot":r.multiboot=this.disk_images.multiboot=v.buffer;break;case"bzimage":r.bzimage=this.disk_images.bzimage=v.buffer;break;case"initrd":r.initrd=this.disk_images.initrd=v.buffer;break;case"bios":r.bios=v.buffer;break;case"vga_bios":r.vga_bios=v.buffer;break;case"initial_state":r.initial_state=v.buffer;break;case"fs9p_json":r.fs9p_json=v;break}}function s(p,v){v&&(v.get&&v.set&&v.load?u.push({name:p,loadable:v}):((p==="bios"||p==="vga_bios"||p==="initial_state"||p==="multiboot"||p==="bzimage"||p==="initrd")&&(v.async=!1),v.buffer instanceof ArrayBuffer?(v=new lt(v.buffer),u.push({name:p,loadable:v})):typeof File<"u"&&v.buffer instanceof File?(v.async===void 0&&(v.async=268435456<=v.buffer.size),v=v.async?new V.AsyncFileBuffer(v.buffer):new V.SyncFileBuffer(v.buffer),u.push({name:p,loadable:v})):v.url?v.async?(v=v.use_parts?new V.AsyncXHRPartfileBuffer(v.url,v.size,v.fixed_chunk_size):new V.AsyncXHRBuffer(v.url,v.size),u.push({name:p,loadable:v})):u.push({name:p,url:v.url,size:v.size}):E("Ignored file: url="+v.url+" buffer="+v.buffer)))}async function a(){if(r.fs9p&&r.fs9p_json){if(r.initial_state?E("Filesystem basefs ignored: Overridden by state image"):r.fs9p.load_from_json(r.fs9p_json),t.bzimage_initrd_from_filesystem){const{bzimage_path:p,initrd_path:v}=this.get_bzimage_initrd_from_filesystem(r.fs9p);E("Found bzimage: "+p+" and initrd: "+v);const[w,y]=await Promise.all([r.fs9p.read_file(v),r.fs9p.read_file(p)]);i.call(this,"initrd",new lt(w.buffer)),i.call(this,"bzimage",new lt(y.buffer))}}else console.assert(!t.bzimage_initrd_from_filesystem,"bzimage_initrd_from_filesystem: Requires a filesystem");this.serial_adapter&&this.serial_adapter.show&&this.serial_adapter.show(),this.bus.send("cpu-init",r),r.initial_state&&(e.restore_state(r.initial_state),r.initial_state=void 0),t.autostart&&this.bus.send("cpu-run"),this.emulator_bus.send("emulator-loaded")}this.bus.register("emulator-stopped",function(){this.cpu_is_running=!1},this),this.bus.register("emulator-started",function(){this.cpu_is_running=!0},this);var r={};this.disk_images={fda:void 0,fdb:void 0,hda:void 0,hdb:void 0,cdrom:void 0},r.acpi=t.acpi,r.load_devices=!0,r.log_level=t.log_level,r.memory_size=t.memory_size||67108864,r.vga_memory_size=t.vga_memory_size||8388608,r.boot_order=t.boot_order||531,r.fastboot=t.fastboot||!1,r.fda=void 0,r.fdb=void 0,r.uart1=t.uart1,r.uart2=t.uart2,r.uart3=t.uart3,r.cmdline=t.cmdline,r.preserve_mac_from_state_image=t.preserve_mac_from_state_image,r.mac_address_translation=t.mac_address_translation,t.network_adapter?this.network_adapter=t.network_adapter(this.bus):t.network_relay_url&&(this.network_adapter=new qt(t.network_relay_url,this.bus)),r.enable_ne2k=!0,t.disable_keyboard||(this.keyboard_adapter=new bc(this.bus)),t.disable_mouse||(this.mouse_adapter=new wc(this.bus,t.screen_container)),t.screen_container?this.screen_adapter=new na(t.screen_container,this.bus):t.screen_dummy&&(this.screen_adapter=new Ec(this.bus)),t.serial_container&&(this.serial_adapter=new Cc(t.serial_container,this.bus)),t.serial_container_xtermjs&&(this.serial_adapter=new Uo(t.serial_container_xtermjs,this.bus,t.xterm)),t.disable_speaker||(this.speaker_adapter=new qo(this.bus));var u=[];t.state&&console.warn("Warning: Unknown option 'state'. Did you mean 'initial_state'?");for(var o="bios vga_bios cdrom hda hdb fda fdb initial_state multiboot bzimage initrd".split(" "),l=0;l<o.length;l++)s(o[l],t[o[l]]);if(t.filesystem){o=t.filesystem.basefs,l=t.filesystem.baseurl;let p=new Kt;if(l&&(p=new It(p,l)),r.fs9p=this.fs9p=new te(p),o){if(console.assert(l,"Filesystem: baseurl must be specified"),typeof o=="object"){var f=o.size;o=o.url}u.push({name:"fs9p_json",url:o,size:f,as_json:!0})}}var m=this,C=u.length,S=function(p){if(p===C)setTimeout(a.bind(this),0);else{var v=u[p];v.loadable?(v.loadable.onload=function(w){i.call(this,v.name,v.loadable),S(p+1)}.bind(this),v.loadable.load()):V.load_file(v.url,{done:function(w){i.call(this,v.name,v.as_json?w:new lt(w)),S(p+1)}.bind(this),progress:function(w){w.target.status===200?m.emulator_bus.send("download-progress",{file_index:p,file_count:C,file_name:v.url,lengthComputable:w.lengthComputable,total:w.total||v.size,loaded:w.loaded}):m.emulator_bus.send("download-error",{file_index:p,file_count:C,file_name:v.url,request:w.target})},as_json:v.as_json})}}.bind(this);S(0)};J.prototype.get_bzimage_initrd_from_filesystem=function(e){const t=(e.read_dir("/")||[]).map(a=>"/"+a);e=(e.read_dir("/boot/")||[]).map(a=>"/boot/"+a);let i,s;for(let a of[].concat(t,e)){const r=/old/i.test(a)||/fallback/i.test(a),u=/vmlinuz/i.test(a)||/bzimage/i.test(a),o=/initrd/i.test(a)||/initramfs/i.test(a);!u||s&&r||(s=a),!o||i&&r||(i=a)}return i&&s||(console.log("Failed to find bzimage or initrd in filesystem. Files:"),console.log(t.join(" ")),console.log(e.join(" "))),{initrd_path:i,bzimage_path:s}};J.prototype.run=async function(){this.bus.send("cpu-run")};Ce.exportProperty(J.prototype,"run",J.prototype.run);J.prototype.stop=async function(){this.cpu_is_running&&await new Promise(e=>{const t=()=>{this.remove_listener("emulator-stopped",t),e()};this.add_listener("emulator-stopped",t),this.bus.send("cpu-stop")})};Ce.exportProperty(J.prototype,"stop",J.prototype.stop);J.prototype.destroy=async function(){await this.stop(),this.v86.destroy(),this.keyboard_adapter&&this.keyboard_adapter.destroy(),this.network_adapter&&this.network_adapter.destroy(),this.mouse_adapter&&this.mouse_adapter.destroy(),this.screen_adapter&&this.screen_adapter.destroy(),this.serial_adapter&&this.serial_adapter.destroy(),this.speaker_adapter&&this.speaker_adapter.destroy()};Ce.exportProperty(J.prototype,"destroy",J.prototype.destroy);J.prototype.restart=function(){this.bus.send("cpu-restart")};Ce.exportProperty(J.prototype,"restart",J.prototype.restart);J.prototype.add_listener=function(e,t){this.bus.register(e,t,this)};Ce.exportProperty(J.prototype,"add_listener",J.prototype.add_listener);J.prototype.remove_listener=function(e,t){this.bus.unregister(e,t)};Ce.exportProperty(J.prototype,"remove_listener",J.prototype.remove_listener);J.prototype.restore_state=async function(e){console.assert(arguments.length===1),this.v86.restore_state(e)};Ce.exportProperty(J.prototype,"restore_state",J.prototype.restore_state);J.prototype.save_state=async function(){return console.assert(arguments.length===0),this.v86.save_state()};Ce.exportProperty(J.prototype,"save_state",J.prototype.save_state);J.prototype.get_statistics=function(){console.warn("V86Starter.prototype.get_statistics is deprecated. Use events instead.");var e={cpu:{instruction_counter:this.get_instruction_counter()}};if(!this.v86)return e;var t=this.v86.cpu.devices;return t.hda&&(e.hda=t.hda.stats),t.cdrom&&(e.cdrom=t.cdrom.stats),t.ps2&&(e.mouse={enabled:t.ps2.use_mouse}),t.vga&&(e.vga={is_graphical:t.vga.stats.is_graphical}),e};Ce.exportProperty(J.prototype,"get_statistics",J.prototype.get_statistics);J.prototype.get_instruction_counter=function(){return this.v86?this.v86.cpu.instruction_counter[0]>>>0:0};Ce.exportProperty(J.prototype,"get_instruction_counter",J.prototype.get_instruction_counter);J.prototype.is_running=function(){return this.cpu_is_running};Ce.exportProperty(J.prototype,"is_running",J.prototype.is_running);J.prototype.keyboard_send_scancodes=function(e){for(var t=0;t<e.length;t++)this.bus.send("keyboard-code",e[t])};Ce.exportProperty(J.prototype,"keyboard_send_scancodes",J.prototype.keyboard_send_scancodes);J.prototype.keyboard_send_keys=function(e){for(var t=0;t<e.length;t++)this.keyboard_adapter.simulate_press(e[t])};Ce.exportProperty(J.prototype,"keyboard_send_keys",J.prototype.keyboard_send_keys);J.prototype.keyboard_send_text=function(e){for(var t=0;t<e.length;t++)this.keyboard_adapter.simulate_char(e[t])};Ce.exportProperty(J.prototype,"keyboard_send_text",J.prototype.keyboard_send_text);J.prototype.screen_make_screenshot=function(){this.screen_adapter&&this.screen_adapter.make_screenshot()};Ce.exportProperty(J.prototype,"screen_make_screenshot",J.prototype.screen_make_screenshot);J.prototype.screen_set_scale=function(e,t){this.screen_adapter&&this.screen_adapter.set_scale(e,t)};Ce.exportProperty(J.prototype,"screen_set_scale",J.prototype.screen_set_scale);J.prototype.screen_go_fullscreen=function(){if(this.screen_adapter){var e=document.getElementById("screen_container");if(e){var t=e.requestFullScreen||e.webkitRequestFullscreen||e.mozRequestFullScreen||e.msRequestFullScreen;t&&(t.call(e),(e=document.getElementsByClassName("phone_keyboard")[0])&&e.focus());try{navigator.keyboard.lock()}catch{}this.lock_mouse()}}};Ce.exportProperty(J.prototype,"screen_go_fullscreen",J.prototype.screen_go_fullscreen);J.prototype.lock_mouse=function(){var e=document.body,t=e.requestPointerLock||e.mozRequestPointerLock||e.webkitRequestPointerLock;t&&t.call(e)};Ce.exportProperty(J.prototype,"lock_mouse",J.prototype.lock_mouse);J.prototype.mouse_set_status=function(e){this.mouse_adapter&&(this.mouse_adapter.emu_enabled=e)};J.prototype.keyboard_set_status=function(e){this.keyboard_adapter&&(this.keyboard_adapter.emu_enabled=e)};Ce.exportProperty(J.prototype,"keyboard_set_status",J.prototype.keyboard_set_status);J.prototype.serial0_send=function(e){for(var t=0;t<e.length;t++)this.bus.send("serial0-input",e.charCodeAt(t))};Ce.exportProperty(J.prototype,"serial0_send",J.prototype.serial0_send);J.prototype.serial_send_bytes=function(e,t){for(var i=0;i<t.length;i++)this.bus.send("serial"+e+"-input",t[i])};Ce.exportProperty(J.prototype,"serial_send_bytes",J.prototype.serial_send_bytes);J.prototype.mount_fs=async function(e,t,i,s){let a=new Kt;t&&(a=new It(a,t));const r=new te(a,this.fs9p.qidcounter),u=()=>{const o=this.fs9p.Mount(e,r);s&&(o===-Qt?s(new ts):o===-io?s(new Ho):0>o?s(Error("Failed to mount. Error number: "+-o)):s(null))};t?r.load_from_json(i,()=>u()):u()};Ce.exportProperty(J.prototype,"mount_fs",J.prototype.mount_fs);J.prototype.create_file=async function(e,t){console.assert(arguments.length===2);var i=this.fs9p;if(i){var s=e.split("/");s=s[s.length-1];var a=i.SearchPath(e).parentid;if(s!==""&&a!==-1)await i.CreateBinaryFile(s,a,t);else return Promise.reject(new ts)}};Ce.exportProperty(J.prototype,"create_file",J.prototype.create_file);J.prototype.read_file=async function(e){console.assert(arguments.length===1);var t=this.fs9p;if(t)return(t=await t.read_file(e))?t:Promise.reject(new ts)};Ce.exportProperty(J.prototype,"read_file",J.prototype.read_file);J.prototype.automatically=function(e){const t=i=>{const s=i[0];if(s){var a=i.slice(1);if(s.sleep)setTimeout(()=>t(a),1e3*s.sleep);else if(s.vga_text){const r=this.screen_adapter.get_text_screen();for(let u of r)if(u.includes(s.vga_text)){t(a);return}setTimeout(()=>t(i),1e3)}else s.keyboard_send?(s.keyboard_send instanceof Array?this.keyboard_send_scancodes(s.keyboard_send):(s.keyboard_send,this.keyboard_send_text(s.keyboard_send)),t(a)):s.call?(s.call(),t(a)):console.assert(!1,s)}};t(e)};J.prototype.read_memory=function(e,t){return this.v86.cpu.read_blob(e,t)};J.prototype.write_memory=function(e,t){this.v86.cpu.write_blob(e,t)};function Ho(e){this.message=e||"File already exists"}Ho.prototype=Error.prototype;function ts(e){this.message=e||"File not found"}ts.prototype=Error.prototype;function Ec(e){var t,i,s;this.bus=e,e.register("screen-set-mode",function(a){this.set_mode(a)},this),e.register("screen-fill-buffer-end",function(a){this.update_buffer(a[0],a[1])},this),e.register("screen-put-char",function(a){this.put_char(a[0],a[1],a[2],a[3],a[4])},this),e.register("screen-text-scroll",function(a){console.log("scroll",a)},this),e.register("screen-update-cursor",function(a){this.update_cursor(a[0],a[1])},this),e.register("screen-update-cursor-scanline",function(a){this.update_cursor_scanline(a[0],a[1])},this),e.register("screen-set-size-text",function(a){this.set_size_text(a[0],a[1])},this),e.register("screen-set-size-graphical",function(a){this.set_size_graphical(a[0],a[1])},this),this.put_char=function(a,r,u,o,l){a<s&&r<i&&(a=3*(a*i+r),t[a]=u,t[a+1]=o,t[a+2]=l)},this.destroy=function(){},this.set_mode=function(a){},this.clear_screen=function(){},this.set_size_text=function(a,r){(a!==i||r!==s)&&(t=new Int32Array(a*r*3),i=a,s=r)},this.set_size_graphical=function(a,r){},this.set_scale=function(a,r){},this.update_cursor_scanline=function(a,r){},this.update_cursor=function(a,r){},this.update_buffer=function(a,r){},this.get_text_screen=function(){for(var a=[],r=0;r<s;r++)a.push(this.get_text_row(r));return a},this.get_text_row=function(a){var r="";a=3*a*i;for(var u=0;u<i;u++)r+=String.fromCharCode(t[a+3*u]);return r}}const jt={stats_to_string:function(e){return jt.print_misc_stats(e)+jt.print_instruction_counts(e)},print_misc_stats:function(e){let t="";var i="COMPILE COMPILE_SKIPPED_NO_NEW_ENTRY_POINTS COMPILE_SUCCESS COMPILE_WRONG_ADDRESS_SPACE COMPILE_CUT_OFF_AT_END_OF_PAGE COMPILE_WITH_LOOP_SAFETY COMPILE_PAGE COMPILE_PAGE/COMPILE_SUCCESS COMPILE_PAGE_SKIPPED_NO_NEW_ENTRY_POINTS COMPILE_BASIC_BLOCK COMPILE_DUPLICATED_BASIC_BLOCK COMPILE_WASM_BLOCK COMPILE_WASM_LOOP COMPILE_DISPATCHER COMPILE_ENTRY_POINT COMPILE_WASM_TOTAL_BYTES COMPILE_WASM_TOTAL_BYTES/COMPILE_PAGE JIT_CACHE_OVERRIDE JIT_CACHE_OVERRIDE_DIFFERENT_STATE_FLAGS RUN_INTERPRETED RUN_INTERPRETED_PENDING RUN_INTERPRETED_NEAR_END_OF_PAGE RUN_INTERPRETED_DIFFERENT_STATE RUN_INTERPRETED_MISSED_COMPILED_ENTRY_RUN_INTERPRETED RUN_INTERPRETED_MISSED_COMPILED_ENTRY_LOOKUP RUN_INTERPRETED_STEPS RUN_FROM_CACHE RUN_FROM_CACHE_STEPS RUN_FROM_CACHE_STEPS/RUN_FROM_CACHE RUN_FROM_CACHE_STEPS/RUN_INTERPRETED_STEPS DIRECT_EXIT INDIRECT_JUMP INDIRECT_JUMP_NO_ENTRY NORMAL_PAGE_CHANGE NORMAL_FALLTHRU NORMAL_FALLTHRU_WITH_TARGET_BLOCK NORMAL_BRANCH NORMAL_BRANCH_WITH_TARGET_BLOCK CONDITIONAL_JUMP CONDITIONAL_JUMP_PAGE_CHANGE CONDITIONAL_JUMP_EXIT CONDITIONAL_JUMP_FALLTHRU CONDITIONAL_JUMP_FALLTHRU_WITH_TARGET_BLOCK CONDITIONAL_JUMP_BRANCH CONDITIONAL_JUMP_BRANCH_WITH_TARGET_BLOCK DISPATCHER_SMALL DISPATCHER_LARGE LOOP LOOP_SAFETY CONDITION_OPTIMISED CONDITION_UNOPTIMISED FAILED_PAGE_CHANGE SAFE_READ_FAST SAFE_READ_SLOW_PAGE_CROSSED SAFE_READ_SLOW_NOT_VALID SAFE_READ_SLOW_NOT_USER SAFE_READ_SLOW_IN_MAPPED_RANGE SAFE_WRITE_FAST SAFE_WRITE_SLOW_PAGE_CROSSED SAFE_WRITE_SLOW_NOT_VALID SAFE_WRITE_SLOW_NOT_USER SAFE_WRITE_SLOW_IN_MAPPED_RANGE SAFE_WRITE_SLOW_READ_ONLY SAFE_WRITE_SLOW_HAS_CODE SAFE_READ_WRITE_FAST SAFE_READ_WRITE_SLOW_PAGE_CROSSED SAFE_READ_WRITE_SLOW_NOT_VALID SAFE_READ_WRITE_SLOW_NOT_USER SAFE_READ_WRITE_SLOW_IN_MAPPED_RANGE SAFE_READ_WRITE_SLOW_READ_ONLY SAFE_READ_WRITE_SLOW_HAS_CODE PAGE_FAULT TLB_MISS DO_RUN DO_MANY_CYCLES CYCLE_INTERNAL INVALIDATE_ALL_MODULES_NO_FREE_WASM_INDICES INVALIDATE_MODULE_WRITTEN_WHILE_COMPILED INVALIDATE_MODULE_UNUSED_AFTER_OVERWRITE INVALIDATE_MODULE_DIRTY_PAGE INVALIDATE_PAGE_HAD_CODE INVALIDATE_PAGE_HAD_ENTRY_POINTS DIRTY_PAGE_DID_NOT_HAVE_CODE RUN_FROM_CACHE_EXIT_SAME_PAGE RUN_FROM_CACHE_EXIT_NEAR_END_OF_PAGE RUN_FROM_CACHE_EXIT_DIFFERENT_PAGE CLEAR_TLB FULL_CLEAR_TLB TLB_FULL TLB_GLOBAL_FULL MODRM_SIMPLE_REG MODRM_SIMPLE_REG_WITH_OFFSET MODRM_SIMPLE_CONST_OFFSET MODRM_COMPLEX SEG_OFFSET_OPTIMISED SEG_OFFSET_NOT_OPTIMISED".split(" "),s=0;const a={};for(let u=0;u<i.length;u++){const o=i[u];var r=void 0;if(o.includes("/")){s++;const[l,f]=o.split("/");r=a[l]/a[f]}else r=a[o]=e.wm.exports.profiler_stat_get(u-s),r=1e8<=r?Math.round(r/1e6)+"m":1e5<=r?Math.round(r/1e3)+"k":r;t+=o+"="+r+`
`}return t+=`
`,i=e.wm.exports.get_valid_tlb_entries_count(),s=e.wm.exports.get_valid_global_tlb_entries_count(),t=t+("TLB_ENTRIES="+i+" ("+s+" global, "+(i-s)+` non-global)
WASM_TABLE_FREE=`)+(e.wm.exports.jit_get_wasm_table_index_free_list_count()+`
`),t+="JIT_CACHE_SIZE="+e.wm.exports.jit_get_cache_size()+`
`,t+="FLAT_SEGMENTS="+e.wm.exports.has_flat_segmentation()+`
`,t+="do_many_cycles avg: "+(e.do_many_cycles_total/e.do_many_cycles_count||0)+`
`,t+="wasm memory size: "+(e.wasm_memory.buffer.byteLength>>20)+`m
`,t=t+`Config:
MAX_PAGES=`+(e.wm.exports.get_config(0)+`
`),t+="JIT_USE_LOOP_SAFETY="+e.wm.exports.get_config(1)+`
`,t+="MAX_EXTRA_BASIC_BLOCKS="+e.wm.exports.get_config(2)+`
`},print_instruction_counts:function(e){return[jt.print_instruction_counts_offset(e,!1,!1,!1,!1),jt.print_instruction_counts_offset(e,!0,!1,!1,!1),jt.print_instruction_counts_offset(e,!1,!0,!1,!1),jt.print_instruction_counts_offset(e,!1,!1,!0,!1),jt.print_instruction_counts_offset(e,!1,!1,!1,!0)].join(`

`)},print_instruction_counts_offset:function(e,t,i,s,a){let r="";var u=[],o=t?"compiled":i?"jit exit":s?"unguarded register":a?"wasm size":"executed";for(let m=0;256>m;m++)for(let C=0;8>C;C++)for(let S of[!1,!0]){var l=e.wm.exports.get_opstats_buffer(t,i,s,a,m,!1,S,C);u.push({opcode:m,count:l,is_mem:S,fixed_g:C}),l=e.wm.exports.get_opstats_buffer(t,i,s,a,m,!0,S,C),u.push({opcode:3840|m,count:l,is_mem:S,fixed_g:C})}e=0,t=new Set([38,46,54,62,100,101,102,103,240,242,243]);for(let{count:m,opcode:C}of u)t.has(C)||(e+=m);if(e===0)return"";i=new Uint32Array(256),t=new Uint32Array(256);for(let{opcode:m,count:C}of u)(m&65280)==3840?t[m&255]+=C:i[m&255]+=C;r=r+`------------------
Total: `+(e+`
`);const f=1e7<e?1e3:1;for(s=Math.max.apply(Math,u.map(({count:m})=>Math.round(m/f))),s=String(s).length,r+=`Instruction counts ${o} (in ${f}):
`,a=0;256>a;a++)r+=a.toString(16).padStart(2,"0")+":"+V.pads(Math.round(i[a]/f),s),r=a%16==15?r+`
`:r+" ";for(r=r+`
Instruction counts ${o} (0f, in ${f}):
`,o=0;256>o;o++)r+=(o&255).toString(16).padStart(2,"0")+":"+V.pads(Math.round(t[o]/f),s),r=o%16==15?r+`
`:r+" ";r+=`
`,u=u.filter(({count:m})=>m).sort(({count:m},{count:C})=>C-m);for(let{opcode:m,is_mem:C,fixed_g:S,count:p}of u.slice(0,200))u=m.toString(16)+"_"+S+(C?"_m":"_r"),r+=u+":"+(p/e*100).toFixed(2)+" ";return r+`
`}};typeof vt<"u"&&typeof vt.exports<"u"&&(vt.exports.print_stats=jt);function Kt(){this.filedata=new Map}Kt.prototype.read=async function(e,t,i){return(e=this.filedata.get(e))?e.subarray(t,t+i):null};Kt.prototype.cache=async function(e,t){this.filedata.set(e,t)};Kt.prototype.uncache=function(e){this.filedata.delete(e)};function It(e,t){this.storage=e,this.baseurl=t}It.prototype.load_from_server=function(e){return new Promise((t,i)=>{V.load_file(this.baseurl+e,{done:async s=>{s=new Uint8Array(s),await this.cache(e,s),t(s)}})})};It.prototype.read=async function(e,t,i){const s=await this.storage.read(e,t,i);return s||(await this.load_from_server(e)).subarray(t,t+i)};It.prototype.cache=async function(e,t){return await this.storage.cache(e,t)};It.prototype.uncache=function(e){this.storage.uncache(e)};typeof window<"u"?(window.MemoryFileStorage=Kt,window.ServerFileStorageWrapper=It):typeof vt<"u"&&typeof vt.exports<"u"?(vt.exports.MemoryFileStorage=Kt,vt.exports.ServerFileStorageWrapper=It):typeof importScripts=="function"&&(self.MemoryFileStorage=Kt,self.ServerFileStorageWrapper=It);var nt=61440,is=49152,Mi=40960,fi=32768,mt=16384,rn=-1,No=0,bi=2,Kr=4,zo=5,xc=3,kc=0,Ac=1,Lc=2,Rc=3,Oc=4,Tc=5,$n=6,Mc=6;function te(e,t){this.inodes=[],this.events=[],this.storage=e,this.qidcounter=t||{last_qidnumber:0},this.inodedata={},this.total_size=274877906944,this.used_size=0,this.mounts=[],this.CreateDirectory("",-1)}te.prototype.get_state=function(){let e=[];e[0]=this.inodes,e[1]=this.qidcounter.last_qidnumber,e[2]=[];for(const[t,i]of Object.entries(this.inodedata))!(this.inodes[t].mode&mt)&&e[2].push([t,i]);return e[3]=this.total_size,e[4]=this.used_size,e=e.concat(this.mounts)};te.prototype.set_state=function(e){this.inodes=e[0].map(t=>{const i=new qi(0);return i.set_state(t),i}),this.qidcounter.last_qidnumber=e[1],this.inodedata={};for(let[t,i]of e[2])i.buffer.byteLength!==i.byteLength&&(i=i.slice()),this.inodedata[t]=i;this.total_size=e[3],this.used_size=e[4],this.mounts=e.slice(5)};te.prototype.AddEvent=function(e,t){var i=this.inodes[e];i.status==No||i.status==bi?t():this.is_forwarder(i)?this.follow_fs(i).AddEvent(i.foreign_id,t):this.events.push({id:e,OnEvent:t})};te.prototype.HandleEvent=function(e){var t=this.inodes[e];this.is_forwarder(t)&&this.follow_fs(t).HandleEvent(t.foreign_id),t=[];for(var i=0;i<this.events.length;i++)this.events[i].id==e?this.events[i].OnEvent():t.push(this.events[i]);this.events=t};te.prototype.load_from_json=function(e,t){if(e.version!==xc)throw"The filesystem JSON format has changed. Please update your fs2json (https://github.com/copy/fs2json) and recreate the filesystem JSON.";var i=e.fsroot;for(this.used_size=e.size,e=0;e<i.length;e++)this.LoadRecursive(i[e],0);t&&t()};te.prototype.LoadRecursive=function(e,t){var i=this.CreateInode();const s=e[kc];i.size=e[Ac],i.mtime=e[Lc],i.ctime=i.mtime,i.atime=i.mtime,i.mode=e[Rc],i.uid=e[Oc],i.gid=e[Tc];var a=i.mode&nt;a===mt?(this.PushInode(i,t,s),this.LoadDir(this.inodes.length-1,e[$n])):a===fi?(i.status=bi,i.sha256sum=e[Mc],i.sha256sum,this.PushInode(i,t,s)):a===Mi?(i.symlink=e[$n],this.PushInode(i,t,s)):a!==is&&E("Unexpected ifmt: "+L(a)+" ("+s+")")};te.prototype.LoadDir=function(e,t){for(var i=0;i<t.length;i++)this.LoadRecursive(t[i],e)};te.prototype.should_be_linked=function(e){return!this.is_forwarder(e)||e.foreign_id===0};te.prototype.link_under_dir=function(e,t,i){const s=this.inodes[t],a=this.inodes[e];this.is_forwarder(a),this.IsDirectory(e),this.should_be_linked(s),0<=s.nlinks,""+s.nlinks,a.direntries.has(i),a.direntries.set(i,t),s.nlinks++,this.IsDirectory(t)&&(s.direntries.has(".."),s.direntries.has(".")||s.nlinks++,s.direntries.set(".",t),s.direntries.set("..",e),a.nlinks++)};te.prototype.unlink_from_dir=function(e,t){const i=this.Search(e,t),s=this.inodes[i],a=this.inodes[e];this.is_forwarder(a),this.IsDirectory(e),a.direntries.delete(t)?(s.nlinks--,this.IsDirectory(i)&&(s.direntries.get(".."),s.direntries.delete(".."),a.nlinks--),0<=s.nlinks,""+s.nlinks,void 0):void 0};te.prototype.PushInode=function(e,t,i){t!=-1?(this.inodes.push(e),e.fid=this.inodes.length-1,this.link_under_dir(t,e.fid,i)):this.inodes.length==0?(this.inodes.push(e),e.direntries.set(".",0),e.direntries.set("..",0),e.nlinks=2):(ye.Debug("Error in Filesystem: Pushed inode with name = "+i+" has no parent"),ye.Abort())};function qi(e){this.direntries=new Map,this.minor=this.major=this.mtime=this.atime=this.ctime=this.fid=this.gid=this.uid=this.size=this.status=0,this.symlink="",this.mode=493,this.qid={type:0,version:0,path:e},this.caps=void 0,this.nlinks=0,this.sha256sum="",this.locks=[],this.foreign_id=this.mount_id=-1}qi.prototype.get_state=function(){const e=[];return e[0]=this.mode,e[1]=(this.mode&nt)===mt?[...this.direntries]:(this.mode&nt)===fi?this.sha256sum:(this.mode&nt)===Mi?this.symlink:(this.mode&nt)===is?[this.minor,this.major]:null,e[2]=this.locks,e[3]=this.status,e[4]=this.size,e[5]=this.uid,e[6]=this.gid,e[7]=this.fid,e[8]=this.ctime,e[9]=this.atime,e[10]=this.mtime,e[11]=this.qid.version,e[12]=this.qid.path,e[13]=this.nlinks,e};qi.prototype.set_state=function(e){if(this.mode=e[0],(this.mode&nt)===mt){this.direntries=new Map;for(const[t,i]of e[1])this.direntries.set(t,i)}else(this.mode&nt)===fi?this.sha256sum=e[1]:(this.mode&nt)===Mi?this.symlink=e[1]:(this.mode&nt)===is&&([this.minor,this.major]=e[1]);this.locks=[];for(const t of e[2]){const i=new Pt;i.set_state(t),this.locks.push(i)}this.status=e[3],this.size=e[4],this.uid=e[5],this.gid=e[6],this.fid=e[7],this.ctime=e[8],this.atime=e[9],this.mtime=e[10],this.qid.type=(this.mode&nt)>>8,this.qid.version=e[11],this.qid.path=e[12],this.nlinks=e[13]};te.prototype.divert=function(e,t){const i=this.Search(e,t),s=this.inodes[i],a=new qi(-1);this.IsDirectory(i)||1>=s.nlinks,""+t+s.nlinks,Object.assign(a,s);const r=this.inodes.length;if(this.inodes.push(a),a.fid=r,this.is_forwarder(s)&&this.mounts[s.mount_id].backtrack.set(s.foreign_id,r),this.should_be_linked(s)&&(this.unlink_from_dir(e,t),this.link_under_dir(e,r,t)),this.IsDirectory(i)&&!this.is_forwarder(s))for(const[u,o]of a.direntries)u!=="."&&u!==".."&&this.IsDirectory(o)&&this.inodes[o].direntries.set("..",r);return this.inodedata[r]=this.inodedata[i],delete this.inodedata[i],s.direntries=new Map,s.nlinks=0,r};te.prototype.copy_inode=function(e,t){Object.assign(t,e,{fid:t.fid,direntries:t.direntries,nlinks:t.nlinks})};te.prototype.CreateInode=function(){const e=Math.round(Date.now()/1e3),t=new qi(++this.qidcounter.last_qidnumber);return t.atime=t.ctime=t.mtime=e,t};te.prototype.CreateDirectory=function(e,t){var i=this.inodes[t];return 0<=t&&this.is_forwarder(i)?(t=i.foreign_id,e=this.follow_fs(i).CreateDirectory(e,t),this.create_forwarder(i.mount_id,e)):(i=this.CreateInode(),i.mode=511|mt,0<=t&&(i.uid=this.inodes[t].uid,i.gid=this.inodes[t].gid,i.mode=this.inodes[t].mode&511|mt),i.qid.type=mt>>8,this.PushInode(i,t,e),this.NotifyListeners(this.inodes.length-1,"newdir"),this.inodes.length-1)};te.prototype.CreateFile=function(e,t){var i=this.inodes[t];return this.is_forwarder(i)?(t=i.foreign_id,e=this.follow_fs(i).CreateFile(e,t),this.create_forwarder(i.mount_id,e)):(i=this.CreateInode(),i.uid=this.inodes[t].uid,i.gid=this.inodes[t].gid,i.qid.type=fi>>8,i.mode=this.inodes[t].mode&438|fi,this.PushInode(i,t,e),this.NotifyListeners(this.inodes.length-1,"newfile"),this.inodes.length-1)};te.prototype.CreateNode=function(e,t,i,s){var a=this.inodes[t];return this.is_forwarder(a)?(t=a.foreign_id,e=this.follow_fs(a).CreateNode(e,t,i,s),this.create_forwarder(a.mount_id,e)):(a=this.CreateInode(),a.major=i,a.minor=s,a.uid=this.inodes[t].uid,a.gid=this.inodes[t].gid,a.qid.type=is>>8,a.mode=this.inodes[t].mode&438,this.PushInode(a,t,e),this.inodes.length-1)};te.prototype.CreateSymlink=function(e,t,i){var s=this.inodes[t];return this.is_forwarder(s)?(t=s.foreign_id,e=this.follow_fs(s).CreateSymlink(e,t,i),this.create_forwarder(s.mount_id,e)):(s=this.CreateInode(),s.uid=this.inodes[t].uid,s.gid=this.inodes[t].gid,s.qid.type=Mi>>8,s.symlink=i,s.mode=Mi,this.PushInode(s,t,e),this.inodes.length-1)};te.prototype.CreateTextFile=async function(e,t,i){var s=this.inodes[t];if(this.is_forwarder(s))return t=s.foreign_id,i=await this.follow_fs(s).CreateTextFile(e,t,i),this.create_forwarder(s.mount_id,i);for(s=this.CreateFile(e,t),t=this.inodes[s],e=new Uint8Array(i.length),t.size=i.length,t=0;t<i.length;t++)e[t]=i.charCodeAt(t);return await this.set_data(s,e),s};te.prototype.CreateBinaryFile=async function(e,t,i){var s=this.inodes[t];return this.is_forwarder(s)?(t=s.foreign_id,i=await this.follow_fs(s).CreateBinaryFile(e,t,i),this.create_forwarder(s.mount_id,i)):(s=this.CreateFile(e,t),e=this.inodes[s],t=new Uint8Array(i.length),t.set(i),await this.set_data(s,t),e.size=i.length,s)};te.prototype.OpenInode=function(e,t){var i=this.inodes[e];return this.is_forwarder(i)?this.follow_fs(i).OpenInode(i.foreign_id,t):((i.mode&nt)==mt&&this.FillDirectory(e),!0)};te.prototype.CloseInode=async function(e){var t=this.inodes[e];if(this.is_forwarder(t))return await this.follow_fs(t).CloseInode(t.foreign_id);t.status===bi&&this.storage.uncache(t.sha256sum),t.status==Kr&&(t.status=rn,await this.DeleteData(e))};te.prototype.Rename=async function(e,t,i,s){if(e==i&&t==s)return 0;var a=this.Search(e,t);if(a===-1)return-Qt;var r=this.GetFullPath(e)+"/"+t;if(this.Search(i,s)!=-1){var u=this.Unlink(i,s);if(0>u)return u}var o=this.inodes[a],l=this.inodes[e];if(u=this.inodes[i],this.is_forwarder(l)||this.is_forwarder(u))if(this.is_forwarder(l)&&l.mount_id===u.mount_id){if(e=await this.follow_fs(l).Rename(l.foreign_id,t,u.foreign_id,s),0>e)return e}else{if(this.is_a_root(a))return E("XXX: Attempted to move mountpoint ("+t+") - skipped",$t),-Dt;if(!this.IsDirectory(a)&&1<this.GetInode(a).nlinks)return E("XXX: Attempted to move hardlinked file ("+t+") across filesystems - skipped",$t),-Dt;l=this.divert(e,t);const f=this.GetInode(a),m=await this.Read(l,0,f.size);if(this.is_forwarder(u)?(i=this.follow_fs(u),s=this.IsDirectory(l)?i.CreateDirectory(s,u.foreign_id):i.CreateFile(s,u.foreign_id),i=i.GetInode(s),this.copy_inode(f,i),this.set_forwarder(a,u.mount_id,s)):(this.delete_forwarder(o),this.copy_inode(f,o),this.link_under_dir(i,a,s)),await this.ChangeSize(a,f.size),m&&m.length&&await this.Write(a,0,m.length,m),this.IsDirectory(a)){for(const C of this.GetChildren(l))if(u=await this.Rename(l,C,a,C),0>u)return u}if(await this.DeleteData(l),e=this.Unlink(e,t),0>e)return e}else this.unlink_from_dir(e,t),this.link_under_dir(i,a,s),o.qid.version++;return this.NotifyListeners(a,"rename",{oldpath:r}),0};te.prototype.Write=async function(e,t,i,s){this.NotifyListeners(e,"write");var a=this.inodes[e];if(this.is_forwarder(a))e=a.foreign_id,await this.follow_fs(a).Write(e,t,i,s);else{var r=await this.get_buffer(e);!r||r.length<t+i?(await this.ChangeSize(e,Math.floor(3*(t+i)/2)),a.size=t+i,r=await this.get_buffer(e)):a.size<t+i&&(a.size=t+i),s&&r.set(s.subarray(0,i),t),await this.set_data(e,r)}};te.prototype.Read=async function(e,t,i){const s=this.inodes[e];return this.is_forwarder(s)?(e=s.foreign_id,await this.follow_fs(s).Read(e,t,i)):await this.get_data(e,t,i)};te.prototype.Search=function(e,t){if(e=this.inodes[e],this.is_forwarder(e)){const i=e.foreign_id;return t=this.follow_fs(e).Search(i,t),t===-1?-1:this.get_forwarder(e.mount_id,t)}return t=e.direntries.get(t),t===void 0?-1:t};te.prototype.CountUsedInodes=function(){let e=this.inodes.length;for(const{fs:t,backtrack:i}of this.mounts)e+=t.CountUsedInodes(),e-=i.size;return e};te.prototype.CountFreeInodes=function(){let e=1048576;for(const{fs:t}of this.mounts)e+=t.CountFreeInodes();return e};te.prototype.GetTotalSize=function(){let e=this.used_size;for(const{fs:t}of this.mounts)e+=t.GetTotalSize();return e};te.prototype.GetSpace=function(){let e=this.total_size;for(const{fs:t}of this.mounts)e+=t.GetSpace();return this.total_size};te.prototype.GetDirectoryName=function(e){const t=this.inodes[this.GetParent(e)];if(this.is_forwarder(t))return this.follow_fs(t).GetDirectoryName(this.inodes[e].foreign_id);if(!t)return"";for(const[i,s]of t.direntries)if(s===e)return i;return""};te.prototype.GetFullPath=function(e){this.IsDirectory(e);for(var t="";e!=0;)t="/"+this.GetDirectoryName(e)+t,e=this.GetParent(e);return t.substring(1)};te.prototype.Link=function(e,t,i){if(this.IsDirectory(t))return-Dt;const s=this.inodes[e],a=this.inodes[t];return this.is_forwarder(s)?this.is_forwarder(a)&&a.mount_id===s.mount_id?this.follow_fs(s).Link(s.foreign_id,a.foreign_id,i):(E("XXX: Attempted to hardlink a file into a child filesystem - skipped",$t),-Dt):this.is_forwarder(a)?(E("XXX: Attempted to hardlink file across filesystems - skipped",$t),-Dt):(this.link_under_dir(e,t,i),0)};te.prototype.Unlink=function(e,t){if(t==="."||t==="..")return-Dt;const i=this.Search(e,t),s=this.inodes[i],a=this.inodes[e];return this.is_forwarder(a)?(this.is_forwarder(s),e=a.foreign_id,this.follow_fs(a).Unlink(e,t)):this.IsDirectory(i)&&!this.IsEmpty(i)?-Os:(this.unlink_from_dir(e,t),s.nlinks===0&&(s.status=Kr,this.NotifyListeners(i,"delete")),0)};te.prototype.DeleteData=async function(e){const t=this.inodes[e];this.is_forwarder(t)?await this.follow_fs(t).DeleteData(t.foreign_id):(t.size=0,delete this.inodedata[e])};te.prototype.get_buffer=async function(e){const t=this.inodes[e];return this.inodedata[e]?this.inodedata[e]:t.status===bi?(t.sha256sum,await this.storage.read(t.sha256sum,0,t.size)):null};te.prototype.get_data=async function(e,t,i){const s=this.inodes[e];return this.inodedata[e]?this.inodedata[e].subarray(t,t+i):s.status===bi?(s.sha256sum,await this.storage.read(s.sha256sum,t,i)):null};te.prototype.set_data=async function(e,t){this.inodedata[e]=t,this.inodes[e].status===bi&&(this.inodes[e].status=No,this.storage.uncache(this.inodes[e].sha256sum))};te.prototype.GetInode=function(e){return 0<=e&&e<this.inodes.length,e=this.inodes[e],this.is_forwarder(e)?this.follow_fs(e).GetInode(e.foreign_id):e};te.prototype.ChangeSize=async function(e,t){var i=this.GetInode(e),s=await this.get_data(e,0,i.size);if(t!=i.size){var a=new Uint8Array(t);i.size=t,s&&a.set(s.subarray(0,Math.min(s.length,i.size)),0),await this.set_data(e,a)}};te.prototype.SearchPath=function(e){e=e.replace("//","/"),e=e.split("/"),0<e.length&&e[e.length-1].length===0&&e.pop(),0<e.length&&e[0].length===0&&e.shift();const t=e.length;var i=-1,s=0;let a=null;for(var r=0;r<t;r++)if(i=s,s=this.Search(i,e[r]),!a&&this.is_forwarder(this.inodes[i])&&(a="/"+e.slice(r).join("/")),s==-1)return r<t-1?{id:-1,parentid:-1,name:e[r],forward_path:a}:{id:-1,parentid:i,name:e[r],forward_path:a};return{id:s,parentid:i,name:e[r],forward_path:a}};te.prototype.GetRecursiveList=function(e,t){if(this.is_forwarder(this.inodes[e])){const i=this.follow_fs(this.inodes[e]),s=this.inodes[e].mount_id,a=t.length;for(i.GetRecursiveList(this.inodes[e].foreign_id,t),e=a;e<t.length;e++)t[e].parentid=this.get_forwarder(s,t[e].parentid)}else for(const[i,s]of this.inodes[e].direntries)i!=="."&&i!==".."&&(t.push({parentid:e,name:i}),this.IsDirectory(s)&&this.GetRecursiveList(s,t))};te.prototype.RecursiveDelete=function(e){var t=[];if(e=this.SearchPath(e),e.id!==-1)for(this.GetRecursiveList(e.id,t),e=t.length-1;0<=e;e--){const i=this.Unlink(t[e].parentid,t[e].name);""+t[e].parentid+t[e].name+-i}};te.prototype.DeleteNode=function(e){var t=this.SearchPath(e);t.id!=-1&&((this.inodes[t.id].mode&nt)==fi?(e=this.Unlink(t.parentid,t.name),void 0):(this.inodes[t.id].mode&nt)==mt&&(this.RecursiveDelete(e),e=this.Unlink(t.parentid,t.name),void 0))};te.prototype.NotifyListeners=function(e,t,i){};te.prototype.Check=function(){for(var e=1;e<this.inodes.length;e++)if(this.inodes[e].status!=rn){var t=this.GetInode(e);if(0>t.nlinks&&ye.Debug("Error in filesystem: negative nlinks="+t.nlinks+" at id ="+e),this.IsDirectory(e)){t=this.GetInode(e),this.IsDirectory(e)&&0>this.GetParent(e)&&ye.Debug("Error in filesystem: negative parent id "+e);for(const[i,s]of t.direntries){i.length===0&&ye.Debug("Error in filesystem: inode with no name and id "+s);for(const a of i)32>a&&ye.Debug("Error in filesystem: Unallowed char in filename")}}}};te.prototype.FillDirectory=function(e){var t=this.inodes[e];if(this.is_forwarder(t))this.follow_fs(t).FillDirectory(t.foreign_id);else{var i=0;for(const s of t.direntries.keys())i+=24+Ns.UTF8Length(s);e=this.inodedata[e]=new Uint8Array(i),t.size=i,i=0;for(const[s,a]of t.direntries)t=this.GetInode(a),i+=fe.Marshall(["Q","d","b","s"],[t.qid,i+13+8+1+2+Ns.UTF8Length(s),t.mode>>12,s],e,i)}};te.prototype.RoundToDirentry=function(e,t){const i=this.inodedata[e];if(i.length,t>=i.length)return i.length;for(e=0;;){const s=fe.Unmarshall(["Q","d"],i,{offset:e})[1];if(s>t)break;e=s}return e};te.prototype.IsDirectory=function(e){return e=this.inodes[e],this.is_forwarder(e)?this.follow_fs(e).IsDirectory(e.foreign_id):(e.mode&nt)===mt};te.prototype.IsEmpty=function(e){if(e=this.inodes[e],this.is_forwarder(e))return this.follow_fs(e).IsDirectory(e.foreign_id);for(const t of e.direntries.keys())if(t!=="."&&t!=="..")return!1;return!0};te.prototype.GetChildren=function(e){if(this.IsDirectory(e),e=this.inodes[e],this.is_forwarder(e))return this.follow_fs(e).GetChildren(e.foreign_id);const t=[];for(const i of e.direntries.keys())i!=="."&&i!==".."&&t.push(i);return t};te.prototype.GetParent=function(e){if(this.IsDirectory(e),e=this.inodes[e],this.should_be_linked(e))return e.direntries.get("..");const t=this.follow_fs(e).GetParent(e.foreign_id);return this.get_forwarder(e.mount_id,t)};te.prototype.PrepareCAPs=function(e){return e=this.GetInode(e),e.caps||(e.caps=new Uint8Array(20),e.caps[0]=0,e.caps[1]=0,e.caps[2]=0,e.caps[3]=2,e.caps[4]=255,e.caps[5]=255,e.caps[6]=255,e.caps[7]=255,e.caps[8]=255,e.caps[9]=255,e.caps[10]=255,e.caps[11]=255,e.caps[12]=63,e.caps[13]=0,e.caps[14]=0,e.caps[15]=0,e.caps[16]=63,e.caps[17]=0,e.caps[18]=0,e.caps[19]=0),e.caps.length};function sn(e){this.fs=e,this.backtrack=new Map}sn.prototype.get_state=function(){const e=[];return e[0]=this.fs,e[1]=[...this.backtrack],e};sn.prototype.set_state=function(e){this.fs=e[0],this.backtrack=new Map(e[1])};te.prototype.set_forwarder=function(e,t,i){const s=this.inodes[e];s.nlinks,this.is_forwarder(s)&&this.mounts[s.mount_id].backtrack.delete(s.foreign_id),s.status=zo,s.mount_id=t,s.foreign_id=i,this.mounts[t].backtrack.set(i,e)};te.prototype.create_forwarder=function(e,t){const i=this.CreateInode(),s=this.inodes.length;return this.inodes.push(i),i.fid=s,this.set_forwarder(s,e,t),s};te.prototype.is_forwarder=function(e){return e.status===zo};te.prototype.is_a_root=function(e){return this.GetInode(e).fid===0};te.prototype.get_forwarder=function(e,t){var i=this.mounts[e];return i=i.backtrack.get(t),i===void 0?this.create_forwarder(e,t):i};te.prototype.delete_forwarder=function(e){this.is_forwarder(e),e.status=rn,this.mounts[e.mount_id].backtrack.delete(e.foreign_id)};te.prototype.follow_fs=function(e){const t=this.mounts[e.mount_id];return this.is_forwarder(e),""+e.fid,t.fs};te.prototype.Mount=function(e,t){t.qidcounter,this.qidcounter;var i=this.SearchPath(e);return i.parentid===-1?(E("Mount failed: parent for path not found: "+e,$t),-Qt):i.id!==-1?(E("Mount failed: file already exists at path: "+e,$t),-io):i.forward_path?(e=this.inodes[i.parentid],i=this.follow_fs(e).Mount(i.forward_path,t),0>i?i:this.get_forwarder(e.mount_id,i)):(e=this.mounts.length,this.mounts.push(new sn(t)),t=this.create_forwarder(e,0),this.link_under_dir(i.parentid,t,i.name),t)};function Pt(){this.type=li,this.start=0,this.length=1/0,this.proc_id=-1,this.client_id=""}Pt.prototype.get_state=function(){const e=[];return e[0]=this.type,e[1]=this.start,e[2]=this.length===1/0?0:this.length,e[3]=this.proc_id,e[4]=this.client_id,e};Pt.prototype.set_state=function(e){this.type=e[0],this.start=e[1],this.length=e[2]===0?1/0:e[2],this.proc_id=e[3],this.client_id=e[4]};Pt.prototype.clone=function(){const e=new Pt;return e.set_state(this.get_state()),e};Pt.prototype.conflicts_with=function(e){return!(this.proc_id===e.proc_id&&this.client_id===e.client_id||this.type===li||e.type===li||this.type!==Ts&&e.type!==Ts||this.start+this.length<=e.start||e.start+e.length<=this.start)};Pt.prototype.is_alike=function(e){return e.proc_id===this.proc_id&&e.client_id===this.client_id&&e.type===this.type};Pt.prototype.may_merge_after=function(e){return this.is_alike(e)&&e.start+e.length===this.start};te.prototype.DescribeLock=function(e,t,i,s,a){const r=new Pt;return r.type=e,r.start=t,r.length=i,r.proc_id=s,r.client_id=a,r};te.prototype.GetLock=function(e,t){if(e=this.inodes[e],this.is_forwarder(e)){var i=e.foreign_id;return this.follow_fs(e).GetLock(i,t)}for(i of e.locks)if(t.conflicts_with(i))return i.clone();return null};te.prototype.Lock=function(e,t,i){const s=this.inodes[e];if(this.is_forwarder(s))return e=s.foreign_id,this.follow_fs(s).Lock(e,t,i);if(t=t.clone(),t.type!==li&&this.GetLock(e,t))return ga;for(i=0;i<s.locks.length;i++){if(e=s.locks[i],0<e.length,""+e.length,e.type===ma||e.type,""+e.type,!s.locks[i-1]||s.locks[i-1].start<=e.start,e.start+e.length<=t.start)continue;if(t.start+t.length<=e.start)break;if(e.proc_id!==t.proc_id||e.client_id!==t.client_id){e.conflicts_with(t);continue}var a=t.start+t.length;const r=t.start-e.start,u=e.start+e.length-a;if(0<r&&0<u&&e.type===t.type)return fn;if(0<r&&(e.length=r),0>=r&&0<u)e.start=a,e.length=u;else if(0<u){for(;i<s.locks.length&&s.locks[i].start<a;)i++;s.locks.splice(i,0,this.DescribeLock(e.type,a,u,e.proc_id,e.client_id))}else 0>=r&&(s.locks.splice(i,1),i--)}if(t.type!==li){for(i=t,e=!1,a=0;a<s.locks.length&&(i.may_merge_after(s.locks[a])&&(s.locks[a].length+=t.length,i=s.locks[a],e=!0),!(t.start<=s.locks[a].start));a++);for(e||(s.locks.splice(a,0,i),a++);a<s.locks.length;a++)if(s.locks[a].is_alike(i)){s.locks[a].may_merge_after(i)&&(i.length+=s.locks[a].length,s.locks.splice(a,1));break}}return fn};te.prototype.read_dir=function(e){if(e=this.SearchPath(e),e.id!==-1)return e=this.GetInode(e.id),Array.from(e.direntries.keys()).filter(t=>t!=="."&&t!=="..")};te.prototype.read_file=function(e){if(e=this.SearchPath(e),e.id===-1)return Promise.resolve(null);const t=this.GetInode(e.id);return this.Read(e.id,0,t.size)};function Dc(e){return L(e)}var ye={Debug:function(e){E([].slice.apply(arguments).join(" "),$t)},Abort:function(){}},fe={Marshall:function(e,t,i,s){for(var a,r=0,u=0;u<e.length;u++)switch(a=t[u],e[u]){case"w":i[s++]=a&255,i[s++]=a>>8&255,i[s++]=a>>16&255,i[s++]=a>>24&255,r+=4;break;case"d":i[s++]=a&255,i[s++]=a>>8&255,i[s++]=a>>16&255,i[s++]=a>>24&255,i[s++]=0,i[s++]=0,i[s++]=0,i[s++]=0,r+=8;break;case"h":i[s++]=a&255,i[s++]=a>>8,r+=2;break;case"b":i[s++]=a,r+=1;break;case"s":var o=s,l=0;i[s++]=0,i[s++]=0,r+=2;for(var f of a)Pc(f.charCodeAt(0)).forEach(function(m){i[s++]=m,r+=1,l++});i[o+0]=l&255,i[o+1]=l>>8&255;break;case"Q":fe.Marshall(["b","w","d"],[a.type,a.version,a.path],i,s),s+=13,r+=13;break;default:ye.Debug("Marshall: Unknown type="+e[u])}return r},Unmarshall:function(e,t,i){let s=i.offset;for(var a=[],r=0;r<e.length;r++)switch(e[r]){case"w":var u=t[s++];u+=t[s++]<<8,u+=t[s++]<<16,u+=t[s++]<<24>>>0,a.push(u);break;case"d":u=t[s++],u+=t[s++]<<8,u+=t[s++]<<16,u+=t[s++]<<24>>>0,s+=4,a.push(u);break;case"h":u=t[s++],a.push(u+(t[s++]<<8));break;case"b":a.push(t[s++]);break;case"s":u=t[s++],u+=t[s++]<<8;for(var o="",l=new Ic,f=0;f<u;f++){var m=l.Put(t[s++]);m!=-1&&(o+=String.fromCharCode(m))}a.push(o);break;case"Q":i.offset=s,u=fe.Unmarshall(["b","w","d"],t,i),s=i.offset,a.push({type:u[0],version:u[1],path:u[2]});break;default:ye.Debug("Error in Unmarshall: Unknown type="+e[r])}return i.offset=s,a}},Ns={};function Ic(){this.stream=new Uint8Array(5),this.ofs=0,this.Put=function(e){switch(this.stream[this.ofs]=e,this.ofs++,this.ofs){case 1:if(128>this.stream[0])return this.ofs=0,this.stream[0];break;case 2:if((this.stream[0]&224)==192&&(this.stream[1]&192)==128)return this.ofs=0,(this.stream[0]&31)<<6|this.stream[1]&63}return-1}}function Pc(e){if(128>e)return[e];if(2048>e)return[192|e>>6&31,128|e&63]}Ns.UTF8Length=function(e){for(var t=0,i=0;i<e.length;i++){var s=e.charCodeAt(i);t+=128>s?1:2}return t};function Bc(e,t){return new Promise(i=>{const s=t.trim(),a=s.split(`
`).length;let r="";const u=[],o=l=>{u.push(l);const f=String.fromCharCode(l);if(r+=f,console.log(r),r.endsWith("=#")||r.endsWith("-#")){e.remove_listener("serial0-output-char",o);const m=new TextDecoder("UTF-8").decode(new Uint8Array(u));i(m.replaceAll("\x1B[?2004l"," ").replaceAll("\x1B[?2004h","").split(`
`).slice(a,-1).join(`
`).trim())}};e.add_listener("serial0-output-raw",o),e.serial_send_bytes(0,new TextEncoder("UTF-8").encode(`${s}
`))})}let zs;const qc=async()=>{const e=new J({wasm_path:"./lib/v86.wasm",memory_size:134217728,filesystem:{basefs:"filesystem/filesystem.json",baseurl:"filesystem/"},serial_container_xtermjs:document.getElementById("terminal"),xterm:Go.Terminal,network_relay_url:"wss://relay.widgetry.org/",autostart:!0,disable_keyboard:!0,disable_mouse:!0,disable_speaker:!0,acpi:!0,initial_state:{url:"./state/v86state.bin.zst"}});return await new Promise(t=>{e.add_listener("emulator-ready",function(){window.emulator=e,setTimeout(()=>{const i=`${(Math.random()+1).toString(36).substring(7)}.sh`;e.create_file(`/inbox/${i}`,new TextEncoder("UTF-8").encode("/etc/init.d/S40network restart")),e.serial0_send(`\\! stty rows ${e.serial_adapter.term.rows} cols ${e.serial_adapter.term.cols} && reset
`),t()},0)})}),await new Promise((t,i)=>{let s="";const a=r=>{s+=r,s.endsWith("=#")&&(e.remove_listener("serial0-output-char",a),t())};e.add_listener("serial0-output-char",a)}),zs=t=>Bc(e,t),zs};class Fc{constructor(t){this.template=`
        <textarea class="query" autofocus rows="5"></textarea>
    `,this.element=document.createElement("label"),this.element.innerHTML=this.template,this.element.className="cell",this.element.addEventListener("keydown",i=>{i.key==="Enter"&&i.ctrlKey&&(i.preventDefault(),this.run()),i.key==="Enter"&&i.shiftKey&&(i.preventDefault(),this.run(),t())})}reset(){var t,i;(t=this.element.querySelector(".answer"))==null||t.remove(),(i=this.element.querySelector(".info"))==null||i.remove(),[...this.element.getElementsByTagName("hr")].forEach(s=>s.remove())}async run(){const t=this.element.querySelector(".query").value;if(t.trim()==="")return;this.reset();const i=document.createElement("div");i.className="info";const s=document.createElement("div");s.classList.add("status","running"),s.appendChild(document.createTextNode("ì¤íì¤.."));const a=document.createElement("div");a.className="time";const r=new Date,u=`${r.getHours()}ì ${r.getMinutes()}ë¶ ${r.getSeconds()}ì´`;a.appendChild(document.createTextNode(u)),i.appendChild(s),i.appendChild(a),this.element.insertBefore(i,this.element.querySelector(".query"));const o=document.createElement("hr");this.element.insertBefore(o,this.element.querySelector(".query"));const l=await zs(t);s.classList.remove("running"),s.classList.add("done"),s.innerHTML="ì¤í ìë£";const f=document.createElement("pre");f.className="answer",f.appendChild(document.createTextNode(l));const m=document.createElement("hr");this.element.appendChild(m),this.element.appendChild(f);const S=new Date().getTime()-r.getTime(),p=S<9999?`${S}ms`:`${(S/1e3).toFixed(1)}s`;a.removeChild(a.firstChild),a.appendChild(document.createTextNode(p+" | "+u))}}const Uc=document.getElementById("cell_wrapper"),nn={addNewCell(){const e=new Fc(nn.addNewCell);Uc.appendChild(e.element),e.element.firstElementChild.focus()}};[...document.querySelectorAll("[data-onclick]")].forEach(e=>{const t=e.dataset.onclick;e.addEventListener("click",nn[t])});qc().then(()=>{document.getElementById("new_cell").classList.remove("hidden"),document.getElementById("cell_wrapper").classList.remove("hidden"),document.getElementById("loading").remove(),nn.addNewCell()})});export default Hc();
